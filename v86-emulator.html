<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v86 Emulator - Run Operating Systems in Browser</title>
    <meta name="description" content="Run Arch Linux, Windows, FreeDOS, and more in your browser using v86 x86 emulator">
    <!-- Load v86 from jsDelivr CDN (raw GitHub doesn't work due to MIME type) -->
    <script src="https://cdn.jsdelivr.net/npm/v86@latest/build/libv86.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #3d3d5c;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 2rem;
            color: #4a9eff;
            margin-bottom: 8px;
        }

        header p {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .toolbar {
            background: #2d2d44;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }

        .toolbar select, .toolbar button {
            padding: 8px 16px;
            background: #3d3d5c;
            border: 1px solid #4d4d6c;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar select:hover, .toolbar button:hover {
            background: #4d4d6c;
        }

        .toolbar button.primary {
            background: #4a7c59;
            border-color: #5a8c69;
        }

        .toolbar button.primary:hover {
            background: #5a8c69;
        }

        .toolbar button.danger {
            background: #7c4a4a;
            border-color: #8c5a5a;
        }

        .toolbar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-area {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .main-area { grid-template-columns: 1fr; }
            .info-panel { display: none; }
        }

        .screen-area {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        #screen_container {
            width: 100%;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #screen_container canvas {
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            max-width: 100%;
        }

        #screen_container > div {
            white-space: pre;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 14px;
            color: #0f0;
            padding: 10px;
        }

        .boot-message {
            color: #4a9eff;
            text-align: center;
            padding: 40px;
            background: #000;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .boot-message h2 { margin-bottom: 16px; }
        .boot-message p { opacity: 0.7; margin: 8px 0; }

        .loading-bar {
            width: 200px;
            height: 4px;
            background: #3d3d5c;
            border-radius: 2px;
            margin: 20px auto;
            overflow: hidden;
        }

        .loading-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #4acfff);
            width: 0%;
            transition: width 0.3s;
        }

        .serial-console {
            background: #0a0a14;
            border-top: 1px solid #3d3d5c;
            max-height: 150px;
            overflow-y: auto;
        }

        .serial-output {
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #0f0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .info-panel {
            background: #2d2d44;
            border-radius: 8px;
            padding: 16px;
        }

        .info-panel h3 {
            color: #4a9eff;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3d3d5c;
        }

        .os-info {
            margin-bottom: 20px;
        }

        .os-info .name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .os-info .desc {
            font-size: 0.85rem;
            opacity: 0.7;
            line-height: 1.4;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag {
            padding: 3px 8px;
            background: #3d3d5c;
            border-radius: 4px;
            font-size: 11px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .stat-row .label { color: #a0a0b0; }
        .stat-row .value { font-family: monospace; }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-indicator.running { background: #4caf50; }
        .status-indicator.stopped { background: #f44336; }
        .status-indicator.loading { background: #ff9800; }

        .progress-section {
            margin-top: 16px;
        }

        .progress-row {
            margin-bottom: 8px;
        }

        .progress-row .label {
            font-size: 11px;
            color: #a0a0b0;
            margin-bottom: 4px;
        }

        .progress-bar-small {
            height: 4px;
            background: #3d3d5c;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-small .fill {
            height: 100%;
            background: #4a9eff;
            transition: width 0.3s;
        }

        .credits {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #3d3d5c;
            font-size: 11px;
            color: #666;
            text-align: center;
        }

        .credits a {
            color: #4a9eff;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>v86 Browser Emulator</h1>
            <p>Run real operating systems directly in your browser</p>
        </header>

        <div class="toolbar">
            <label>
                <select id="os-select">
                    <option value="">-- Select OS --</option>
                    <optgroup label="Linux">
                        <option value="archlinux">Arch Linux (32-bit, GUI)</option>
                        <option value="buildroot">Buildroot Linux (CLI, Fast)</option>
                        <option value="dsl">Damn Small Linux (GUI)</option>
                        <option value="tinycore">Tiny Core Linux (GUI)</option>
                    </optgroup>
                    <optgroup label="BSD">
                        <option value="freebsd">FreeBSD 12.0</option>
                        <option value="openbsd">OpenBSD</option>
                        <option value="netbsd">NetBSD 4.0</option>
                    </optgroup>
                    <optgroup label="Windows">
                        <option value="windows98">Windows 98</option>
                        <option value="windows2000">Windows 2000</option>
                        <option value="windows1">Windows 1.01</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="freedos">FreeDOS</option>
                        <option value="kolibri">KolibriOS (Assembly OS)</option>
                        <option value="serenity">SerenityOS</option>
                        <option value="haiku">Haiku OS</option>
                        <option value="reactos">ReactOS</option>
                    </optgroup>
                </select>
            </label>

            <button id="btn-start" class="primary" disabled>Start</button>
            <button id="btn-stop" class="danger" disabled>Stop</button>
            <button id="btn-reset" disabled>Reset</button>
            <button id="btn-pause" disabled>Pause</button>
            <button id="btn-fullscreen">Fullscreen</button>
            <button id="btn-screenshot">Screenshot</button>
        </div>

        <div class="main-area">
            <div class="screen-area">
                <!-- Boot message overlay (shown before emulator starts) -->
                <div id="boot-overlay" class="boot-message">
                    <h2>v86 x86 Emulator</h2>
                    <p>Select an operating system from the dropdown above</p>
                    <p style="font-size: 12px;">Powered by <a href="https://copy.sh/v86/" style="color: #4a9eff;">copy.sh/v86</a></p>
                </div>
                <!-- v86 screen container - REQUIRED STRUCTURE for ScreenAdapter -->
                <div id="screen_container" style="display: none;">
                    <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
                    <canvas style="display: none"></canvas>
                </div>
                <div class="serial-console" style="display: none;">
                    <div id="serial-output" class="serial-output"></div>
                </div>
            </div>

            <div class="info-panel">
                <h3>Operating System</h3>
                <div class="os-info">
                    <div class="name" id="os-name">No OS Selected</div>
                    <div class="desc" id="os-desc">Select an operating system to begin</div>
                    <div class="tags" id="os-tags"></div>
                </div>

                <h3>Status</h3>
                <div class="stat-row">
                    <span class="label">Status</span>
                    <span class="value"><span class="status-indicator stopped"></span><span id="status-text">Stopped</span></span>
                </div>
                <div class="stat-row">
                    <span class="label">Runtime</span>
                    <span class="value" id="runtime">--:--</span>
                </div>
                <div class="stat-row">
                    <span class="label">IPS</span>
                    <span class="value" id="ips">0</span>
                </div>

                <div class="progress-section" id="progress-section" style="display: none;">
                    <div class="progress-row">
                        <div class="label">Download Progress</div>
                        <div class="progress-bar-small">
                            <div class="fill" id="download-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <h3>Setup Instructions</h3>
                <div class="download-links" style="font-size: 11px; margin-bottom: 16px;">
                    <p style="margin-bottom: 8px; opacity: 0.7;">Download images to <code>v86/images/</code>:</p>
                    <a href="https://copy.sh/v86/images/freedos722.img" target="_blank" style="display: block; color: #4a9eff; margin: 4px 0;">FreeDOS (720KB)</a>
                    <a href="https://copy.sh/v86/images/kolibri.img" target="_blank" style="display: block; color: #4a9eff; margin: 4px 0;">KolibriOS (1.4MB)</a>
                    <a href="https://copy.sh/v86/images/windows101.img" target="_blank" style="display: block; color: #4a9eff; margin: 4px 0;">Windows 1.01 (720KB)</a>
                    <p style="margin-top: 8px; opacity: 0.5; font-size: 10px;">Or use copy.sh/v86 directly</p>
                </div>

                <div class="credits">
                    <p>Emulator by <a href="https://github.com/copy/v86">copy/v86</a></p>
                    <p>Images hosted on copy.sh</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // v86 Emulator Controller
        class V86Controller {
            constructor() {
                this.emulator = null;
                this.isRunning = false;
                this.startTime = null;
                this.statsInterval = null;
                this.lastInstructions = 0;
                this.lastStatsTime = 0;

                // Image host - copy.sh CDN
                this.imageHost = 'https://i.copy.sh/';
                this.largeImageHost = 'https://k.copy.sh/';

                // OS Configurations matching copy.sh/v86 profiles
                this.profiles = {
                    archlinux: {
                        name: 'Arch Linux',
                        description: 'Modern Arch Linux 32-bit with Xorg, Firefox, and more. Uses 9p filesystem.',
                        tags: ['Linux', 'GUI', '32-bit', '~800MB'],
                        memory_size: 512 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        filesystem: {
                            baseurl: 'https://k.copy.sh/arch/',
                            basefs: 'https://k.copy.sh/fs.json'
                        },
                        cmdline: 'rw root=host9p rootfstype=9p rootflags=trans=virtio,cache=loose modules=virtio_pci tsc=reliable init_on_free=on',
                        bzimage_initrd_from_filesystem: true,
                        acpi: true,
                        autostart: true
                    },
                    buildroot: {
                        name: 'Buildroot Linux',
                        description: 'Minimal command-line Linux. Fast boot, small footprint.',
                        tags: ['Linux', 'CLI', '32-bit', '5MB'],
                        memory_size: 128 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                        bzimage: { url: 'https://i.copy.sh/buildroot-bzimage68.bin' },
                        cmdline: 'console=ttyS0',
                        autostart: true
                    },
                    dsl: {
                        name: 'Damn Small Linux',
                        description: 'Lightweight Linux with GUI. Includes Firefox 2.0, text editors, etc.',
                        tags: ['Linux', 'GUI', '32-bit', '50MB'],
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        cdrom: { url: 'https://i.copy.sh/dsl-4.11.rc2.iso' },
                        autostart: true
                    },
                    tinycore: {
                        name: 'Tiny Core Linux',
                        description: 'Minimal Linux with GUI desktop. Very fast boot.',
                        tags: ['Linux', 'GUI', '32-bit', '16MB'],
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        cdrom: { url: 'https://i.copy.sh/TinyCore-11.0.iso' },
                        autostart: true
                    },
                    freebsd: {
                        name: 'FreeBSD 12.0',
                        description: 'FreeBSD with Xorg desktop environment.',
                        tags: ['BSD', 'GUI', '32-bit', '~500MB'],
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        hda: { url: 'https://k.copy.sh/freebsd/', async: true, size: 2 * 1024 * 1024 * 1024 },
                        state: { url: 'https://k.copy.sh/freebsd_state-v2.bin.zst' },
                        autostart: true
                    },
                    openbsd: {
                        name: 'OpenBSD',
                        description: 'Security-focused BSD operating system.',
                        tags: ['BSD', 'CLI', '32-bit', '~200MB'],
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                        fda: { url: 'https://i.copy.sh/openbsd-floppy.img' },
                        autostart: true
                    },
                    netbsd: {
                        name: 'NetBSD 4.0',
                        description: 'Portable BSD with Xorg.',
                        tags: ['BSD', 'GUI', '32-bit'],
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        hda: { url: 'https://k.copy.sh/netbsd/.img', async: true },
                        autostart: true
                    },
                    windows98: {
                        name: 'Windows 98',
                        description: 'Classic Windows 98 with full GUI.',
                        tags: ['Windows', 'GUI', '32-bit', '~300MB'],
                        memory_size: 128 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        hda: { url: 'https://k.copy.sh/windows98/', async: true, size: 300 * 1024 * 1024 },
                        state: { url: 'https://k.copy.sh/windows98_state-v2.bin.zst' },
                        autostart: true
                    },
                    windows2000: {
                        name: 'Windows 2000',
                        description: 'Windows 2000 Professional.',
                        tags: ['Windows', 'GUI', '32-bit', '~500MB'],
                        memory_size: 512 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        hda: { url: 'https://k.copy.sh/windows2k-v2/.img', async: true },
                        state: { url: 'https://k.copy.sh/windows2k_state-v4.bin.zst' },
                        autostart: true
                    },
                    windows1: {
                        name: 'Windows 1.01',
                        description: 'The original Windows from 1985.',
                        tags: ['Windows', 'GUI', '16-bit', '1MB'],
                        memory_size: 32 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                        fda: { url: 'https://i.copy.sh/windows101.img' },
                        autostart: true
                    },
                    freedos: {
                        name: 'FreeDOS',
                        description: 'Free DOS-compatible operating system. Download freedos722.img to v86/images/',
                        tags: ['DOS', 'CLI', '16-bit', '720KB'],
                        memory_size: 32 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                        fda: { url: 'v86/images/freedos722.img' },
                        autostart: true
                    },
                    kolibri: {
                        name: 'KolibriOS',
                        description: 'Tiny graphical OS written in assembly. Download kolibri.img to v86/images/',
                        tags: ['Hobby OS', 'GUI', '32-bit', '1.4MB'],
                        memory_size: 128 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        fda: { url: 'v86/images/kolibri.img' },
                        autostart: true
                    },
                    serenity: {
                        name: 'SerenityOS',
                        description: 'Modern Unix-like OS with retro aesthetics.',
                        tags: ['Hobby OS', 'GUI', '32-bit', '~400MB'],
                        memory_size: 512 * 1024 * 1024,
                        vga_memory_size: 64 * 1024 * 1024,
                        hda: { url: 'https://k.copy.sh/serenity-v3/.img.zst', async: true },
                        state: { url: 'https://k.copy.sh/serenity_state-v4.bin.zst' },
                        autostart: true
                    },
                    haiku: {
                        name: 'Haiku OS',
                        description: 'Open-source BeOS successor with native GUI.',
                        tags: ['Hobby OS', 'GUI', '32-bit', '~400MB'],
                        memory_size: 512 * 1024 * 1024,
                        vga_memory_size: 64 * 1024 * 1024,
                        hda: { url: 'https://k.copy.sh/haiku-v2/.img', async: true },
                        state: { url: 'https://k.copy.sh/haiku_state-v2.bin.zst' },
                        autostart: true
                    },
                    reactos: {
                        name: 'ReactOS',
                        description: 'Open-source Windows-compatible OS.',
                        tags: ['Windows-like', 'GUI', '32-bit'],
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                        cdrom: { url: 'https://i.copy.sh/reactos-livecd-0.4.14-dev-1603-gb85f3db-x86-gcc-lin-dbg.iso' },
                        autostart: true
                    }
                };

                this.init();
            }

            init() {
                this.bindEvents();
                this.checkV86Available();
            }

            bindEvents() {
                document.getElementById('os-select').addEventListener('change', (e) => this.onOSSelect(e.target.value));
                document.getElementById('btn-start').addEventListener('click', () => this.start());
                document.getElementById('btn-stop').addEventListener('click', () => this.stop());
                document.getElementById('btn-reset').addEventListener('click', () => this.reset());
                document.getElementById('btn-pause').addEventListener('click', () => this.togglePause());
                document.getElementById('btn-fullscreen').addEventListener('click', () => this.fullscreen());
                document.getElementById('btn-screenshot').addEventListener('click', () => this.screenshot());
            }

            checkV86Available() {
                // Handle both V86 and V86Starter constructor names (npm vs source build)
                if (typeof V86Starter === 'undefined' && typeof V86 === 'undefined') {
                    document.getElementById('boot-overlay').innerHTML = `
                        <h2 style="color: #f44336;">v86 Library Not Loaded</h2>
                        <p>The v86 emulator library failed to load.</p>
                        <p style="font-size: 12px; margin-top: 16px;">This may be due to network issues or CORS restrictions.</p>
                        <p style="font-size: 12px; margin-top: 8px;">Try running a local server: <code>python3 -m http.server 8000</code></p>
                    `;
                    return false;
                }
                // Set global constructor reference
                window.V86Constructor = typeof V86Starter !== 'undefined' ? V86Starter : V86;
                return true;
            }

            onOSSelect(profileId) {
                if (!profileId) {
                    document.getElementById('btn-start').disabled = true;
                    document.getElementById('os-name').textContent = 'No OS Selected';
                    document.getElementById('os-desc').textContent = 'Select an operating system to begin';
                    document.getElementById('os-tags').innerHTML = '';
                    return;
                }

                const profile = this.profiles[profileId];
                if (profile) {
                    document.getElementById('os-name').textContent = profile.name;
                    document.getElementById('os-desc').textContent = profile.description;
                    document.getElementById('os-tags').innerHTML = profile.tags.map(t => `<span class="tag">${t}</span>`).join('');
                    document.getElementById('btn-start').disabled = false;
                }
            }

            async start() {
                if (!this.checkV86Available()) return;

                const profileId = document.getElementById('os-select').value;
                const profile = this.profiles[profileId];
                if (!profile) return;

                // Stop existing emulator
                this.stop();

                // Update UI - use boot-overlay for loading messages
                const bootOverlay = document.getElementById('boot-overlay');
                bootOverlay.innerHTML = `
                    <h2>Loading ${profile.name}...</h2>
                    <p>Downloading disk image and initializing emulator</p>
                    <div class="loading-bar"><div class="fill" id="loading-fill"></div></div>
                    <p id="loading-status" style="font-size: 12px;">Preparing...</p>
                `;
                bootOverlay.style.display = 'flex';
                document.getElementById('screen_container').style.display = 'none';

                document.getElementById('progress-section').style.display = 'block';
                this.updateStatus('loading', 'Loading...');

                // Build emulator config
                // JS/WASM from jsDelivr CDN, BIOS from GitHub raw (binary files work)
                const config = {
                    wasm_path: 'https://cdn.jsdelivr.net/npm/v86@latest/build/v86.wasm',
                    bios: { url: 'https://raw.githubusercontent.com/copy/v86/master/bios/seabios.bin' },
                    vga_bios: { url: 'https://raw.githubusercontent.com/copy/v86/master/bios/vgabios.bin' },
                    screen_container: document.getElementById('screen_container'),
                    memory_size: profile.memory_size,
                    vga_memory_size: profile.vga_memory_size,
                    autostart: profile.autostart !== false,
                    disable_keyboard: false,
                    disable_mouse: false
                };

                // Add boot media
                if (profile.filesystem) {
                    config.filesystem = profile.filesystem;
                    config.bzimage_initrd_from_filesystem = profile.bzimage_initrd_from_filesystem;
                }
                if (profile.bzimage) config.bzimage = profile.bzimage;
                if (profile.cdrom) config.cdrom = profile.cdrom;
                if (profile.hda) config.hda = profile.hda;
                if (profile.fda) config.fda = profile.fda;
                if (profile.state) config.initial_state = profile.state;
                if (profile.cmdline) config.cmdline = profile.cmdline;
                if (profile.acpi) config.acpi = profile.acpi;

                // Add serial output for CLI systems
                config.serial_container_xtermjs = document.getElementById('serial-output');

                try {
                    this.emulator = new window.V86Constructor(config);

                    // Track download progress
                    this.emulator.add_listener('download-progress', (e) => {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('download-progress').style.width = percent + '%';
                        document.getElementById('loading-fill').style.width = percent + '%';
                        document.getElementById('loading-status').textContent = `Downloading: ${percent}% (${(e.loaded / 1024 / 1024).toFixed(1)} MB)`;
                    });

                    // Track emulator ready
                    this.emulator.add_listener('emulator-ready', () => {
                        this.isRunning = true;
                        this.startTime = Date.now();
                        this.updateStatus('running', 'Running');
                        this.startStatsUpdate();
                        document.getElementById('btn-stop').disabled = false;
                        document.getElementById('btn-reset').disabled = false;
                        document.getElementById('btn-pause').disabled = false;
                        document.getElementById('progress-section').style.display = 'none';
                        // Hide boot overlay, show emulator screen
                        document.getElementById('boot-overlay').style.display = 'none';
                        document.getElementById('screen_container').style.display = 'block';
                        document.querySelector('.serial-console').style.display = profile.bzimage && !profile.hda ? 'block' : 'none';
                    });

                } catch (error) {
                    console.error('Failed to start emulator:', error);
                    document.getElementById('boot-overlay').innerHTML = `
                        <h2 style="color: #f44336;">Failed to Start</h2>
                        <p>${error.message}</p>
                        <p style="font-size: 12px; margin-top: 10px;">Make sure you're running a local server and v86-master/ folder exists.</p>
                    `;
                    document.getElementById('boot-overlay').style.display = 'flex';
                }
            }

            stop() {
                if (this.emulator) {
                    this.emulator.stop();
                    this.emulator.destroy();
                    this.emulator = null;
                }
                this.isRunning = false;
                this.startTime = null;
                this.stopStatsUpdate();
                this.updateStatus('stopped', 'Stopped');
                document.getElementById('btn-stop').disabled = true;
                document.getElementById('btn-reset').disabled = true;
                document.getElementById('btn-pause').disabled = true;
                document.getElementById('runtime').textContent = '--:--';
                document.getElementById('ips').textContent = '0';
            }

            reset() {
                if (this.emulator) {
                    this.emulator.restart();
                    this.startTime = Date.now();
                }
            }

            togglePause() {
                if (!this.emulator) return;

                if (this.emulator.is_running()) {
                    this.emulator.stop();
                    this.updateStatus('stopped', 'Paused');
                    document.getElementById('btn-pause').textContent = 'Resume';
                } else {
                    this.emulator.run();
                    this.updateStatus('running', 'Running');
                    document.getElementById('btn-pause').textContent = 'Pause';
                }
            }

            fullscreen() {
                const container = document.getElementById('screen_container');
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                }
            }

            screenshot() {
                if (!this.emulator) return;

                const canvas = document.querySelector('#screen_container canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = 'v86-screenshot.png';
                    link.href = canvas.toDataURL();
                    link.click();
                }
            }

            updateStatus(state, text) {
                const indicator = document.querySelector('.status-indicator');
                indicator.className = 'status-indicator ' + state;
                document.getElementById('status-text').textContent = text;
            }

            startStatsUpdate() {
                this.lastStatsTime = Date.now();
                this.lastInstructions = 0;

                this.statsInterval = setInterval(() => {
                    if (!this.emulator || !this.isRunning) return;

                    // Update runtime
                    const elapsed = Date.now() - this.startTime;
                    const mins = Math.floor(elapsed / 60000);
                    const secs = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('runtime').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                    // Update IPS
                    const now = Date.now();
                    const stats = this.emulator.get_statistics();
                    if (stats) {
                        const timeDelta = (now - this.lastStatsTime) / 1000;
                        const instrDelta = stats.cpu_time - this.lastInstructions;
                        const ips = Math.round(instrDelta / timeDelta);
                        document.getElementById('ips').textContent = this.formatNumber(ips);
                        this.lastInstructions = stats.cpu_time;
                        this.lastStatsTime = now;
                    }
                }, 1000);
            }

            stopStatsUpdate() {
                if (this.statsInterval) {
                    clearInterval(this.statsInterval);
                    this.statsInterval = null;
                }
            }

            formatNumber(n) {
                if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
                if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
                if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
                return n.toString();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            window.vm = new V86Controller();
        });
    </script>
</body>
</html>
