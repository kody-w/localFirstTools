<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 95 Desktop Simulator - Interactive Edition</title>
    <meta name="description" content="Fully interactive Windows 95 desktop simulator with working programs, draggable windows, and authentic UI">
    <style>
        /* Windows 95 Color Palette - Authentic solid colors */
        :root {
            --desktop-teal: #008080;
            --button-face: #c0c0c0;
            --button-shadow: #808080;
            --button-dark-shadow: #000000;
            --button-highlight: #ffffff;
            --button-light: #dfdfdf;
            --active-title-bar: #000080;
            --inactive-title-bar: #808080;
            --window-background: #ffffff;
            --text-color: #000000;
            --menu-highlight: #000080;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', Arial, sans-serif;
            font-size: 11px;
            background: var(--desktop-teal);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #fff;
            overflow: hidden;
            user-select: none;
        }

        .header {
            background: var(--active-title-bar);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 2px solid var(--button-face);
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ff0000 0%, #ffff00 25%, #00ff00 50%, #0000ff 100%);
            display: inline-block;
            position: relative;
            transform: perspective(10px) rotateY(-5deg);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Authentic Windows 95 3D button effect */
        .btn {
            padding: 3px 8px;
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-highlight),
                inset 2px 2px 0 var(--button-light),
                inset -1px -1px 0 var(--button-dark-shadow),
                inset -2px -2px 0 var(--button-shadow);
            color: var(--text-color);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            outline: none;
            position: relative;
            min-height: 22px;
        }

        /* Pressed button effect */
        .btn:active {
            box-shadow:
                inset -1px -1px 0 var(--button-highlight),
                inset -2px -2px 0 var(--button-light),
                inset 1px 1px 0 var(--button-dark-shadow),
                inset 2px 2px 0 var(--button-shadow);
            padding: 4px 7px 2px 9px;
        }

        /* Focus state for accessibility */
        .btn:focus-visible {
            outline: 1px dotted var(--text-color);
            outline-offset: -4px;
        }

        .btn:disabled {
            color: var(--button-shadow);
            text-shadow: 1px 1px 0 var(--button-highlight);
            cursor: default;
        }

        .btn.primary {
            background: var(--active-title-bar);
            color: white;
            font-weight: bold;
            border: 1px solid #000;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            overflow: auto;
        }

        .emulator-frame {
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-light),
                inset 2px 2px 0 var(--button-highlight),
                inset -1px -1px 0 var(--button-shadow),
                inset -2px -2px 0 var(--button-dark-shadow),
                0 0 30px rgba(0,0,0,0.5);
            padding: 3px;
            position: relative;
            max-width: 95vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        /* Fullscreen mode styling */
        .emulator-frame.fullscreen-mode {
            max-width: 100vw;
            max-height: 100vh;
            width: 100vw;
            height: 100vh;
        }

        .emulator-frame.fullscreen-mode #screen_container {
            background: #008080; /* Match desktop teal background */
        }

        .emulator-titlebar {
            background: var(--active-title-bar);
            color: white;
            padding: 2px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            font-weight: bold;
            user-select: none;
            height: 18px;
            cursor: default;
        }

        .emulator-titlebar.inactive {
            background: var(--inactive-title-bar);
        }

        .titlebar-buttons {
            display: flex;
            gap: 2px;
        }

        .titlebar-btn {
            width: 16px;
            height: 14px;
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-highlight),
                inset -1px -1px 0 var(--button-dark-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 10px;
            font-weight: bold;
            color: var(--text-color);
        }

        .titlebar-btn:active {
            box-shadow:
                inset -1px -1px 0 var(--button-highlight),
                inset 1px 1px 0 var(--button-dark-shadow);
            padding-top: 1px;
            padding-left: 1px;
        }

        .titlebar-btn:hover {
            background: var(--button-light);
        }

        #screen_container {
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }

        #screen {
            /* Scale canvas to fit container while maintaining aspect ratio */
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            /* Width and height controlled by #screen selector for proper scaling */
        }

        .status-bar {
            background: var(--button-face);
            border-top: 1px solid var(--button-highlight);
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            color: var(--text-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-section {
            border-left: 1px solid var(--button-shadow);
            border-right: 1px solid var(--button-highlight);
            padding: 0 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-section:first-child {
            border-left: none;
            padding-left: 0;
        }

        .led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--button-shadow);
            box-shadow: inset 0 0 2px rgba(0,0,0,0.5);
            transition: all 0.1s ease;
        }

        .led.active {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00, inset 0 0 2px rgba(255,255,255,0.5);
        }

        .led.hdd {
            background: #ff0000;
        }

        .led.hdd.active {
            background: #ff6600;
            box-shadow: 0 0 5px #ff6600, inset 0 0 2px rgba(255,255,255,0.5);
        }

        .setup-screen {
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-light),
                inset 2px 2px 0 var(--button-highlight),
                inset -1px -1px 0 var(--button-shadow),
                inset -2px -2px 0 var(--button-dark-shadow),
                0 0 20px rgba(0,0,0,0.5);
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setup-screen h2 {
            background: var(--active-title-bar);
            color: white;
            padding: 4px 8px;
            margin: -20px -20px 15px -20px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 14px;
        }

        .setup-content {
            color: var(--text-color);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
        }

        .setup-content p {
            margin: 8px 0;
            line-height: 1.4;
        }

        .setup-option {
            margin: 15px 0;
            padding: 10px;
            background: var(--window-background);
            border: 1px solid var(--button-shadow);
            box-shadow: inset -1px -1px 0 var(--button-highlight);
        }

        .setup-option h3 {
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--active-title-bar);
        }

        .setup-option p {
            margin: 5px 0;
            line-height: 1.4;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 1;
        }

        .file-input-label {
            display: inline-block;
            padding: 3px 8px;
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-highlight),
                inset 2px 2px 0 var(--button-light),
                inset -1px -1px 0 var(--button-dark-shadow),
                inset -2px -2px 0 var(--button-shadow);
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            color: var(--text-color);
        }

        input[type="text"],
        select {
            padding: 2px 4px;
            border: 1px solid var(--button-shadow);
            box-shadow: inset -1px -1px 0 var(--button-highlight);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            background: var(--window-background);
        }

        input[type="text"]:focus,
        select:focus {
            outline: 1px dotted var(--text-color);
            outline-offset: -2px;
        }

        label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 2px 0;
        }

        input[type="checkbox"] {
            width: 13px;
            height: 13px;
            cursor: pointer;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .loading-screen.active {
            display: flex;
        }

        .boot-logo {
            width: 200px;
            height: 150px;
            background: linear-gradient(135deg, #ff0000 0%, #ffff00 25%, #00ff00 50%, #0000ff 100%);
            margin-bottom: 30px;
            position: relative;
            animation: bootWave 2s infinite;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        @keyframes bootWave {
            0%, 100% { transform: perspective(100px) rotateY(0deg); }
            50% { transform: perspective(100px) rotateY(10deg); }
        }

        .loading-text {
            color: #c0c0c0;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: #000;
            border: 2px solid #c0c0c0;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
        }

        .progress-fill {
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                #000080 0px,
                #000080 10px,
                #1084d0 10px,
                #1084d0 20px
            );
            width: 0%;
            transition: width 0.3s ease;
            animation: slide 1s linear infinite;
        }

        @keyframes slide {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #ffffcc;
            border: 2px solid var(--text-color);
            padding: 10px;
            max-width: 300px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            color: var(--text-color);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
        }

        .info-panel h4 {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .info-panel ul {
            margin-left: 20px;
            margin-top: 5px;
        }

        .info-panel li {
            margin: 3px 0;
            line-height: 1.3;
        }

        .warning-icon {
            color: #ff0000;
            font-weight: bold;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        /* Desktop icons styling */
        .desktop-icon {
            position: absolute;
            width: 64px;
            text-align: center;
            cursor: pointer;
            user-select: none;
        }

        .desktop-icon.selected .icon-text {
            background: var(--menu-highlight);
            color: white;
        }

        .icon-image {
            width: 32px;
            height: 32px;
            margin: 0 auto 4px;
        }

        .icon-text {
            font-size: 11px;
            padding: 1px 2px;
            word-wrap: break-word;
        }

        /* Window styling improvements */
        .window {
            position: absolute;
            background: var(--button-face);
            border: 2px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
            box-shadow: 1px 1px 0 var(--button-shadow);
            min-width: 200px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .window.minimized {
            display: none;
        }

        .window.active {
            z-index: 1000;
        }

        .window-titlebar {
            background: var(--active-title-bar);
            color: white;
            padding: 2px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            cursor: move;
            height: 18px;
            user-select: none;
        }

        .window-titlebar.inactive {
            background: var(--inactive-title-bar);
        }

        .window-content {
            background: var(--window-background);
            padding: 8px;
            overflow: auto;
            flex: 1;
            color: var(--text-color);
        }

        .taskbar-button {
            min-width: 100px;
            max-width: 200px;
            padding: 2px 4px;
            margin: 2px;
            background: var(--button-face);
            border: 2px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
            cursor: pointer;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .taskbar-button.active {
            border-color: var(--button-dark-shadow) var(--button-highlight) var(--button-highlight) var(--button-dark-shadow);
            padding: 3px 3px 1px 5px;
        }

        .start-menu {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 200px;
            background: var(--button-face);
            border: 2px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
            display: none;
            z-index: 10000;
        }

        .start-menu.active {
            display: block;
        }

        .start-menu-sidebar {
            background: var(--inactive-title-bar);
            color: white;
            padding: 20px 4px;
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            font-weight: bold;
            font-size: 16px;
        }

        .start-menu-items {
            padding: 2px;
        }

        .start-menu-item {
            padding: 4px 30px 4px 8px;
            cursor: pointer;
            position: relative;
            font-size: 11px;
        }

        .start-menu-item:hover {
            background: var(--menu-highlight);
            color: white;
        }

        .start-menu-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
        }

        .context-menu {
            position: absolute;
            background: var(--button-face);
            border: 2px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
            padding: 2px;
            min-width: 150px;
            display: none;
            z-index: 10001;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }

        .context-menu-item:hover {
            background: var(--menu-highlight);
            color: white;
        }

        .context-menu-separator {
            height: 1px;
            background: var(--button-shadow);
            margin: 2px 4px;
        }

        /* Scrollbar styling for Windows 95 authenticity */
        .setup-screen::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }

        .setup-screen::-webkit-scrollbar-track {
            background: var(--button-face);
        }

        .setup-screen::-webkit-scrollbar-thumb {
            background: var(--button-face);
            border: 1px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
        }

        .setup-screen::-webkit-scrollbar-button {
            background: var(--button-face);
            border: 1px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
        }

        /* Reduced motion support for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .btn {
                min-height: 44px;
                min-width: 44px;
                padding: 0.6rem 1rem;
                font-size: 12px;
            }

            .info-panel {
                position: static;
                margin-top: 1rem;
                max-width: 100%;
            }

            .controls {
                width: 100%;
                justify-content: center;
            }
        }

        /* Tooltip styling */
        .tooltip {
            position: absolute;
            background: #ffffcc;
            border: 1px solid var(--text-color);
            padding: 2px 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="logo"></span> Windows 95 Desktop Simulator</h1>
        <div class="controls" role="toolbar" aria-label="Desktop controls">
            <button class="btn" id="pause-btn" onclick="emulator.togglePause()" aria-label="Pause desktop" title="Pause/Resume">
                <span aria-hidden="true">‚è∏</span> Pause
            </button>
            <button class="btn" onclick="emulator.restart()" aria-label="Restart desktop" title="Restart desktop">
                <span aria-hidden="true">üîÑ</span> Restart
            </button>
            <button class="btn" onclick="emulator.fullscreen()" aria-label="Enter fullscreen mode" title="Toggle fullscreen">
                <span aria-hidden="true">üñ•</span> Fullscreen
            </button>
            <button class="btn" onclick="emulator.screenshot()" aria-label="Take screenshot" title="Save screenshot">
                <span aria-hidden="true">üì∑</span> Screenshot
            </button>
            <button class="btn" onclick="emulator.showHelp()" aria-label="Show help information" title="Help & Information">
                <span aria-hidden="true">‚ùì</span> Help
            </button>
            <button class="btn primary" onclick="emulator.openAbout()" aria-label="About this simulator" title="About">
                <span aria-hidden="true">‚ÑπÔ∏è</span> About
            </button>
        </div>
    </div>

    <div class="main-container">
        <div id="setup-screen" class="setup-screen" role="dialog" aria-labelledby="setup-title">
            <h2 id="setup-title">Windows 95 Desktop Simulator</h2>
            <div class="setup-content">
                <p><strong>Welcome to the Interactive Windows 95 Desktop Simulator!</strong></p>
                <p>Experience a fully functional Windows 95 desktop environment right in your browser.</p>

                <div class="setup-option">
                    <h3><span aria-hidden="true">üéÆ</span> Start Desktop Experience</h3>
                    <p>Launch the interactive desktop with working programs and classic Windows 95 interface.</p>
                    <p><strong>Features:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><strong>Internet Explorer</strong> - Browse real websites!</li>
                        <li>Draggable, resizable windows</li>
                        <li>Working Notepad, Calculator, and Minesweeper</li>
                        <li>Functional Start menu</li>
                        <li>Clickable desktop icons</li>
                        <li>Right-click context menus</li>
                        <li>Authentic Windows 95 aesthetics</li>
                    </ul>
                    <button class="btn primary" onclick="emulator.loadDemo()" style="margin-top: 10px;">Start Windows 95 Desktop</button>
                </div>

                <div class="setup-option" style="background: #e0e0e0;">
                    <h3><span aria-hidden="true">‚öôÔ∏è</span> Emulator Settings</h3>
                    <div style="display: grid; gap: 8px;">
                        <label>
                            <input type="checkbox" id="enable-mouse"> Enable Mouse Lock (Leave OFF for interactive desktop)
                        </label>
                        <label>
                            <input type="checkbox" id="enable-sound"> Enable Sound Emulation
                        </label>
                        <label>
                            <input type="checkbox" id="enable-network" checked> Enable Network
                        </label>
                        <label style="display: block; margin-top: 8px;">
                            <strong>Memory Allocation:</strong>
                            <select id="memory-size" style="width: 100%; margin-top: 4px;">
                                <option value="8">8 MB (Minimum)</option>
                                <option value="16">16 MB (Low)</option>
                                <option value="32" selected>32 MB (Recommended)</option>
                                <option value="64">64 MB (High)</option>
                                <option value="128">128 MB (Maximum)</option>
                            </select>
                        </label>
                        <label style="display: block; margin-top: 8px;">
                            <strong>CPU Speed:</strong>
                            <select id="cpu-speed" style="width: 100%; margin-top: 4px;">
                                <option value="1">1x (Authentic)</option>
                                <option value="2" selected>2x (Balanced)</option>
                                <option value="4">4x (Fast)</option>
                                <option value="8">8x (Maximum)</option>
                            </select>
                        </label>
                    </div>
                </div>

                <div class="setup-option" style="background: #fff8dc;">
                    <h3><span aria-hidden="true">‚ÑπÔ∏è</span> System Information</h3>
                    <p><strong>Browser:</strong> <span id="browser-info">Detecting...</span></p>
                    <p><strong>WebAssembly:</strong> <span id="wasm-support">Checking...</span></p>
                    <p><strong>Screen:</strong> <span id="screen-info">Detecting...</span></p>
                </div>
            </div>
        </div>

        <div id="emulator-container" class="emulator-frame hidden">
            <div class="emulator-titlebar" id="emulator-titlebar">
                <span>Windows 95 Desktop - Interactive Mode</span>
                <div class="titlebar-buttons">
                    <div class="titlebar-btn" onclick="emulator.minimize()" role="button" aria-label="Minimize" title="Minimize">_</div>
                    <div class="titlebar-btn" onclick="emulator.maximize()" role="button" aria-label="Maximize" title="Maximize">‚ñ°</div>
                    <div class="titlebar-btn" onclick="emulator.close()" role="button" aria-label="Close" title="Close">X</div>
                </div>
            </div>
            <div id="screen_container">
                <canvas id="screen" role="img" aria-label="Windows 95 emulator screen" tabindex="0"></canvas>
            </div>
            <div class="status-bar" role="status" aria-live="polite" aria-atomic="false">
                <div class="status-section">
                    <span id="cpu-status-label">CPU:</span>
                    <span id="cpu-status" aria-labelledby="cpu-status-label">Idle</span>
                    <div class="led" id="cpu-led" role="status" aria-label="CPU activity indicator" title="CPU Activity"></div>
                </div>
                <div class="status-section">
                    <span>HDD:</span>
                    <div class="led hdd" id="hdd-led" role="status" aria-label="Hard drive activity indicator" title="HDD Activity"></div>
                </div>
                <div class="status-section">
                    <span>FPS:</span>
                    <span id="fps-counter" aria-label="Frames per second">0</span>
                </div>
                <div class="status-section">
                    <span>MEM:</span>
                    <span id="memory-usage" aria-label="Memory usage">0 MB</span>
                </div>
                <div class="status-section">
                    <span id="time-display" aria-label="Uptime" title="Uptime">00:00:00</span>
                </div>
            </div>
        </div>

        <div class="info-panel" id="info-panel">
            <h4><span class="warning-icon" aria-hidden="true">üí°</span> Quick Start Guide</h4>
            <ul>
                <li><strong>Try Internet Explorer!</strong> Browse real websites (try wikipedia.org)</li>
                <li><strong>Double-click</strong> desktop icons to launch programs</li>
                <li><strong>Drag</strong> windows by their title bars to move them</li>
                <li><strong>Click</strong> the Start button for the program menu</li>
                <li><strong>Right-click</strong> the desktop for context menu</li>
                <li><strong>Minimize</strong> windows to the taskbar</li>
                <li>Press <strong>F11</strong> for fullscreen mode</li>
                <li><strong>Note:</strong> Mouse lock is disabled for free movement</li>
            </ul>
            <button class="btn" onclick="document.getElementById('info-panel').classList.add('hidden')" style="margin-top: 8px; width: 100%;">Got it!</button>
        </div>
    </div>

    <div class="loading-screen" id="loading-screen" role="alert" aria-live="assertive">
        <div class="boot-logo" aria-hidden="true"></div>
        <div class="loading-text" id="loading-text">Starting Windows 95 Desktop...</div>
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Polyfill for String.padStart (IE11, Safari < 10)
        if (!String.prototype.padStart) {
            String.prototype.padStart = function padStart(targetLength, padString) {
                targetLength = targetLength >> 0;
                padString = String(typeof padString !== 'undefined' ? padString : ' ');
                if (this.length >= targetLength) {
                    return String(this);
                }
                targetLength = targetLength - this.length;
                if (targetLength > padString.length) {
                    padString += padString.repeat(targetLength / padString.length);
                }
                return padString.slice(0, targetLength) + String(this);
            };
        }

        // Configuration constants
        const CONFIG = {
            DISPLAY: {
                WIDTH: 640,
                HEIGHT: 480,
                TASKBAR_HEIGHT: 30
            },
            COLORS: {
                DESKTOP: '#008080',
                TASKBAR: '#c0c0c0',
                TITLE_BAR: '#000080',
                WINDOW_BG: '#ffffff'
            },
            ANIMATION: {
                FPS_UPDATE_INTERVAL: 1000,
                LED_THROTTLE_FRAMES: 10,
                BOOT_MESSAGE_DELAY: 150
            },
            PERFORMANCE: {
                MAX_FPS: 60,
                FRAME_TIME: 16.67
            }
        };

        // Window Manager - handles all window operations
        class WindowManager {
            constructor(desktop) {
                this.desktop = desktop;
                this.windows = [];
                this.nextZIndex = 1000;
                this.draggedWindow = null;
                this.dragOffset = { x: 0, y: 0 };
            }

            createWindow(title, content, options = {}) {
                const windowId = 'win-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                const windowEl = document.createElement('div');
                windowEl.className = 'window active';
                windowEl.id = windowId;
                windowEl.style.left = (options.x || 100 + this.windows.length * 30) + 'px';
                windowEl.style.top = (options.y || 100 + this.windows.length * 30) + 'px';
                windowEl.style.width = (options.width || 400) + 'px';
                windowEl.style.height = (options.height || 300) + 'px';
                windowEl.style.zIndex = this.nextZIndex++;

                const titleBar = document.createElement('div');
                titleBar.className = 'window-titlebar';
                titleBar.innerHTML = `
                    <span>${title}</span>
                    <div class="titlebar-buttons">
                        <div class="titlebar-btn minimize-btn" title="Minimize">_</div>
                        <div class="titlebar-btn maximize-btn" title="Maximize">‚ñ°</div>
                        <div class="titlebar-btn close-btn" title="Close">X</div>
                    </div>
                `;

                const contentEl = document.createElement('div');
                contentEl.className = 'window-content';
                if (typeof content === 'string') {
                    contentEl.innerHTML = content;
                } else {
                    contentEl.appendChild(content);
                }

                windowEl.appendChild(titleBar);
                windowEl.appendChild(contentEl);

                // Add to desktop
                const screenContainer = document.getElementById('screen_container');
                screenContainer.appendChild(windowEl);

                // Setup event listeners
                this.setupWindowEvents(windowEl, titleBar);

                // Store window reference
                const windowObj = {
                    id: windowId,
                    element: windowEl,
                    title: title,
                    minimized: false
                };
                this.windows.push(windowObj);

                // Add taskbar button
                this.desktop.addTaskbarButton(windowObj);

                // Focus window
                this.focusWindow(windowEl);

                return windowObj;
            }

            setupWindowEvents(windowEl, titleBar) {
                // Make titlebar draggable
                titleBar.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.titlebar-btn')) return;

                    this.draggedWindow = windowEl;
                    this.dragOffset = {
                        x: e.clientX - windowEl.offsetLeft,
                        y: e.clientY - windowEl.offsetTop
                    };
                    this.focusWindow(windowEl);
                });

                // Close button
                const closeBtn = windowEl.querySelector('.close-btn');
                closeBtn.addEventListener('click', () => this.closeWindow(windowEl));

                // Minimize button
                const minimizeBtn = windowEl.querySelector('.minimize-btn');
                minimizeBtn.addEventListener('click', () => this.minimizeWindow(windowEl));

                // Maximize button
                const maximizeBtn = windowEl.querySelector('.maximize-btn');
                maximizeBtn.addEventListener('click', () => this.maximizeWindow(windowEl));

                // Focus on click
                windowEl.addEventListener('mousedown', () => this.focusWindow(windowEl));
            }

            focusWindow(windowEl) {
                // Remove active class from all windows
                this.windows.forEach(win => {
                    win.element.classList.remove('active');
                    const titlebar = win.element.querySelector('.window-titlebar');
                    if (titlebar) titlebar.classList.add('inactive');
                });

                // Set active window
                windowEl.classList.add('active');
                windowEl.style.zIndex = this.nextZIndex++;
                const titlebar = windowEl.querySelector('.window-titlebar');
                if (titlebar) titlebar.classList.remove('inactive');

                // Update taskbar buttons
                this.desktop.updateTaskbarButtons();
            }

            minimizeWindow(windowEl) {
                const windowObj = this.windows.find(w => w.element === windowEl);
                if (windowObj) {
                    windowObj.minimized = true;
                    windowEl.classList.add('minimized');
                    this.desktop.updateTaskbarButtons();
                }
            }

            maximizeWindow(windowEl) {
                const isMaximized = windowEl.dataset.maximized === 'true';

                if (isMaximized) {
                    // Restore
                    windowEl.style.left = windowEl.dataset.restoreLeft;
                    windowEl.style.top = windowEl.dataset.restoreTop;
                    windowEl.style.width = windowEl.dataset.restoreWidth;
                    windowEl.style.height = windowEl.dataset.restoreHeight;
                    windowEl.dataset.maximized = 'false';
                } else {
                    // Store current position
                    windowEl.dataset.restoreLeft = windowEl.style.left;
                    windowEl.dataset.restoreTop = windowEl.style.top;
                    windowEl.dataset.restoreWidth = windowEl.style.width;
                    windowEl.dataset.restoreHeight = windowEl.style.height;

                    // Maximize
                    windowEl.style.left = '0px';
                    windowEl.style.top = '0px';
                    windowEl.style.width = '640px';
                    windowEl.style.height = '450px';
                    windowEl.dataset.maximized = 'true';
                }
            }

            restoreWindow(windowEl) {
                const windowObj = this.windows.find(w => w.element === windowEl);
                if (windowObj && windowObj.minimized) {
                    windowObj.minimized = false;
                    windowEl.classList.remove('minimized');
                    this.focusWindow(windowEl);
                    this.desktop.updateTaskbarButtons();
                }
            }

            closeWindow(windowEl) {
                const index = this.windows.findIndex(w => w.element === windowEl);
                if (index > -1) {
                    const windowObj = this.windows[index];
                    this.desktop.removeTaskbarButton(windowObj);
                    windowEl.remove();
                    this.windows.splice(index, 1);
                }
            }

            handleMouseMove(e) {
                if (this.draggedWindow) {
                    const newX = Math.max(0, Math.min(640 - 100, e.clientX - this.dragOffset.x));
                    const newY = Math.max(0, Math.min(450 - 30, e.clientY - this.dragOffset.y));
                    this.draggedWindow.style.left = newX + 'px';
                    this.draggedWindow.style.top = newY + 'px';
                }
            }

            handleMouseUp() {
                this.draggedWindow = null;
            }
        }

        class Windows95Emulator {
            constructor() {
                this.v86 = null;
                this.isRunning = false;
                this.isPaused = false;
                this.startTime = Date.now();
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                this.lastFrameTime = 0;
                this.hddLedTimeout = null;
                this.canvas = null;
                this.ctx = null;
                this.domCache = null;
                this.memoryUsage = 0;
                this.cpuUsage = 0;

                this.settings = {
                    memory: 32 * 1024 * 1024,
                    enableMouse: false,
                    enableSound: false,
                    enableNetwork: true,
                    cpuSpeed: 2
                };

                this.desktop = {
                    icons: [],
                    windows: []
                };

                this.windowManager = new WindowManager(this);
                this.taskbarButtons = [];

                this.initEmulatorCore();
                this.detectSystemInfo();
            }

            // Programs
            openNotepad() {
                const content = document.createElement('div');
                content.innerHTML = `
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div style="background: var(--button-face); padding: 2px; border-bottom: 1px solid var(--button-shadow);">
                            <button class="btn" onclick="alert('File menu')">File</button>
                            <button class="btn" onclick="alert('Edit menu')">Edit</button>
                            <button class="btn" onclick="alert('Help menu')">Help</button>
                        </div>
                        <textarea id="notepad-textarea" style="flex: 1; border: none; font-family: 'Courier New', monospace; font-size: 12px; padding: 4px; resize: none; outline: none; width: 100%; box-sizing: border-box;"></textarea>
                    </div>
                `;
                this.windowManager.createWindow('Untitled - Notepad', content, { width: 500, height: 400 });
            }

            openCalculator() {
                const content = document.createElement('div');
                content.innerHTML = `
                    <div style="padding: 10px;">
                        <input type="text" id="calc-display" readonly style="width: 100%; margin-bottom: 10px; text-align: right; font-size: 18px; padding: 5px; border: 2px inset; background: white;" value="0">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px;">
                            <button class="btn" onclick="emulator.calcInput('7')">7</button>
                            <button class="btn" onclick="emulator.calcInput('8')">8</button>
                            <button class="btn" onclick="emulator.calcInput('9')">9</button>
                            <button class="btn" onclick="emulator.calcInput('/')">/</button>
                            <button class="btn" onclick="emulator.calcInput('4')">4</button>
                            <button class="btn" onclick="emulator.calcInput('5')">5</button>
                            <button class="btn" onclick="emulator.calcInput('6')">6</button>
                            <button class="btn" onclick="emulator.calcInput('*')">*</button>
                            <button class="btn" onclick="emulator.calcInput('1')">1</button>
                            <button class="btn" onclick="emulator.calcInput('2')">2</button>
                            <button class="btn" onclick="emulator.calcInput('3')">3</button>
                            <button class="btn" onclick="emulator.calcInput('-')">-</button>
                            <button class="btn" onclick="emulator.calcInput('0')" style="grid-column: span 2;">0</button>
                            <button class="btn" onclick="emulator.calcInput('.')">.</button>
                            <button class="btn" onclick="emulator.calcInput('+')">+</button>
                            <button class="btn primary" onclick="emulator.calcEquals()" style="grid-column: span 4;">=</button>
                            <button class="btn" onclick="emulator.calcClear()" style="grid-column: span 4;">C</button>
                        </div>
                    </div>
                `;
                this.windowManager.createWindow('Calculator', content, { width: 240, height: 320 });
                this.calcExpression = '';
            }

            calcInput(value) {
                const display = document.getElementById('calc-display');
                if (display) {
                    if (this.calcExpression === '' || this.calcExpression === '0') {
                        this.calcExpression = value;
                    } else {
                        this.calcExpression += value;
                    }
                    display.value = this.calcExpression;
                }
            }

            calcEquals() {
                const display = document.getElementById('calc-display');
                if (display && this.calcExpression) {
                    try {
                        const result = eval(this.calcExpression);
                        display.value = result;
                        this.calcExpression = result.toString();
                    } catch (e) {
                        display.value = 'Error';
                        this.calcExpression = '';
                    }
                }
            }

            calcClear() {
                const display = document.getElementById('calc-display');
                if (display) {
                    display.value = '0';
                    this.calcExpression = '';
                }
            }

            openMinesweeper() {
                const content = document.createElement('div');
                const rows = 10, cols = 10, mines = 15;
                let board = this.createMinesweeperBoard(rows, cols, mines);

                content.innerHTML = `
                    <div style="padding: 10px; text-align: center;">
                        <div style="background: var(--button-face); padding: 5px; margin-bottom: 10px; border: 2px inset;">
                            <strong>Mines: ${mines}</strong> | <strong>Flags: <span id="flag-count">0</span></strong>
                        </div>
                        <div id="minesweeper-board" style="display: inline-grid; grid-template-columns: repeat(${cols}, 24px); gap: 0; border: 2px outset var(--button-face);"></div>
                    </div>
                `;

                const boardEl = content.querySelector('#minesweeper-board');
                board.forEach((row, r) => {
                    row.forEach((cell, c) => {
                        const cellBtn = document.createElement('button');
                        cellBtn.className = 'btn';
                        cellBtn.style.cssText = 'width: 24px; height: 24px; padding: 0; font-size: 10px; font-weight: bold;';
                        cellBtn.dataset.row = r;
                        cellBtn.dataset.col = c;
                        cellBtn.onclick = () => this.revealCell(boardEl, board, r, c);
                        cellBtn.oncontextmenu = (e) => {
                            e.preventDefault();
                            this.toggleFlag(cellBtn);
                            return false;
                        };
                        boardEl.appendChild(cellBtn);
                    });
                });

                this.windowManager.createWindow('Minesweeper', content, { width: 300, height: 380 });
            }

            createMinesweeperBoard(rows, cols, mines) {
                const board = Array(rows).fill().map(() => Array(cols).fill(0));
                let placedMines = 0;

                while (placedMines < mines) {
                    const r = Math.floor(Math.random() * rows);
                    const c = Math.floor(Math.random() * cols);
                    if (board[r][c] !== -1) {
                        board[r][c] = -1;
                        placedMines++;

                        for (let dr = -1; dr <= 1; dr++) {
                            for (let dc = -1; dc <= 1; dc++) {
                                const nr = r + dr, nc = c + dc;
                                if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc] !== -1) {
                                    board[nr][nc]++;
                                }
                            }
                        }
                    }
                }
                return board;
            }

            revealCell(boardEl, board, row, col) {
                const cellBtn = boardEl.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (!cellBtn || cellBtn.disabled || cellBtn.textContent === 'üö©') return;

                const value = board[row][col];
                cellBtn.disabled = true;
                cellBtn.style.background = '#c0c0c0';
                cellBtn.style.borderStyle = 'solid';

                if (value === -1) {
                    cellBtn.textContent = 'üí£';
                    alert('Game Over! You hit a mine!');
                } else if (value === 0) {
                    cellBtn.textContent = '';
                    // Auto-reveal adjacent cells
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            this.revealCell(boardEl, board, row + dr, col + dc);
                        }
                    }
                } else {
                    const colors = ['', 'blue', 'green', 'red', 'purple', 'maroon', 'turquoise', 'black', 'gray'];
                    cellBtn.textContent = value;
                    cellBtn.style.color = colors[value];
                }
            }

            toggleFlag(cellBtn) {
                if (cellBtn.disabled) return;
                const flagCount = document.getElementById('flag-count');
                if (cellBtn.textContent === 'üö©') {
                    cellBtn.textContent = '';
                    if (flagCount) flagCount.textContent = parseInt(flagCount.textContent) - 1;
                } else {
                    cellBtn.textContent = 'üö©';
                    if (flagCount) flagCount.textContent = parseInt(flagCount.textContent) + 1;
                }
            }

            openInternetExplorer() {
                const content = document.createElement('div');
                content.style.cssText = 'display: flex; flex-direction: column; height: 100%; overflow: hidden;';

                // Create IE toolbar
                const toolbar = document.createElement('div');
                toolbar.style.cssText = 'background: var(--button-face); padding: 2px; border-bottom: 1px solid var(--button-shadow); display: flex; gap: 2px; align-items: center;';
                toolbar.innerHTML = `
                    <button class="btn" onclick="emulator.ieNavigate('back')" title="Back">‚óÄ</button>
                    <button class="btn" onclick="emulator.ieNavigate('forward')" title="Forward">‚ñ∂</button>
                    <button class="btn" onclick="emulator.ieNavigate('refresh')" title="Refresh">üîÑ</button>
                    <button class="btn" onclick="emulator.ieNavigate('home')" title="Home">üè†</button>
                    <button class="btn" onclick="emulator.ieNavigate('stop')" title="Stop">‚èπ</button>
                    <div style="flex: 1; display: flex; align-items: center; gap: 4px; margin-left: 4px;">
                        <span style="font-size: 11px; font-weight: bold;">Address:</span>
                        <input type="text" id="ie-address-bar" value="https://example.com"
                            style="flex: 1; padding: 2px 4px; border: 1px solid var(--button-shadow); font-size: 11px;"
                            onkeypress="if(event.key==='Enter') emulator.ieNavigate('go')">
                        <button class="btn" onclick="emulator.ieNavigate('go')">Go</button>
                    </div>
                `;

                // Create status bar
                const statusBar = document.createElement('div');
                statusBar.style.cssText = 'background: var(--button-face); border-top: 1px solid var(--button-highlight); padding: 2px 4px; font-size: 11px; display: flex; align-items: center; gap: 8px;';
                statusBar.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div class="led" id="ie-status-led"></div>
                        <span id="ie-status-text">Ready</span>
                    </div>
                    <div style="flex: 1;"></div>
                    <span style="font-size: 10px;">Internet zone</span>
                `;

                // Create iframe container
                const iframeContainer = document.createElement('div');
                iframeContainer.style.cssText = 'flex: 1; background: white; position: relative; overflow: hidden;';

                const iframe = document.createElement('iframe');
                iframe.id = 'ie-browser-frame';
                iframe.src = 'https://example.com';
                iframe.style.cssText = 'width: 100%; height: 100%; border: none;';
                iframe.sandbox = 'allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox';

                // Loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'ie-loading';
                loadingDiv.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; background: #ffffcc; padding: 4px 8px; font-size: 11px; border-bottom: 1px solid #808080; display: none;';
                loadingDiv.innerHTML = '‚è≥ Loading page...';

                iframeContainer.appendChild(loadingDiv);
                iframeContainer.appendChild(iframe);

                // Assemble the browser
                content.appendChild(toolbar);
                content.appendChild(iframeContainer);
                content.appendChild(statusBar);

                // Create window
                const win = this.windowManager.createWindow('Internet Explorer', content, {
                    width: 600,
                    height: 500,
                    x: 50,
                    y: 50
                });

                // Store current window ID for navigation
                this.currentIEWindowId = win.id;

                // Setup iframe event listeners
                iframe.addEventListener('load', () => {
                    const led = document.getElementById('ie-status-led');
                    const statusText = document.getElementById('ie-status-text');
                    const loading = document.getElementById('ie-loading');

                    if (led) led.classList.remove('active');
                    if (statusText) statusText.textContent = 'Done';
                    if (loading) loading.style.display = 'none';

                    // Try to update address bar with current URL (won't work for cross-origin)
                    try {
                        const addressBar = document.getElementById('ie-address-bar');
                        if (addressBar && iframe.contentWindow) {
                            addressBar.value = iframe.contentWindow.location.href;
                        }
                    } catch (e) {
                        // Cross-origin, can't access
                    }
                });

                // Show loading state
                const led = document.getElementById('ie-status-led');
                const statusText = document.getElementById('ie-status-text');
                const loading = document.getElementById('ie-loading');
                if (led) led.classList.add('active');
                if (statusText) statusText.textContent = 'Loading...';
                if (loading) loading.style.display = 'block';
            }

            ieNavigate(action) {
                const iframe = document.getElementById('ie-browser-frame');
                const addressBar = document.getElementById('ie-address-bar');
                const led = document.getElementById('ie-status-led');
                const statusText = document.getElementById('ie-status-text');
                const loading = document.getElementById('ie-loading');

                if (!iframe) return;

                try {
                    switch (action) {
                        case 'back':
                            window.history.back();
                            break;
                        case 'forward':
                            window.history.forward();
                            break;
                        case 'refresh':
                            iframe.src = iframe.src;
                            if (led) led.classList.add('active');
                            if (statusText) statusText.textContent = 'Refreshing...';
                            if (loading) loading.style.display = 'block';
                            break;
                        case 'home':
                            iframe.src = 'https://example.com';
                            if (addressBar) addressBar.value = 'https://example.com';
                            if (led) led.classList.add('active');
                            if (statusText) statusText.textContent = 'Loading home page...';
                            if (loading) loading.style.display = 'block';
                            break;
                        case 'stop':
                            iframe.src = '';
                            if (led) led.classList.remove('active');
                            if (statusText) statusText.textContent = 'Stopped';
                            if (loading) loading.style.display = 'none';
                            break;
                        case 'go':
                            if (addressBar) {
                                let url = addressBar.value.trim();

                                // Add protocol if missing
                                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                                    url = 'https://' + url;
                                }

                                iframe.src = url;
                                if (led) led.classList.add('active');
                                if (statusText) statusText.textContent = 'Connecting...';
                                if (loading) loading.style.display = 'block';
                            }
                            break;
                    }
                } catch (error) {
                    console.error('Navigation error:', error);
                    if (statusText) statusText.textContent = 'Error loading page';
                    if (led) led.classList.remove('active');
                    if (loading) loading.style.display = 'none';
                }
            }

            openPaint() {
                const content = document.createElement('div');
                content.style.cssText = 'display: flex; flex-direction: column; height: 100%; overflow: hidden;';

                // Paint toolbar
                const toolbar = document.createElement('div');
                toolbar.style.cssText = 'background: var(--button-face); padding: 2px; border-bottom: 1px solid var(--button-shadow); display: flex; gap: 2px; flex-wrap: wrap;';
                toolbar.innerHTML = `
                    <button class="btn" title="Pencil" onclick="emulator.paintSetTool('pencil')">‚úèÔ∏è</button>
                    <button class="btn" title="Brush" onclick="emulator.paintSetTool('brush')">üñåÔ∏è</button>
                    <button class="btn" title="Line" onclick="emulator.paintSetTool('line')">üìè</button>
                    <button class="btn" title="Rectangle" onclick="emulator.paintSetTool('rect')">‚ñ≠</button>
                    <button class="btn" title="Circle" onclick="emulator.paintSetTool('circle')">‚óã</button>
                    <button class="btn" title="Fill" onclick="emulator.paintSetTool('fill')">ü™£</button>
                    <button class="btn" title="Eraser" onclick="emulator.paintSetTool('eraser')">üßπ</button>
                    <button class="btn" onclick="emulator.paintClear()">Clear</button>
                    <div style="display: flex; gap: 2px; align-items: center; margin-left: auto;">
                        <span style="font-size: 11px;">Color:</span>
                        <input type="color" id="paint-color" value="#000000" style="width: 40px; height: 22px; border: 1px solid var(--button-shadow);">
                        <span style="font-size: 11px;">Size:</span>
                        <input type="range" id="paint-size" min="1" max="20" value="3" style="width: 60px;">
                    </div>
                `;

                // Canvas container
                const canvasContainer = document.createElement('div');
                canvasContainer.style.cssText = 'flex: 1; background: white; overflow: auto; position: relative;';

                const canvas = document.createElement('canvas');
                canvas.id = 'paint-canvas';
                canvas.width = 640;
                canvas.height = 480;
                canvas.style.cssText = 'display: block; cursor: crosshair; background: white;';

                canvasContainer.appendChild(canvas);
                content.appendChild(toolbar);
                content.appendChild(canvasContainer);

                this.windowManager.createWindow('Paint', content, { width: 680, height: 560 });

                // Initialize paint
                this.initPaint(canvas);
            }

            initPaint(canvas) {
                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                let startX, startY;
                let currentTool = 'pencil';
                let tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;

                this.paintSetTool = (tool) => {
                    currentTool = tool;
                };

                this.paintClear = () => {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                };

                canvas.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    startX = e.clientX - rect.left;
                    startY = e.clientY - rect.top;

                    // Save current canvas state
                    tempCanvas.getContext('2d').drawImage(canvas, 0, 0);

                    const colorInput = document.getElementById('paint-color');
                    const sizeInput = document.getElementById('paint-size');
                    if (colorInput) ctx.strokeStyle = colorInput.value;
                    if (colorInput) ctx.fillStyle = colorInput.value;
                    if (sizeInput) ctx.lineWidth = parseInt(sizeInput.value);
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    if (currentTool === 'pencil' || currentTool === 'brush') {
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                    }
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!isDrawing) return;

                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    if (currentTool === 'pencil' || currentTool === 'brush') {
                        ctx.lineTo(x, y);
                        ctx.stroke();
                    } else if (currentTool === 'eraser') {
                        ctx.clearRect(x - ctx.lineWidth/2, y - ctx.lineWidth/2, ctx.lineWidth, ctx.lineWidth);
                    } else {
                        // For shapes, restore canvas and draw preview
                        ctx.putImageData(tempCanvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height), 0, 0);

                        if (currentTool === 'line') {
                            ctx.beginPath();
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(x, y);
                            ctx.stroke();
                        } else if (currentTool === 'rect') {
                            ctx.strokeRect(startX, startY, x - startX, y - startY);
                        } else if (currentTool === 'circle') {
                            const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
                            ctx.beginPath();
                            ctx.arc(startX, startY, radius, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    }
                });

                canvas.addEventListener('mouseup', (e) => {
                    if (!isDrawing) return;
                    isDrawing = false;

                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    if (currentTool === 'fill') {
                        // Simple fill (basic implementation)
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                });

                canvas.addEventListener('mouseleave', () => {
                    isDrawing = false;
                });

                // Clear canvas initially
                this.paintClear();
            }

            openFileExplorer() {
                const content = document.createElement('div');
                content.style.cssText = 'display: flex; flex-direction: column; height: 100%; overflow: hidden;';

                // Toolbar
                const toolbar = document.createElement('div');
                toolbar.style.cssText = 'background: var(--button-face); padding: 2px; border-bottom: 1px solid var(--button-shadow); display: flex; gap: 2px; align-items: center;';
                toolbar.innerHTML = `
                    <button class="btn" onclick="emulator.explorerNavigate('back')" title="Back">‚óÄ</button>
                    <button class="btn" onclick="emulator.explorerNavigate('up')" title="Up">‚¨Ü</button>
                    <div style="flex: 1; margin: 0 4px; padding: 2px 4px; border: 1px solid var(--button-shadow); background: white; font-size: 11px;" id="explorer-path">
                        C:\\
                    </div>
                `;

                // Content area
                const contentArea = document.createElement('div');
                contentArea.id = 'explorer-content';
                contentArea.style.cssText = 'flex: 1; background: white; padding: 8px; overflow: auto;';

                content.appendChild(toolbar);
                content.appendChild(contentArea);

                this.windowManager.createWindow('My Computer', content, { width: 500, height: 400 });

                this.initFileExplorer();
            }

            initFileExplorer() {
                this.fileSystem = {
                    'C:\\': {
                        type: 'folder',
                        contents: {
                            'Windows': { type: 'folder', contents: {} },
                            'Program Files': { type: 'folder', contents: {} },
                            'My Documents': {
                                type: 'folder',
                                contents: {
                                    'readme.txt': { type: 'file', size: '1 KB' },
                                    'notes.txt': { type: 'file', size: '2 KB' }
                                }
                            },
                            'autoexec.bat': { type: 'file', size: '156 bytes' },
                            'config.sys': { type: 'file', size: '89 bytes' }
                        }
                    }
                };

                this.currentPath = 'C:\\';
                this.explorerHistory = ['C:\\'];
                this.explorerHistoryIndex = 0;

                this.explorerNavigate = (action) => {
                    if (action === 'back' && this.explorerHistoryIndex > 0) {
                        this.explorerHistoryIndex--;
                        this.currentPath = this.explorerHistory[this.explorerHistoryIndex];
                        this.renderExplorer();
                    } else if (action === 'up') {
                        const parts = this.currentPath.split('\\').filter(p => p);
                        if (parts.length > 1) {
                            parts.pop();
                            this.currentPath = parts.join('\\') + '\\';
                            if (!this.currentPath.includes(':\\')) {
                                this.currentPath = parts[0] + ':\\' + this.currentPath.split(':\\')[1];
                            }
                            this.addToHistory(this.currentPath);
                            this.renderExplorer();
                        }
                    }
                };

                this.explorerOpenFolder = (name) => {
                    this.currentPath = this.currentPath + name + '\\';
                    this.addToHistory(this.currentPath);
                    this.renderExplorer();
                };

                this.addToHistory = (path) => {
                    this.explorerHistory = this.explorerHistory.slice(0, this.explorerHistoryIndex + 1);
                    this.explorerHistory.push(path);
                    this.explorerHistoryIndex = this.explorerHistory.length - 1;
                };

                this.renderExplorer();
            }

            renderExplorer() {
                const contentArea = document.getElementById('explorer-content');
                const pathDisplay = document.getElementById('explorer-path');

                if (!contentArea || !pathDisplay) return;

                pathDisplay.textContent = this.currentPath;

                // Get current folder contents
                const parts = this.currentPath.split('\\').filter(p => p);
                let current = this.fileSystem['C:\\'];

                for (let i = 1; i < parts.length; i++) {
                    if (current.contents && current.contents[parts[i]]) {
                        current = current.contents[parts[i]];
                    }
                }

                // Render contents
                contentArea.innerHTML = '';

                if (current.contents) {
                    Object.keys(current.contents).forEach(name => {
                        const item = current.contents[name];
                        const itemEl = document.createElement('div');
                        itemEl.style.cssText = 'display: inline-flex; flex-direction: column; align-items: center; width: 80px; padding: 8px; margin: 4px; cursor: pointer;';
                        itemEl.innerHTML = `
                            <div style="font-size: 32px; margin-bottom: 4px;">${item.type === 'folder' ? 'üìÅ' : 'üìÑ'}</div>
                            <div style="font-size: 11px; text-align: center; word-wrap: break-word;">${name}</div>
                            ${item.size ? `<div style="font-size: 9px; color: #808080;">${item.size}</div>` : ''}
                        `;

                        if (item.type === 'folder') {
                            itemEl.addEventListener('dblclick', () => this.explorerOpenFolder(name));
                        } else {
                            itemEl.addEventListener('dblclick', () => {
                                this.openNotepad();
                                // Could load file content here
                            });
                        }

                        contentArea.appendChild(itemEl);
                    });
                } else {
                    contentArea.innerHTML = '<div style="padding: 20px; color: #808080;">Empty folder</div>';
                }
            }

            openDOSPrompt() {
                const content = document.createElement('div');
                content.style.cssText = 'display: flex; flex-direction: column; height: 100%; background: #000; color: #0f0; font-family: "Courier New", monospace; font-size: 13px;';

                const output = document.createElement('div');
                output.id = 'terminal-output';
                output.style.cssText = 'flex: 1; padding: 8px; overflow-y: auto; white-space: pre-wrap;';
                output.innerHTML = `Linux Terminal Emulator v1.0
Type 'help' for available commands

user@win95:~$ `;

                const inputLine = document.createElement('div');
                inputLine.style.cssText = 'display: flex; padding: 0 8px 8px 8px;';
                inputLine.innerHTML = `
                    <span id="terminal-prompt" style="margin-right: 4px; color: #0f0;">user@win95:~$</span>
                    <input type="text" id="terminal-input" style="flex: 1; background: #000; color: #0f0; border: none; outline: none; font-family: 'Courier New', monospace; font-size: 13px;">
                `;

                content.appendChild(output);
                content.appendChild(inputLine);

                this.windowManager.createWindow('Linux Terminal', content, { width: 700, height: 450 });

                // Initialize Linux terminal
                this.initLinuxTerminal();
            }

            initLinuxTerminal() {
                // Virtual filesystem
                this.linuxFS = {
                    '/': {
                        type: 'dir',
                        contents: {
                            'home': {
                                type: 'dir',
                                contents: {
                                    'user': {
                                        type: 'dir',
                                        contents: {
                                            'welcome.txt': { type: 'file', content: 'Welcome to the Linux Terminal Emulator!\nType commands like ls, cat, echo, etc.' },
                                            'notes.txt': { type: 'file', content: 'This is a text file.' }
                                        }
                                    }
                                }
                            },
                            'bin': { type: 'dir', contents: {} },
                            'etc': { type: 'dir', contents: {} },
                            'var': { type: 'dir', contents: {} },
                            'tmp': { type: 'dir', contents: {} }
                        }
                    }
                };

                this.terminalCwd = '/home/user';
                this.terminalHistory = [];
                this.terminalHistoryIndex = -1;
                this.terminalEnv = {
                    USER: 'user',
                    HOME: '/home/user',
                    PATH: '/bin:/usr/bin',
                    PWD: '/home/user'
                };

                const input = document.getElementById('terminal-input');
                const prompt = document.getElementById('terminal-prompt');

                if (input) {
                    input.focus();

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            const command = input.value.trim();
                            if (command) {
                                this.terminalHistory.push(command);
                                this.terminalHistoryIndex = this.terminalHistory.length;
                                this.executeLinuxCommand(command);
                            } else {
                                this.terminalPrint('');
                            }
                            input.value = '';
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (this.terminalHistoryIndex > 0) {
                                this.terminalHistoryIndex--;
                                input.value = this.terminalHistory[this.terminalHistoryIndex];
                            }
                        } else if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (this.terminalHistoryIndex < this.terminalHistory.length - 1) {
                                this.terminalHistoryIndex++;
                                input.value = this.terminalHistory[this.terminalHistoryIndex];
                            } else {
                                this.terminalHistoryIndex = this.terminalHistory.length;
                                input.value = '';
                            }
                        } else if (e.key === 'Tab') {
                            e.preventDefault();
                            // Tab completion could be added here
                        }
                    });
                }
            }

            terminalPrint(text, color = '#0f0') {
                const output = document.getElementById('terminal-output');
                if (!output) return;

                const promptText = this.getTerminalPrompt();
                output.innerHTML += `<span style="color: ${color}">${text}</span>\n${promptText}`;
                output.scrollTop = output.scrollHeight;
            }

            getTerminalPrompt() {
                const shortPath = this.terminalCwd.replace('/home/user', '~');
                return `<span style="color: #0f0;">user@win95</span>:<span style="color: #00f;">${shortPath}</span>$ `;
            }

            executeLinuxCommand(cmdLine) {
                const output = document.getElementById('terminal-output');
                const prompt = document.getElementById('terminal-prompt');

                if (!output) return;

                // Echo command
                output.innerHTML += cmdLine + '\n';

                const parts = cmdLine.trim().split(/\s+/);
                const cmd = parts[0];
                const args = parts.slice(1);

                let response = '';

                switch (cmd) {
                    case 'help':
                        response = `Available commands:

File Operations:
  ls [-la]          - List directory contents
  cd <dir>          - Change directory
  pwd               - Print working directory
  cat <file>        - Display file contents
  mkdir <dir>       - Create directory
  touch <file>      - Create empty file
  rm <file>         - Remove file
  tree              - Show directory tree
  find <dir>        - Search for files
  grep <pat> <file> - Search in files

System Info:
  whoami            - Print current user
  hostname          - Print system name
  uname [-a]        - Print system information
  date              - Display date and time
  uptime            - Show system uptime
  env               - Show environment variables
  export VAR=value  - Set environment variable

Process Management:
  ps                - Show processes
  top               - Display system resource usage
  df                - Show disk usage
  free              - Display memory usage
  which <cmd>       - Locate command

Utilities:
  echo <text>       - Print text
  history           - Show command history
  cal               - Display calendar
  cowsay <text>     - ASCII cow speaks
  fortune           - Random fortune cookie
  clear             - Clear screen
  exit              - Close terminal`;
                        break;

                    case 'ls':
                        response = this.terminalLs(args);
                        break;

                    case 'cd':
                        response = this.terminalCd(args[0] || this.terminalEnv.HOME);
                        break;

                    case 'pwd':
                        response = this.terminalCwd;
                        break;

                    case 'cat':
                        response = this.terminalCat(args[0]);
                        break;

                    case 'echo':
                        response = args.join(' ');
                        break;

                    case 'mkdir':
                        response = this.terminalMkdir(args[0]);
                        break;

                    case 'touch':
                        response = this.terminalTouch(args[0]);
                        break;

                    case 'rm':
                        response = this.terminalRm(args[0]);
                        break;

                    case 'clear':
                        output.innerHTML = this.getTerminalPrompt();
                        if (prompt) prompt.innerHTML = this.getTerminalPrompt();
                        return;

                    case 'whoami':
                        response = this.terminalEnv.USER;
                        break;

                    case 'uname':
                        if (args[0] === '-a') {
                            response = 'Linux win95 5.15.0 #1 SMP x86_64 GNU/Linux';
                        } else {
                            response = 'Linux';
                        }
                        break;

                    case 'date':
                        response = new Date().toString();
                        break;

                    case 'env':
                        response = Object.entries(this.terminalEnv)
                            .map(([k, v]) => `${k}=${v}`)
                            .join('\n');
                        break;

                    case 'export':
                        if (args[0]) {
                            const [key, value] = args[0].split('=');
                            this.terminalEnv[key] = value || '';
                            response = '';
                        } else {
                            response = 'Usage: export VAR=value';
                        }
                        break;

                    case 'tree':
                        response = this.terminalTree();
                        break;

                    case 'grep':
                        response = this.terminalGrep(args);
                        break;

                    case 'find':
                        response = this.terminalFind(args[0] || this.terminalCwd);
                        break;

                    case 'ps':
                        response = this.terminalPs();
                        break;

                    case 'top':
                        response = this.terminalTop();
                        break;

                    case 'df':
                        response = this.terminalDf();
                        break;

                    case 'free':
                        response = this.terminalFree();
                        break;

                    case 'history':
                        response = this.terminalHistory.map((h, i) => `  ${i + 1}  ${h}`).join('\n');
                        break;

                    case 'hostname':
                        response = 'win95';
                        break;

                    case 'uptime':
                        const uptime = Math.floor((Date.now() - this.startTime) / 1000);
                        const hours = Math.floor(uptime / 3600);
                        const mins = Math.floor((uptime % 3600) / 60);
                        response = `up ${hours}:${String(mins).padStart(2, '0')}, 1 user, load average: 0.15, 0.10, 0.05`;
                        break;

                    case 'which':
                        if (args[0]) {
                            const cmds = ['ls', 'cd', 'pwd', 'cat', 'echo', 'mkdir', 'touch', 'rm', 'clear', 'help'];
                            response = cmds.includes(args[0]) ? `/bin/${args[0]}` : `${args[0]} not found`;
                        } else {
                            response = 'which: missing argument';
                        }
                        break;

                    case 'cal':
                        response = this.terminalCal();
                        break;

                    case 'cowsay':
                        response = this.terminalCowsay(args.join(' '));
                        break;

                    case 'fortune':
                        const fortunes = [
                            'You will have a pleasant surprise today.',
                            'A new opportunity is coming your way.',
                            'Good things come to those who code.',
                            'Your hard work will pay off soon.',
                            'Today is a perfect day to learn something new.'
                        ];
                        response = fortunes[Math.floor(Math.random() * fortunes.length)];
                        break;

                    case 'exit':
                        const win = output?.closest('.window');
                        if (win) this.windowManager.closeWindow(win);
                        return;

                    case '':
                        response = '';
                        break;

                    default:
                        response = `bash: ${cmd}: command not found`;
                        break;
                }

                this.terminalPrint(response);

                // Update prompt
                if (prompt) {
                    const shortPath = this.terminalCwd.replace('/home/user', '~');
                    prompt.innerHTML = `<span style="color: #0f0;">user@win95</span>:<span style="color: #00f;">${shortPath}</span>$ `;
                }
            }

            terminalLs(args) {
                const showAll = args.includes('-a') || args.includes('-la');
                const longFormat = args.includes('-l') || args.includes('-la');

                const current = this.terminalGetDir(this.terminalCwd);
                if (!current || current.type !== 'dir') {
                    return 'ls: cannot access directory';
                }

                const items = Object.keys(current.contents || {});
                if (items.length === 0) return '';

                if (longFormat) {
                    return items.map(name => {
                        const item = current.contents[name];
                        const type = item.type === 'dir' ? 'd' : '-';
                        const perms = item.type === 'dir' ? 'rwxr-xr-x' : 'rw-r--r--';
                        const size = item.type === 'file' ? (item.content?.length || 0) : 4096;
                        const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return `${type}${perms} 1 user user ${size.toString().padStart(5)} ${date} ${name}`;
                    }).join('\n');
                } else {
                    return items.join('  ');
                }
            }

            terminalCd(path) {
                if (!path) path = this.terminalEnv.HOME;

                let newPath;
                if (path.startsWith('/')) {
                    newPath = path;
                } else if (path === '..') {
                    const parts = this.terminalCwd.split('/').filter(p => p);
                    parts.pop();
                    newPath = '/' + parts.join('/');
                    if (newPath === '/') newPath = '/';
                } else if (path === '.') {
                    return '';
                } else if (path === '~') {
                    newPath = this.terminalEnv.HOME;
                } else {
                    newPath = this.terminalCwd + (this.terminalCwd.endsWith('/') ? '' : '/') + path;
                }

                const dir = this.terminalGetDir(newPath);
                if (!dir || dir.type !== 'dir') {
                    return `cd: ${path}: No such file or directory`;
                }

                this.terminalCwd = newPath === '' ? '/' : newPath;
                this.terminalEnv.PWD = this.terminalCwd;
                return '';
            }

            terminalCat(filename) {
                if (!filename) return 'cat: missing file operand';

                const path = filename.startsWith('/') ? filename : this.terminalCwd + '/' + filename;
                const file = this.terminalGetDir(path);

                if (!file) {
                    return `cat: ${filename}: No such file or directory`;
                }

                if (file.type === 'dir') {
                    return `cat: ${filename}: Is a directory`;
                }

                return file.content || '';
            }

            terminalMkdir(dirname) {
                if (!dirname) return 'mkdir: missing operand';

                const path = dirname.startsWith('/') ? dirname : this.terminalCwd + '/' + dirname;
                const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
                const name = path.substring(path.lastIndexOf('/') + 1);

                const parent = this.terminalGetDir(parentPath);
                if (!parent || parent.type !== 'dir') {
                    return `mkdir: cannot create directory '${dirname}': No such file or directory`;
                }

                if (parent.contents[name]) {
                    return `mkdir: cannot create directory '${dirname}': File exists`;
                }

                parent.contents[name] = { type: 'dir', contents: {} };
                return '';
            }

            terminalTouch(filename) {
                if (!filename) return 'touch: missing file operand';

                const path = filename.startsWith('/') ? filename : this.terminalCwd + '/' + filename;
                const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
                const name = path.substring(path.lastIndexOf('/') + 1);

                const parent = this.terminalGetDir(parentPath);
                if (!parent || parent.type !== 'dir') {
                    return `touch: cannot touch '${filename}': No such file or directory`;
                }

                if (!parent.contents[name]) {
                    parent.contents[name] = { type: 'file', content: '' };
                }

                return '';
            }

            terminalRm(filename) {
                if (!filename) return 'rm: missing operand';

                const path = filename.startsWith('/') ? filename : this.terminalCwd + '/' + filename;
                const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
                const name = path.substring(path.lastIndexOf('/') + 1);

                const parent = this.terminalGetDir(parentPath);
                if (!parent || parent.type !== 'dir') {
                    return `rm: cannot remove '${filename}': No such file or directory`;
                }

                if (!parent.contents[name]) {
                    return `rm: cannot remove '${filename}': No such file or directory`;
                }

                if (parent.contents[name].type === 'dir') {
                    return `rm: cannot remove '${filename}': Is a directory`;
                }

                delete parent.contents[name];
                return '';
            }

            terminalTree(dir = this.terminalCwd, prefix = '', isLast = true) {
                const current = this.terminalGetDir(dir);
                if (!current || current.type !== 'dir') return '';

                let result = '';
                const items = Object.keys(current.contents || {});

                items.forEach((name, index) => {
                    const item = current.contents[name];
                    const isLastItem = index === items.length - 1;
                    const connector = isLastItem ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
                    const icon = item.type === 'dir' ? 'üìÅ' : 'üìÑ';

                    result += prefix + connector + icon + ' ' + name + '\n';

                    if (item.type === 'dir') {
                        const newPrefix = prefix + (isLastItem ? '    ' : '‚îÇ   ');
                        const subPath = dir + (dir.endsWith('/') ? '' : '/') + name;
                        result += this.terminalTree(subPath, newPrefix, isLastItem);
                    }
                });

                return result;
            }

            terminalGetDir(path) {
                if (!path || path === '/') return this.linuxFS['/'];

                const parts = path.split('/').filter(p => p);
                let current = this.linuxFS['/'];

                for (const part of parts) {
                    if (!current.contents || !current.contents[part]) {
                        return null;
                    }
                    current = current.contents[part];
                }

                return current;
            }

            terminalGrep(args) {
                if (args.length < 2) return 'grep: usage: grep PATTERN FILE';

                const pattern = args[0];
                const filename = args[1];

                const path = filename.startsWith('/') ? filename : this.terminalCwd + '/' + filename;
                const file = this.terminalGetDir(path);

                if (!file) return `grep: ${filename}: No such file or directory`;
                if (file.type === 'dir') return `grep: ${filename}: Is a directory`;

                const lines = (file.content || '').split('\n');
                const matches = lines.filter(line => line.includes(pattern));

                return matches.length > 0 ? matches.join('\n') : '';
            }

            terminalFind(dir) {
                const results = [];
                const search = (path, item) => {
                    results.push(path);
                    if (item.type === 'dir' && item.contents) {
                        Object.keys(item.contents).forEach(name => {
                            const newPath = path + (path.endsWith('/') ? '' : '/') + name;
                            search(newPath, item.contents[name]);
                        });
                    }
                };

                const startDir = this.terminalGetDir(dir);
                if (startDir) {
                    search(dir, startDir);
                }

                return results.join('\n');
            }

            terminalPs() {
                const processes = [
                    '  PID TTY          TIME CMD',
                    '    1 ?        00:00:01 init',
                    '    2 ?        00:00:00 kthreadd',
                    '  123 pts/0    00:00:00 bash',
                    '  456 pts/0    00:00:00 ps'
                ];
                return processes.join('\n');
            }

            terminalTop() {
                return `top - ${new Date().toLocaleTimeString()} up ${Math.floor((Date.now() - this.startTime) / 60000)} min, 1 user, load average: 0.15, 0.10, 0.05

Tasks:  85 total,   1 running,  84 sleeping,   0 stopped,   0 zombie
%Cpu(s):  2.3 us,  1.0 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  ${this.settings.memory / 1024 / 1024} total,  ${Math.floor(this.settings.memory / 1024 / 1024 * 0.6)} free,  ${Math.floor(this.settings.memory / 1024 / 1024 * 0.3)} used,  ${Math.floor(this.settings.memory / 1024 / 1024 * 0.1)} buff/cache

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
    1 root      20   0    2048    512    448 S   0.0   0.1   0:01.23 init
  123 user      20   0    4096   1024    896 S   0.0   0.3   0:00.45 bash
  456 user      20   0    2560    768    640 R   1.3   0.2   0:00.01 top`;
            }

            terminalDf() {
                return `Filesystem     1K-blocks    Used Available Use% Mounted on
/dev/sda1       ${Math.floor(this.settings.memory / 1024)}    ${Math.floor(this.settings.memory / 1024 * 0.4)}    ${Math.floor(this.settings.memory / 1024 * 0.6)}  40% /
tmpfs               1024     128       896  13% /tmp`;
            }

            terminalFree() {
                const total = Math.floor(this.settings.memory / 1024);
                const used = Math.floor(total * 0.3);
                const free = total - used;

                return `              total        used        free      shared  buff/cache   available
Mem:          ${total}        ${used}        ${free}           0           0        ${free}
Swap:             0           0           0`;
            }

            terminalCal() {
                const now = new Date();
                const month = now.toLocaleString('default', { month: 'long' });
                const year = now.getFullYear();
                const firstDay = new Date(year, now.getMonth(), 1).getDay();
                const daysInMonth = new Date(year, now.getMonth() + 1, 0).getDate();

                let cal = `   ${month} ${year}\n`;
                cal += 'Su Mo Tu We Th Fr Sa\n';

                let day = 1;
                let week = '';

                // Add spaces for days before first day of month
                for (let i = 0; i < firstDay; i++) {
                    week += '   ';
                }

                // Add days
                for (let d = firstDay; d < 7 && day <= daysInMonth; d++) {
                    week += String(day).padStart(2, ' ') + ' ';
                    day++;
                }
                cal += week + '\n';

                // Rest of the weeks
                while (day <= daysInMonth) {
                    week = '';
                    for (let d = 0; d < 7 && day <= daysInMonth; d++) {
                        week += String(day).padStart(2, ' ') + ' ';
                        day++;
                    }
                    cal += week + '\n';
                }

                return cal;
            }

            terminalCowsay(message) {
                if (!message) message = 'Moo!';

                const len = message.length;
                const border = '-'.repeat(len + 2);

                return ` ${border}
< ${message} >
 ${border}
        \\   ^__^
         \\  (oo)\\_______
            (__)\\       )\\/\\
                ||----w |
                ||     ||`;
            }

            openSolitaire() {
                const content = document.createElement('div');
                content.style.cssText = 'padding: 20px; text-align: center; background: linear-gradient(135deg, #0a5f0a 0%, #0d7d0d 100%);';

                content.innerHTML = `
                    <div style="background: var(--button-face); padding: 10px; margin-bottom: 10px;">
                        <button class="btn" onclick="emulator.solitaireNewGame()">New Game</button>
                        <button class="btn" onclick="emulator.solitaireDeal()">Deal</button>
                        <button class="btn" onclick="emulator.solitaireUndo()">Undo</button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                        <div style="width: 70px; height: 100px; border: 2px dashed white; background: rgba(0,0,0,0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 40px;">üÇ†</div>
                        <div style="width: 70px; height: 100px; border: 2px dashed white; background: rgba(0,0,0,0.2); border-radius: 4px;"></div>
                        <div style="flex: 1;"></div>
                        <div style="width: 70px; height: 100px; border: 2px solid white; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 40px;">‚ô†</div>
                        <div style="width: 70px; height: 100px; border: 2px solid white; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 40px;">‚ô•</div>
                        <div style="width: 70px; height: 100px; border: 2px solid white; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 40px;">‚ô£</div>
                        <div style="width: 70px; height: 100px; border: 2px solid white; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 40px;">‚ô¶</div>
                    </div>
                    <div id="solitaire-tableau" style="display: flex; gap: 10px; justify-content: center; min-height: 300px;">
                        <div style="width: 70px;">
                            <div style="width: 70px; height: 100px; background: white; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
                                <div>üÇ°</div>
                            </div>
                        </div>
                        <div style="width: 70px;">
                            <div style="width: 70px; height: 100px; background: white; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
                                <div>üÇ±</div>
                            </div>
                        </div>
                        <div style="width: 70px;">
                            <div style="width: 70px; height: 100px; background: white; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
                                <div>üÉÅ</div>
                            </div>
                        </div>
                        <div style="width: 70px;">
                            <div style="width: 70px; height: 100px; background: white; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
                                <div>üÉë</div>
                            </div>
                        </div>
                        <div style="width: 70px;">
                            <div style="width: 70px; height: 100px; background: white; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
                                <div>üÇ¢</div>
                            </div>
                        </div>
                        <div style="width: 70px;">
                            <div style="width: 70px; height: 100px; background: white; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
                                <div>üÇ≤</div>
                            </div>
                        </div>
                        <div style="width: 70px;">
                            <div style="width: 70px; height: 100px; background: white; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
                                <div>üÉÇ</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; color: white; font-size: 12px;">
                        Click "New Game" to shuffle and deal cards!
                    </div>
                `;

                this.windowManager.createWindow('Solitaire', content, { width: 640, height: 520 });

                // Initialize solitaire game state
                this.solitaireState = {
                    moves: 0,
                    score: 0
                };
            }

            solitaireNewGame() {
                alert('New game started! (Full game logic would shuffle and deal cards here)');
            }

            solitaireDeal() {
                alert('Dealing 3 cards from deck...');
            }

            solitaireUndo() {
                alert('Undo last move...');
            }

            openMediaPlayer() {
                const content = document.createElement('div');
                content.style.cssText = 'display: flex; flex-direction: column; height: 100%; background: var(--button-face);';

                content.innerHTML = `
                    <div style="flex: 1; background: black; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <video id="media-player-video" style="max-width: 100%; max-height: 100%;" controls>
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div id="media-visualization" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #00ff00;">
                            ‚ô™‚ô´‚ô™
                        </div>
                    </div>
                    <div style="background: var(--button-face); padding: 8px; border-top: 1px solid var(--button-shadow);">
                        <div style="display: flex; gap: 4px; margin-bottom: 8px; justify-content: center;">
                            <button class="btn" onclick="emulator.mediaControl('prev')" title="Previous">‚èÆ</button>
                            <button class="btn" onclick="emulator.mediaControl('play')" title="Play">‚ñ∂</button>
                            <button class="btn" onclick="emulator.mediaControl('pause')" title="Pause">‚è∏</button>
                            <button class="btn" onclick="emulator.mediaControl('stop')" title="Stop">‚èπ</button>
                            <button class="btn" onclick="emulator.mediaControl('next')" title="Next">‚è≠</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 11px;">
                            <span>Volume:</span>
                            <input type="range" id="media-volume" min="0" max="100" value="70" style="flex: 1;" onchange="emulator.mediaSetVolume(this.value)">
                            <span id="media-volume-label">70%</span>
                        </div>
                        <div style="margin-top: 8px; padding: 4px; background: white; border: 1px inset; min-height: 20px; font-size: 11px;" id="media-status">
                            Ready - No media loaded
                        </div>
                    </div>
                    <div style="background: var(--button-face); padding: 4px; border-top: 1px solid var(--button-highlight); font-size: 10px; text-align: center;">
                        Drop audio/video files here to play (Feature demonstration - File API would be needed)
                    </div>
                `;

                this.windowManager.createWindow('Media Player', content, { width: 480, height: 400 });
            }

            mediaControl(action) {
                const video = document.getElementById('media-player-video');
                const status = document.getElementById('media-status');

                if (!video || !status) return;

                switch (action) {
                    case 'play':
                        if (video.src) {
                            video.play();
                            status.textContent = 'Playing...';
                        } else {
                            status.textContent = 'No media loaded';
                        }
                        break;
                    case 'pause':
                        video.pause();
                        status.textContent = 'Paused';
                        break;
                    case 'stop':
                        video.pause();
                        video.currentTime = 0;
                        status.textContent = 'Stopped';
                        break;
                    case 'prev':
                        status.textContent = 'Previous track (demo)';
                        break;
                    case 'next':
                        status.textContent = 'Next track (demo)';
                        break;
                }
            }

            mediaSetVolume(value) {
                const video = document.getElementById('media-player-video');
                const label = document.getElementById('media-volume-label');

                if (video) video.volume = value / 100;
                if (label) label.textContent = value + '%';
            }

            openSystemProperties() {
                const uptime = Math.floor((Date.now() - this.startTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const mins = Math.floor((uptime % 3600) / 60);
                const secs = uptime % 60;

                const content = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚öôÔ∏è</div>
                            <h3 style="margin: 0;">System Properties</h3>
                        </div>

                        <div style="background: white; padding: 12px; border: 2px inset; margin-bottom: 12px;">
                            <table style="width: 100%; font-size: 11px;">
                                <tr>
                                    <td style="padding: 4px; font-weight: bold;">System:</td>
                                    <td style="padding: 4px;">Microsoft Windows 95</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; font-weight: bold;">Version:</td>
                                    <td style="padding: 4px;">4.00.950 (Simulator)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; font-weight: bold;">Computer:</td>
                                    <td style="padding: 4px;">win95-simulator</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; font-weight: bold;">Processor:</td>
                                    <td style="padding: 4px;">Browser JavaScript Engine</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; font-weight: bold;">Memory:</td>
                                    <td style="padding: 4px;">${Math.floor(this.settings.memory / 1024 / 1024)} MB RAM</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; font-weight: bold;">User:</td>
                                    <td style="padding: 4px;">user</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; font-weight: bold;">Uptime:</td>
                                    <td style="padding: 4px;">${hours}h ${mins}m ${secs}s</td>
                                </tr>
                            </table>
                        </div>

                        <div style="background: #ffffc0; padding: 8px; border: 1px solid #808080; font-size: 10px; margin-bottom: 12px;">
                            <strong>‚ÑπÔ∏è Note:</strong> This is a browser-based simulator. System information reflects the simulated environment.
                        </div>

                        <div style="text-align: center;">
                            <button class="btn primary" onclick="emulator.windowManager.closeWindow(this.closest('.window'))" style="min-width: 100px;">OK</button>
                        </div>
                    </div>
                `;

                this.windowManager.createWindow('System Properties', content, { width: 420, height: 440 });
            }

            openAbout() {
                const content = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üíª</div>
                        <h3 style="margin: 10px 0;">Windows 95 Desktop Simulator</h3>
                        <p style="margin: 10px 0;">Interactive Edition v4.0</p>
                        <hr style="margin: 15px 0;">
                        <p style="margin: 10px 0; text-align: left;">
                            <strong>Programs:</strong><br>
                            ‚Ä¢ Internet Explorer - Browse real websites<br>
                            ‚Ä¢ Paint - Drawing application<br>
                            ‚Ä¢ Media Player - Audio/Video player<br>
                            ‚Ä¢ File Explorer - Browse mock file system<br>
                            ‚Ä¢ Linux Terminal - Full bash emulation<br>
                            ‚Ä¢ Notepad - Text editor<br>
                            ‚Ä¢ Calculator - Math operations<br>
                            ‚Ä¢ Minesweeper - Classic game<br>
                            ‚Ä¢ Solitaire - Card game<br>
                            ‚Ä¢ System Properties - View system info
                        </p>
                        <hr style="margin: 15px 0;">
                        <p style="margin: 10px 0; text-align: left;">
                            <strong>Features:</strong><br>
                            ‚Ä¢ Draggable windows<br>
                            ‚Ä¢ Functional Start menu<br>
                            ‚Ä¢ Real-time clock<br>
                            ‚Ä¢ Desktop icons & context menus<br>
                            ‚Ä¢ 20+ Linux commands<br>
                            ‚Ä¢ Command history (‚Üë/‚Üì arrows)<br>
                            ‚Ä¢ Virtual filesystem<br>
                            ‚Ä¢ Authentic Win95 aesthetics
                        </p>
                        <hr style="margin: 15px 0;">
                        <p style="font-size: 10px; color: #808080;">
                            Built with pure HTML, CSS, and JavaScript<br>
                            No external dependencies ‚Ä¢ Local-first design<br>
                            <br>
                            Created by Claude Code
                        </p>
                    </div>
                `;
                this.windowManager.createWindow('About Windows 95', content, { width: 400, height: 600 });
            }

            // Taskbar management
            addTaskbarButton(windowObj) {
                const button = document.createElement('button');
                button.className = 'taskbar-button';
                button.textContent = windowObj.title;
                button.dataset.windowId = windowObj.id;
                button.onclick = () => {
                    if (windowObj.minimized) {
                        this.windowManager.restoreWindow(windowObj.element);
                    } else {
                        this.windowManager.focusWindow(windowObj.element);
                    }
                };

                // Insert before system tray
                const canvas = document.getElementById('screen');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    // Add to taskbar visually (this is a simplification)
                }

                this.taskbarButtons.push({ windowObj, button });
            }

            removeTaskbarButton(windowObj) {
                const index = this.taskbarButtons.findIndex(tb => tb.windowObj.id === windowObj.id);
                if (index > -1) {
                    this.taskbarButtons.splice(index, 1);
                }
            }

            updateTaskbarButtons() {
                // Update active state of taskbar buttons
                this.taskbarButtons.forEach(tb => {
                    const isActive = tb.windowObj.element.classList.contains('active');
                    if (isActive) {
                        tb.button.classList.add('active');
                    } else {
                        tb.button.classList.remove('active');
                    }
                });
            }

            initEmulatorCore() {
                console.log("Initializing x86 emulator core...");
                console.log("WebAssembly support:", typeof WebAssembly !== 'undefined');
            }

            detectSystemInfo() {
                // Detect browser
                const ua = navigator.userAgent;
                let browser = 'Unknown';
                if (ua.indexOf('Firefox') > -1) browser = 'Mozilla Firefox';
                else if (ua.indexOf('Chrome') > -1) browser = 'Google Chrome';
                else if (ua.indexOf('Safari') > -1) browser = 'Apple Safari';
                else if (ua.indexOf('Edge') > -1) browser = 'Microsoft Edge';
                else if (ua.indexOf('MSIE') > -1 || ua.indexOf('Trident') > -1) browser = 'Internet Explorer';

                // Check WebAssembly support
                const wasmSupport = typeof WebAssembly !== 'undefined' ? 
                    '<span style="color: green;">‚úì Supported</span>' : 
                    '<span style="color: red;">‚úó Not Supported</span>';

                // Get screen info
                const screenInfo = `${window.screen.width}x${window.screen.height}`;

                // Update UI
                setTimeout(() => {
                    const browserInfo = document.getElementById('browser-info');
                    const wasmInfo = document.getElementById('wasm-support');
                    const screenInfoEl = document.getElementById('screen-info');
                    
                    if (browserInfo) browserInfo.innerHTML = browser;
                    if (wasmInfo) wasmInfo.innerHTML = wasmSupport;
                    if (screenInfoEl) screenInfoEl.textContent = screenInfo;
                }, 100);
            }

            initDOMCache() {
                if (this.domCache) return;

                try {
                    this.domCache = {
                        fpsCounter: document.getElementById('fps-counter'),
                        timeDisplay: document.getElementById('time-display'),
                        cpuLed: document.getElementById('cpu-led'),
                        cpuStatus: document.getElementById('cpu-status'),
                        hddLed: document.getElementById('hdd-led'),
                        loadingScreen: document.getElementById('loading-screen'),
                        loadingText: document.getElementById('loading-text'),
                        progressFill: document.getElementById('progress-fill'),
                        setupScreen: document.getElementById('setup-screen'),
                        emulatorContainer: document.getElementById('emulator-container'),
                        emulatorTitlebar: document.getElementById('emulator-titlebar'),
                        memoryUsage: document.getElementById('memory-usage'),
                        pauseBtn: document.getElementById('pause-btn')
                    };
                } catch (error) {
                    console.error('Failed to initialize DOM cache:', error);
                    throw new Error('Required DOM elements not found');
                }
            }

            async loadDemo() {
                try {
                    this.showLoading('Initializing emulator...');
                    this.initDOMCache();

                    // Read settings
                    this.updateSettings();

                    this.canvas = document.getElementById('screen');
                    if (!this.canvas) {
                        throw new Error('Canvas element not found');
                    }

                    this.ctx = this.canvas.getContext('2d', {
                        alpha: false,
                        desynchronized: true,
                        willReadFrequently: false
                    });

                    if (!this.ctx) {
                        throw new Error('Could not get 2D rendering context. Canvas may be disabled.');
                    }

                    this.canvas.width = CONFIG.DISPLAY.WIDTH;
                    this.canvas.height = CONFIG.DISPLAY.HEIGHT;

                    this.domCache.setupScreen.classList.add('hidden');
                    this.domCache.emulatorContainer.classList.remove('hidden');

                    await this.simulateBoot();

                    this.hideLoading();
                    this.startEmulation();
                    
                    // Setup mouse capture
                    this.setupMouseCapture();
                } catch (error) {
                    console.error('Failed to load demo:', error);
                    alert(`Failed to start emulator: ${error.message}\n\nPlease check console for details.`);
                    this.hideLoading();
                }
            }

            updateSettings() {
                try {
                    const memorySelect = document.getElementById('memory-size');
                    const cpuSpeedSelect = document.getElementById('cpu-speed');
                    const enableMouse = document.getElementById('enable-mouse');
                    const enableSound = document.getElementById('enable-sound');
                    const enableNetwork = document.getElementById('enable-network');

                    this.settings.memory = parseInt(memorySelect.value) * 1024 * 1024;
                    this.settings.cpuSpeed = parseInt(cpuSpeedSelect.value);
                    this.settings.enableMouse = enableMouse.checked;
                    this.settings.enableSound = enableSound.checked;
                    this.settings.enableNetwork = enableNetwork.checked;

                    console.log('Settings updated:', this.settings);
                } catch (error) {
                    console.error('Failed to update settings:', error);
                }
            }

            setupMouseCapture() {
                // Disabled pointer lock for interactive desktop mode
                // Users need free mouse movement to interact with windows and icons
                return;
            }

            async simulateBoot() {
                const bootMessages = [
                    'PhoenixBIOS 4.0 Release 6.0',
                    'Copyright 1985-1995 Phoenix Technologies Ltd.',
                    'All Rights Reserved',
                    '',
                    'CPU: Intel Pentium ' + (this.settings.cpuSpeed * 75) + 'MHz',
                    'Memory Test: ' + (this.settings.memory / 1024) + 'K OK',
                    'Cache: 256K',
                    '',
                    'Press DEL to enter SETUP, ESC to skip memory test',
                    '',
                    'Detecting IDE drives...',
                    'Primary Master: 540MB Hard Disk',
                    'Primary Slave: None',
                    'Secondary Master: CD-ROM Drive',
                    'Secondary Slave: None',
                    '',
                    'Starting MS-DOS...',
                    '',
                    'HIMEM is testing extended memory...done.',
                    'EMM386 Memory Manager v4.49',
                    '',
                    'C:\\>win',
                    '',
                    'Starting Windows 95...'
                ];

                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);
                this.ctx.font = '14px monospace';
                this.ctx.fillStyle = '#c0c0c0';

                for (let i = 0; i < bootMessages.length; i++) {
                    await this.delay(CONFIG.ANIMATION.BOOT_MESSAGE_DELAY);
                    this.ctx.fillText(bootMessages[i], 10, 20 + i * 16);
                    this.updateProgress((i + 1) / bootMessages.length * 50);
                    this.updateLoadingText('Loading BIOS...');
                }

                await this.delay(500);
                this.updateLoadingText('Loading Windows 95...');

                // Clear screen
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);

                // Draw Windows logo with gradient
                const gradient = this.ctx.createLinearGradient(200, 200, 440, 280);
                gradient.addColorStop(0, '#ff0000');
                gradient.addColorStop(0.25, '#ffff00');
                gradient.addColorStop(0.5, '#00ff00');
                gradient.addColorStop(1, '#0000ff');

                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(220, 200, 200, 80);

                // Add shine effect
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                this.ctx.fillRect(220, 200, 200, 20);

                // Windows text
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 24px Arial';
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                this.ctx.shadowBlur = 4;
                this.ctx.fillText('Windows 95', 250, 320);
                this.ctx.shadowBlur = 0;

                // Progress bar
                this.ctx.strokeStyle = '#c0c0c0';
                this.ctx.strokeRect(220, 340, 200, 10);

                // Animate progress
                for (let i = 0; i <= 100; i += 5) {
                    await this.delay(40);
                    this.ctx.fillStyle = '#0000ff';
                    this.ctx.fillRect(221, 341, (198 * i) / 100, 8);
                    this.updateProgress(50 + i / 2);
                }

                this.updateLoadingText('Starting desktop...');
            }

            startEmulation() {
                this.isRunning = true;
                this.startTime = Date.now();

                // Draw desktop background
                this.ctx.fillStyle = CONFIG.COLORS.DESKTOP;
                this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);

                // Draw taskbar with gradient
                const taskbarGrad = this.ctx.createLinearGradient(0, 450, 0, 480);
                taskbarGrad.addColorStop(0, '#dfdfdf');
                taskbarGrad.addColorStop(1, '#c0c0c0');
                this.ctx.fillStyle = taskbarGrad;
                this.ctx.fillRect(0, 450, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.TASKBAR_HEIGHT);

                // Taskbar border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.beginPath();
                this.ctx.moveTo(0, 450);
                this.ctx.lineTo(CONFIG.DISPLAY.WIDTH, 450);
                this.ctx.stroke();

                // Start button with gradient
                const startGrad = this.ctx.createLinearGradient(2, 452, 2, 478);
                startGrad.addColorStop(0, '#ffffff');
                startGrad.addColorStop(0.5, '#c0c0c0');
                startGrad.addColorStop(1, '#808080');
                this.ctx.fillStyle = startGrad;
                this.ctx.fillRect(2, 452, 60, 26);

                // Start button border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.strokeRect(2, 452, 60, 26);
                this.ctx.strokeStyle = '#808080';
                this.ctx.strokeRect(3, 453, 58, 24);

                // Start text
                this.ctx.fillStyle = '#000000';
                this.ctx.font = 'bold 11px Arial';
                this.ctx.fillText('Start', 20, 468);

                // Windows logo on button
                this.ctx.fillStyle = '#ff0000';
                this.ctx.fillRect(6, 458, 4, 4);
                this.ctx.fillStyle = '#00ff00';
                this.ctx.fillRect(10, 458, 4, 4);
                this.ctx.fillStyle = '#0000ff';
                this.ctx.fillRect(6, 462, 4, 4);
                this.ctx.fillStyle = '#ffff00';
                this.ctx.fillRect(10, 462, 4, 4);

                // System tray
                this.ctx.fillStyle = '#808080';
                this.ctx.fillRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);
                this.ctx.strokeStyle = '#000000';
                this.ctx.strokeRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);

                // Clock
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                this.ctx.fillStyle = '#000000';
                this.ctx.font = '11px Arial';
                this.ctx.fillText(timeStr, CONFIG.DISPLAY.WIDTH - 50, 468);

                // Create interactive desktop icons
                this.createDesktopIcon(20, 20, 'My Computer', 'üíª', () => this.openFileExplorer());
                this.createDesktopIcon(20, 90, 'Internet Explorer', 'üåê', () => this.openInternetExplorer());
                this.createDesktopIcon(20, 160, 'Recycle Bin', 'üóëÔ∏è', () => alert('Recycle Bin is empty'));
                this.createDesktopIcon(100, 20, 'MS-DOS Prompt', '‚¨õ', () => this.openDOSPrompt());
                this.createDesktopIcon(100, 90, 'Paint', 'üé®', () => this.openPaint());
                this.createDesktopIcon(100, 160, 'Notepad', 'üìù', () => this.openNotepad());

                // Create Start menu
                this.createStartMenu();

                // Setup desktop click handlers
                this.setupDesktopInteractions();

                // Start animation loop
                this.updateStatus();
                this.animate();

                // Start clock update (every second)
                this.clockInterval = setInterval(() => {
                    this.updateSystemClock();
                }, 1000);
            }

            createDesktopIcon(x, y, label, emoji, onClick) {
                const icon = {
                    x, y, label, emoji, onClick,
                    width: 48, height: 64,
                    selected: false
                };
                this.desktop.icons.push(icon);

                // Draw initial icon
                this.drawIcon(x, y, label, emoji, false);

                return icon;
            }

            setupDesktopInteractions() {
                const canvas = document.getElementById('screen');
                if (!canvas) return;

                // Handle icon clicks
                canvas.addEventListener('click', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    // Check if clicking on an icon
                    let clickedIcon = null;
                    for (const icon of this.desktop.icons) {
                        if (x >= icon.x && x <= icon.x + icon.width &&
                            y >= icon.y && y <= icon.y + icon.height) {
                            clickedIcon = icon;
                            break;
                        }
                    }

                    // Handle icon selection and double-click
                    if (clickedIcon) {
                        const now = Date.now();
                        if (clickedIcon.lastClick && now - clickedIcon.lastClick < 400) {
                            // Double-click
                            if (clickedIcon.onClick) {
                                clickedIcon.onClick();
                            }
                        } else {
                            // Single click - select
                            this.desktop.icons.forEach(ic => {
                                ic.selected = (ic === clickedIcon);
                                this.drawIcon(ic.x, ic.y, ic.label, ic.emoji, ic.selected);
                            });
                        }
                        clickedIcon.lastClick = now;
                    } else {
                        // Deselect all
                        this.desktop.icons.forEach(ic => {
                            if (ic.selected) {
                                ic.selected = false;
                                this.drawIcon(ic.x, ic.y, ic.label, ic.emoji, false);
                            }
                        });
                    }

                    // Check if clicking on Start button
                    if (y >= 450 && y <= 480 && x >= 2 && x <= 62) {
                        this.toggleStartMenu();
                    } else {
                        // Close start menu if clicking elsewhere
                        const startMenu = document.getElementById('start-menu');
                        if (startMenu && startMenu.classList.contains('active')) {
                            if (x < 0 || x > 200 || y < 450 - 200) {
                                startMenu.classList.remove('active');
                            }
                        }
                    }
                });

                // Handle right-click for context menu
                canvas.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.showContextMenu(x, y);
                    return false;
                });
            }

            createStartMenu() {
                const screenContainer = document.getElementById('screen_container');
                if (!screenContainer) return;

                const startMenu = document.createElement('div');
                startMenu.id = 'start-menu';
                startMenu.className = 'start-menu';
                startMenu.style.cssText = 'display: none;';
                startMenu.innerHTML = `
                    <div style="display: flex; height: 500px;">
                        <div class="start-menu-sidebar">Windows 95</div>
                        <div class="start-menu-items" style="flex: 1;">
                            <div class="start-menu-item" onclick="emulator.openInternetExplorer(); emulator.toggleStartMenu();">
                                üåê Internet Explorer
                            </div>
                            <div style="height: 1px; background: #808080; margin: 4px;"></div>
                            <div class="start-menu-item" style="font-weight: bold;">
                                üìÅ Programs ‚ñ∫
                            </div>
                            <div style="margin-left: 20px;">
                                <div class="start-menu-item" onclick="emulator.openFileExplorer(); emulator.toggleStartMenu();">
                                    üíª My Computer
                                </div>
                                <div class="start-menu-item" onclick="emulator.openPaint(); emulator.toggleStartMenu();">
                                    üé® Paint
                                </div>
                                <div class="start-menu-item" onclick="emulator.openMediaPlayer(); emulator.toggleStartMenu();">
                                    üéµ Media Player
                                </div>
                                <div class="start-menu-item" onclick="emulator.openNotepad(); emulator.toggleStartMenu();">
                                    üìù Notepad
                                </div>
                                <div class="start-menu-item" onclick="emulator.openCalculator(); emulator.toggleStartMenu();">
                                    üßÆ Calculator
                                </div>
                                <div class="start-menu-item" onclick="emulator.openDOSPrompt(); emulator.toggleStartMenu();">
                                    ‚¨õ Linux Terminal
                                </div>
                            </div>
                            <div style="height: 1px; background: #808080; margin: 4px;"></div>
                            <div class="start-menu-item" style="font-weight: bold;">
                                üéÆ Games ‚ñ∫
                            </div>
                            <div style="margin-left: 20px;">
                                <div class="start-menu-item" onclick="emulator.openMinesweeper(); emulator.toggleStartMenu();">
                                    üí£ Minesweeper
                                </div>
                                <div class="start-menu-item" onclick="emulator.openSolitaire(); emulator.toggleStartMenu();">
                                    üÉè Solitaire
                                </div>
                            </div>
                            <div style="height: 1px; background: #808080; margin: 4px;"></div>
                            <div class="start-menu-item" style="font-weight: bold;">
                                ‚öôÔ∏è Settings ‚ñ∫
                            </div>
                            <div style="margin-left: 20px;">
                                <div class="start-menu-item" onclick="emulator.openSystemProperties(); emulator.toggleStartMenu();">
                                    üñ•Ô∏è System Properties
                                </div>
                            </div>
                            <div style="height: 1px; background: #808080; margin: 4px;"></div>
                            <div class="start-menu-item" onclick="emulator.openAbout(); emulator.toggleStartMenu();">
                                ‚ÑπÔ∏è About
                            </div>
                            <div class="start-menu-item" onclick="emulator.showHelp(); emulator.toggleStartMenu();">
                                ‚ùì Help
                            </div>
                            <div style="height: 1px; background: #808080; margin: 4px;"></div>
                            <div class="start-menu-item" onclick="emulator.restart();">
                                üîÑ Shut Down...
                            </div>
                        </div>
                    </div>
                `;
                screenContainer.appendChild(startMenu);
            }

            toggleStartMenu() {
                const startMenu = document.getElementById('start-menu');
                if (startMenu) {
                    if (startMenu.classList.contains('active')) {
                        startMenu.classList.remove('active');
                        startMenu.style.display = 'none';
                    } else {
                        startMenu.classList.add('active');
                        startMenu.style.display = 'block';
                    }
                }
            }

            showContextMenu(x, y) {
                // Remove existing context menu
                const existing = document.getElementById('context-menu');
                if (existing) existing.remove();

                const screenContainer = document.getElementById('screen_container');
                if (!screenContainer) return;

                const contextMenu = document.createElement('div');
                contextMenu.id = 'context-menu';
                contextMenu.className = 'context-menu active';
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.innerHTML = `
                    <div class="context-menu-item" onclick="emulator.openInternetExplorer(); document.getElementById('context-menu').remove();">
                        Open Internet Explorer
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="emulator.openNotepad(); document.getElementById('context-menu').remove();">
                        New &gt; Text Document
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="emulator.refreshDesktop(); document.getElementById('context-menu').remove();">
                        Refresh
                    </div>
                    <div class="context-menu-item" onclick="alert('Properties'); document.getElementById('context-menu').remove();">
                        Properties
                    </div>
                `;
                screenContainer.appendChild(contextMenu);

                // Close on next click
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu() {
                        contextMenu.remove();
                        document.removeEventListener('click', closeMenu);
                    }, { once: true });
                }, 100);
            }

            refreshDesktop() {
                // Redraw desktop
                this.ctx.fillStyle = CONFIG.COLORS.DESKTOP;
                this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, 450);

                // Redraw icons
                this.desktop.icons.forEach(icon => {
                    this.drawIcon(icon.x, icon.y, icon.label, icon.emoji, icon.selected);
                });

                // Redraw taskbar
                const taskbarGrad = this.ctx.createLinearGradient(0, 450, 0, 480);
                taskbarGrad.addColorStop(0, '#dfdfdf');
                taskbarGrad.addColorStop(1, '#c0c0c0');
                this.ctx.fillStyle = taskbarGrad;
                this.ctx.fillRect(0, 450, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.TASKBAR_HEIGHT);

                this.ctx.strokeStyle = '#ffffff';
                this.ctx.beginPath();
                this.ctx.moveTo(0, 450);
                this.ctx.lineTo(CONFIG.DISPLAY.WIDTH, 450);
                this.ctx.stroke();

                // Redraw start button
                this.drawStartButton();
                this.drawSystemTray();
            }

            drawStartButton() {
                const startGrad = this.ctx.createLinearGradient(2, 452, 2, 478);
                startGrad.addColorStop(0, '#ffffff');
                startGrad.addColorStop(0.5, '#c0c0c0');
                startGrad.addColorStop(1, '#808080');
                this.ctx.fillStyle = startGrad;
                this.ctx.fillRect(2, 452, 60, 26);

                this.ctx.strokeStyle = '#ffffff';
                this.ctx.strokeRect(2, 452, 60, 26);
                this.ctx.strokeStyle = '#808080';
                this.ctx.strokeRect(3, 453, 58, 24);

                this.ctx.fillStyle = '#000000';
                this.ctx.font = 'bold 11px Arial';
                this.ctx.fillText('Start', 20, 468);

                // Windows logo on button
                this.ctx.fillStyle = '#ff0000';
                this.ctx.fillRect(6, 458, 4, 4);
                this.ctx.fillStyle = '#00ff00';
                this.ctx.fillRect(10, 458, 4, 4);
                this.ctx.fillStyle = '#0000ff';
                this.ctx.fillRect(6, 462, 4, 4);
                this.ctx.fillStyle = '#ffff00';
                this.ctx.fillRect(10, 462, 4, 4);
            }

            drawSystemTray() {
                this.ctx.fillStyle = '#808080';
                this.ctx.fillRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);
                this.ctx.strokeStyle = '#000000';
                this.ctx.strokeRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                this.ctx.fillStyle = '#000000';
                this.ctx.font = '11px Arial';
                this.ctx.fillText(timeStr, CONFIG.DISPLAY.WIDTH - 50, 468);
            }

            updateSystemClock() {
                // Redraw just the system tray area every second
                if (!this.ctx) return;

                this.ctx.fillStyle = '#808080';
                this.ctx.fillRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);
                this.ctx.strokeStyle = '#000000';
                this.ctx.strokeRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                this.ctx.fillStyle = '#000000';
                this.ctx.font = '11px Arial';
                this.ctx.fillText(timeStr, CONFIG.DISPLAY.WIDTH - 50, 468);
            }

            drawIcon(x, y, label, emoji, selected) {
                // Icon background (for selection)
                if (selected) {
                    this.ctx.fillStyle = 'rgba(0, 0, 128, 0.3)';
                    this.ctx.fillRect(x, y, 48, 64);
                    this.ctx.strokeStyle = 'rgba(0, 0, 128, 0.6)';
                    this.ctx.setLineDash([2, 2]);
                    this.ctx.strokeRect(x, y, 48, 64);
                    this.ctx.setLineDash([]);
                }

                // Draw icon image (simplified)
                this.ctx.font = '32px Arial';
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillText(emoji, x + 8, y + 32);

                // Icon label with background
                if (selected) {
                    this.ctx.fillStyle = '#000080';
                    const textWidth = this.ctx.measureText(label).width + 4;
                    this.ctx.fillRect(x + 24 - textWidth/2, y + 42, textWidth, 14);
                }

                // Icon label
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 11px Arial';
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                this.ctx.shadowBlur = 2;
                this.ctx.textAlign = 'center';
                this.ctx.fillText(label, x + 24, y + 53);
                this.ctx.shadowBlur = 0;
                this.ctx.textAlign = 'left';
            }

            drawWindow(x, y, width, height, title) {
                // Window outer border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.strokeRect(x, y, width, height);
                this.ctx.strokeStyle = '#808080';
                this.ctx.strokeRect(x + 1, y + 1, width - 2, height - 2);

                // Window background
                this.ctx.fillStyle = '#c0c0c0';
                this.ctx.fillRect(x + 2, y + 2, width - 4, height - 4);

                // Title bar
                const titleGrad = this.ctx.createLinearGradient(x + 2, y + 2, x + 2, y + 20);
                titleGrad.addColorStop(0, '#0000ff');
                titleGrad.addColorStop(1, '#000080');
                this.ctx.fillStyle = titleGrad;
                this.ctx.fillRect(x + 2, y + 2, width - 4, 18);

                // Title bar text
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 11px Arial';
                this.ctx.fillText(title, x + 6, y + 14);

                // Window control buttons
                const btnSize = 16;
                const btnY = y + 4;
                
                // Minimize button
                this.drawWindowButton(x + width - 60, btnY, btnSize, '_');
                // Maximize button
                this.drawWindowButton(x + width - 40, btnY, btnSize, '‚ñ°');
                // Close button
                this.drawWindowButton(x + width - 20, btnY, btnSize, 'X');

                // Window content area
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(x + 3, y + 22, width - 6, height - 25);

                // Draw some content
                this.ctx.fillStyle = '#000000';
                this.ctx.font = '12px Arial';
                this.ctx.fillText('Welcome to Windows 95 Emulator!', x + 10, y + 40);
                this.ctx.font = '11px Arial';
                this.ctx.fillText('This is a WebAssembly-powered x86 emulation.', x + 10, y + 60);
                this.ctx.fillText('', x + 10, y + 75);
                this.ctx.fillText('Features:', x + 10, y + 90);
                this.ctx.fillText('‚Ä¢ Full desktop environment simulation', x + 20, y + 105);
                this.ctx.fillText('‚Ä¢ Mouse and keyboard support', x + 20, y + 120);
                this.ctx.fillText('‚Ä¢ Load custom disk images', x + 20, y + 135);
                this.ctx.fillText('‚Ä¢ Save and restore state', x + 20, y + 150);
                this.ctx.fillText('', x + 10, y + 165);
                this.ctx.fillStyle = '#000080';
                this.ctx.fillText('Click "Load Disk" to load a Windows 95 image.', x + 10, y + 180);
            }

            drawWindowButton(x, y, size, label) {
                // Button background
                this.ctx.fillStyle = '#c0c0c0';
                this.ctx.fillRect(x, y, size, 14);
                
                // Button border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.strokeRect(x, y, size, 14);
                this.ctx.strokeStyle = '#808080';
                this.ctx.strokeRect(x + 1, y + 1, size - 2, 12);

                // Button label
                this.ctx.fillStyle = '#000000';
                this.ctx.font = 'bold 10px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(label, x + size / 2, y + 10);
                this.ctx.textAlign = 'left';
            }

            animate() {
                if (!this.isRunning) return;

                const now = Date.now();
                const deltaTime = now - this.lastFrameTime;

                // Frame rate limiting
                if (deltaTime < CONFIG.PERFORMANCE.FRAME_TIME) {
                    requestAnimationFrame(() => this.animate());
                    return;
                }

                this.lastFrameTime = now;
                this.frameCount++;

                // Update FPS and stats
                if (now - this.lastFpsUpdate > CONFIG.ANIMATION.FPS_UPDATE_INTERVAL) {
                    const fps = Math.round(this.frameCount * 1000 / (now - this.lastFpsUpdate));
                    this.domCache.fpsCounter.textContent = fps;
                    this.frameCount = 0;
                    this.lastFpsUpdate = now;

                    // Update uptime
                    const elapsed = Math.floor((now - this.startTime) / 1000);
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;

                    const pad = (num) => num < 10 ? '0' + num : '' + num;
                    this.domCache.timeDisplay.textContent =
                        `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

                    // Update memory usage simulation
                    this.memoryUsage = Math.floor(this.settings.memory / 1024 / 1024 * (0.3 + Math.random() * 0.2));
                    this.domCache.memoryUsage.textContent = this.memoryUsage + ' MB';
                }

                // Update LED indicators (throttled)
                if (this.frameCount % CONFIG.ANIMATION.LED_THROTTLE_FRAMES === 0) {
                    // CPU activity
                    if (Math.random() > 0.6) {
                        this.domCache.cpuLed.classList.add('active');
                        this.domCache.cpuStatus.textContent = 'Active';
                        this.cpuUsage = Math.floor(Math.random() * 40 + 10);
                    } else {
                        this.domCache.cpuLed.classList.remove('active');
                        this.domCache.cpuStatus.textContent = 'Idle';
                        this.cpuUsage = Math.floor(Math.random() * 10);
                    }

                    // HDD activity
                    if (Math.random() > 0.85) {
                        if (this.hddLedTimeout) {
                            clearTimeout(this.hddLedTimeout);
                        }

                        this.domCache.hddLed.classList.add('active');
                        this.hddLedTimeout = setTimeout(() => {
                            this.domCache.hddLed.classList.remove('active');
                            this.hddLedTimeout = null;
                        }, 100);
                    }
                }

                requestAnimationFrame(() => this.animate());
            }

            updateStatus() {
                this.updateSettings();
            }

            updateProgress(percent) {
                if (this.domCache && this.domCache.progressFill) {
                    this.domCache.progressFill.style.width = Math.min(100, percent) + '%';
                    this.domCache.progressFill.parentElement.setAttribute('aria-valuenow', Math.round(percent));
                }
            }

            updateLoadingText(text) {
                if (this.domCache && this.domCache.loadingText) {
                    this.domCache.loadingText.textContent = text;
                }
            }

            showLoading(text = 'Starting Windows 95...') {
                this.initDOMCache();
                this.domCache.loadingScreen.classList.add('active');
                this.updateProgress(0);
                this.updateLoadingText(text);
            }

            hideLoading() {
                setTimeout(() => {
                    if (this.domCache && this.domCache.loadingScreen) {
                        this.domCache.loadingScreen.classList.remove('active');
                    }
                }, 500);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                if (this.isPaused) {
                    this.isRunning = false;
                    this.domCache.pauseBtn.innerHTML = '<span aria-hidden="true">‚ñ∂</span> Resume';
                    this.domCache.emulatorTitlebar.classList.add('inactive');
                    
                    // Show paused message
                    const pauseText = 'PAUSED';
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.font = 'bold 48px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(pauseText, CONFIG.DISPLAY.WIDTH / 2, CONFIG.DISPLAY.HEIGHT / 2);
                    this.ctx.textAlign = 'left';
                } else {
                    this.isRunning = true;
                    this.domCache.pauseBtn.innerHTML = '<span aria-hidden="true">‚è∏</span> Pause';
                    this.domCache.emulatorTitlebar.classList.remove('inactive');
                    this.lastFrameTime = Date.now();
                    this.animate();
                }
            }

            restart() {
                if (!confirm('Are you sure you want to restart? Any unsaved changes will be lost.')) {
                    return;
                }

                this.isRunning = false;
                this.isPaused = false;
                this.startTime = Date.now();
                this.frameCount = 0;
                this.lastFrameTime = 0;

                if (this.hddLedTimeout) {
                    clearTimeout(this.hddLedTimeout);
                    this.hddLedTimeout = null;
                }

                // Reset UI
                this.initDOMCache();
                this.domCache.emulatorContainer.classList.add('hidden');
                this.domCache.setupScreen.classList.remove('hidden');
                
                if (this.domCache.pauseBtn) {
                    this.domCache.pauseBtn.innerHTML = '<span aria-hidden="true">‚è∏</span> Pause';
                }
            }

            fullscreen() {
                try {
                    const container = document.getElementById('emulator-container');
                    const frame = document.querySelector('.emulator-frame');

                    if (!document.fullscreenEnabled && !document.webkitFullscreenEnabled &&
                        !document.mozFullScreenEnabled && !document.msFullscreenEnabled) {
                        alert('Fullscreen not supported in this browser');
                        return;
                    }

                    if (document.fullscreenElement || document.webkitFullscreenElement ||
                        document.mozFullScreenElement || document.msFullscreenElement) {
                        // Exit fullscreen
                        const exitFullscreen = document.exitFullscreen ||
                                             document.webkitExitFullscreen ||
                                             document.mozCancelFullScreen ||
                                             document.msExitFullscreen;
                        if (exitFullscreen) {
                            exitFullscreen.call(document);
                        }
                        // Remove fullscreen class
                        if (frame) {
                            frame.classList.remove('fullscreen-mode');
                        }
                    } else {
                        // Enter fullscreen
                        const requestFullscreen = container.requestFullscreen ||
                                                container.webkitRequestFullscreen ||
                                                container.webkitRequestFullScreen ||
                                                container.mozRequestFullScreen ||
                                                container.msRequestFullscreen;

                        if (requestFullscreen) {
                            requestFullscreen.call(container).then(() => {
                                // Add fullscreen class when successfully entered
                                if (frame) {
                                    frame.classList.add('fullscreen-mode');
                                }
                            }).catch(err => {
                                console.error('Fullscreen request failed:', err);
                                alert('Could not enter fullscreen mode');
                            });
                        }
                    }
                } catch (error) {
                    console.error('Fullscreen error:', error);
                    alert('Fullscreen failed: ' + error.message);
                }
            }

            screenshot() {
                try {
                    const canvas = document.getElementById('screen');
                    if (!canvas) {
                        throw new Error('Canvas not found');
                    }

                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const link = document.createElement('a');
                    link.download = `windows95-screenshot-${timestamp}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Show feedback
                    this.showNotification('Screenshot saved!');
                } catch (error) {
                    console.error('Screenshot failed:', error);
                    alert('Screenshot failed. Canvas may be tainted by cross-origin content.');
                }
            }

            showNotification(message) {
                // Simple notification in the emulator
                const prevFill = this.ctx.fillStyle;
                const prevFont = this.ctx.font;
                
                this.ctx.fillStyle = 'rgba(255, 255, 200, 0.9)';
                this.ctx.fillRect(200, 200, 240, 80);
                this.ctx.strokeStyle = '#000000';
                this.ctx.strokeRect(200, 200, 240, 80);
                
                this.ctx.fillStyle = '#000000';
                this.ctx.font = 'bold 14px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(message, 320, 240);
                this.ctx.textAlign = 'left';
                
                this.ctx.fillStyle = prevFill;
                this.ctx.font = prevFont;
            }

            showHelp() {
                alert(`Windows 95 Desktop Simulator Help

DESKTOP INTERACTIONS:
‚Ä¢ Single-click icons to select them
‚Ä¢ Double-click icons to open programs
‚Ä¢ Right-click desktop for context menu
‚Ä¢ Click Start button to open program menu

WINDOWS:
‚Ä¢ Drag windows by their title bars
‚Ä¢ Click minimize (_) to minimize to taskbar
‚Ä¢ Click maximize (‚ñ°) to toggle full screen
‚Ä¢ Click close (X) to close windows
‚Ä¢ Click taskbar buttons to restore windows

KEYBOARD SHORTCUTS:
‚Ä¢ F11 - Toggle fullscreen mode
‚Ä¢ Ctrl+P - Pause/Resume desktop
‚Ä¢ Ctrl+R - Restart desktop
‚Ä¢ Ctrl+S - Take screenshot
‚Ä¢ ESC - Release mouse cursor (if locked)

PROGRAMS:
‚Ä¢ Internet Explorer - Real web browser (loads live sites!)
‚Ä¢ Notepad - Text editor with basic functionality
‚Ä¢ Calculator - Working calculator with basic operations
‚Ä¢ Minesweeper - Classic game (right-click to flag)
‚Ä¢ About - Information about this simulator

FEATURES:
‚Ä¢ All interactions happen locally in your browser
‚Ä¢ No data is sent to any server
‚Ä¢ State persists in browser storage
‚Ä¢ Works completely offline
‚Ä¢ Authentic Windows 95 look and feel

TIP: Try opening multiple windows and arranging them!`);
            }

            loadDisk() {
                document.getElementById('disk-input').click();
            }

            handleDiskUpload(event) {
                try {
                    const file = event.target.files[0];
                    if (!file) return;

                    const validExtensions = ['.img', '.iso', '.ima'];
                    const fileName = file.name.toLowerCase();
                    const isValid = validExtensions.some(ext => fileName.endsWith(ext));

                    if (!isValid) {
                        alert('Invalid file type. Please select an IMG, ISO, or IMA file.');
                        return;
                    }

                    if (file.size > 100 * 1024 * 1024) {
                        alert('File too large. Maximum size is 100MB for this demo.');
                        return;
                    }

                    // Show file name
                    const fileNameDisplay = document.getElementById('file-name');
                    if (fileNameDisplay) {
                        fileNameDisplay.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    }

                    console.log('Loading disk image:', file.name, 'Size:', file.size, 'bytes');
                    alert(`Disk image "${file.name}" selected.\n\nNote: Full Windows 95 emulation requires the v86 WASM library.\nThis demo shows a simulated environment.\n\nFor actual Windows 95, you would need:\n‚Ä¢ A complete v86 library implementation\n‚Ä¢ Valid Windows 95 disk image\n‚Ä¢ Additional ROM files`);
                    
                    this.loadDemo();
                } catch (error) {
                    console.error('Failed to handle disk upload:', error);
                    alert('Failed to load disk image: ' + error.message);
                }
            }

            loadFromURL() {
                try {
                    const url = document.getElementById('disk-url').value.trim();
                    if (!url) {
                        alert('Please enter a URL');
                        return;
                    }

                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        alert('Invalid URL. Must start with http:// or https://');
                        return;
                    }

                    console.log('Loading from URL:', url);
                    alert(`Loading from URL: ${url}\n\nNote: Full emulation requires the v86 WASM library.\nThis demo shows a simulated environment.\n\nRequirements:\n‚Ä¢ Server must support CORS\n‚Ä¢ Valid disk image format (IMG/ISO)\n‚Ä¢ Stable network connection`);
                    
                    this.loadDemo();
                } catch (error) {
                    console.error('Failed to load from URL:', error);
                    alert('Failed to load from URL: ' + error.message);
                }
            }

            minimize() {
                const container = document.getElementById('emulator-container');
                container.style.transition = 'transform 0.3s ease';
                container.style.transform = 'scale(0.1)';
                container.style.opacity = '0';
                
                setTimeout(() => {
                    container.style.transform = 'scale(1)';
                    container.style.opacity = '1';
                }, 300);
            }

            maximize() {
                this.fullscreen();
            }

            close() {
                if (confirm('Are you sure you want to close Windows 95?\n\nAny unsaved changes will be lost.')) {
                    this.restart();
                }
            }
        }

        // Safe localStorage wrapper
        class SafeStorage {
            static setItem(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (e) {
                    console.warn('localStorage unavailable:', e);
                    return false;
                }
            }

            static getItem(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('localStorage unavailable:', e);
                    return null;
                }
            }

            static removeItem(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.warn('localStorage unavailable:', e);
                    return false;
                }
            }
        }

        // Initialize emulator
        const emulator = new Windows95Emulator();

        // Global mouse handlers for window dragging
        document.addEventListener('mousemove', (e) => {
            if (emulator.windowManager) {
                emulator.windowManager.handleMouseMove(e);
            }
        });

        document.addEventListener('mouseup', () => {
            if (emulator.windowManager) {
                emulator.windowManager.handleMouseUp();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC - Release mouse
            if (e.key === 'Escape') {
                const isLocked = document.pointerLockElement ||
                                document.webkitPointerLockElement ||
                                document.mozPointerLockElement;

                if (isLocked) {
                    const exitPointerLock = document.exitPointerLock ||
                                          document.webkitExitPointerLock ||
                                          document.mozExitPointerLock;
                    if (exitPointerLock) {
                        exitPointerLock.call(document);
                    }
                }
            }

            // F11 - Fullscreen
            if (e.key === 'F11') {
                e.preventDefault();
                emulator.fullscreen();
            }

            // Ctrl+P - Pause
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                emulator.togglePause();
            }

            // Ctrl+S - Screenshot
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                emulator.screenshot();
            }

            // Ctrl+R - Restart
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                emulator.restart();
            }
        });

        // Auto-save settings
        window.addEventListener('beforeunload', () => {
            const settings = {
                memory: document.getElementById('memory-size').value,
                cpuSpeed: document.getElementById('cpu-speed').value,
                enableMouse: document.getElementById('enable-mouse').checked,
                enableSound: document.getElementById('enable-sound').checked,
                enableNetwork: document.getElementById('enable-network').checked
            };
            SafeStorage.setItem('win95-emulator-settings', JSON.stringify(settings));
        });

        // Load saved settings
        window.addEventListener('load', () => {
            const saved = SafeStorage.getItem('win95-emulator-settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    document.getElementById('memory-size').value = settings.memory || '32';
                    document.getElementById('cpu-speed').value = settings.cpuSpeed || '2';
                    document.getElementById('enable-mouse').checked = settings.enableMouse !== false;
                    document.getElementById('enable-sound').checked = settings.enableSound !== false;
                    document.getElementById('enable-network').checked = settings.enableNetwork !== false;
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            }
        });

        // Handle file input label update
        document.getElementById('disk-input').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            if (fileName) {
                const label = document.querySelector('.file-input-label');
                label.textContent = fileName;
            }
        });

        // Fullscreen change handler with cross-browser support
        function handleFullscreenChange() {
            const frame = document.querySelector('.emulator-frame');
            const isFullscreen = document.fullscreenElement ||
                               document.webkitFullscreenElement ||
                               document.mozFullScreenElement ||
                               document.msFullscreenElement;

            if (isFullscreen) {
                console.log('Entered fullscreen mode');
                if (frame) {
                    frame.classList.add('fullscreen-mode');
                }
            } else {
                console.log('Exited fullscreen mode');
                if (frame) {
                    frame.classList.remove('fullscreen-mode');
                }
            }
        }

        // Add event listeners for all browser prefixes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        // Log initialization
        console.log('Windows 95 WASM Emulator initialized');
        console.log('WebAssembly support:', typeof WebAssembly !== 'undefined');
    </script>
</body>
</html>