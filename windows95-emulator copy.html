<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 95 in Browser - WASM x86 Emulator</title>
    <style>
        /* Windows 95 Color Palette - Authentic solid colors */
        :root {
            --desktop-teal: #008080;
            --button-face: #c0c0c0;
            --button-shadow: #808080;
            --button-dark-shadow: #000000;
            --button-highlight: #ffffff;
            --button-light: #dfdfdf;
            --active-title-bar: #000080;
            --inactive-title-bar: #808080;
            --window-background: #ffffff;
            --text-color: #000000;
            --menu-highlight: #000080;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', Arial, sans-serif;
            font-size: 11px;
            background: var(--desktop-teal);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #fff;
            overflow: hidden;
            user-select: none;
        }

        .header {
            background: var(--active-title-bar);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 2px solid var(--button-face);
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ff0000 0%, #ffff00 25%, #00ff00 50%, #0000ff 100%);
            display: inline-block;
            position: relative;
            transform: perspective(10px) rotateY(-5deg);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Authentic Windows 95 3D button effect */
        .btn {
            padding: 3px 8px;
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-highlight),
                inset 2px 2px 0 var(--button-light),
                inset -1px -1px 0 var(--button-dark-shadow),
                inset -2px -2px 0 var(--button-shadow);
            color: var(--text-color);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            outline: none;
            position: relative;
            min-height: 22px;
        }

        /* Pressed button effect */
        .btn:active {
            box-shadow:
                inset -1px -1px 0 var(--button-highlight),
                inset -2px -2px 0 var(--button-light),
                inset 1px 1px 0 var(--button-dark-shadow),
                inset 2px 2px 0 var(--button-shadow);
            padding: 4px 7px 2px 9px;
        }

        /* Focus state for accessibility */
        .btn:focus-visible {
            outline: 1px dotted var(--text-color);
            outline-offset: -4px;
        }

        .btn:disabled {
            color: var(--button-shadow);
            text-shadow: 1px 1px 0 var(--button-highlight);
            cursor: default;
        }

        .btn.primary {
            background: var(--active-title-bar);
            color: white;
            font-weight: bold;
            border: 1px solid #000;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            overflow: auto;
        }

        .emulator-frame {
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-light),
                inset 2px 2px 0 var(--button-highlight),
                inset -1px -1px 0 var(--button-shadow),
                inset -2px -2px 0 var(--button-dark-shadow),
                0 0 30px rgba(0,0,0,0.5);
            padding: 3px;
            position: relative;
            max-width: 95vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .emulator-titlebar {
            background: var(--active-title-bar);
            color: white;
            padding: 2px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            font-weight: bold;
            user-select: none;
            height: 18px;
            cursor: default;
        }

        .emulator-titlebar.inactive {
            background: var(--inactive-title-bar);
        }

        .titlebar-buttons {
            display: flex;
            gap: 2px;
        }

        .titlebar-btn {
            width: 16px;
            height: 14px;
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-highlight),
                inset -1px -1px 0 var(--button-dark-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 10px;
            font-weight: bold;
            color: var(--text-color);
        }

        .titlebar-btn:active {
            box-shadow:
                inset -1px -1px 0 var(--button-highlight),
                inset 1px 1px 0 var(--button-dark-shadow);
            padding-top: 1px;
            padding-left: 1px;
        }

        .titlebar-btn:hover {
            background: var(--button-light);
        }

        #screen_container {
            background: #000;
            position: relative;
            display: block;
            overflow: hidden;
            flex: 1;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            width: 100%;
            height: 100%;
        }

        .status-bar {
            background: var(--button-face);
            border-top: 1px solid var(--button-highlight);
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            color: var(--text-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-section {
            border-left: 1px solid var(--button-shadow);
            border-right: 1px solid var(--button-highlight);
            padding: 0 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-section:first-child {
            border-left: none;
            padding-left: 0;
        }

        .led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--button-shadow);
            box-shadow: inset 0 0 2px rgba(0,0,0,0.5);
            transition: all 0.1s ease;
        }

        .led.active {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00, inset 0 0 2px rgba(255,255,255,0.5);
        }

        .led.hdd {
            background: #ff0000;
        }

        .led.hdd.active {
            background: #ff6600;
            box-shadow: 0 0 5px #ff6600, inset 0 0 2px rgba(255,255,255,0.5);
        }

        .setup-screen {
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-light),
                inset 2px 2px 0 var(--button-highlight),
                inset -1px -1px 0 var(--button-shadow),
                inset -2px -2px 0 var(--button-dark-shadow),
                0 0 20px rgba(0,0,0,0.5);
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setup-screen h2 {
            background: var(--active-title-bar);
            color: white;
            padding: 4px 8px;
            margin: -20px -20px 15px -20px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 14px;
        }

        .setup-content {
            color: var(--text-color);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
        }

        .setup-content p {
            margin: 8px 0;
            line-height: 1.4;
        }

        .setup-option {
            margin: 15px 0;
            padding: 10px;
            background: var(--window-background);
            border: 1px solid var(--button-shadow);
            box-shadow: inset -1px -1px 0 var(--button-highlight);
        }

        .setup-option h3 {
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--active-title-bar);
        }

        .setup-option p {
            margin: 5px 0;
            line-height: 1.4;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 1;
        }

        .file-input-label {
            display: inline-block;
            padding: 3px 8px;
            background: var(--button-face);
            border: none;
            box-shadow:
                inset 1px 1px 0 var(--button-highlight),
                inset 2px 2px 0 var(--button-light),
                inset -1px -1px 0 var(--button-dark-shadow),
                inset -2px -2px 0 var(--button-shadow);
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            color: var(--text-color);
        }

        input[type="text"],
        select {
            padding: 2px 4px;
            border: 1px solid var(--button-shadow);
            box-shadow: inset -1px -1px 0 var(--button-highlight);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            background: var(--window-background);
        }

        input[type="text"]:focus,
        select:focus {
            outline: 1px dotted var(--text-color);
            outline-offset: -2px;
        }

        label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 2px 0;
        }

        input[type="checkbox"] {
            width: 13px;
            height: 13px;
            cursor: pointer;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .loading-screen.active {
            display: flex;
        }

        .boot-logo {
            width: 200px;
            height: 150px;
            background: linear-gradient(135deg, #ff0000 0%, #ffff00 25%, #00ff00 50%, #0000ff 100%);
            margin-bottom: 30px;
            position: relative;
            animation: bootWave 2s infinite;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        @keyframes bootWave {
            0%, 100% { transform: perspective(100px) rotateY(0deg); }
            50% { transform: perspective(100px) rotateY(10deg); }
        }

        .loading-text {
            color: #c0c0c0;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: #000;
            border: 2px solid #c0c0c0;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
        }

        .progress-fill {
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                #000080 0px,
                #000080 10px,
                #1084d0 10px,
                #1084d0 20px
            );
            width: 0%;
            transition: width 0.3s ease;
            animation: slide 1s linear infinite;
        }

        @keyframes slide {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #ffffcc;
            border: 2px solid var(--text-color);
            padding: 10px;
            max-width: 300px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            color: var(--text-color);
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
        }

        .info-panel h4 {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .info-panel ul {
            margin-left: 20px;
            margin-top: 5px;
        }

        .info-panel li {
            margin: 3px 0;
            line-height: 1.3;
        }

        .warning-icon {
            color: #ff0000;
            font-weight: bold;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        /* Desktop icons styling */
        .desktop-icon {
            position: absolute;
            width: 64px;
            text-align: center;
            cursor: pointer;
            user-select: none;
        }

        .desktop-icon.selected .icon-text {
            background: var(--menu-highlight);
            color: white;
        }

        .icon-image {
            width: 32px;
            height: 32px;
            margin: 0 auto 4px;
        }

        .icon-text {
            font-size: 11px;
            padding: 1px 2px;
            word-wrap: break-word;
        }

        /* Window styling improvements */
        .window {
            position: absolute;
            background: var(--button-face);
            border: 2px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
            box-shadow: 1px 1px 0 var(--button-shadow);
            min-width: 200px;
            min-height: 100px;
        }

        .window-titlebar {
            background: var(--active-title-bar);
            color: white;
            padding: 2px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            cursor: move;
            height: 18px;
        }

        .window-content {
            background: var(--window-background);
            padding: 8px;
            overflow: auto;
        }

        /* Scrollbar styling for Windows 95 authenticity */
        .setup-screen::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }

        .setup-screen::-webkit-scrollbar-track {
            background: var(--button-face);
        }

        .setup-screen::-webkit-scrollbar-thumb {
            background: var(--button-face);
            border: 1px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
        }

        .setup-screen::-webkit-scrollbar-button {
            background: var(--button-face);
            border: 1px solid;
            border-color: var(--button-highlight) var(--button-dark-shadow) var(--button-dark-shadow) var(--button-highlight);
        }

        /* Reduced motion support for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .btn {
                min-height: 44px;
                min-width: 44px;
                padding: 0.6rem 1rem;
                font-size: 12px;
            }

            .info-panel {
                position: static;
                margin-top: 1rem;
                max-width: 100%;
            }

            .controls {
                width: 100%;
                justify-content: center;
            }
        }

        /* Tooltip styling */
        .tooltip {
            position: absolute;
            background: #ffffcc;
            border: 1px solid var(--text-color);
            padding: 2px 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="logo"></span> Windows 95 WASM Emulator</h1>
        <div class="controls" role="toolbar" aria-label="Emulator controls">
            <button class="btn" id="pause-btn" onclick="emulator.togglePause()" aria-label="Pause emulation" title="Pause/Resume">
                <span aria-hidden="true">⏸</span> Pause
            </button>
            <button class="btn" onclick="emulator.restart()" aria-label="Restart emulation" title="Restart emulator">
                <span aria-hidden="true">🔄</span> Restart
            </button>
            <button class="btn" onclick="emulator.fullscreen()" aria-label="Enter fullscreen mode" title="Toggle fullscreen">
                <span aria-hidden="true">🖥</span> Fullscreen
            </button>
            <button class="btn" onclick="emulator.screenshot()" aria-label="Take screenshot" title="Save screenshot">
                <span aria-hidden="true">📷</span> Screenshot
            </button>
            <button class="btn" onclick="emulator.showHelp()" aria-label="Show help information" title="Help & Information">
                <span aria-hidden="true">❓</span> Help
            </button>
            <button class="btn primary" onclick="emulator.loadDisk()" aria-label="Load disk image" title="Load disk image">
                <span aria-hidden="true">💾</span> Load Disk
            </button>
        </div>
    </div>

    <div class="main-container">
        <div id="setup-screen" class="setup-screen" role="dialog" aria-labelledby="setup-title">
            <h2 id="setup-title">Windows 95 Emulator Setup</h2>
            <div class="setup-content">
                <p><strong>Welcome to the Windows 95 WASM Emulator!</strong></p>
                <p>This emulator runs a full x86 PC in your browser using WebAssembly technology.</p>

                <div class="setup-option">
                    <h3><span aria-hidden="true">🎮</span> Quick Start - Demo OS</h3>
                    <p>Load a lightweight demo operating system to test the emulator capabilities.</p>
                    <p><strong>Features:</strong> Basic DOS environment, simple applications, file manager</p>
                    <p><em>Best for testing and demonstration purposes</em></p>
                    <button class="btn primary" onclick="emulator.loadDemo()">Start Demo OS</button>
                </div>

                <div class="setup-option">
                    <h3><span aria-hidden="true">💾</span> Load Windows 95 Image</h3>
                    <p>Load your own Windows 95 disk image for full functionality.</p>
                    <p><strong>Supported formats:</strong> IMG, ISO, IMA</p>
                    <p><strong>Recommended size:</strong> 2-50MB for boot disks</p>
                    <div class="file-input-wrapper">
                        <input type="file" id="disk-input" accept=".img,.iso,.ima" onchange="emulator.handleDiskUpload(event)" aria-label="Choose disk image file">
                        <label class="file-input-label">Browse Files...</label>
                    </div>
                    <div id="file-name" style="margin-top: 5px; font-style: italic; color: #000080;"></div>
                </div>

                <div class="setup-option">
                    <h3><span aria-hidden="true">🌐</span> Load from URL</h3>
                    <p>Load a disk image from a remote URL (must allow CORS).</p>
                    <p><strong>Note:</strong> Server must support cross-origin requests</p>
                    <input type="text" id="disk-url" placeholder="https://example.com/windows95.img" aria-label="Disk image URL" style="width: 100%; padding: 4px; margin-top: 5px;">
                    <button class="btn" onclick="emulator.loadFromURL()" style="margin-top: 5px;">Load from URL</button>
                </div>

                <div class="setup-option" style="background: #e0e0e0;">
                    <h3><span aria-hidden="true">⚙️</span> Emulator Settings</h3>
                    <div style="display: grid; gap: 8px;">
                        <label>
                            <input type="checkbox" id="enable-mouse" checked> Enable Mouse Lock (Ctrl+Click)
                        </label>
                        <label>
                            <input type="checkbox" id="enable-sound" checked> Enable Sound Emulation
                        </label>
                        <label>
                            <input type="checkbox" id="enable-network" checked> Enable Network (Experimental)
                        </label>
                        <label style="display: block; margin-top: 8px;">
                            <strong>Memory Allocation:</strong>
                            <select id="memory-size" style="width: 100%; margin-top: 4px;">
                                <option value="8">8 MB (Minimum)</option>
                                <option value="16">16 MB (Low)</option>
                                <option value="32" selected>32 MB (Recommended)</option>
                                <option value="64">64 MB (High)</option>
                                <option value="128">128 MB (Maximum)</option>
                            </select>
                        </label>
                        <label style="display: block; margin-top: 8px;">
                            <strong>CPU Speed:</strong>
                            <select id="cpu-speed" style="width: 100%; margin-top: 4px;">
                                <option value="1">1x (Authentic)</option>
                                <option value="2" selected>2x (Balanced)</option>
                                <option value="4">4x (Fast)</option>
                                <option value="8">8x (Maximum)</option>
                            </select>
                        </label>
                    </div>
                </div>

                <div class="setup-option" style="background: #fff8dc;">
                    <h3><span aria-hidden="true">ℹ️</span> System Information</h3>
                    <p><strong>Browser:</strong> <span id="browser-info">Detecting...</span></p>
                    <p><strong>WebAssembly:</strong> <span id="wasm-support">Checking...</span></p>
                    <p><strong>Screen:</strong> <span id="screen-info">Detecting...</span></p>
                </div>
            </div>
        </div>

        <div id="emulator-container" class="emulator-frame hidden">
            <div class="emulator-titlebar" id="emulator-titlebar">
                <span>Windows 95 - [Running]</span>
                <div class="titlebar-buttons">
                    <div class="titlebar-btn" onclick="emulator.minimize()" role="button" aria-label="Minimize" title="Minimize">_</div>
                    <div class="titlebar-btn" onclick="emulator.maximize()" role="button" aria-label="Maximize" title="Maximize">□</div>
                    <div class="titlebar-btn" onclick="emulator.close()" role="button" aria-label="Close" title="Close">X</div>
                </div>
            </div>
            <div id="screen_container">
                <canvas id="screen" role="img" aria-label="Windows 95 emulator screen" tabindex="0"></canvas>
            </div>
            <div class="status-bar" role="status" aria-live="polite" aria-atomic="false">
                <div class="status-section">
                    <span id="cpu-status-label">CPU:</span>
                    <span id="cpu-status" aria-labelledby="cpu-status-label">Idle</span>
                    <div class="led" id="cpu-led" role="status" aria-label="CPU activity indicator" title="CPU Activity"></div>
                </div>
                <div class="status-section">
                    <span>HDD:</span>
                    <div class="led hdd" id="hdd-led" role="status" aria-label="Hard drive activity indicator" title="HDD Activity"></div>
                </div>
                <div class="status-section">
                    <span>FPS:</span>
                    <span id="fps-counter" aria-label="Frames per second">0</span>
                </div>
                <div class="status-section">
                    <span>MEM:</span>
                    <span id="memory-usage" aria-label="Memory usage">0 MB</span>
                </div>
                <div class="status-section">
                    <span id="time-display" aria-label="Uptime" title="Uptime">00:00:00</span>
                </div>
            </div>
        </div>

        <div class="info-panel" id="info-panel">
            <h4><span class="warning-icon" aria-hidden="true">⚠</span> Important Notes</h4>
            <ul>
                <li>This is an x86 emulator running in WebAssembly</li>
                <li>Performance depends on your browser and device</li>
                <li>Click inside screen to capture mouse input</li>
                <li>Press <strong>ESC</strong> to release mouse cursor</li>
                <li>Keyboard shortcuts work inside emulator</li>
                <li>Right-click is supported for context menus</li>
            </ul>
            <button class="btn" onclick="document.getElementById('info-panel').classList.add('hidden')" style="margin-top: 8px; width: 100%;">Close</button>
        </div>
    </div>

    <div class="loading-screen" id="loading-screen" role="alert" aria-live="assertive">
        <div class="boot-logo" aria-hidden="true"></div>
        <div class="loading-text" id="loading-text">Starting Windows 95...</div>
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Polyfill for String.padStart (IE11, Safari < 10)
        if (!String.prototype.padStart) {
            String.prototype.padStart = function padStart(targetLength, padString) {
                targetLength = targetLength >> 0;
                padString = String(typeof padString !== 'undefined' ? padString : ' ');
                if (this.length >= targetLength) {
                    return String(this);
                }
                targetLength = targetLength - this.length;
                if (targetLength > padString.length) {
                    padString += padString.repeat(targetLength / padString.length);
                }
                return padString.slice(0, targetLength) + String(this);
            };
        }

        // Configuration constants
        const CONFIG = {
            DISPLAY: {
                WIDTH: 640,
                HEIGHT: 480,
                TASKBAR_HEIGHT: 30
            },
            COLORS: {
                DESKTOP: '#008080',
                TASKBAR: '#c0c0c0',
                TITLE_BAR: '#000080',
                WINDOW_BG: '#ffffff'
            },
            ANIMATION: {
                FPS_UPDATE_INTERVAL: 1000,
                LED_THROTTLE_FRAMES: 10,
                BOOT_MESSAGE_DELAY: 150
            },
            PERFORMANCE: {
                MAX_FPS: 60,
                FRAME_TIME: 16.67
            }
        };

        class Windows95Emulator {
            constructor() {
                this.v86 = null;
                this.isRunning = false;
                this.isPaused = false;
                this.startTime = Date.now();
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                this.lastFrameTime = 0;
                this.hddLedTimeout = null;
                this.canvas = null;
                this.ctx = null;
                this.domCache = null;
                this.memoryUsage = 0;
                this.cpuUsage = 0;

                this.settings = {
                    memory: 32 * 1024 * 1024,
                    enableMouse: true,
                    enableSound: true,
                    enableNetwork: true,
                    cpuSpeed: 2
                };

                this.desktop = {
                    icons: [],
                    windows: []
                };

                this.initEmulatorCore();
                this.detectSystemInfo();
            }

            initEmulatorCore() {
                console.log("Initializing x86 emulator core...");
                console.log("WebAssembly support:", typeof WebAssembly !== 'undefined');
            }

            detectSystemInfo() {
                // Detect browser
                const ua = navigator.userAgent;
                let browser = 'Unknown';
                if (ua.indexOf('Firefox') > -1) browser = 'Mozilla Firefox';
                else if (ua.indexOf('Chrome') > -1) browser = 'Google Chrome';
                else if (ua.indexOf('Safari') > -1) browser = 'Apple Safari';
                else if (ua.indexOf('Edge') > -1) browser = 'Microsoft Edge';
                else if (ua.indexOf('MSIE') > -1 || ua.indexOf('Trident') > -1) browser = 'Internet Explorer';

                // Check WebAssembly support
                const wasmSupport = typeof WebAssembly !== 'undefined' ? 
                    '<span style="color: green;">✓ Supported</span>' : 
                    '<span style="color: red;">✗ Not Supported</span>';

                // Get screen info
                const screenInfo = `${window.screen.width}x${window.screen.height}`;

                // Update UI
                setTimeout(() => {
                    const browserInfo = document.getElementById('browser-info');
                    const wasmInfo = document.getElementById('wasm-support');
                    const screenInfoEl = document.getElementById('screen-info');
                    
                    if (browserInfo) browserInfo.innerHTML = browser;
                    if (wasmInfo) wasmInfo.innerHTML = wasmSupport;
                    if (screenInfoEl) screenInfoEl.textContent = screenInfo;
                }, 100);
            }

            initDOMCache() {
                if (this.domCache) return;

                try {
                    this.domCache = {
                        fpsCounter: document.getElementById('fps-counter'),
                        timeDisplay: document.getElementById('time-display'),
                        cpuLed: document.getElementById('cpu-led'),
                        cpuStatus: document.getElementById('cpu-status'),
                        hddLed: document.getElementById('hdd-led'),
                        loadingScreen: document.getElementById('loading-screen'),
                        loadingText: document.getElementById('loading-text'),
                        progressFill: document.getElementById('progress-fill'),
                        setupScreen: document.getElementById('setup-screen'),
                        emulatorContainer: document.getElementById('emulator-container'),
                        emulatorTitlebar: document.getElementById('emulator-titlebar'),
                        memoryUsage: document.getElementById('memory-usage'),
                        pauseBtn: document.getElementById('pause-btn')
                    };
                } catch (error) {
                    console.error('Failed to initialize DOM cache:', error);
                    throw new Error('Required DOM elements not found');
                }
            }

            async loadDemo() {
                try {
                    this.showLoading('Initializing emulator...');
                    this.initDOMCache();

                    // Read settings
                    this.updateSettings();

                    this.canvas = document.getElementById('screen');
                    if (!this.canvas) {
                        throw new Error('Canvas element not found');
                    }

                    this.ctx = this.canvas.getContext('2d', {
                        alpha: false,
                        desynchronized: true,
                        willReadFrequently: false
                    });

                    if (!this.ctx) {
                        throw new Error('Could not get 2D rendering context. Canvas may be disabled.');
                    }

                    this.canvas.width = CONFIG.DISPLAY.WIDTH;
                    this.canvas.height = CONFIG.DISPLAY.HEIGHT;

                    this.domCache.setupScreen.classList.add('hidden');
                    this.domCache.emulatorContainer.classList.remove('hidden');

                    await this.simulateBoot();

                    this.hideLoading();
                    this.startEmulation();
                    
                    // Setup mouse capture
                    this.setupMouseCapture();
                } catch (error) {
                    console.error('Failed to load demo:', error);
                    alert(`Failed to start emulator: ${error.message}\n\nPlease check console for details.`);
                    this.hideLoading();
                }
            }

            updateSettings() {
                try {
                    const memorySelect = document.getElementById('memory-size');
                    const cpuSpeedSelect = document.getElementById('cpu-speed');
                    const enableMouse = document.getElementById('enable-mouse');
                    const enableSound = document.getElementById('enable-sound');
                    const enableNetwork = document.getElementById('enable-network');

                    this.settings.memory = parseInt(memorySelect.value) * 1024 * 1024;
                    this.settings.cpuSpeed = parseInt(cpuSpeedSelect.value);
                    this.settings.enableMouse = enableMouse.checked;
                    this.settings.enableSound = enableSound.checked;
                    this.settings.enableNetwork = enableNetwork.checked;

                    console.log('Settings updated:', this.settings);
                } catch (error) {
                    console.error('Failed to update settings:', error);
                }
            }

            setupMouseCapture() {
                if (!this.settings.enableMouse) return;

                this.canvas.addEventListener('click', () => {
                    if (this.canvas.requestPointerLock) {
                        this.canvas.requestPointerLock();
                    }
                });

                document.addEventListener('pointerlockchange', () => {
                    if (document.pointerLockElement === this.canvas) {
                        console.log('Mouse captured');
                    } else {
                        console.log('Mouse released');
                    }
                });
            }

            async simulateBoot() {
                const bootMessages = [
                    'PhoenixBIOS 4.0 Release 6.0',
                    'Copyright 1985-1995 Phoenix Technologies Ltd.',
                    'All Rights Reserved',
                    '',
                    'CPU: Intel Pentium ' + (this.settings.cpuSpeed * 75) + 'MHz',
                    'Memory Test: ' + (this.settings.memory / 1024) + 'K OK',
                    'Cache: 256K',
                    '',
                    'Press DEL to enter SETUP, ESC to skip memory test',
                    '',
                    'Detecting IDE drives...',
                    'Primary Master: 540MB Hard Disk',
                    'Primary Slave: None',
                    'Secondary Master: CD-ROM Drive',
                    'Secondary Slave: None',
                    '',
                    'Starting MS-DOS...',
                    '',
                    'HIMEM is testing extended memory...done.',
                    'EMM386 Memory Manager v4.49',
                    '',
                    'C:\\>win',
                    '',
                    'Starting Windows 95...'
                ];

                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);
                this.ctx.font = '14px monospace';
                this.ctx.fillStyle = '#c0c0c0';

                for (let i = 0; i < bootMessages.length; i++) {
                    await this.delay(CONFIG.ANIMATION.BOOT_MESSAGE_DELAY);
                    this.ctx.fillText(bootMessages[i], 10, 20 + i * 16);
                    this.updateProgress((i + 1) / bootMessages.length * 50);
                    this.updateLoadingText('Loading BIOS...');
                }

                await this.delay(500);
                this.updateLoadingText('Loading Windows 95...');

                // Clear screen
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);

                // Draw Windows logo with gradient
                const gradient = this.ctx.createLinearGradient(200, 200, 440, 280);
                gradient.addColorStop(0, '#ff0000');
                gradient.addColorStop(0.25, '#ffff00');
                gradient.addColorStop(0.5, '#00ff00');
                gradient.addColorStop(1, '#0000ff');

                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(220, 200, 200, 80);

                // Add shine effect
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                this.ctx.fillRect(220, 200, 200, 20);

                // Windows text
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 24px Arial';
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                this.ctx.shadowBlur = 4;
                this.ctx.fillText('Windows 95', 250, 320);
                this.ctx.shadowBlur = 0;

                // Progress bar
                this.ctx.strokeStyle = '#c0c0c0';
                this.ctx.strokeRect(220, 340, 200, 10);

                // Animate progress
                for (let i = 0; i <= 100; i += 5) {
                    await this.delay(40);
                    this.ctx.fillStyle = '#0000ff';
                    this.ctx.fillRect(221, 341, (198 * i) / 100, 8);
                    this.updateProgress(50 + i / 2);
                }

                this.updateLoadingText('Starting desktop...');
            }

            startEmulation() {
                this.isRunning = true;
                this.startTime = Date.now();

                // Draw desktop background
                this.ctx.fillStyle = CONFIG.COLORS.DESKTOP;
                this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);

                // Draw taskbar with gradient
                const taskbarGrad = this.ctx.createLinearGradient(0, 450, 0, 480);
                taskbarGrad.addColorStop(0, '#dfdfdf');
                taskbarGrad.addColorStop(1, '#c0c0c0');
                this.ctx.fillStyle = taskbarGrad;
                this.ctx.fillRect(0, 450, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.TASKBAR_HEIGHT);

                // Taskbar border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.beginPath();
                this.ctx.moveTo(0, 450);
                this.ctx.lineTo(CONFIG.DISPLAY.WIDTH, 450);
                this.ctx.stroke();

                // Start button with gradient
                const startGrad = this.ctx.createLinearGradient(2, 452, 2, 478);
                startGrad.addColorStop(0, '#ffffff');
                startGrad.addColorStop(0.5, '#c0c0c0');
                startGrad.addColorStop(1, '#808080');
                this.ctx.fillStyle = startGrad;
                this.ctx.fillRect(2, 452, 60, 26);

                // Start button border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.strokeRect(2, 452, 60, 26);
                this.ctx.strokeStyle = '#808080';
                this.ctx.strokeRect(3, 453, 58, 24);

                // Start text
                this.ctx.fillStyle = '#000000';
                this.ctx.font = 'bold 11px Arial';
                this.ctx.fillText('Start', 20, 468);

                // Windows logo on button
                this.ctx.fillStyle = '#ff0000';
                this.ctx.fillRect(6, 458, 4, 4);
                this.ctx.fillStyle = '#00ff00';
                this.ctx.fillRect(10, 458, 4, 4);
                this.ctx.fillStyle = '#0000ff';
                this.ctx.fillRect(6, 462, 4, 4);
                this.ctx.fillStyle = '#ffff00';
                this.ctx.fillRect(10, 462, 4, 4);

                // System tray
                this.ctx.fillStyle = '#808080';
                this.ctx.fillRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);
                this.ctx.strokeStyle = '#000000';
                this.ctx.strokeRect(CONFIG.DISPLAY.WIDTH - 100, 453, 96, 24);

                // Clock
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                this.ctx.fillStyle = '#000000';
                this.ctx.font = '11px Arial';
                this.ctx.fillText(timeStr, CONFIG.DISPLAY.WIDTH - 50, 468);

                // Draw desktop icons
                this.drawIcon(20, 20, 'My Computer', '💻');
                this.drawIcon(20, 90, 'Recycle Bin', '🗑️');
                this.drawIcon(20, 160, 'Network', '🌐');
                this.drawIcon(20, 230, 'My Documents', '📁');

                // Draw a sample window
                this.drawWindow(150, 100, 350, 250, 'Welcome to Windows 95');

                // Start animation loop
                this.updateStatus();
                this.animate();
            }

            drawIcon(x, y, label, emoji) {
                // Icon background (for selection)
                const iconBox = 48;
                
                // Draw icon image (simplified)
                this.ctx.font = '32px Arial';
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillText(emoji, x + 8, y + 32);

                // Icon label
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 11px Arial';
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                this.ctx.shadowBlur = 2;
                this.ctx.textAlign = 'center';
                this.ctx.fillText(label, x + 24, y + 56);
                this.ctx.shadowBlur = 0;
                this.ctx.textAlign = 'left';
            }

            drawWindow(x, y, width, height, title) {
                // Window outer border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.strokeRect(x, y, width, height);
                this.ctx.strokeStyle = '#808080';
                this.ctx.strokeRect(x + 1, y + 1, width - 2, height - 2);

                // Window background
                this.ctx.fillStyle = '#c0c0c0';
                this.ctx.fillRect(x + 2, y + 2, width - 4, height - 4);

                // Title bar
                const titleGrad = this.ctx.createLinearGradient(x + 2, y + 2, x + 2, y + 20);
                titleGrad.addColorStop(0, '#0000ff');
                titleGrad.addColorStop(1, '#000080');
                this.ctx.fillStyle = titleGrad;
                this.ctx.fillRect(x + 2, y + 2, width - 4, 18);

                // Title bar text
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 11px Arial';
                this.ctx.fillText(title, x + 6, y + 14);

                // Window control buttons
                const btnSize = 16;
                const btnY = y + 4;
                
                // Minimize button
                this.drawWindowButton(x + width - 60, btnY, btnSize, '_');
                // Maximize button
                this.drawWindowButton(x + width - 40, btnY, btnSize, '□');
                // Close button
                this.drawWindowButton(x + width - 20, btnY, btnSize, 'X');

                // Window content area
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(x + 3, y + 22, width - 6, height - 25);

                // Draw some content
                this.ctx.fillStyle = '#000000';
                this.ctx.font = '12px Arial';
                this.ctx.fillText('Welcome to Windows 95 Emulator!', x + 10, y + 40);
                this.ctx.font = '11px Arial';
                this.ctx.fillText('This is a WebAssembly-powered x86 emulation.', x + 10, y + 60);
                this.ctx.fillText('', x + 10, y + 75);
                this.ctx.fillText('Features:', x + 10, y + 90);
                this.ctx.fillText('• Full desktop environment simulation', x + 20, y + 105);
                this.ctx.fillText('• Mouse and keyboard support', x + 20, y + 120);
                this.ctx.fillText('• Load custom disk images', x + 20, y + 135);
                this.ctx.fillText('• Save and restore state', x + 20, y + 150);
                this.ctx.fillText('', x + 10, y + 165);
                this.ctx.fillStyle = '#000080';
                this.ctx.fillText('Click "Load Disk" to load a Windows 95 image.', x + 10, y + 180);
            }

            drawWindowButton(x, y, size, label) {
                // Button background
                this.ctx.fillStyle = '#c0c0c0';
                this.ctx.fillRect(x, y, size, 14);
                
                // Button border
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.strokeRect(x, y, size, 14);
                this.ctx.strokeStyle = '#808080';
                this.ctx.strokeRect(x + 1, y + 1, size - 2, 12);

                // Button label
                this.ctx.fillStyle = '#000000';
                this.ctx.font = 'bold 10px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(label, x + size / 2, y + 10);
                this.ctx.textAlign = 'left';
            }

            animate() {
                if (!this.isRunning) return;

                const now = Date.now();
                const deltaTime = now - this.lastFrameTime;

                // Frame rate limiting
                if (deltaTime < CONFIG.PERFORMANCE.FRAME_TIME) {
                    requestAnimationFrame(() => this.animate());
                    return;
                }

                this.lastFrameTime = now;
                this.frameCount++;

                // Update FPS and stats
                if (now - this.lastFpsUpdate > CONFIG.ANIMATION.FPS_UPDATE_INTERVAL) {
                    const fps = Math.round(this.frameCount * 1000 / (now - this.lastFpsUpdate));
                    this.domCache.fpsCounter.textContent = fps;
                    this.frameCount = 0;
                    this.lastFpsUpdate = now;

                    // Update uptime
                    const elapsed = Math.floor((now - this.startTime) / 1000);
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;

                    const pad = (num) => num < 10 ? '0' + num : '' + num;
                    this.domCache.timeDisplay.textContent =
                        `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

                    // Update memory usage simulation
                    this.memoryUsage = Math.floor(this.settings.memory / 1024 / 1024 * (0.3 + Math.random() * 0.2));
                    this.domCache.memoryUsage.textContent = this.memoryUsage + ' MB';
                }

                // Update LED indicators (throttled)
                if (this.frameCount % CONFIG.ANIMATION.LED_THROTTLE_FRAMES === 0) {
                    // CPU activity
                    if (Math.random() > 0.6) {
                        this.domCache.cpuLed.classList.add('active');
                        this.domCache.cpuStatus.textContent = 'Active';
                        this.cpuUsage = Math.floor(Math.random() * 40 + 10);
                    } else {
                        this.domCache.cpuLed.classList.remove('active');
                        this.domCache.cpuStatus.textContent = 'Idle';
                        this.cpuUsage = Math.floor(Math.random() * 10);
                    }

                    // HDD activity
                    if (Math.random() > 0.85) {
                        if (this.hddLedTimeout) {
                            clearTimeout(this.hddLedTimeout);
                        }

                        this.domCache.hddLed.classList.add('active');
                        this.hddLedTimeout = setTimeout(() => {
                            this.domCache.hddLed.classList.remove('active');
                            this.hddLedTimeout = null;
                        }, 100);
                    }
                }

                requestAnimationFrame(() => this.animate());
            }

            updateStatus() {
                this.updateSettings();
            }

            updateProgress(percent) {
                if (this.domCache && this.domCache.progressFill) {
                    this.domCache.progressFill.style.width = Math.min(100, percent) + '%';
                    this.domCache.progressFill.parentElement.setAttribute('aria-valuenow', Math.round(percent));
                }
            }

            updateLoadingText(text) {
                if (this.domCache && this.domCache.loadingText) {
                    this.domCache.loadingText.textContent = text;
                }
            }

            showLoading(text = 'Starting Windows 95...') {
                this.initDOMCache();
                this.domCache.loadingScreen.classList.add('active');
                this.updateProgress(0);
                this.updateLoadingText(text);
            }

            hideLoading() {
                setTimeout(() => {
                    if (this.domCache && this.domCache.loadingScreen) {
                        this.domCache.loadingScreen.classList.remove('active');
                    }
                }, 500);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                if (this.isPaused) {
                    this.isRunning = false;
                    this.domCache.pauseBtn.innerHTML = '<span aria-hidden="true">▶</span> Resume';
                    this.domCache.emulatorTitlebar.classList.add('inactive');
                    
                    // Show paused message
                    const pauseText = 'PAUSED';
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    this.ctx.fillRect(0, 0, CONFIG.DISPLAY.WIDTH, CONFIG.DISPLAY.HEIGHT);
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.font = 'bold 48px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(pauseText, CONFIG.DISPLAY.WIDTH / 2, CONFIG.DISPLAY.HEIGHT / 2);
                    this.ctx.textAlign = 'left';
                } else {
                    this.isRunning = true;
                    this.domCache.pauseBtn.innerHTML = '<span aria-hidden="true">⏸</span> Pause';
                    this.domCache.emulatorTitlebar.classList.remove('inactive');
                    this.lastFrameTime = Date.now();
                    this.animate();
                }
            }

            restart() {
                if (!confirm('Are you sure you want to restart? Any unsaved changes will be lost.')) {
                    return;
                }

                this.isRunning = false;
                this.isPaused = false;
                this.startTime = Date.now();
                this.frameCount = 0;
                this.lastFrameTime = 0;

                if (this.hddLedTimeout) {
                    clearTimeout(this.hddLedTimeout);
                    this.hddLedTimeout = null;
                }

                // Reset UI
                this.initDOMCache();
                this.domCache.emulatorContainer.classList.add('hidden');
                this.domCache.setupScreen.classList.remove('hidden');
                
                if (this.domCache.pauseBtn) {
                    this.domCache.pauseBtn.innerHTML = '<span aria-hidden="true">⏸</span> Pause';
                }
            }

            fullscreen() {
                try {
                    const container = document.getElementById('emulator-container');

                    if (!document.fullscreenEnabled && !document.webkitFullscreenEnabled &&
                        !document.mozFullScreenEnabled && !document.msFullscreenEnabled) {
                        alert('Fullscreen not supported in this browser');
                        return;
                    }

                    if (document.fullscreenElement || document.webkitFullscreenElement || 
                        document.mozFullScreenElement || document.msFullscreenElement) {
                        // Exit fullscreen
                        const exitFullscreen = document.exitFullscreen ||
                                             document.webkitExitFullscreen ||
                                             document.mozCancelFullScreen ||
                                             document.msExitFullscreen;
                        if (exitFullscreen) {
                            exitFullscreen.call(document);
                        }
                    } else {
                        // Enter fullscreen
                        const requestFullscreen = container.requestFullscreen ||
                                                container.webkitRequestFullscreen ||
                                                container.webkitRequestFullScreen ||
                                                container.mozRequestFullScreen ||
                                                container.msRequestFullscreen;

                        if (requestFullscreen) {
                            requestFullscreen.call(container).catch(err => {
                                console.error('Fullscreen request failed:', err);
                                alert('Could not enter fullscreen mode');
                            });
                        }
                    }
                } catch (error) {
                    console.error('Fullscreen error:', error);
                    alert('Fullscreen failed: ' + error.message);
                }
            }

            screenshot() {
                try {
                    const canvas = document.getElementById('screen');
                    if (!canvas) {
                        throw new Error('Canvas not found');
                    }

                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const link = document.createElement('a');
                    link.download = `windows95-screenshot-${timestamp}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Show feedback
                    this.showNotification('Screenshot saved!');
                } catch (error) {
                    console.error('Screenshot failed:', error);
                    alert('Screenshot failed. Canvas may be tainted by cross-origin content.');
                }
            }

            showNotification(message) {
                // Simple notification in the emulator
                const prevFill = this.ctx.fillStyle;
                const prevFont = this.ctx.font;
                
                this.ctx.fillStyle = 'rgba(255, 255, 200, 0.9)';
                this.ctx.fillRect(200, 200, 240, 80);
                this.ctx.strokeStyle = '#000000';
                this.ctx.strokeRect(200, 200, 240, 80);
                
                this.ctx.fillStyle = '#000000';
                this.ctx.font = 'bold 14px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(message, 320, 240);
                this.ctx.textAlign = 'left';
                
                this.ctx.fillStyle = prevFill;
                this.ctx.font = prevFont;
            }

            showHelp() {
                alert(`Windows 95 WASM Emulator Help

CONTROLS:
• Click inside screen to capture mouse
• Press ESC to release mouse cursor
• Ctrl+Alt+Del works inside the emulator
• Use arrow keys for navigation
• Right-click for context menus

KEYBOARD SHORTCUTS:
• F11 - Toggle fullscreen
• Ctrl+P - Pause/Resume
• Ctrl+R - Restart (with confirmation)
• Ctrl+S - Take screenshot

TIPS:
• This emulator runs entirely in your browser
• No data is sent to any server
• Performance depends on your device capabilities
• For best results, use Chrome, Firefox, or Edge
• Increase memory allocation for better performance

SYSTEM INFO:
• Memory: ${this.settings.memory / 1024 / 1024} MB
• CPU Speed: ${this.settings.cpuSpeed}x
• Mouse Lock: ${this.settings.enableMouse ? 'Enabled' : 'Disabled'}
• Sound: ${this.settings.enableSound ? 'Enabled' : 'Disabled'}

NOTE:
This is a demonstration of x86 emulation in WebAssembly.
For full Windows 95 functionality, you need to provide
your own licensed disk image.`);
            }

            loadDisk() {
                document.getElementById('disk-input').click();
            }

            handleDiskUpload(event) {
                try {
                    const file = event.target.files[0];
                    if (!file) return;

                    const validExtensions = ['.img', '.iso', '.ima'];
                    const fileName = file.name.toLowerCase();
                    const isValid = validExtensions.some(ext => fileName.endsWith(ext));

                    if (!isValid) {
                        alert('Invalid file type. Please select an IMG, ISO, or IMA file.');
                        return;
                    }

                    if (file.size > 100 * 1024 * 1024) {
                        alert('File too large. Maximum size is 100MB for this demo.');
                        return;
                    }

                    // Show file name
                    const fileNameDisplay = document.getElementById('file-name');
                    if (fileNameDisplay) {
                        fileNameDisplay.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    }

                    console.log('Loading disk image:', file.name, 'Size:', file.size, 'bytes');
                    alert(`Disk image "${file.name}" selected.\n\nNote: Full Windows 95 emulation requires the v86 WASM library.\nThis demo shows a simulated environment.\n\nFor actual Windows 95, you would need:\n• A complete v86 library implementation\n• Valid Windows 95 disk image\n• Additional ROM files`);
                    
                    this.loadDemo();
                } catch (error) {
                    console.error('Failed to handle disk upload:', error);
                    alert('Failed to load disk image: ' + error.message);
                }
            }

            loadFromURL() {
                try {
                    const url = document.getElementById('disk-url').value.trim();
                    if (!url) {
                        alert('Please enter a URL');
                        return;
                    }

                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        alert('Invalid URL. Must start with http:// or https://');
                        return;
                    }

                    console.log('Loading from URL:', url);
                    alert(`Loading from URL: ${url}\n\nNote: Full emulation requires the v86 WASM library.\nThis demo shows a simulated environment.\n\nRequirements:\n• Server must support CORS\n• Valid disk image format (IMG/ISO)\n• Stable network connection`);
                    
                    this.loadDemo();
                } catch (error) {
                    console.error('Failed to load from URL:', error);
                    alert('Failed to load from URL: ' + error.message);
                }
            }

            minimize() {
                const container = document.getElementById('emulator-container');
                container.style.transition = 'transform 0.3s ease';
                container.style.transform = 'scale(0.1)';
                container.style.opacity = '0';
                
                setTimeout(() => {
                    container.style.transform = 'scale(1)';
                    container.style.opacity = '1';
                }, 300);
            }

            maximize() {
                this.fullscreen();
            }

            close() {
                if (confirm('Are you sure you want to close Windows 95?\n\nAny unsaved changes will be lost.')) {
                    this.restart();
                }
            }
        }

        // Safe localStorage wrapper
        class SafeStorage {
            static setItem(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (e) {
                    console.warn('localStorage unavailable:', e);
                    return false;
                }
            }

            static getItem(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('localStorage unavailable:', e);
                    return null;
                }
            }

            static removeItem(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.warn('localStorage unavailable:', e);
                    return false;
                }
            }
        }

        // Initialize emulator
        const emulator = new Windows95Emulator();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC - Release mouse
            if (e.key === 'Escape') {
                const isLocked = document.pointerLockElement ||
                                document.webkitPointerLockElement ||
                                document.mozPointerLockElement;

                if (isLocked) {
                    const exitPointerLock = document.exitPointerLock ||
                                          document.webkitExitPointerLock ||
                                          document.mozExitPointerLock;
                    if (exitPointerLock) {
                        exitPointerLock.call(document);
                    }
                }
            }

            // F11 - Fullscreen
            if (e.key === 'F11') {
                e.preventDefault();
                emulator.fullscreen();
            }

            // Ctrl+P - Pause
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                emulator.togglePause();
            }

            // Ctrl+S - Screenshot
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                emulator.screenshot();
            }

            // Ctrl+R - Restart
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                emulator.restart();
            }
        });

        // Auto-save settings
        window.addEventListener('beforeunload', () => {
            const settings = {
                memory: document.getElementById('memory-size').value,
                cpuSpeed: document.getElementById('cpu-speed').value,
                enableMouse: document.getElementById('enable-mouse').checked,
                enableSound: document.getElementById('enable-sound').checked,
                enableNetwork: document.getElementById('enable-network').checked
            };
            SafeStorage.setItem('win95-emulator-settings', JSON.stringify(settings));
        });

        // Load saved settings
        window.addEventListener('load', () => {
            const saved = SafeStorage.getItem('win95-emulator-settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    document.getElementById('memory-size').value = settings.memory || '32';
                    document.getElementById('cpu-speed').value = settings.cpuSpeed || '2';
                    document.getElementById('enable-mouse').checked = settings.enableMouse !== false;
                    document.getElementById('enable-sound').checked = settings.enableSound !== false;
                    document.getElementById('enable-network').checked = settings.enableNetwork !== false;
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            }
        });

        // Handle file input label update
        document.getElementById('disk-input').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            if (fileName) {
                const label = document.querySelector('.file-input-label');
                label.textContent = fileName;
            }
        });

        // Fullscreen change handler
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                console.log('Entered fullscreen mode');
            } else {
                console.log('Exited fullscreen mode');
            }
        });

        // Log initialization
        console.log('Windows 95 WASM Emulator initialized');
        console.log('WebAssembly support:', typeof WebAssembly !== 'undefined');
    </script>
</body>
</html>