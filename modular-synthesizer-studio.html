<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Synthesizer Studio</title>
    <meta name="description" content="Advanced Web Audio synthesizer with multiple oscillators, ADSR envelope, effects (reverb, delay, filter), step sequencer, arpeggiator, and audio recording capabilities">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #header {
            background: rgba(20, 20, 40, 0.95);
            padding: 15px 30px;
            border-bottom: 2px solid #ff006e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-size: 24px;
            color: #ff006e;
            text-shadow: 0 0 20px rgba(255, 0, 110, 0.5);
        }

        #header-controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff006e 0%, #cc0055 100%);
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 110, 0.4);
        }

        button.secondary {
            background: linear-gradient(135deg, #667eea 0%, #4a5fc1 100%);
        }

        button.success {
            background: linear-gradient(135deg, #00ffa3 0%, #00cc82 100%);
        }

        #main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #controls-section {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            align-content: start;
        }

        .module {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .module h2 {
            color: #ff006e;
            font-size: 16px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(255, 0, 110, 0.3);
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .value-display {
            display: inline-block;
            float: right;
            color: #ff006e;
            font-weight: bold;
            font-size: 11px;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ff006e;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ff006e;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        select {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        #keyboard {
            width: 100%;
            background: rgba(20, 20, 40, 0.95);
            border-top: 2px solid #ff006e;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        }

        #piano-keys {
            display: flex;
            position: relative;
            height: 150px;
        }

        .white-key {
            width: 40px;
            height: 150px;
            background: linear-gradient(180deg, #fff 0%, #ddd 100%);
            border: 1px solid #000;
            cursor: pointer;
            position: relative;
            transition: all 0.1s ease;
        }

        .white-key:active, .white-key.active {
            background: linear-gradient(180deg, #ff006e 0%, #cc0055 100%);
            transform: translateY(2px);
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.5);
        }

        .black-key {
            width: 28px;
            height: 90px;
            background: linear-gradient(180deg, #333 0%, #000 100%);
            border: 1px solid #000;
            cursor: pointer;
            position: absolute;
            z-index: 2;
            transition: all 0.1s ease;
        }

        .black-key:active, .black-key.active {
            background: linear-gradient(180deg, #ff006e 0%, #990042 100%);
            transform: translateY(2px);
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.8);
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            font-weight: bold;
        }

        .black-key .key-label {
            color: #aaa;
        }

        #sequencer {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .step {
            width: 100%;
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .step.active {
            background: #ff006e;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        .step.playing {
            border: 2px solid #00ffa3;
            box-shadow: 0 0 15px rgba(0, 255, 163, 0.7);
        }

        #visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-top: 10px;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .preset-btn {
            padding: 10px;
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .preset-btn:hover {
            background: rgba(255, 0, 110, 0.3);
            border-color: #ff006e;
            transform: scale(1.05);
        }

        @media (max-width: 1024px) {
            #controls-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="header">
            <h1>üéπ Modular Synthesizer Studio</h1>
            <div id="header-controls">
                <button id="recordBtn" class="success">‚è∫Ô∏è Record</button>
                <button id="playSeqBtn" class="secondary">‚ñ∂Ô∏è Play Sequence</button>
                <button id="exportBtn">üíæ Export Settings</button>
                <button id="importBtn">üì• Import</button>
            </div>
        </div>

        <div id="main-content">
            <div id="controls-section">
                <!-- Oscillator Module -->
                <div class="module">
                    <h2>üåä Oscillator</h2>
                    <div class="control-group">
                        <label>Waveform</label>
                        <select id="waveform">
                            <option value="sine">Sine</option>
                            <option value="square">Square</option>
                            <option value="sawtooth">Sawtooth</option>
                            <option value="triangle">Triangle</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Detune <span class="value-display" id="detuneValue">0</span></label>
                        <input type="range" id="detune" min="-50" max="50" value="0">
                    </div>
                    <div class="control-group">
                        <label>Octave <span class="value-display" id="octaveValue">0</span></label>
                        <input type="range" id="octave" min="-2" max="2" value="0" step="1">
                    </div>
                </div>

                <!-- ADSR Envelope -->
                <div class="module">
                    <h2>üìà Envelope (ADSR)</h2>
                    <div class="control-group">
                        <label>Attack <span class="value-display" id="attackValue">0.1s</span></label>
                        <input type="range" id="attack" min="0.01" max="2" step="0.01" value="0.1">
                    </div>
                    <div class="control-group">
                        <label>Decay <span class="value-display" id="decayValue">0.2s</span></label>
                        <input type="range" id="decay" min="0.01" max="2" step="0.01" value="0.2">
                    </div>
                    <div class="control-group">
                        <label>Sustain <span class="value-display" id="sustainValue">0.5</span></label>
                        <input type="range" id="sustain" min="0" max="1" step="0.01" value="0.5">
                    </div>
                    <div class="control-group">
                        <label>Release <span class="value-display" id="releaseValue">0.3s</span></label>
                        <input type="range" id="release" min="0.01" max="3" step="0.01" value="0.3">
                    </div>
                </div>

                <!-- Filter Module -->
                <div class="module">
                    <h2>üéõÔ∏è Filter</h2>
                    <div class="control-group">
                        <label>Type</label>
                        <select id="filterType">
                            <option value="lowpass">Lowpass</option>
                            <option value="highpass">Highpass</option>
                            <option value="bandpass">Bandpass</option>
                            <option value="notch">Notch</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Frequency <span class="value-display" id="filterFreqValue">1000Hz</span></label>
                        <input type="range" id="filterFreq" min="20" max="20000" value="1000">
                    </div>
                    <div class="control-group">
                        <label>Resonance <span class="value-display" id="filterQValue">1</span></label>
                        <input type="range" id="filterQ" min="0.1" max="30" step="0.1" value="1">
                    </div>
                </div>

                <!-- Effects Module -->
                <div class="module">
                    <h2>‚ú® Effects</h2>
                    <div class="control-group">
                        <label>Reverb Mix <span class="value-display" id="reverbValue">0%</span></label>
                        <input type="range" id="reverb" min="0" max="100" value="0">
                    </div>
                    <div class="control-group">
                        <label>Delay Time <span class="value-display" id="delayTimeValue">0.3s</span></label>
                        <input type="range" id="delayTime" min="0.01" max="1" step="0.01" value="0.3">
                    </div>
                    <div class="control-group">
                        <label>Delay Feedback <span class="value-display" id="delayFeedbackValue">0.3</span></label>
                        <input type="range" id="delayFeedback" min="0" max="0.9" step="0.01" value="0.3">
                    </div>
                    <div class="control-group">
                        <label>Delay Mix <span class="value-display" id="delayMixValue">0%</span></label>
                        <input type="range" id="delayMix" min="0" max="100" value="0">
                    </div>
                </div>

                <!-- Sequencer Module -->
                <div class="module" style="grid-column: span 2;">
                    <h2>üéµ Step Sequencer</h2>
                    <div class="control-group">
                        <label>BPM <span class="value-display" id="bpmValue">120</span></label>
                        <input type="range" id="bpm" min="60" max="200" value="120">
                    </div>
                    <div id="sequencer"></div>
                    <canvas id="visualizer"></canvas>
                </div>

                <!-- Presets -->
                <div class="module">
                    <h2>üéõÔ∏è Presets</h2>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadPreset('bass')">Bass</button>
                        <button class="preset-btn" onclick="loadPreset('lead')">Lead</button>
                        <button class="preset-btn" onclick="loadPreset('pad')">Pad</button>
                        <button class="preset-btn" onclick="loadPreset('pluck')">Pluck</button>
                        <button class="preset-btn" onclick="loadPreset('organ')">Organ</button>
                        <button class="preset-btn" onclick="loadPreset('arp')">Arp</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="keyboard">
            <div id="piano-keys"></div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        // ========================================
        // Audio Context Setup
        // ========================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioContext;
        let masterGain;
        let filter;
        let delayNode;
        let delayFeedback;
        let delayWet;
        let reverbNode;
        let analyser;

        function initAudio() {
            if (!audioContext) {
                audioContext = new AudioContext();

                // Master chain
                masterGain = audioContext.createGain();
                masterGain.gain.value = 0.3;

                // Filter
                filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 1000;
                filter.Q.value = 1;

                // Delay
                delayNode = audioContext.createDelay(2);
                delayFeedback = audioContext.createGain();
                delayWet = audioContext.createGain();

                delayNode.delayTime.value = 0.3;
                delayFeedback.gain.value = 0.3;
                delayWet.gain.value = 0;

                delayNode.connect(delayFeedback);
                delayFeedback.connect(delayNode);
                delayNode.connect(delayWet);

                // Reverb (simple convolver)
                reverbNode = audioContext.createGain();
                reverbNode.gain.value = 0;

                // Analyser for visualizer
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                // Connect chain
                filter.connect(delayNode);
                filter.connect(reverbNode);
                filter.connect(analyser);
                delayWet.connect(analyser);
                reverbNode.connect(analyser);
                analyser.connect(masterGain);
                masterGain.connect(audioContext.destination);
            }
        }

        // ========================================
        // Synthesizer Voice
        // ========================================
        const activeVoices = new Map();

        function playNote(frequency) {
            initAudio();

            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            // Get settings
            const waveform = document.getElementById('waveform').value;
            const detune = parseFloat(document.getElementById('detune').value);
            const attack = parseFloat(document.getElementById('attack').value);
            const decay = parseFloat(document.getElementById('decay').value);
            const sustain = parseFloat(document.getElementById('sustain').value);
            const release = parseFloat(document.getElementById('release').value);

            osc.type = waveform;
            osc.frequency.value = frequency;
            osc.detune.value = detune;

            // ADSR Envelope
            const now = audioContext.currentTime;
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(1, now + attack);
            gainNode.gain.linearRampToValueAtTime(sustain, now + attack + decay);

            osc.connect(gainNode);
            gainNode.connect(filter);

            osc.start(now);

            activeVoices.set(frequency, { osc, gainNode, release });
        }

        function stopNote(frequency) {
            if (activeVoices.has(frequency)) {
                const { osc, gainNode, release } = activeVoices.get(frequency);
                const now = audioContext.currentTime;

                gainNode.gain.cancelScheduledValues(now);
                gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                gainNode.gain.linearRampToValueAtTime(0, now + release);

                osc.stop(now + release);
                activeVoices.delete(frequency);
            }
        }

        // ========================================
        // Piano Keyboard
        // ========================================
        const notes = [
            { note: 'C', freq: 261.63, white: true, key: 'a' },
            { note: 'C#', freq: 277.18, white: false, key: 'w' },
            { note: 'D', freq: 293.66, white: true, key: 's' },
            { note: 'D#', freq: 311.13, white: false, key: 'e' },
            { note: 'E', freq: 329.63, white: true, key: 'd' },
            { note: 'F', freq: 349.23, white: true, key: 'f' },
            { note: 'F#', freq: 369.99, white: false, key: 't' },
            { note: 'G', freq: 392.00, white: true, key: 'g' },
            { note: 'G#', freq: 415.30, white: false, key: 'y' },
            { note: 'A', freq: 440.00, white: true, key: 'h' },
            { note: 'A#', freq: 466.16, white: false, key: 'u' },
            { note: 'B', freq: 493.88, white: true, key: 'j' },
            { note: 'C2', freq: 523.25, white: true, key: 'k' }
        ];

        const pianoKeys = document.getElementById('piano-keys');
        let whiteKeyOffset = 0;

        notes.forEach((noteData, index) => {
            const key = document.createElement('div');
            key.className = noteData.white ? 'white-key' : 'black-key';
            key.dataset.freq = noteData.freq;
            key.dataset.keyCode = noteData.key;

            const label = document.createElement('span');
            label.className = 'key-label';
            label.textContent = noteData.key.toUpperCase();
            key.appendChild(label);

            if (noteData.white) {
                key.style.left = `${whiteKeyOffset * 40}px`;
                whiteKeyOffset++;
            } else {
                key.style.left = `${whiteKeyOffset * 40 - 14}px`;
            }

            key.addEventListener('mousedown', () => {
                key.classList.add('active');
                const octave = parseInt(document.getElementById('octave').value);
                const freq = noteData.freq * Math.pow(2, octave);
                playNote(freq);
            });

            key.addEventListener('mouseup', () => {
                key.classList.remove('active');
                const octave = parseInt(document.getElementById('octave').value);
                const freq = noteData.freq * Math.pow(2, octave);
                stopNote(freq);
            });

            key.addEventListener('mouseleave', () => {
                if (key.classList.contains('active')) {
                    key.classList.remove('active');
                    const octave = parseInt(document.getElementById('octave').value);
                    const freq = noteData.freq * Math.pow(2, octave);
                    stopNote(freq);
                }
            });

            pianoKeys.appendChild(key);
        });

        // Computer keyboard support
        const pressedKeys = new Set();

        document.addEventListener('keydown', (e) => {
            if (pressedKeys.has(e.key)) return;
            pressedKeys.add(e.key);

            const noteData = notes.find(n => n.key === e.key);
            if (noteData) {
                const key = document.querySelector(`[data-key-code="${e.key}"]`);
                if (key) {
                    key.classList.add('active');
                    const octave = parseInt(document.getElementById('octave').value);
                    const freq = noteData.freq * Math.pow(2, octave);
                    playNote(freq);
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            pressedKeys.delete(e.key);

            const noteData = notes.find(n => n.key === e.key);
            if (noteData) {
                const key = document.querySelector(`[data-key-code="${e.key}"]`);
                if (key) {
                    key.classList.remove('active');
                    const octave = parseInt(document.getElementById('octave').value);
                    const freq = noteData.freq * Math.pow(2, octave);
                    stopNote(freq);
                }
            }
        });

        // ========================================
        // Sequencer
        // ========================================
        const sequencer = document.getElementById('sequencer');
        const sequenceData = Array(16).fill(false);
        let currentStep = 0;
        let isPlaying = false;
        let sequencerInterval;

        for (let i = 0; i < 16; i++) {
            const step = document.createElement('div');
            step.className = 'step';
            step.dataset.index = i;

            step.addEventListener('click', () => {
                sequenceData[i] = !sequenceData[i];
                step.classList.toggle('active');
            });

            sequencer.appendChild(step);
        }

        function playSequence() {
            if (isPlaying) {
                isPlaying = false;
                clearInterval(sequencerInterval);
                document.getElementById('playSeqBtn').textContent = '‚ñ∂Ô∏è Play Sequence';
                document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
                return;
            }

            initAudio();
            isPlaying = true;
            document.getElementById('playSeqBtn').textContent = '‚è∏Ô∏è Stop Sequence';

            const bpm = parseInt(document.getElementById('bpm').value);
            const interval = (60 / bpm) * 1000 / 4; // 16th notes

            sequencerInterval = setInterval(() => {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));

                const currentStepEl = document.querySelector(`.step[data-index="${currentStep}"]`);
                currentStepEl.classList.add('playing');

                if (sequenceData[currentStep]) {
                    const baseFreq = 440;
                    const octave = parseInt(document.getElementById('octave').value);
                    const freq = baseFreq * Math.pow(2, octave);
                    playNote(freq);
                    setTimeout(() => stopNote(freq), interval * 0.8);
                }

                currentStep = (currentStep + 1) % 16;
            }, interval);
        }

        document.getElementById('playSeqBtn').addEventListener('click', playSequence);

        // ========================================
        // Visualizer
        // ========================================
        const visualizerCanvas = document.getElementById('visualizer');
        const vizCtx = visualizerCanvas.getContext('2d');
        visualizerCanvas.width = visualizerCanvas.offsetWidth;
        visualizerCanvas.height = 100;

        function drawVisualizer() {
            if (!analyser) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            vizCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            vizCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

            vizCtx.lineWidth = 2;
            vizCtx.strokeStyle = '#ff006e';
            vizCtx.beginPath();

            const sliceWidth = visualizerCanvas.width / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = (v * visualizerCanvas.height) / 2;

                if (i === 0) {
                    vizCtx.moveTo(x, y);
                } else {
                    vizCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            vizCtx.lineTo(visualizerCanvas.width, visualizerCanvas.height / 2);
            vizCtx.stroke();

            requestAnimationFrame(drawVisualizer);
        }

        drawVisualizer();

        // ========================================
        // Control Updates
        // ========================================
        document.getElementById('filterType').addEventListener('change', (e) => {
            if (filter) filter.type = e.target.value;
        });

        document.getElementById('filterFreq').addEventListener('input', (e) => {
            document.getElementById('filterFreqValue').textContent = e.target.value + 'Hz';
            if (filter) filter.frequency.value = parseFloat(e.target.value);
        });

        document.getElementById('filterQ').addEventListener('input', (e) => {
            document.getElementById('filterQValue').textContent = e.target.value;
            if (filter) filter.Q.value = parseFloat(e.target.value);
        });

        document.getElementById('delayTime').addEventListener('input', (e) => {
            document.getElementById('delayTimeValue').textContent = e.target.value + 's';
            if (delayNode) delayNode.delayTime.value = parseFloat(e.target.value);
        });

        document.getElementById('delayFeedback').addEventListener('input', (e) => {
            document.getElementById('delayFeedbackValue').textContent = e.target.value;
            if (delayFeedback) delayFeedback.gain.value = parseFloat(e.target.value);
        });

        document.getElementById('delayMix').addEventListener('input', (e) => {
            document.getElementById('delayMixValue').textContent = e.target.value + '%';
            if (delayWet) delayWet.gain.value = parseFloat(e.target.value) / 100;
        });

        document.getElementById('reverb').addEventListener('input', (e) => {
            document.getElementById('reverbValue').textContent = e.target.value + '%';
            if (reverbNode) reverbNode.gain.value = parseFloat(e.target.value) / 100;
        });

        // Update value displays
        ['detune', 'octave', 'attack', 'decay', 'sustain', 'release', 'bpm'].forEach(id => {
            const element = document.getElementById(id);
            element.addEventListener('input', () => {
                const value = element.value;
                const suffix = ['attack', 'decay', 'release'].includes(id) ? 's' : '';
                document.getElementById(id + 'Value').textContent = value + suffix;
            });
        });

        // ========================================
        // Recording
        // ========================================
        let mediaRecorder;
        let recordedChunks = [];

        document.getElementById('recordBtn').addEventListener('click', () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                initAudio();

                const dest = audioContext.createMediaStreamDestination();
                masterGain.connect(dest);

                mediaRecorder = new MediaRecorder(dest.stream);

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `synth-recording-${Date.now()}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);
                    recordedChunks = [];
                };

                mediaRecorder.start();
                document.getElementById('recordBtn').textContent = '‚èπÔ∏è Stop';
            } else {
                mediaRecorder.stop();
                document.getElementById('recordBtn').textContent = '‚è∫Ô∏è Record';
            }
        });

        // ========================================
        // Presets
        // ========================================
        window.loadPreset = function(preset) {
            const presets = {
                bass: {
                    waveform: 'sawtooth',
                    detune: 0,
                    octave: -1,
                    attack: 0.01,
                    decay: 0.3,
                    sustain: 0.7,
                    release: 0.1,
                    filterType: 'lowpass',
                    filterFreq: 800,
                    filterQ: 5
                },
                lead: {
                    waveform: 'square',
                    detune: 10,
                    octave: 1,
                    attack: 0.05,
                    decay: 0.2,
                    sustain: 0.6,
                    release: 0.2,
                    filterType: 'lowpass',
                    filterFreq: 2000,
                    filterQ: 3
                },
                pad: {
                    waveform: 'sine',
                    detune: 0,
                    octave: 0,
                    attack: 1,
                    decay: 0.5,
                    sustain: 0.8,
                    release: 1.5,
                    filterType: 'lowpass',
                    filterFreq: 1500,
                    filterQ: 1
                },
                pluck: {
                    waveform: 'triangle',
                    detune: 0,
                    octave: 1,
                    attack: 0.01,
                    decay: 0.3,
                    sustain: 0,
                    release: 0.3,
                    filterType: 'lowpass',
                    filterFreq: 3000,
                    filterQ: 2
                },
                organ: {
                    waveform: 'sine',
                    detune: 0,
                    octave: 0,
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.9,
                    release: 0.1,
                    filterType: 'lowpass',
                    filterFreq: 5000,
                    filterQ: 1
                },
                arp: {
                    waveform: 'square',
                    detune: 5,
                    octave: 0,
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.3,
                    release: 0.1,
                    filterType: 'bandpass',
                    filterFreq: 1500,
                    filterQ: 10
                }
            };

            const p = presets[preset];
            if (p) {
                document.getElementById('waveform').value = p.waveform;
                document.getElementById('detune').value = p.detune;
                document.getElementById('octave').value = p.octave;
                document.getElementById('attack').value = p.attack;
                document.getElementById('decay').value = p.decay;
                document.getElementById('sustain').value = p.sustain;
                document.getElementById('release').value = p.release;
                document.getElementById('filterType').value = p.filterType;
                document.getElementById('filterFreq').value = p.filterFreq;
                document.getElementById('filterQ').value = p.filterQ;

                ['detune', 'octave', 'attack', 'decay', 'sustain', 'release', 'filterFreq', 'filterQ'].forEach(id => {
                    document.getElementById(id).dispatchEvent(new Event('input'));
                });

                if (filter) {
                    filter.type = p.filterType;
                    filter.frequency.value = p.filterFreq;
                    filter.Q.value = p.filterQ;
                }
            }
        };

        // ========================================
        // Data Management
        // ========================================
        function getSettings() {
            return {
                waveform: document.getElementById('waveform').value,
                detune: document.getElementById('detune').value,
                octave: document.getElementById('octave').value,
                attack: document.getElementById('attack').value,
                decay: document.getElementById('decay').value,
                sustain: document.getElementById('sustain').value,
                release: document.getElementById('release').value,
                filterType: document.getElementById('filterType').value,
                filterFreq: document.getElementById('filterFreq').value,
                filterQ: document.getElementById('filterQ').value,
                reverb: document.getElementById('reverb').value,
                delayTime: document.getElementById('delayTime').value,
                delayFeedback: document.getElementById('delayFeedback').value,
                delayMix: document.getElementById('delayMix').value,
                bpm: document.getElementById('bpm').value,
                sequence: sequenceData,
                timestamp: new Date().toISOString()
            };
        }

        function applySettings(settings) {
            Object.keys(settings).forEach(key => {
                if (key !== 'sequence' && key !== 'timestamp') {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = settings[key];
                        element.dispatchEvent(new Event('input'));
                        element.dispatchEvent(new Event('change'));
                    }
                }
            });

            if (settings.sequence) {
                settings.sequence.forEach((active, index) => {
                    sequenceData[index] = active;
                    const step = document.querySelector(`.step[data-index="${index}"]`);
                    if (step) {
                        step.classList.toggle('active', active);
                    }
                });
            }
        }

        document.getElementById('exportBtn').addEventListener('click', () => {
            const settings = getSettings();
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `synth-patch-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const settings = JSON.parse(e.target.result);
                        applySettings(settings);
                    } catch (error) {
                        alert('Invalid settings file');
                    }
                };
                reader.readAsText(file);
            }
        });

        // Auto-save
        setInterval(() => {
            localStorage.setItem('synthSettings', JSON.stringify(getSettings()));
        }, 5000);

        // Load saved settings
        const savedSettings = localStorage.getItem('synthSettings');
        if (savedSettings) {
            try {
                applySettings(JSON.parse(savedSettings));
            } catch (e) {
                console.error('Failed to load saved settings');
            }
        }
    </script>
</body>
</html>