<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wave Music Composer</title>
    <meta name="description" content="Visual music composition tool using waveforms, drag-and-drop notes, multiple instruments, chord progressions, and real-time playback with Web Audio API">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d1b4e 0%, #1a0b2e 100%);
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #header {
            background: rgba(20, 10, 40, 0.95);
            padding: 15px 30px;
            border-bottom: 2px solid #9d4edd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 22px;
            color: #9d4edd;
            text-shadow: 0 0 10px rgba(157, 78, 221, 0.5);
        }

        #controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(157, 78, 221, 0.4);
        }

        #main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: 280px;
            background: rgba(20, 10, 40, 0.95);
            border-right: 1px solid rgba(157, 78, 221, 0.3);
            padding: 20px;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(157, 78, 221, 0.2);
        }

        .section h2 {
            font-size: 14px;
            color: #9d4edd;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .instrument-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid rgba(157, 78, 221, 0.3);
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .instrument-btn:hover {
            background: rgba(157, 78, 221, 0.3);
        }

        .instrument-btn.active {
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
            color: #fff;
        }

        #workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
        }

        #piano-roll {
            flex: 1;
            position: relative;
            overflow: auto;
            background: linear-gradient(90deg, #1a0a2e 0%, #0a0a1a 100%);
        }

        #grid-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        #timeline {
            height: 60px;
            background: rgba(20, 10, 40, 0.95);
            border-top: 1px solid rgba(157, 78, 221, 0.3);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }

        #playhead {
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: #ff006e;
            box-shadow: 0 0 10px #ff006e;
            pointer-events: none;
            z-index: 100;
        }

        label {
            font-size: 11px;
            color: #aaa;
            margin-right: 10px;
        }

        input[type="range"] {
            width: 150px;
        }

        select {
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            border: 1px solid rgba(157, 78, 221, 0.3);
            border-radius: 3px;
            font-size: 11px;
        }

        .note {
            position: absolute;
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
            border: 1px solid #c77dff;
            border-radius: 3px;
            cursor: move;
            box-shadow: 0 2px 8px rgba(157, 78, 221, 0.4);
        }

        .note:hover {
            filter: brightness(1.2);
            box-shadow: 0 4px 12px rgba(157, 78, 221, 0.6);
        }

        .chord-btn {
            padding: 8px 12px;
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid rgba(157, 78, 221, 0.3);
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 10px;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .chord-btn:hover {
            background: rgba(157, 78, 221, 0.3);
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="header">
            <h1>üéµ Wave Music Composer</h1>
            <div id="controls">
                <button id="playBtn">‚ñ∂Ô∏è Play</button>
                <button id="stopBtn">‚èπÔ∏è Stop</button>
                <button id="clearBtn">üóëÔ∏è Clear</button>
                <button id="exportBtn">üíæ Export</button>
            </div>
        </div>

        <div id="main-content">
            <div id="sidebar">
                <div class="section">
                    <h2>Instruments</h2>
                    <button class="instrument-btn active" data-inst="sine">Sine Wave</button>
                    <button class="instrument-btn" data-inst="square">Square Wave</button>
                    <button class="instrument-btn" data-inst="sawtooth">Sawtooth</button>
                    <button class="instrument-btn" data-inst="triangle">Triangle</button>
                    <button class="instrument-btn" data-inst="piano">Piano</button>
                    <button class="instrument-btn" data-inst="bass">Bass</button>
                </div>

                <div class="section">
                    <h2>Quick Chords</h2>
                    <button class="chord-btn" onclick="addChord('major')">C Major</button>
                    <button class="chord-btn" onclick="addChord('minor')">C Minor</button>
                    <button class="chord-btn" onclick="addChord('seventh')">C7</button>
                    <button class="chord-btn" onclick="addChord('sus4')">Csus4</button>
                    <button class="chord-btn" onclick="addChord('dim')">C Dim</button>
                </div>

                <div class="section">
                    <h2>Settings</h2>
                    <label>BPM: <span id="bpmDisplay">120</span></label><br>
                    <input type="range" id="bpm" min="60" max="200" value="120"><br><br>

                    <label>Scale:</label><br>
                    <select id="scale">
                        <option value="chromatic">Chromatic</option>
                        <option value="major" selected>Major</option>
                        <option value="minor">Minor</option>
                        <option value="pentatonic">Pentatonic</option>
                    </select>
                </div>
            </div>

            <div id="workspace">
                <div id="piano-roll">
                    <canvas id="grid-canvas"></canvas>
                    <div id="playhead"></div>
                </div>

                <div id="timeline">
                    <label>Time: <span id="timeDisplay">0.0s</span></label>
                    <label>Notes: <span id="noteCount">0</span></label>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('grid-canvas');
        const ctx = canvas.getContext('2d');
        const pianoRoll = document.getElementById('piano-roll');

        const CELL_WIDTH = 40;
        const CELL_HEIGHT = 30;
        const OCTAVES = 4;
        const NOTES_PER_OCTAVE = 12;
        const TOTAL_NOTES = OCTAVES * NOTES_PER_OCTAVE;
        const BEATS = 32;

        canvas.width = BEATS * CELL_WIDTH;
        canvas.height = TOTAL_NOTES * CELL_HEIGHT;

        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const BASE_FREQ = 130.81; // C3

        let notes = [];
        let currentInstrument = 'sine';
        let isPlaying = false;
        let playbackTime = 0;
        let audioContext;
        let scheduledNotes = [];

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function drawGrid() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw vertical lines (beats)
            for (let i = 0; i <= BEATS; i++) {
                ctx.strokeStyle = i % 4 === 0 ? 'rgba(157, 78, 221, 0.3)' : 'rgba(157, 78, 221, 0.1)';
                ctx.lineWidth = i % 4 === 0 ? 2 : 1;
                ctx.beginPath();
                ctx.moveTo(i * CELL_WIDTH, 0);
                ctx.lineTo(i * CELL_WIDTH, canvas.height);
                ctx.stroke();
            }

            // Draw horizontal lines (notes)
            const scaleType = document.getElementById('scale').value;
            const scales = {
                chromatic: [0,1,2,3,4,5,6,7,8,9,10,11],
                major: [0,2,4,5,7,9,11],
                minor: [0,2,3,5,7,8,10],
                pentatonic: [0,2,4,7,9]
            };

            for (let i = 0; i <= TOTAL_NOTES; i++) {
                const noteInOctave = i % 12;
                const isInScale = scales[scaleType].includes(noteInOctave);
                const isC = noteInOctave === 0;

                if (isC) {
                    ctx.fillStyle = 'rgba(157, 78, 221, 0.05)';
                    ctx.fillRect(0, i * CELL_HEIGHT, canvas.width, CELL_HEIGHT);
                }

                ctx.strokeStyle = isC ? 'rgba(157, 78, 221, 0.4)' :
                                 isInScale ? 'rgba(157, 78, 221, 0.15)' :
                                 'rgba(157, 78, 221, 0.05)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, i * CELL_HEIGHT);
                ctx.lineTo(canvas.width, i * CELL_HEIGHT);
                ctx.stroke();

                // Note names
                if (i < TOTAL_NOTES) {
                    const octave = Math.floor(i / 12) + 3;
                    ctx.fillStyle = 'rgba(157, 78, 221, 0.5)';
                    ctx.font = '10px monospace';
                    ctx.fillText(NOTE_NAMES[noteInOctave] + octave, 5, i * CELL_HEIGHT + 20);
                }
            }
        }

        function getFrequency(noteIndex) {
            return BASE_FREQ * Math.pow(2, noteIndex / 12);
        }

        function playNote(freq, duration, startTime, instrument) {
            initAudio();

            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            switch(instrument) {
                case 'sine':
                case 'square':
                case 'sawtooth':
                case 'triangle':
                    osc.type = instrument;
                    break;
                case 'piano':
                    osc.type = 'sine';
                    break;
                case 'bass':
                    osc.type = 'sawtooth';
                    break;
            }

            osc.frequency.value = freq;

            // ADSR envelope
            const now = audioContext.currentTime + startTime;
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
            gainNode.gain.linearRampToValueAtTime(0.2, now + 0.1);
            gainNode.gain.setValueAtTime(0.2, now + duration - 0.1);
            gainNode.gain.linearRampToValueAtTime(0, now + duration);

            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);

            osc.start(now);
            osc.stop(now + duration);

            return { osc, gainNode };
        }

        function addNote(beat, noteIndex, duration = 1) {
            const note = {
                beat,
                noteIndex,
                duration,
                instrument: currentInstrument,
                id: Date.now() + Math.random()
            };
            notes.push(note);
            renderNotes();
            updateStats();
        }

        function renderNotes() {
            document.querySelectorAll('.note').forEach(n => n.remove());

            notes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note';
                noteEl.style.left = (note.beat * CELL_WIDTH) + 'px';
                noteEl.style.top = (note.noteIndex * CELL_HEIGHT) + 'px';
                noteEl.style.width = (note.duration * CELL_WIDTH - 2) + 'px';
                noteEl.style.height = (CELL_HEIGHT - 2) + 'px';
                noteEl.dataset.id = note.id;

                noteEl.addEventListener('click', (e) => {
                    if (e.shiftKey) {
                        notes = notes.filter(n => n.id !== note.id);
                        renderNotes();
                        updateStats();
                    }
                });

                pianoRoll.appendChild(noteEl);
            });
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left + pianoRoll.scrollLeft;
            const y = e.clientY - rect.top + pianoRoll.scrollTop;

            const beat = Math.floor(x / CELL_WIDTH);
            const noteIndex = Math.floor(y / CELL_HEIGHT);

            if (beat >= 0 && beat < BEATS && noteIndex >= 0 && noteIndex < TOTAL_NOTES) {
                addNote(beat, noteIndex);
            }
        });

        document.querySelectorAll('.instrument-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.instrument-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentInstrument = btn.dataset.inst;
            });
        });

        document.getElementById('playBtn').addEventListener('click', () => {
            if (isPlaying) return;

            initAudio();
            isPlaying = true;
            playbackTime = 0;

            const bpm = parseInt(document.getElementById('bpm').value);
            const beatDuration = 60 / bpm;

            notes.sort((a, b) => a.beat - b.beat);

            notes.forEach(note => {
                const freq = getFrequency(note.noteIndex);
                const startTime = note.beat * beatDuration;
                const duration = note.duration * beatDuration;

                const scheduled = playNote(freq, duration, startTime, note.instrument);
                scheduledNotes.push(scheduled);
            });

            const totalDuration = BEATS * beatDuration;
            animatePlayhead(totalDuration);
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            isPlaying = false;
            scheduledNotes.forEach(({ osc }) => {
                try { osc.stop(); } catch(e) {}
            });
            scheduledNotes = [];
            document.getElementById('playhead').style.left = '0px';
            playbackTime = 0;
        });

        function animatePlayhead(totalDuration) {
            if (!isPlaying) return;

            const bpm = parseInt(document.getElementById('bpm').value);
            const beatDuration = 60 / bpm;

            playbackTime += 0.016;
            const progress = playbackTime / totalDuration;
            document.getElementById('playhead').style.left = (progress * canvas.width) + 'px';
            document.getElementById('timeDisplay').textContent = playbackTime.toFixed(1) + 's';

            if (playbackTime >= totalDuration) {
                document.getElementById('stopBtn').click();
            } else {
                requestAnimationFrame(() => animatePlayhead(totalDuration));
            }
        }

        document.getElementById('clearBtn').addEventListener('click', () => {
            notes = [];
            renderNotes();
            updateStats();
        });

        window.addChord = function(chordType) {
            const chords = {
                major: [0, 4, 7],
                minor: [0, 3, 7],
                seventh: [0, 4, 7, 10],
                sus4: [0, 5, 7],
                dim: [0, 3, 6]
            };

            const intervals = chords[chordType];
            const rootNote = 24; // C4
            const beat = 0;

            intervals.forEach(interval => {
                addNote(beat, rootNote + interval, 2);
            });
        };

        document.getElementById('bpm').addEventListener('input', (e) => {
            document.getElementById('bpmDisplay').textContent = e.target.value;
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            const data = {
                notes,
                bpm: document.getElementById('bpm').value,
                scale: document.getElementById('scale').value,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `composition-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        function updateStats() {
            document.getElementById('noteCount').textContent = notes.length;
        }

        drawGrid();
        renderNotes();
    </script>
</body>
</html>