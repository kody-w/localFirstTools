<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Manager System Demo</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        select, input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #667eea;
        }

        input[type="text"] {
            min-width: 250px;
        }

        #visible-games-count {
            margin-left: auto;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-weight: 600;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .game-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .game-icon {
            font-size: 60px;
            text-align: center;
            margin-bottom: 15px;
        }

        .game-info {
            margin-bottom: 15px;
        }

        .game-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .game-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .game-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }

        .game-category {
            padding: 4px 10px;
            background: #f0f0f0;
            border-radius: 12px;
            color: #666;
        }

        .game-rating {
            padding: 4px 10px;
            background: #fff3e0;
            border-radius: 12px;
            color: #f57c00;
        }

        .game-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .play-button {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .play-button:hover {
            transform: scale(1.05);
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .favorite-button {
            padding: 10px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .favorite-button:hover {
            transform: scale(1.1);
        }

        .favorite-button.favorited {
            background: #ffe0e0;
            border-color: #ff4444;
        }

        .installed-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 12px;
            background: #4caf50;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Modal Styles */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-content {
            margin-bottom: 20px;
        }

        #modal-game-icon {
            font-size: 80px;
            text-align: center;
            margin-bottom: 20px;
        }

        #modal-game-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        #modal-game-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .modal-meta {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .modal-meta span {
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 12px;
            font-size: 14px;
        }

        #play-from-modal {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #play-from-modal:hover {
            transform: scale(1.02);
        }

        /* Emulator Container */
        #emulator-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            flex-direction: column;
        }

        .emulator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
        }

        .emulator-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        #close-emulator {
            padding: 10px 20px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        #close-emulator:hover {
            background: #cc0000;
        }

        .emulator-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #game-iframe, #game-display {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            background: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Game Manager System Demo</h1>

        <div class="controls">
            <div class="control-group">
                <label for="view-toggle">View:</label>
                <select id="view-toggle">
                    <option value="store">Store</option>
                    <option value="library">My Library</option>
                </select>
            </div>

            <div class="control-group">
                <label for="category-filter">Category:</label>
                <select id="category-filter">
                    <option value="all">All Categories</option>
                    <option value="favorites">‚≠ê Favorites</option>
                    <option value="action">Action</option>
                    <option value="puzzle">Puzzle</option>
                    <option value="arcade">Arcade</option>
                    <option value="sports">Sports</option>
                </select>
            </div>

            <div class="control-group">
                <label for="search-input">Search:</label>
                <input type="text" id="search-input" placeholder="Search games...">
            </div>

            <div id="visible-games-count">Showing 0 games</div>
        </div>

        <div class="games-grid" id="games-grid">
            <!-- Game cards will be inserted here -->
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay">
        <div class="modal" id="game-details-modal">
            <div class="modal-header">
                <h2>Game Details</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="modal-game-icon">üéÆ</div>
                <div id="modal-game-title">Game Title</div>
                <p id="modal-game-description">Game description goes here...</p>
                <div class="modal-meta">
                    <span id="modal-game-category">Category</span>
                    <span id="modal-game-rating">‚≠ê 4.5</span>
                    <span id="modal-game-plays">üéÆ 100 plays</span>
                </div>
                <button id="play-from-modal" data-game-id="">‚ñ∂Ô∏è Play Game</button>
            </div>
        </div>
    </div>

    <!-- Emulator Container -->
    <div id="emulator-container">
        <div class="emulator-header">
            <div class="emulator-title">Now Playing</div>
            <button id="close-emulator">‚úï Close</button>
        </div>
        <div class="emulator-content">
            <iframe id="game-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
            <div id="game-display"></div>
        </div>
    </div>

    <script>
        // Game Management System for RetroPlay Console
        // Complete JavaScript implementation with proper async handling

        class StateManager {
            constructor() {
                this.state = {
                    installedGames: new Set(),
                    favorites: new Set(),
                    currentView: 'store', // 'store' or 'library'
                    currentCategory: 'all',
                    searchQuery: '',
                    currentGame: null,
                    gameHistory: []
                };
                this.listeners = new Map();
                this.loadState();
            }

            loadState() {
                try {
                    const savedState = localStorage.getItem('retroplay_state');
                    if (savedState) {
                        const parsed = JSON.parse(savedState);
                        this.state.installedGames = new Set(parsed.installedGames || []);
                        this.state.favorites = new Set(parsed.favorites || []);
                        this.state.currentView = parsed.currentView || 'store';
                        this.state.currentCategory = parsed.currentCategory || 'all';
                        this.state.gameHistory = parsed.gameHistory || [];
                    }
                } catch (error) {
                    console.error('Error loading state:', error);
                }
            }

            saveState() {
                try {
                    const stateToSave = {
                        installedGames: Array.from(this.state.installedGames),
                        favorites: Array.from(this.state.favorites),
                        currentView: this.state.currentView,
                        currentCategory: this.state.currentCategory,
                        gameHistory: this.state.gameHistory
                    };
                    localStorage.setItem('retroplay_state', JSON.stringify(stateToSave));
                } catch (error) {
                    console.error('Error saving state:', error);
                }
            }

            subscribe(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(callback);
            }

            emit(event, data) {
                if (this.listeners.has(event)) {
                    this.listeners.get(event).forEach(callback => callback(data));
                }
            }

            updateState(updates) {
                Object.assign(this.state, updates);
                this.saveState();
                this.emit('stateChanged', this.state);
            }

            getState() {
                return { ...this.state };
            }
        }

        class GameManager {
            constructor(stateManager, gameLibrary) {
                this.stateManager = stateManager;
                this.gameLibrary = gameLibrary || {};
                this.currentGame = null;
                this.gameRunning = false;
                this.gameLoop = null;
                this.blobUrls = new Map(); // Track blob URLs for cleanup

                // DOM elements
                this.gameDisplay = document.getElementById('game-display');
                this.emulatorContainer = document.getElementById('emulator-container');
                this.gameIframe = document.getElementById('game-iframe');
                this.modalOverlay = document.getElementById('modal-overlay');
                this.gameDetailsModal = document.getElementById('game-details-modal');
                this.gamesGrid = document.getElementById('games-grid');
                this.storeView = document.getElementById('store-view');
                this.libraryView = document.getElementById('library-view');
                this.searchInput = document.getElementById('search-input');
                this.categoryFilter = document.getElementById('category-filter');
                this.viewToggle = document.getElementById('view-toggle');

                this.setupEventDelegation();
                this.setupStateListeners();
                this.initializeFilters();
            }

            setupEventDelegation() {
                // Event delegation for game cards (launch, favorite, details)
                if (this.gamesGrid) {
                    this.gamesGrid.addEventListener('click', (e) => {
                        const target = e.target;
                        const gameCard = target.closest('.game-card');

                        if (!gameCard) return;

                        const gameId = gameCard.dataset.gameId;

                        // Handle play/launch button
                        if (target.closest('.play-button')) {
                            e.stopPropagation();
                            this.launchGame(gameId);
                        }
                        // Handle favorite button
                        else if (target.closest('.favorite-button')) {
                            e.stopPropagation();
                            this.toggleFavorite(gameId);
                        }
                        // Handle card click for details (but not play or favorite buttons)
                        else {
                            this.showGameDetails(gameId);
                        }
                    });
                }

                // Close emulator button
                const closeEmulatorBtn = document.getElementById('close-emulator');
                if (closeEmulatorBtn) {
                    closeEmulatorBtn.addEventListener('click', () => this.closeEmulator());
                }

                // Modal close buttons
                if (this.modalOverlay) {
                    this.modalOverlay.addEventListener('click', (e) => {
                        if (e.target === this.modalOverlay) {
                            this.closeModal();
                        }
                    });
                }

                const closeModalBtns = document.querySelectorAll('.close-modal');
                closeModalBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.closeModal());
                });

                // View toggle (store/library)
                if (this.viewToggle) {
                    this.viewToggle.addEventListener('change', (e) => {
                        const view = e.target.value;
                        this.stateManager.updateState({ currentView: view });
                        this.filterGames();
                    });
                }

                // Category filter
                if (this.categoryFilter) {
                    this.categoryFilter.addEventListener('change', (e) => {
                        const category = e.target.value;
                        this.stateManager.updateState({ currentCategory: category });
                        this.filterGames();
                    });
                }

                // Search input
                if (this.searchInput) {
                    this.searchInput.addEventListener('input', (e) => {
                        const query = e.target.value.toLowerCase();
                        this.stateManager.updateState({ searchQuery: query });
                        this.filterGames();
                    });
                }

                // Play button in details modal
                const playFromModalBtn = document.getElementById('play-from-modal');
                if (playFromModalBtn) {
                    playFromModalBtn.addEventListener('click', () => {
                        const gameId = playFromModalBtn.dataset.gameId;
                        this.closeModal();
                        this.launchGame(gameId);
                    });
                }
            }

            setupStateListeners() {
                this.stateManager.subscribe('stateChanged', (state) => {
                    this.updateUI(state);
                });
            }

            initializeFilters() {
                // Set initial filter values from state
                const state = this.stateManager.getState();

                if (this.viewToggle) {
                    this.viewToggle.value = state.currentView;
                }

                if (this.categoryFilter) {
                    this.categoryFilter.value = state.currentCategory;
                }

                // Initial render
                this.filterGames();
            }

            async launchGame(gameId) {
                try {
                    const game = this.gameLibrary[gameId];

                    if (!game) {
                        throw new Error(`Game ${gameId} not found in library`);
                    }

                    console.log(`Launching game: ${game.name}`);

                    // Mark game as installed
                    const state = this.stateManager.getState();
                    state.installedGames.add(gameId);
                    this.stateManager.updateState({
                        installedGames: state.installedGames,
                        currentGame: gameId
                    });

                    // Add to game history
                    this.addToHistory(gameId);

                    // Handle different game types
                    if (game.type === 'local') {
                        await this.launchLocalGame(game);
                    } else if (game.type === 'iframe') {
                        await this.launchIframeGame(game);
                    } else {
                        // Default: embedded game with canvas/renderer
                        await this.launchEmbeddedGame(game);
                    }

                    // Show emulator container
                    if (this.emulatorContainer) {
                        this.emulatorContainer.style.display = 'flex';
                    }

                    console.log(`Game ${game.name} launched successfully`);
                } catch (error) {
                    console.error('Error launching game:', error);
                    alert(`Failed to launch game: ${error.message}`);
                }
            }

            async launchLocalGame(game) {
                // Create blob URL for local game files
                let blobUrl;

                if (game.htmlContent) {
                    // Create blob from HTML content
                    const blob = new Blob([game.htmlContent], { type: 'text/html' });
                    blobUrl = URL.createObjectURL(blob);
                } else if (game.url) {
                    // Fetch and create blob from URL
                    const response = await fetch(game.url);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch game: ${response.status}`);
                    }
                    const blob = await response.blob();
                    blobUrl = URL.createObjectURL(blob);
                } else {
                    throw new Error('No game content or URL provided');
                }

                // Store blob URL for cleanup
                this.blobUrls.set(game.id, blobUrl);

                // Set iframe src
                if (this.gameIframe) {
                    this.gameIframe.src = blobUrl;
                }
            }

            async launchIframeGame(game) {
                // Set iframe src directly for external games
                if (this.gameIframe && game.url) {
                    this.gameIframe.src = game.url;
                } else {
                    throw new Error('Invalid iframe game configuration');
                }
            }

            async launchEmbeddedGame(game) {
                // Stop any current game
                if (this.currentGame) {
                    this.stopCurrentGame();
                }

                // Clear the display
                if (this.gameDisplay) {
                    this.gameDisplay.innerHTML = '';
                }

                // Initialize the new game
                this.currentGame = game;

                if (game.initialize) {
                    await game.initialize(this.gameDisplay);
                }

                // Set up game loop
                if (game.update || game.render) {
                    let lastTime = performance.now();
                    this.gameRunning = true;

                    this.gameLoop = setInterval(() => {
                        if (!this.gameRunning) return;

                        const currentTime = performance.now();
                        const deltaTime = currentTime - lastTime;

                        if (game.update) {
                            game.update(deltaTime);
                        }

                        if (game.render) {
                            game.render();
                        }

                        lastTime = currentTime;
                    }, 1000 / 60); // 60 FPS
                }
            }

            stopCurrentGame() {
                if (this.gameLoop) {
                    clearInterval(this.gameLoop);
                    this.gameLoop = null;
                }

                this.gameRunning = false;

                if (this.currentGame && this.currentGame.cleanup) {
                    this.currentGame.cleanup();
                }

                this.currentGame = null;
            }

            closeEmulator() {
                console.log('Closing emulator');

                // Stop current game
                this.stopCurrentGame();

                // Clear iframe
                if (this.gameIframe) {
                    this.gameIframe.src = 'about:blank';
                }

                // Cleanup blob URLs
                this.blobUrls.forEach((url, gameId) => {
                    URL.revokeObjectURL(url);
                });
                this.blobUrls.clear();

                // Hide emulator container
                if (this.emulatorContainer) {
                    this.emulatorContainer.style.display = 'none';
                }

                // Update state
                this.stateManager.updateState({ currentGame: null });
            }

            showGameDetails(gameId) {
                const game = this.gameLibrary[gameId];

                if (!game) {
                    console.error(`Game ${gameId} not found`);
                    return;
                }

                console.log(`Showing details for: ${game.name}`);

                // Populate modal with game details
                const modalTitle = document.getElementById('modal-game-title');
                const modalIcon = document.getElementById('modal-game-icon');
                const modalDescription = document.getElementById('modal-game-description');
                const modalCategory = document.getElementById('modal-game-category');
                const modalRating = document.getElementById('modal-game-rating');
                const modalPlays = document.getElementById('modal-game-plays');
                const playFromModalBtn = document.getElementById('play-from-modal');

                if (modalTitle) modalTitle.textContent = game.name;
                if (modalIcon) modalIcon.textContent = game.icon || 'üéÆ';
                if (modalDescription) modalDescription.textContent = game.description || 'No description available';
                if (modalCategory) modalCategory.textContent = game.category || 'Uncategorized';
                if (modalRating) modalRating.textContent = `‚≠ê ${game.rating || 'N/A'}`;
                if (modalPlays) modalPlays.textContent = `üéÆ ${game.plays || 0} plays`;

                if (playFromModalBtn) {
                    playFromModalBtn.dataset.gameId = gameId;
                }

                // Show modal
                if (this.modalOverlay) {
                    this.modalOverlay.style.display = 'flex';
                }

                if (this.gameDetailsModal) {
                    this.gameDetailsModal.style.display = 'block';
                }
            }

            closeModal() {
                console.log('Closing modal');

                if (this.modalOverlay) {
                    this.modalOverlay.style.display = 'none';
                }

                // Hide all modals
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            toggleFavorite(gameId) {
                const state = this.stateManager.getState();

                if (state.favorites.has(gameId)) {
                    state.favorites.delete(gameId);
                    console.log(`Removed ${gameId} from favorites`);
                } else {
                    state.favorites.add(gameId);
                    console.log(`Added ${gameId} to favorites`);
                }

                // Update state and save to localStorage
                this.stateManager.updateState({ favorites: state.favorites });

                // Update UI for this specific game card
                this.updateFavoriteButton(gameId, state.favorites.has(gameId));
            }

            updateFavoriteButton(gameId, isFavorite) {
                const gameCard = document.querySelector(`[data-game-id="${gameId}"]`);
                if (!gameCard) return;

                const favoriteBtn = gameCard.querySelector('.favorite-button');
                if (favoriteBtn) {
                    favoriteBtn.classList.toggle('favorited', isFavorite);
                    favoriteBtn.textContent = isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
                }
            }

            filterGames() {
                const state = this.stateManager.getState();
                const { currentView, currentCategory, searchQuery, installedGames, favorites } = state;

                console.log('Filtering games:', { currentView, currentCategory, searchQuery });

                // Get all game cards
                const gameCards = this.gamesGrid ? this.gamesGrid.querySelectorAll('.game-card') : [];

                gameCards.forEach(card => {
                    const gameId = card.dataset.gameId;
                    const game = this.gameLibrary[gameId];

                    if (!game) {
                        card.style.display = 'none';
                        return;
                    }

                    let showCard = true;

                    // Filter by view (store/library)
                    if (currentView === 'library') {
                        // Only show installed games in library view
                        if (!installedGames.has(gameId)) {
                            showCard = false;
                        }
                    }

                    // Filter by category
                    if (showCard && currentCategory !== 'all') {
                        if (currentCategory === 'favorites') {
                            showCard = favorites.has(gameId);
                        } else if (game.category !== currentCategory) {
                            showCard = false;
                        }
                    }

                    // Filter by search query
                    if (showCard && searchQuery) {
                        const searchLower = searchQuery.toLowerCase();
                        const nameMatch = game.name.toLowerCase().includes(searchLower);
                        const descMatch = game.description && game.description.toLowerCase().includes(searchLower);
                        const categoryMatch = game.category && game.category.toLowerCase().includes(searchLower);

                        showCard = nameMatch || descMatch || categoryMatch;
                    }

                    card.style.display = showCard ? 'block' : 'none';
                });

                // Update view counts
                this.updateViewCounts();
            }

            updateViewCounts() {
                const visibleCards = this.gamesGrid ?
                    Array.from(this.gamesGrid.querySelectorAll('.game-card')).filter(card =>
                        card.style.display !== 'none'
                    ).length : 0;

                const countElement = document.getElementById('visible-games-count');
                if (countElement) {
                    countElement.textContent = `Showing ${visibleCards} games`;
                }
            }

            updateUI(state) {
                // Update all game cards based on current state
                const gameCards = this.gamesGrid ? this.gamesGrid.querySelectorAll('.game-card') : [];

                gameCards.forEach(card => {
                    const gameId = card.dataset.gameId;

                    // Update favorite status
                    const isFavorite = state.favorites.has(gameId);
                    this.updateFavoriteButton(gameId, isFavorite);

                    // Update installed status
                    const isInstalled = state.installedGames.has(gameId);
                    const installedBadge = card.querySelector('.installed-badge');
                    if (installedBadge) {
                        installedBadge.style.display = isInstalled ? 'block' : 'none';
                    }
                });

                // Re-filter games
                this.filterGames();
            }

            addToHistory(gameId) {
                const state = this.stateManager.getState();
                const history = state.gameHistory || [];

                // Remove if already in history
                const index = history.indexOf(gameId);
                if (index > -1) {
                    history.splice(index, 1);
                }

                // Add to beginning
                history.unshift(gameId);

                // Keep only last 10 games
                if (history.length > 10) {
                    history.pop();
                }

                this.stateManager.updateState({ gameHistory: history });
            }

            renderGameCard(game) {
                const state = this.stateManager.getState();
                const isFavorite = state.favorites.has(game.id);
                const isInstalled = state.installedGames.has(game.id);

                const card = document.createElement('div');
                card.className = 'game-card';
                card.dataset.gameId = game.id;

                card.innerHTML = `
                    <div class="game-icon">${game.icon || 'üéÆ'}</div>
                    <div class="game-info">
                        <h3 class="game-name">${game.name}</h3>
                        <p class="game-description">${game.description || ''}</p>
                        <div class="game-meta">
                            <span class="game-category">${game.category || 'Game'}</span>
                            ${game.rating ? `<span class="game-rating">‚≠ê ${game.rating}</span>` : ''}
                        </div>
                    </div>
                    <div class="game-actions">
                        <button class="play-button" title="Play">‚ñ∂Ô∏è Play</button>
                        <button class="favorite-button ${isFavorite ? 'favorited' : ''}" title="Favorite">
                            ${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}
                        </button>
                    </div>
                    ${isInstalled ? '<span class="installed-badge">Installed</span>' : ''}
                `;

                return card;
            }

            renderAllGames() {
                if (!this.gamesGrid) return;

                this.gamesGrid.innerHTML = '';

                Object.values(this.gameLibrary).forEach(game => {
                    const card = this.renderGameCard(game);
                    this.gamesGrid.appendChild(card);
                });

                this.filterGames();
            }

            // Public API methods
            addGame(game) {
                if (!game.id) {
                    throw new Error('Game must have an id');
                }

                this.gameLibrary[game.id] = game;
                this.renderAllGames();
            }

            removeGame(gameId) {
                delete this.gameLibrary[gameId];

                // Remove from state
                const state = this.stateManager.getState();
                state.installedGames.delete(gameId);
                state.favorites.delete(gameId);

                this.stateManager.updateState({
                    installedGames: state.installedGames,
                    favorites: state.favorites
                });

                this.renderAllGames();
            }

            getGameById(gameId) {
                return this.gameLibrary[gameId];
            }

            getAllGames() {
                return Object.values(this.gameLibrary);
            }

            getInstalledGames() {
                const state = this.stateManager.getState();
                return Array.from(state.installedGames)
                    .map(id => this.gameLibrary[id])
                    .filter(game => game);
            }

            getFavoriteGames() {
                const state = this.stateManager.getState();
                return Array.from(state.favorites)
                    .map(id => this.gameLibrary[id])
                    .filter(game => game);
            }

            destroy() {
                // Cleanup
                this.closeEmulator();
                this.closeModal();

                // Remove event listeners (if needed)
                this.stateManager.listeners.clear();
            }
        }
    </script>

    <script>
        // Demo: Initialize the system with sample games
        const sampleGames = {
            'snake-game': {
                id: 'snake-game',
                name: 'Snake Classic',
                description: 'Classic snake game where you eat apples and grow longer. Avoid hitting walls or yourself!',
                icon: 'üêç',
                category: 'arcade',
                rating: 4.5,
                plays: 1250,
                type: 'embedded',
                canvas: null,
                ctx: null,
                snake: null,
                food: null,
                direction: null,
                score: 0,
                gameOver: false,
                gridSize: 20,
                tileCount: 0,

                initialize: function(display) {
                    // Create game container
                    display.innerHTML = `
                        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#111;color:white;padding:20px;">
                            <h2 style="margin-bottom:20px;">üêç Snake Game</h2>
                            <div style="margin-bottom:15px;font-size:20px;">Score: <span id="snake-score">0</span></div>
                            <canvas id="snake-canvas" width="400" height="400" style="border:2px solid #4caf50;background:#000;"></canvas>
                            <div style="margin-top:20px;text-align:center;">
                                <p style="margin:10px 0;">Use Arrow Keys to Move</p>
                                <p style="margin:10px 0;color:#999;">Press Space to Restart</p>
                            </div>
                            <div id="game-over-message" style="display:none;margin-top:20px;font-size:24px;color:#ff4444;">
                                Game Over! Press Space to Restart
                            </div>
                        </div>
                    `;

                    this.canvas = document.getElementById('snake-canvas');
                    this.ctx = this.canvas.getContext('2d');
                    this.tileCount = this.canvas.width / this.gridSize;

                    // Initialize game state
                    this.resetGame();

                    // Handle keyboard input
                    this.keyHandler = (e) => {
                        if (e.code === 'ArrowUp' && this.direction !== 'down') {
                            this.direction = 'up';
                            e.preventDefault();
                        } else if (e.code === 'ArrowDown' && this.direction !== 'up') {
                            this.direction = 'down';
                            e.preventDefault();
                        } else if (e.code === 'ArrowLeft' && this.direction !== 'right') {
                            this.direction = 'left';
                            e.preventDefault();
                        } else if (e.code === 'ArrowRight' && this.direction !== 'left') {
                            this.direction = 'right';
                            e.preventDefault();
                        } else if (e.code === 'Space' && this.gameOver) {
                            this.resetGame();
                            e.preventDefault();
                        }
                    };

                    document.addEventListener('keydown', this.keyHandler);
                    console.log('Snake game initialized');
                },

                resetGame: function() {
                    this.snake = [
                        { x: 10, y: 10 },
                        { x: 9, y: 10 },
                        { x: 8, y: 10 }
                    ];
                    this.direction = 'right';
                    this.score = 0;
                    this.gameOver = false;
                    this.spawnFood();

                    const scoreEl = document.getElementById('snake-score');
                    if (scoreEl) scoreEl.textContent = '0';

                    const gameOverMsg = document.getElementById('game-over-message');
                    if (gameOverMsg) gameOverMsg.style.display = 'none';
                },

                spawnFood: function() {
                    this.food = {
                        x: Math.floor(Math.random() * this.tileCount),
                        y: Math.floor(Math.random() * this.tileCount)
                    };

                    // Make sure food doesn't spawn on snake
                    const onSnake = this.snake.some(segment =>
                        segment.x === this.food.x && segment.y === this.food.y
                    );

                    if (onSnake) {
                        this.spawnFood();
                    }
                },

                update: function() {
                    if (this.gameOver) return;

                    // Calculate new head position
                    const head = { ...this.snake[0] };

                    switch (this.direction) {
                        case 'up': head.y--; break;
                        case 'down': head.y++; break;
                        case 'left': head.x--; break;
                        case 'right': head.x++; break;
                    }

                    // Check wall collision
                    if (head.x < 0 || head.x >= this.tileCount ||
                        head.y < 0 || head.y >= this.tileCount) {
                        this.endGame();
                        return;
                    }

                    // Check self collision
                    const hitSelf = this.snake.some(segment =>
                        segment.x === head.x && segment.y === head.y
                    );

                    if (hitSelf) {
                        this.endGame();
                        return;
                    }

                    // Add new head
                    this.snake.unshift(head);

                    // Check food collision
                    if (head.x === this.food.x && head.y === this.food.y) {
                        this.score++;
                        const scoreEl = document.getElementById('snake-score');
                        if (scoreEl) scoreEl.textContent = this.score;
                        this.spawnFood();
                    } else {
                        // Remove tail if no food eaten
                        this.snake.pop();
                    }
                },

                render: function() {
                    if (!this.ctx) return;

                    // Clear canvas
                    this.ctx.fillStyle = '#000';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                    // Draw snake
                    this.snake.forEach((segment, index) => {
                        this.ctx.fillStyle = index === 0 ? '#4caf50' : '#66bb6a';
                        this.ctx.fillRect(
                            segment.x * this.gridSize,
                            segment.y * this.gridSize,
                            this.gridSize - 2,
                            this.gridSize - 2
                        );
                    });

                    // Draw food
                    this.ctx.fillStyle = '#ff4444';
                    this.ctx.fillRect(
                        this.food.x * this.gridSize,
                        this.food.y * this.gridSize,
                        this.gridSize - 2,
                        this.gridSize - 2
                    );
                },

                endGame: function() {
                    this.gameOver = true;
                    const gameOverMsg = document.getElementById('game-over-message');
                    if (gameOverMsg) gameOverMsg.style.display = 'block';
                },

                cleanup: function() {
                    if (this.keyHandler) {
                        document.removeEventListener('keydown', this.keyHandler);
                    }
                }
            },
            'tetris': {
                id: 'tetris',
                name: 'Tetris',
                description: 'Stack falling blocks to create complete lines. Classic puzzle gameplay!',
                icon: 'üß±',
                category: 'puzzle',
                rating: 4.8,
                plays: 2100,
                type: 'embedded'
            },
            'pong': {
                id: 'pong',
                name: 'Pong',
                description: 'Classic two-player ping pong game. First to 5 points wins!',
                icon: 'üèì',
                category: 'sports',
                rating: 4.2,
                plays: 890,
                type: 'embedded'
            },
            'space-invaders': {
                id: 'space-invaders',
                name: 'Space Invaders',
                description: 'Defend Earth from waves of alien invaders. Shoot them all!',
                icon: 'üëæ',
                category: 'action',
                rating: 4.6,
                plays: 1500,
                type: 'embedded'
            },
            'pac-man': {
                id: 'pac-man',
                name: 'Pac-Man',
                description: 'Eat all the dots while avoiding ghosts in this maze classic.',
                icon: 'üëª',
                category: 'arcade',
                rating: 4.7,
                plays: 1800,
                type: 'embedded'
            },
            'breakout': {
                id: 'breakout',
                name: 'Breakout',
                description: 'Break all the bricks with your paddle and ball. Classic arcade action!',
                icon: 'üß±',
                category: 'arcade',
                rating: 4.4,
                plays: 1100,
                type: 'embedded'
            },
            'mario-clone': {
                id: 'mario-clone',
                name: 'Platform Adventure',
                description: 'Jump and run through levels collecting coins and avoiding enemies.',
                icon: 'üçÑ',
                category: 'action',
                rating: 4.9,
                plays: 2500,
                type: 'embedded'
            },
            'chess': {
                id: 'chess',
                name: 'Chess',
                description: 'Classic strategy game. Checkmate your opponent to win!',
                icon: '‚ôüÔ∏è',
                category: 'puzzle',
                rating: 4.7,
                plays: 950,
                type: 'embedded'
            }
        };

        // Initialize StateManager and GameManager
        const stateManager = new StateManager();
        const gameManager = new GameManager(stateManager, sampleGames);

        // Render all games
        gameManager.renderAllGames();

        // Demo: Add some pre-installed games and favorites
        setTimeout(() => {
            console.log('Auto-installing some demo games...');
            stateManager.state.installedGames.add('snake-game');
            stateManager.state.installedGames.add('tetris');
            stateManager.state.favorites.add('snake-game');
            stateManager.saveState();
            gameManager.updateUI(stateManager.getState());
        }, 1000);

        // Log state changes for debugging
        stateManager.subscribe('stateChanged', (state) => {
            console.log('State changed:', {
                view: state.currentView,
                category: state.currentCategory,
                search: state.searchQuery,
                installedCount: state.installedGames.size,
                favoritesCount: state.favorites.size
            });
        });

        // Demo: Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                gameManager.closeEmulator();
                gameManager.closeModal();
            }
        });

        console.log('Game Manager Demo initialized successfully!');
        console.log('Available methods:', {
            addGame: 'gameManager.addGame(game)',
            removeGame: 'gameManager.removeGame(gameId)',
            launchGame: 'gameManager.launchGame(gameId)',
            getInstalledGames: 'gameManager.getInstalledGames()',
            getFavoriteGames: 'gameManager.getFavoriteGames()'
        });
    </script>
</body>
</html>
