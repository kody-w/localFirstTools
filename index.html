<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Local First Tools</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LocalFirst">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <meta name="description" content="Privacy-first, offline-capable tools that work entirely in your browser.">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-hover: #1a1a1a;
            --border: rgba(255,255,255,0.08);
            --text: #fff;
            --text-dim: #888;
            --accent: #8338ec;
            --accent2: #06ffa5;
            --cat-games: #f59e0b;
            --cat-ai-tools: #8b5cf6;
            --cat-development: #10b981;
            --cat-education: #06b6d4;
            --cat-productivity: #3b82f6;
            --cat-quantum-worlds: #14b8a6;
            --cat-business: #64748b;
            --cat-media: #ec4899;
            --cat-utilities: #6b7280;
            --cat-health: #ef4444;
            --cat-index-variants: #a855f7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Top bar */
        .top-bar {
            padding: 12px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .logo {
            font-weight: 700;
            font-size: 13px;
            color: var(--text-dim);
            white-space: nowrap;
            cursor: pointer;
            transition: color 0.2s;
        }
        .logo:hover { color: var(--text); }

        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 500px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 0 3px rgba(131,56,236,0.15);
        }

        .search-input::placeholder { color: var(--text-dim); }

        .categories {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            flex: 1;
        }
        .categories::-webkit-scrollbar { display: none; }

        .cat-btn {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cat-btn:hover { border-color: var(--accent); color: var(--text); }
        .cat-btn:active { transform: scale(0.96); }
        .cat-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        .cat-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

        .cat-count {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .cat-btn.active .cat-count { background: rgba(0,0,0,0.2); }

        /* Controls group */
        .controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ctrl-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s;
        }
        .ctrl-btn:hover { border-color: var(--accent); color: var(--text); background: var(--surface-hover); }
        .ctrl-btn:active { transform: scale(0.92); }
        .ctrl-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        .ctrl-btn.active { background: rgba(131,56,236,0.2); border-color: var(--accent); color: var(--accent); }

        .sort-select {
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
        }
        .sort-select:focus { outline: none; border-color: var(--accent); }

        /* Main area */
        .main-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        /* Recent section */
        .recent-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .recent-clear {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .recent-clear:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .recent-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 4px;
        }
        .recent-scroll::-webkit-scrollbar { display: none; }
        .recent-card {
            flex-shrink: 0;
            width: 100px;
            padding: 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-decoration: none;
            color: inherit;
            text-align: center;
            transition: all 0.15s;
        }
        .recent-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .recent-card:active { transform: scale(0.96); }
        .recent-icon { font-size: 20px; margin-bottom: 4px; }
        .recent-title { font-size: 10px; color: var(--text-dim); line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Result count */
        .result-info {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid/List views */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .tools-grid.list-view {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tool-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            min-height: 90px;
            position: relative;
        }
        .tool-card:hover {
            border-color: var(--accent);
            background: var(--surface-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .tool-card:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .tool-card:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        /* List view card */
        .tools-grid.list-view .tool-card {
            flex-direction: row;
            align-items: center;
            min-height: 44px;
            padding: 8px 12px;
            gap: 12px;
        }
        .tools-grid.list-view .tool-icon { font-size: 18px; margin: 0; }
        .tools-grid.list-view .tool-title { flex: 0 0 200px; margin: 0; font-size: 13px; }
        .tools-grid.list-view .tool-desc { flex: 1; margin: 0; -webkit-line-clamp: 1; white-space: nowrap; }
        .tools-grid.list-view .tool-category { margin: 0; }
        .tools-grid.list-view .tool-pin { position: static; opacity: 0.5; }
        .tools-grid.list-view .tool-card:hover .tool-pin { opacity: 1; }

        .tool-icon { font-size: 22px; margin-bottom: 6px; }
        .tool-title { font-size: 12px; font-weight: 500; margin-bottom: 4px; line-height: 1.3; }
        .tool-desc {
            font-size: 10px;
            color: var(--text-dim);
            line-height: 1.4;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .tool-category {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-dim);
            margin-top: 6px;
            align-self: flex-start;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: rgba(255,255,255,0.06);
        }

        /* Category colors */
        .tool-category[data-cat="games"] { background: rgba(245,158,11,0.15); color: var(--cat-games); }
        .tool-category[data-cat="ai-tools"] { background: rgba(139,92,246,0.15); color: var(--cat-ai-tools); }
        .tool-category[data-cat="development"] { background: rgba(16,185,129,0.15); color: var(--cat-development); }
        .tool-category[data-cat="education"] { background: rgba(6,182,212,0.15); color: var(--cat-education); }
        .tool-category[data-cat="productivity"] { background: rgba(59,130,246,0.15); color: var(--cat-productivity); }
        .tool-category[data-cat="quantum-worlds"] { background: rgba(20,184,166,0.15); color: var(--cat-quantum-worlds); }
        .tool-category[data-cat="business"] { background: rgba(100,116,139,0.15); color: var(--cat-business); }
        .tool-category[data-cat="media"] { background: rgba(236,72,153,0.15); color: var(--cat-media); }
        .tool-category[data-cat="utilities"] { background: rgba(107,114,128,0.15); color: var(--cat-utilities); }
        .tool-category[data-cat="health"] { background: rgba(239,68,68,0.15); color: var(--cat-health); }
        .tool-category[data-cat="index-variants"] { background: rgba(168,85,247,0.15); color: var(--cat-index-variants); }

        .tool-featured {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 12px;
            color: var(--cat-games);
        }

        .tool-pin {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.15s;
        }
        .tool-card:hover .tool-pin { opacity: 1; }
        .tool-pin:hover { background: var(--accent); color: #fff; }
        .tool-pin:active { transform: scale(0.9); }
        .tool-pin.pinned { opacity: 1; background: #ff006e; color: #fff; }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--surface) 25%, rgba(255,255,255,0.08) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-card { min-height: 90px; }

        .no-results { text-align: center; padding: 40px 20px; color: var(--text-dim); }

        /* Command palette */
        .cmd-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
        }
        .cmd-overlay.active { opacity: 1; visibility: visible; }

        .cmd-palette {
            width: 90%;
            max-width: 550px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            transform: scale(0.95) translateY(-10px);
            transition: transform 0.2s;
        }
        .cmd-overlay.active .cmd-palette { transform: scale(1) translateY(0); }

        .cmd-input-wrap { padding: 12px; border-bottom: 1px solid var(--border); }
        .cmd-input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 15px;
        }
        .cmd-input:focus { outline: none; border-color: var(--accent); }
        .cmd-input::placeholder { color: var(--text-dim); }

        .cmd-results { max-height: 350px; overflow-y: auto; }
        .cmd-item {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }
        .cmd-item:hover, .cmd-item.selected { background: rgba(131,56,236,0.15); }
        .cmd-item:active { background: rgba(131,56,236,0.25); }
        .cmd-item-icon { font-size: 18px; }
        .cmd-item-info { flex: 1; }
        .cmd-item-title { font-size: 13px; font-weight: 500; }
        .cmd-item-path { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        .cmd-item-cat { font-size: 9px; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-dim); }
        .cmd-hint { padding: 10px 14px; font-size: 10px; color: var(--text-dim); display: flex; gap: 12px; border-top: 1px solid var(--border); }
        .cmd-hint kbd { padding: 2px 5px; background: rgba(255,255,255,0.1); border-radius: 3px; font-family: monospace; }

        /* Settings */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
        }
        .settings-overlay.active { opacity: 1; visibility: visible; }

        .settings-panel {
            width: 90%;
            max-width: 360px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .settings-overlay.active .settings-panel { transform: scale(1); }

        .settings-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
        .settings-close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 4px; border-radius: 4px; }
        .settings-close:hover { background: rgba(255,255,255,0.1); }
        .settings-section { margin-bottom: 16px; }
        .settings-label { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .settings-btns { display: flex; gap: 8px; }
        .settings-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .settings-btn:hover { border-color: var(--accent); background: var(--surface-hover); }
        .settings-btn:active { transform: scale(0.97); }

        /* More menu */
        .more-menu-wrap { position: relative; }
        .more-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 6px;
            min-width: 180px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 0;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.15s;
        }
        .more-menu.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .more-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 14px;
            background: none;
            border: none;
            color: var(--text);
            font-size: 13px;
            text-align: left;
            cursor: pointer;
            transition: background 0.1s;
        }
        .more-item:hover { background: rgba(131,56,236,0.15); }
        .more-item:active { background: rgba(131,56,236,0.25); }
        .more-item span { font-size: 16px; width: 20px; text-align: center; }
        .more-divider { border: none; border-top: 1px solid var(--border); margin: 6px 0; }

        /* 3D Gallery Container */
        #threeContainer {
            position: fixed;
            inset: 0;
            z-index: 500;
            background: #000;
            display: none;
        }
        #threeContainer.active { display: block; }
        .three-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 501;
            display: flex;
            gap: 10px;
        }
        .three-btn {
            padding: 10px 20px;
            background: rgba(131,56,236,0.8);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }
        .three-btn:hover { background: rgba(131,56,236,1); transform: translateY(-2px); }
        .three-hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            z-index: 501;
        }

        /* Analytics Dashboard */
        .analytics-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
        }
        .analytics-overlay.active { opacity: 1; visibility: visible; }
        .analytics-panel {
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .analytics-overlay.active .analytics-panel { transform: scale(1); }
        .analytics-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        .analytics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
        .analytics-stat {
            background: rgba(131,56,236,0.1);
            border: 1px solid rgba(131,56,236,0.2);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .stat-number { font-size: 28px; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-top: 4px; }
        .chart-section { margin-top: 20px; }
        .chart-title { font-size: 13px; color: var(--text-dim); margin-bottom: 12px; }
        .chart-bars { display: flex; align-items: flex-end; gap: 8px; height: 120px; }
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--accent), var(--accent2));
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            position: relative;
        }
        .chart-bar-label { position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-dim); white-space: nowrap; }
        @media (max-width: 600px) { .analytics-grid { grid-template-columns: repeat(2, 1fr); } }

        /* Magazine View */
        .magazine-mode .tools-grid { display: none; }
        .magazine-content {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 40px;
            border: 1px solid var(--border);
        }
        .magazine-mode .magazine-content { display: block; }
        .magazine-header { text-align: center; margin-bottom: 40px; padding-bottom: 30px; border-bottom: 1px solid var(--border); }
        .magazine-issue { font-size: 11px; letter-spacing: 3px; color: var(--text-dim); margin-bottom: 12px; }
        .magazine-title { font-size: 3em; font-weight: 200; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .magazine-subtitle { margin-top: 12px; color: var(--text-dim); font-style: italic; }
        .mag-section { margin: 40px 0; }
        .mag-section-title { font-size: 1.8em; font-weight: 300; margin-bottom: 20px; color: var(--accent); }
        .mag-featured { padding: 20px; background: rgba(131,56,236,0.1); border-radius: 12px; margin-bottom: 16px; }
        .mag-featured-title { font-size: 1.4em; margin-bottom: 8px; }
        .mag-featured-desc { color: var(--text-dim); line-height: 1.7; margin-bottom: 12px; }
        .mag-featured-link { display: inline-block; padding: 10px 24px; background: var(--accent); color: #fff; text-decoration: none; border-radius: 6px; font-size: 13px; }
        .mag-featured-link:hover { opacity: 0.9; }
        .mag-tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .mag-tool-card { padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; text-decoration: none; color: inherit; transition: all 0.15s; }
        .mag-tool-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .mag-tool-title { font-size: 14px; font-weight: 500; margin-bottom: 6px; }
        .mag-tool-desc { font-size: 11px; color: var(--text-dim); }

        /* Keyboard Shortcuts Modal */
        .shortcuts-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
        }
        .shortcuts-overlay.active { opacity: 1; visibility: visible; }
        .shortcuts-panel {
            width: 90%;
            max-width: 500px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .shortcuts-overlay.active .shortcuts-panel { transform: scale(1); }
        .shortcuts-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        .shortcuts-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 16px; }
        .shortcut-key { padding: 4px 10px; background: rgba(131,56,236,0.15); border-radius: 4px; font-family: monospace; font-size: 12px; color: var(--accent); text-align: center; }
        .shortcut-desc { font-size: 13px; color: var(--text-dim); display: flex; align-items: center; }

        /* Preview Modal */
        .preview-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 800;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
        }
        .preview-overlay.active { opacity: 1; visibility: visible; }
        .preview-header {
            padding: 12px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .preview-title { font-size: 14px; font-weight: 500; }
        .preview-actions { display: flex; gap: 8px; }
        .preview-btn {
            padding: 8px 16px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        .preview-btn:hover { opacity: 0.9; }
        .preview-btn.secondary { background: rgba(255,255,255,0.1); }
        .preview-iframe { flex: 1; border: none; background: #fff; }

        /* Tour Overlay */
        .tour-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .tour-overlay.active { opacity: 1; visibility: visible; }
        .tour-tooltip {
            max-width: 400px;
            background: var(--surface);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(131,56,236,0.3);
        }
        .tour-progress { font-size: 11px; color: var(--accent); margin-bottom: 8px; }
        .tour-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
        .tour-text { font-size: 14px; color: var(--text-dim); line-height: 1.6; margin-bottom: 20px; }
        .tour-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .tour-btn {
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tour-btn:hover { border-color: var(--accent); }
        .tour-btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
        .tour-btn.primary:hover { opacity: 0.9; }
        .tour-highlight {
            position: relative;
            z-index: 901;
            box-shadow: 0 0 0 4px var(--accent), 0 0 20px rgba(131,56,236,0.5);
            border-radius: 8px;
        }

        /* Compare Mode */
        .compare-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
        }
        .compare-overlay.active { opacity: 1; visibility: visible; }
        .compare-panel {
            width: 95%;
            max-width: 1000px;
            max-height: 85vh;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .compare-overlay.active .compare-panel { transform: scale(1); }
        .compare-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .compare-title { font-size: 16px; font-weight: 600; }
        .compare-body { padding: 20px; overflow-y: auto; max-height: calc(85vh - 60px); }
        .compare-empty { text-align: center; padding: 40px; color: var(--text-dim); }
        .compare-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .compare-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .compare-card-icon { font-size: 32px; margin-bottom: 10px; }
        .compare-card-title { font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .compare-card-cat { font-size: 10px; padding: 3px 8px; background: rgba(131,56,236,0.15); border-radius: 4px; color: var(--accent); display: inline-block; margin-bottom: 10px; }
        .compare-card-desc { font-size: 11px; color: var(--text-dim); line-height: 1.5; margin-bottom: 12px; }
        .compare-card-link { display: inline-block; padding: 8px 16px; background: var(--accent); color: #fff; text-decoration: none; border-radius: 6px; font-size: 12px; }
        .compare-card-link:hover { opacity: 0.9; }

        /* Collections */
        .collections-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
        }
        .collections-overlay.active { opacity: 1; visibility: visible; }
        .collections-panel {
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .collections-overlay.active .collections-panel { transform: scale(1); }
        .collections-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .collections-body { padding: 20px; overflow-y: auto; max-height: calc(80vh - 120px); }
        .collection-item {
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .collection-item:hover { border-color: var(--accent); }
        .collection-name { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        .collection-count { font-size: 11px; color: var(--text-dim); }
        .collections-footer { padding: 16px 20px; border-top: 1px solid var(--border); }
        .collection-input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
        }
        .collection-input:focus { outline: none; border-color: var(--accent); }

        /* Light theme */
        body.light {
            --bg: #f5f5f5;
            --surface: #fff;
            --surface-hover: #fafafa;
            --border: rgba(0,0,0,0.08);
            --text: #111;
            --text-dim: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .top-bar { flex-wrap: wrap; padding: 10px; gap: 8px; }
            .logo { display: none; }
            .search-box { order: 1; flex: 100%; max-width: none; }
            .categories { order: 2; flex: 1; }
            .controls { order: 3; }
            .tools-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .recent-card { width: 80px; }
            .recent-title { font-size: 9px; }
        }

        @media (max-width: 480px) {
            .tools-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .tool-card { padding: 10px; min-height: 80px; }
            .tool-desc { display: none; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo" onclick="location.reload()">LOCAL FIRST</div>
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search tools..." autocomplete="off">
        </div>
        <div class="categories" id="categories"></div>
        <div class="controls">
            <select class="sort-select" id="sortSelect" title="Sort">
                <option value="name">A-Z</option>
                <option value="recent">Recent</option>
                <option value="popular">Popular</option>
            </select>
            <button class="ctrl-btn" id="viewToggle" title="Toggle view">‚ò∞</button>
            <button class="ctrl-btn" id="themeToggle" title="Toggle theme">üåô</button>
            <div class="more-menu-wrap">
                <button class="ctrl-btn" id="moreBtn" title="More options">‚ãØ</button>
                <div class="more-menu" id="moreMenu">
                    <button class="more-item" id="mode3D"><span>üéÆ</span> 3D Gallery</button>
                    <button class="more-item" id="modeAnalytics"><span>üìä</span> Analytics</button>
                    <button class="more-item" id="modeMagazine"><span>üìñ</span> Magazine View</button>
                    <button class="more-item" id="modeCompare"><span>‚öñÔ∏è</span> Compare Mode</button>
                    <button class="more-item" id="modeTour"><span>üéØ</span> Guided Tour</button>
                    <button class="more-item" id="modeCollections"><span>üìÅ</span> Collections</button>
                    <hr class="more-divider">
                    <button class="more-item" id="modeShortcuts"><span>‚å®Ô∏è</span> Keyboard Shortcuts</button>
                    <button class="more-item" id="settingsBtn"><span>‚öôÔ∏è</span> Settings</button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="recent-section" id="recentSection" style="display:none">
            <div class="recent-header">
                <span>Recent</span>
                <button class="recent-clear" onclick="clearRecent()">Clear</button>
            </div>
            <div class="recent-scroll" id="recentScroll"></div>
        </div>

        <div class="result-info" id="resultInfo">Loading...</div>

        <div class="tools-grid" id="toolsGrid">
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
        </div>
    </div>

    <div class="cmd-overlay" id="cmdOverlay">
        <div class="cmd-palette">
            <div class="cmd-input-wrap">
                <input type="text" class="cmd-input" id="cmdInput" placeholder="Search apps...">
            </div>
            <div class="cmd-results" id="cmdResults"></div>
            <div class="cmd-hint">
                <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
                <span><kbd>Enter</kbd> Open</span>
                <span><kbd>Esc</kbd> Close</span>
            </div>
        </div>
    </div>

    <!-- 3D Gallery Container -->
    <div id="threeContainer">
        <div class="three-ui">
            <button class="three-btn" id="backTo2D">‚Üê Back to Gallery</button>
        </div>
        <div class="three-hint">WASD to move ‚Ä¢ Mouse to look ‚Ä¢ Click artwork to open</div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="analytics-overlay" id="analyticsOverlay">
        <div class="analytics-panel">
            <div class="analytics-title">
                üìä Analytics Dashboard
                <button class="settings-close" onclick="closeAnalytics()">‚úï</button>
            </div>
            <div class="analytics-grid">
                <div class="analytics-stat"><div class="stat-number" id="statTotalOpens">0</div><div class="stat-label">Total Opens</div></div>
                <div class="analytics-stat"><div class="stat-number" id="statUniqueTools">0</div><div class="stat-label">Unique Tools</div></div>
                <div class="analytics-stat"><div class="stat-number" id="statPinned">0</div><div class="stat-label">Pinned</div></div>
                <div class="analytics-stat"><div class="stat-number" id="statCategories">0</div><div class="stat-label">Categories</div></div>
            </div>
            <div class="chart-section">
                <div class="chart-title">Top 10 Most Used Tools</div>
                <div class="chart-bars" id="topToolsChart"></div>
            </div>
            <div class="chart-section">
                <div class="chart-title">Usage by Category</div>
                <div class="chart-bars" id="categoryChart"></div>
            </div>
        </div>
    </div>

    <!-- Magazine Content -->
    <div class="magazine-content" id="magazineContent"></div>

    <!-- Keyboard Shortcuts -->
    <div class="shortcuts-overlay" id="shortcutsOverlay">
        <div class="shortcuts-panel">
            <div class="shortcuts-title">
                ‚å®Ô∏è Keyboard Shortcuts
                <button class="settings-close" onclick="closeShortcuts()">‚úï</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-key">/</div><div class="shortcut-desc">Focus search</div>
                <div class="shortcut-key">‚åòK</div><div class="shortcut-desc">Command palette</div>
                <div class="shortcut-key">Esc</div><div class="shortcut-desc">Close modals</div>
                <div class="shortcut-key">?</div><div class="shortcut-desc">Show shortcuts</div>
                <div class="shortcut-key">1-9</div><div class="shortcut-desc">Jump to category</div>
                <div class="shortcut-key">0</div><div class="shortcut-desc">Show all</div>
                <div class="shortcut-key">t</div><div class="shortcut-desc">Toggle theme</div>
                <div class="shortcut-key">g</div><div class="shortcut-desc">Toggle grid/list</div>
                <div class="shortcut-key">3</div><div class="shortcut-desc">3D Gallery</div>
                <div class="shortcut-key">a</div><div class="shortcut-desc">Analytics</div>
                <div class="shortcut-key">c</div><div class="shortcut-desc">Compare pinned</div>
                <div class="shortcut-key">Tab</div><div class="shortcut-desc">Navigate tools</div>
                <div class="shortcut-key">Enter</div><div class="shortcut-desc">Open tool</div>
                <div class="shortcut-key">‚áßEnter</div><div class="shortcut-desc">Preview tool</div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="preview-overlay" id="previewOverlay">
        <div class="preview-header">
            <div class="preview-title" id="previewTitle">Tool Preview</div>
            <div class="preview-actions">
                <button class="preview-btn" id="openFullBtn">Open Full</button>
                <button class="preview-btn secondary" onclick="closePreview()">Close (Esc)</button>
            </div>
        </div>
        <iframe class="preview-iframe" id="previewIframe"></iframe>
    </div>

    <!-- Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-tooltip">
            <div class="tour-progress" id="tourProgress">Step 1 of 6</div>
            <div class="tour-title" id="tourTitle">Welcome to Local First Tools!</div>
            <div class="tour-text" id="tourText">Discover 200+ privacy-first applications that work entirely offline in your browser.</div>
            <div class="tour-actions">
                <button class="tour-btn" id="tourSkip">Skip Tour</button>
                <button class="tour-btn primary" id="tourNext">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Compare Mode -->
    <div class="compare-overlay" id="compareOverlay">
        <div class="compare-panel">
            <div class="compare-header">
                <div class="compare-title">‚öñÔ∏è Compare Pinned Tools</div>
                <button class="settings-close" onclick="closeCompare()">‚úï</button>
            </div>
            <div class="compare-body" id="compareBody">
                <div class="compare-empty">Pin some tools to compare them side by side!</div>
            </div>
        </div>
    </div>

    <!-- Collections -->
    <div class="collections-overlay" id="collectionsOverlay">
        <div class="collections-panel">
            <div class="collections-header">
                <div class="compare-title">üìÅ Collections</div>
                <button class="settings-close" onclick="closeCollections()">‚úï</button>
            </div>
            <div class="collections-body" id="collectionsBody">
                <div class="collection-item" onclick="loadCollection('favorites')">
                    <div class="collection-name">‚≠ê Favorites</div>
                    <div class="collection-count" id="favCount">0 tools</div>
                </div>
                <div class="collection-item" onclick="loadCollection('workflow')">
                    <div class="collection-name">üîß My Workflow</div>
                    <div class="collection-count" id="workflowCount">0 tools</div>
                </div>
                <div class="collection-item" onclick="loadCollection('learning')">
                    <div class="collection-name">üìö Learning</div>
                    <div class="collection-count" id="learningCount">0 tools</div>
                </div>
            </div>
            <div class="collections-footer">
                <input type="text" class="collection-input" id="newCollectionInput" placeholder="Create new collection..." onkeydown="if(event.key==='Enter')createCollection()">
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-panel">
            <div class="settings-title">
                Settings
                <button class="settings-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="settings-section">
                <div class="settings-label">Data</div>
                <div class="settings-btns">
                    <button class="settings-btn" onclick="exportData()">Export</button>
                    <button class="settings-btn" onclick="document.getElementById('importFile').click()">Import</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
            <div class="settings-section">
                <div class="settings-label">Pinned (<span id="pinnedCount">0</span>)</div>
                <div id="pinnedList" style="font-size:11px;color:var(--text-dim);max-height:120px;overflow-y:auto">None</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let allTools = [];
        let filteredTools = [];
        let currentCategory = localStorage.getItem('lastCategory') || 'all';
        let currentSort = localStorage.getItem('preferredSort') || 'name';
        let currentView = localStorage.getItem('viewMode') || 'grid';
        let searchTerm = '';
        let pinnedTools = JSON.parse(localStorage.getItem('pinnedTools') || '[]');
        let usageData = JSON.parse(localStorage.getItem('toolUsage') || '{}');
        let cmdSelectedIndex = 0;
        let searchTimeout;

        const EMBEDDED_CONFIG = {"apps":[]};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            setupEventListeners();
            applyTheme();
            applyView();
            document.getElementById('sortSelect').value = currentSort;
        });

        // Load config
        async function loadConfig() {
            const isFileProtocol = window.location.protocol === 'file:';
            if (isFileProtocol && EMBEDDED_CONFIG.apps.length > 0) {
                processConfig(EMBEDDED_CONFIG);
                return;
            }
            try {
                const response = await fetch('./data/config/utility_apps_config.json');
                if (response.ok) {
                    const config = await response.json();
                    processConfig(config);
                    return;
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }
            if (EMBEDDED_CONFIG.apps.length > 0) processConfig(EMBEDDED_CONFIG);
        }

        // Process config
        function processConfig(config) {
            if (!config || !config.apps) return;

            allTools = config.apps.map(app => {
                const pathParts = app.path.split('/');
                const categoryKey = pathParts.length > 2 ? pathParts[2] : 'utilities';
                return {
                    id: app.id,
                    filename: app.path.split('/').pop(),
                    title: app.title,
                    path: app.path,
                    description: app.description || '',
                    tags: app.tags || [],
                    icon: app.icon || 'üîß',
                    category: categoryKey,
                    featured: app.tags?.includes('featured') || false
                };
            });

            buildCategories();
            renderRecent();
            filterAndDisplay();
        }

        // Build categories
        function buildCategories() {
            const container = document.getElementById('categories');
            const counts = {};
            allTools.forEach(t => { counts[t.category] = (counts[t.category] || 0) + 1; });

            let html = `<button class="cat-btn ${currentCategory === 'all' ? 'active' : ''}" data-cat="all">All <span class="cat-count">${allTools.length}</span></button>`;
            Object.entries(counts).sort((a, b) => b[1] - a[1]).forEach(([cat, count]) => {
                html += `<button class="cat-btn ${currentCategory === cat ? 'active' : ''}" data-cat="${cat}">${formatCat(cat)} <span class="cat-count">${count}</span></button>`;
            });
            container.innerHTML = html;
            container.querySelectorAll('.cat-btn').forEach(btn => {
                btn.onclick = () => selectCategory(btn.dataset.cat);
            });
        }

        function formatCat(cat) {
            return cat.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        function selectCategory(cat) {
            currentCategory = cat;
            localStorage.setItem('lastCategory', cat);
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-cat="${cat}"]`)?.classList.add('active');
            filterAndDisplay();
        }

        // Recent tools
        function renderRecent() {
            const recent = getRecentTools(8);
            const section = document.getElementById('recentSection');
            const scroll = document.getElementById('recentScroll');

            if (recent.length < 3) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            scroll.innerHTML = recent.map(t => `
                <a href="${t.path}" class="recent-card" onclick="trackUsage('${t.filename}')">
                    <div class="recent-icon">${t.icon}</div>
                    <div class="recent-title">${t.title}</div>
                </a>
            `).join('');
        }

        function getRecentTools(limit) {
            return allTools
                .filter(t => usageData[t.filename]?.lastUsed)
                .sort((a, b) => usageData[b.filename].lastUsed - usageData[a.filename].lastUsed)
                .slice(0, limit);
        }

        function clearRecent() {
            Object.keys(usageData).forEach(k => { usageData[k].lastUsed = 0; });
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
            renderRecent();
        }

        // Filter and display
        function filterAndDisplay() {
            filteredTools = [...allTools];

            if (currentCategory !== 'all') {
                filteredTools = filteredTools.filter(t => t.category === currentCategory);
            }

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredTools = filteredTools.filter(t =>
                    t.title.toLowerCase().includes(term) ||
                    t.description.toLowerCase().includes(term) ||
                    t.tags.some(tag => tag.toLowerCase().includes(term))
                );
            }

            sortTools();
            displayTools();
        }

        function sortTools() {
            switch (currentSort) {
                case 'name':
                    filteredTools.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'recent':
                    filteredTools.sort((a, b) => (usageData[b.filename]?.lastUsed || 0) - (usageData[a.filename]?.lastUsed || 0));
                    break;
                case 'popular':
                    filteredTools.sort((a, b) => (usageData[b.filename]?.count || 0) - (usageData[a.filename]?.count || 0));
                    break;
            }
            const pinned = filteredTools.filter(t => pinnedTools.includes(t.filename));
            const unpinned = filteredTools.filter(t => !pinnedTools.includes(t.filename));
            filteredTools = [...pinned, ...unpinned];
        }

        function displayTools() {
            const grid = document.getElementById('toolsGrid');
            const info = document.getElementById('resultInfo');

            if (filteredTools.length === 0) {
                grid.innerHTML = '<div class="no-results">No tools found</div>';
                info.textContent = '0 results';
                return;
            }

            info.textContent = `${filteredTools.length} tools`;

            grid.innerHTML = filteredTools.map(tool => `
                <a href="${tool.path}" class="tool-card" onclick="trackUsage('${tool.filename}')">
                    <div class="tool-icon">${tool.icon}</div>
                    ${tool.featured ? '<span class="tool-featured">‚òÖ</span>' : ''}
                    <button class="tool-pin ${pinnedTools.includes(tool.filename) ? 'pinned' : ''}"
                            onclick="event.preventDefault();event.stopPropagation();togglePin('${tool.filename}')">üìå</button>
                    <div class="tool-title">${tool.title}</div>
                    <div class="tool-desc">${tool.description}</div>
                    <div class="tool-category" data-cat="${tool.category}">${tool.category}</div>
                </a>
            `).join('');
        }

        function trackUsage(filename) {
            if (!usageData[filename]) usageData[filename] = { count: 0, lastUsed: 0 };
            usageData[filename].count++;
            usageData[filename].lastUsed = Date.now();
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
        }

        function togglePin(filename) {
            const idx = pinnedTools.indexOf(filename);
            if (idx > -1) pinnedTools.splice(idx, 1);
            else pinnedTools.push(filename);
            localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools));
            filterAndDisplay();
        }

        // Debounced search
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTerm = e.target.value;
                    filterAndDisplay();
                }, 150);
            });

            document.getElementById('sortSelect').addEventListener('change', (e) => {
                currentSort = e.target.value;
                localStorage.setItem('preferredSort', currentSort);
                filterAndDisplay();
            });

            document.addEventListener('keydown', (e) => {
                if ((e.key === '/' || (e.metaKey && e.key === 'k') || (e.ctrlKey && e.key === 'k')) && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    openCmd();
                }
                if (e.key === 'Escape') {
                    closeCmd();
                    closeSettings();
                    closeShortcuts();
                    closePreview();
                    closeTour();
                    closeCompare();
                    closeCollections();
                    closeAnalytics();
                    if (isMagazine) toggleMagazine();
                }
                if (document.getElementById('cmdOverlay').classList.contains('active')) {
                    if (e.key === 'ArrowDown') { e.preventDefault(); navCmd(1); }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); navCmd(-1); }
                    else if (e.key === 'Enter') { e.preventDefault(); selectCmd(); }
                }
            });

            document.getElementById('cmdInput').addEventListener('input', updateCmd);
            document.getElementById('cmdOverlay').addEventListener('click', (e) => { if (e.target.id === 'cmdOverlay') closeCmd(); });
            document.getElementById('settingsOverlay').addEventListener('click', (e) => { if (e.target.id === 'settingsOverlay') closeSettings(); });
            document.getElementById('settingsBtn').onclick = openSettings;
            document.getElementById('themeToggle').onclick = toggleTheme;
            document.getElementById('viewToggle').onclick = toggleView;
        }

        // Command palette
        function openCmd() {
            document.getElementById('cmdOverlay').classList.add('active');
            document.getElementById('cmdInput').value = '';
            document.getElementById('cmdInput').focus();
            cmdSelectedIndex = 0;
            updateCmd();
        }

        function closeCmd() { document.getElementById('cmdOverlay').classList.remove('active'); }

        function updateCmd() {
            const q = document.getElementById('cmdInput').value.toLowerCase();
            const results = document.getElementById('cmdResults');
            let matches = allTools;
            if (q) {
                matches = allTools.filter(t =>
                    t.title.toLowerCase().includes(q) ||
                    t.description.toLowerCase().includes(q) ||
                    t.category.toLowerCase().includes(q) ||
                    t.tags.some(tag => tag.toLowerCase().includes(q))
                );
            }
            matches = matches.slice(0, 10);
            cmdSelectedIndex = Math.min(cmdSelectedIndex, matches.length - 1);

            results.innerHTML = matches.map((t, i) => `
                <div class="cmd-item ${i === cmdSelectedIndex ? 'selected' : ''}" onclick="window.location.href='${t.path}'" data-index="${i}">
                    <span class="cmd-item-icon">${t.icon}</span>
                    <div class="cmd-item-info">
                        <div class="cmd-item-title">${t.title}</div>
                        <div class="cmd-item-path">${t.path}</div>
                    </div>
                    <span class="cmd-item-cat">${t.category}</span>
                </div>
            `).join('');
            results.dataset.matches = JSON.stringify(matches.map(t => t.path));
        }

        function navCmd(dir) {
            const items = document.querySelectorAll('.cmd-item');
            if (!items.length) return;
            cmdSelectedIndex = Math.max(0, Math.min(cmdSelectedIndex + dir, items.length - 1));
            items.forEach((item, i) => item.classList.toggle('selected', i === cmdSelectedIndex));
            items[cmdSelectedIndex].scrollIntoView({ block: 'nearest' });
        }

        function selectCmd() {
            const matches = JSON.parse(document.getElementById('cmdResults').dataset.matches || '[]');
            if (matches[cmdSelectedIndex]) window.location.href = matches[cmdSelectedIndex];
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('active');
            updatePinned();
        }

        function closeSettings() { document.getElementById('settingsOverlay').classList.remove('active'); }

        function updatePinned() {
            document.getElementById('pinnedCount').textContent = pinnedTools.length;
            const list = document.getElementById('pinnedList');
            if (pinnedTools.length === 0) { list.textContent = 'None'; return; }
            list.innerHTML = pinnedTools.map(f => {
                const t = allTools.find(x => x.filename === f);
                return t ? `<div style="margin:3px 0">${t.icon} ${t.title}</div>` : '';
            }).join('');
        }

        // Theme
        function toggleTheme() {
            document.body.classList.toggle('light');
            const isLight = document.body.classList.contains('light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('themeToggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        }

        function applyTheme() {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // View toggle
        function toggleView() {
            currentView = currentView === 'grid' ? 'list' : 'grid';
            localStorage.setItem('viewMode', currentView);
            applyView();
        }

        function applyView() {
            const grid = document.getElementById('toolsGrid');
            const btn = document.getElementById('viewToggle');
            grid.classList.toggle('list-view', currentView === 'list');
            btn.textContent = currentView === 'list' ? '‚ñ¶' : '‚ò∞';
            btn.classList.toggle('active', currentView === 'list');
        }

        // Export/Import
        function exportData() {
            const data = { pinnedTools, usageData };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `localfirst-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.pinnedTools) { pinnedTools = data.pinnedTools; localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools)); }
                    if (data.usageData) { usageData = data.usageData; localStorage.setItem('toolUsage', JSON.stringify(usageData)); }
                    filterAndDisplay();
                    renderRecent();
                    updatePinned();
                } catch (err) { alert('Invalid JSON'); }
            };
            reader.readAsText(file);
        }

        // More menu
        const moreBtn = document.getElementById('moreBtn');
        const moreMenu = document.getElementById('moreMenu');
        moreBtn.onclick = (e) => { e.stopPropagation(); moreMenu.classList.toggle('active'); };
        document.addEventListener('click', () => moreMenu.classList.remove('active'));
        moreMenu.onclick = (e) => e.stopPropagation();

        // Mode handlers
        document.getElementById('mode3D').onclick = () => { moreMenu.classList.remove('active'); open3DGallery(); };
        document.getElementById('modeAnalytics').onclick = () => { moreMenu.classList.remove('active'); openAnalytics(); };
        document.getElementById('modeMagazine').onclick = () => { moreMenu.classList.remove('active'); toggleMagazine(); };
        document.getElementById('modeCompare').onclick = () => { moreMenu.classList.remove('active'); openCompare(); };
        document.getElementById('modeTour').onclick = () => { moreMenu.classList.remove('active'); startTour(); };
        document.getElementById('modeCollections').onclick = () => { moreMenu.classList.remove('active'); openCollections(); };
        document.getElementById('modeShortcuts').onclick = () => { moreMenu.classList.remove('active'); openShortcuts(); };
        document.getElementById('settingsBtn').onclick = () => { moreMenu.classList.remove('active'); openSettings(); };

        // Analytics
        function openAnalytics() {
            const overlay = document.getElementById('analyticsOverlay');
            overlay.classList.add('active');

            // Calculate stats
            const totalOpens = Object.values(usageData).reduce((sum, d) => sum + (d.count || 0), 0);
            const uniqueTools = Object.keys(usageData).filter(k => usageData[k].count > 0).length;
            const categories = new Set(allTools.map(t => t.category));

            document.getElementById('statTotalOpens').textContent = totalOpens;
            document.getElementById('statUniqueTools').textContent = uniqueTools;
            document.getElementById('statPinned').textContent = pinnedTools.length;
            document.getElementById('statCategories').textContent = categories.size;

            // Top tools chart
            const topTools = Object.entries(usageData)
                .filter(([k, v]) => v.count > 0)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            const maxCount = topTools.length > 0 ? topTools[0][1].count : 1;
            const topChart = document.getElementById('topToolsChart');
            topChart.innerHTML = topTools.map(([filename, data]) => {
                const tool = allTools.find(t => t.filename === filename);
                const height = (data.count / maxCount) * 100;
                const name = tool ? tool.title.substring(0, 8) : filename.substring(0, 8);
                return `<div class="chart-bar" style="height:${height}%"><span class="chart-bar-label">${name}</span></div>`;
            }).join('') || '<div style="color:var(--text-dim);text-align:center;width:100%">No data yet</div>';

            // Category chart
            const catCounts = {};
            Object.entries(usageData).forEach(([filename, data]) => {
                const tool = allTools.find(t => t.filename === filename);
                if (tool && data.count > 0) {
                    catCounts[tool.category] = (catCounts[tool.category] || 0) + data.count;
                }
            });
            const catEntries = Object.entries(catCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
            const maxCat = catEntries.length > 0 ? catEntries[0][1] : 1;
            const catChart = document.getElementById('categoryChart');
            catChart.innerHTML = catEntries.map(([cat, count]) => {
                const height = (count / maxCat) * 100;
                return `<div class="chart-bar" style="height:${height}%"><span class="chart-bar-label">${cat.substring(0, 6)}</span></div>`;
            }).join('') || '<div style="color:var(--text-dim);text-align:center;width:100%">No data yet</div>';
        }

        function closeAnalytics() {
            document.getElementById('analyticsOverlay').classList.remove('active');
        }
        document.getElementById('analyticsOverlay').onclick = (e) => { if (e.target.id === 'analyticsOverlay') closeAnalytics(); };

        // Magazine view
        let isMagazine = false;
        function toggleMagazine() {
            isMagazine = !isMagazine;
            document.querySelector('.main-area').classList.toggle('magazine-mode', isMagazine);

            if (isMagazine) {
                renderMagazine();
            }
        }

        function renderMagazine() {
            const container = document.getElementById('magazineContent');
            const date = new Date();

            // Group by category
            const catGroups = {};
            filteredTools.forEach(t => {
                if (!catGroups[t.category]) catGroups[t.category] = [];
                catGroups[t.category].push(t);
            });

            let html = `
                <div class="magazine-header">
                    <div class="magazine-issue">ISSUE ${date.getMonth() + 1}.${date.getFullYear()}</div>
                    <div class="magazine-title">LOCAL FIRST TOOLS</div>
                    <div class="magazine-subtitle">A Curated Collection of ${allTools.length} Privacy-First Applications</div>
                </div>
            `;

            Object.entries(catGroups).slice(0, 5).forEach(([cat, tools]) => {
                const featured = tools[0];
                const others = tools.slice(1, 5);

                html += `
                    <div class="mag-section">
                        <div class="mag-section-title">${formatCat(cat)}</div>
                        <div class="mag-featured">
                            <div class="mag-featured-title">${featured.icon} ${featured.title}</div>
                            <div class="mag-featured-desc">${featured.description || 'Explore this powerful tool designed for privacy-first computing.'}</div>
                            <a href="${featured.path}" class="mag-featured-link" onclick="trackUsage('${featured.filename}')">Explore ‚Üí</a>
                        </div>
                        ${others.length > 0 ? `
                            <div class="mag-tools-grid">
                                ${others.map(t => `
                                    <a href="${t.path}" class="mag-tool-card" onclick="trackUsage('${t.filename}')">
                                        <div class="mag-tool-title">${t.icon} ${t.title}</div>
                                        <div class="mag-tool-desc">${(t.description || '').substring(0, 60)}...</div>
                                    </a>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += `
                <div style="text-align:center;padding:30px 0;color:var(--text-dim);font-size:12px;border-top:1px solid var(--border);margin-top:40px">
                    LOCAL FIRST TOOLS ‚Ä¢ Privacy-first. Offline-ready. Forever yours.<br>
                    ${allTools.length} applications ‚Ä¢ ${Object.keys(catGroups).length} categories ‚Ä¢ 100% local
                </div>
            `;

            container.innerHTML = html;
        }

        // Keyboard Shortcuts
        function openShortcuts() {
            document.getElementById('shortcutsOverlay').classList.add('active');
        }
        function closeShortcuts() {
            document.getElementById('shortcutsOverlay').classList.remove('active');
        }
        document.getElementById('shortcutsOverlay').onclick = (e) => { if (e.target.id === 'shortcutsOverlay') closeShortcuts(); };

        // Preview Modal
        let currentPreviewUrl = '';
        function openPreview(tool) {
            currentPreviewUrl = tool.path;
            document.getElementById('previewTitle').textContent = tool.title;
            document.getElementById('previewIframe').src = tool.path;
            document.getElementById('previewOverlay').classList.add('active');
        }
        function closePreview() {
            document.getElementById('previewOverlay').classList.remove('active');
            document.getElementById('previewIframe').src = '';
        }
        document.getElementById('openFullBtn').onclick = () => {
            if (currentPreviewUrl) window.location.href = currentPreviewUrl;
        };

        // Guided Tour
        const tourSteps = [
            { title: 'Welcome to Local First Tools!', text: 'Discover 200+ privacy-first applications that work entirely offline in your browser. All your data stays on your device.' },
            { title: 'Quick Search', text: 'Use the search bar to instantly find any tool. Press "/" to focus it from anywhere, or ‚åòK for the command palette.' },
            { title: 'Categories', text: 'Filter by category to explore tools organized by type: Games, AI Tools, Productivity, Development, and more.' },
            { title: 'Pin Your Favorites', text: 'Click the pin icon on any tool card to keep it at the top. Pinned tools appear first in your list.' },
            { title: 'Multiple Views', text: 'Switch between grid and list view. Try the 3D Gallery for an immersive experience, or Magazine View for editorial style browsing.' },
            { title: 'Your Data, Your Control', text: 'Export all your preferences and usage data anytime. Import it on any device. Everything is stored locally - no accounts needed!' }
        ];
        let tourStep = 0;

        function startTour() {
            tourStep = 0;
            updateTour();
            document.getElementById('tourOverlay').classList.add('active');
        }

        function updateTour() {
            const step = tourSteps[tourStep];
            document.getElementById('tourProgress').textContent = `Step ${tourStep + 1} of ${tourSteps.length}`;
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourText').textContent = step.text;
            document.getElementById('tourNext').textContent = tourStep === tourSteps.length - 1 ? 'Finish' : 'Next ‚Üí';
        }

        function closeTour() {
            document.getElementById('tourOverlay').classList.remove('active');
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
        }

        document.getElementById('tourSkip').onclick = closeTour;
        document.getElementById('tourNext').onclick = () => {
            tourStep++;
            if (tourStep >= tourSteps.length) {
                closeTour();
            } else {
                updateTour();
            }
        };

        // Compare Mode
        function openCompare() {
            const body = document.getElementById('compareBody');
            const pinned = pinnedTools.map(f => allTools.find(t => t.filename === f)).filter(Boolean);

            if (pinned.length === 0) {
                body.innerHTML = '<div class="compare-empty">Pin some tools to compare them side by side!<br><br>Click the üìå icon on any tool card to pin it.</div>';
            } else {
                body.innerHTML = `<div class="compare-grid">${pinned.map(t => `
                    <div class="compare-card">
                        <div class="compare-card-icon">${t.icon}</div>
                        <div class="compare-card-title">${t.title}</div>
                        <div class="compare-card-cat">${t.category}</div>
                        <div class="compare-card-desc">${t.description || 'No description available.'}</div>
                        <a href="${t.path}" class="compare-card-link" onclick="trackUsage('${t.filename}')">Open</a>
                    </div>
                `).join('')}</div>`;
            }
            document.getElementById('compareOverlay').classList.add('active');
        }
        function closeCompare() {
            document.getElementById('compareOverlay').classList.remove('active');
        }
        document.getElementById('compareOverlay').onclick = (e) => { if (e.target.id === 'compareOverlay') closeCompare(); };

        // Collections
        let collections = JSON.parse(localStorage.getItem('toolCollections') || '{"favorites":[],"workflow":[],"learning":[]}');

        function openCollections() {
            updateCollectionCounts();
            document.getElementById('collectionsOverlay').classList.add('active');
        }
        function closeCollections() {
            document.getElementById('collectionsOverlay').classList.remove('active');
        }
        document.getElementById('collectionsOverlay').onclick = (e) => { if (e.target.id === 'collectionsOverlay') closeCollections(); };

        function updateCollectionCounts() {
            document.getElementById('favCount').textContent = `${collections.favorites?.length || 0} tools`;
            document.getElementById('workflowCount').textContent = `${collections.workflow?.length || 0} tools`;
            document.getElementById('learningCount').textContent = `${collections.learning?.length || 0} tools`;
        }

        function loadCollection(name) {
            const tools = collections[name] || [];
            if (tools.length === 0) {
                alert(`No tools in "${name}" collection yet. Pin tools and add them to collections from the context menu!`);
                return;
            }
            closeCollections();
            // Filter to show only collection tools
            searchTerm = '';
            document.getElementById('searchInput').value = '';
            filteredTools = allTools.filter(t => tools.includes(t.filename));
            displayTools();
            document.getElementById('resultInfo').textContent = `${filteredTools.length} tools in "${name}"`;
        }

        function createCollection() {
            const input = document.getElementById('newCollectionInput');
            const name = input.value.trim().toLowerCase().replace(/\s+/g, '-');
            if (name && !collections[name]) {
                collections[name] = [];
                localStorage.setItem('toolCollections', JSON.stringify(collections));
                input.value = '';
                // Add new collection item to UI
                const body = document.getElementById('collectionsBody');
                const item = document.createElement('div');
                item.className = 'collection-item';
                item.onclick = () => loadCollection(name);
                item.innerHTML = `<div class="collection-name">üìÇ ${name}</div><div class="collection-count">0 tools</div>`;
                body.appendChild(item);
            }
        }

        // Extended keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT') return;

            switch(e.key) {
                case '?':
                    e.preventDefault();
                    openShortcuts();
                    break;
                case 't':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case 'g':
                    e.preventDefault();
                    toggleView();
                    break;
                case 'a':
                    e.preventDefault();
                    openAnalytics();
                    break;
                case 'c':
                    e.preventDefault();
                    openCompare();
                    break;
                case '0':
                    e.preventDefault();
                    selectCategory('all');
                    break;
            }

            // Number keys for categories
            if (e.key >= '1' && e.key <= '9') {
                const cats = document.querySelectorAll('.cat-btn:not([data-cat="all"])');
                const idx = parseInt(e.key) - 1;
                if (cats[idx]) {
                    e.preventDefault();
                    cats[idx].click();
                }
            }
        });
    </script>

    <!-- Three.js Library (loaded on demand) -->
    <script>
        // 3D Gallery - loads Three.js only when needed
        let threeLoaded = false;
        let threeScene = null;

        function open3DGallery() {
            if (!threeLoaded) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
                script.onload = () => {
                    threeLoaded = true;
                    init3DGallery();
                };
                document.head.appendChild(script);
            } else {
                init3DGallery();
            }
        }

        function init3DGallery() {
            const container = document.getElementById('threeContainer');
            container.classList.add('active');

            if (threeScene) {
                threeScene.cleanup();
            }

            const files = filteredTools.slice(0, 24).map(t => ({
                path: t.path,
                title: t.title,
                description: t.description,
                icon: t.icon
            }));

            threeScene = new Gallery3D(files, container);
            threeScene.init();
        }

        function close3DGallery() {
            const container = document.getElementById('threeContainer');
            container.classList.remove('active');
            if (threeScene) {
                threeScene.cleanup();
                threeScene = null;
            }
        }

        document.getElementById('backTo2D').onclick = close3DGallery;

        // 3D Gallery Class
        class Gallery3D {
            constructor(files, container) {
                this.files = files;
                this.container = container;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.artworks = [];
                this.raycaster = new THREE.Raycaster();
                this.moveSpeed = 0.15;
                this.lookSpeed = 0.002;
                this.keys = { w: false, a: false, s: false, d: false };
                this.rotation = { x: 0, y: 0 };
                this.isPointerLocked = false;
                this.animationId = null;
            }

            init() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.Fog(0x0a0a0a, 10, 80);

                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 500);
                this.camera.position.set(0, 2, 8);

                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.container.appendChild(this.renderer.domElement);

                this.setupLighting();
                this.createEnvironment();
                this.createArtworks();
                this.setupControls();
                this.animate();
            }

            setupLighting() {
                this.scene.add(new THREE.AmbientLight(0x404040, 0.4));
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
                dirLight.position.set(10, 20, 10);
                dirLight.castShadow = true;
                this.scene.add(dirLight);

                [0x8338ec, 0x06ffa5, 0xff006e].forEach((color, i) => {
                    const light = new THREE.PointLight(color, 0.4, 15);
                    light.position.set(i * 12 - 12, 4, 0);
                    this.scene.add(light);
                });
            }

            createEnvironment() {
                // Floor
                const floor = new THREE.Mesh(
                    new THREE.PlaneGeometry(100, 100),
                    new THREE.MeshLambertMaterial({ color: 0x141414 })
                );
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                this.scene.add(floor);

                // Walls
                const wallMat = new THREE.MeshLambertMaterial({ color: 0x1a1a1a });
                const backWall = new THREE.Mesh(new THREE.BoxGeometry(100, 20, 0.5), wallMat);
                backWall.position.set(0, 10, -40);
                this.scene.add(backWall);

                // Pillars
                for (let i = 0; i < 6; i++) {
                    const pillar = new THREE.Mesh(
                        new THREE.BoxGeometry(1.5, 12, 1.5),
                        new THREE.MeshLambertMaterial({ color: 0x222222 })
                    );
                    const angle = (i / 6) * Math.PI * 2;
                    pillar.position.set(Math.cos(angle) * 25, 6, Math.sin(angle) * 25);
                    pillar.castShadow = true;
                    this.scene.add(pillar);
                }

                // Floating particles
                for (let i = 0; i < 30; i++) {
                    const size = Math.random() * 0.3 + 0.1;
                    const cube = new THREE.Mesh(
                        new THREE.BoxGeometry(size, size, size),
                        new THREE.MeshBasicMaterial({
                            color: new THREE.Color().setHSL(Math.random(), 0.8, 0.5),
                            transparent: true,
                            opacity: 0.6
                        })
                    );
                    cube.position.set(
                        (Math.random() - 0.5) * 50,
                        Math.random() * 15 + 5,
                        (Math.random() - 0.5) * 50
                    );
                    cube.userData.floatSpeed = Math.random() * 0.02 + 0.01;
                    cube.userData.rotSpeed = Math.random() * 0.02;
                    this.scene.add(cube);
                }
            }

            createTextSprite(text, size = 0.4) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.height = 256;
                ctx.font = `${256 * size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'white';
                ctx.fillText(text, 128, 128);
                const texture = new THREE.CanvasTexture(canvas);
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
                sprite.scale.set(2, 2, 1);
                return sprite;
            }

            createArtworks() {
                const numArtworks = Math.min(this.files.length, 24);
                for (let i = 0; i < numArtworks; i++) {
                    const file = this.files[i];
                    const group = new THREE.Group();

                    // Frame
                    const frame = new THREE.Mesh(
                        new THREE.BoxGeometry(3.5, 2.8, 0.15),
                        new THREE.MeshLambertMaterial({ color: 0x333333 })
                    );

                    // Canvas with color
                    const hue = i / numArtworks;
                    const canvas = new THREE.Mesh(
                        new THREE.BoxGeometry(3.2, 2.5, 0.08),
                        new THREE.MeshLambertMaterial({
                            color: new THREE.Color().setHSL(hue, 0.6, 0.4),
                            emissive: new THREE.Color().setHSL(hue, 0.6, 0.2),
                            emissiveIntensity: 0.4
                        })
                    );
                    canvas.position.z = 0.08;
                    frame.add(canvas);

                    // Icon
                    const icon = this.createTextSprite(file.icon || 'üîß', 0.35);
                    icon.position.z = 0.15;
                    canvas.add(icon);

                    // Title
                    const title = this.createTextSprite(file.title.substring(0, 12), 0.12);
                    title.position.y = -1.8;
                    title.position.z = 0.3;
                    frame.add(title);

                    group.add(frame);

                    // Position in circle
                    const angle = (i / numArtworks) * Math.PI * 2;
                    const radius = 18;
                    group.position.x = Math.cos(angle) * radius;
                    group.position.z = Math.sin(angle) * radius;
                    group.position.y = 2.5;
                    group.rotation.y = -angle + Math.PI;

                    frame.userData = { url: file.path, title: file.title };
                    frame.castShadow = true;

                    this.artworks.push(frame);
                    this.scene.add(group);
                }
            }

            setupControls() {
                this.keydownHandler = (e) => {
                    if (e.key.toLowerCase() in this.keys) this.keys[e.key.toLowerCase()] = true;
                    if (e.key === 'Escape') close3DGallery();
                };
                this.keyupHandler = (e) => {
                    if (e.key.toLowerCase() in this.keys) this.keys[e.key.toLowerCase()] = false;
                };
                this.clickHandler = () => {
                    if (!this.isPointerLocked) {
                        this.renderer.domElement.requestPointerLock();
                    } else {
                        this.raycaster.setFromCamera(new THREE.Vector2(0, 0), this.camera);
                        const intersects = this.raycaster.intersectObjects(this.artworks, true);
                        if (intersects.length > 0) {
                            let obj = intersects[0].object;
                            while (obj && !obj.userData?.url) obj = obj.parent;
                            if (obj?.userData?.url) {
                                trackUsage(obj.userData.url.split('/').pop());
                                window.open(obj.userData.url, '_blank');
                            }
                        }
                    }
                };
                this.lockHandler = () => {
                    this.isPointerLocked = document.pointerLockElement === this.renderer.domElement;
                };
                this.moveHandler = (e) => {
                    if (this.isPointerLocked) {
                        this.rotation.y -= e.movementX * this.lookSpeed;
                        this.rotation.x -= e.movementY * this.lookSpeed;
                        this.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, this.rotation.x));
                    }
                };
                this.resizeHandler = () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                };

                window.addEventListener('keydown', this.keydownHandler);
                window.addEventListener('keyup', this.keyupHandler);
                this.renderer.domElement.addEventListener('click', this.clickHandler);
                document.addEventListener('pointerlockchange', this.lockHandler);
                document.addEventListener('mousemove', this.moveHandler);
                window.addEventListener('resize', this.resizeHandler);
            }

            updateMovement() {
                const forward = new THREE.Vector3();
                const right = new THREE.Vector3();
                this.camera.getWorldDirection(forward);
                forward.y = 0;
                forward.normalize();
                right.crossVectors(forward, new THREE.Vector3(0, 1, 0));

                if (this.keys.w) this.camera.position.add(forward.clone().multiplyScalar(this.moveSpeed));
                if (this.keys.s) this.camera.position.add(forward.clone().multiplyScalar(-this.moveSpeed));
                if (this.keys.a) this.camera.position.add(right.clone().multiplyScalar(-this.moveSpeed));
                if (this.keys.d) this.camera.position.add(right.clone().multiplyScalar(this.moveSpeed));

                this.camera.rotation.order = 'YXZ';
                this.camera.rotation.y = this.rotation.y;
                this.camera.rotation.x = this.rotation.x;
            }

            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
                this.updateMovement();

                // Animate floating cubes
                this.scene.children.forEach(child => {
                    if (child.userData.floatSpeed) {
                        child.position.y += Math.sin(Date.now() * child.userData.floatSpeed) * 0.005;
                        child.rotation.x += child.userData.rotSpeed || 0;
                        child.rotation.y += (child.userData.rotSpeed || 0) * 0.7;
                    }
                });

                this.renderer.render(this.scene, this.camera);
            }

            cleanup() {
                if (this.animationId) cancelAnimationFrame(this.animationId);
                window.removeEventListener('keydown', this.keydownHandler);
                window.removeEventListener('keyup', this.keyupHandler);
                this.renderer.domElement.removeEventListener('click', this.clickHandler);
                document.removeEventListener('pointerlockchange', this.lockHandler);
                document.removeEventListener('mousemove', this.moveHandler);
                window.removeEventListener('resize', this.resizeHandler);
                if (document.pointerLockElement) document.exitPointerLock();
                if (this.renderer?.domElement && this.container.contains(this.renderer.domElement)) {
                    this.container.removeChild(this.renderer.domElement);
                }
                if (this.renderer) this.renderer.dispose();
            }
        }
    </script>
</body>
</html>
