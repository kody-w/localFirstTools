<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Local First Tools</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LocalFirst">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <meta name="description" content="Privacy-first, offline-capable tools that work entirely in your browser.">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-hover: #1a1a1a;
            --border: rgba(255,255,255,0.08);
            --text: #fff;
            --text-dim: #888;
            --accent: #8338ec;
            --accent2: #06ffa5;
            --cat-games: #f59e0b;
            --cat-ai-tools: #8b5cf6;
            --cat-development: #10b981;
            --cat-education: #06b6d4;
            --cat-productivity: #3b82f6;
            --cat-quantum-worlds: #14b8a6;
            --cat-business: #64748b;
            --cat-media: #ec4899;
            --cat-utilities: #6b7280;
            --cat-health: #ef4444;
            --cat-index-variants: #a855f7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Top bar */
        .top-bar {
            padding: 12px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .logo {
            font-weight: 700;
            font-size: 13px;
            color: var(--text-dim);
            white-space: nowrap;
            cursor: pointer;
            transition: color 0.2s;
        }
        .logo:hover { color: var(--text); }

        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 500px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 0 3px rgba(131,56,236,0.15);
        }

        .search-input::placeholder { color: var(--text-dim); }

        .categories {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            flex: 1;
        }
        .categories::-webkit-scrollbar { display: none; }

        .cat-btn {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cat-btn:hover { border-color: var(--accent); color: var(--text); }
        .cat-btn:active { transform: scale(0.96); }
        .cat-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        .cat-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

        .cat-count {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .cat-btn.active .cat-count { background: rgba(0,0,0,0.2); }

        /* Controls group */
        .controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ctrl-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s;
        }
        .ctrl-btn:hover { border-color: var(--accent); color: var(--text); background: var(--surface-hover); }
        .ctrl-btn:active { transform: scale(0.92); }
        .ctrl-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        .ctrl-btn.active { background: rgba(131,56,236,0.2); border-color: var(--accent); color: var(--accent); }

        .sort-select {
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
        }
        .sort-select:focus { outline: none; border-color: var(--accent); }

        /* Main area */
        .main-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        /* Recent section */
        .recent-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .recent-clear {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .recent-clear:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .recent-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 4px;
        }
        .recent-scroll::-webkit-scrollbar { display: none; }
        .recent-card {
            flex-shrink: 0;
            width: 100px;
            padding: 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-decoration: none;
            color: inherit;
            text-align: center;
            transition: all 0.15s;
        }
        .recent-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .recent-card:active { transform: scale(0.96); }
        .recent-icon { font-size: 20px; margin-bottom: 4px; }
        .recent-title { font-size: 10px; color: var(--text-dim); line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Result count */
        .result-info {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid/List views */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .tools-grid.list-view {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tool-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            min-height: 90px;
            position: relative;
        }
        .tool-card:hover {
            border-color: var(--accent);
            background: var(--surface-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .tool-card:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .tool-card:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        /* List view card */
        .tools-grid.list-view .tool-card {
            flex-direction: row;
            align-items: center;
            min-height: 44px;
            padding: 8px 12px;
            gap: 12px;
        }
        .tools-grid.list-view .tool-icon { font-size: 18px; margin: 0; }
        .tools-grid.list-view .tool-title { flex: 0 0 200px; margin: 0; font-size: 13px; }
        .tools-grid.list-view .tool-desc { flex: 1; margin: 0; -webkit-line-clamp: 1; white-space: nowrap; }
        .tools-grid.list-view .tool-category { margin: 0; }
        .tools-grid.list-view .tool-pin { position: static; opacity: 0.5; }
        .tools-grid.list-view .tool-card:hover .tool-pin { opacity: 1; }

        .tool-icon { font-size: 22px; margin-bottom: 6px; }
        .tool-title { font-size: 12px; font-weight: 500; margin-bottom: 4px; line-height: 1.3; }
        .tool-desc {
            font-size: 10px;
            color: var(--text-dim);
            line-height: 1.4;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .tool-category {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-dim);
            margin-top: 6px;
            align-self: flex-start;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: rgba(255,255,255,0.06);
        }

        /* Category colors */
        .tool-category[data-cat="games"] { background: rgba(245,158,11,0.15); color: var(--cat-games); }
        .tool-category[data-cat="ai-tools"] { background: rgba(139,92,246,0.15); color: var(--cat-ai-tools); }
        .tool-category[data-cat="development"] { background: rgba(16,185,129,0.15); color: var(--cat-development); }
        .tool-category[data-cat="education"] { background: rgba(6,182,212,0.15); color: var(--cat-education); }
        .tool-category[data-cat="productivity"] { background: rgba(59,130,246,0.15); color: var(--cat-productivity); }
        .tool-category[data-cat="quantum-worlds"] { background: rgba(20,184,166,0.15); color: var(--cat-quantum-worlds); }
        .tool-category[data-cat="business"] { background: rgba(100,116,139,0.15); color: var(--cat-business); }
        .tool-category[data-cat="media"] { background: rgba(236,72,153,0.15); color: var(--cat-media); }
        .tool-category[data-cat="utilities"] { background: rgba(107,114,128,0.15); color: var(--cat-utilities); }
        .tool-category[data-cat="health"] { background: rgba(239,68,68,0.15); color: var(--cat-health); }
        .tool-category[data-cat="index-variants"] { background: rgba(168,85,247,0.15); color: var(--cat-index-variants); }

        .tool-featured {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 12px;
            color: var(--cat-games);
        }

        .tool-pin {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.15s;
        }
        .tool-card:hover .tool-pin { opacity: 1; }
        .tool-pin:hover { background: var(--accent); color: #fff; }
        .tool-pin:active { transform: scale(0.9); }
        .tool-pin.pinned { opacity: 1; background: #ff006e; color: #fff; }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--surface) 25%, rgba(255,255,255,0.08) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-card { min-height: 90px; }

        .no-results { text-align: center; padding: 40px 20px; color: var(--text-dim); }

        /* Command palette */
        .cmd-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
        }
        .cmd-overlay.active { opacity: 1; visibility: visible; }

        .cmd-palette {
            width: 90%;
            max-width: 550px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            transform: scale(0.95) translateY(-10px);
            transition: transform 0.2s;
        }
        .cmd-overlay.active .cmd-palette { transform: scale(1) translateY(0); }

        .cmd-input-wrap { padding: 12px; border-bottom: 1px solid var(--border); }
        .cmd-input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 15px;
        }
        .cmd-input:focus { outline: none; border-color: var(--accent); }
        .cmd-input::placeholder { color: var(--text-dim); }

        .cmd-results { max-height: 350px; overflow-y: auto; }
        .cmd-item {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }
        .cmd-item:hover, .cmd-item.selected { background: rgba(131,56,236,0.15); }
        .cmd-item:active { background: rgba(131,56,236,0.25); }
        .cmd-item-icon { font-size: 18px; }
        .cmd-item-info { flex: 1; }
        .cmd-item-title { font-size: 13px; font-weight: 500; }
        .cmd-item-path { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        .cmd-item-cat { font-size: 9px; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-dim); }
        .cmd-hint { padding: 10px 14px; font-size: 10px; color: var(--text-dim); display: flex; gap: 12px; border-top: 1px solid var(--border); }
        .cmd-hint kbd { padding: 2px 5px; background: rgba(255,255,255,0.1); border-radius: 3px; font-family: monospace; }

        /* Settings */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
        }
        .settings-overlay.active { opacity: 1; visibility: visible; }

        .settings-panel {
            width: 90%;
            max-width: 360px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .settings-overlay.active .settings-panel { transform: scale(1); }

        .settings-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
        .settings-close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 4px; border-radius: 4px; }
        .settings-close:hover { background: rgba(255,255,255,0.1); }
        .settings-section { margin-bottom: 16px; }
        .settings-label { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .settings-btns { display: flex; gap: 8px; }
        .settings-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .settings-btn:hover { border-color: var(--accent); background: var(--surface-hover); }
        .settings-btn:active { transform: scale(0.97); }

        /* Light theme */
        body.light {
            --bg: #f5f5f5;
            --surface: #fff;
            --surface-hover: #fafafa;
            --border: rgba(0,0,0,0.08);
            --text: #111;
            --text-dim: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .top-bar { flex-wrap: wrap; padding: 10px; gap: 8px; }
            .logo { display: none; }
            .search-box { order: 1; flex: 100%; max-width: none; }
            .categories { order: 2; flex: 1; }
            .controls { order: 3; }
            .tools-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .recent-card { width: 80px; }
            .recent-title { font-size: 9px; }
        }

        @media (max-width: 480px) {
            .tools-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .tool-card { padding: 10px; min-height: 80px; }
            .tool-desc { display: none; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo" onclick="location.reload()">LOCAL FIRST</div>
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search tools..." autocomplete="off">
        </div>
        <div class="categories" id="categories"></div>
        <div class="controls">
            <select class="sort-select" id="sortSelect" title="Sort">
                <option value="name">A-Z</option>
                <option value="recent">Recent</option>
                <option value="popular">Popular</option>
            </select>
            <button class="ctrl-btn" id="viewToggle" title="Toggle view">‚ò∞</button>
            <button class="ctrl-btn" id="themeToggle" title="Toggle theme">üåô</button>
            <button class="ctrl-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="main-area">
        <div class="recent-section" id="recentSection" style="display:none">
            <div class="recent-header">
                <span>Recent</span>
                <button class="recent-clear" onclick="clearRecent()">Clear</button>
            </div>
            <div class="recent-scroll" id="recentScroll"></div>
        </div>

        <div class="result-info" id="resultInfo">Loading...</div>

        <div class="tools-grid" id="toolsGrid">
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
        </div>
    </div>

    <div class="cmd-overlay" id="cmdOverlay">
        <div class="cmd-palette">
            <div class="cmd-input-wrap">
                <input type="text" class="cmd-input" id="cmdInput" placeholder="Search apps...">
            </div>
            <div class="cmd-results" id="cmdResults"></div>
            <div class="cmd-hint">
                <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
                <span><kbd>Enter</kbd> Open</span>
                <span><kbd>Esc</kbd> Close</span>
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-panel">
            <div class="settings-title">
                Settings
                <button class="settings-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="settings-section">
                <div class="settings-label">Data</div>
                <div class="settings-btns">
                    <button class="settings-btn" onclick="exportData()">Export</button>
                    <button class="settings-btn" onclick="document.getElementById('importFile').click()">Import</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
            <div class="settings-section">
                <div class="settings-label">Pinned (<span id="pinnedCount">0</span>)</div>
                <div id="pinnedList" style="font-size:11px;color:var(--text-dim);max-height:120px;overflow-y:auto">None</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let allTools = [];
        let filteredTools = [];
        let currentCategory = localStorage.getItem('lastCategory') || 'all';
        let currentSort = localStorage.getItem('preferredSort') || 'name';
        let currentView = localStorage.getItem('viewMode') || 'grid';
        let searchTerm = '';
        let pinnedTools = JSON.parse(localStorage.getItem('pinnedTools') || '[]');
        let usageData = JSON.parse(localStorage.getItem('toolUsage') || '{}');
        let cmdSelectedIndex = 0;
        let searchTimeout;

        const EMBEDDED_CONFIG = {"apps":[]};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            setupEventListeners();
            applyTheme();
            applyView();
            document.getElementById('sortSelect').value = currentSort;
        });

        // Load config
        async function loadConfig() {
            const isFileProtocol = window.location.protocol === 'file:';
            if (isFileProtocol && EMBEDDED_CONFIG.apps.length > 0) {
                processConfig(EMBEDDED_CONFIG);
                return;
            }
            try {
                const response = await fetch('./data/config/utility_apps_config.json');
                if (response.ok) {
                    const config = await response.json();
                    processConfig(config);
                    return;
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }
            if (EMBEDDED_CONFIG.apps.length > 0) processConfig(EMBEDDED_CONFIG);
        }

        // Process config
        function processConfig(config) {
            if (!config || !config.apps) return;

            allTools = config.apps.map(app => {
                const pathParts = app.path.split('/');
                const categoryKey = pathParts.length > 2 ? pathParts[2] : 'utilities';
                return {
                    id: app.id,
                    filename: app.path.split('/').pop(),
                    title: app.title,
                    path: app.path,
                    description: app.description || '',
                    tags: app.tags || [],
                    icon: app.icon || 'üîß',
                    category: categoryKey,
                    featured: app.tags?.includes('featured') || false
                };
            });

            buildCategories();
            renderRecent();
            filterAndDisplay();
        }

        // Build categories
        function buildCategories() {
            const container = document.getElementById('categories');
            const counts = {};
            allTools.forEach(t => { counts[t.category] = (counts[t.category] || 0) + 1; });

            let html = `<button class="cat-btn ${currentCategory === 'all' ? 'active' : ''}" data-cat="all">All <span class="cat-count">${allTools.length}</span></button>`;
            Object.entries(counts).sort((a, b) => b[1] - a[1]).forEach(([cat, count]) => {
                html += `<button class="cat-btn ${currentCategory === cat ? 'active' : ''}" data-cat="${cat}">${formatCat(cat)} <span class="cat-count">${count}</span></button>`;
            });
            container.innerHTML = html;
            container.querySelectorAll('.cat-btn').forEach(btn => {
                btn.onclick = () => selectCategory(btn.dataset.cat);
            });
        }

        function formatCat(cat) {
            return cat.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        function selectCategory(cat) {
            currentCategory = cat;
            localStorage.setItem('lastCategory', cat);
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-cat="${cat}"]`)?.classList.add('active');
            filterAndDisplay();
        }

        // Recent tools
        function renderRecent() {
            const recent = getRecentTools(8);
            const section = document.getElementById('recentSection');
            const scroll = document.getElementById('recentScroll');

            if (recent.length < 3) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            scroll.innerHTML = recent.map(t => `
                <a href="${t.path}" class="recent-card" onclick="trackUsage('${t.filename}')">
                    <div class="recent-icon">${t.icon}</div>
                    <div class="recent-title">${t.title}</div>
                </a>
            `).join('');
        }

        function getRecentTools(limit) {
            return allTools
                .filter(t => usageData[t.filename]?.lastUsed)
                .sort((a, b) => usageData[b.filename].lastUsed - usageData[a.filename].lastUsed)
                .slice(0, limit);
        }

        function clearRecent() {
            Object.keys(usageData).forEach(k => { usageData[k].lastUsed = 0; });
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
            renderRecent();
        }

        // Filter and display
        function filterAndDisplay() {
            filteredTools = [...allTools];

            if (currentCategory !== 'all') {
                filteredTools = filteredTools.filter(t => t.category === currentCategory);
            }

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredTools = filteredTools.filter(t =>
                    t.title.toLowerCase().includes(term) ||
                    t.description.toLowerCase().includes(term) ||
                    t.tags.some(tag => tag.toLowerCase().includes(term))
                );
            }

            sortTools();
            displayTools();
        }

        function sortTools() {
            switch (currentSort) {
                case 'name':
                    filteredTools.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'recent':
                    filteredTools.sort((a, b) => (usageData[b.filename]?.lastUsed || 0) - (usageData[a.filename]?.lastUsed || 0));
                    break;
                case 'popular':
                    filteredTools.sort((a, b) => (usageData[b.filename]?.count || 0) - (usageData[a.filename]?.count || 0));
                    break;
            }
            const pinned = filteredTools.filter(t => pinnedTools.includes(t.filename));
            const unpinned = filteredTools.filter(t => !pinnedTools.includes(t.filename));
            filteredTools = [...pinned, ...unpinned];
        }

        function displayTools() {
            const grid = document.getElementById('toolsGrid');
            const info = document.getElementById('resultInfo');

            if (filteredTools.length === 0) {
                grid.innerHTML = '<div class="no-results">No tools found</div>';
                info.textContent = '0 results';
                return;
            }

            info.textContent = `${filteredTools.length} tools`;

            grid.innerHTML = filteredTools.map(tool => `
                <a href="${tool.path}" class="tool-card" onclick="trackUsage('${tool.filename}')">
                    <div class="tool-icon">${tool.icon}</div>
                    ${tool.featured ? '<span class="tool-featured">‚òÖ</span>' : ''}
                    <button class="tool-pin ${pinnedTools.includes(tool.filename) ? 'pinned' : ''}"
                            onclick="event.preventDefault();event.stopPropagation();togglePin('${tool.filename}')">üìå</button>
                    <div class="tool-title">${tool.title}</div>
                    <div class="tool-desc">${tool.description}</div>
                    <div class="tool-category" data-cat="${tool.category}">${tool.category}</div>
                </a>
            `).join('');
        }

        function trackUsage(filename) {
            if (!usageData[filename]) usageData[filename] = { count: 0, lastUsed: 0 };
            usageData[filename].count++;
            usageData[filename].lastUsed = Date.now();
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
        }

        function togglePin(filename) {
            const idx = pinnedTools.indexOf(filename);
            if (idx > -1) pinnedTools.splice(idx, 1);
            else pinnedTools.push(filename);
            localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools));
            filterAndDisplay();
        }

        // Debounced search
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTerm = e.target.value;
                    filterAndDisplay();
                }, 150);
            });

            document.getElementById('sortSelect').addEventListener('change', (e) => {
                currentSort = e.target.value;
                localStorage.setItem('preferredSort', currentSort);
                filterAndDisplay();
            });

            document.addEventListener('keydown', (e) => {
                if ((e.key === '/' || (e.metaKey && e.key === 'k') || (e.ctrlKey && e.key === 'k')) && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    openCmd();
                }
                if (e.key === 'Escape') {
                    closeCmd();
                    closeSettings();
                }
                if (document.getElementById('cmdOverlay').classList.contains('active')) {
                    if (e.key === 'ArrowDown') { e.preventDefault(); navCmd(1); }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); navCmd(-1); }
                    else if (e.key === 'Enter') { e.preventDefault(); selectCmd(); }
                }
            });

            document.getElementById('cmdInput').addEventListener('input', updateCmd);
            document.getElementById('cmdOverlay').addEventListener('click', (e) => { if (e.target.id === 'cmdOverlay') closeCmd(); });
            document.getElementById('settingsOverlay').addEventListener('click', (e) => { if (e.target.id === 'settingsOverlay') closeSettings(); });
            document.getElementById('settingsBtn').onclick = openSettings;
            document.getElementById('themeToggle').onclick = toggleTheme;
            document.getElementById('viewToggle').onclick = toggleView;
        }

        // Command palette
        function openCmd() {
            document.getElementById('cmdOverlay').classList.add('active');
            document.getElementById('cmdInput').value = '';
            document.getElementById('cmdInput').focus();
            cmdSelectedIndex = 0;
            updateCmd();
        }

        function closeCmd() { document.getElementById('cmdOverlay').classList.remove('active'); }

        function updateCmd() {
            const q = document.getElementById('cmdInput').value.toLowerCase();
            const results = document.getElementById('cmdResults');
            let matches = allTools;
            if (q) {
                matches = allTools.filter(t =>
                    t.title.toLowerCase().includes(q) ||
                    t.description.toLowerCase().includes(q) ||
                    t.category.toLowerCase().includes(q) ||
                    t.tags.some(tag => tag.toLowerCase().includes(q))
                );
            }
            matches = matches.slice(0, 10);
            cmdSelectedIndex = Math.min(cmdSelectedIndex, matches.length - 1);

            results.innerHTML = matches.map((t, i) => `
                <div class="cmd-item ${i === cmdSelectedIndex ? 'selected' : ''}" onclick="window.location.href='${t.path}'" data-index="${i}">
                    <span class="cmd-item-icon">${t.icon}</span>
                    <div class="cmd-item-info">
                        <div class="cmd-item-title">${t.title}</div>
                        <div class="cmd-item-path">${t.path}</div>
                    </div>
                    <span class="cmd-item-cat">${t.category}</span>
                </div>
            `).join('');
            results.dataset.matches = JSON.stringify(matches.map(t => t.path));
        }

        function navCmd(dir) {
            const items = document.querySelectorAll('.cmd-item');
            if (!items.length) return;
            cmdSelectedIndex = Math.max(0, Math.min(cmdSelectedIndex + dir, items.length - 1));
            items.forEach((item, i) => item.classList.toggle('selected', i === cmdSelectedIndex));
            items[cmdSelectedIndex].scrollIntoView({ block: 'nearest' });
        }

        function selectCmd() {
            const matches = JSON.parse(document.getElementById('cmdResults').dataset.matches || '[]');
            if (matches[cmdSelectedIndex]) window.location.href = matches[cmdSelectedIndex];
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('active');
            updatePinned();
        }

        function closeSettings() { document.getElementById('settingsOverlay').classList.remove('active'); }

        function updatePinned() {
            document.getElementById('pinnedCount').textContent = pinnedTools.length;
            const list = document.getElementById('pinnedList');
            if (pinnedTools.length === 0) { list.textContent = 'None'; return; }
            list.innerHTML = pinnedTools.map(f => {
                const t = allTools.find(x => x.filename === f);
                return t ? `<div style="margin:3px 0">${t.icon} ${t.title}</div>` : '';
            }).join('');
        }

        // Theme
        function toggleTheme() {
            document.body.classList.toggle('light');
            const isLight = document.body.classList.contains('light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('themeToggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        }

        function applyTheme() {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // View toggle
        function toggleView() {
            currentView = currentView === 'grid' ? 'list' : 'grid';
            localStorage.setItem('viewMode', currentView);
            applyView();
        }

        function applyView() {
            const grid = document.getElementById('toolsGrid');
            const btn = document.getElementById('viewToggle');
            grid.classList.toggle('list-view', currentView === 'list');
            btn.textContent = currentView === 'list' ? '‚ñ¶' : '‚ò∞';
            btn.classList.toggle('active', currentView === 'list');
        }

        // Export/Import
        function exportData() {
            const data = { pinnedTools, usageData };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `localfirst-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.pinnedTools) { pinnedTools = data.pinnedTools; localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools)); }
                    if (data.usageData) { usageData = data.usageData; localStorage.setItem('toolUsage', JSON.stringify(usageData)); }
                    filterAndDisplay();
                    renderRecent();
                    updatePinned();
                } catch (err) { alert('Invalid JSON'); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
