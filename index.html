<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Local First Tools</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LocalFirst">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <meta name="description" content="Privacy-first, offline-capable tools that work entirely in your browser.">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --border: rgba(255,255,255,0.1);
            --text: #fff;
            --text-dim: #888;
            --accent: #8338ec;
            --accent2: #06ffa5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Top bar - search + categories */
        .top-bar {
            padding: 12px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        .logo {
            font-weight: 700;
            font-size: 14px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            cursor: pointer;
        }

        .search-box {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255,255,255,0.1);
        }

        .search-input::placeholder { color: var(--text-dim); }

        .search-shortcut {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            color: var(--text-dim);
            font-family: monospace;
            pointer-events: none;
        }

        .categories {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .categories::-webkit-scrollbar { display: none; }

        .cat-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cat-btn:hover { border-color: var(--accent); color: var(--text); }
        .cat-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

        .cat-count {
            font-size: 10px;
            opacity: 0.7;
        }

        .tools-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tools-btn:hover { border-color: var(--accent); color: var(--text); }

        /* Status bar */
        .status-bar {
            padding: 6px 20px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-dim);
            flex-shrink: 0;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-btn {
            padding: 3px 8px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .sort-btn:hover { background: rgba(255,255,255,0.05); }
        .sort-btn.active { background: rgba(131,56,236,0.2); color: var(--accent); border-color: rgba(131,56,236,0.3); }

        /* Main grid */
        .main-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .tool-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            min-height: 100px;
            position: relative;
        }

        .tool-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .tool-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .tool-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .tool-desc {
            font-size: 11px;
            color: var(--text-dim);
            line-height: 1.4;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .tool-category {
            font-size: 9px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.06);
            border-radius: 4px;
            color: var(--text-dim);
            margin-top: 8px;
            align-self: flex-start;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tool-featured {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 10px;
            padding: 2px 6px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 4px;
            color: #fff;
            font-weight: 600;
        }

        .tool-pin {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.15s;
        }

        .tool-card:hover .tool-pin { opacity: 1; }
        .tool-pin:hover { background: var(--accent); color: #fff; }
        .tool-pin.pinned { opacity: 1; background: #ff006e; color: #fff; }

        /* No results */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        /* Command palette */
        .cmd-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
        }

        .cmd-overlay.active { display: flex; }

        .cmd-palette {
            width: 90%;
            max-width: 600px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        .cmd-input-wrap {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .cmd-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
        }

        .cmd-input:focus { outline: none; border-color: var(--accent); }
        .cmd-input::placeholder { color: var(--text-dim); }

        .cmd-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .cmd-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }

        .cmd-item:hover, .cmd-item.selected { background: rgba(131,56,236,0.15); }

        .cmd-item-icon { font-size: 20px; }

        .cmd-item-info { flex: 1; }

        .cmd-item-title { font-size: 14px; font-weight: 500; }

        .cmd-item-path { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

        .cmd-item-cat {
            font-size: 10px;
            padding: 2px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            color: var(--text-dim);
        }

        .cmd-hint {
            padding: 12px 16px;
            font-size: 11px;
            color: var(--text-dim);
            display: flex;
            gap: 16px;
        }

        .cmd-hint kbd {
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            font-family: monospace;
        }

        /* Settings panel */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .settings-overlay.active { display: flex; }

        .settings-panel {
            width: 90%;
            max-width: 400px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 18px;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-btns {
            display: flex;
            gap: 8px;
        }

        .settings-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn:hover { border-color: var(--accent); }

        /* Theme toggle in top bar */
        .theme-toggle {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .theme-toggle:hover { border-color: var(--accent); color: var(--text); }

        /* Light theme */
        body.light {
            --bg: #f5f5f5;
            --surface: #fff;
            --border: rgba(0,0,0,0.1);
            --text: #000;
            --text-dim: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .top-bar { flex-wrap: wrap; padding: 10px; gap: 10px; }
            .logo { display: none; }
            .search-box { order: 1; flex: 100%; max-width: none; }
            .categories { order: 2; flex: 1; }
            .tools-btn { order: 3; }
            .tools-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
            .tool-card { padding: 12px; min-height: 90px; }
        }

        @media (max-width: 480px) {
            .tools-grid { grid-template-columns: 1fr 1fr; }
            .status-bar { display: none; }
        }
    </style>
</head>
<body>
    <!-- Top bar with search and categories -->
    <div class="top-bar">
        <div class="logo" onclick="location.reload()">LOCAL FIRST</div>

        <div class="search-box">
            <input type="text" class="search-input" id="searchInput"
                   placeholder="Search 200+ tools..." autocomplete="off">
            <span class="search-shortcut">/</span>
        </div>

        <div class="categories" id="categories">
            <button class="cat-btn active" data-cat="all">All</button>
        </div>

        <button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>
        <button class="tools-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
        <div class="status-left">
            <span id="resultCount">Loading...</span>
            <span>‚Ä¢</span>
            <span>Press <kbd style="padding:1px 4px;background:rgba(255,255,255,0.1);border-radius:3px;font-size:10px">/</kbd> for command palette</span>
        </div>
        <div class="status-right">
            <span style="margin-right:8px">Sort:</span>
            <button class="sort-btn active" data-sort="name">A-Z</button>
            <button class="sort-btn" data-sort="recent">Recent</button>
            <button class="sort-btn" data-sort="popular">Popular</button>
        </div>
    </div>

    <!-- Main grid area -->
    <div class="main-area">
        <div class="tools-grid" id="toolsGrid">
            <div class="no-results">Loading tools...</div>
        </div>
    </div>

    <!-- Command palette -->
    <div class="cmd-overlay" id="cmdOverlay">
        <div class="cmd-palette">
            <div class="cmd-input-wrap">
                <input type="text" class="cmd-input" id="cmdInput"
                       placeholder="Search apps, categories, tags...">
            </div>
            <div class="cmd-results" id="cmdResults"></div>
            <div class="cmd-hint">
                <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
                <span><kbd>Enter</kbd> Open</span>
                <span><kbd>Esc</kbd> Close</span>
            </div>
        </div>
    </div>

    <!-- Settings panel -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-panel">
            <div class="settings-title">
                Settings
                <button class="settings-close" onclick="closeSettings()">‚úï</button>
            </div>

            <div class="settings-section">
                <div class="settings-label">Data</div>
                <div class="settings-btns">
                    <button class="settings-btn" onclick="exportData()">üì§ Export</button>
                    <button class="settings-btn" onclick="document.getElementById('importFile').click()">üì• Import</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>

            <div class="settings-section">
                <div class="settings-label">Pinned Tools</div>
                <div id="pinnedList" style="font-size:12px;color:var(--text-dim)">No pinned tools</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let allTools = [];
        let filteredTools = [];
        let currentCategory = 'all';
        let currentSort = 'name';
        let searchTerm = '';
        let pinnedTools = JSON.parse(localStorage.getItem('pinnedTools') || '[]');
        let usageData = JSON.parse(localStorage.getItem('toolUsage') || '{}');
        let cmdSelectedIndex = 0;

        // Embedded config for offline mode
        const EMBEDDED_CONFIG = {"apps":[]};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            setupEventListeners();
            applyTheme();
        });

        // Load config
        async function loadConfig() {
            const isFileProtocol = window.location.protocol === 'file:';

            if (isFileProtocol && EMBEDDED_CONFIG.apps.length > 0) {
                processConfig(EMBEDDED_CONFIG);
                return;
            }

            try {
                const response = await fetch('./data/config/utility_apps_config.json');
                if (response.ok) {
                    const config = await response.json();
                    processConfig(config);
                    return;
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }

            // Fallback
            if (EMBEDDED_CONFIG.apps.length > 0) {
                processConfig(EMBEDDED_CONFIG);
            }
        }

        // Process config
        function processConfig(config) {
            if (!config || !config.apps) return;

            allTools = config.apps.map(app => {
                const pathParts = app.path.split('/');
                const categoryKey = pathParts.length > 2 ? pathParts[2] : 'utilities';

                return {
                    id: app.id,
                    filename: app.path.split('/').pop(),
                    title: app.title,
                    path: app.path,
                    description: app.description || '',
                    tags: app.tags || [],
                    icon: app.icon || 'üîß',
                    category: categoryKey,
                    featured: app.tags?.includes('featured') || false
                };
            });

            buildCategories();
            filterAndDisplay();
        }

        // Build category buttons
        function buildCategories() {
            const container = document.getElementById('categories');
            const counts = {};

            allTools.forEach(t => {
                counts[t.category] = (counts[t.category] || 0) + 1;
            });

            container.innerHTML = `<button class="cat-btn active" data-cat="all">All <span class="cat-count">${allTools.length}</span></button>`;

            // Sort categories by count
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            sorted.forEach(([cat, count]) => {
                const btn = document.createElement('button');
                btn.className = 'cat-btn';
                btn.dataset.cat = cat;
                btn.innerHTML = `${formatCategory(cat)} <span class="cat-count">${count}</span>`;
                container.appendChild(btn);
            });

            // Add click handlers
            container.querySelectorAll('.cat-btn').forEach(btn => {
                btn.onclick = () => selectCategory(btn.dataset.cat);
            });
        }

        // Format category name
        function formatCategory(cat) {
            return cat.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        // Select category
        function selectCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-cat="${cat}"]`).classList.add('active');
            filterAndDisplay();
        }

        // Filter and display
        function filterAndDisplay() {
            filteredTools = [...allTools];

            // Category filter
            if (currentCategory !== 'all') {
                filteredTools = filteredTools.filter(t => t.category === currentCategory);
            }

            // Search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredTools = filteredTools.filter(t =>
                    t.title.toLowerCase().includes(term) ||
                    t.description.toLowerCase().includes(term) ||
                    t.tags.some(tag => tag.toLowerCase().includes(term))
                );
            }

            // Sort
            sortTools();

            // Display
            displayTools();
        }

        // Sort tools
        function sortTools() {
            switch (currentSort) {
                case 'name':
                    filteredTools.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'recent':
                    filteredTools.sort((a, b) => {
                        const aTime = usageData[a.filename]?.lastUsed || 0;
                        const bTime = usageData[b.filename]?.lastUsed || 0;
                        return bTime - aTime;
                    });
                    break;
                case 'popular':
                    filteredTools.sort((a, b) => {
                        const aCount = usageData[a.filename]?.count || 0;
                        const bCount = usageData[b.filename]?.count || 0;
                        return bCount - aCount;
                    });
                    break;
            }

            // Pinned first
            const pinned = filteredTools.filter(t => pinnedTools.includes(t.filename));
            const unpinned = filteredTools.filter(t => !pinnedTools.includes(t.filename));
            filteredTools = [...pinned, ...unpinned];
        }

        // Display tools
        function displayTools() {
            const grid = document.getElementById('toolsGrid');

            if (filteredTools.length === 0) {
                grid.innerHTML = '<div class="no-results">No tools found</div>';
                document.getElementById('resultCount').textContent = '0 results';
                return;
            }

            document.getElementById('resultCount').textContent = `${filteredTools.length} tools`;

            grid.innerHTML = filteredTools.map(tool => `
                <a href="${tool.path}" class="tool-card" onclick="trackUsage('${tool.filename}')">
                    <div class="tool-icon">${tool.icon}</div>
                    ${tool.featured ? '<span class="tool-featured">‚òÖ</span>' : ''}
                    <button class="tool-pin ${pinnedTools.includes(tool.filename) ? 'pinned' : ''}"
                            onclick="event.preventDefault();event.stopPropagation();togglePin('${tool.filename}')">
                        üìå
                    </button>
                    <div class="tool-title">${tool.title}</div>
                    <div class="tool-desc">${tool.description}</div>
                    <div class="tool-category">${tool.category}</div>
                </a>
            `).join('');
        }

        // Track usage
        function trackUsage(filename) {
            if (!usageData[filename]) {
                usageData[filename] = { count: 0, lastUsed: 0 };
            }
            usageData[filename].count++;
            usageData[filename].lastUsed = Date.now();
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
        }

        // Toggle pin
        function togglePin(filename) {
            const idx = pinnedTools.indexOf(filename);
            if (idx > -1) {
                pinnedTools.splice(idx, 1);
            } else {
                pinnedTools.push(filename);
            }
            localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools));
            filterAndDisplay();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                filterAndDisplay();
            });

            // Sort buttons
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSort = btn.dataset.sort;
                    filterAndDisplay();
                };
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Command palette
                if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    openCommandPalette();
                }

                // Focus search
                if (e.key === 'Escape') {
                    closeCommandPalette();
                    closeSettings();
                }

                // Command palette navigation
                if (document.getElementById('cmdOverlay').classList.contains('active')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateCmd(1);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateCmd(-1);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        selectCmdItem();
                    }
                }
            });

            // Command palette input
            const cmdInput = document.getElementById('cmdInput');
            cmdInput.addEventListener('input', updateCmdResults);

            // Click outside to close
            document.getElementById('cmdOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'cmdOverlay') closeCommandPalette();
            });

            document.getElementById('settingsOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'settingsOverlay') closeSettings();
            });

            // Settings button
            document.getElementById('settingsBtn').onclick = openSettings;

            // Theme toggle
            document.getElementById('themeToggle').onclick = toggleTheme;
        }

        // Command palette
        function openCommandPalette() {
            document.getElementById('cmdOverlay').classList.add('active');
            document.getElementById('cmdInput').value = '';
            document.getElementById('cmdInput').focus();
            cmdSelectedIndex = 0;
            updateCmdResults();
        }

        function closeCommandPalette() {
            document.getElementById('cmdOverlay').classList.remove('active');
        }

        function updateCmdResults() {
            const query = document.getElementById('cmdInput').value.toLowerCase();
            const results = document.getElementById('cmdResults');

            let matches = allTools;
            if (query) {
                matches = allTools.filter(t =>
                    t.title.toLowerCase().includes(query) ||
                    t.description.toLowerCase().includes(query) ||
                    t.category.toLowerCase().includes(query) ||
                    t.tags.some(tag => tag.toLowerCase().includes(query))
                );
            }

            matches = matches.slice(0, 10);
            cmdSelectedIndex = Math.min(cmdSelectedIndex, matches.length - 1);

            results.innerHTML = matches.map((tool, i) => `
                <div class="cmd-item ${i === cmdSelectedIndex ? 'selected' : ''}"
                     onclick="window.location.href='${tool.path}'"
                     data-index="${i}">
                    <span class="cmd-item-icon">${tool.icon}</span>
                    <div class="cmd-item-info">
                        <div class="cmd-item-title">${tool.title}</div>
                        <div class="cmd-item-path">${tool.path}</div>
                    </div>
                    <span class="cmd-item-cat">${tool.category}</span>
                </div>
            `).join('');

            // Store matches for navigation
            results.dataset.matches = JSON.stringify(matches.map(t => t.path));
        }

        function navigateCmd(dir) {
            const results = document.getElementById('cmdResults');
            const items = results.querySelectorAll('.cmd-item');
            if (items.length === 0) return;

            cmdSelectedIndex = Math.max(0, Math.min(cmdSelectedIndex + dir, items.length - 1));
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === cmdSelectedIndex);
            });

            items[cmdSelectedIndex].scrollIntoView({ block: 'nearest' });
        }

        function selectCmdItem() {
            const results = document.getElementById('cmdResults');
            const matches = JSON.parse(results.dataset.matches || '[]');
            if (matches[cmdSelectedIndex]) {
                window.location.href = matches[cmdSelectedIndex];
            }
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('active');
            updatePinnedList();
        }

        function closeSettings() {
            document.getElementById('settingsOverlay').classList.remove('active');
        }

        function updatePinnedList() {
            const list = document.getElementById('pinnedList');
            if (pinnedTools.length === 0) {
                list.textContent = 'No pinned tools';
                return;
            }
            list.innerHTML = pinnedTools.map(f => {
                const tool = allTools.find(t => t.filename === f);
                return tool ? `<div style="margin:4px 0">${tool.icon} ${tool.title}</div>` : '';
            }).join('');
        }

        // Theme
        function toggleTheme() {
            document.body.classList.toggle('light');
            const isLight = document.body.classList.contains('light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('themeToggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        }

        function applyTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // Export/Import
        function exportData() {
            const data = { pinnedTools, usageData };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `localfirst-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.pinnedTools) {
                        pinnedTools = data.pinnedTools;
                        localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools));
                    }
                    if (data.usageData) {
                        usageData = data.usageData;
                        localStorage.setItem('toolUsage', JSON.stringify(usageData));
                    }
                    filterAndDisplay();
                    updatePinnedList();
                } catch (err) {
                    alert('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
