<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magentic Agents</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github.min.css" as="style">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github.min.css" rel="stylesheet">
    <style>
        /* All CSS styles from the original file remain unchanged */
        :root {
            --primary-color: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #4f46e5;
            --secondary-light: #6366f1;
            --secondary-dark: #4338ca;
            --accent-color: #ec4899;
            --accent-light: #f472b6;
            --accent-dark: #db2777;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --ms-gray-10: #fafafa;
            --ms-gray-20: #f4f4f5;
            --ms-gray-30: #e4e4e7;
            --ms-gray-40: #d4d4d8;
            --ms-gray-100: #18181b;
            --ms-gray-130: #09090b;
            --space-xs: 4px;
            --space-s: 8px;
            --space-m: 16px;
            --space-l: 24px;
            --space-xl: 32px;
            --border-radius: 6px;
            --shadow-small: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.1);
            --header-height: 60px;
            --footer-height: 60px;
        }

        @font-face {
            font-family: "Inter";
            src: local("Inter"), url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
            font-weight: normal;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont,
                "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--ms-gray-10);
            color: var(--ms-gray-100);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--footer-height);
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: var(--shadow-medium);
        }

        .header {
            background: linear-gradient(to right, var(--primary-dark), var(--secondary-dark));
            color: white;
            padding: 0 var(--space-m);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-small);
            z-index: 100;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-s);
        }

        .logo {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 5px 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 242, 254, 0.3);
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-s);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            overflow: hidden;
        }

        .app-store-container {
            padding: var(--space-m);
            overflow-y: auto;
            border-right: 1px solid var(--ms-gray-30);
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        .workflow-container {
            padding: var(--space-m);
            overflow-y: auto;
            border-right: 1px solid var(--ms-gray-30);
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        .queue-container {
            padding: var(--space-m);
            overflow-y: auto;
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--space-m);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .workflow-card {
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--ms-gray-30);
            box-shadow: var(--shadow-small);
            padding: var(--space-m);
            margin-bottom: var(--space-m);
        }

        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-m);
        }

        .workflow-name {
            font-size: 16px;
            font-weight: 600;
        }

        .workflow-description {
            color: var(--ms-gray-100);
            margin-bottom: var(--space-m);
            font-size: 14px;
        }

        .workflow-agents {
            margin-top: var(--space-m);
        }

        .agent-item {
            display: flex;
            align-items: center;
            padding: var(--space-s);
            margin-bottom: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: var(--ms-gray-10);
            cursor: grab;
        }

        .agent-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: var(--space-s);
        }

        .dynamics-color {
            background-color: var(--primary-color);
        }

        .email-color {
            background-color: var(--secondary-color);
        }

        .memory-color {
            background-color: var(--accent-color);
        }

        .custom-color {
            background-color: var(--warning-color);
        }

        .agent-details {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            font-size: 14px;
        }

        .agent-command {
            font-size: 12px;
            color: var(--ms-gray-100);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .agent-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: var(--space-xs) var(--space-s);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button:hover {
            background: var(--primary-dark);
        }

        .button:active {
            transform: scale(0.98);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button.secondary {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .button.secondary:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .button.icon-only {
            width: 24px;
            height: 24px;
            padding: 0;
        }

        .workflow-connections {
            margin-top: var(--space-m);
        }

        .connection-item {
            display: flex;
            align-items: center;
            padding: var(--space-s);
            margin-bottom: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: var(--ms-gray-10);
            font-size: 12px;
        }

        .connection-arrow {
            margin: 0 var(--space-s);
            color: var(--primary-color);
        }

        .workflow-actions {
            display: flex;
            gap: var(--space-s);
            margin-top: var(--space-m);
            justify-content: flex-end;
        }

        /* Command Queue Styles */
        .queue-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            padding: var(--space-s);
            margin-bottom: var(--space-m);
            min-height: 200px;
        }

        .queue-empty {
            color: var(--ms-gray-100);
            text-align: center;
            padding: var(--space-m);
            font-style: italic;
        }

        .queue-item {
            display: flex;
            align-items: center;
            padding: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: white;
            position: relative;
        }

        .queue-item-number {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            background: var(--primary-light);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .queue-item-content {
            flex: 1;
            padding-left: 28px;
        }

        .queue-item-command {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .queue-item-skill {
            font-size: 12px;
            color: var(--primary-color);
        }

        .queue-item-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .queue-item-remove {
            color: var(--error-color);
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .queue-item-remove:hover {
            opacity: 1;
        }

        .queue-form {
            margin-top: var(--space-m);
        }

        .form-group {
            margin-bottom: var(--space-m);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--ms-gray-40);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--ms-gray-40);
            border-radius: var(--border-radius);
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .queue-actions {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-m);
        }

        .queue-status {
            padding: var(--space-s);
            border-radius: var(--border-radius);
            font-size: 14px;
            margin-top: var(--space-m);
            display: none;
        }

        .queue-status.processing {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            display: block;
        }

        .queue-status.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            display: block;
        }

        .queue-status.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            display: block;
        }

        .queue-item-completed {
            border-left: 4px solid var(--success-color);
        }

        .queue-item-failed {
            border-left: 4px solid var(--error-color);
        }

        .queue-item-processing {
            border-left: 4px solid var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }

        /* App Store Styles */
        .app-category {
            margin-bottom: var(--space-m);
        }

        .app-category-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-s);
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid var(--ms-gray-30);
        }

        .app-item {
            display: flex;
            padding: var(--space-s);
            margin-bottom: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-item:hover {
            box-shadow: var(--shadow-small);
            transform: translateY(-2px);
            border-color: var(--primary-light);
        }

        .app-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--space-s);
            color: white;
            border-radius: var(--border-radius);
        }

        .app-details {
            flex: 1;
        }

        .app-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .app-description {
            font-size: 12px;
            color: var(--ms-gray-100);
        }

        .app-rating {
            display: flex;
            align-items: center;
            margin-top: 4px;
            font-size: 12px;
            color: var(--warning-color);
        }

        /* Footer styles */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--ms-gray-10);
            border-top: 1px solid var(--ms-gray-30);
            padding: 0 var(--space-m);
        }

        .footer-actions {
            display: flex;
            gap: var(--space-m);
        }

        .footer-status {
            font-size: 12px;
            color: var(--ms-gray-100);
        }

        /* Chat Interface Styles */
        .chat-container {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            display: none;
        }

        .chat-header {
            padding: 12px 16px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: var(--ms-gray-10);
        }

        .chat-message {
            margin-bottom: 12px;
            max-width: 80%;
        }

        .chat-message.user {
            margin-left: auto;
        }

        .chat-message.assistant {
            margin-right: auto;
        }

        .message-bubble {
            padding: 10px 12px;
            border-radius: 18px;
            display: inline-block;
            font-size: 14px;
        }

        .user .message-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .assistant .message-bubble {
            background-color: white;
            color: var(--ms-gray-100);
            border: 1px solid var(--ms-gray-30);
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid var(--ms-gray-30);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--ms-gray-30);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            height: 40px;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .chat-send {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-send:hover {
            background-color: var(--primary-dark);
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            padding: var(--space-l);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-m);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--ms-gray-100);
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: var(--space-m);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-s);
            margin-top: var(--space-m);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: var(--space-xs);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Utility classes */
        .hidden {
            display: none;
        }

        /* Dark mode */
        body.dark-mode {
            background-color: var(--ms-gray-130);
            color: white;
        }

        body.dark-mode .app-container {
            background: var(--ms-gray-100);
        }

        body.dark-mode .workflow-card,
        body.dark-mode .queue-item,
        body.dark-mode .modal-content,
        body.dark-mode .app-item,
        body.dark-mode .chat-container {
            background-color: var(--ms-gray-100);
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .agent-item,
        body.dark-mode .connection-item {
            background-color: var(--ms-gray-130);
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .form-input,
        body.dark-mode .form-textarea,
        body.dark-mode .chat-input {
            background-color: var(--ms-gray-130);
            color: white;
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .chat-messages {
            background-color: var(--ms-gray-130);
        }

        body.dark-mode .assistant .message-bubble {
            background-color: var(--ms-gray-100);
            color: white;
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .footer {
            background-color: var(--ms-gray-100);
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .queue-empty {
            color: white;
        }

        body.dark-mode .queue-list {
            border-color: var(--ms-gray-40);
        }

        /* Drag and drop styling */
        .drag-over {
            border: 2px dashed var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }

        /* Response viewer */
        .response-container {
            margin-top: var(--space-m);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            padding: var(--space-m);
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--ms-gray-10);
            font-size: 14px;
        }

        body.dark-mode .response-container {
            background-color: var(--ms-gray-130);
            border-color: var(--ms-gray-40);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Drop zone for file import */
        .drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(37, 99, 235, 0.1);
            border: 3px dashed var(--primary-color);
            z-index: 1000;
            display: flex;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .drop-zone.active {
            opacity: 1;
            pointer-events: all;
        }

        .drop-zone-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--primary-color);
        }

        .drop-zone-content i {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .drop-zone-content p {
            font-size: 18px;
            font-weight: 500;
        }

        /* Sound notification and animation */
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.replay-animation {
            animation: messageAppear 0.5s ease forwards;
        }

        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 2fr;
            }

            .app-store-container {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }

            .workflow-container {
                border-right: none;
                border-bottom: 1px solid var(--ms-gray-30);
            }
            
            .button.secondary {
                padding: 4px 8px;
            }
            
            .agent-command {
                max-width: 150px;
            }

            .chat-container {
                width: 100%;
                height: 80vh;
                bottom: 10px;
                right: 0;
                border-radius: 0;
            }

            .chat-header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body data-assistant-name="Magic Agents">
    <div class="app-container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">Magic Agents</div>
            </div>
            <div class="header-actions">
                <button id="theme-toggle" class="button icon-only" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <main class="main-container">
            <section class="app-store-container">
                <div class="section-title">
                    <span>App Store</span>
                    <button class="button" id="refresh-apps-btn" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div class="app-category">
                    <div class="app-category-title">Featured Workflows</div>
                    <div class="app-item" data-workflow-id="opportunity-email">
                        <div class="app-icon" style="background-color: #3b82f6;">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Opportunity Summary Email</div>
                            <div class="app-description">Automatically send opportunity summaries to your team lead</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span style="margin-left: 5px; color: #666;">4.5</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-item" data-workflow-id="lead-followup">
                        <div class="app-icon" style="background-color: #10b981;">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Lead Follow-up</div>
                            <div class="app-description">Create and follow up with new leads automatically</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">4.0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-category">
                    <div class="app-category-title">New Releases</div>
                    <div class="app-item" data-workflow-id="customer-support">
                        <div class="app-icon" style="background-color: #ec4899;">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Customer Support Bot</div>
                            <div class="app-description">AI-powered customer support assistant</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">5.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-item" data-workflow-id="social-scheduler">
                        <div class="app-icon" style="background-color: #f59e0b;">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Social Media Scheduler</div>
                            <div class="app-description">Schedule and automate social media posts</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">4.2</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-category">
                    <div class="app-category-title">Work Productivity</div>
                    <div class="app-item" data-workflow-id="meeting-summary">
                        <div class="app-icon" style="background-color: #6366f1;">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Meeting Summarizer</div>
                            <div class="app-description">Create and send meeting summaries automatically</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span style="margin-left: 5px; color: #666;">4.6</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-item" data-workflow-id="expense-reporter">
                        <div class="app-icon" style="background-color: #ef4444;">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Expense Reporter</div>
                            <div class="app-description">Automatically process and submit expense reports</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <i class="far fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">3.7</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="workflow-container">
                <div class="section-title">
                    <span>Workflow Designer</span>
                    <button class="button" id="create-workflow-btn">Create New</button>
                </div>

                <div class="workflow-card">
                    <div class="workflow-header">
                        <div class="workflow-name" id="current-workflow-name">Opportunity Summary Email</div>
                        <button class="button secondary icon-only" id="edit-workflow-btn" title="Edit Workflow">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="workflow-description" id="current-workflow-description">
                        This workflow retrieves your active sales opportunities from Dynamics 365 and sends a summary email to your team lead.
                    </div>

                    <div class="workflow-agents">
                        <h3>Agents</h3>
                        <div class="agent-list" id="agent-list">
                            <!-- Agents will be populated here by JavaScript -->
                        </div>
                    </div>

                    <div class="workflow-connections">
                        <h3>Connections</h3>
                        <div class="connection-list" id="connection-list">
                            <!-- Connections will be populated here by JavaScript -->
                        </div>
                    </div>

                    <div class="workflow-actions">
                        <button class="button secondary" id="export-workflow-btn">Export</button>
                        <button class="button secondary" id="import-workflow-btn">Import</button>
                        <button class="button secondary" id="convert-to-queue-btn">Convert to Queue</button>
                        <button class="button" id="run-workflow-btn">Run Workflow</button>
                    </div>
                </div>

                <div class="response-container hidden" id="workflow-response">
                    <h3>Workflow Response</h3>
                    <div id="response-content"></div>
                    <div class="workflow-chat-actions" style="margin-top: 10px; text-align: right;">
                        <button class="button" id="open-chat-btn">
                            <i class="fas fa-comment"></i> Open Chat
                        </button>
                    </div>
                </div>
            </section>

            <section class="queue-container">
                <div class="section-title">
                    <span>Command Queue</span>
                    <button class="button" id="convert-to-workflow-btn">Convert to Workflow</button>
                </div>

                <div class="queue-list" id="queue-list">
                    <div class="queue-empty" id="queue-empty">No commands in queue</div>
                    <!-- Command queue items will be added here by JavaScript -->
                </div>

                <div class="queue-form">
                    <div class="form-group">
                        <label for="command-input" class="form-label">Command</label>
                        <textarea id="command-input" class="form-textarea" placeholder="Enter your command in natural language..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="skill-input" class="form-label">Expected Skill (optional)</label>
                        <select id="skill-input" class="form-input">
                            <option value="">-- Select Skill --</option>
                            <option value="Dynamics365CRUD">Dynamics 365</option>
                            <option value="EmailDrafting">Email</option>
                            <option value="ManageMemory">Memory</option>
                            <option value="ContextMemory">Context</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="queue-actions">
                        <div>
                            <button class="button secondary" id="clear-queue-btn">Clear Queue</button>
                        </div>
                        <div>
                            <button class="button" id="add-command-btn">Add Command</button>
                            <button class="button" id="run-queue-btn">Run Queue</button>
                        </div>
                    </div>
                </div>

                <div class="queue-status" id="queue-status"></div>
                
                <div class="response-container hidden" id="queue-response">
                    <h3>Queue Response</h3>
                    <div id="queue-response-content"></div>
                    <div class="queue-chat-actions" style="margin-top: 10px; text-align: right;">
                        <button class="button" id="queue-open-chat-btn">
                            <i class="fas fa-comment"></i> Open Chat
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <div class="footer-status" id="footer-status">Ready</div>
            <div class="footer-actions">
                <button class="button secondary" id="export-json-btn">Export JSON</button>
                <button class="button secondary" id="import-json-btn">Import JSON</button>
                <button class="button" id="open-main-chat-btn">
                    <i class="fas fa-comment"></i> Chat
                </button>
            </div>
        </footer>

        <!-- Chat Interface -->
        <div class="chat-container" id="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    <span id="chat-title-text">Magentic Assistant</span>
                </div>
                <button class="chat-close" id="chat-close">&times;</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <!-- Chat messages will be added here by JavaScript -->
            </div>
            <div class="chat-input-area">
                <textarea class="chat-input" id="chat-input" placeholder="Type your message..." rows="1"></textarea>
                <button class="chat-send" id="chat-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Workflow Modal -->
    <div class="modal" id="edit-workflow-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Workflow</div>
                <button class="modal-close" id="close-edit-workflow">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="workflow-name" class="form-label">Workflow Name</label>
                    <input type="text" id="workflow-name" class="form-input" placeholder="Enter workflow name">
                </div>
                <div class="form-group">
                    <label for="workflow-description" class="form-label">Description</label>
                    <textarea id="workflow-description" class="form-textarea" placeholder="Describe your workflow"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Natural Language Description</label>
                    <textarea id="workflow-nlp-description" class="form-textarea" placeholder="Describe what this workflow should do in natural language..."></textarea>
                    <small style="color: #666;">Example: "Get all active opportunities and send a summary to the team lead"</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-edit-workflow">Cancel</button>
                <button class="button" id="save-edit-workflow">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Agent Modal -->
    <div class="modal" id="edit-agent-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Agent</div>
                <button class="modal-close" id="close-edit-agent">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="agent-name" class="form-label">Agent Name</label>
                    <input type="text" id="agent-name" class="form-input" placeholder="Enter agent name">
                </div>
                <div class="form-group">
                    <label for="agent-description" class="form-label">Description</label>
                    <input type="text" id="agent-description" class="form-input" placeholder="Enter agent description">
                </div>
                <div class="form-group">
                    <label for="agent-command" class="form-label">Command</label>
                    <textarea id="agent-command" class="form-textarea" placeholder="Enter agent command in natural language"></textarea>
                </div>
                <div class="form-group">
                    <label for="agent-type" class="form-label">Agent Type</label>
                    <select id="agent-type" class="form-input">
                        <option value="Dynamics365CRUD">Dynamics 365</option>
                        <option value="EmailDrafting">Email</option>
                        <option value="ManageMemory">Memory</option>
                        <option value="ContextMemory">Context</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-edit-agent">Cancel</button>
                <button class="button" id="save-edit-agent">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Import/Export JSON Modal -->
    <div class="modal" id="json-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="json-modal-title">Import/Export JSON</div>
                <button class="modal-close" id="close-json-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="json-content" class="form-textarea" style="min-height: 300px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-json-modal">Cancel</button>
                <button class="button" id="confirm-json-modal">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Chat Context Modal -->
    <div class="modal" id="chat-context-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Join Chat at Specific Step</div>
                <button class="modal-close" id="close-chat-context-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select the step where you want to intervene:</label>
                    <div id="workflow-steps-list" style="margin-top: 10px;">
                        <!-- Steps will be added here dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-chat-context">Cancel</button>
                <button class="button" id="confirm-chat-context">Join Chat</button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">API Authentication</div>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Please enter your API key to connect to the backend services.</p>
                <div class="form-group">
                    <label for="api-key" class="form-label">API Key</label>
                    <input type="password" id="api-key" class="form-input" placeholder="Enter your API key">
                </div>
                <div class="form-group">
                    <label for="api-endpoint" class="form-label">API Endpoint</label>
                    <input type="text" id="api-endpoint" class="form-input" placeholder="Enter API endpoint URL" value="http://localhost:7071/api/businessinsightbot_function">
                    <small style="color: #666;">Default is http://localhost:7071/api/businessinsightbot_function</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button" id="save-api-key">Save and Connect</button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Drop zone for importing files -->
    <div id="drop-zone" class="drop-zone">
        <div class="drop-zone-content">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drop file here</p>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="workflow-file-input" accept=".json" style="display: none">
    <input type="file" id="json-file-input" accept=".json" style="display: none">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>

    <script>
        // Initial data structure for the application
        const initialData = {
            version: "1.0.0",
            workflows: {
                "opportunity-email": {
                    id: "opportunity-email",
                    name: "Opportunity Summary Email",
                    description: "This workflow retrieves your active sales opportunities from Dynamics 365 and sends a summary email to your team lead.",
                    created: "2023-09-15T12:00:00Z",
                    lastRun: null,
                    nlDescription: "Get all active sales opportunities from Dynamics 365, create a summary, and send it to my team lead via email.",
                    agents: [
                        {
                            id: "agent1",
                            type: "Dynamics365CRUD",
                            agentId: "getDynamicsData",
                            name: "Get Opportunities",
                            description: "Retrieves active opportunities from Dynamics 365",
                            position: { x: 100, y: 100 },
                            command: "Get all active sales opportunities from Dynamics 365 CRM where status is open."
                        },
                        {
                            id: "agent2",
                            type: "EmailDrafting",
                            agentId: "sendEmail",
                            name: "Send Summary Email",
                            description: "Sends an email with the opportunity summary",
                            position: { x: 300, y: 100 },
                            command: "Create a summary email of the opportunities and send it to my team lead at teamlead@example.com."
                        }
                    ],
                    connections: [
                        {
                            fromId: "agent1",
                            toId: "agent2",
                            connectionPrompt: "Pass the opportunities data to the email agent"
                        }
                    ]
                },
                "lead-followup": {
                    id: "lead-followup",
                    name: "Lead Follow-up",
                    description: "Create and follow up with new leads automatically",
                    created: "2023-09-16T12:00:00Z",
                    lastRun: null,
                    nlDescription: "Get leads that haven't been contacted in the last 7 days, create personalized follow-up emails, and send them to each lead.",
                    agents: [
                        {
                            id: "agent1",
                            type: "Dynamics365CRUD",
                            agentId: "getDynamicsData",
                            name: "Get Stale Leads",
                            description: "Retrieves leads not contacted in 7 days",
                            position: { x: 100, y: 100 },
                            command: "Get all leads from Dynamics 365 CRM where last contact date is more than 7 days ago."
                        },
                        {
                            id: "agent2",
                            type: "EmailDrafting",
                            agentId: "sendEmail",
                            name: "Send Follow-up Emails",
                            description: "Creates and sends follow-up emails to leads",
                            position: { x: 300, y: 100 },
                            command: "For each lead, draft a personalized follow-up email and send it to their email address."
                        },
                        {
                            id: "agent3",
                            type: "ManageMemory",
                            agentId: "memorySave",
                            name: "Record Follow-up",
                            description: "Records that follow-up was sent",
                            position: { x: 500, y: 100 },
                            command: "Record in the system memory that we've sent follow-up emails to these leads today."
                        }
                    ],
                    connections: [
                        {
                            fromId: "agent1",
                            toId: "agent2",
                            connectionPrompt: "Pass the lead data to create emails"
                        },
                        {
                            fromId: "agent2",
                            toId: "agent3",
                            connectionPrompt: "Record that emails were sent"
                        }
                    ]
                }
            }
        };

        document.addEventListener("DOMContentLoaded", function () {
            const assistantName = document.body.dataset.assistantName;
            
            // Initialize state
            let appState = {
                currentWorkflowId: "opportunity-email",
                commandQueue: [],
                expectedSkills: {},
                darkMode: localStorage.getItem("theme") === "dark",
                editingAgentId: null,
                isProcessing: false,
                chatContext: null,
                chatHistory: [],
                selectedStep: null,
                userId: generateUserId(),
                apiUrl: localStorage.getItem("apiEndpoint") || "http://localhost:7071/api/businessinsightbot_function",
                apiKey: localStorage.getItem("functionKey") || ""
            };

            // Helper function to generate a userId if needed
            function generateUserId() {
                const existingId = localStorage.getItem('userGuid');
                if (existingId) {
                    return existingId;
                }
                
                const newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                
                localStorage.setItem('userGuid', newId);
                return newId;
            }

            // Class for handling sound effects
            class SoundManager {
                constructor() {
                    this.audioContext = null;
                    this.bellBuffer = null;
                    this.responseBuffer = null;
                    this.loopTimeout = null;
                    this.isPlaying = false;

                    // Get sound preference from localStorage, default to 'off'
                    const savedSoundPreference = localStorage.getItem("soundEnabled");
                    this.volume = savedSoundPreference === "on" ? 0.3 : 0;
                    this.isInitialized = false;

                    this.initializeAudio();
                }

                async initializeAudio() {
                    if (this.isInitialized) return;

                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

                        const bellBuffer = this.audioContext.createBuffer(
                            1,
                            this.audioContext.sampleRate * 1,
                            this.audioContext.sampleRate
                        );
                        const bellData = bellBuffer.getChannelData(0);
                        for (let i = 0; i < bellBuffer.length; i++) {
                            bellData[i] = Math.sin((440 * Math.PI * 2 * i) / this.audioContext.sampleRate) * 
                                Math.exp((-3 * i) / bellBuffer.length);
                        }
                        this.bellBuffer = bellBuffer;

                        const responseBuffer = this.audioContext.createBuffer(
                            1,
                            this.audioContext.sampleRate * 0.5,
                            this.audioContext.sampleRate
                        );
                        const responseData = responseBuffer.getChannelData(0);
                        for (let i = 0; i < responseBuffer.length; i++) {
                            responseData[i] = Math.sin((880 * Math.PI * 2 * i) / this.audioContext.sampleRate) * 
                                Math.exp((-5 * i) / responseBuffer.length);
                        }
                        this.responseBuffer = responseBuffer;

                        this.isInitialized = true;
                    } catch (error) {
                        console.warn("Error initializing audio:", error);
                    }
                }

                async playSound(buffer, volume = 0.3) {
                    if (!this.isInitialized || !this.audioContext || !buffer) return;

                    try {
                        const source = this.audioContext.createBufferSource();
                        const gainNode = this.audioContext.createGain();

                        source.buffer = buffer;
                        gainNode.gain.value = volume * this.volume;

                        source.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);

                        source.start(0);
                        gainNode.gain.exponentialRampToValueAtTime(
                            0.001,
                            this.audioContext.currentTime + 2.0
                        );
                    } catch (error) {
                        console.warn("Error playing sound:", error);
                    }
                }

                async startBellSequence() {
                    if (this.isPlaying) return;

                    if (this.audioContext?.state === "suspended") {
                        await this.audioContext.resume();
                    }

                    this.isPlaying = true;
                    await this.playSound(this.bellBuffer);
                    this.scheduleNextBell();
                }

                async scheduleNextBell() {
                    if (!this.isPlaying) return;

                    this.loopTimeout = setTimeout(async () => {
                        if (this.isPlaying) {
                            await this.playSound(this.bellBuffer, 0.15);
                            this.scheduleNextBell();
                        }
                    }, 3000);
                }

                stopBellSequence() {
                    this.isPlaying = false;
                    if (this.loopTimeout) {
                        clearTimeout(this.loopTimeout);
                        this.loopTimeout = null;
                    }
                }

                async playResponseSound() {
                    await this.playSound(this.responseBuffer, 0.2);
                }

                setVolume(volume) {
                    this.volume = volume;
                }

                mute() {
                    this.volume = 0;
                    localStorage.setItem("soundEnabled", "off");
                }

                unmute() {
                    this.volume = 0.3;
                    localStorage.setItem("soundEnabled", "on");
                }
            }

            const soundManager = new SoundManager();

            // Get icon for agent type
            function getIconForAgentType(type) {
                const iconMap = {
                    "Dynamics365CRUD": "fa-database",
                    "EmailDrafting": "fa-envelope",
                    "ManageMemory": "fa-brain",
                    "ContextMemory": "fa-memory",
                    "custom": "fa-cog"
                };
                
                return iconMap[type] || "fa-robot";
            }

            // Format response text with markdown and code highlighting
            function formatResponse(text) {
                if (!text) return '';
                
                if (text.trim().startsWith("{") || text.trim().startsWith("[")) {
                    try {
                        const json = JSON.parse(text);
                        return `<pre><code class="json">${JSON.stringify(json, null, 2)}</code></pre>`;
                    } catch (e) {
                        console.warn("JSON parsing failed:", e);
                    }
                }

                const codeBlocks = [];
                text = text.replace(/```(\w+)?\n([\s\S]+?)```/g, (match, language, code) => {
                    codeBlocks.push({
                        language: language || "",
                        code: code.trim(),
                    });
                    return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
                });

                text = text.replace(/\(URL: ([^)]+)\)/g, (match, url) => {
                    return `<a href="${url.trim()}" target="_blank" rel="noopener noreferrer">${url.trim()}</a>`;
                });

                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                    const decodedUrl = url.replace(/&amp;/g, "&");
                    return `<a href="${decodedUrl}" target="_blank" rel="noopener noreferrer">${text}</a>`;
                });

                text = text.replace(
                    /(?<!["\'])(https?:\/\/[^\s<>]+)(?![^<]*>|[^<>]*<\/)/g,
                    '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
                );

                text = text
                .replace(/`([^`]+)`/g, "<code>$1</code>")
                    .replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>")
                    .replace(/\*([^*]+)\*/g, "<em>$1</em>")
                    .replace(/\n/g, "<br>");

                text = text.replace(/__CODE_BLOCK_(\d+)__/g, (match, index) => {
                    const block = codeBlocks[parseInt(index)];
                    const highlightedCode = hljs.highlightAuto(
                        block.code,
                        block.language ? [block.language] : undefined
                    ).value;
                    return `<pre><code class="${block.language}">${highlightedCode}</code></pre>`;
                });

                return text;
            }

            // Show toast message
            function showToast(message, duration = 3000) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }

            // Add a command to the queue
            function addCommandToQueue(command, skill) {
                if (!command.trim()) return;
                
                appState.commandQueue.push(command);
                
                if (skill) {
                    appState.expectedSkills[appState.commandQueue.length - 1] = skill;
                }
                
                renderCommandQueue();
                document.getElementById("command-input").value = "";
                document.getElementById("skill-input").value = "";
                
                showToast("Command added to queue");
            }

            // Add an agent to the queue
            function addAgentToQueue(agentId) {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                const agent = workflow.agents.find(a => a.id === agentId);
                
                if (agent) {
                    addCommandToQueue(agent.command, agent.type);
                }
            }

            // Render the command queue
            function renderCommandQueue() {
                const queueList = document.getElementById('queue-list');
                const queueEmpty = document.getElementById('queue-empty');
                
                queueList.innerHTML = '';
                
                if (appState.commandQueue.length === 0) {
                    queueEmpty.style.display = 'block';
                    return;
                }
                
                queueEmpty.style.display = 'none';
                
                appState.commandQueue.forEach((command, index) => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'queue-item';
                    
                    if (appState.isProcessing && index === appState.currentQueueIndex) {
                        queueItem.classList.add('queue-item-processing');
                    }
                    
                    const expectedSkill = appState.expectedSkills[index] || '';
                    
                    queueItem.innerHTML = `
                        <div class="queue-item-number">${index + 1}</div>
                        <div class="queue-item-content">
                            <div class="queue-item-command">${command}</div>
                            ${expectedSkill ? `<div class="queue-item-skill">Expects: ${expectedSkill}</div>` : ''}
                        </div>
                        <div class="queue-item-actions">
                            <button class="queue-item-remove" data-index="${index}" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    queueList.appendChild(queueItem);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.queue-item-remove').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        removeFromQueue(index);
                    });
                });
            }

            // Remove a command from the queue
            function removeFromQueue(index) {
                if (index < 0 || index >= appState.commandQueue.length) return;
                
                appState.commandQueue.splice(index, 1);
                
                // Update expected skills
                const newExpectedSkills = {};
                Object.keys(appState.expectedSkills).forEach(key => {
                    const keyIndex = parseInt(key);
                    if (keyIndex < index) {
                        newExpectedSkills[keyIndex] = appState.expectedSkills[keyIndex];
                    } else if (keyIndex > index) {
                        newExpectedSkills[keyIndex - 1] = appState.expectedSkills[keyIndex];
                    }
                });
                
                appState.expectedSkills = newExpectedSkills;
                renderCommandQueue();
            }

            // Process a single command - this is the main function that connects to the backend
            async function processCommand(command, expectedSkill) {
                await soundManager.startBellSequence();
                
                try {
                    // Show a footer status
                    const footerStatus = document.getElementById('footer-status');
                    footerStatus.textContent = 'Processing request...';
                    
                    const response = await fetch(appState.apiUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-functions-key": appState.apiKey
                        },
                        body: JSON.stringify({
                            user_input: command,
                            conversation_history: appState.chatHistory,
                            user_guid: appState.userId
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            // API key is invalid
                            showAuthModal();
                            throw new Error("Authentication failed. Please check your API key.");
                        }
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Update user GUID if returned by the server
                    if (data.user_guid) {
                        appState.userId = data.user_guid;
                        localStorage.setItem('userGuid', data.user_guid);
                    }
                    
                    // Add to chat history
                    appState.chatHistory.push(
                        { role: "user", content: command },
                        { role: "assistant", content: data.assistant_response || data.text || "No response received" }
                    );
                    
                    // Reset footer status
                    footerStatus.textContent = 'Ready';
                    
                    soundManager.stopBellSequence();
                    await soundManager.playResponseSound();
                    
                    return data;
                } catch (error) {
                    soundManager.stopBellSequence();
                    document.getElementById('footer-status').textContent = 'Error: ' + error.message;
                    throw error;
                }
            }

            // Run the command queue
            async function runQueue() {
                if (appState.isProcessing || appState.commandQueue.length === 0) return;
                
                // Check if we have API credentials
                if (!appState.apiKey || !appState.apiUrl) {
                    showAuthModal();
                    return;
                }
                
                appState.isProcessing = true;
                appState.currentQueueIndex = 0;
                appState.queueResponses = [];
                
                const queueStatus = document.getElementById('queue-status');
                queueStatus.textContent = `Processing queue (1/${appState.commandQueue.length})...`;
                queueStatus.className = 'queue-status processing';
                
                renderCommandQueue();
                
                try {
                    for (let i = 0; i < appState.commandQueue.length; i++) {
                        appState.currentQueueIndex = i;
                        renderCommandQueue();
                        
                        queueStatus.textContent = `Processing queue (${i + 1}/${appState.commandQueue.length})...`;
                        
                        const command = appState.commandQueue[i];
                        const expectedSkill = appState.expectedSkills[i];
                        
                        // Process command using API
                        const response = await processCommand(command, expectedSkill);
                        appState.queueResponses.push(response);
                        
                        // Check for skill match if expected skill is specified
                        if (expectedSkill && response.agent_logs) {
                            const skillMatched = response.agent_logs.includes(`Performed ${expectedSkill}`);
                            
                            if (!skillMatched) {
                                const confirmContinue = confirm(`Command did not use the expected ${expectedSkill} skill. Continue with remaining commands?`);
                                
                                if (!confirmContinue) {
                                    break;
                                }
                            }
                        }
                    }
                    
                    queueStatus.textContent = `Queue completed successfully`;
                    queueStatus.className = 'queue-status success';
                    
                    // Show combined response
                    showQueueResponse(appState.queueResponses);
                } catch (error) {
                    console.error('Error running queue:', error);
                    queueStatus.textContent = `Error: ${error.message}`;
                    queueStatus.className = 'queue-status error';
                } finally {
                    appState.isProcessing = false;
                    appState.currentQueueIndex = -1;
                    renderCommandQueue();
                }
            }

            // Display the queue response
            function showQueueResponse(responses) {
                const queueResponse = document.getElementById('queue-response');
                const responseContent = document.getElementById('queue-response-content');
                
                responseContent.innerHTML = '';
                
                if (!responses || responses.length === 0) {
                    responseContent.innerHTML = '<div class="empty-response">No responses received</div>';
                    return;
                }
                
                responses.forEach((response, index) => {
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'response-item';
                    
                    const text = response.assistant_response || response.text || 'No response';
                    
                    responseDiv.innerHTML = `
                        <h4>Response ${index + 1}</h4>
                        <div class="response-text">${formatResponse(text)}</div>
                        ${response.agent_logs ? 
                            `<details>
                                <summary>Agent Logs</summary>
                                <div class="agent-logs">${formatResponse(response.agent_logs)}</div>
                            </details>` 
                            : ''}
                    `;
                    
                    responseContent.appendChild(responseDiv);
                });
                
                queueResponse.classList.remove('hidden');
                
                // Highlight code blocks
                responseContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
            
            // Run a workflow
            async function runWorkflow() {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                if (!workflow) {
                    showToast("Invalid workflow selected");
                    return;
                }
                
                // If it has a natural language description, use that as a single command
                if (workflow.nlDescription) {
                    try {
                        // Clear any previous response
                        document.getElementById('workflow-response').classList.add('hidden');
                        
                        const response = await processCommand(workflow.nlDescription);
                        
                        // Show workflow response
                        showWorkflowResponse([response]);
                        
                        // Update workflow lastRun timestamp
                        workflow.lastRun = new Date().toISOString();
                    } catch (error) {
                        console.error('Error running workflow:', error);
                        showToast(`Error running workflow: ${error.message}`);
                    }
                    return;
                }
                
                // Otherwise, run each agent in sequence
                if (!workflow.agents || workflow.agents.length === 0) {
                    showToast("No agents in this workflow to run");
                    return;
                }
                
                // Convert to command queue
                const result = workflowToCommandQueue(workflow);
                
                // Store current queue (to restore later)
                const previousQueue = [...appState.commandQueue];
                const previousSkills = {...appState.expectedSkills};
                
                try {
                    // Replace with workflow commands
                    appState.commandQueue = result.queue;
                    appState.expectedSkills = result.expectedSkills;
                    
                    // Run the queue
                    await runQueue();
                    
                    // Update workflow lastRun timestamp
                    workflow.lastRun = new Date().toISOString();
                } catch (error) {
                    console.error('Error running workflow:', error);
                    showToast(`Error running workflow: ${error.message}`);
                } finally {
                    // Restore previous queue
                    appState.commandQueue = previousQueue;
                    appState.expectedSkills = previousSkills;
                    renderCommandQueue();
                }
            }

            // Display workflow response
            function showWorkflowResponse(responses) {
                const workflowResponse = document.getElementById('workflow-response');
                const responseContent = document.getElementById('response-content');
                
                responseContent.innerHTML = '';
                
                if (!responses || responses.length === 0) {
                    responseContent.innerHTML = '<div class="empty-response">No responses received</div>';
                    return;
                }
                
                // Combine all responses
                const combinedResponse = document.createElement('div');
                
                responses.forEach((response, index) => {
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'response-item';
                    
                    const text = response.assistant_response || response.text || 'No response';
                    
                    responseDiv.innerHTML = `
                        <h4>Step ${index + 1}</h4>
                        <div class="response-text">${formatResponse(text)}</div>
                        ${response.agent_logs ? 
                            `<details>
                                <summary>Agent Logs</summary>
                                <div class="agent-logs">${formatResponse(response.agent_logs)}</div>
                            </details>` 
                            : ''}
                    `;
                    
                    combinedResponse.appendChild(responseDiv);
                });
                
                responseContent.appendChild(combinedResponse);
                workflowResponse.classList.remove('hidden');
                
                // Highlight code blocks
                responseContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
            
            // Convert workflow to command queue
            function convertWorkflowToQueue() {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                if (!workflow) {
                    showToast("Invalid workflow selected");
                    return;
                }
                
                // If it has a natural language description, use that as a single command
                if (workflow.nlDescription) {
                    // Confirm with the user
                    if (appState.commandQueue.length > 0) {
                        const confirmed = confirm("This will replace your current command queue. Continue?");
                        
                        if (!confirmed) {
                            return;
                        }
                    }
                    
                    appState.commandQueue = [workflow.nlDescription];
                    appState.expectedSkills = {};
                    
                    renderCommandQueue();
                    showToast(`Added workflow natural language command to queue`);
                    return;
                }
                
                if (!workflow.agents || workflow.agents.length === 0) {
                    showToast("No agents in this workflow to convert");
                    return;
                }
                
                const result = workflowToCommandQueue(workflow);
                
                // Confirm with the user
                if (appState.commandQueue.length > 0) {
                    const confirmed = confirm("This will replace your current command queue. Continue?");
                    
                    if (!confirmed) {
                        return;
                    }
                }
                
                appState.commandQueue = result.queue;
                appState.expectedSkills = result.expectedSkills;
                
                renderCommandQueue();
                showToast(`Converted workflow to ${result.queue.length} commands`);
            }
            
            // Helper function for topological sort of workflow agents
            function workflowToCommandQueue(workflow) {
                const queue = [];
                const expectedSkills = {};
                
                if (!workflow.agents || workflow.agents.length === 0) {
                    return { queue, expectedSkills };
                }
                
                // Create a map of agent IDs to their indices in the sorted order
                const agentOrder = {};
                const visited = new Set();
                let orderIndex = 0;
                
                // Helper function for topological sort
                function visit(agentId) {
                    if (visited.has(agentId)) return;
                    visited.add(agentId);
                    
                    // Find outgoing connections
                    const outgoingConnections = workflow.connections ? 
                        workflow.connections.filter(c => c.fromId === agentId) : [];
                        
                    for (const conn of outgoingConnections) {
                        visit(conn.toId);
                    }
                    
                    agentOrder[agentId] = orderIndex++;
                }
                
                // Start with agents that have no incoming connections
                const hasIncoming = new Set(workflow.connections ? 
                    workflow.connections.map(c => c.toId) : []);
                    
                for (const agent of workflow.agents) {
                    if (!hasIncoming.has(agent.id)) {
                        visit(agent.id);
                    }
                }
                
                // If there are still unvisited agents, visit them
                for (const agent of workflow.agents) {
                    visit(agent.id);
                }
                
                // Sort agents by their order (reversed to get correct execution order)
                const sortedAgents = [...workflow.agents]
                    .sort((a, b) => agentOrder[b.id] - agentOrder[a.id])
                    .reverse();
                
                // Convert each agent to a command
                sortedAgents.forEach((agent, index) => {
                    queue.push(agent.command);
                    
                    // Use agent type as expected skill
                    expectedSkills[index] = agent.type;
                });
                
                return { queue, expectedSkills };
            }
            
            // Convert command queue to workflow
            function convertQueueToWorkflow() {
                if (appState.commandQueue.length === 0) {
                    showToast("No commands in queue to convert");
                    return;
                }
                
                // If there's only one command, treat it as a natural language description
                if (appState.commandQueue.length === 1) {
                    const workflowName = prompt("Enter a name for the new workflow:", "New Workflow");
                    
                    if (!workflowName) return;
                    
                    // Generate a new workflow
                    const newWorkflowId = `workflow-${Date.now()}`;
                    
                    initialData.workflows[newWorkflowId] = {
                        id: newWorkflowId,
                        name: workflowName,
                        description: "Created from a natural language command",
                        created: new Date().toISOString(),
                        lastRun: null,
                        nlDescription: appState.commandQueue[0],
                        agents: [],
                        connections: []
                    };
                    
                    // Switch to the new workflow
                    appState.currentWorkflowId = newWorkflowId;
                    
                    // Update UI
                    updateWorkflowUI();
                    renderAgentList();
                    renderConnectionList();
                    
                    showToast("Command converted to new workflow");
                    return;
                }
                
                // Generate a new workflow
                const newWorkflowId = `workflow-${Date.now()}`;
                const newWorkflow = commandQueueToWorkflow(
                    appState.commandQueue, 
                    appState.expectedSkills,
                    { id: newWorkflowId, name: "Generated Workflow" }
                );
                
                // Add to workflows data
                initialData.workflows[newWorkflowId] = newWorkflow;
                
                // Switch to the new workflow
                appState.currentWorkflowId = newWorkflowId;
                
                // Update UI
                updateWorkflowUI();
                renderAgentList();
                renderConnectionList();
                
                showToast("Queue converted to new workflow");
            }
            
            // Helper function to convert queue to workflow
            function commandQueueToWorkflow(queue, expectedSkills, workflowTemplate) {
                // Start with a copy of the template
                const workflow = {
                    id: workflowTemplate?.id || `workflow-${Date.now()}`,
                    name: workflowTemplate?.name || "Generated Workflow",
                    description: workflowTemplate?.description || "Created from command queue",
                    created: workflowTemplate?.created || new Date().toISOString(),
                    lastRun: null,
                    agents: [],
                    connections: []
                };
                
                // Generate agents from the command queue
                queue.forEach((command, index) => {
                    const skill = expectedSkills[index] || "custom";
                    
                    // Create an agent ID
                    const agentId = `agent${index + 1}`;
                    
                    // Determine agent name based on command
                    let agentName = `Command ${index + 1}`;
                    if (command.length <= 40) {
                        agentName = command;
                    } else {
                        // Try to extract a meaningful name from the first part of the command
                        const firstSentence = command.split(/[.!?]/).shift();
                        if (firstSentence.length <= 40) {
                            agentName = firstSentence;
                        }
                    }
                    
                    // Create agent
                    const agent = {
                        id: agentId,
                        type: skill,
                        agentId: skill,
                        name: agentName,
                        description: command,
                        position: {
                            x: 100 + index * 300,
                            y: 120
                        },
                        command: command
                    };
                    
                    workflow.agents.push(agent);
                    
                    // Create connections (simple linear chain)
                    if (index > 0) {
                        const prevAgentId = `agent${index}`;
                        workflow.connections.push({
                            fromId: prevAgentId,
                            toId: agentId,
                            connectionPrompt: `Pass the results from Command ${index} to Command ${index + 1}`
                        });
                    }
                });
                
                return workflow;
            }

            // Open a specific workflow
            function openWorkflow(workflowId) {
                if (initialData.workflows[workflowId]) {
                    appState.currentWorkflowId = workflowId;
                    updateWorkflowUI();
                    renderAgentList();
                    renderConnectionList();
                    
                    // Hide any response containers
                    document.getElementById('workflow-response').classList.add('hidden');
                }
            }

            // Update workflow UI with current workflow data
            function updateWorkflowUI() {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                if (!workflow) return;
                
                document.getElementById('current-workflow-name').textContent = workflow.name;
                document.getElementById('current-workflow-description').textContent = workflow.description;
            }

            // Open the chat interface
            function openChat(title = "Magentic Assistant") {
                const chatContainer = document.getElementById('chat-container');
                chatContainer.style.display = 'flex';
                
                // Set chat title
                document.getElementById('chat-title-text').textContent = title;
                
                // Add initial assistant message if chat is empty
                if (document.getElementById('chat-messages').children.length === 0) {
                    addChatMessage("assistant", "Hi there! I'm the Magentic Assistant. How can I help you today?");
                }
                
                // Focus input
                document.getElementById('chat-input').focus();
            }

            // Add a message to the chat
            function addChatMessage(role, content) {
                const chatMessages = document.getElementById('chat-messages');
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${role}`;
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                
                // Format the content with markdown if it's an assistant message
                bubble.innerHTML = role === 'assistant' ? formatResponse(content) : content;
                
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Add to chat history array if not already there
                if (role === 'user' || role === 'assistant') {
                    const lastMessage = appState.chatHistory.length > 0 ? 
                        appState.chatHistory[appState.chatHistory.length - 1] : null;
                        
                    if (!lastMessage || lastMessage.role !== role || lastMessage.content !== content) {
                        appState.chatHistory.push({ role, content });
                    }
                }
            }

            // Send a chat message
            async function sendChatMessage(message) {
                if (!message.trim()) return;
                
                // Check if we have API credentials
                if (!appState.apiKey || !appState.apiUrl) {
                    showAuthModal();
                    return;
                }
                
                // Add user message to chat
                addChatMessage("user", message);
                
                // Clear input
                document.getElementById('chat-input').value = '';
                
                try {
                    // Show loading state
                    document.getElementById('chat-send').innerHTML = '<div class="loading-spinner"></div>';
                    
                    // Start sound effect
                    await soundManager.startBellSequence();
                    
                    // Send message to API
                    const response = await fetch(appState.apiUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-functions-key": appState.apiKey
                        },
                        body: JSON.stringify({
                            user_input: message,
                            conversation_history: appState.chatHistory,
                            user_guid: appState.userId,
                            chat_context: appState.chatContext
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            showAuthModal();
                            throw new Error("Authentication failed. Please check your API key.");
                        }
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Update user GUID if returned by the server
                    if (data.user_guid) {
                        appState.userId = data.user_guid;
                        localStorage.setItem('userGuid', data.user_guid);
                    }
                    
                    // Add assistant response
                    addChatMessage("assistant", data.assistant_response || data.text || "No response received");
                    
                    // Stop sound effect and play response sound
                    soundManager.stopBellSequence();
                    await soundManager.playResponseSound();
                } catch (error) {
                    console.error('Error sending chat message:', error);
                    
                    // Add error message to chat
                    addChatMessage("assistant", `I'm sorry, there was an error: ${error.message}`);
                    
                    // Stop sound effect
                    soundManager.stopBellSequence();
                } finally {
                    // Restore send button
                    document.getElementById('chat-send').innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }

            // Open edit workflow modal
            function openEditWorkflowModal() {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                if (!workflow) return;
                
                document.getElementById('workflow-name').value = workflow.name;
                document.getElementById('workflow-description').value = workflow.description;
                document.getElementById('workflow-nlp-description').value = workflow.nlDescription || '';
                
                document.getElementById('edit-workflow-modal').style.display = 'flex';
            }

            // Show the auth modal
            function showAuthModal() {
                document.getElementById('api-key').value = appState.apiKey || '';
                document.getElementById('api-endpoint').value = appState.apiUrl || 'http://localhost:7071/api/businessinsightbot_function';
                document.getElementById('auth-modal').style.display = 'flex';
            }

            // Open edit agent modal
            function openEditAgentModal(agentId) {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                const agent = workflow.agents.find(a => a.id === agentId);
                
                if (!agent) return;
                
                document.getElementById('agent-name').value = agent.name;
                document.getElementById('agent-description').value = agent.description;
                document.getElementById('agent-command').value = agent.command;
                document.getElementById('agent-type').value = agent.type;
                
                appState.editingAgentId = agentId;
                
                document.getElementById('edit-agent-modal').style.display = 'flex';
            }

            // Save edited workflow
            function saveEditedWorkflow() {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                if (!workflow) return;
                
                const name = document.getElementById('workflow-name').value.trim();
                const description = document.getElementById('workflow-description').value.trim();
                const nlDescription = document.getElementById('workflow-nlp-description').value.trim();
                
                if (!name) {
                    alert("Workflow name cannot be empty");
                    return;
                }
                
                workflow.name = name;
                workflow.description = description;
                workflow.nlDescription = nlDescription || null;
                
                updateWorkflowUI();
                
                document.getElementById('edit-workflow-modal').style.display = 'none';
                showToast("Workflow updated successfully");
            }

            // Save edited agent
            function saveEditedAgent() {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                const agent = workflow.agents.find(a => a.id === appState.editingAgentId);
                
                if (!agent) return;
                
                const name = document.getElementById('agent-name').value.trim();
                const description = document.getElementById('agent-description').value.trim();
                const command = document.getElementById('agent-command').value.trim();
                const type = document.getElementById('agent-type').value;
                
                if (!name || !command) {
                    alert("Agent name and command cannot be empty");
                    return;
                }
                
                agent.name = name;
                agent.description = description;
                agent.command = command;
                agent.type = type;
                
                renderAgentList();
                renderConnectionList();
                
                document.getElementById('edit-agent-modal').style.display = 'none';
                showToast("Agent updated successfully");
            }

            // Save API credentials
            function saveApiCredentials() {
                const apiKey = document.getElementById('api-key').value.trim();
                const apiEndpoint = document.getElementById('api-endpoint').value.trim();
                
                if (!apiEndpoint) {
                    alert("API endpoint cannot be empty");
                    return;
                }
                
                appState.apiKey = apiKey;
                appState.apiUrl = apiEndpoint;
                
                localStorage.setItem("functionKey", apiKey);
                localStorage.setItem("apiEndpoint", apiEndpoint);
                
                document.getElementById('auth-modal').style.display = 'none';
                showToast("API credentials saved successfully");
            }

            // Export workflow to JSON
            function exportWorkflow() {
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                if (!workflow) return;
                
                const jsonString = JSON.stringify(workflow, null, 2);
                
                // Set modal content
                document.getElementById('json-modal-title').textContent = "Export Workflow JSON";
                document.getElementById('json-content').value = jsonString;
                
                // Configure modal buttons
                const confirmBtn = document.getElementById('confirm-json-modal');
                confirmBtn.textContent = "Download";
                confirmBtn.onclick = function() {
                    // Create a blob and download the JSON
                    const blob = new Blob([jsonString], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `workflow-${workflow.id}-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    document.getElementById('json-modal').style.display = 'none';
                };
                
                // Show modal
                document.getElementById('json-modal').style.display = 'flex';
            }

            // Import workflow from JSON
            function importWorkflow() {
                document.getElementById('workflow-file-input').click();
            }

            // Handle workflow file import
            function handleWorkflowFileImport(file) {
                if (!file || file.type !== "application/json") {
                    alert("Please select a valid JSON file");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate workflow structure
                        if (!importedData.id || !importedData.name) {
                            throw new Error("Invalid workflow format");
                        }
                        
                        // Generate a new ID to avoid conflicts
                        const newId = `imported-${Date.now()}`;
                        importedData.id = newId;
                        
                        // Add to workflows
                        initialData.workflows[newId] = importedData;
                        
                        // Switch to the new workflow
                        appState.currentWorkflowId = newId;
                        updateWorkflowUI();
                        renderAgentList();
                        renderConnectionList();
                        
                        showToast("Workflow imported successfully");
                    } catch (error) {
                        console.error('Error importing workflow:', error);
                        alert(`Error importing workflow: ${error.message}`);
                    }
                };
                
                reader.readAsText(file);
            }

            // Export all data to JSON
            function exportAllData() {
                const exportData = {
                    version: initialData.version,
                    exportDate: new Date().toISOString(),
                    workflows: initialData.workflows
                };
                
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // Set modal content
                document.getElementById('json-modal-title').textContent = "Export All Data";
                document.getElementById('json-content').value = jsonString;
                
                // Configure modal buttons
                const confirmBtn = document.getElementById('confirm-json-modal');
                confirmBtn.textContent = "Download";
                confirmBtn.onclick = function() {
                    // Create a blob and download the JSON
                    const blob = new Blob([jsonString], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `magentic-Agents-export-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    document.getElementById('json-modal').style.display = 'none';
                };
                
                // Show modal
                document.getElementById('json-modal').style.display = 'flex';
            }

            // Import all data from JSON
            function importAllData() {
                document.getElementById('json-file-input').click();
            }

            // Handle all data file import
            function handleAllDataFileImport(file) {
                if (!file || file.type !== "application/json") {
                    alert("Please select a valid JSON file");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate structure
                        if (!importedData.version || !importedData.workflows) {
                            throw new Error("Invalid data format");
                        }
                        
                        // Confirm with user
                        const confirmed = confirm("This will replace all your workflows and data. Continue?");
                        
                        if (!confirmed) {
                            return;
                        }
                        
                        // Replace data
                        initialData.version = importedData.version;
                        initialData.workflows = importedData.workflows;
                        
                        // Update UI
                        updateWorkflowUI();
                        renderAgentList();
                        renderConnectionList();
                        
                        showToast("Data imported successfully");
                    } catch (error) {
                        console.error('Error importing data:', error);
                        alert(`Error importing data: ${error.message}`);
                    }
                };
                
                reader.readAsText(file);
            }

            // Create new workflow
            function createNewWorkflow() {
                const name = prompt("Enter name for new workflow:");
                
                if (!name || !name.trim()) return;
                
                const newId = `workflow-${Date.now()}`;
                
                initialData.workflows[newId] = {
                    id: newId,
                    name: name.trim(),
                    description: "A new workflow",
                    created: new Date().toISOString(),
                    lastRun: null,
                    agents: [],
                    connections: []
                };
                
                appState.currentWorkflowId = newId;
                updateWorkflowUI();
                renderAgentList();
                renderConnectionList();
                
                // Open edit modal to allow setting up the natural language description
                openEditWorkflowModal();
                
                showToast("New workflow created");
            }

            // Toggle dark mode
            function toggleDarkMode() {
                appState.darkMode = !appState.darkMode;
                
                if (appState.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.querySelector('#theme-toggle i').classList.replace('fa-moon', 'fa-sun');
                    localStorage.setItem("theme", "dark");
                } else {
                    document.body.classList.remove('dark-mode');
                    document.querySelector('#theme-toggle i').classList.replace('fa-sun', 'fa-moon');
                    localStorage.setItem("theme", "light");
                }
            }

            // Render agent list
            function renderAgentList() {
                const agentList = document.getElementById('agent-list');
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                agentList.innerHTML = '';
                
                if (!workflow || !workflow.agents || workflow.agents.length === 0) {
                    agentList.innerHTML = '<div class="empty-message">No agents in this workflow</div>';
                    return;
                }
                
                workflow.agents.forEach(agent => {
                    const agentElement = document.createElement('div');
                    agentElement.className = 'agent-item';
                    agentElement.setAttribute('data-agent-id', agent.id);
                    agentElement.setAttribute('draggable', 'true');
                    
                    agentElement.innerHTML = `
                        <div class="agent-icon ${agent.type.toLowerCase()}-color">
                            <i class="fas ${getIconForAgentType(agent.type)}"></i>
                        </div>
                        <div class="agent-details">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-command">${agent.command}</div>
                        </div>
                        <div class="agent-actions">
                            <button class="button secondary icon-only agent-edit-btn" title="Edit Agent">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="button icon-only agent-add-to-queue-btn" title="Add to Queue">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;
                    
                    agentList.appendChild(agentElement);
                });
                
                // Add event listeners to agent buttons
                document.querySelectorAll('.agent-edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const agentId = e.target.closest('.agent-item').getAttribute('data-agent-id');
                        openEditAgentModal(agentId);
                    });
                });
                
                document.querySelectorAll('.agent-add-to-queue-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const agentId = e.target.closest('.agent-item').getAttribute('data-agent-id');
                        addAgentToQueue(agentId);
                    });
                });
            }

            // Render connection list
            function renderConnectionList() {
                const connectionList = document.getElementById('connection-list');
                const workflow = initialData.workflows[appState.currentWorkflowId];
                
                connectionList.innerHTML = '';
                
                if (!workflow || !workflow.connections || workflow.connections.length === 0) {
                    connectionList.innerHTML = '<div class="empty-message">No connections in this workflow</div>';
                    return;
                }
                
                workflow.connections.forEach(connection => {
                    const fromAgent = workflow.agents.find(a => a.id === connection.fromId);
                    const toAgent = workflow.agents.find(a => a.id === connection.toId);
                    
                    if (!fromAgent || !toAgent) return;
                    
                    const connectionElement = document.createElement('div');
                    connectionElement.className = 'connection-item';
                    
                    connectionElement.innerHTML = `
                        <div class="connection-from">${fromAgent.name}</div>
                        <div class="connection-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="connection-to">${toAgent.name}</div>
                    `;
                    
                    connectionList.appendChild(connectionElement);
                });
            }

            // Add event listeners for all elements
            function setupEventListeners() {
                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
                
                // Buttons in workflow section
                document.getElementById('edit-workflow-btn').addEventListener('click', openEditWorkflowModal);
                document.getElementById('run-workflow-btn').addEventListener('click', runWorkflow);
                document.getElementById('export-workflow-btn').addEventListener('click', exportWorkflow);
                document.getElementById('import-workflow-btn').addEventListener('click', importWorkflow);
                document.getElementById('convert-to-queue-btn').addEventListener('click', convertWorkflowToQueue);
                document.getElementById('create-workflow-btn').addEventListener('click', createNewWorkflow);
                
                // Buttons in queue section
                document.getElementById('add-command-btn').addEventListener('click', () => {
                    const command = document.getElementById('command-input').value.trim();
                    const skill = document.getElementById('skill-input').value;
                    
                    if (command) {
                        addCommandToQueue(command, skill);
                    } else {
                        alert("Please enter a command");
                    }
                });
                
                document.getElementById('run-queue-btn').addEventListener('click', runQueue);
                document.getElementById('clear-queue-btn').addEventListener('click', () => {
                    if (appState.commandQueue.length === 0) return;
                    
                    if (confirm("Are you sure you want to clear the queue?")) {
                        appState.commandQueue = [];
                        appState.expectedSkills = {};
                        renderCommandQueue();
                    }
                });
                
                document.getElementById('convert-to-workflow-btn').addEventListener('click', convertQueueToWorkflow);
                
                // Modal event listeners
                document.getElementById('close-edit-workflow').addEventListener('click', () => {
                    document.getElementById('edit-workflow-modal').style.display = 'none';
                });
                
                document.getElementById('cancel-edit-workflow').addEventListener('click', () => {
                    document.getElementById('edit-workflow-modal').style.display = 'none';
                });
                
                document.getElementById('save-edit-workflow').addEventListener('click', saveEditedWorkflow);
                
                document.getElementById('close-edit-agent').addEventListener('click', () => {
                    document.getElementById('edit-agent-modal').style.display = 'none';
                });
                
                document.getElementById('cancel-edit-agent').addEventListener('click', () => {
                    document.getElementById('edit-agent-modal').style.display = 'none';
                });
                
                document.getElementById('save-edit-agent').addEventListener('click', saveEditedAgent);
                
                document.getElementById('close-json-modal').addEventListener('click', () => {
                    document.getElementById('json-modal').style.display = 'none';
                });
                
                document.getElementById('cancel-json-modal').addEventListener('click', () => {
                    document.getElementById('json-modal').style.display = 'none';
                });
                
                // Auth modal
                document.getElementById('save-api-key').addEventListener('click', saveApiCredentials);
                
                // Chat event listeners
                document.getElementById('open-chat-btn').addEventListener('click', () => {
                    openChat("Workflow Chat");
                });
                
                document.getElementById('queue-open-chat-btn').addEventListener('click', () => {
                    openChat("Queue Chat");
                });
                
                document.getElementById('open-main-chat-btn').addEventListener('click', () => {
                    openChat("Magentic Assistant");
                });
                
                document.getElementById('chat-close').addEventListener('click', () => {
                    document.getElementById('chat-container').style.display = 'none';
                });
                
                document.getElementById('chat-send').addEventListener('click', () => {
                    const message = document.getElementById('chat-input').value.trim();
                    if (message) {
                        sendChatMessage(message);
                    }
                });
                
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const message = e.target.value.trim();
                        if (message) {
                            sendChatMessage(message);
                        }
                    }
                });
                
                // Auto-resize chat input as user types
                document.getElementById('chat-input').addEventListener('input', (e) => {
                    const textarea = e.target;
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
                });
                
                // Footer buttons
                document.getElementById('export-json-btn').addEventListener('click', exportAllData);
                document.getElementById('import-json-btn').addEventListener('click', importAllData);
                
                // File inputs
                document.getElementById('workflow-file-input').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleWorkflowFileImport(e.target.files[0]);
                        e.target.value = '';
                    }
                });
                
                document.getElementById('json-file-input').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleAllDataFileImport(e.target.files[0]);
                        e.target.value = '';
                    }
                });
                
                // App store items
                document.querySelectorAll('.app-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const workflowId = item.dataset.workflowId;
                        
                        if (initialData.workflows[workflowId]) {
                            openWorkflow(workflowId);
                            
                            // Scroll workflow section into view on mobile
                            if (window.innerWidth <= 768) {
                                document.querySelector('.workflow-container').scrollIntoView({
                                    behavior: 'smooth'
                                });
                            }
                        }
                    });
                });

                // Drop zone for file imports
                const dropZone = document.getElementById('drop-zone');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    document.body.addEventListener(eventName, () => {
                        dropZone.classList.add('active');
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    document.body.addEventListener(eventName, () => {
                        dropZone.classList.remove('active');
                    });
                });
                
                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        // Check the file type to determine what import function to use
                        const file = files[0];
                        
                        if (file.type === 'application/json') {
                            // Ask user what type of import they want
                            const importType = confirm('Import as a workflow (OK) or as complete data (Cancel)?');
                            
                            if (importType) {
                                handleWorkflowFileImport(file);
                            } else {
                                handleAllDataFileImport(file);
                            }
                        } else {
                            alert('Please drop a JSON file');
                        }
                    }
                });
                
                // Enter key on command input
                document.getElementById('command-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        const command = e.target.value.trim();
                        const skill = document.getElementById('skill-input').value;
                        
                        if (command) {
                            addCommandToQueue(command, skill);
                        }
                    }
                });
            }

            // Initialize the application
            function init() {
                // Initialize dark mode based on saved preference
                if (appState.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.querySelector('#theme-toggle i').classList.replace('fa-moon', 'fa-sun');
                }
                
                // Initialize UI
                updateWorkflowUI();
                renderAgentList();
                renderConnectionList();
                renderCommandQueue();
                
                // Setup event listeners
                setupEventListeners();
                
                // Check if API auth is needed
                if (!appState.apiKey || !appState.apiUrl) {
                    showAuthModal();
                }
                
                // Log initialization complete
                console.log('Magic Agents initialized!');
                
                // Show welcome toast
                showToast("Welcome to Magic Agents! Connect to the backend to get started.");
            }

            // Start initialization
            init();
        });
    </script>
</body>
</html>