<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser VM - Azure Function with Hacker News API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .azure-badge {
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .hn-badge {
            background: #ff6600;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-indicator.azure {
            background: #0078d4;
        }

        .status-indicator.hn {
            background: #ff6600;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            width: 450px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal {
            flex: 1;
            background: #000;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-y: auto;
            min-height: 400px;
            max-height: 500px;
            color: #0f0;
            text-shadow: 0 0 3px #0f0;
        }

        .terminal-line {
            margin: 2px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .terminal-line.azure {
            color: #00d4ff;
        }

        .terminal-line.http {
            color: #ffeb3b;
        }

        .terminal-line.success {
            color: #4caf50;
        }

        .terminal-line.error {
            color: #ff6b6b;
        }

        .terminal-line.hn {
            color: #ff6600;
        }

        .terminal-input {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .terminal-prompt {
            color: #4caf50;
            margin-right: 10px;
        }

        input[type="text"] {
            flex: 1;
            background: transparent;
            border: none;
            color: #0f0;
            font-family: inherit;
            font-size: 13px;
            outline: none;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.azure {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
        }

        button.hn {
            background: linear-gradient(135deg, #ff6600 0%, #ff4500 100%);
        }

        button.running {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .azure-function-panel {
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.2) 0%, rgba(0, 90, 158, 0.2) 100%);
        }

        .function-endpoint {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            font-size: 12px;
        }

        .endpoint-url {
            color: #00d4ff;
            word-break: break-all;
            margin-top: 5px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            font-family: monospace;
        }

        .code-viewer {
            background: #1e1e1e;
            border-radius: 5px;
            padding: 15px;
            max-height: 350px;
            overflow-y: auto;
            font-size: 11px;
        }

        .code-line {
            margin: 2px 0;
            font-family: 'Courier New', monospace;
            white-space: pre;
        }

        .code-keyword {
            color: #569cd6;
        }

        .code-string {
            color: #ce9178;
        }

        .code-comment {
            color: #6a9955;
        }

        .code-function {
            color: #dcdcaa;
        }

        .code-number {
            color: #b5cea8;
        }

        .test-panel {
            margin-top: 15px;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .test-select {
            flex: 1;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 4px;
        }

        .test-input {
            width: 80px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 4px;
        }

        .response-viewer {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .story-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid #ff6600;
        }

        .story-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .story-meta {
            font-size: 11px;
            color: #aaa;
        }

        .story-meta span {
            margin-right: 10px;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loader.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .metric-item {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #00d4ff;
        }

        .metric-label {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .right-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            üñ•Ô∏è Browser VM - Docker 
            <span class="azure-badge">AZURE FUNCTIONS</span>
            <span class="hn-badge">HACKER NEWS API</span>
        </h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>VM Status: <span id="vmStatus">Ready</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator azure"></div>
                <span>Azure Function: <span id="functionStatus">Not Deployed</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator hn"></div>
                <span>HN API: <span id="hnStatus">Ready</span></span>
            </div>
            <div class="status-item">
                <span>Runtime: Node.js 18 LTS</span>
            </div>
            <div class="status-item">
                <span>Container: <span id="containerStatus">Stopped</span></span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="panel">
                <h3>üñ•Ô∏è Container Terminal</h3>
                <div class="terminal" id="terminal">
                    <div class="terminal-line">Browser VM with Azure Functions Runtime</div>
                    <div class="terminal-line">WebAssembly-powered Docker environment initialized</div>
                    <div class="terminal-line">Hacker News API integration ready...</div>
                </div>
                <div class="terminal-input">
                    <span class="terminal-prompt">azurevm@browser:~$</span>
                    <input type="text" id="terminalInput" placeholder="Enter command...">
                </div>
            </div>

            <div class="panel">
                <h3>üìù Azure Function Code - Hacker News API</h3>
                <div class="code-viewer" id="codeViewer"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel azure-function-panel">
                <h3>‚ö° Azure Function Deployment</h3>
                <div class="controls">
                    <button onclick="buildDockerImage()" id="buildBtn" class="azure">Build Image</button>
                    <button onclick="deployFunction()" id="deployBtn" class="azure">Deploy Function</button>
                    <button onclick="startContainer()" id="startBtn">Start Container</button>
                    <button onclick="stopContainer()" id="stopBtn">Stop Container</button>
                </div>
                <div class="loader" id="loader">
                    <div class="spinner"></div>
                    <p>Deploying Azure Function...</p>
                </div>
                <div class="function-endpoint" id="functionEndpoint" style="display: none;">
                    <strong>Function Endpoint:</strong>
                    <div class="endpoint-url" id="endpointUrl">http://localhost:7071/api/hackernews</div>
                </div>
            </div>

            <div class="panel">
                <h3>üß™ Test Hacker News Function</h3>
                <div class="test-panel">
                    <div class="test-controls">
                        <select class="test-select" id="storyType">
                            <option value="top">Top Stories</option>
                            <option value="new">New Stories</option>
                            <option value="best">Best Stories</option>
                            <option value="ask">Ask HN</option>
                            <option value="show">Show HN</option>
                            <option value="job">Jobs</option>
                        </select>
                        <input type="number" class="test-input" id="storyLimit" placeholder="Limit" value="5" min="1" max="50">
                    </div>
                    <button onclick="testFunction()" id="testBtn" style="width: 100%;" class="hn">Fetch Stories</button>
                    <div class="response-viewer" id="responseViewer" style="display: none;">
                        <strong>Response:</strong>
                        <div id="responseContent"></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üìä Function Metrics</h3>
                <div class="metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="requestCount">0</div>
                        <div class="metric-label">API Requests</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avgResponseTime">0ms</div>
                        <div class="metric-label">Avg Response Time</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="storiesFetched">0</div>
                        <div class="metric-label">Stories Fetched</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="cacheHitRate">0%</div>
                        <div class="metric-label">Cache Hit Rate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Hacker News API Mock Data
        const mockHNData = {
            topStories: [30424069, 30423766, 30422955, 30421738, 30420834, 30419923, 30418812, 30417701, 30416590, 30415479],
            newStories: [30425180, 30425079, 30424968, 30424857, 30424746, 30424635, 30424524, 30424413, 30424302, 30424191],
            bestStories: [30420069, 30419766, 30418955, 30417738, 30416834, 30415923, 30414812, 30413701, 30412590, 30411479],
            askStories: [30422169, 30421866, 30421055, 30420838, 30419934, 30419023, 30417912, 30416801, 30415690, 30414579],
            showStories: [30423269, 30422966, 30422155, 30421938, 30421034, 30420123, 30419012, 30417901, 30416790, 30415679],
            jobStories: [30424369, 30424066, 30423255, 30423038, 30422134, 30421223, 30420112, 30419001, 30417890, 30416779],
            
            stories: {
                30424069: { id: 30424069, title: "Show HN: I built a WebAssembly runtime in the browser", url: "https://github.com/example/wasm-runtime", score: 342, by: "wasm_dev", time: 1645564800, descendants: 89, type: "story" },
                30423766: { id: 30423766, title: "Azure Functions now supports Node.js 18 LTS", url: "https://azure.microsoft.com/blog/nodejs18", score: 256, by: "azure_team", time: 1645561200, descendants: 67, type: "story" },
                30422955: { id: 30422955, title: "The state of serverless in 2025", url: "https://serverless.com/state-2025", score: 189, by: "serverless_fan", time: 1645557600, descendants: 45, type: "story" },
                30421738: { id: 30421738, title: "Ask HN: What's your favorite API to work with?", url: null, score: 156, by: "curious_dev", time: 1645554000, descendants: 234, type: "story" },
                30420834: { id: 30420834, title: "Docker announces new WASM integration features", url: "https://docker.com/wasm-integration", score: 298, by: "docker_news", time: 1645550400, descendants: 78, type: "story" },
                30419923: { id: 30419923, title: "Understanding Azure Functions pricing model", url: "https://docs.microsoft.com/azure/functions-pricing", score: 123, by: "cloud_expert", time: 1645546800, descendants: 34, type: "story" },
                30418812: { id: 30418812, title: "Building real-time applications with serverless", url: "https://realtime-serverless.io", score: 234, by: "realtime_dev", time: 1645543200, descendants: 56, type: "story" },
                30417701: { id: 30417701, title: "Microsoft's new AI-powered code assistant", url: "https://microsoft.com/ai-code", score: 567, by: "ms_insider", time: 1645539600, descendants: 123, type: "story" },
                30416590: { id: 30416590, title: "WebAssembly System Interface reaches 1.0", url: "https://wasi.dev/announcement", score: 445, by: "wasi_team", time: 1645536000, descendants: 99, type: "story" },
                30415479: { id: 30415479, title: "The future of cloud computing: Edge functions", url: "https://edge-computing.tech", score: 178, by: "edge_pioneer", time: 1645532400, descendants: 67, type: "story" }
            }
        };

        // Add more mock stories for other categories
        const additionalStories = {
            30425180: { id: 30425180, title: "New: GPT-5 capabilities leaked", url: "https://ai-news.com/gpt5", score: 892, by: "ai_leak", time: 1645568400, descendants: 456, type: "story" },
            30425079: { id: 30425079, title: "Breaking: Major security vulnerability in npm", url: "https://security.npm/alert", score: 723, by: "security_watch", time: 1645564800, descendants: 234, type: "story" },
            30424968: { id: 30424968, title: "Rust 2.0 roadmap announced", url: "https://rust-lang.org/roadmap", score: 456, by: "rust_team", time: 1645561200, descendants: 178, type: "story" },
            30422169: { id: 30422169, title: "Ask HN: Best practices for Azure Functions?", url: null, score: 89, by: "azure_newbie", time: 1645557600, descendants: 67, type: "story" },
            30423269: { id: 30423269, title: "Show HN: Real-time collaborative code editor", url: "https://collab-edit.io", score: 234, by: "collab_dev", time: 1645554000, descendants: 89, type: "story" },
            30424369: { id: 30424369, title: "Microsoft is hiring: Senior Azure Engineers", url: "https://careers.microsoft.com/azure", score: 156, by: "ms_hr", time: 1645550400, descendants: 45, type: "job" }
        };

        // Merge additional stories
        Object.assign(mockHNData.stories, additionalStories);

        // Azure Function VM Implementation with Hacker News API
        class AzureFunctionVM {
            constructor() {
                this.dockerImage = null;
                this.container = null;
                this.functionRuntime = null;
                this.isRunning = false;
                this.cache = new Map();
                this.cacheTimeout = 300000; // 5 minutes
                this.metrics = {
                    requests: 0,
                    totalResponseTime: 0,
                    errors: 0,
                    activeConnections: 0,
                    storiesFetched: 0,
                    cacheHits: 0,
                    cacheMisses: 0
                };
                
                this.initializeAzureRuntime();
            }

            initializeAzureRuntime() {
                this.functionRuntime = {
                    version: '4.0.5455',
                    nodeVersion: '18.17.1',
                    port: 7071,
                    functions: new Map()
                };
            }

            async buildDockerImage() {
                addTerminalLine('[Docker] Building Azure Functions image with HN API support...', 'azure');
                
                const dockerfile = `
FROM mcr.microsoft.com/azure-functions/node:4-node18
ENV AzureWebJobsScriptRoot=/home/site/wwwroot
ENV AzureFunctionsJobHost__Logging__Console__IsEnabled=true
COPY . /home/site/wwwroot
RUN cd /home/site/wwwroot && npm install
                `.trim();
                
                await this.simulateDelay(500);
                addTerminalLine('[Docker] Creating Dockerfile...');
                
                await this.simulateDelay(800);
                addTerminalLine('[Docker] Step 1/6 : FROM mcr.microsoft.com/azure-functions/node:4-node18');
                
                await this.simulateDelay(600);
                addTerminalLine('[Docker] Step 2/6 : ENV AzureWebJobsScriptRoot=/home/site/wwwroot');
                
                await this.simulateDelay(500);
                addTerminalLine('[Docker] Step 3/6 : COPY . /home/site/wwwroot');
                
                await this.simulateDelay(700);
                addTerminalLine('[Docker] Step 4/6 : RUN npm install');
                addTerminalLine('[npm] Installing dependencies...');
                addTerminalLine('[npm] + @azure/functions@4.0.0');
                addTerminalLine('[npm] + node-fetch@3.3.0');
                addTerminalLine('[npm] + axios@1.6.0');
                addTerminalLine('[npm] added 52 packages');
                
                await this.simulateDelay(500);
                addTerminalLine('[Docker] Step 5/6 : EXPOSE 7071');
                
                await this.simulateDelay(300);
                addTerminalLine('[Docker] Step 6/6 : CMD ["func", "start"]');
                
                const imageId = this.generateId().slice(0, 12);
                addTerminalLine(`[Docker] Successfully built ${imageId}`, 'success');
                addTerminalLine('[Docker] Successfully tagged azurefunc-hn:latest', 'success');
                
                this.dockerImage = {
                    id: imageId,
                    name: 'azurefunc-hn:latest',
                    size: '312MB',
                    created: new Date().toISOString()
                };
                
                return this.dockerImage;
            }

            async deployFunction() {
                if (!this.dockerImage) {
                    addTerminalLine('[Error] No Docker image found. Build image first.', 'error');
                    return;
                }
                
                addTerminalLine('[Azure] Deploying Hacker News API function...', 'azure');
                
                await this.simulateDelay(400);
                addTerminalLine('[Azure] Creating function.json configuration...');
                
                const functionConfig = {
                    bindings: [{
                        authLevel: "anonymous",
                        type: "httpTrigger",
                        direction: "in",
                        name: "req",
                        methods: ["get", "post"],
                        route: "hackernews"
                    }, {
                        type: "http",
                        direction: "out",
                        name: "res"
                    }]
                };
                
                await this.simulateDelay(300);
                addTerminalLine('[Azure] Registering HTTP trigger binding...');
                addTerminalLine('[Azure] Route: /api/hackernews', 'http');
                
                const functionCode = this.createHackerNewsFunction();
                this.functionRuntime.functions.set('HackerNewsAPI', functionCode);
                
                await this.simulateDelay(500);
                addTerminalLine('[Azure] Function app created successfully', 'success');
                addTerminalLine('[Azure] Hacker News API endpoint ready', 'success');
                addTerminalLine('[HN] Firebase API integration configured', 'hn');
                
                document.getElementById('functionStatus').textContent = 'Deployed';
                document.getElementById('functionEndpoint').style.display = 'block';
                
                return true;
            }

            async startContainer() {
                if (!this.dockerImage) {
                    addTerminalLine('[Error] No Docker image available', 'error');
                    return;
                }
                
                const containerId = this.generateId();
                addTerminalLine(`[Docker] Creating container from ${this.dockerImage.name}`);
                
                await this.simulateDelay(500);
                addTerminalLine(`[Docker] Container ID: ${containerId.slice(0, 12)}`);
                
                await this.simulateDelay(400);
                addTerminalLine('[Docker] Starting container...');
                
                this.container = {
                    id: containerId,
                    image: this.dockerImage.name,
                    status: 'running',
                    port: 7071
                };
                
                await this.simulateDelay(600);
                addTerminalLine('[Azure] Azure Functions Core Tools');
                addTerminalLine('[Azure] Core Tools Version: 4.0.5455');
                addTerminalLine('[Azure] Function Runtime Version: 4.27.5.21554');
                
                await this.simulateDelay(400);
                addTerminalLine('[Azure] Starting host...');
                
                await this.simulateDelay(500);
                addTerminalLine('[Host] Initializing function HTTP routes');
                addTerminalLine('[Host] Mapped function route: api/hackernews', 'http');
                addTerminalLine('[HN] Connecting to hacker-news.firebaseio.com', 'hn');
                
                await this.simulateDelay(300);
                addTerminalLine('[HN] API connection established', 'hn');
                addTerminalLine('[Host] Host started successfully', 'success');
                addTerminalLine('[Host] Listening on: http://localhost:7071', 'http');
                
                this.isRunning = true;
                document.getElementById('containerStatus').textContent = 'Running';
                document.getElementById('functionStatus').textContent = 'Active';
                document.getElementById('hnStatus').textContent = 'Connected';
                
                this.startMockServer();
                
                return this.container;
            }

            async stopContainer() {
                if (!this.container || !this.isRunning) {
                    addTerminalLine('[Error] No container running', 'error');
                    return;
                }
                
                addTerminalLine(`[Docker] Stopping container ${this.container.id.slice(0, 12)}...`);
                
                await this.simulateDelay(500);
                addTerminalLine('[Host] Stopping host...');
                addTerminalLine('[HN] Disconnecting from Hacker News API...', 'hn');
                
                await this.simulateDelay(300);
                addTerminalLine('[Host] Host stopped', 'success');
                addTerminalLine('[Docker] Container stopped', 'success');
                
                this.isRunning = false;
                this.container = null;
                document.getElementById('containerStatus').textContent = 'Stopped';
                document.getElementById('functionStatus').textContent = 'Inactive';
                document.getElementById('hnStatus').textContent = 'Disconnected';
            }

            createHackerNewsFunction() {
                return async (context, req) => {
                    const startTime = Date.now();
                    
                    try {
                        const storyType = req.query?.type || req.body?.type || 'top';
                        const limit = parseInt(req.query?.limit || req.body?.limit || '10');
                        
                        const validTypes = ['top', 'new', 'best', 'ask', 'show', 'job'];
                        const type = validTypes.includes(storyType) ? storyType : 'top';
                        
                        addTerminalLine(`[HN] Fetching ${type} stories (limit: ${limit})`, 'hn');
                        
                        // Check cache
                        const cacheKey = `${type}-${limit}`;
                        const cached = this.cache.get(cacheKey);
                        
                        if (cached && cached.timestamp > Date.now() - this.cacheTimeout) {
                            this.metrics.cacheHits++;
                            addTerminalLine('[Cache] Hit - returning cached data', 'success');
                            const responseTime = Date.now() - startTime;
                            this.updateMetrics(responseTime, true, 0);
                            return cached.data;
                        }
                        
                        this.metrics.cacheMisses++;
                        addTerminalLine('[Cache] Miss - fetching from API', 'http');
                        
                        // Simulate API call to Hacker News
                        await this.simulateDelay(300);
                        addTerminalLine(`[HN] GET https://hacker-news.firebaseio.com/v0/${type}stories.json`, 'http');
                        
                        const storyIds = mockHNData[`${type}Stories`] || mockHNData.topStories;
                        const limitedIds = storyIds.slice(0, Math.min(limit, 50));
                        
                        addTerminalLine(`[HN] Received ${storyIds.length} story IDs`, 'hn');
                        addTerminalLine(`[HN] Fetching details for ${limitedIds.length} stories...`, 'hn');
                        
                        const stories = [];
                        for (const id of limitedIds) {
                            await this.simulateDelay(50);
                            const story = mockHNData.stories[id] || this.generateMockStory(id);
                            stories.push({
                                id: story.id,
                                title: story.title,
                                url: story.url || `https://news.ycombinator.com/item?id=${story.id}`,
                                points: story.score,
                                author: story.by,
                                time: new Date(story.time * 1000).toISOString(),
                                commentCount: story.descendants || 0,
                                type: story.type
                            });
                        }
                        
                        addTerminalLine(`[HN] Successfully fetched ${stories.length} stories`, 'success');
                        
                        const response = {
                            source: 'Hacker News API',
                            storyType: type,
                            timestamp: new Date().toISOString(),
                            count: stories.length,
                            requestedLimit: limit,
                            stories: stories,
                            metadata: {
                                environment: 'Azure Functions',
                                runtime: 'Node.js 18',
                                apiVersion: 'v0',
                                cached: false,
                                executionTime: `${Date.now() - startTime}ms`
                            }
                        };
                        
                        // Cache the response
                        this.cache.set(cacheKey, {
                            data: {
                                status: 200,
                                body: response,
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Powered-By': 'Azure Functions',
                                    'X-HN-API': 'Firebase',
                                    'Cache-Control': 'public, max-age=300'
                                }
                            },
                            timestamp: Date.now()
                        });
                        
                        const responseTime = Date.now() - startTime;
                        this.updateMetrics(responseTime, true, stories.length);
                        
                        return {
                            status: 200,
                            body: response,
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Powered-By': 'Azure Functions',
                                'X-HN-API': 'Firebase',
                                'X-Response-Time': `${responseTime}ms`,
                                'Cache-Control': 'public, max-age=300'
                            }
                        };
                        
                    } catch (error) {
                        addTerminalLine(`[Error] ${error.message}`, 'error');
                        const responseTime = Date.now() - startTime;
                        this.updateMetrics(responseTime, false, 0);
                        
                        return {
                            status: 500,
                            body: {
                                error: 'Failed to fetch Hacker News stories',
                                message: error.message,
                                timestamp: new Date().toISOString()
                            },
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        };
                    }
                };
            }

            generateMockStory(id) {
                const titles = [
                    "Understanding WebAssembly performance",
                    "The future of edge computing",
                    "Building scalable microservices",
                    "Machine learning in production",
                    "Rust vs Go: Performance comparison"
                ];
                
                return {
                    id: id,
                    title: titles[Math.floor(Math.random() * titles.length)],
                    url: `https://example.com/story-${id}`,
                    score: Math.floor(Math.random() * 500) + 50,
                    by: `user_${Math.floor(Math.random() * 1000)}`,
                    time: Math.floor(Date.now() / 1000) - Math.floor(Math.random() * 86400),
                    descendants: Math.floor(Math.random() * 200),
                    type: "story"
                };
            }

            async invokeFunction(type, limit) {
                if (!this.isRunning) {
                    throw new Error('Container not running');
                }
                
                const func = this.functionRuntime.functions.get('HackerNewsAPI');
                if (!func) {
                    throw new Error('Function not found');
                }
                
                const context = {
                    invocationId: this.generateId(),
                    executionContext: {
                        invocationId: this.generateId(),
                        functionName: 'HackerNewsAPI',
                        functionDirectory: '/home/site/wwwroot/HackerNewsAPI'
                    },
                    bindings: {},
                    bindingData: {},
                    bindingDefinitions: [],
                    log: (msg) => addTerminalLine(`[Function] ${msg}`)
                };
                
                const req = {
                    query: { type, limit },
                    body: {},
                    headers: {
                        'content-type': 'application/json'
                    }
                };
                
                const result = await func(context, req);
                return result;
            }

            startMockServer() {
                setTimeout(() => {
                    if (this.isRunning) {
                        addTerminalLine('[Http] GET /api/hackernews => Ready', 'http');
                        addTerminalLine('[Http] Accepting parameters: type, limit', 'http');
                    }
                }, 1000);
            }

            updateMetrics(responseTime, success, storiesCount) {
                this.metrics.requests++;
                this.metrics.totalResponseTime += responseTime;
                this.metrics.storiesFetched += storiesCount;
                if (!success) this.metrics.errors++;
                
                document.getElementById('requestCount').textContent = this.metrics.requests;
                document.getElementById('storiesFetched').textContent = this.metrics.storiesFetched;
                
                const avgTime = Math.round(this.metrics.totalResponseTime / this.metrics.requests);
                document.getElementById('avgResponseTime').textContent = `${avgTime}ms`;
                
                const totalCacheRequests = this.metrics.cacheHits + this.metrics.cacheMisses;
                const cacheHitRate = totalCacheRequests > 0 
                    ? Math.round((this.metrics.cacheHits / totalCacheRequests) * 100)
                    : 0;
                document.getElementById('cacheHitRate').textContent = `${cacheHitRate}%`;
            }

            simulateDelay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            generateId() {
                return Array.from({length: 32}, () => 
                    Math.floor(Math.random() * 16).toString(16)
                ).join('');
            }
        }

        // Initialize Azure Function VM
        const azureVM = new AzureFunctionVM();

        // Initialize code viewer with Hacker News function
        function initializeCodeViewer() {
            const codeViewer = document.getElementById('codeViewer');
            const functionCode = `<div class="code-line"><span class="code-comment">// Azure Function: Hacker News API Integration</span></div>
<div class="code-line"><span class="code-keyword">module.exports</span> = <span class="code-keyword">async function</span> (context, req) {</div>
<div class="code-line">    <span class="code-keyword">try</span> {</div>
<div class="code-line">        <span class="code-comment">// Get query parameters</span></div>
<div class="code-line">        <span class="code-keyword">const</span> storyType = req.query.type || req.body?.type || <span class="code-string">'top'</span>;</div>
<div class="code-line">        <span class="code-keyword">const</span> limit = <span class="code-function">parseInt</span>(req.query.limit || req.body?.limit || <span class="code-string">'10'</span>);</div>
<div class="code-line">        </div>
<div class="code-line">        <span class="code-comment">// Validate story type</span></div>
<div class="code-line">        <span class="code-keyword">const</span> validTypes = [<span class="code-string">'top'</span>, <span class="code-string">'new'</span>, <span class="code-string">'best'</span>, <span class="code-string">'ask'</span>, <span class="code-string">'show'</span>, <span class="code-string">'job'</span>];</div>
<div class="code-line">        <span class="code-keyword">const</span> type = validTypes.<span class="code-function">includes</span>(storyType) ? storyType : <span class="code-string">'top'</span>;</div>
<div class="code-line">        </div>
<div class="code-line">        <span class="code-comment">// Fetch story IDs from Hacker News API</span></div>
<div class="code-line">        <span class="code-keyword">const</span> storyIdsResponse = <span class="code-keyword">await</span> <span class="code-function">fetch</span>(</div>
<div class="code-line">            <span class="code-string">\`https://hacker-news.firebaseio.com/v0/\${type}stories.json\`</span></div>
<div class="code-line">        );</div>
<div class="code-line">        </div>
<div class="code-line">        <span class="code-keyword">if</span> (!storyIdsResponse.ok) {</div>
<div class="code-line">            <span class="code-keyword">throw new</span> <span class="code-function">Error</span>(<span class="code-string">\`Failed to fetch: \${storyIdsResponse.status}\`</span>);</div>
<div class="code-line">        }</div>
<div class="code-line">        </div>
<div class="code-line">        <span class="code-keyword">const</span> storyIds = <span class="code-keyword">await</span> storyIdsResponse.<span class="code-function">json</span>();</div>
<div class="code-line">        <span class="code-keyword">const</span> limitedStoryIds = storyIds.<span class="code-function">slice</span>(<span class="code-number">0</span>, Math.<span class="code-function">min</span>(limit, <span class="code-number">50</span>));</div>
<div class="code-line">        </div>
<div class="code-line">        <span class="code-comment">// Fetch story details in parallel</span></div>
<div class="code-line">        <span class="code-keyword">const</span> storyPromises = limitedStoryIds.<span class="code-function">map</span>(<span class="code-keyword">async</span> (id) => {</div>
<div class="code-line">            <span class="code-keyword">const</span> storyResponse = <span class="code-keyword">await</span> <span class="code-function">fetch</span>(</div>
<div class="code-line">                <span class="code-string">\`https://hacker-news.firebaseio.com/v0/item/\${id}.json\`</span></div>
<div class="code-line">            );</div>
<div class="code-line">            <span class="code-keyword">const</span> story = <span class="code-keyword">await</span> storyResponse.<span class="code-function">json</span>();</div>
<div class="code-line">            </div>
<div class="code-line">            <span class="code-keyword">return</span> {</div>
<div class="code-line">                id: story.id,</div>
<div class="code-line">                title: story.title,</div>
<div class="code-line">                url: story.url || <span class="code-string">\`https://news.ycombinator.com/item?id=\${story.id}\`</span>,</div>
<div class="code-line">                points: story.score,</div>
<div class="code-line">                author: story.by,</div>
<div class="code-line">                time: <span class="code-keyword">new</span> <span class="code-function">Date</span>(story.time * <span class="code-number">1000</span>).<span class="code-function">toISOString</span>(),</div>
<div class="code-line">                commentCount: story.descendants || <span class="code-number">0</span>,</div>
<div class="code-line">                type: story.type</div>
<div class="code-line">            };</div>
<div class="code-line">        });</div>
<div class="code-line">        </div>
<div class="code-line">        <span class="code-keyword">const</span> stories = <span class="code-keyword">await</span> Promise.<span class="code-function">all</span>(storyPromises);</div>
<div class="code-line">        </div>
<div class="code-line">        context.res = {</div>
<div class="code-line">            status: <span class="code-number">200</span>,</div>
<div class="code-line">            body: {</div>
<div class="code-line">                source: <span class="code-string">'Hacker News API'</span>,</div>
<div class="code-line">                storyType: type,</div>
<div class="code-line">                timestamp: <span class="code-keyword">new</span> <span class="code-function">Date</span>().<span class="code-function">toISOString</span>(),</div>
<div class="code-line">                count: stories.length,</div>
<div class="code-line">                stories: stories</div>
<div class="code-line">            },</div>
<div class="code-line">            headers: { <span class="code-string">'Content-Type'</span>: <span class="code-string">'application/json'</span> }</div>
<div class="code-line">        };</div>
<div class="code-line">    } <span class="code-keyword">catch</span> (error) {</div>
<div class="code-line">        context.res = {</div>
<div class="code-line">            status: <span class="code-number">500</span>,</div>
<div class="code-line">            body: { error: error.message }</div>
<div class="code-line">        };</div>
<div class="code-line">    }</div>
<div class="code-line">};`;
            
            codeViewer.innerHTML = functionCode;
        }

        // Terminal output helper
        function addTerminalLine(text, className = '') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Control functions
        async function buildDockerImage() {
            const btn = document.getElementById('buildBtn');
            btn.disabled = true;
            btn.textContent = 'Building...';
            
            await azureVM.buildDockerImage();
            
            btn.disabled = false;
            btn.textContent = 'Build Image';
        }

        async function deployFunction() {
            const btn = document.getElementById('deployBtn');
            const loader = document.getElementById('loader');
            
            btn.disabled = true;
            loader.classList.add('active');
            
            await azureVM.deployFunction();
            
            loader.classList.remove('active');
            btn.disabled = false;
        }

        async function startContainer() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.classList.add('running');
            btn.textContent = 'Starting...';
            
            await azureVM.startContainer();
            
            btn.disabled = false;
            btn.classList.remove('running');
            btn.textContent = 'Start Container';
            document.getElementById('stopBtn').disabled = false;
        }

        async function stopContainer() {
            const btn = document.getElementById('stopBtn');
            btn.disabled = true;
            
            await azureVM.stopContainer();
            
            btn.disabled = false;
            document.getElementById('startBtn').disabled = false;
        }

        async function testFunction() {
            if (!azureVM.isRunning) {
                addTerminalLine('[Error] Container not running. Start the container first.', 'error');
                return;
            }
            
            const type = document.getElementById('storyType').value;
            const limit = document.getElementById('storyLimit').value;
            const btn = document.getElementById('testBtn');
            
            btn.disabled = true;
            btn.textContent = 'Fetching...';
            
            addTerminalLine(`[Http] GET /api/hackernews?type=${type}&limit=${limit}`, 'http');
            addTerminalLine(`[Function] Executing 'HackerNewsAPI' (ID: ${azureVM.generateId().slice(0, 8)})`);
            
            try {
                const response = await azureVM.invokeFunction(type, limit);
                
                addTerminalLine(`[Function] Executed 'HackerNewsAPI' (Succeeded)`, 'success');
                addTerminalLine(`[Http] Response: 200 OK`, 'http');
                
                // Display response
                document.getElementById('responseViewer').style.display = 'block';
                const responseContent = document.getElementById('responseContent');
                responseContent.innerHTML = '';
                
                // Display stories in a nice format
                if (response.body.stories && response.body.stories.length > 0) {
                    response.body.stories.forEach(story => {
                        const storyDiv = document.createElement('div');
                        storyDiv.className = 'story-item';
                        storyDiv.innerHTML = `
                            <div class="story-title">${story.title}</div>
                            <div class="story-meta">
                                <span>üìä ${story.points} points</span>
                                <span>üë§ ${story.author}</span>
                                <span>üí¨ ${story.commentCount} comments</span>
                            </div>
                        `;
                        responseContent.appendChild(storyDiv);
                    });
                } else {
                    responseContent.innerHTML = '<pre>' + JSON.stringify(response.body, null, 2) + '</pre>';
                }
                
            } catch (error) {
                addTerminalLine(`[Error] ${error.message}`, 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Fetch Stories';
        }

        // Terminal command handler
        document.getElementById('terminalInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const command = this.value.trim();
                if (command) {
                    addTerminalLine(`azurevm@browser:~$ ${command}`);
                    
                    switch(command) {
                        case 'func --version':
                            addTerminalLine('Azure Functions Core Tools 4.0.5455');
                            break;
                        case 'node --version':
                            addTerminalLine('v18.17.1');
                            break;
                        case 'npm --version':
                            addTerminalLine('9.6.7');
                            break;
                        case 'docker ps':
                            if (azureVM.container && azureVM.isRunning) {
                                addTerminalLine(`CONTAINER ID   IMAGE                  STATUS`);
                                addTerminalLine(`${azureVM.container.id.slice(0,12)}   azurefunc-hn:latest   running`);
                            } else {
                                addTerminalLine('No containers running');
                            }
                            break;
                        case 'docker images':
                            if (azureVM.dockerImage) {
                                addTerminalLine(`REPOSITORY      TAG      SIZE`);
                                addTerminalLine(`azurefunc-hn    latest   ${azureVM.dockerImage.size}`);
                            } else {
                                addTerminalLine('No images available');
                            }
                            break;
                        case 'func start':
                            if (azureVM.isRunning) {
                                addTerminalLine('Azure Functions host is already running');
                            } else {
                                addTerminalLine('Starting Azure Functions host...');
                                await startContainer();
                            }
                            break;
                        case 'func stop':
                            if (azureVM.isRunning) {
                                await stopContainer();
                            } else {
                                addTerminalLine('No Functions host running');
                            }
                            break;
                        case 'curl localhost:7071/api/hackernews':
                            if (azureVM.isRunning) {
                                addTerminalLine('Fetching from localhost:7071/api/hackernews...');
                                await testFunction();
                            } else {
                                addTerminalLine('curl: (7) Failed to connect to localhost port 7071');
                            }
                            break;
                        case 'help':
                            addTerminalLine('Available commands:');
                            addTerminalLine('  func --version         Show Azure Functions version');
                            addTerminalLine('  func start            Start Functions runtime');
                            addTerminalLine('  func stop             Stop Functions runtime');
                            addTerminalLine('  node --version        Show Node.js version');
                            addTerminalLine('  npm --version         Show npm version');
                            addTerminalLine('  docker ps             List running containers');
                            addTerminalLine('  docker images         List Docker images');
                            addTerminalLine('  curl localhost:7071   Test the API endpoint');
                            addTerminalLine('  clear                 Clear terminal');
                            break;
                        case 'clear':
                            document.getElementById('terminal').innerHTML = '';
                            break;
                        default:
                            addTerminalLine(`Command not found: ${command}`);
                    }
                    
                    this.value = '';
                }
            }
        });

        // Initialize on load
        window.addEventListener('load', () => {
            initializeCodeViewer();
            setTimeout(() => {
                addTerminalLine('[System] Azure Functions VM with Hacker News API initialized');
                addTerminalLine('[System] Build ‚Üí Deploy ‚Üí Start to run the function');
                addTerminalLine('[System] Type "help" for available commands');
            }, 500);
        });

        // Add periodic health checks
        setInterval(() => {
            if (azureVM.isRunning && Math.random() > 0.7) {
                addTerminalLine(`[Health] Function app health check: Healthy`);
                if (Math.random() > 0.5) {
                    addTerminalLine(`[HN] API connection status: Active`, 'hn');
                }
            }
        }, 30000);
    </script>
</body>
</html>