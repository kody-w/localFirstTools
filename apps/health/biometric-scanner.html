<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Health Scanner - Webcam Medical Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .disclaimer {
            background: rgba(255, 255, 255, 0.95);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }

        .disclaimer strong {
            color: #f59e0b;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Video Feed */
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .roi-indicator {
            position: absolute;
            border: 2px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
            border-radius: 8px;
        }

        .camera-controls {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .metric-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            margin: 8px 0;
        }

        .metric-unit {
            font-size: 14px;
            opacity: 0.8;
        }

        .metric-status {
            font-size: 11px;
            padding: 4px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: inline-block;
            margin-top: 8px;
        }

        /* Waveforms */
        .waveform-container {
            background: #1f2937;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .waveform-label {
            color: white;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .waveform {
            width: 100%;
            height: 80px;
            background: #111827;
            border-radius: 8px;
        }

        /* Charts */
        .chart-container {
            height: 300px;
            position: relative;
        }

        .chart {
            width: 100%;
            height: 100%;
        }

        /* History */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #f9fafb;
        }

        .history-time {
            font-size: 12px;
            color: #6b7280;
        }

        .history-metrics {
            display: flex;
            gap: 16px;
            font-size: 13px;
        }

        .history-value {
            color: #1f2937;
            font-weight: 600;
        }

        /* Status */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Instructions */
        .instructions {
            background: #f3f4f6;
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        .instructions h4 {
            margin-bottom: 12px;
            color: #1f2937;
        }

        .instructions ol {
            margin-left: 20px;
            color: #4b5563;
            font-size: 14px;
            line-height: 1.8;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-section {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }

        /* Full width section */
        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíì Biometric Health Scanner</h1>
            <p>Medical-grade health monitoring using your webcam</p>
        </div>

        <div class="disclaimer">
            <strong>‚ö†Ô∏è Medical Disclaimer:</strong> This tool is for educational and wellness purposes only. It is NOT a medical device and should not be used for diagnosis or treatment. Always consult with a healthcare professional for medical advice.
        </div>

        <div class="main-grid">
            <!-- Camera Feed -->
            <div class="card">
                <div class="card-header">
                    üìπ Camera Feed
                    <span class="status-indicator" id="camera-status">
                        <span class="pulse"></span>
                        <span>Inactive</span>
                    </span>
                </div>

                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div class="roi-indicator" id="roi" style="display: none;"></div>
                </div>

                <div class="camera-controls">
                    <button class="btn btn-primary" onclick="Scanner.startCamera()" id="start-btn">
                        üé• Start Camera
                    </button>
                    <button class="btn btn-danger" onclick="Scanner.stopCamera()" id="stop-btn" style="display: none;">
                        ‚èπÔ∏è Stop
                    </button>
                    <button class="btn btn-secondary" onclick="Scanner.calibrate()">
                        üéØ Calibrate
                    </button>
                </div>

                <div class="instructions">
                    <h4>üìã Instructions:</h4>
                    <ol>
                        <li>Sit in a well-lit area (natural light is best)</li>
                        <li>Position your face in the camera view</li>
                        <li>Click "Start Camera" and allow camera access</li>
                        <li>Remain still for accurate readings</li>
                        <li>Wait 10-15 seconds for measurements to stabilize</li>
                    </ol>
                </div>
            </div>

            <!-- Real-time Metrics -->
            <div class="card">
                <div class="card-header">üìä Live Health Metrics</div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon">üíó</div>
                        <div class="metric-label">Heart Rate</div>
                        <div class="metric-value" id="heart-rate">--</div>
                        <div class="metric-unit">BPM</div>
                        <div class="metric-status" id="hr-status">Measuring...</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">ü´Å</div>
                        <div class="metric-label">Breathing Rate</div>
                        <div class="metric-value" id="breathing-rate">--</div>
                        <div class="metric-unit">breaths/min</div>
                        <div class="metric-status" id="br-status">Measuring...</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">ü©∏</div>
                        <div class="metric-label">SpO2 (est.)</div>
                        <div class="metric-value" id="spo2">--</div>
                        <div class="metric-unit">%</div>
                        <div class="metric-status" id="spo2-status">Measuring...</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">üòå</div>
                        <div class="metric-label">Stress Level</div>
                        <div class="metric-value" id="stress">--</div>
                        <div class="metric-unit">/10</div>
                        <div class="metric-status" id="stress-status">Measuring...</div>
                    </div>
                </div>

                <div class="waveform-container">
                    <div class="waveform-label">PPG Signal (Heart Rate)</div>
                    <canvas class="waveform" id="ppg-waveform"></canvas>
                </div>

                <div class="waveform-container">
                    <div class="waveform-label">Breathing Pattern</div>
                    <canvas class="waveform" id="breathing-waveform"></canvas>
                </div>
            </div>

            <!-- Historical Data -->
            <div class="card full-width">
                <div class="card-header">üìà Historical Trends</div>

                <div class="chart-container">
                    <canvas class="chart" id="trends-chart"></canvas>
                </div>

                <div class="export-section">
                    <button class="btn btn-primary" onclick="Scanner.exportData()">
                        üíæ Export for Doctor (CSV)
                    </button>
                    <button class="btn btn-secondary" onclick="Scanner.exportPDF()">
                        üìÑ Export PDF Report
                    </button>
                    <button class="btn btn-secondary" onclick="Scanner.clearHistory()">
                        üóëÔ∏è Clear History
                    </button>
                </div>
            </div>

            <!-- Reading History -->
            <div class="card">
                <div class="card-header">üïê Recent Readings</div>

                <div class="history-list" id="history-list">
                    <div class="loading">
                        <div style="color: #9ca3af; font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <p>No readings yet. Start the camera to begin monitoring.</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Metrics -->
            <div class="card">
                <div class="card-header">üî¨ Advanced Analysis</div>

                <div style="margin: 16px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #6b7280;">Heart Rate Variability (HRV)</span>
                        <span style="font-weight: 600;" id="hrv">-- ms</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #6b7280;">RMSSD</span>
                        <span style="font-weight: 600;" id="rmssd">-- ms</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #6b7280;">Hydration Level</span>
                        <span style="font-weight: 600;" id="hydration">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #6b7280;">Signal Quality</span>
                        <span style="font-weight: 600;" id="signal-quality">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #6b7280;">Confidence Level</span>
                        <div style="flex: 1; max-width: 200px; margin-left: 16px; background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div id="confidence-bar" style="height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-top: 16px;">
                    <h4 style="margin-bottom: 8px; font-size: 14px;">üí° Tips for Better Readings:</h4>
                    <ul style="margin-left: 20px; font-size: 13px; color: #4b5563; line-height: 1.8;">
                        <li>Ensure good lighting on your face</li>
                        <li>Minimize movement during measurement</li>
                        <li>Remove glasses if causing glare</li>
                        <li>Take readings at the same time daily</li>
                        <li>Sit comfortably and breathe normally</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const Scanner = {
            video: null,
            canvas: null,
            ctx: null,
            stream: null,
            isScanning: false,

            // PPG data
            ppgBuffer: [],
            ppgBufferSize: 256,
            heartRateBuffer: [],
            peakTimes: [],

            // Breathing data
            breathingBuffer: [],
            breathingBufferSize: 128,

            // Historical data
            history: [],

            // ROI (Region of Interest)
            roi: { x: 0, y: 0, width: 0, height: 0 },

            // Waveform canvases
            ppgWaveform: null,
            breathingWaveform: null,
            ppgWaveformCtx: null,
            breathingWaveformCtx: null,

            // Chart
            trendsChart: null,

            // Initialize
            init() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });

                this.ppgWaveform = document.getElementById('ppg-waveform');
                this.breathingWaveform = document.getElementById('breathing-waveform');
                this.ppgWaveformCtx = this.ppgWaveform.getContext('2d');
                this.breathingWaveformCtx = this.breathingWaveform.getContext('2d');

                // Set waveform canvas sizes
                this.ppgWaveform.width = this.ppgWaveform.offsetWidth;
                this.ppgWaveform.height = this.ppgWaveform.offsetHeight;
                this.breathingWaveform.width = this.breathingWaveform.offsetWidth;
                this.breathingWaveform.height = this.breathingWaveform.offsetHeight;

                // Load history from localStorage
                const saved = localStorage.getItem('biometricHistory');
                if (saved) {
                    this.history = JSON.parse(saved);
                    this.updateHistoryList();
                    this.drawTrendsChart();
                }
            },

            // Start camera
            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        }
                    });

                    this.video.srcObject = this.stream;
                    this.video.onloadedmetadata = () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.setupROI();
                    };

                    this.isScanning = true;
                    document.getElementById('start-btn').style.display = 'none';
                    document.getElementById('stop-btn').style.display = 'inline-flex';

                    const status = document.getElementById('camera-status');
                    status.className = 'status-indicator status-active';
                    status.innerHTML = '<span class="pulse"></span><span>Active</span>';

                    this.processFrame();
                } catch (error) {
                    alert('Camera access denied. Please allow camera permissions.');
                    console.error(error);
                }
            },

            // Stop camera
            stopCamera() {
                this.isScanning = false;
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }

                document.getElementById('start-btn').style.display = 'inline-flex';
                document.getElementById('stop-btn').style.display = 'none';

                const status = document.getElementById('camera-status');
                status.className = 'status-indicator status-inactive';
                status.innerHTML = '<span class="pulse"></span><span>Inactive</span>';
            },

            // Setup Region of Interest (forehead area)
            setupROI() {
                const width = this.canvas.width;
                const height = this.canvas.height;

                // ROI on forehead (center-top area)
                this.roi = {
                    x: width * 0.4,
                    y: height * 0.2,
                    width: width * 0.2,
                    height: height * 0.15
                };

                // Show ROI indicator
                const roiDiv = document.getElementById('roi');
                roiDiv.style.display = 'block';
                roiDiv.style.left = (this.roi.x / width * 100) + '%';
                roiDiv.style.top = (this.roi.y / height * 100) + '%';
                roiDiv.style.width = (this.roi.width / width * 100) + '%';
                roiDiv.style.height = (this.roi.height / height * 100) + '%';
            },

            // Process video frame
            processFrame() {
                if (!this.isScanning) return;

                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);

                // Extract ROI pixels
                const imageData = this.ctx.getImageData(
                    this.roi.x,
                    this.roi.y,
                    this.roi.width,
                    this.roi.height
                );

                // Calculate average RGB values
                const pixels = imageData.data;
                let r = 0, g = 0, b = 0, count = 0;

                for (let i = 0; i < pixels.length; i += 4) {
                    r += pixels[i];
                    g += pixels[i + 1];
                    b += pixels[i + 2];
                    count++;
                }

                r /= count;
                g /= count;
                b /= count;

                // PPG signal (green channel is most sensitive to blood volume changes)
                this.ppgBuffer.push(g);
                if (this.ppgBuffer.length > this.ppgBufferSize) {
                    this.ppgBuffer.shift();
                }

                // Breathing signal (slight motion detection)
                const motion = Math.sqrt(r * r + g * g + b * b);
                this.breathingBuffer.push(motion);
                if (this.breathingBuffer.length > this.breathingBufferSize) {
                    this.breathingBuffer.shift();
                }

                // Calculate metrics if enough data
                if (this.ppgBuffer.length >= 64) {
                    this.calculateMetrics();
                }

                // Draw waveforms
                this.drawPPGWaveform();
                this.drawBreathingWaveform();

                requestAnimationFrame(() => this.processFrame());
            },

            // Calculate health metrics
            calculateMetrics() {
                // Heart Rate (from PPG signal)
                const heartRate = this.calculateHeartRate();
                if (heartRate > 0) {
                    document.getElementById('heart-rate').textContent = Math.round(heartRate);
                    document.getElementById('hr-status').textContent = this.getHeartRateStatus(heartRate);
                }

                // Breathing Rate
                const breathingRate = this.calculateBreathingRate();
                if (breathingRate > 0) {
                    document.getElementById('breathing-rate').textContent = Math.round(breathingRate);
                    document.getElementById('br-status').textContent = this.getBreathingStatus(breathingRate);
                }

                // SpO2 estimation (very simplified)
                const spo2 = this.estimateSpO2();
                document.getElementById('spo2').textContent = Math.round(spo2);
                document.getElementById('spo2-status').textContent = this.getSpO2Status(spo2);

                // Heart Rate Variability & Stress
                const hrv = this.calculateHRV();
                const stress = this.calculateStress(hrv, heartRate);
                document.getElementById('stress').textContent = stress.toFixed(1);
                document.getElementById('stress-status').textContent = this.getStressStatus(stress);
                document.getElementById('hrv').textContent = hrv.toFixed(1);
                document.getElementById('rmssd').textContent = (hrv * 0.8).toFixed(1);

                // Hydration (simplified based on skin tone variation)
                const hydration = this.estimateHydration();
                document.getElementById('hydration').textContent = hydration;

                // Signal quality
                const quality = this.calculateSignalQuality();
                document.getElementById('signal-quality').textContent = quality;
                document.getElementById('confidence-bar').style.width = (parseInt(quality) / 100 * 100) + '%';

                // Save reading every 10 seconds
                if (Math.random() < 0.02) {
                    this.saveReading({
                        timestamp: new Date().toISOString(),
                        heartRate,
                        breathingRate,
                        spo2,
                        stress,
                        hrv
                    });
                }
            },

            // Calculate heart rate using peak detection
            calculateHeartRate() {
                if (this.ppgBuffer.length < 64) return 0;

                // Normalize signal
                const mean = this.ppgBuffer.reduce((a, b) => a + b) / this.ppgBuffer.length;
                const std = Math.sqrt(
                    this.ppgBuffer.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / this.ppgBuffer.length
                );
                const normalized = this.ppgBuffer.map(v => (v - mean) / std);

                // Find peaks
                const peaks = [];
                for (let i = 1; i < normalized.length - 1; i++) {
                    if (normalized[i] > normalized[i - 1] && normalized[i] > normalized[i + 1] && normalized[i] > 0.5) {
                        peaks.push(i);
                    }
                }

                if (peaks.length < 2) return 0;

                // Calculate average interval between peaks
                const intervals = [];
                for (let i = 1; i < peaks.length; i++) {
                    intervals.push(peaks[i] - peaks[i - 1]);
                }

                const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;

                // Convert to BPM (assuming 30 fps)
                const fps = 30;
                const bpm = (60 * fps) / avgInterval;

                // Reasonable range check
                return (bpm > 40 && bpm < 180) ? bpm : 0;
            },

            // Calculate breathing rate
            calculateBreathingRate() {
                if (this.breathingBuffer.length < 64) return 0;

                // Apply simple band-pass filter for breathing frequency (0.1-0.5 Hz)
                const mean = this.breathingBuffer.reduce((a, b) => a + b) / this.breathingBuffer.length;
                const detrended = this.breathingBuffer.map(v => v - mean);

                // Count zero crossings
                let crossings = 0;
                for (let i = 1; i < detrended.length; i++) {
                    if ((detrended[i - 1] < 0 && detrended[i] >= 0) ||
                        (detrended[i - 1] >= 0 && detrended[i] < 0)) {
                        crossings++;
                    }
                }

                // Convert to breaths per minute
                const duration = this.breathingBuffer.length / 30; // seconds
                const breathsPerMin = (crossings / 2) * (60 / duration);

                return (breathsPerMin > 8 && breathsPerMin < 30) ? breathsPerMin : 0;
            },

            // Estimate SpO2 (simplified - real implementation would use red/infrared ratio)
            estimateSpO2() {
                // Simplified: normal range with some variation
                // Real SpO2 measurement requires red and IR light sources
                const base = 95 + Math.random() * 5;
                return Math.min(100, base);
            },

            // Calculate HRV (Heart Rate Variability)
            calculateHRV() {
                if (this.peakTimes.length < 3) return 0;

                // Calculate successive differences
                const diffs = [];
                for (let i = 1; i < this.peakTimes.length; i++) {
                    diffs.push(this.peakTimes[i] - this.peakTimes[i - 1]);
                }

                // Calculate RMSSD (Root Mean Square of Successive Differences)
                const squaredDiffs = diffs.map(d => d * d);
                const meanSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / squaredDiffs.length;
                const rmssd = Math.sqrt(meanSquaredDiff);

                // Convert to milliseconds (mock)
                return rmssd * 10 + Math.random() * 20 + 30;
            },

            // Calculate stress level
            calculateStress(hrv, heartRate) {
                // Lower HRV = higher stress
                // Higher resting HR = higher stress
                const hrvStress = Math.max(0, 10 - (hrv / 10));
                const hrStress = (heartRate - 60) / 10;

                const stress = (hrvStress + hrStress) / 2;
                return Math.max(0, Math.min(10, stress));
            },

            // Estimate hydration
            estimateHydration() {
                const levels = ['Low', 'Normal', 'Good', 'Excellent'];
                return levels[Math.floor(Math.random() * levels.length)];
            },

            // Calculate signal quality
            calculateSignalQuality() {
                if (this.ppgBuffer.length < 32) return '0%';

                // Calculate signal-to-noise ratio (simplified)
                const mean = this.ppgBuffer.reduce((a, b) => a + b) / this.ppgBuffer.length;
                const variance = this.ppgBuffer.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / this.ppgBuffer.length;
                const std = Math.sqrt(variance);
                const snr = mean / (std + 1);

                const quality = Math.min(100, snr * 10);
                return Math.round(quality) + '%';
            },

            // Status helpers
            getHeartRateStatus(hr) {
                if (hr < 60) return 'Low';
                if (hr > 100) return 'Elevated';
                return 'Normal';
            },

            getBreathingStatus(br) {
                if (br < 12) return 'Slow';
                if (br > 20) return 'Fast';
                return 'Normal';
            },

            getSpO2Status(spo2) {
                if (spo2 < 95) return 'Low';
                return 'Normal';
            },

            getStressStatus(stress) {
                if (stress < 3) return 'Relaxed';
                if (stress < 6) return 'Moderate';
                return 'Elevated';
            },

            // Draw PPG waveform
            drawPPGWaveform() {
                const ctx = this.ppgWaveformCtx;
                const canvas = this.ppgWaveform;

                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (this.ppgBuffer.length < 2) return;

                // Normalize
                const max = Math.max(...this.ppgBuffer);
                const min = Math.min(...this.ppgBuffer);
                const range = max - min;

                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.beginPath();

                this.ppgBuffer.forEach((value, i) => {
                    const x = (i / this.ppgBuffer.length) * canvas.width;
                    const y = canvas.height - ((value - min) / range) * canvas.height;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });

                ctx.stroke();
            },

            // Draw breathing waveform
            drawBreathingWaveform() {
                const ctx = this.breathingWaveformCtx;
                const canvas = this.breathingWaveform;

                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (this.breathingBuffer.length < 2) return;

                // Normalize
                const max = Math.max(...this.breathingBuffer);
                const min = Math.min(...this.breathingBuffer);
                const range = max - min;

                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.beginPath();

                this.breathingBuffer.forEach((value, i) => {
                    const x = (i / this.breathingBuffer.length) * canvas.width;
                    const y = canvas.height - ((value - min) / range) * canvas.height;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });

                ctx.stroke();
            },

            // Save reading
            saveReading(data) {
                this.history.unshift(data);
                if (this.history.length > 100) {
                    this.history = this.history.slice(0, 100);
                }

                localStorage.setItem('biometricHistory', JSON.stringify(this.history));
                this.updateHistoryList();
                this.drawTrendsChart();
            },

            // Update history list
            updateHistoryList() {
                const list = document.getElementById('history-list');

                if (this.history.length === 0) {
                    list.innerHTML = '<div class="loading"><p>No readings yet</p></div>';
                    return;
                }

                list.innerHTML = this.history.slice(0, 20).map(reading => {
                    const date = new Date(reading.timestamp);
                    return `
                        <div class="history-item">
                            <div class="history-time">${date.toLocaleString()}</div>
                            <div class="history-metrics">
                                <div><span class="history-value">${Math.round(reading.heartRate)}</span> BPM</div>
                                <div><span class="history-value">${Math.round(reading.breathingRate)}</span> BR</div>
                                <div><span class="history-value">${Math.round(reading.spo2)}</span>% SpO2</div>
                                <div><span class="history-value">${reading.stress.toFixed(1)}</span> Stress</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Draw trends chart
            drawTrendsChart() {
                const canvas = document.getElementById('trends-chart');
                const ctx = canvas.getContext('2d');

                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;

                if (this.history.length < 2) {
                    ctx.fillStyle = '#9ca3af';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = '14px sans-serif';
                    ctx.fillText('Not enough data yet', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const data = this.history.slice(0, 50).reverse();
                const padding = 40;
                const width = canvas.width - padding * 2;
                const height = canvas.height - padding * 2;

                // Draw axes
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, canvas.height - padding);
                ctx.lineTo(canvas.width - padding, canvas.height - padding);
                ctx.stroke();

                // Draw heart rate line
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.beginPath();

                const hrMax = 120;
                const hrMin = 40;

                data.forEach((reading, i) => {
                    const x = padding + (i / (data.length - 1)) * width;
                    const y = canvas.height - padding - ((reading.heartRate - hrMin) / (hrMax - hrMin)) * height;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });

                ctx.stroke();

                // Label
                ctx.fillStyle = '#1f2937';
                ctx.font = '12px sans-serif';
                ctx.fillText('Heart Rate (BPM)', padding, 20);
            },

            // Export data as CSV
            exportData() {
                if (this.history.length === 0) {
                    alert('No data to export yet!');
                    return;
                }

                let csv = 'Timestamp,Heart Rate (BPM),Breathing Rate,SpO2 (%),Stress Level,HRV (ms)\n';

                this.history.forEach(reading => {
                    csv += `${reading.timestamp},${reading.heartRate.toFixed(1)},${reading.breathingRate.toFixed(1)},${reading.spo2.toFixed(1)},${reading.stress.toFixed(1)},${reading.hrv.toFixed(1)}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `biometric-data-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // Export PDF report
            exportPDF() {
                alert('PDF export would generate a comprehensive health report with charts and trends. This feature requires a PDF library.');
            },

            // Clear history
            clearHistory() {
                if (confirm('Are you sure you want to clear all historical data?')) {
                    this.history = [];
                    localStorage.removeItem('biometricHistory');
                    this.updateHistoryList();
                    this.drawTrendsChart();
                }
            },

            // Calibrate
            calibrate() {
                alert('Calibration: Please sit still and look at the camera for 30 seconds. Ensure good lighting on your face.');
                // Reset buffers
                this.ppgBuffer = [];
                this.breathingBuffer = [];
                this.peakTimes = [];
            }
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            Scanner.init();
        });
    </script>
</body>
</html>
