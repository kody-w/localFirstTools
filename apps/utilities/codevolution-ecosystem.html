<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeVolution - Living Code Ecosystem</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent-primary: #00ff88;
            --accent-secondary: #00ccff;
            --accent-tertiary: #ff00aa;
            --text-primary: #ffffff;
            --text-secondary: #888899;
            --danger: #ff4444;
            --warning: #ffaa00;
            --success: #00ff88;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Fira Code', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Data Controls */
        .data-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .data-controls button {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .data-controls button:hover {
            background: var(--accent-secondary);
            color: var(--bg-primary);
        }

        /* Main Layout */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 0;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 10px var(--accent-primary); }
            50% { box-shadow: 0 0 25px var(--accent-primary); }
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 300;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: -2px;
        }

        /* Simulation Controls */
        .sim-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn.play {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .control-btn.pause {
            background: var(--warning);
            color: var(--bg-primary);
        }

        .control-btn.reset {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--danger);
        }

        .control-btn:hover {
            transform: scale(1.05);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .speed-control input {
            width: 100px;
            accent-color: var(--accent-primary);
        }

        .generation-display {
            background: var(--bg-tertiary);
            padding: 8px 16px;
            border-radius: 6px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
        }

        .generation-display span {
            color: var(--accent-primary);
            font-weight: bold;
        }

        /* Left Panel - Controls & Stats */
        .left-panel {
            background: var(--bg-secondary);
            padding: 16px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-secondary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 204, 255, 0.2);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: bold;
            color: var(--accent-primary);
            font-family: 'Fira Code', monospace;
        }

        .stat-value.danger {
            color: var(--danger);
        }

        .stat-value.warning {
            color: var(--warning);
        }

        /* Sliders */
        .slider-group {
            margin-bottom: 16px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .slider-value {
            color: var(--accent-primary);
            font-family: 'Fira Code', monospace;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--accent-primary);
        }

        /* Event Buttons */
        .event-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .event-btn {
            padding: 10px 8px;
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .event-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .event-btn.asteroid {
            border-color: var(--danger);
            color: var(--danger);
        }

        .event-btn.asteroid:hover {
            background: var(--danger);
            color: white;
        }

        .event-btn.shift {
            border-color: var(--accent-tertiary);
            color: var(--accent-tertiary);
        }

        .event-btn.shift:hover {
            background: var(--accent-tertiary);
            color: white;
        }

        .event-btn.plague {
            border-color: var(--warning);
            color: var(--warning);
        }

        .event-btn.plague:hover {
            background: var(--warning);
            color: var(--bg-primary);
        }

        .event-btn.drought {
            border-color: #8b4513;
            color: #deb887;
        }

        .event-btn.drought:hover {
            background: #8b4513;
            color: white;
        }

        /* Seed Buttons */
        .seed-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .seed-btn {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-secondary);
            border-radius: 4px;
            color: var(--accent-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .seed-btn:hover {
            background: var(--accent-secondary);
            color: var(--bg-primary);
        }

        /* Main Viewport */
        .viewport {
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        #ecosystem-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .viewport-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
        }

        .viewport-overlay .fps {
            color: var(--accent-primary);
            font-family: 'Fira Code', monospace;
        }

        /* Event Notification */
        .event-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 50px;
            border-radius: 12px;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 100;
        }

        .event-notification.show {
            opacity: 1;
        }

        .event-notification h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .event-notification p {
            color: var(--text-secondary);
        }

        /* Right Panel */
        .right-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-tab.active {
            color: var(--accent-primary);
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--accent-primary);
        }

        .panel-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Code Inspector */
        .selected-organism {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .organism-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .organism-name {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .organism-species {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .organism-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .organism-stat {
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .organism-stat-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .organism-stat-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            font-family: 'Fira Code', monospace;
        }

        .code-display {
            background: #1e1e2e;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .code-keyword { color: #ff79c6; }
        .code-function { color: #50fa7b; }
        .code-number { color: #bd93f9; }
        .code-string { color: #f1fa8c; }
        .code-comment { color: #6272a4; }
        .code-operator { color: #ff79c6; }

        .no-selection {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .no-selection p {
            margin-bottom: 10px;
        }

        /* Phylogenetic Tree */
        .tree-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            min-height: 300px;
            position: relative;
        }

        .tree-node {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .tree-node:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tree-node-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .tree-node-name {
            font-size: 12px;
            flex: 1;
        }

        .tree-node-count {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: 'Fira Code', monospace;
        }

        .tree-branch {
            margin-left: 20px;
            border-left: 1px dashed rgba(255, 255, 255, 0.2);
            padding-left: 10px;
        }

        /* Statistics Charts */
        .chart-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-canvas {
            width: 100%;
            height: 100px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        /* Achievements */
        .achievement {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            opacity: 0.4;
            transition: all 0.3s;
        }

        .achievement.unlocked {
            opacity: 1;
            border: 1px solid var(--accent-primary);
        }

        .achievement-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .achievement.unlocked .achievement-icon {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }

        .achievement-info h4 {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .achievement-info p {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Export Panel */
        .export-section {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .export-title {
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--accent-primary);
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            border: none;
            border-radius: 6px;
            color: var(--bg-primary);
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        .export-btn.secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            border: 1px solid var(--accent-primary);
            display: none;
        }

        .tooltip.show {
            display: block;
        }

        .tooltip h4 {
            color: var(--accent-primary);
            margin-bottom: 6px;
        }

        .tooltip p {
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 240px 1fr 280px;
            }
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }

            .left-panel, .right-panel {
                max-height: 200px;
                overflow-y: auto;
            }

            .viewport {
                min-height: 400px;
            }

            .sim-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .data-controls {
                position: relative;
                top: auto;
                right: auto;
                justify-content: center;
                margin-top: 10px;
            }
        }

        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                gap: 12px;
                padding: 10px;
            }

            .logo h1 {
                font-size: 18px;
            }

            .generation-display {
                font-size: 12px;
            }

            .control-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Loading State */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* First Time Help */
        .help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .help-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .help-content h2 {
            color: var(--accent-primary);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .help-content h3 {
            color: var(--accent-secondary);
            margin: 20px 0 10px;
            font-size: 16px;
        }

        .help-content p, .help-content li {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .help-content ul {
            padding-left: 20px;
        }

        .help-close-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .help-close-btn:hover {
            background: var(--accent-secondary);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Data Controls -->
    <div class="data-controls">
        <button onclick="exportData()" title="Export ecosystem data">Export Data</button>
        <button onclick="document.getElementById('importFile').click()" title="Import ecosystem data">Import Data</button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        <button onclick="showHelp()" title="Show help">Help</button>
    </div>

    <!-- Help Overlay -->
    <div class="help-overlay hidden" id="helpOverlay">
        <div class="help-content">
            <h2>Welcome to CodeVolution</h2>
            <p>A living ecosystem where JavaScript functions are organisms competing for survival through evolution.</p>

            <h3>How It Works</h3>
            <ul>
                <li><strong>Organisms</strong> are JavaScript functions that execute and compete for CPU cycles (energy)</li>
                <li><strong>Fitness</strong> is determined by execution speed and correct results</li>
                <li><strong>Mutation</strong> creates random code changes in offspring</li>
                <li><strong>Selection</strong> favors more efficient functions - inefficient ones die</li>
                <li><strong>Species</strong> form when functions become sufficiently different</li>
            </ul>

            <h3>Controls</h3>
            <ul>
                <li><strong>Play/Pause</strong> - Start or stop the simulation</li>
                <li><strong>Speed</strong> - Control simulation speed</li>
                <li><strong>Population/Mutation/Energy</strong> - Adjust ecosystem parameters</li>
                <li><strong>Catastrophic Events</strong> - Trigger extinction-level events</li>
                <li><strong>Seed Ecosystems</strong> - Start with predefined function sets</li>
            </ul>

            <h3>Viewing Organisms</h3>
            <ul>
                <li>Click any organism in the 3D view to inspect its code</li>
                <li>View the phylogenetic tree to see evolutionary history</li>
                <li>Export successful functions as usable JavaScript code</li>
            </ul>

            <h3>Tips</h3>
            <ul>
                <li>Start with a seed ecosystem to see evolution in action</li>
                <li>Lower energy creates more competitive pressure</li>
                <li>Higher mutation rates accelerate evolution but can cause chaos</li>
                <li>Watch for emergent optimization patterns!</li>
            </ul>

            <button class="help-close-btn" onclick="hideHelp()">Start Exploring</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">&#x1F9EC;</div>
                <div>
                    <h1>CodeVolution</h1>
                    <div class="logo-subtitle">Living Code Ecosystem Simulator</div>
                </div>
            </div>

            <div class="sim-controls">
                <button class="control-btn play" id="playPauseBtn" onclick="toggleSimulation()">
                    <span id="playIcon">&#9658;</span> <span id="playText">Play</span>
                </button>
                <button class="control-btn reset" onclick="resetSimulation()">
                    &#8634; Reset
                </button>
                <div class="speed-control">
                    <span>Speed:</span>
                    <input type="range" min="0.1" max="3" step="0.1" value="1" id="speedSlider" oninput="updateSpeed(this.value)">
                    <span id="speedValue">1x</span>
                </div>
                <div class="generation-display">
                    Gen: <span id="genCounter">0</span> | Pop: <span id="popCounter">0</span>
                </div>
            </div>
        </header>

        <!-- Left Panel -->
        <aside class="left-panel">
            <div class="panel-section">
                <h3 class="panel-title">Ecosystem Stats</h3>
                <div class="stat-row">
                    <span class="stat-label">Total Organisms</span>
                    <span class="stat-value" id="statPopulation">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Species Count</span>
                    <span class="stat-value" id="statSpecies">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Fitness</span>
                    <span class="stat-value" id="statFitness">0.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Births</span>
                    <span class="stat-value" id="statBirths">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Deaths</span>
                    <span class="stat-value danger" id="statDeaths">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Extinctions</span>
                    <span class="stat-value warning" id="statExtinctions">0</span>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">Parameters</h3>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Max Population</span>
                        <span class="slider-value" id="maxPopValue">50</span>
                    </div>
                    <input type="range" min="10" max="100" value="50" id="maxPopSlider" oninput="updateParam('maxPop', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Mutation Rate</span>
                        <span class="slider-value" id="mutationValue">15%</span>
                    </div>
                    <input type="range" min="1" max="50" value="15" id="mutationSlider" oninput="updateParam('mutation', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Energy Level</span>
                        <span class="slider-value" id="energyValue">100%</span>
                    </div>
                    <input type="range" min="10" max="200" value="100" id="energySlider" oninput="updateParam('energy', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Selection Pressure</span>
                        <span class="slider-value" id="pressureValue">50%</span>
                    </div>
                    <input type="range" min="10" max="90" value="50" id="pressureSlider" oninput="updateParam('pressure', this.value)">
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">Catastrophic Events</h3>
                <div class="event-grid">
                    <button class="event-btn asteroid" onclick="triggerEvent('asteroid')">
                        Syntax Asteroid
                    </button>
                    <button class="event-btn shift" onclick="triggerEvent('paradigmShift')">
                        Paradigm Shift
                    </button>
                    <button class="event-btn plague" onclick="triggerEvent('refactorPlague')">
                        Refactor Plague
                    </button>
                    <button class="event-btn drought" onclick="triggerEvent('optimizationDrought')">
                        Energy Drought
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">Seed Ecosystems</h3>
                <div class="seed-grid">
                    <button class="seed-btn" onclick="seedEcosystem('sorting')">Sorting Arena</button>
                    <button class="seed-btn" onclick="seedEcosystem('math')">Math Olympics</button>
                    <button class="seed-btn" onclick="seedEcosystem('string')">String Manipulators</button>
                    <button class="seed-btn" onclick="seedEcosystem('random')">Random Soup</button>
                </div>
            </div>
        </aside>

        <!-- Main Viewport -->
        <main class="viewport">
            <canvas id="ecosystem-canvas"></canvas>
            <div class="viewport-overlay">
                FPS: <span class="fps" id="fpsCounter">60</span>
            </div>
            <div class="event-notification" id="eventNotification">
                <h2 id="eventTitle">Event!</h2>
                <p id="eventDesc">Description</p>
            </div>
            <div class="tooltip" id="tooltip">
                <h4 id="tooltipTitle">Organism</h4>
                <p id="tooltipContent">Details</p>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <div class="panel-tabs">
                <button class="panel-tab active" onclick="switchTab('inspector')">Inspector</button>
                <button class="panel-tab" onclick="switchTab('tree')">Phylogeny</button>
                <button class="panel-tab" onclick="switchTab('stats')">Charts</button>
                <button class="panel-tab" onclick="switchTab('export')">Export</button>
            </div>

            <div class="panel-content">
                <!-- Inspector Tab -->
                <div class="tab-pane active" id="inspectorTab">
                    <div class="no-selection" id="noSelection">
                        <p>Click an organism in the viewport to inspect its code</p>
                        <p style="font-size: 10px; margin-top: 10px;">Tip: Larger organisms are more fit</p>
                    </div>
                    <div class="selected-organism hidden" id="selectedOrganism">
                        <div class="organism-header">
                            <span class="organism-name" id="orgName">Organism #1</span>
                            <span class="organism-species" id="orgSpeciesColor"></span>
                        </div>
                        <div class="organism-stats">
                            <div class="organism-stat">
                                <div class="organism-stat-label">Fitness</div>
                                <div class="organism-stat-value" id="orgFitness">0.00</div>
                            </div>
                            <div class="organism-stat">
                                <div class="organism-stat-label">Energy</div>
                                <div class="organism-stat-value" id="orgEnergy">100</div>
                            </div>
                            <div class="organism-stat">
                                <div class="organism-stat-label">Age</div>
                                <div class="organism-stat-value" id="orgAge">0</div>
                            </div>
                            <div class="organism-stat">
                                <div class="organism-stat-label">Children</div>
                                <div class="organism-stat-value" id="orgChildren">0</div>
                            </div>
                        </div>
                        <div class="code-display" id="orgCode">// Code here</div>
                        <div style="margin-top: 12px;">
                            <button class="export-btn secondary" onclick="copyOrganismCode()" style="padding: 8px; font-size: 12px;">Copy Code</button>
                        </div>
                    </div>
                </div>

                <!-- Phylogeny Tab -->
                <div class="tab-pane" id="treeTab">
                    <div class="tree-container" id="phyloTree">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px 20px;">
                            Start simulation to see evolutionary tree
                        </p>
                    </div>
                </div>

                <!-- Stats Tab -->
                <div class="tab-pane" id="statsTab">
                    <div class="chart-container">
                        <div class="chart-title">Population Over Time</div>
                        <canvas class="chart-canvas" id="popChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Species Diversity</div>
                        <canvas class="chart-canvas" id="diversityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Average Fitness</div>
                        <canvas class="chart-canvas" id="fitnessChart"></canvas>
                    </div>
                </div>

                <!-- Export Tab -->
                <div class="tab-pane" id="exportTab">
                    <div class="export-section">
                        <div class="export-title">Export Top Performers</div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                            Export the fittest functions as usable JavaScript code
                        </p>
                        <button class="export-btn" onclick="exportTopFunctions()">Export as JS Library</button>
                        <button class="export-btn secondary" onclick="exportBenchmarks()">Export Benchmarks</button>
                    </div>

                    <div class="export-section">
                        <div class="export-title">Achievements</div>
                        <div id="achievementsList">
                            <!-- Achievements populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // ============================================
        // CodeVolution - Living Code Ecosystem
        // ============================================

        const APP_NAME = 'codevolution-ecosystem';

        // Global State
        let appData = {
            generation: 0,
            totalBirths: 0,
            totalDeaths: 0,
            extinctions: 0,
            achievements: [],
            history: {
                population: [],
                diversity: [],
                fitness: []
            },
            savedOrganisms: []
        };

        // Simulation State
        let organisms = [];
        let species = new Map();
        let isRunning = false;
        let simulationSpeed = 1;
        let selectedOrganism = null;
        let lastFrameTime = 0;
        let frameCount = 0;
        let fps = 60;

        // Parameters
        let params = {
            maxPopulation: 50,
            mutationRate: 0.15,
            energyLevel: 1.0,
            selectionPressure: 0.5
        };

        // Canvas and 3D rendering
        let canvas, ctx;
        let camera = { x: 0, y: 0, z: -300, rotX: 0, rotY: 0 };
        let particles = [];

        // Species colors
        const speciesColors = [
            '#00ff88', '#00ccff', '#ff00aa', '#ffaa00', '#ff4444',
            '#aa00ff', '#00ffcc', '#ff6600', '#66ff00', '#ff0066',
            '#00aaff', '#ffcc00', '#cc00ff', '#00ff66', '#ff3366'
        ];

        // Challenge functions - organisms compete to solve these
        const challenges = {
            fibonacci: {
                name: 'Fibonacci',
                test: (fn) => {
                    try {
                        const results = [fn(0), fn(1), fn(5), fn(10)];
                        const expected = [0, 1, 5, 55];
                        return results.every((r, i) => r === expected[i]) ? 1 : 0;
                    } catch { return 0; }
                },
                input: 10
            },
            sum: {
                name: 'Sum Array',
                test: (fn) => {
                    try {
                        const arr = [1, 2, 3, 4, 5];
                        return fn(arr) === 15 ? 1 : 0;
                    } catch { return 0; }
                },
                input: [1, 2, 3, 4, 5]
            },
            sort: {
                name: 'Sort Array',
                test: (fn) => {
                    try {
                        const arr = [5, 2, 8, 1, 9];
                        const result = fn([...arr]);
                        const expected = [1, 2, 5, 8, 9];
                        return JSON.stringify(result) === JSON.stringify(expected) ? 1 : 0;
                    } catch { return 0; }
                },
                input: [5, 2, 8, 1, 9]
            },
            max: {
                name: 'Find Max',
                test: (fn) => {
                    try {
                        return fn([3, 7, 2, 9, 4]) === 9 ? 1 : 0;
                    } catch { return 0; }
                },
                input: [3, 7, 2, 9, 4]
            },
            isPrime: {
                name: 'Is Prime',
                test: (fn) => {
                    try {
                        const results = [fn(2), fn(4), fn(7), fn(9)];
                        const expected = [true, false, true, false];
                        return results.every((r, i) => r === expected[i]) ? 1 : 0;
                    } catch { return 0; }
                },
                input: 7
            }
        };

        let currentChallenge = 'fibonacci';

        // ============================================
        // Organism Class
        // ============================================

        class Organism {
            constructor(code, parent = null, speciesId = null) {
                this.id = Math.random().toString(36).substr(2, 9);
                this.code = code;
                this.fn = null;
                this.fitness = 0;
                this.energy = 100;
                this.age = 0;
                this.children = 0;
                this.speciesId = speciesId || this.generateSpeciesId();
                this.parentId = parent ? parent.id : null;
                this.generation = parent ? parent.generation + 1 : 0;

                // 3D position
                this.x = (Math.random() - 0.5) * 400;
                this.y = (Math.random() - 0.5) * 400;
                this.z = (Math.random() - 0.5) * 400;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.vz = (Math.random() - 0.5) * 2;

                // Visual properties
                this.size = 10;
                this.targetSize = 10;
                this.alpha = 1;
                this.dying = false;

                this.compile();
            }

            generateSpeciesId() {
                return Math.floor(Math.random() * speciesColors.length);
            }

            compile() {
                try {
                    // Sandbox the function execution
                    this.fn = new Function('n', 'arr', `
                        "use strict";
                        const input = Array.isArray(arr) ? arr : n;
                        ${this.code}
                    `);
                } catch (e) {
                    this.fn = null;
                    this.fitness = 0;
                }
            }

            execute() {
                if (!this.fn) return 0;

                const challenge = challenges[currentChallenge];
                const startTime = performance.now();

                try {
                    // Execute with timeout protection
                    const result = challenge.test(this.fn);
                    const execTime = performance.now() - startTime;

                    // Fitness = correctness / time (prefer faster correct solutions)
                    const timePenalty = Math.min(execTime / 10, 1);
                    this.fitness = result * (1 - timePenalty * 0.5);

                    // Energy cost based on execution time
                    this.energy -= execTime * 0.1 + 1;

                    return this.fitness;
                } catch (e) {
                    this.fitness = 0;
                    this.energy -= 5;
                    return 0;
                }
            }

            mutate() {
                const mutations = [
                    this.addLine.bind(this),
                    this.removeLine.bind(this),
                    this.modifyOperator.bind(this),
                    this.modifyNumber.bind(this),
                    this.swapLines.bind(this),
                    this.duplicateLine.bind(this)
                ];

                const mutation = mutations[Math.floor(Math.random() * mutations.length)];
                const newCode = mutation();

                // Create mutant with new species if code differs significantly
                const similarity = this.calculateSimilarity(newCode);
                const newSpeciesId = similarity < 0.7 ? this.generateSpeciesId() : this.speciesId;

                return new Organism(newCode, this, newSpeciesId);
            }

            addLine() {
                const lines = this.code.split('\n');
                const templates = [
                    'let temp = n * 2;',
                    'if (n < 0) return 0;',
                    'n = Math.abs(n);',
                    'let result = 0;',
                    'for (let i = 0; i < n; i++) { result += i; }',
                    'return n + 1;'
                ];
                const newLine = templates[Math.floor(Math.random() * templates.length)];
                const pos = Math.floor(Math.random() * (lines.length + 1));
                lines.splice(pos, 0, newLine);
                return lines.join('\n');
            }

            removeLine() {
                const lines = this.code.split('\n').filter(l => l.trim());
                if (lines.length <= 1) return this.code;
                const pos = Math.floor(Math.random() * lines.length);
                lines.splice(pos, 1);
                return lines.join('\n');
            }

            modifyOperator() {
                const operators = ['+', '-', '*', '/', '%', '>', '<', '>=', '<=', '===', '!=='];
                const op = operators[Math.floor(Math.random() * operators.length)];
                const oldOp = operators[Math.floor(Math.random() * operators.length)];
                return this.code.replace(new RegExp('\\' + oldOp.split('').join('\\'), 'g'), op);
            }

            modifyNumber() {
                return this.code.replace(/\d+/g, (match) => {
                    const num = parseInt(match);
                    const delta = Math.floor(Math.random() * 5) - 2;
                    return Math.max(0, num + delta).toString();
                });
            }

            swapLines() {
                const lines = this.code.split('\n');
                if (lines.length < 2) return this.code;
                const i = Math.floor(Math.random() * lines.length);
                const j = Math.floor(Math.random() * lines.length);
                [lines[i], lines[j]] = [lines[j], lines[i]];
                return lines.join('\n');
            }

            duplicateLine() {
                const lines = this.code.split('\n');
                const pos = Math.floor(Math.random() * lines.length);
                lines.splice(pos, 0, lines[pos]);
                return lines.join('\n');
            }

            crossover(partner) {
                const myLines = this.code.split('\n');
                const partnerLines = partner.code.split('\n');

                const crossPoint1 = Math.floor(Math.random() * myLines.length);
                const crossPoint2 = Math.floor(Math.random() * partnerLines.length);

                const childLines = [
                    ...myLines.slice(0, crossPoint1),
                    ...partnerLines.slice(crossPoint2)
                ];

                const childCode = childLines.join('\n');
                const similarity = this.calculateSimilarity(childCode);
                const newSpeciesId = similarity < 0.5 ? this.generateSpeciesId() :
                    Math.random() < 0.5 ? this.speciesId : partner.speciesId;

                return new Organism(childCode, this, newSpeciesId);
            }

            calculateSimilarity(otherCode) {
                const a = this.code.replace(/\s/g, '');
                const b = otherCode.replace(/\s/g, '');
                let matches = 0;
                const maxLen = Math.max(a.length, b.length);
                for (let i = 0; i < Math.min(a.length, b.length); i++) {
                    if (a[i] === b[i]) matches++;
                }
                return matches / maxLen;
            }

            update() {
                this.age++;

                // Movement
                this.x += this.vx;
                this.y += this.vy;
                this.z += this.vz;

                // Boundary bounce
                const bound = 200;
                if (Math.abs(this.x) > bound) this.vx *= -0.8;
                if (Math.abs(this.y) > bound) this.vy *= -0.8;
                if (Math.abs(this.z) > bound) this.vz *= -0.8;

                // Friction
                this.vx *= 0.99;
                this.vy *= 0.99;
                this.vz *= 0.99;

                // Size based on fitness
                this.targetSize = 8 + this.fitness * 20;
                this.size += (this.targetSize - this.size) * 0.1;

                // Dying animation
                if (this.dying) {
                    this.alpha -= 0.05;
                    this.size *= 0.95;
                }
            }

            getColor() {
                return speciesColors[this.speciesId % speciesColors.length];
            }
        }

        // ============================================
        // Seed Functions
        // ============================================

        const seedFunctions = {
            sorting: [
                `// Bubble Sort
let arr = [...input];
for (let i = 0; i < arr.length; i++) {
    for (let j = 0; j < arr.length - i - 1; j++) {
        if (arr[j] > arr[j + 1]) {
            [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
        }
    }
}
return arr;`,
                `// Selection Sort
let arr = [...input];
for (let i = 0; i < arr.length; i++) {
    let min = i;
    for (let j = i + 1; j < arr.length; j++) {
        if (arr[j] < arr[min]) min = j;
    }
    [arr[i], arr[min]] = [arr[min], arr[i]];
}
return arr;`,
                `// Simple Sort
return [...input].sort((a, b) => a - b);`
            ],
            math: [
                `// Fibonacci Recursive
if (n <= 1) return n;
let a = 0, b = 1;
for (let i = 2; i <= n; i++) {
    [a, b] = [b, a + b];
}
return b;`,
                `// Fibonacci Simple
if (n <= 1) return n;
return n + n - 1;`,
                `// Sum Array
if (!Array.isArray(input)) return 0;
let sum = 0;
for (let i = 0; i < input.length; i++) {
    sum += input[i];
}
return sum;`,
                `// Find Max
if (!Array.isArray(input)) return 0;
let max = input[0];
for (let i = 1; i < input.length; i++) {
    if (input[i] > max) max = input[i];
}
return max;`
            ],
            string: [
                `// Reverse approach
if (Array.isArray(input)) {
    return input.slice().reverse();
}
return n;`,
                `// Length check
if (Array.isArray(input)) {
    return input.length;
}
return 1;`,
                `// First element
if (Array.isArray(input)) {
    return input[0];
}
return n;`
            ],
            random: [
                `return n * 2;`,
                `return n + 1;`,
                `let x = n; return x;`,
                `if (n > 0) return n; return 0;`,
                `return n - 1 + 1;`,
                `let result = 0; result = n; return result;`
            ]
        };

        // ============================================
        // Simulation Logic
        // ============================================

        function initSimulation() {
            canvas = document.getElementById('ecosystem-canvas');
            ctx = canvas.getContext('2d');

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousemove', handleCanvasHover);

            loadData();
            initCharts();
            initAchievements();

            // Show help on first visit
            if (!appData.hasSeenHelp) {
                showHelp();
                appData.hasSeenHelp = true;
                saveData();
            }

            requestAnimationFrame(gameLoop);
        }

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }

        function gameLoop(timestamp) {
            // FPS calculation
            frameCount++;
            if (timestamp - lastFrameTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFrameTime = timestamp;
                document.getElementById('fpsCounter').textContent = fps;
            }

            if (isRunning) {
                updateSimulation();
            }

            render();
            requestAnimationFrame(gameLoop);
        }

        function updateSimulation() {
            // Execute all organisms and update fitness
            organisms.forEach(org => {
                org.execute();
                org.update();

                // Natural energy drain
                org.energy -= 0.5 / params.energyLevel;
            });

            // Remove dead organisms
            const beforeCount = organisms.length;
            organisms = organisms.filter(org => {
                if (org.energy <= 0 || org.dying && org.alpha <= 0) {
                    appData.totalDeaths++;

                    // Create death particle effect
                    createDeathParticles(org);

                    // Check for species extinction
                    const speciesCount = organisms.filter(o => o.speciesId === org.speciesId).length;
                    if (speciesCount <= 1) {
                        appData.extinctions++;
                        updateAchievement('first_extinction');
                    }

                    return false;
                }
                return true;
            });

            // Selection and reproduction
            if (organisms.length > 0 && organisms.length < params.maxPopulation) {
                // Tournament selection
                const tournament = [];
                for (let i = 0; i < Math.min(5, organisms.length); i++) {
                    tournament.push(organisms[Math.floor(Math.random() * organisms.length)]);
                }
                tournament.sort((a, b) => b.fitness - a.fitness);

                const parent1 = tournament[0];

                if (parent1 && parent1.energy > 30 && parent1.fitness > 0.1) {
                    let child;

                    if (Math.random() < 0.3 && tournament.length > 1) {
                        // Crossover
                        child = parent1.crossover(tournament[1]);
                    } else if (Math.random() < params.mutationRate) {
                        // Mutation
                        child = parent1.mutate();
                    } else {
                        // Clone
                        child = new Organism(parent1.code, parent1, parent1.speciesId);
                    }

                    if (child) {
                        organisms.push(child);
                        parent1.children++;
                        parent1.energy -= 20;
                        appData.totalBirths++;

                        // Birth particles
                        createBirthParticles(child);
                    }
                }
            }

            // Kill weakest if overpopulated
            while (organisms.length > params.maxPopulation) {
                organisms.sort((a, b) => a.fitness - b.fitness);
                organisms[0].dying = true;
            }

            // Update particles
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                return p.life > 0;
            });

            // Update generation counter
            if (organisms.length > 0) {
                appData.generation = Math.max(...organisms.map(o => o.generation));
            }

            // Update species map
            species.clear();
            organisms.forEach(org => {
                if (!species.has(org.speciesId)) {
                    species.set(org.speciesId, []);
                }
                species.get(org.speciesId).push(org);
            });

            // Record history
            if (appData.generation % 10 === 0) {
                recordHistory();
            }

            // Update UI
            updateStats();
            updatePhylogeneticTree();

            // Check achievements
            checkAchievements();
        }

        function render() {
            ctx.fillStyle = '#0a0a0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grid
            drawGrid();

            // Draw connections between related organisms
            drawConnections();

            // Draw particles
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(
                    canvas.width / 2 + p.x,
                    canvas.height / 2 + p.y,
                    p.size * p.life,
                    0,
                    Math.PI * 2
                );
                ctx.fillStyle = `rgba(${p.r}, ${p.g}, ${p.b}, ${p.life})`;
                ctx.fill();
            });

            // Draw organisms
            organisms.forEach(org => {
                const projected = project3D(org.x, org.y, org.z);
                const scale = projected.scale;

                // Glow effect
                const gradient = ctx.createRadialGradient(
                    projected.x, projected.y, 0,
                    projected.x, projected.y, org.size * scale * 2
                );
                const color = org.getColor();
                gradient.addColorStop(0, color);
                gradient.addColorStop(0.5, color + '80');
                gradient.addColorStop(1, 'transparent');

                ctx.beginPath();
                ctx.arc(projected.x, projected.y, org.size * scale * 2, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.globalAlpha = org.alpha * 0.5;
                ctx.fill();

                // Core
                ctx.beginPath();
                ctx.arc(projected.x, projected.y, org.size * scale, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.globalAlpha = org.alpha;
                ctx.fill();

                // Highlight if selected
                if (selectedOrganism && selectedOrganism.id === org.id) {
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                ctx.globalAlpha = 1;
            });
        }

        function project3D(x, y, z) {
            const fov = 500;
            const scale = fov / (fov + z - camera.z);
            return {
                x: canvas.width / 2 + (x - camera.x) * scale,
                y: canvas.height / 2 + (y - camera.y) * scale,
                scale: scale
            };
        }

        function drawGrid() {
            ctx.strokeStyle = 'rgba(0, 255, 136, 0.1)';
            ctx.lineWidth = 1;

            const gridSize = 50;
            const gridCount = 10;

            for (let i = -gridCount; i <= gridCount; i++) {
                const p1 = project3D(i * gridSize, -200, -200);
                const p2 = project3D(i * gridSize, -200, 200);
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();

                const p3 = project3D(-200, -200, i * gridSize);
                const p4 = project3D(200, -200, i * gridSize);
                ctx.beginPath();
                ctx.moveTo(p3.x, p3.y);
                ctx.lineTo(p4.x, p4.y);
                ctx.stroke();
            }
        }

        function drawConnections() {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;

            organisms.forEach(org => {
                if (org.parentId) {
                    const parent = organisms.find(o => o.id === org.parentId);
                    if (parent) {
                        const p1 = project3D(org.x, org.y, org.z);
                        const p2 = project3D(parent.x, parent.y, parent.z);
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                    }
                }
            });
        }

        function createBirthParticles(org) {
            const color = org.getColor();
            const rgb = hexToRgb(color);

            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: org.x,
                    y: org.y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    size: Math.random() * 4 + 2,
                    life: 1,
                    r: rgb.r,
                    g: rgb.g,
                    b: rgb.b
                });
            }
        }

        function createDeathParticles(org) {
            const rgb = hexToRgb('#ff4444');

            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: org.x,
                    y: org.y,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    size: Math.random() * 3 + 1,
                    life: 1,
                    r: rgb.r,
                    g: rgb.g,
                    b: rgb.b
                });
            }
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        }

        // ============================================
        // Event Handlers
        // ============================================

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            let closest = null;
            let closestDist = Infinity;

            organisms.forEach(org => {
                const projected = project3D(org.x, org.y, org.z);
                const dist = Math.hypot(clickX - projected.x, clickY - projected.y);
                if (dist < org.size * projected.scale * 2 && dist < closestDist) {
                    closest = org;
                    closestDist = dist;
                }
            });

            selectOrganism(closest);
        }

        function handleCanvasHover(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const tooltip = document.getElementById('tooltip');
            let found = false;

            organisms.forEach(org => {
                const projected = project3D(org.x, org.y, org.z);
                const dist = Math.hypot(mouseX - projected.x, mouseY - projected.y);
                if (dist < org.size * projected.scale * 2 && !found) {
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY + 15) + 'px';
                    document.getElementById('tooltipTitle').textContent = `Organism #${org.id.substr(0, 4)}`;
                    document.getElementById('tooltipContent').textContent =
                        `Fitness: ${org.fitness.toFixed(2)} | Energy: ${org.energy.toFixed(0)} | Gen: ${org.generation}`;
                    tooltip.classList.add('show');
                    found = true;
                }
            });

            if (!found) {
                tooltip.classList.remove('show');
            }
        }

        function selectOrganism(org) {
            selectedOrganism = org;

            const noSelection = document.getElementById('noSelection');
            const selectedDiv = document.getElementById('selectedOrganism');

            if (org) {
                noSelection.classList.add('hidden');
                selectedDiv.classList.remove('hidden');

                document.getElementById('orgName').textContent = `Organism #${org.id.substr(0, 6)}`;
                document.getElementById('orgSpeciesColor').style.background = org.getColor();
                document.getElementById('orgFitness').textContent = org.fitness.toFixed(3);
                document.getElementById('orgEnergy').textContent = org.energy.toFixed(0);
                document.getElementById('orgAge').textContent = org.age;
                document.getElementById('orgChildren').textContent = org.children;
                document.getElementById('orgCode').innerHTML = highlightCode(org.code);
            } else {
                noSelection.classList.remove('hidden');
                selectedDiv.classList.add('hidden');
            }
        }

        function highlightCode(code) {
            return code
                .replace(/\b(function|return|let|const|var|if|else|for|while|do)\b/g, '<span class="code-keyword">$1</span>')
                .replace(/\b(\d+)\b/g, '<span class="code-number">$1</span>')
                .replace(/(["'`].*?["'`])/g, '<span class="code-string">$1</span>')
                .replace(/(\/\/.*$)/gm, '<span class="code-comment">$1</span>')
                .replace(/([+\-*/%=<>!&|]+)/g, '<span class="code-operator">$1</span>');
        }

        function copyOrganismCode() {
            if (selectedOrganism) {
                navigator.clipboard.writeText(selectedOrganism.code);
                alert('Code copied to clipboard!');
            }
        }

        // ============================================
        // Controls
        // ============================================

        function toggleSimulation() {
            isRunning = !isRunning;
            const btn = document.getElementById('playPauseBtn');
            const icon = document.getElementById('playIcon');
            const text = document.getElementById('playText');

            if (isRunning) {
                btn.classList.remove('play');
                btn.classList.add('pause');
                icon.textContent = '\u23F8';
                text.textContent = 'Pause';

                // Create initial population if empty
                if (organisms.length === 0) {
                    seedEcosystem('random');
                }
            } else {
                btn.classList.remove('pause');
                btn.classList.add('play');
                icon.textContent = '\u25B6';
                text.textContent = 'Play';
            }
        }

        function resetSimulation() {
            if (!confirm('Reset the entire ecosystem? All organisms will be lost.')) return;

            isRunning = false;
            organisms = [];
            species.clear();
            particles = [];
            selectedOrganism = null;

            appData.generation = 0;
            appData.totalBirths = 0;
            appData.totalDeaths = 0;
            appData.extinctions = 0;
            appData.history = { population: [], diversity: [], fitness: [] };

            const btn = document.getElementById('playPauseBtn');
            btn.classList.remove('pause');
            btn.classList.add('play');
            document.getElementById('playIcon').textContent = '\u25B6';
            document.getElementById('playText').textContent = 'Play';

            updateStats();
            saveData();
            selectOrganism(null);
        }

        function updateSpeed(value) {
            simulationSpeed = parseFloat(value);
            document.getElementById('speedValue').textContent = value + 'x';
        }

        function updateParam(param, value) {
            switch(param) {
                case 'maxPop':
                    params.maxPopulation = parseInt(value);
                    document.getElementById('maxPopValue').textContent = value;
                    break;
                case 'mutation':
                    params.mutationRate = parseInt(value) / 100;
                    document.getElementById('mutationValue').textContent = value + '%';
                    break;
                case 'energy':
                    params.energyLevel = parseInt(value) / 100;
                    document.getElementById('energyValue').textContent = value + '%';
                    break;
                case 'pressure':
                    params.selectionPressure = parseInt(value) / 100;
                    document.getElementById('pressureValue').textContent = value + '%';
                    break;
            }
        }

        // ============================================
        // Catastrophic Events
        // ============================================

        function triggerEvent(eventType) {
            if (organisms.length === 0) {
                alert('No organisms to affect! Start the simulation first.');
                return;
            }

            const events = {
                asteroid: {
                    title: 'SYNTAX ERROR ASTEROID',
                    desc: 'Random syntax errors kill vulnerable organisms!',
                    color: '#ff4444',
                    effect: () => {
                        organisms.forEach(org => {
                            if (Math.random() < 0.4) {
                                // Inject syntax error
                                org.code = org.code.replace(/;/g, Math.random() < 0.5 ? ';;' : '');
                                org.compile();
                                if (!org.fn) org.energy = 0;
                            }
                        });
                    }
                },
                paradigmShift: {
                    title: 'PARADIGM SHIFT',
                    desc: 'Environment now favors different code patterns!',
                    color: '#ff00aa',
                    effect: () => {
                        const challenges_arr = Object.keys(challenges);
                        const current = challenges_arr.indexOf(currentChallenge);
                        currentChallenge = challenges_arr[(current + 1) % challenges_arr.length];
                        // Re-evaluate all organisms
                        organisms.forEach(org => org.execute());
                    }
                },
                refactorPlague: {
                    title: 'REFACTOR PLAGUE',
                    desc: 'Complex code becomes unstable!',
                    color: '#ffaa00',
                    effect: () => {
                        organisms.forEach(org => {
                            const complexity = org.code.split('\n').length;
                            if (complexity > 5) {
                                org.energy -= complexity * 10;
                            }
                        });
                    }
                },
                optimizationDrought: {
                    title: 'OPTIMIZATION DROUGHT',
                    desc: 'Energy becomes extremely scarce!',
                    color: '#8b4513',
                    effect: () => {
                        params.energyLevel = 0.3;
                        document.getElementById('energySlider').value = 30;
                        document.getElementById('energyValue').textContent = '30%';
                        organisms.forEach(org => org.energy *= 0.5);
                    }
                }
            };

            const event = events[eventType];
            showEventNotification(event.title, event.desc, event.color);
            event.effect();

            updateAchievement('trigger_event');
        }

        function showEventNotification(title, desc, color) {
            const notification = document.getElementById('eventNotification');
            const titleEl = document.getElementById('eventTitle');
            const descEl = document.getElementById('eventDesc');

            titleEl.textContent = title;
            titleEl.style.color = color;
            descEl.textContent = desc;

            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // Seed Ecosystems
        // ============================================

        function seedEcosystem(type) {
            organisms = [];
            species.clear();

            const funcs = seedFunctions[type] || seedFunctions.random;

            // Set appropriate challenge
            if (type === 'sorting') currentChallenge = 'sort';
            else if (type === 'math') currentChallenge = 'fibonacci';
            else if (type === 'string') currentChallenge = 'sum';
            else currentChallenge = 'fibonacci';

            // Create initial population
            funcs.forEach((code, i) => {
                for (let j = 0; j < 5; j++) {
                    const org = new Organism(code, null, i);
                    organisms.push(org);
                }
            });

            appData.generation = 0;
            updateStats();

            if (!isRunning) {
                toggleSimulation();
            }
        }

        // ============================================
        // Statistics & UI
        // ============================================

        function updateStats() {
            document.getElementById('genCounter').textContent = appData.generation;
            document.getElementById('popCounter').textContent = organisms.length;
            document.getElementById('statPopulation').textContent = organisms.length;
            document.getElementById('statSpecies').textContent = species.size;
            document.getElementById('statBirths').textContent = appData.totalBirths;
            document.getElementById('statDeaths').textContent = appData.totalDeaths;
            document.getElementById('statExtinctions').textContent = appData.extinctions;

            const avgFitness = organisms.length > 0
                ? organisms.reduce((sum, o) => sum + o.fitness, 0) / organisms.length
                : 0;
            document.getElementById('statFitness').textContent = avgFitness.toFixed(3);
        }

        function updatePhylogeneticTree() {
            const container = document.getElementById('phyloTree');

            if (species.size === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px 20px;">Start simulation to see evolutionary tree</p>';
                return;
            }

            let html = '';
            species.forEach((members, speciesId) => {
                const color = speciesColors[speciesId % speciesColors.length];
                const avgFitness = members.reduce((s, o) => s + o.fitness, 0) / members.length;

                html += `
                    <div class="tree-node" onclick="highlightSpecies(${speciesId})">
                        <span class="tree-node-color" style="background: ${color}"></span>
                        <span class="tree-node-name">Species ${speciesId}</span>
                        <span class="tree-node-count">${members.length} | ${avgFitness.toFixed(2)}</span>
                    </div>
                `;

                // Show top 3 members
                const topMembers = [...members].sort((a, b) => b.fitness - a.fitness).slice(0, 3);
                html += '<div class="tree-branch">';
                topMembers.forEach(m => {
                    html += `
                        <div class="tree-node" onclick="selectOrganismById('${m.id}')" style="font-size: 11px;">
                            <span class="tree-node-name">#${m.id.substr(0, 4)} (Gen ${m.generation})</span>
                            <span class="tree-node-count">${m.fitness.toFixed(2)}</span>
                        </div>
                    `;
                });
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function highlightSpecies(speciesId) {
            organisms.forEach(org => {
                if (org.speciesId === speciesId) {
                    org.size = org.targetSize * 1.5;
                }
            });
        }

        function selectOrganismById(id) {
            const org = organisms.find(o => o.id === id);
            if (org) {
                selectOrganism(org);
                switchTab('inspector');
            }
        }

        function recordHistory() {
            const avgFitness = organisms.length > 0
                ? organisms.reduce((sum, o) => sum + o.fitness, 0) / organisms.length
                : 0;

            appData.history.population.push(organisms.length);
            appData.history.diversity.push(species.size);
            appData.history.fitness.push(avgFitness);

            // Keep last 100 data points
            if (appData.history.population.length > 100) {
                appData.history.population.shift();
                appData.history.diversity.shift();
                appData.history.fitness.shift();
            }

            updateCharts();
        }

        // ============================================
        // Charts
        // ============================================

        function initCharts() {
            updateCharts();
        }

        function updateCharts() {
            drawChart('popChart', appData.history.population, '#00ff88');
            drawChart('diversityChart', appData.history.diversity, '#00ccff');
            drawChart('fitnessChart', appData.history.fitness, '#ff00aa');
        }

        function drawChart(canvasId, data, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.clientWidth - 32;
            const height = 100;

            canvas.width = width;
            canvas.height = height;

            ctx.fillStyle = '#12121a';
            ctx.fillRect(0, 0, width, height);

            if (data.length < 2) return;

            const max = Math.max(...data, 1);
            const step = width / (data.length - 1);

            ctx.beginPath();
            ctx.moveTo(0, height - (data[0] / max) * height);

            data.forEach((value, i) => {
                ctx.lineTo(i * step, height - (value / max) * height);
            });

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();

            // Fill under line
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            ctx.fillStyle = color + '20';
            ctx.fill();
        }

        // ============================================
        // Tabs
        // ============================================

        function switchTab(tabName) {
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'stats') {
                updateCharts();
            }
        }

        // ============================================
        // Achievements
        // ============================================

        const achievementDefs = [
            { id: 'first_extinction', name: 'Extinction Event', desc: 'Witness a species go extinct', icon: '\uD83D\uDC80' },
            { id: 'gen_100', name: 'Century', desc: 'Reach generation 100', icon: '\uD83C\uDFC6' },
            { id: 'gen_500', name: 'Half Millennium', desc: 'Reach generation 500', icon: '\uD83C\uDF1F' },
            { id: 'pop_50', name: 'Thriving', desc: 'Have 50 organisms alive', icon: '\uD83C\uDF31' },
            { id: 'species_10', name: 'Biodiversity', desc: 'Have 10 different species', icon: '\uD83E\uDDEC' },
            { id: 'trigger_event', name: 'Playing God', desc: 'Trigger a catastrophic event', icon: '\u26A1' },
            { id: 'perfect_fitness', name: 'Perfection', desc: 'An organism achieves 1.0 fitness', icon: '\u2B50' },
            { id: 'export_library', name: 'Creator', desc: 'Export organisms as a library', icon: '\uD83D\uDCBE' }
        ];

        function initAchievements() {
            const container = document.getElementById('achievementsList');
            let html = '';

            achievementDefs.forEach(ach => {
                const unlocked = appData.achievements.includes(ach.id);
                html += `
                    <div class="achievement ${unlocked ? 'unlocked' : ''}" id="ach_${ach.id}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-info">
                            <h4>${ach.name}</h4>
                            <p>${ach.desc}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateAchievement(id) {
            if (!appData.achievements.includes(id)) {
                appData.achievements.push(id);
                saveData();

                const el = document.getElementById('ach_' + id);
                if (el) el.classList.add('unlocked');

                const ach = achievementDefs.find(a => a.id === id);
                if (ach) {
                    showEventNotification('Achievement Unlocked!', ach.name, '#00ff88');
                }
            }
        }

        function checkAchievements() {
            if (appData.generation >= 100) updateAchievement('gen_100');
            if (appData.generation >= 500) updateAchievement('gen_500');
            if (organisms.length >= 50) updateAchievement('pop_50');
            if (species.size >= 10) updateAchievement('species_10');
            if (organisms.some(o => o.fitness >= 0.99)) updateAchievement('perfect_fitness');
        }

        // ============================================
        // Export Functions
        // ============================================

        function exportTopFunctions() {
            if (organisms.length === 0) {
                alert('No organisms to export!');
                return;
            }

            const top = [...organisms].sort((a, b) => b.fitness - a.fitness).slice(0, 10);

            let jsCode = `// CodeVolution Evolved Functions Library
// Generated: ${new Date().toISOString()}
// Generation: ${appData.generation}
// Total Organisms Evaluated: ${appData.totalBirths + organisms.length}

`;

            top.forEach((org, i) => {
                jsCode += `/**
 * Evolved Function #${i + 1}
 * Species: ${org.speciesId}
 * Fitness: ${org.fitness.toFixed(4)}
 * Generation: ${org.generation}
 */
function evolved_${org.id.substr(0, 6)}(n, arr) {
    const input = Array.isArray(arr) ? arr : n;
    ${org.code}
}

`;
            });

            jsCode += `// Export all functions
const evolvedLibrary = {
${top.map((o, i) => `    func${i + 1}: evolved_${o.id.substr(0, 6)}`).join(',\n')}
};

// Usage: evolvedLibrary.func1(10) or evolvedLibrary.func1([1,2,3])
`;

            downloadFile(jsCode, `codevolution-library-${Date.now()}.js`, 'text/javascript');
            updateAchievement('export_library');
        }

        function exportBenchmarks() {
            if (organisms.length === 0) {
                alert('No organisms to benchmark!');
                return;
            }

            const top = [...organisms].sort((a, b) => b.fitness - a.fitness).slice(0, 20);

            const benchmarks = {
                generated: new Date().toISOString(),
                generation: appData.generation,
                challenge: currentChallenge,
                results: top.map(org => ({
                    id: org.id,
                    species: org.speciesId,
                    fitness: org.fitness,
                    energy: org.energy,
                    age: org.age,
                    children: org.children,
                    codeLength: org.code.length,
                    lineCount: org.code.split('\n').length
                }))
            };

            downloadFile(JSON.stringify(benchmarks, null, 2), `codevolution-benchmarks-${Date.now()}.json`, 'application/json');
        }

        // ============================================
        // Data Persistence
        // ============================================

        function saveData() {
            localStorage.setItem(APP_NAME, JSON.stringify(appData));
        }

        function loadData() {
            const saved = localStorage.getItem(APP_NAME);
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    appData = { ...appData, ...loaded };
                } catch (e) {
                    console.error('Failed to load saved data:', e);
                }
            }
            initAchievements();
        }

        function exportData() {
            const exportObj = {
                appData: appData,
                organisms: organisms.map(o => ({
                    code: o.code,
                    speciesId: o.speciesId,
                    fitness: o.fitness,
                    energy: o.energy,
                    age: o.age,
                    generation: o.generation
                })),
                params: params,
                currentChallenge: currentChallenge,
                exportDate: new Date().toISOString()
            };

            downloadFile(JSON.stringify(exportObj, null, 2), `${APP_NAME}-data-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);

                    if (imported.appData) {
                        appData = { ...appData, ...imported.appData };
                        saveData();
                    }

                    if (imported.params) {
                        params = { ...params, ...imported.params };
                        // Update UI sliders
                        document.getElementById('maxPopSlider').value = params.maxPopulation;
                        document.getElementById('maxPopValue').textContent = params.maxPopulation;
                        document.getElementById('mutationSlider').value = params.mutationRate * 100;
                        document.getElementById('mutationValue').textContent = (params.mutationRate * 100) + '%';
                        document.getElementById('energySlider').value = params.energyLevel * 100;
                        document.getElementById('energyValue').textContent = (params.energyLevel * 100) + '%';
                    }

                    if (imported.organisms && imported.organisms.length > 0) {
                        organisms = imported.organisms.map(data => {
                            const org = new Organism(data.code, null, data.speciesId);
                            org.fitness = data.fitness;
                            org.energy = data.energy;
                            org.age = data.age;
                            org.generation = data.generation;
                            return org;
                        });
                    }

                    if (imported.currentChallenge) {
                        currentChallenge = imported.currentChallenge;
                    }

                    updateStats();
                    initAchievements();
                    alert('Ecosystem imported successfully!');

                } catch (error) {
                    alert('Invalid JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // Help
        // ============================================

        function showHelp() {
            document.getElementById('helpOverlay').classList.remove('hidden');
        }

        function hideHelp() {
            document.getElementById('helpOverlay').classList.add('hidden');
        }

        // ============================================
        // Initialize
        // ============================================

        document.addEventListener('DOMContentLoaded', initSimulation);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    toggleSimulation();
                    break;
                case 'r':
                    if (e.ctrlKey || e.metaKey) return;
                    resetSimulation();
                    break;
                case 'h':
                    showHelp();
                    break;
                case 'Escape':
                    hideHelp();
                    selectOrganism(null);
                    break;
            }
        });
    </script>
</body>
</html>
