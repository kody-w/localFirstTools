<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics 365 Sales</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f2f2f2;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
            color: #323130;
        }

        /* Dynamics 365 Header */
        .d365-header {
            height: 48px;
            background: #0078d4;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.08);
        }

        .app-launcher {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 16px;
        }

        .app-launcher:hover {
            background: rgba(255,255,255,0.1);
        }

        .waffle-icon {
            display: grid;
            grid-template-columns: repeat(3, 4px);
            grid-gap: 3px;
        }

        .waffle-icon span {
            width: 4px;
            height: 4px;
            background: white;
        }

        .app-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-right: 24px;
        }

        .header-search {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 2px;
            padding: 6px 12px;
            color: white;
            width: 400px;
            outline: none;
        }

        .header-search::placeholder {
            color: rgba(255,255,255,0.8);
        }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 2px;
            color: white;
        }

        .header-icon:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 48px);
        }

        /* Left Navigation */
        .left-nav {
            width: 48px;
            background: #2b2b2b;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 8px;
        }

        .nav-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #c8c8c8;
            cursor: pointer;
            margin-bottom: 4px;
            border-radius: 2px;
            position: relative;
        }

        .nav-item:hover {
            background: #404040;
            color: white;
        }

        .nav-item.active {
            background: #404040;
            color: white;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 24px;
            background: #0078d4;
        }

        /* Site Map / Navigation Area */
        .sitemap {
            width: 200px;
            background: white;
            border-right: 1px solid #e1e1e1;
            padding: 16px 0;
            overflow-y: auto;
        }

        .sitemap-section {
            margin-bottom: 24px;
        }

        .sitemap-header {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #605e5c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sitemap-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #323130;
            text-decoration: none;
        }

        .sitemap-item:hover {
            background: #f3f2f1;
        }

        .sitemap-item.active {
            background: #edebe9;
            font-weight: 600;
        }

        /* Chat Panel */
        .chat-panel {
            width: 320px;
            background: white;
            border-right: 1px solid #e1e1e1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 16px;
            background: white;
            border-bottom: 1px solid #e1e1e1;
        }

        .chat-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .chat-subheader {
            font-size: 12px;
            color: #605e5c;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #faf9f8;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 8px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .message.ai .message-avatar {
            background: #0078d4;
        }

        .message.user .message-avatar {
            background: #5c2e91;
        }

        .message-content {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.4;
        }

        .message.ai .message-content {
            background: white;
            border: 1px solid #e1e1e1;
            color: #323130;
        }

        .message.user .message-content {
            background: #0078d4;
            color: white;
        }

        .chat-input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e1e1e1;
        }

        .chat-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            font-size: 14px;
            outline: none;
            resize: none;
            min-height: 36px;
            max-height: 100px;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #0078d4;
        }

        .chat-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .chat-hints {
            font-size: 11px;
            color: #605e5c;
        }

        .send-btn {
            padding: 5px 16px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-btn:hover {
            background: #106ebe;
        }

        /* Main Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f3f2f1;
            overflow: hidden;
        }

        /* Command Bar */
        .command-bar {
            background: white;
            border-bottom: 1px solid #e1e1e1;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
        }

        .command-btn {
            padding: 5px 12px;
            background: white;
            border: 1px solid #8a8886;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #323130;
            font-weight: 400;
        }

        .command-btn:hover {
            background: #f3f2f1;
        }

        .command-btn.primary {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .command-btn.primary:hover {
            background: #106ebe;
        }

        .command-separator {
            width: 1px;
            height: 20px;
            background: #e1e1e1;
            margin: 0 4px;
        }

        .view-selector {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .view-dropdown {
            padding: 5px 12px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Grid/List View */
        .grid-container {
            flex: 1;
            overflow: auto;
            background: white;
        }

        .grid-header {
            background: #faf9f8;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            align-items: center;
            min-height: 32px;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
            font-weight: 400;
        }

        .grid-header-cell {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            border-right: 1px solid #e1e1e1;
            color: #323130;
        }

        .grid-header-cell:hover {
            background: #edebe9;
        }

        .grid-body {
            min-height: 200px;
        }

        .grid-row {
            display: flex;
            border-bottom: 1px solid #edebe9;
            min-height: 40px;
            align-items: center;
            cursor: pointer;
            font-size: 13px;
        }

        .grid-row:hover {
            background: #faf9f8;
        }

        .grid-row.selected {
            background: #e1dfdd;
        }

        .grid-cell {
            padding: 8px 12px;
            border-right: 1px solid #edebe9;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .grid-cell a {
            color: #0078d4;
            text-decoration: none;
        }

        .grid-cell a:hover {
            text-decoration: underline;
        }

        /* Record Form */
        .record-form {
            padding: 24px;
            background: white;
            overflow-y: auto;
            display: none;
        }

        .form-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #edebe9;
        }

        .form-title {
            font-size: 24px;
            font-weight: 600;
            color: #323130;
        }

        .form-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .form-tabs {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            border-bottom: 1px solid #edebe9;
        }

        .form-tab {
            padding: 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: #605e5c;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .form-tab:hover {
            color: #323130;
        }

        .form-tab.active {
            color: #0078d4;
            border-bottom-color: #0078d4;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-field.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: #323130;
        }

        .form-input {
            padding: 6px 8px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            font-size: 14px;
            outline: none;
            background: white;
        }

        .form-input:focus {
            border-color: #0078d4;
        }

        .form-input[readonly] {
            background: #faf9f8;
            color: #605e5c;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.open {
            background: #e7f3ff;
            color: #004578;
        }

        .status-badge.qualified {
            background: #fff4ce;
            color: #8a6d00;
        }

        .status-badge.won {
            background: #dff6dd;
            color: #107c10;
        }

        .status-badge.lost {
            background: #fde7e9;
            color: #a80000;
        }

        /* Activities Timeline */
        .timeline {
            padding: 16px 0;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #edebe9;
        }

        .timeline-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f2f1;
            color: #605e5c;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .timeline-description {
            font-size: 13px;
            color: #605e5c;
            margin-bottom: 4px;
        }

        .timeline-date {
            font-size: 12px;
            color: #a19f9d;
        }

        /* Data Import/Export */
        .data-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }

        .data-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #8a8886;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-btn:hover {
            background: #f3f2f1;
        }

        #importFile {
            display: none;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f2f1;
            border-top-color: #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive column widths */
        .col-check { width: 40px; }
        .col-name { width: 200px; flex: 1; }
        .col-email { width: 200px; }
        .col-account { width: 180px; }
        .col-phone { width: 120px; }
        .col-city { width: 120px; }
        .col-state { width: 80px; }
        .col-owner { width: 150px; }
        .col-status { width: 100px; }
        .col-rating { width: 100px; }
        .col-value { width: 120px; }
        .col-date { width: 100px; }
        .col-probability { width: 80px; }
        .col-source { width: 120px; }
        .col-company { width: 150px; }
        .col-title { width: 150px; }
        .col-subject { flex: 1; min-width: 200px; }
        .col-regarding { width: 150px; }
        .col-priority { width: 100px; }
        .col-due { width: 100px; }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Dynamics 365 Header -->
    <div class="d365-header">
        <div class="app-launcher">
            <div class="waffle-icon">
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="app-title">Dynamics 365 | Sales Hub</div>
        <input type="text" class="header-search" placeholder="Search for records, views, and dashboards">
        <div class="header-right">
            <div class="header-icon" title="Settings">⚙️</div>
            <div class="header-icon" title="Help">❓</div>
            <div class="header-icon" title="Notifications">🔔</div>
            <div class="header-icon" title="Profile">👤</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Navigation -->
        <div class="left-nav">
            <div class="nav-item active" data-area="sales" title="Sales">📊</div>
            <div class="nav-item" data-area="service" title="Service">🎧</div>
            <div class="nav-item" data-area="marketing" title="Marketing">📢</div>
            <div class="nav-item" data-area="operations" title="Operations">⚙️</div>
        </div>

        <!-- Site Map -->
        <div class="sitemap">
            <div class="sitemap-section">
                <div class="sitemap-header">My Work</div>
                <div class="sitemap-item active" data-entity="dashboard">📊 Dashboards</div>
                <div class="sitemap-item" data-entity="activities">📅 Activities</div>
            </div>
            <div class="sitemap-section">
                <div class="sitemap-header">Customers</div>
                <div class="sitemap-item" data-entity="accounts">🏢 Accounts</div>
                <div class="sitemap-item" data-entity="contacts">👤 Contacts</div>
            </div>
            <div class="sitemap-section">
                <div class="sitemap-header">Sales</div>
                <div class="sitemap-item" data-entity="leads">🎯 Leads</div>
                <div class="sitemap-item" data-entity="opportunities">💰 Opportunities</div>
                <div class="sitemap-item" data-entity="quotes">📄 Quotes</div>
                <div class="sitemap-item" data-entity="orders">📦 Orders</div>
                <div class="sitemap-item" data-entity="invoices">🧾 Invoices</div>
            </div>
            <div class="sitemap-section">
                <div class="sitemap-header">Collateral</div>
                <div class="sitemap-item" data-entity="products">📦 Products</div>
                <div class="sitemap-item" data-entity="pricelists">💵 Price Lists</div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <h3>AI Assistant</h3>
                <div class="chat-subheader">Natural language CRM control</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        Hello! I'm your Dynamics 365 AI assistant. I can help you manage contacts, leads, opportunities, and more. Try asking me to:
                        <br><br>
                        • "Show leads from this week"<br>
                        • "Add a new contact"<br>
                        • "Find high-value opportunities"<br>
                        • "Update contact status"<br>
                        • "Show my tasks"
                    </div>
                </div>
            </div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Type your message here..." rows="1"></textarea>
                <div class="chat-actions">
                    <div class="chat-hints">Press Enter to send</div>
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Command Bar -->
            <div class="command-bar">
                <button class="command-btn primary" onclick="createNew()">
                    <span>➕</span> New
                </button>
                <button class="command-btn" onclick="deleteSelected()">
                    <span>🗑️</span> Delete
                </button>
                <div class="command-separator"></div>
                <button class="command-btn" onclick="refreshData()">
                    <span>🔄</span> Refresh
                </button>
                <button class="command-btn" onclick="exportToExcel()">
                    <span>📊</span> Export to Excel
                </button>
                <div class="command-separator"></div>
                <button class="command-btn" onclick="showChart()">
                    <span>📈</span> Show Chart
                </button>
                <div class="view-selector">
                    <span>View:</span>
                    <select class="view-dropdown" id="viewSelector" onchange="changeView()">
                        <option value="active">My Active Contacts</option>
                        <option value="all">All Contacts</option>
                        <option value="recent">Recently Viewed</option>
                        <option value="followed">Followed Contacts</option>
                    </select>
                </div>
            </div>

            <!-- Grid View -->
            <div class="grid-container" id="gridContainer">
                <div class="grid-header" id="gridHeader">
                    <!-- Headers will be generated dynamically -->
                </div>
                <div class="grid-body" id="gridBody">
                    <!-- Grid rows will be generated dynamically -->
                </div>
            </div>

            <!-- Record Form (hidden by default) -->
            <div class="record-form" id="recordForm">
                <!-- Form content will be generated dynamically -->
            </div>
        </div>
    </div>

    <!-- Data Import/Export Controls -->
    <div class="data-controls">
        <button class="data-btn" onclick="exportData()">📥 Export Data</button>
        <button class="data-btn" onclick="document.getElementById('importFile').click()">📤 Import Data</button>
        <input type="file" id="importFile" accept=".json" onchange="importData(event)">
    </div>

    <script>
        // Dynamics 365 Data Schema
        class CRMData {
            constructor() {
                this.accounts = [];
                this.contacts = [];
                this.leads = [];
                this.opportunities = [];
                this.activities = [];
                this.quotes = [];
                this.orders = [];
                this.invoices = [];
                this.products = [];
                this.pricelists = [];
                this.currentEntity = 'contacts';
                this.selectedRecords = new Set();
                this.initializeData();
            }

            initializeData() {
                // Load from localStorage or initialize with sample data
                const savedData = localStorage.getItem('dynamics365_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    Object.assign(this, data);
                } else {
                    this.createSampleData();
                }
            }

            createSampleData() {
                // Sample Accounts (Companies)
                this.accounts = [
                    {
                        accountid: this.generateGuid(),
                        name: 'Contoso Ltd.',
                        accountnumber: 'ACC-001',
                        telephone1: '555-0100',
                        address1_city: 'Seattle',
                        address1_stateorprovince: 'WA',
                        address1_country: 'United States',
                        revenue: 5000000,
                        numberofemployees: 250,
                        industrycode: 'Technology',
                        accountratingcode: 'High',
                        ownerid: 'John Smith',
                        createdon: '2024-01-15T10:00:00Z',
                        modifiedon: '2024-12-01T14:30:00Z',
                        statecode: 0,
                        statuscode: 1
                    },
                    {
                        accountid: this.generateGuid(),
                        name: 'Fabrikam, Inc.',
                        accountnumber: 'ACC-002',
                        telephone1: '555-0101',
                        address1_city: 'Redmond',
                        address1_stateorprovince: 'WA',
                        address1_country: 'United States',
                        revenue: 10000000,
                        numberofemployees: 500,
                        industrycode: 'Manufacturing',
                        accountratingcode: 'High',
                        ownerid: 'Sarah Johnson',
                        createdon: '2024-02-20T09:00:00Z',
                        modifiedon: '2024-11-28T16:45:00Z',
                        statecode: 0,
                        statuscode: 1
                    },
                    {
                        accountid: this.generateGuid(),
                        name: 'Adventure Works',
                        accountnumber: 'ACC-003',
                        telephone1: '555-0102',
                        address1_city: 'Bellevue',
                        address1_stateorprovince: 'WA',
                        address1_country: 'United States',
                        revenue: 15000000,
                        numberofemployees: 750,
                        industrycode: 'Retail',
                        accountratingcode: 'Medium',
                        ownerid: 'Michael Chen',
                        createdon: '2024-03-10T11:30:00Z',
                        modifiedon: '2024-11-25T13:20:00Z',
                        statecode: 0,
                        statuscode: 1
                    }
                ];

                // Sample Contacts
                this.contacts = [
                    {
                        contactid: this.generateGuid(),
                        fullname: 'Nancy Anderson',
                        firstname: 'Nancy',
                        lastname: 'Anderson',
                        jobtitle: 'Purchasing Manager',
                        parentcustomerid: this.accounts[0].accountid,
                        parentcustomername: this.accounts[0].name,
                        emailaddress1: 'nancy@contoso.com',
                        telephone1: '555-0110',
                        mobilephone: '555-0210',
                        address1_city: 'Seattle',
                        address1_stateorprovince: 'WA',
                        address1_country: 'United States',
                        birthdate: '1985-05-15',
                        ownerid: 'John Smith',
                        createdon: '2024-01-20T10:00:00Z',
                        modifiedon: '2024-12-01T09:00:00Z',
                        statecode: 0,
                        statuscode: 1,
                        preferredcontactmethodcode: 'Email'
                    },
                    {
                        contactid: this.generateGuid(),
                        fullname: 'Robert Lyon',
                        firstname: 'Robert',
                        lastname: 'Lyon',
                        jobtitle: 'CEO',
                        parentcustomerid: this.accounts[1].accountid,
                        parentcustomername: this.accounts[1].name,
                        emailaddress1: 'robert@fabrikam.com',
                        telephone1: '555-0111',
                        mobilephone: '555-0211',
                        address1_city: 'Redmond',
                        address1_stateorprovince: 'WA',
                        address1_country: 'United States',
                        birthdate: '1978-03-22',
                        ownerid: 'Sarah Johnson',
                        createdon: '2024-02-25T11:30:00Z',
                        modifiedon: '2024-11-30T10:15:00Z',
                        statecode: 0,
                        statuscode: 1,
                        preferredcontactmethodcode: 'Phone'
                    },
                    {
                        contactid: this.generateGuid(),
                        fullname: 'Lisa Miller',
                        firstname: 'Lisa',
                        lastname: 'Miller',
                        jobtitle: 'IT Director',
                        parentcustomerid: this.accounts[2].accountid,
                        parentcustomername: this.accounts[2].name,
                        emailaddress1: 'lisa@adventureworks.com',
                        telephone1: '555-0112',
                        mobilephone: '555-0212',
                        address1_city: 'Bellevue',
                        address1_stateorprovince: 'WA',
                        address1_country: 'United States',
                        birthdate: '1982-07-10',
                        ownerid: 'Michael Chen',
                        createdon: '2024-03-15T14:00:00Z',
                        modifiedon: '2024-11-29T15:30:00Z',
                        statecode: 0,
                        statuscode: 1,
                        preferredcontactmethodcode: 'Email'
                    }
                ];

                // Sample Leads
                this.leads = [
                    {
                        leadid: this.generateGuid(),
                        subject: 'Interested in Enterprise Solution',
                        fullname: 'Jennifer Brown',
                        firstname: 'Jennifer',
                        lastname: 'Brown',
                        jobtitle: 'CTO',
                        companyname: 'TechStart Inc.',
                        emailaddress1: 'jennifer@techstart.com',
                        telephone1: '555-0120',
                        mobilephone: '555-0220',
                        address1_city: 'Portland',
                        address1_stateorprovince: 'OR',
                        address1_country: 'United States',
                        leadsourcecode: 'Web',
                        leadqualitycode: 'Hot',
                        estimatedvalue: 75000,
                        estimatedclosedate: '2025-02-15',
                        description: 'Looking for comprehensive CRM solution for 100+ users',
                        ownerid: 'John Smith',
                        createdon: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    },
                    {
                        leadid: this.generateGuid(),
                        subject: 'Product Demo Request',
                        fullname: 'David Wilson',
                        firstname: 'David',
                        lastname: 'Wilson',
                        jobtitle: 'Operations Manager',
                        companyname: 'Global Industries',
                        emailaddress1: 'david@globalind.com',
                        telephone1: '555-0121',
                        mobilephone: '555-0221',
                        address1_city: 'Chicago',
                        address1_stateorprovince: 'IL',
                        address1_country: 'United States',
                        leadsourcecode: 'Partner',
                        leadqualitycode: 'Warm',
                        estimatedvalue: 120000,
                        estimatedclosedate: '2025-03-30',
                        description: 'Referred by Microsoft partner, needs sales automation',
                        ownerid: 'Sarah Johnson',
                        createdon: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        modifiedon: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        statecode: 0,
                        statuscode: 1
                    }
                ];

                // Sample Opportunities
                this.opportunities = [
                    {
                        opportunityid: this.generateGuid(),
                        name: 'Contoso CRM Implementation',
                        parentaccountid: this.accounts[0].accountid,
                        parentaccountname: this.accounts[0].name,
                        parentcontactid: this.contacts[0].contactid,
                        parentcontactname: this.contacts[0].fullname,
                        estimatedvalue: 250000,
                        estimatedclosedate: '2025-03-31',
                        closeprobability: 80,
                        currentphase: 'Propose',
                        description: 'Full CRM implementation including customization and training',
                        ownerid: 'John Smith',
                        createdon: '2024-10-01T10:00:00Z',
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1,
                        stepname: 'Proposal',
                        salesstage: 3
                    },
                    {
                        opportunityid: this.generateGuid(),
                        name: 'Fabrikam Cloud Migration',
                        parentaccountid: this.accounts[1].accountid,
                        parentaccountname: this.accounts[1].name,
                        parentcontactid: this.contacts[1].contactid,
                        parentcontactname: this.contacts[1].fullname,
                        estimatedvalue: 500000,
                        estimatedclosedate: '2025-06-30',
                        closeprobability: 60,
                        currentphase: 'Develop',
                        description: 'Complete cloud infrastructure migration project',
                        ownerid: 'Sarah Johnson',
                        createdon: '2024-11-01T09:00:00Z',
                        modifiedon: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        statecode: 0,
                        statuscode: 1,
                        stepname: 'Development',
                        salesstage: 2
                    }
                ];

                // Sample Activities
                this.activities = [
                    {
                        activityid: this.generateGuid(),
                        subject: 'Follow up on proposal',
                        description: 'Discuss pricing options and timeline',
                        activitytypecode: 'Task',
                        scheduledstart: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString(),
                        scheduledend: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString(),
                        prioritycode: 'High',
                        regardingobjectid: this.opportunities[0].opportunityid,
                        regardingname: this.opportunities[0].name,
                        ownerid: 'John Smith',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    },
                    {
                        activityid: this.generateGuid(),
                        subject: 'Demo meeting',
                        description: 'Product demonstration for stakeholders',
                        activitytypecode: 'Appointment',
                        scheduledstart: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                        scheduledend: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 + 60 * 60 * 1000).toISOString(),
                        prioritycode: 'Normal',
                        regardingobjectid: this.leads[0].leadid,
                        regardingname: this.leads[0].subject,
                        ownerid: 'John Smith',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    },
                    {
                        activityid: this.generateGuid(),
                        subject: 'Send contract',
                        description: 'Email final contract for review',
                        activitytypecode: 'Email',
                        scheduledstart: new Date().toISOString(),
                        scheduledend: new Date().toISOString(),
                        prioritycode: 'High',
                        regardingobjectid: this.opportunities[1].opportunityid,
                        regardingname: this.opportunities[1].name,
                        ownerid: 'Sarah Johnson',
                        createdon: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 1,
                        statuscode: 2
                    }
                ];

                this.saveData();
            }

            generateGuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            saveData() {
                const dataToSave = {
                    accounts: this.accounts,
                    contacts: this.contacts,
                    leads: this.leads,
                    opportunities: this.opportunities,
                    activities: this.activities,
                    quotes: this.quotes,
                    orders: this.orders,
                    invoices: this.invoices,
                    products: this.products,
                    pricelists: this.pricelists
                };
                localStorage.setItem('dynamics365_data', JSON.stringify(dataToSave));
            }

            getEntityData(entityName) {
                switch(entityName) {
                    case 'accounts': return this.accounts;
                    case 'contacts': return this.contacts;
                    case 'leads': return this.leads;
                    case 'opportunities': return this.opportunities;
                    case 'activities': return this.activities;
                    case 'quotes': return this.quotes;
                    case 'orders': return this.orders;
                    case 'invoices': return this.invoices;
                    case 'products': return this.products;
                    case 'pricelists': return this.pricelists;
                    default: return [];
                }
            }
        }

        // Initialize CRM Data
        const crmData = new CRMData();

        // AI Chat Processing
        class AIAssistant {
            processMessage(message) {
                const lowerMessage = message.toLowerCase();
                
                // Parse intent
                if (lowerMessage.includes('show') || lowerMessage.includes('find') || lowerMessage.includes('list') || lowerMessage.includes('search')) {
                    return this.handleSearch(message);
                } else if (lowerMessage.includes('add') || lowerMessage.includes('create') || lowerMessage.includes('new')) {
                    return this.handleCreate(message);
                } else if (lowerMessage.includes('update') || lowerMessage.includes('change') || lowerMessage.includes('modify')) {
                    return this.handleUpdate(message);
                } else if (lowerMessage.includes('delete') || lowerMessage.includes('remove')) {
                    return this.handleDelete(message);
                } else if (lowerMessage.includes('task') || lowerMessage.includes('activity') || lowerMessage.includes('appointment')) {
                    return this.handleActivities(message);
                } else if (lowerMessage.includes('help')) {
                    return this.getHelp();
                } else {
                    return this.getGeneralResponse(message);
                }
            }

            handleSearch(message) {
                const lowerMessage = message.toLowerCase();
                let results = [];
                let entityType = '';

                // Determine entity type
                if (lowerMessage.includes('lead')) {
                    entityType = 'leads';
                    results = crmData.leads;
                } else if (lowerMessage.includes('contact')) {
                    entityType = 'contacts';
                    results = crmData.contacts;
                } else if (lowerMessage.includes('account') || lowerMessage.includes('compan')) {
                    entityType = 'accounts';
                    results = crmData.accounts;
                } else if (lowerMessage.includes('opportunit')) {
                    entityType = 'opportunities';
                    results = crmData.opportunities;
                } else if (lowerMessage.includes('task') || lowerMessage.includes('activit')) {
                    entityType = 'activities';
                    results = crmData.activities;
                }

                // Apply filters
                if (lowerMessage.includes('this week') || lowerMessage.includes('recent')) {
                    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    results = results.filter(r => new Date(r.createdon) > oneWeekAgo);
                }

                if (lowerMessage.includes('high value') || lowerMessage.includes('high-value')) {
                    if (entityType === 'opportunities') {
                        results = results.filter(r => r.estimatedvalue > 100000);
                    } else if (entityType === 'leads') {
                        results = results.filter(r => r.estimatedvalue > 50000);
                    }
                }

                if (lowerMessage.includes('hot')) {
                    results = results.filter(r => r.leadqualitycode === 'Hot');
                }

                // Update view
                if (entityType && results.length > 0) {
                    switchToEntity(entityType);
                    renderGrid(entityType, results);
                    return `Found ${results.length} ${entityType}. I've updated the view to show these records.`;
                } else if (entityType) {
                    return `No ${entityType} found matching your criteria.`;
                } else {
                    return "I couldn't determine what type of records you're looking for. Try specifying 'contacts', 'leads', 'accounts', or 'opportunities'.";
                }
            }

            handleCreate(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('contact')) {
                    // Extract name from message
                    const nameMatch = message.match(/named?\s+([A-Z][a-z]+\s+[A-Z][a-z]+)/);
                    const emailMatch = message.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/);
                    
                    const newContact = {
                        contactid: crmData.generateGuid(),
                        fullname: nameMatch ? nameMatch[1] : 'New Contact',
                        firstname: nameMatch ? nameMatch[1].split(' ')[0] : 'New',
                        lastname: nameMatch ? nameMatch[1].split(' ')[1] : 'Contact',
                        emailaddress1: emailMatch ? emailMatch[0] : 'email@company.com',
                        telephone1: '555-0000',
                        jobtitle: 'Manager',
                        ownerid: 'Current User',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    };
                    
                    crmData.contacts.push(newContact);
                    crmData.saveData();
                    switchToEntity('contacts');
                    renderGrid('contacts', crmData.contacts);
                    
                    return `Contact "${newContact.fullname}" has been created successfully. You can see it in the contacts list.`;
                } else if (lowerMessage.includes('lead')) {
                    const newLead = {
                        leadid: crmData.generateGuid(),
                        subject: 'New Lead',
                        fullname: 'New Lead',
                        firstname: 'New',
                        lastname: 'Lead',
                        companyname: 'New Company',
                        emailaddress1: 'lead@company.com',
                        telephone1: '555-0000',
                        leadsourcecode: 'Web',
                        leadqualitycode: 'Warm',
                        estimatedvalue: 50000,
                        ownerid: 'Current User',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    };
                    
                    crmData.leads.push(newLead);
                    crmData.saveData();
                    switchToEntity('leads');
                    renderGrid('leads', crmData.leads);
                    
                    return `New lead has been created successfully. You can edit the details in the lead form.`;
                }
                
                return "Please specify what you'd like to create (e.g., 'create a new contact named John Smith').";
            }

            handleUpdate(message) {
                return "To update a record, click on it in the grid to open the form, make your changes, and save. You can also tell me specific updates like 'update contact status to inactive'.";
            }

            handleDelete(message) {
                return "To delete records, select them in the grid using the checkboxes and click the Delete button in the command bar.";
            }

            handleActivities(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('my task') || lowerMessage.includes('my activit')) {
                    switchToEntity('activities');
                    renderGrid('activities', crmData.activities);
                    return `Showing ${crmData.activities.length} activities. You have ${crmData.activities.filter(a => a.statecode === 0).length} open items.`;
                }
                
                return "Here are your activities. Click on any activity to view or edit details.";
            }

            getHelp() {
                return `I can help you with:
                
• **Finding Records**: "Show me leads from this week", "Find hot leads", "List high-value opportunities"
• **Creating Records**: "Add a new contact named John Smith", "Create a new lead"
• **Managing Tasks**: "Show my tasks", "What activities do I have?"
• **Filtering Data**: "Show contacts from Seattle", "Find accounts worth over 1 million"
• **Quick Actions**: Click any record to view details, use checkboxes to select multiple records

What would you like to do?`;
            }

            getGeneralResponse(message) {
                return "I can help you manage your CRM data. Try asking me to show contacts, leads, or opportunities. You can also ask me to create new records or find specific information.";
            }
        }

        const aiAssistant = new AIAssistant();

        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Process with AI
            setTimeout(() => {
                const response = aiAssistant.processMessage(message);
                addChatMessage(response, 'ai');
            }, 500);
        }

        function addChatMessage(content, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Enter key handler for chat
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // Entity switching
        function switchToEntity(entityName) {
            // Update sitemap active state
            document.querySelectorAll('.sitemap-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.entity === entityName) {
                    item.classList.add('active');
                }
            });
            
            crmData.currentEntity = entityName;
            renderGrid(entityName);
        }

        // Grid rendering
        function renderGrid(entityName, data = null) {
            const gridHeader = document.getElementById('gridHeader');
            const gridBody = document.getElementById('gridBody');
            const recordForm = document.getElementById('recordForm');
            const gridContainer = document.getElementById('gridContainer');
            
            // Show grid, hide form
            gridContainer.style.display = 'block';
            recordForm.style.display = 'none';
            
            // Clear existing content
            gridHeader.innerHTML = '';
            gridBody.innerHTML = '';
            
            // Get data if not provided
            if (!data) {
                data = crmData.getEntityData(entityName);
            }
            
            // Define columns based on entity
            let columns = [];
            switch(entityName) {
                case 'contacts':
                    columns = [
                        { field: 'select', label: '', width: 'col-check' },
                        { field: 'fullname', label: 'Full Name', width: 'col-name' },
                        { field: 'emailaddress1', label: 'Email', width: 'col-email' },
                        { field: 'parentcustomername', label: 'Account', width: 'col-account' },
                        { field: 'telephone1', label: 'Business Phone', width: 'col-phone' },
                        { field: 'address1_city', label: 'City', width: 'col-city' },
                        { field: 'ownerid', label: 'Owner', width: 'col-owner' }
                    ];
                    break;
                case 'leads':
                    columns = [
                        { field: 'select', label: '', width: 'col-check' },
                        { field: 'subject', label: 'Topic', width: 'col-subject' },
                        { field: 'fullname', label: 'Name', width: 'col-name' },
                        { field: 'companyname', label: 'Company', width: 'col-company' },
                        { field: 'emailaddress1', label: 'Email', width: 'col-email' },
                        { field: 'leadqualitycode', label: 'Rating', width: 'col-rating' },
                        { field: 'leadsourcecode', label: 'Source', width: 'col-source' },
                        { field: 'ownerid', label: 'Owner', width: 'col-owner' }
                    ];
                    break;
                case 'accounts':
                    columns = [
                        { field: 'select', label: '', width: 'col-check' },
                        { field: 'name', label: 'Account Name', width: 'col-name' },
                        { field: 'accountnumber', label: 'Account Number', width: 'col-account' },
                        { field: 'telephone1', label: 'Main Phone', width: 'col-phone' },
                        { field: 'address1_city', label: 'City', width: 'col-city' },
                        { field: 'revenue', label: 'Annual Revenue', width: 'col-value' },
                        { field: 'ownerid', label: 'Owner', width: 'col-owner' }
                    ];
                    break;
                case 'opportunities':
                    columns = [
                        { field: 'select', label: '', width: 'col-check' },
                        { field: 'name', label: 'Topic', width: 'col-subject' },
                        { field: 'parentaccountname', label: 'Account', width: 'col-account' },
                        { field: 'estimatedvalue', label: 'Est. Revenue', width: 'col-value' },
                        { field: 'estimatedclosedate', label: 'Est. Close Date', width: 'col-date' },
                        { field: 'closeprobability', label: 'Probability %', width: 'col-probability' },
                        { field: 'ownerid', label: 'Owner', width: 'col-owner' }
                    ];
                    break;
                case 'activities':
                    columns = [
                        { field: 'select', label: '', width: 'col-check' },
                        { field: 'subject', label: 'Subject', width: 'col-subject' },
                        { field: 'activitytypecode', label: 'Type', width: 'col-status' },
                        { field: 'regardingname', label: 'Regarding', width: 'col-regarding' },
                        { field: 'prioritycode', label: 'Priority', width: 'col-priority' },
                        { field: 'scheduledstart', label: 'Due Date', width: 'col-due' },
                        { field: 'ownerid', label: 'Owner', width: 'col-owner' }
                    ];
                    break;
                default:
                    columns = [
                        { field: 'select', label: '', width: 'col-check' },
                        { field: 'name', label: 'Name', width: 'col-name' }
                    ];
            }
            
            // Render headers
            columns.forEach(col => {
                const headerCell = document.createElement('div');
                headerCell.className = `grid-header-cell ${col.width}`;
                if (col.field === 'select') {
                    headerCell.innerHTML = '<input type="checkbox" onchange="toggleSelectAll(this)">';
                } else {
                    headerCell.innerHTML = `${col.label} <span style="font-size: 10px;">▼</span>`;
                }
                gridHeader.appendChild(headerCell);
            });
            
            // Render rows
            data.forEach((record, index) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.dataset.index = index;
                
                columns.forEach(col => {
                    const cell = document.createElement('div');
                    cell.className = `grid-cell ${col.width}`;
                    
                    if (col.field === 'select') {
                        cell.innerHTML = `<input type="checkbox" onclick="toggleRowSelection(event, '${record[Object.keys(record)[0]]}')">`;
                    } else {
                        let value = record[col.field] || '';
                        
                        // Format special fields
                        if (col.field === 'revenue' || col.field === 'estimatedvalue') {
                            value = value ? `$${value.toLocaleString()}` : '';
                        } else if (col.field.includes('date')) {
                            value = value ? new Date(value).toLocaleDateString() : '';
                        } else if (col.field === 'closeprobability') {
                            value = value ? `${value}%` : '';
                        }
                        
                        // Make name fields clickable
                        if (col.field === 'fullname' || col.field === 'name' || col.field === 'subject') {
                            cell.innerHTML = `<a href="#" onclick="openRecord(event, '${entityName}', ${index})">${value}</a>`;
                        } else {
                            cell.textContent = value;
                        }
                    }
                    
                    row.appendChild(cell);
                });
                
                gridBody.appendChild(row);
            });
            
            // Update view selector
            updateViewSelector(entityName);
        }

        function updateViewSelector(entityName) {
            const viewSelector = document.getElementById('viewSelector');
            viewSelector.innerHTML = '';
            
            let views = [];
            switch(entityName) {
                case 'contacts':
                    views = [
                        { value: 'active', label: 'My Active Contacts' },
                        { value: 'all', label: 'All Contacts' },
                        { value: 'recent', label: 'Recently Viewed Contacts' }
                    ];
                    break;
                case 'leads':
                    views = [
                        { value: 'open', label: 'Open Leads' },
                        { value: 'hot', label: 'Hot Leads' },
                        { value: 'myopen', label: 'My Open Leads' }
                    ];
                    break;
                case 'accounts':
                    views = [
                        { value: 'active', label: 'My Active Accounts' },
                        { value: 'all', label: 'All Accounts' },
                        { value: 'top', label: 'Top Revenue Accounts' }
                    ];
                    break;
                case 'opportunities':
                    views = [
                        { value: 'open', label: 'Open Opportunities' },
                        { value: 'closing', label: 'Closing This Month' },
                        { value: 'won', label: 'Won Opportunities' }
                    ];
                    break;
                case 'activities':
                    views = [
                        { value: 'my', label: 'My Activities' },
                        { value: 'open', label: 'Open Activities' },
                        { value: 'overdue', label: 'Overdue Activities' }
                    ];
                    break;
                default:
                    views = [{ value: 'all', label: 'All Records' }];
            }
            
            views.forEach(view => {
                const option = document.createElement('option');
                option.value = view.value;
                option.textContent = view.label;
                viewSelector.appendChild(option);
            });
        }

        function openRecord(event, entityName, index) {
            event.preventDefault();
            const data = crmData.getEntityData(entityName);
            const record = data[index];
            
            // Hide grid, show form
            document.getElementById('gridContainer').style.display = 'none';
            document.getElementById('recordForm').style.display = 'block';
            
            renderRecordForm(entityName, record);
        }

        function renderRecordForm(entityName, record) {
            const formDiv = document.getElementById('recordForm');
            let formHTML = '';
            
            switch(entityName) {
                case 'contacts':
                    formHTML = `
                        <div class="form-header">
                            <div class="form-title">${record.fullname}</div>
                            <div class="form-actions">
                                <button class="command-btn" onclick="saveRecord('${entityName}', '${record.contactid}')">Save</button>
                                <button class="command-btn" onclick="closeForm()">Close</button>
                            </div>
                        </div>
                        <div class="form-tabs">
                            <div class="form-tab active">Summary</div>
                            <div class="form-tab">Details</div>
                            <div class="form-tab">Activities</div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">Contact Information</div>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-input" value="${record.firstname || ''}" data-field="firstname">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-input" value="${record.lastname || ''}" data-field="lastname">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Job Title</label>
                                    <input type="text" class="form-input" value="${record.jobtitle || ''}" data-field="jobtitle">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Account</label>
                                    <input type="text" class="form-input" value="${record.parentcustomername || ''}" data-field="parentcustomername">
                                </div>
                                <div class="form-field full-width">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" value="${record.emailaddress1 || ''}" data-field="emailaddress1">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Business Phone</label>
                                    <input type="text" class="form-input" value="${record.telephone1 || ''}" data-field="telephone1">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Mobile Phone</label>
                                    <input type="text" class="form-input" value="${record.mobilephone || ''}" data-field="mobilephone">
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">Address</div>
                            <div class="form-grid">
                                <div class="form-field full-width">
                                    <label class="form-label">Street</label>
                                    <input type="text" class="form-input" value="${record.address1_street || ''}" data-field="address1_street">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-input" value="${record.address1_city || ''}" data-field="address1_city">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">State/Province</label>
                                    <input type="text" class="form-input" value="${record.address1_stateorprovince || ''}" data-field="address1_stateorprovince">
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'leads':
                    formHTML = `
                        <div class="form-header">
                            <div class="form-title">${record.subject}</div>
                            <div class="form-actions">
                                <button class="command-btn primary" onclick="qualifyLead('${record.leadid}')">Qualify</button>
                                <button class="command-btn" onclick="saveRecord('${entityName}', '${record.leadid}')">Save</button>
                                <button class="command-btn" onclick="closeForm()">Close</button>
                            </div>
                        </div>
                        <div class="form-tabs">
                            <div class="form-tab active">Summary</div>
                            <div class="form-tab">Details</div>
                            <div class="form-tab">Activities</div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">Lead Information</div>
                            <div class="form-grid">
                                <div class="form-field full-width">
                                    <label class="form-label">Topic</label>
                                    <input type="text" class="form-input" value="${record.subject || ''}" data-field="subject">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-input" value="${record.firstname || ''}" data-field="firstname">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-input" value="${record.lastname || ''}" data-field="lastname">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Job Title</label>
                                    <input type="text" class="form-input" value="${record.jobtitle || ''}" data-field="jobtitle">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Company</label>
                                    <input type="text" class="form-input" value="${record.companyname || ''}" data-field="companyname">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" value="${record.emailaddress1 || ''}" data-field="emailaddress1">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Business Phone</label>
                                    <input type="text" class="form-input" value="${record.telephone1 || ''}" data-field="telephone1">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Rating</label>
                                    <select class="form-input" data-field="leadqualitycode">
                                        <option value="Hot" ${record.leadqualitycode === 'Hot' ? 'selected' : ''}>Hot</option>
                                        <option value="Warm" ${record.leadqualitycode === 'Warm' ? 'selected' : ''}>Warm</option>
                                        <option value="Cold" ${record.leadqualitycode === 'Cold' ? 'selected' : ''}>Cold</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Lead Source</label>
                                    <select class="form-input" data-field="leadsourcecode">
                                        <option value="Web" ${record.leadsourcecode === 'Web' ? 'selected' : ''}>Web</option>
                                        <option value="Partner" ${record.leadsourcecode === 'Partner' ? 'selected' : ''}>Partner</option>
                                        <option value="Advertisement" ${record.leadsourcecode === 'Advertisement' ? 'selected' : ''}>Advertisement</option>
                                        <option value="Trade Show" ${record.leadsourcecode === 'Trade Show' ? 'selected' : ''}>Trade Show</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Est. Value</label>
                                    <input type="number" class="form-input" value="${record.estimatedvalue || ''}" data-field="estimatedvalue">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Est. Close Date</label>
                                    <input type="date" class="form-input" value="${record.estimatedclosedate ? record.estimatedclosedate.split('T')[0] : ''}" data-field="estimatedclosedate">
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'opportunities':
                    formHTML = `
                        <div class="form-header">
                            <div class="form-title">${record.name}</div>
                            <div class="form-actions">
                                <button class="command-btn primary" onclick="closeAsWon('${record.opportunityid}')">Close as Won</button>
                                <button class="command-btn" onclick="saveRecord('${entityName}', '${record.opportunityid}')">Save</button>
                                <button class="command-btn" onclick="closeForm()">Close</button>
                            </div>
                        </div>
                        <div class="form-tabs">
                            <div class="form-tab active">Summary</div>
                            <div class="form-tab">Product Line Items</div>
                            <div class="form-tab">Competitors</div>
                            <div class="form-tab">Activities</div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">Opportunity Information</div>
                            <div class="form-grid">
                                <div class="form-field full-width">
                                    <label class="form-label">Topic</label>
                                    <input type="text" class="form-input" value="${record.name || ''}" data-field="name">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Account</label>
                                    <input type="text" class="form-input" value="${record.parentaccountname || ''}" data-field="parentaccountname">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Contact</label>
                                    <input type="text" class="form-input" value="${record.parentcontactname || ''}" data-field="parentcontactname">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Est. Revenue</label>
                                    <input type="number" class="form-input" value="${record.estimatedvalue || ''}" data-field="estimatedvalue">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Est. Close Date</label>
                                    <input type="date" class="form-input" value="${record.estimatedclosedate ? record.estimatedclosedate.split('T')[0] : ''}" data-field="estimatedclosedate">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Probability (%)</label>
                                    <input type="number" class="form-input" value="${record.closeprobability || ''}" data-field="closeprobability" min="0" max="100">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Sales Stage</label>
                                    <select class="form-input" data-field="salesstage">
                                        <option value="1" ${record.salesstage === 1 ? 'selected' : ''}>Qualify</option>
                                        <option value="2" ${record.salesstage === 2 ? 'selected' : ''}>Develop</option>
                                        <option value="3" ${record.salesstage === 3 ? 'selected' : ''}>Propose</option>
                                        <option value="4" ${record.salesstage === 4 ? 'selected' : ''}>Close</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">Description</div>
                            <div class="form-grid">
                                <div class="form-field full-width">
                                    <textarea class="form-input" rows="4" data-field="description">${record.description || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            formDiv.innerHTML = formHTML;
        }

        function closeForm() {
            document.getElementById('gridContainer').style.display = 'block';
            document.getElementById('recordForm').style.display = 'none';
        }

        function saveRecord(entityName, recordId) {
            const inputs = document.querySelectorAll('#recordForm .form-input');
            const data = crmData.getEntityData(entityName);
            const record = data.find(r => r[Object.keys(r)[0]] === recordId);
            
            if (record) {
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (field) {
                        if (input.type === 'number') {
                            record[field] = parseFloat(input.value) || 0;
                        } else {
                            record[field] = input.value;
                        }
                    }
                });
                
                record.modifiedon = new Date().toISOString();
                crmData.saveData();
                
                addChatMessage(`Record has been saved successfully.`, 'ai');
                closeForm();
                renderGrid(entityName);
            }
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.grid-row input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            
            if (checkbox.checked) {
                const data = crmData.getEntityData(crmData.currentEntity);
                data.forEach(record => {
                    crmData.selectedRecords.add(record[Object.keys(record)[0]]);
                });
            } else {
                crmData.selectedRecords.clear();
            }
        }

        function toggleRowSelection(event, recordId) {
            event.stopPropagation();
            if (event.target.checked) {
                crmData.selectedRecords.add(recordId);
            } else {
                crmData.selectedRecords.delete(recordId);
            }
        }

        // Command bar functions
        function createNew() {
            const entityName = crmData.currentEntity;
            let newRecord = {};
            
            switch(entityName) {
                case 'contacts':
                    newRecord = {
                        contactid: crmData.generateGuid(),
                        fullname: 'New Contact',
                        firstname: 'New',
                        lastname: 'Contact',
                        emailaddress1: '',
                        telephone1: '',
                        ownerid: 'Current User',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    };
                    crmData.contacts.push(newRecord);
                    break;
                case 'leads':
                    newRecord = {
                        leadid: crmData.generateGuid(),
                        subject: 'New Lead',
                        fullname: 'New Lead',
                        firstname: 'New',
                        lastname: 'Lead',
                        companyname: '',
                        emailaddress1: '',
                        telephone1: '',
                        leadsourcecode: 'Web',
                        leadqualitycode: 'Warm',
                        estimatedvalue: 0,
                        ownerid: 'Current User',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    };
                    crmData.leads.push(newRecord);
                    break;
                case 'opportunities':
                    newRecord = {
                        opportunityid: crmData.generateGuid(),
                        name: 'New Opportunity',
                        estimatedvalue: 0,
                        estimatedclosedate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        closeprobability: 50,
                        currentphase: 'Qualify',
                        ownerid: 'Current User',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1,
                        salesstage: 1
                    };
                    crmData.opportunities.push(newRecord);
                    break;
                case 'accounts':
                    newRecord = {
                        accountid: crmData.generateGuid(),
                        name: 'New Account',
                        accountnumber: 'ACC-' + Date.now().toString().slice(-4),
                        telephone1: '',
                        address1_city: '',
                        address1_stateorprovince: '',
                        address1_country: '',
                        revenue: 0,
                        ownerid: 'Current User',
                        createdon: new Date().toISOString(),
                        modifiedon: new Date().toISOString(),
                        statecode: 0,
                        statuscode: 1
                    };
                    crmData.accounts.push(newRecord);
                    break;
            }
            
            crmData.saveData();
            renderGrid(entityName);
            
            // Open the new record for editing
            const data = crmData.getEntityData(entityName);
            openRecord(new Event('click'), entityName, data.length - 1);
        }

        function deleteSelected() {
            if (crmData.selectedRecords.size === 0) {
                alert('Please select records to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${crmData.selectedRecords.size} record(s)?`)) {
                const entityName = crmData.currentEntity;
                const data = crmData.getEntityData(entityName);
                const idField = Object.keys(data[0])[0];
                
                // Remove selected records
                for (let i = data.length - 1; i >= 0; i--) {
                    if (crmData.selectedRecords.has(data[i][idField])) {
                        data.splice(i, 1);
                    }
                }
                
                crmData.selectedRecords.clear();
                crmData.saveData();
                renderGrid(entityName);
                
                addChatMessage(`Deleted ${crmData.selectedRecords.size} record(s) successfully.`, 'ai');
            }
        }

        function refreshData() {
            renderGrid(crmData.currentEntity);
            addChatMessage('Data refreshed successfully.', 'ai');
        }

        function exportToExcel() {
            // Simplified export - in real app would create actual Excel file
            const data = crmData.getEntityData(crmData.currentEntity);
            const csv = convertToCSV(data);
            downloadCSV(csv, `${crmData.currentEntity}_export.csv`);
            
            addChatMessage(`Exported ${data.length} records to CSV.`, 'ai');
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header] || '';
                    return typeof value === 'string' && value.includes(',') 
                        ? `"${value}"` 
                        : value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showChart() {
            alert('Chart view would be displayed here. This would show analytics for the current entity.');
        }

        function changeView() {
            const viewValue = document.getElementById('viewSelector').value;
            // Apply view filter logic here
            renderGrid(crmData.currentEntity);
        }

        function qualifyLead(leadId) {
            const lead = crmData.leads.find(l => l.leadid === leadId);
            if (lead) {
                // Create account, contact, and opportunity from lead
                const newAccount = {
                    accountid: crmData.generateGuid(),
                    name: lead.companyname,
                    telephone1: lead.telephone1,
                    ownerid: lead.ownerid,
                    createdon: new Date().toISOString(),
                    modifiedon: new Date().toISOString(),
                    statecode: 0,
                    statuscode: 1
                };
                
                const newContact = {
                    contactid: crmData.generateGuid(),
                    fullname: lead.fullname,
                    firstname: lead.firstname,
                    lastname: lead.lastname,
                    emailaddress1: lead.emailaddress1,
                    telephone1: lead.telephone1,
                    jobtitle: lead.jobtitle,
                    parentcustomerid: newAccount.accountid,
                    parentcustomername: newAccount.name,
                    ownerid: lead.ownerid,
                    createdon: new Date().toISOString(),
                    modifiedon: new Date().toISOString(),
                    statecode: 0,
                    statuscode: 1
                };
                
                const newOpportunity = {
                    opportunityid: crmData.generateGuid(),
                    name: lead.subject,
                    parentaccountid: newAccount.accountid,
                    parentaccountname: newAccount.name,
                    parentcontactid: newContact.contactid,
                    parentcontactname: newContact.fullname,
                    estimatedvalue: lead.estimatedvalue,
                    estimatedclosedate: lead.estimatedclosedate,
                    closeprobability: 50,
                    currentphase: 'Qualify',
                    ownerid: lead.ownerid,
                    createdon: new Date().toISOString(),
                    modifiedon: new Date().toISOString(),
                    statecode: 0,
                    statuscode: 1,
                    salesstage: 1
                };
                
                crmData.accounts.push(newAccount);
                crmData.contacts.push(newContact);
                crmData.opportunities.push(newOpportunity);
                
                // Mark lead as qualified
                lead.statecode = 1;
                lead.statuscode = 3;
                
                crmData.saveData();
                
                addChatMessage(`Lead qualified successfully. Created new account, contact, and opportunity.`, 'ai');
                
                // Switch to opportunities and show the new one
                switchToEntity('opportunities');
                renderGrid('opportunities');
            }
        }

        function closeAsWon(opportunityId) {
            const opportunity = crmData.opportunities.find(o => o.opportunityid === opportunityId);
            if (opportunity) {
                opportunity.statecode = 1;
                opportunity.statuscode = 3;
                opportunity.actualclosedate = new Date().toISOString();
                opportunity.actualvalue = opportunity.estimatedvalue;
                
                crmData.saveData();
                
                addChatMessage(`Opportunity closed as Won with revenue of $${opportunity.actualvalue.toLocaleString()}.`, 'ai');
                closeForm();
                renderGrid('opportunities');
            }
        }

        // Data Import/Export
        function exportData() {
            const dataToExport = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                accounts: crmData.accounts,
                contacts: crmData.contacts,
                leads: crmData.leads,
                opportunities: crmData.opportunities,
                activities: crmData.activities,
                quotes: crmData.quotes,
                orders: crmData.orders,
                invoices: crmData.invoices,
                products: crmData.products,
                pricelists: crmData.pricelists
            };
            
            const json = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dynamics365_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            addChatMessage(`Data exported successfully. File saved as dynamics365_backup.json`, 'ai');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.version) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Import data
                    if (importedData.accounts) crmData.accounts = importedData.accounts;
                    if (importedData.contacts) crmData.contacts = importedData.contacts;
                    if (importedData.leads) crmData.leads = importedData.leads;
                    if (importedData.opportunities) crmData.opportunities = importedData.opportunities;
                    if (importedData.activities) crmData.activities = importedData.activities;
                    if (importedData.quotes) crmData.quotes = importedData.quotes;
                    if (importedData.orders) crmData.orders = importedData.orders;
                    if (importedData.invoices) crmData.invoices = importedData.invoices;
                    if (importedData.products) crmData.products = importedData.products;
                    if (importedData.pricelists) crmData.pricelists = importedData.pricelists;
                    
                    crmData.saveData();
                    renderGrid(crmData.currentEntity);
                    
                    addChatMessage(`Data imported successfully from ${file.name}`, 'ai');
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                    addChatMessage(`Failed to import data: ${error.message}`, 'ai');
                }
            };
            
            reader.readAsText(file);
            
            // Clear the input
            event.target.value = '';
        }

        // Sitemap navigation
        document.querySelectorAll('.sitemap-item').forEach(item => {
            item.addEventListener('click', function() {
                const entityName = this.dataset.entity;
                if (entityName) {
                    switchToEntity(entityName);
                }
            });
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial view
            switchToEntity('contacts');
            
            // Add welcome message
            setTimeout(() => {
                addChatMessage('Welcome to Dynamics 365! The system has loaded with sample data. You can interact with me using natural language or use the interface directly.', 'ai');
            }, 1000);
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save in form view
            if (e.ctrlKey && e.key === 's' && document.getElementById('recordForm').style.display === 'block') {
                e.preventDefault();
                const saveBtn = document.querySelector('#recordForm .command-btn');
                if (saveBtn) saveBtn.click();
            }
            
            // Escape to close form
            if (e.key === 'Escape' && document.getElementById('recordForm').style.display === 'block') {
                closeForm();
            }
        });
    </script>
</body>
</html>