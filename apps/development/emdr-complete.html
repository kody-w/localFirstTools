<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>EMDR Therapy Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
        overscroll-behavior: none;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      .ball {
        height: 48px;
        width: 48px;
        background: #3b82f6;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px 4px rgba(59, 130, 246, 0.5),
          0 0 30px 8px rgba(59, 130, 246, 0.3);
        transition: box-shadow 0.3s ease;
        will-change: transform;
        z-index: 20;
      }

      .ball.active {
        box-shadow: 0 0 25px 10px rgba(59, 130, 246, 0.6),
          0 0 50px 15px rgba(59, 130, 246, 0.4);
      }

      /* Full-screen modal for ball tracking */
      #ballFocusModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(15, 23, 42, 0.95); /* Dark background */
        z-index: 1000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      /* Immersive track for the modal */
      .immersive-track {
        position: relative;
        width: 90%;
        max-width: 1200px;
        height: 120px;
        background: linear-gradient(
          to right,
          rgba(29, 78, 216, 0.2),
          rgba(29, 78, 216, 0.05)
        );
        border-radius: 20px;
        overflow: visible;
        margin-bottom: 50px;
      }

      /* Larger, more prominent ball for the modal */
      #modalBall {
        height: 60px;
        width: 60px;
        background: #60a5fa;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 20px 8px rgba(96, 165, 250, 0.7),
          0 0 40px 16px rgba(96, 165, 250, 0.4),
          0 0 80px 20px rgba(96, 165, 250, 0.2);
        will-change: transform;
        z-index: 1010;
      }

      /* Controls area in the modal */
      .modal-controls {
        position: absolute;
        bottom: 30px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 20px;
      }

      .modal-timer {
        position: absolute;
        top: 30px;
        right: 50%;
        transform: translateX(50%);
        font-size: 36px;
        font-weight: 200;
        color: white;
        font-family: monospace;
      }

      .memory-reminder {
        position: absolute;
        top: 100px;
        left: 0;
        right: 0;
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
        padding: 10px;
        max-width: 600px;
        margin: 0 auto;
        font-style: italic;
        line-height: 1.5;
      }

      /* Focus helper dots */
      .focus-dots {
        position: absolute;
        width: 100%;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        pointer-events: none;
      }

      .focus-dot {
        width: 8px;
        height: 8px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
      }

      /* Mobile optimizations */
      @media (max-width: 768px) {
        .ball {
          height: 24px;
          width: 24px;
        }

        .left-panel {
          display: none;
        }

        .right-panel {
          width: 100%;
        }

        .mobile-stack {
          flex-direction: column;
        }

        #modalBall {
          height: 40px;
          width: 40px;
        }

        .immersive-track {
          height: 80px;
        }

        .modal-timer {
          font-size: 24px;
        }
      }

      /* Desktop-specific styles */
      @media (min-width: 769px) {
        .mobile-only {
          display: none;
        }
      }

      /* UI Elements */
      .info-tooltip {
        visibility: hidden;
        position: absolute;
        background-color: #1f2937;
        color: white;
        padding: 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        max-width: 300px;
        z-index: 50;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
      }

      .info-icon:hover + .info-tooltip {
        visibility: visible;
        opacity: 1;
      }

      /* Custom scrollbar */
      #historyContent::-webkit-scrollbar,
      #chatHistory::-webkit-scrollbar {
        width: 6px;
      }

      #historyContent::-webkit-scrollbar-track,
      #chatHistory::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      #historyContent::-webkit-scrollbar-thumb,
      #chatHistory::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      #historyContent::-webkit-scrollbar-thumb:hover,
      #chatHistory::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Range input styling */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 4px;
        border-radius: 2px;
        background: #e2e8f0;
        outline: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        transition: background 0.15s ease-in-out;
      }

      input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border: 0;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        transition: background 0.15s ease-in-out;
      }

      /* Animations */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Focus styles for accessibility */
      :focus-visible {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
      }

      /* Prevent text selection during ball tracking */
      .no-select {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      /* Chat styling */
      .message {
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 12px;
        margin-bottom: 10px;
        word-wrap: break-word;
      }

      .user-message {
        background-color: #e9ecef;
        color: #212529;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .assistant-message {
        background-color: #deedff;
        color: #0a397d;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .system-message {
        background-color: #f9fafc;
        color: #64748b;
        border: 1px dashed #ced4da;
        font-style: italic;
        align-self: center;
        max-width: 95%;
        font-size: 0.9em;
      }

      #chatHistory {
        height: calc(100vh - 280px);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .message-container {
        margin: 5px 0;
        display: flex;
        flex-direction: column;
      }

      .timestamp {
        font-size: 0.7em;
        margin-top: 4px;
        opacity: 0.7;
      }

      /* Improved chart container */
      #chartContainer {
        height: 180px;
        margin-top: 10px;
        transition: height 0.3s ease;
      }

      .session-button {
        transition: transform 0.1s ease;
      }
      
      .session-button:active {
        transform: scale(0.98);
      }
      
      /* Pulse animation for start button */
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
      }
      
      .pulse-button {
        animation: pulse 2s infinite;
      }
      
      /* Progress bar styling */
      .progress-container {
        width: 100%;
        height: 8px;
        background-color: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0;
      }
      
      .progress-bar {
        height: 100%;
        background-color: #3b82f6;
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      /* NEW STYLES FOR IMPROVED CHECK-IN EXPERIENCE */
      
      /* Breathing animation */
      @keyframes breathe {
        0%, 100% { 
          transform: scale(0.75);
          opacity: 0.4;
        }
        50% { 
          transform: scale(1);
          opacity: 0.8;
        }
      }

      .breathing-animation {
        animation: breathe 4s infinite ease-in-out;
      }

      /* Scale in animation for modal content */
      @keyframes scaleIn {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .scale-in {
        animation: scaleIn 0.4s forwards ease-out;
      }

      /* Fade transition */
      .fade-transition {
        transition: opacity 0.4s ease;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Main Container -->
    <div class="h-screen flex flex-col">
      <!-- Top Bar -->
      <div
        class="bg-white border-b px-4 py-2 flex justify-between items-center flex-shrink-0"
      >
        <div class="text-sm text-gray-600" id="sessionInfo"></div>
        <div class="flex gap-2">
          <input type="file" id="sessionUpload" accept=".json" class="hidden" />
          <label
            for="sessionUpload"
            class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm hover:bg-blue-100 cursor-pointer session-button"
          >
            Import Session
          </label>
          <button
            onclick="exportSession()"
            class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 session-button"
          >
            Save Session
          </button>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="flex-1 flex min-h-0">
        <!-- Left Panel - EMDR Session -->
        <div
          class="w-1/2 border-r bg-gray-50 flex flex-col overflow-hidden left-panel"
        >
          <!-- Progress Steps -->
          <div class="p-3 border-b bg-white flex-shrink-0">
            <div class="flex justify-between">
              <div id="step1" class="text-center flex-1">
                <div
                  class="w-6 h-6 rounded-full bg-blue-500 text-white text-sm flex items-center justify-center mx-auto mb-1"
                >
                  1
                </div>
                <div class="text-xs">Memory</div>
              </div>
              <div
                class="flex-1 border-t-2 border-gray-200 relative top-3"
              ></div>
              <div id="step2" class="text-center flex-1">
                <div
                  class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-sm flex items-center justify-center mx-auto mb-1"
                >
                  2
                </div>
                <div class="text-xs">Rating</div>
              </div>
              <div
                class="flex-1 border-t-2 border-gray-200 relative top-3"
              ></div>
              <div id="step3" class="text-center flex-1">
                <div
                  class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-sm flex items-center justify-center mx-auto mb-1"
                >
                  3
                </div>
                <div class="text-xs">Process</div>
              </div>
              <div
                class="flex-1 border-t-2 border-gray-200 relative top-3"
              ></div>
              <div id="step4" class="text-center flex-1">
                <div
                  class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-sm flex items-center justify-center mx-auto mb-1"
                >
                  4
                </div>
                <div class="text-xs">Complete</div>
              </div>
            </div>
          </div>

          <!-- Current Focus -->
          <div class="p-3 border-b flex-shrink-0">
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-sm font-medium">Current Focus</h3>
              <span
                id="currentPhase"
                class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded"
                >Memory Selection</span
              >
            </div>
            <div id="focusContent" class="text-sm text-gray-600"></div>
          </div>

          <!-- SUDS Progress -->
          <div class="p-3 border-b flex-shrink-0">
            <div class="flex justify-between text-sm mb-2">
              <span class="font-medium">SUDS Ratings</span>
              <div class="flex gap-2">
                <span
                  >Initial:
                  <span id="initialSudsDisplay" class="font-mono">-</span></span
                >
                <span
                  >Current:
                  <span id="currentSudsDisplay" class="font-mono text-blue-600 font-semibold">-</span></span
                >
              </div>
            </div>
            <div id="chartContainer" class="hidden">
              <canvas id="sudsChart"></canvas>
            </div>
          </div>

          <!-- Therapist Insights Panel -->
          <div
            class="p-3 border-b flex-shrink-0 bg-blue-50"
            id="therapistInsightsPanel"
          >
            <h3 class="text-sm font-medium mb-2">Therapist Insights</h3>
            <div id="therapistInsights" class="text-sm text-gray-700">
              No insights available yet. The therapist will provide guidance
              when you save and re-import the session.
            </div>
          </div>

          <!-- History -->
          <div class="flex-1 overflow-y-auto">
            <div id="processHistory" class="hidden p-3">
              <h3 class="text-sm font-medium mb-2">Process History</h3>
              <div class="space-y-3" id="historyContent"></div>
            </div>
          </div>
        </div>

        <!-- Right Panel - Chat & Processing -->
        <div class="w-1/2 flex flex-col p-4 right-panel">
          <!-- Memory Input -->
          <div id="memoryInput" class="space-y-3 mb-4">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-lg font-semibold">Target Memory</h2>
                <p class="text-sm text-gray-600">
                  Choose a specific memory to process
                </p>
              </div>
              <button
                class="text-blue-600 hover:text-blue-700 text-sm session-button"
                onclick="showHelp('memory')"
              >
                Need help?
              </button>
            </div>

            <textarea
              id="memoryText"
              placeholder="Describe a specific memory that still bothers you..."
              class="w-full p-2 border rounded-lg h-24 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            ></textarea>

            <button
              onclick="submitMemory()"
              class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 session-button"
            >
              Continue
            </button>
          </div>

          <!-- Rating Input -->
          <div id="ratingInput" class="hidden space-y-3 mb-4">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-lg font-semibold">Rate Your Discomfort</h2>
                <p class="text-sm text-gray-600">
                  How disturbing does this memory feel right now?
                </p>
              </div>
              <div class="relative">
                <span class="info-icon cursor-help text-sm">❔</span>
                <div class="info-tooltip -right-2">
                  0 = No disturbance<br />
                  5 = Moderate disturbance<br />
                  10 = Highest disturbance
                </div>
              </div>
            </div>

            <div class="flex gap-4 items-center">
              <input
                type="range"
                id="sudsSlider"
                min="0"
                max="10"
                step="1"
                class="w-full"
                oninput="updateSudsValue(this.value)"
              />
              <input
                type="number"
                id="sudsRating"
                min="0"
                max="10"
                class="w-16 p-1 border rounded text-sm"
                oninput="updateSudsSlider(this.value)"
              />
            </div>
            
            <div class="flex mt-4 pt-3 border-t border-gray-200">
              <div class="w-full flex justify-center">
                <button
                  onclick="submitRating()"
                  class="bg-blue-500 text-white px-5 py-2 rounded text-sm hover:bg-blue-600 session-button w-1/2"
                >
                  Start Processing
                </button>
              </div>
            </div>
          </div>

          <!-- Processing Area -->
          <div id="processing" class="hidden space-y-4 mb-4">
            <div class="flex justify-between items-center">
              <div>
                <h2 class="text-lg font-semibold">
                  Eye Movement Processing
                </h2>
                <p class="text-sm text-gray-600">
                  Click below to start your immersive session
                </p>
              </div>
              <div class="flex items-center">
                <span class="text-sm font-semibold mr-2">Set:</span>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
                  <span id="currentSet">1</span>/<span id="totalSets">10</span>
                </span>
              </div>
            </div>
            
            <!-- Progress visualization -->
            <div>
              <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span>Start</span>
                <span>Progress</span>
                <span>Complete</span>
              </div>
              <div class="progress-container">
                <div class="progress-bar" id="setProgressBar" style="width: 0%"></div>
              </div>
            </div>

            <div class="flex justify-between items-center">
              <button
                id="toggleButton"
                class="bg-blue-500 text-white px-5 py-3 rounded font-medium hover:bg-blue-600 pulse-button session-button w-3/4 mx-auto mt-4 flex items-center justify-center"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                Start Immersive EMDR Session
              </button>
            </div>
            
            <div class="mt-2 flex items-center justify-center gap-6 bg-gray-50 p-3 rounded-lg">
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-600">Slower</span>
                <input
                  type="range"
                  id="speedControl"
                  min="1"
                  max="4"
                  step="0.5"
                  value="2"
                  class="w-32"
                />
                <span class="text-xs text-gray-600">Faster</span>
              </div>
              <div class="text-sm text-gray-600">
                <span id="speedLabel">Normal Speed</span>
              </div>
            </div>

            <!-- Set Completion Form (will be hidden by the new modal approach) -->
            <div
              id="setComplete"
              class="hidden space-y-4 p-5 bg-blue-50 rounded-lg border border-blue-200 mt-4 shadow-sm"
            >
              <div class="flex items-center">
                <div class="bg-blue-100 p-2 rounded-full mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div>
                  <h3 class="font-medium text-blue-800">Set Complete - Check In</h3>
                  <p class="text-xs text-blue-700">Take a moment to notice what you're experiencing</p>
                </div>
              </div>

              <div class="space-y-4 pt-2">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Current disturbance level (0-10):</label
                  >
                  <div class="flex gap-4 items-center">
                    <input
                      type="range"
                      id="currentSudsSlider"
                      min="0"
                      max="10"
                      class="w-full"
                      oninput="updateCurrentSudsValue(this.value)"
                    />
                    <input
                      type="number"
                      id="currentSuds"
                      min="0"
                      max="10"
                      class="w-16 p-1 border rounded text-sm"
                      oninput="updateCurrentSudsSlider(this.value)"
                    />
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >What are you noticing? (Optional)</label
                  >
                  <textarea
                    id="observations"
                    placeholder="Any changes in thoughts, feelings, sensations..."
                    class="w-full p-2 border rounded-lg h-24 text-sm focus:ring-2 focus:ring-blue-500"
                  ></textarea>
                </div>

                <button
                  onclick="completeSet()"
                  class="w-full bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 session-button"
                >
                  Continue to Next Set
                </button>
              </div>
            </div>
          </div>

          <!-- Chat Interface -->
          <div id="chatInterface" class="flex flex-col h-full">
            <div
              id="chatHistory"
              class="flex-1 bg-white rounded-lg border p-3 shadow-sm overflow-y-auto"
            >
              <!-- Messages will be inserted here -->
              <div class="message-container">
                <div class="message system-message">
                  Session started. Save your session and submit it to the AI
                  assistant for guidance. When you import the response back,
                  you'll see the insights.
                </div>
              </div>
            </div>
            <div class="mt-3 flex gap-2">
              <textarea
                id="userMessage"
                placeholder="Type your observations here for the export..."
                class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                rows="2"
              ></textarea>
              <button
                onclick="addUserNote()"
                class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 flex-shrink-0 session-button"
                title="Add note"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Immersive Full-Screen Ball Modal -->
    <div id="ballFocusModal" class="no-select">
      <div class="modal-timer" id="modalTimer">30</div>
      <div class="memory-reminder" id="memoryReminder"></div>

      <div class="immersive-track">
        <div class="focus-dots">
          <div class="focus-dot"></div>
          <div class="focus-dot"></div>
          <div class="focus-dot"></div>
          <div class="focus-dot"></div>
          <div class="focus-dot"></div>
          <div class="focus-dot"></div>
          <div class="focus-dot"></div>
        </div>
        <div id="modalBall"></div>
      </div>

      <div class="modal-controls">
        <button
          id="modalPauseButton"
          class="bg-white text-blue-800 px-6 py-3 rounded-lg text-sm font-medium hover:bg-gray-100 session-button"
        >
          Pause
        </button>
        <button
          id="modalExitButton"
          class="bg-red-500 text-white px-6 py-3 rounded-lg text-sm font-medium hover:bg-red-600 session-button"
        >
          Stop Session
        </button>
      </div>
    </div>

    <!-- Help Modal -->
    <div
      id="helpModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg w-[32rem] mx-4 p-<div class="bg-white rounded-lg w-[32rem] mx-4 p-4 space-y-3 shadow-xl">
        <h3 class="text-lg font-bold text-gray-800" id="helpTitle"></h3>
        <div
          id="helpContent"
          class="text-gray-600 max-h-[60vh] overflow-y-auto"
        ></div>
        <button
          onclick="closeHelp()"
          class="w-full bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 session-button"
        >
          Got it
        </button>
      </div>
    </div>

    <!-- Welcome Modal -->
    <div
      id="welcomeModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-lg w-[40rem] mx-4 p-5 space-y-4 max-h-[90vh] overflow-y-auto shadow-xl"
        >
          <h2 class="text-xl font-bold text-gray-800">
            Welcome to AI-Assisted EMDR Therapy
          </h2>
  
          <div class="space-y-4 text-gray-600">
            <div>
              <p class="font-medium text-gray-700">What is EMDR?</p>
              <p class="text-sm">
                EMDR (Eye Movement Desensitization and Reprocessing) is a proven
                therapy technique that helps process difficult memories and reduce
                their emotional impact. It works by combining memory recall with
                bilateral stimulation (in this case, following a moving ball with
                your eyes).
              </p>
            </div>
  
            <div>
              <p class="font-medium text-gray-700">How does this tool work?</p>
              <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>You'll identify a specific memory you want to work on</li>
                <li>Rate how disturbing it feels (0-10)</li>
                <li>
                  Follow the ball with your eyes while holding the memory in mind
                </li>
                <li>After each set, you'll note any changes in how you feel</li>
                <li>
                  To get AI guidance:
                  <ul class="list-disc list-inside ml-6 mt-1">
                    <li>Save your session (exports a JSON file)</li>
                    <li>Submit this file to the AI assistant</li>
                    <li>
                      Import the response JSON back for therapeutic insights
                    </li>
                  </ul>
                </li>
              </ol>
            </div>
  
            <div class="bg-blue-50 p-3 rounded-lg">
              <label class="block font-medium text-gray-700 mb-1 text-sm"
                >How much time do you have for this session?</label
              >
              <select
                id="sessionDuration"
                class="w-full p-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="15">15 minutes (5 sets)</option>
                <option value="30" selected>30 minutes (10 sets)</option>
                <option value="45">45 minutes (15 sets)</option>
                <option value="60">60 minutes (20 sets)</option>
              </select>
              <p class="text-xs text-gray-600 mt-1">
                Each set takes about 2-3 minutes including check-ins
              </p>
            </div>
  
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
              <p class="font-medium text-sm">Important Note:</p>
              <p class="text-sm">
                While this tool can be helpful, it's recommended to use it
                alongside professional therapy. If you're dealing with severe
                trauma, please consult a mental health professional.
              </p>
            </div>
          </div>
  
          <button
            onclick="startSession()"
            class="w-full bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600 session-button"
          >
            Begin Session
          </button>
        </div>
      </div>

    <!-- NEW: Improved Set Completion Modal -->
    <div id="setCompletionModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 transition-opacity duration-300 ease-in-out">
      <div class="bg-white rounded-xl w-full max-w-xl mx-4 shadow-2xl overflow-hidden transition-transform duration-500 ease-out transform scale-95 opacity-0" id="setCompletionContent">
        <!-- Header with calming visual element -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 border-b border-blue-100 relative">
          <div class="absolute top-3 right-3 flex items-center space-x-1 bg-blue-100 px-2 py-1 rounded-lg text-blue-800 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
            </svg>
            <span>Set <span id="completedSetNumber">0</span> Complete</span>
          </div>
          
          <div class="flex items-center mt-4">
            <div class="bg-white p-3 rounded-full shadow-md mr-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <h2 class="text-xl font-semibold text-gray-800">Check-In Moment</h2>
              <p class="text-gray-600">Take a breath and notice what you're experiencing now</p>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <div class="p-6 space-y-6">
          <!-- Breathing guidance -->
          <div class="text-center py-3 bg-blue-50 rounded-lg">
            <p class="text-blue-800 font-medium mb-2">First, take three deep breaths</p>
            <div class="inline-block p-4 rounded-full bg-white shadow-inner relative mb-1">
              <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center">
                <div id="breathingCircle" class="w-12 h-12 bg-blue-400 rounded-full transition-all duration-4000 ease-in-out opacity-40 transform scale-75"></div>
              </div>
            </div>
            <p id="breathingGuidance" class="text-sm text-blue-700">Breathe in...</p>
          </div>

          <!-- Current disturbance level -->
          <div class="transition-opacity duration-300" id="sudsSection">
            <label class="block text-gray-700 font-medium mb-3">
              How disturbing does the memory feel right now? (0-10)
            </label>
            <div class="flex items-center mb-2">
              <span class="text-gray-500 text-sm mr-3 w-8 text-right">0</span>
              <div class="flex-1 bg-gray-100 h-2 rounded-full relative">
                <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-green-400 to-red-500 rounded-full" style="width: 50%" id="sudsFill"></div>
                <div class="absolute -top-1 bg-white border-2 border-blue-600 w-4 h-4 rounded-full shadow-md" style="left: 50%; transform: translateX(-50%)" id="sudsHandle"></div>
              </div>
              <span class="text-gray-500 text-sm ml-3 w-8">10</span>
              <input type="number" id="modalCurrentSuds" min="0" max="10" step="1" value="5"
                  class="w-12 ml-3 p-1 border border-gray-300 rounded text-sm text-center"/>
            </div>
            <div class="flex justify-between text-xs text-gray-500 px-8">
              <span>No disturbance</span>
              <span>Highest disturbance</span>
            </div>
          </div>

          <!-- Observations input -->
          <div class="transition-opacity duration-300" id="observationsSection">
            <label class="block text-gray-700 font-medium mb-2">
              What are you noticing right now?
            </label>
            <textarea id="modalObservations" placeholder="Any changes in thoughts, feelings, body sensations..."
                class="w-full p-3 border border-gray-300 rounded-lg h-28 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50"></textarea>
            <p class="text-xs text-gray-500 mt-1">It's okay to leave this blank if you're not sure what to write</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 p-5 border-t border-gray-200">
          <div class="flex justify-between items-center mb-3">
            <div class="text-sm text-gray-600">
              <span>Initial SUDS: <span id="initialSudsValue" class="font-mono">0</span></span>
              &nbsp;→&nbsp;
              <span>Current: <span id="liveSudsValue" class="font-mono font-semibold text-blue-700">5</span></span>
            </div>
            <div id="progressIndicator" class="text-sm text-gray-600">
              Set <span id="currentSetNumber">1</span>/<span id="totalSetsNumber">10</span>
            </div>
          </div>
          
          <button id="continueToNextSet" class="w-full bg-blue-600 text-white py-3 rounded-lg text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200 flex items-center justify-center">
            <span>Continue to Next Set</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  
    <script>
      // Session state management
      let sessionState = {
        id: "session_" + Date.now(),
        startTime: new Date().toISOString(),
        memory: "",
        initialSuds: null,
        currentSet: 0,
        sets: [],
        status: "active",
        totalSets: 10,
        duration: 30,
        therapist_data: {},
        client_notes: [],
      };

      // Chat history management
      let chatHistory = [];

      // UI state
      let isRunning = false;
      let position = 0;
      let direction = 1;
      let speed = 2;
      let animationFrame;
      let lastTime = 0;
      let setTimer;
      let remainingTime = 30;
      let sudsChart = null;
      let immersiveMode = false;

      // Initialize
      updateSessionInfo();

      // Update speed label when slider changes
      document.getElementById('speedControl').addEventListener('input', function(e) {
        const speedValue = parseFloat(e.target.value);
        let speedText = '';
        
        if (speedValue < 1.5) speedText = 'Very Slow';
        else if (speedValue < 2) speedText = 'Slow';
        else if (speedValue < 3) speedText = 'Normal Speed';
        else if (speedValue < 3.5) speedText = 'Fast';
        else speedText = 'Very Fast';
        
        document.getElementById('speedLabel').textContent = speedText;
      });

      document
        .getElementById("userMessage")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            addUserNote();
          }
        });

      // Set up modal controls
      document
        .getElementById("modalPauseButton")
        .addEventListener("click", function () {
          if (isRunning) {
            pauseImmersiveSession();
          } else {
            resumeImmersiveSession();
          }
        });

      document
        .getElementById("modalExitButton")
        .addEventListener("click", function () {
          if (document.fullscreenElement) {
            exitFullscreen().then(() => {
              exitImmersiveMode();
            }).catch(err => {
              console.error("Error exiting fullscreen:", err);
              exitImmersiveMode();
            });
          } else {
            exitImmersiveMode();
          }
        });

      function startSession() {
        const durationSelect = document.getElementById("sessionDuration");
        const duration = parseInt(durationSelect.value);
        sessionState.duration = duration;
        sessionState.totalSets = Math.floor(duration / 3); // Approximately 3 minutes per set
        document.getElementById("welcomeModal").style.display = "none";
        document.getElementById("totalSets").textContent =
          sessionState.totalSets;
        updateSessionInfo();

        // Initialize focus content
        updateFocusPanel(
          "Memory Selection",
          `
                <p>Please describe a specific memory you'd like to work on.</p>
                <p class="text-sm text-gray-500 mt-2">Choose something that:</p>
                <ul class="list-disc list-inside text-sm text-gray-500 mt-1">
                    <li>Is a single, specific event</li>
                    <li>Still causes some emotional discomfort</li>
                    <li>You feel ready to work with</li>
                </ul>
            `
        );

        // Add initial system message
        addMessage({
          role: "system",
          content:
            "Session started. Add your memory and follow the EMDR protocol. When you need guidance, save your session file and submit it to an AI assistant. Then import the response file to see therapeutic insights.",
        });
      }

      function updateProgress(step) {
        // Reset all steps
        for (let i = 1; i <= 4; i++) {
          const stepEl = document.getElementById(`step${i}`);
          stepEl
            .querySelector("div")
            .classList.remove("bg-blue-500", "bg-green-500");
          stepEl.querySelector("div").classList.add("bg-gray-200");
          stepEl.querySelector("div").classList.remove("text-white");
          stepEl.querySelector("div").classList.add("text-gray-600");
        }

        // Update completed steps
        for (let i = 1; i <= step; i++) {
          const stepEl = document.getElementById(`step${i}`);
          stepEl.querySelector("div").classList.remove("bg-gray-200");
          stepEl
            .querySelector("div")
            .classList.add(i === step ? "bg-blue-500" : "bg-green-500");
          stepEl.querySelector("div").classList.remove("text-gray-600");
          stepEl.querySelector("div").classList.add("text-white");
        }
      }

      function updateFocusPanel(phase, content) {
        document.getElementById("currentPhase").textContent = phase;
        document.getElementById("focusContent").innerHTML = content;
      }

      function updateTherapistInsights(insights) {
        const insightsDiv = document.getElementById("therapistInsights");
        if (insights) {
          insightsDiv.innerHTML = insights;
        }
      }

      function addToHistory(type, content) {
        const historyDiv = document.getElementById("processHistory");
        const historyContent = document.getElementById("historyContent");

        historyDiv.classList.remove("hidden");

        const timestamp = new Date().toLocaleTimeString();
        const entryDiv = document.createElement("div");
        entryDiv.className = "border-l-2 border-blue-200 pl-4 fade-in";
        entryDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="text-sm font-medium">${type}</span>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <div class="text-gray-600 mt-1">${content}</div>
            `;

        historyContent.insertBefore(entryDiv, historyContent.firstChild);
      }

      function initSudsChart() {
        const ctx = document.getElementById("sudsChart").getContext("2d");
        document.getElementById("chartContainer").classList.remove("hidden");

        sudsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Initial"],
            datasets: [
              {
                label: "Distress Level (SUDS)",
                data: [sessionState.initialSuds],
                borderColor: "rgb(59, 130, 246)",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: "#ffffff",
                pointBorderColor: "rgb(59, 130, 246)",
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 10,
                title: {
                  display: true,
                  text: "Distress Level (0-10)",
                  font: {
                    weight: 'bold'
                  }
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.05)"
                },
                ticks: {
                  stepSize: 1
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.7)",
                padding: 10,
                titleFont: {
                  size: 14
                },
                bodyFont: {
                  size: 13
                },
                displayColors: false,
                callbacks: {
                  title: function(tooltipItems) {
                    const idx = tooltipItems[0].dataIndex;
                    return idx === 0 ? 'Initial Rating' : `Set ${idx}`;
                  }
                }
              },
            },
            animation: {
              duration: 1000,
              easing: 'easeOutQuart'
            }
          },
        });
      }

      function updateSudsChart(suds) {
        if (sudsChart) {
          sudsChart.data.labels.push(`Set ${sessionState.sets.length}`);
          sudsChart.data.datasets[0].data.push(suds);
          sudsChart.update();
          
          // Update progress bar
          updateSetProgressBar();
        }
      }
      
      function updateSetProgressBar() {
        const progressBar = document.getElementById('setProgressBar');
        const progressPercentage = (sessionState.currentSet / sessionState.totalSets) * 100;
        progressBar.style.width = `${progressPercentage}%`;
      }

      function updateSudsValue(value) {
        document.getElementById("sudsRating").value = value;
      }

      function updateSudsSlider(value) {
        document.getElementById("sudsSlider").value = value;
      }

      function updateCurrentSudsValue(value) {
        document.getElementById("currentSuds").value = value;
      }

      function updateCurrentSudsSlider(value) {
        document.getElementById("currentSudsSlider").value = value;
      }

      // File handling
      document
        .getElementById("sessionUpload")
        .addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const importedState = JSON.parse(e.target.result);
                sessionState = importedState;
                restoreSession();
                updateSessionInfo();

                // Check if there are therapist insights in the imported session
                if (
                  sessionState.therapist_data &&
                  Object.keys(sessionState.therapist_data).length > 0
                ) {
                  addMessage({
                    role: "system",
                    content:
                      "Session imported with therapist insights. Review the Therapist Insights panel for guidance.",
                  });

                  // Display the latest assistant response if it exists
                  if (sessionState.therapist_data.latest_response) {
                    addMessage({
                      role: "assistant",
                      content: sessionState.therapist_data.latest_response,
                    });
                  }
                } else {
                  addMessage({
                    role: "system",
                    content:
                      "Session imported. No therapist insights found. Continue your process and save the session when you want AI guidance.",
                  });
                }
              } catch (error) {
                alert("Error importing session: " + error.message);
              }
            };
            reader.readAsText(file);
          }
        });

      function exportSession() {
        // Add latest user message if entered but not submitted
        const pendingMessage = document
          .getElementById("userMessage")
          .value.trim();
        if (pendingMessage) {
          addUserNote();
        }

        // Create a copy of the session state for export
        const exportState = JSON.parse(JSON.stringify(sessionState));

        // Add additional export metadata
        exportState.needs_review = true;
        exportState.export_time = new Date().toISOString();

        // If there are unprocessed client notes, mark them for review
        if (exportState.client_notes && exportState.client_notes.length > 0) {
          const unprocessedNotes = exportState.client_notes.filter(
            (note) => !note.processed
          );
          if (unprocessedNotes.length > 0) {
            exportState.unprocessed_notes_count = unprocessedNotes.length;
          }
        }

        const dataStr = JSON.stringify(exportState, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `emdr_session_${sessionState.id}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        addMessage({
          role: "system",
          content:
            "Session exported. Submit this file to the AI assistant for analysis, then import the response file to receive therapeutic guidance.",
        });
      }

      function addUserNote() {
        const messageInput = document.getElementById("userMessage");
        const content = messageInput.value.trim();

        if (content) {
          // Add to client notes array
          sessionState.client_notes.push({
            content: content,
            timestamp: new Date().toISOString(),
            processed: false,
          });

          // Add to chat history
          addMessage({
            role: "user",
            content: content,
          });

          messageInput.value = "";

          // Add system message suggesting export for therapist guidance
          if (sessionState.client_notes.length === 1) {
            addMessage({
              role: "system",
              content:
                "Note saved. To receive therapist insights, export your session and submit it for AI analysis.",
            });
          }
        }
      }

      function addMessage(msg) {
        chatHistory.push(msg);
        updateChatDisplay();
      }

      function updateChatDisplay() {
        const chatHistoryDiv = document.getElementById("chatHistory");
        chatHistoryDiv.innerHTML = "";

        chatHistory.forEach((msg) => {
          const messageContainer = document.createElement("div");
          messageContainer.className = "message-container";

          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${msg.role}-message`;
          messageDiv.textContent = msg.content;

          const timestamp = document.createElement("div");
          timestamp.className = "timestamp";
          timestamp.textContent = new Date().toLocaleTimeString();

          messageContainer.appendChild(messageDiv);
          messageContainer.appendChild(timestamp);
          chatHistoryDiv.appendChild(messageContainer);
        });

        // Scroll to bottom
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
      }

      function submitMemory() {
        const memoryText = document.getElementById("memoryText").value.trim();
        if (memoryText) {
          sessionState.memory = memoryText;
          document.getElementById("memoryInput").classList.add("hidden");
          document.getElementById("ratingInput").classList.remove("hidden");
          updateSessionInfo();

          // Update progress tracking
          updateProgress(2);
          updateFocusPanel(
            "Initial Rating",
            `
                    <p class="mb-2"><strong>Target Memory:</strong> "${memoryText}"</p>
                    <p>Please rate how disturbing this memory feels right now.</p>
                `
          );
          addToHistory("Memory Selected", memoryText);

          // Add to chat history
          addMessage({
            role: "user",
            content: `My target memory is: ${memoryText}`,
          });

          // Add to client notes for future AI processing
          sessionState.client_notes.push({
            content: `Selected target memory: ${memoryText}`,
            timestamp: new Date().toISOString(),
            processed: false,
            type: "memory_selection",
          });
        } else {
          alert("Please describe the memory you want to work on.");
        }
      }

      function submitRating() {
        const rating = parseInt(document.getElementById("sudsRating").value);
        if (rating >= 0 && rating <= 10) {
          sessionState.initialSuds = rating;
          document.getElementById("initialSudsDisplay").textContent = rating;
          document.getElementById("currentSudsDisplay").textContent = rating;
          document.getElementById("ratingInput").classList.add("hidden");
          document.getElementById("processing").classList.remove("hidden");
          updateSessionInfo();

          // Initialize SUDS chart
          initSudsChart();

          // Update progress tracking
          updateProgress(3);
          updateFocusPanel(
            "Processing",
            `
                    <div class="space-y-2">
                        <p><strong>Target Memory:</strong> "${sessionState.memory}"</p>
                        <p><strong>Initial Disturbance:</strong> ${rating}/10</p>
                        <p>Follow the guided process for bilateral stimulation.</p>
                    </div>
                `
          );
          addToHistory("Initial Rating", `Starting SUDS: ${rating}/10`);

          // Add to chat
          addMessage({
            role: "user",
            content: `My initial disturbance level for this memory is ${rating}/10.`,
          });

          // Add to client notes for future AI processing
          sessionState.client_notes.push({
            content: `Initial SUDS rating: ${rating}/10`,
            timestamp: new Date().toISOString(),
            processed: false,
            type: "initial_rating",
          });
          
          // Initialize progress bar
          updateSetProgressBar();

          // Show initial guidance
          showProcessingGuidance();
        } else {
          alert("Please enter a rating between 0 and 10.");
        }
      }

      function showProcessingGuidance() {
        const modal = document.getElementById("helpModal");
        const title = document.getElementById("helpTitle");
        const content = document.getElementById("helpContent");

        title.textContent = "Ready to Begin Processing";
        content.innerHTML = `
                <p class="mb-4">During each processing set:</p>
                <ul class="list-disc list-inside space-y-2 mb-4">
                    <li>Follow the blue ball with your eyes</li>
                    <li>Allow your mind to go wherever it needs to</li>
                    <li>Notice any changes in thoughts, feelings, or body sensations</li>
                    <li>There's no "right" or "wrong" way to experience this</li>
                </ul>
                <div class="bg-blue-50 p-4 rounded">
                    <p class="font-medium">Immersive Focus Mode</p>
                    <p class="mb-2">The immersive focus mode:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Fills your entire screen to eliminate distractions</li>
                        <li>Uses a larger, more visible ball</li>
                        <li>Provides focus markers to help eye tracking</li>
                        <li>Shows your memory as a gentle reminder</li>
                        <li>Can be controlled with the spacebar (pause/resume)</li>
                        <li>Can be exited with the Escape key</li>
                    </ul>
                </div>
            `;
        modal.style.display = "flex";
      }

      // Immersive Mode Functions
      function startImmersiveMode() {
        immersiveMode = true;

        // Set up memory reminder text// Set up memory reminder text
        const memoryReminderText =
          sessionState.memory.length > 100
            ? sessionState.memory.substring(0, 100) + "..."
            : sessionState.memory;
        document.getElementById(
          "memoryReminder"
        ).textContent = `Memory: "${memoryReminderText}"`;

        // Show the modal
        const modal = document.getElementById("ballFocusModal");
        modal.style.display = "flex";

        // Reset positions and parameters
        position = 0;
        lastTime = 0;
        remainingTime = 30;
        document.getElementById("modalTimer").textContent = remainingTime;
        document.getElementById("modalPauseButton").textContent = "Pause";

        // Start the animation
        isRunning = true;
        animationFrame = requestAnimationFrame(animateModal);

        // Start timer
        setTimer = setInterval(() => {
          remainingTime--;
          document.getElementById("modalTimer").textContent = remainingTime;
          if (remainingTime <= 0) {
            clearInterval(setTimer);
            if (document.fullscreenElement) {
              exitFullscreen().then(() => {
                exitImmersiveMode();
                showSetCompletion();
              }).catch(err => {
                console.error("Error exiting fullscreen:", err);
                exitImmersiveMode();
                showSetCompletion();
              });
            } else {
              exitImmersiveMode();
              showSetCompletion();
            }
          }
        }, 1000);

        // Record analytics
        addToHistory("Process Mode", "Started immersive full-screen mode");
      }

      function pauseImmersiveSession() {
        isRunning = false;
        document.getElementById("modalPauseButton").textContent = "Resume";
        clearInterval(setTimer);
        cancelAnimationFrame(animationFrame);
      }

      function resumeImmersiveSession() {
        isRunning = true;
        document.getElementById("modalPauseButton").textContent = "Pause";
        lastTime = 0;

        // Resume timer
        setTimer = setInterval(() => {
          remainingTime--;
          document.getElementById("modalTimer").textContent = remainingTime;
          if (remainingTime <= 0) {
            clearInterval(setTimer);
            if (document.fullscreenElement) {
              exitFullscreen().then(() => {
                exitImmersiveMode();
                showSetCompletion();
              }).catch(err => {
                console.error("Error exiting fullscreen:", err);
                exitImmersiveMode();
                showSetCompletion();
              });
            } else {
              exitImmersiveMode();
              showSetCompletion();
            }
          }
        }, 1000);

        // Resume animation
        animationFrame = requestAnimationFrame(animateModal);
      }

      function exitImmersiveMode() {
        immersiveMode = false;
        isRunning = false;

        // Hide modal
        const modal = document.getElementById("ballFocusModal");
        modal.style.display = "none";

        // Clean up
        clearInterval(setTimer);
        cancelAnimationFrame(animationFrame);
      }

      function animateModal(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        position += direction * speed * (deltaTime / 16);

        if (position >= 100) {
          direction = -1;
          position = 100;
        } else if (position <= 0) {
          direction = 1;
          position = 0;
        }

        document.getElementById("modalBall").style.left = `${position}%`;

        if (isRunning && immersiveMode) {
          animationFrame = requestAnimationFrame(animateModal);
        }
      }

      function startSet() {
        // Direct call to startImmersiveMode
        startImmersiveMode();
        
        // Try to enter fullscreen
        try {
          requestFullscreen();
        } catch (e) {
          console.error("Fullscreen request failed:", e);
        }
      }

      function stopSet() {
        if (document.fullscreenElement) {
          exitFullscreen().then(() => {
            exitImmersiveMode();
          }).catch(err => {
            console.error("Error exiting fullscreen:", err);
            exitImmersiveMode();
          });
        } else {
          exitImmersiveMode();
        }
      }

      // IMPROVED SET COMPLETION EXPERIENCE
      function showSetCompletion() {
        // First make sure we're out of fullscreen
        if (document.fullscreenElement) {
          exitFullscreen().then(() => {
            displayCompletionModal();
          }).catch(err => {
            console.error("Error exiting fullscreen:", err);
            displayCompletionModal();
          });
        } else {
          displayCompletionModal();
        }
      }
      
      function displayCompletionModal() {
        // Hide the existing completion form if visible
        document.getElementById("setComplete").classList.add("hidden");
        
        // Set up and show our new modal
        const modal = document.getElementById("setCompletionModal");
        const content = document.getElementById("setCompletionContent");
        modal.style.display = "flex";
        
        // Animate in
        setTimeout(() => {
          content.classList.add("scale-in");
          content.classList.remove("opacity-0", "scale-95");
        }, 50);
        
        // Update the set numbers
        document.getElementById("completedSetNumber").textContent = sessionState.currentSet + 1;
        document.getElementById("currentSetNumber").textContent = sessionState.currentSet + 1;
        document.getElementById("totalSetsNumber").textContent = sessionState.totalSets;
        
        // Initialize the SUDS value
        const lastSuds = sessionState.sets.length > 0
          ? sessionState.sets[sessionState.sets.length - 1].suds
          : sessionState.initialSuds;
          
        document.getElementById("modalCurrentSuds").value = lastSuds;
        document.getElementById("liveSudsValue").textContent = lastSuds;
        document.getElementById("initialSudsValue").textContent = sessionState.initialSuds;
        
        // Set the SUDS slider fill and handle position
        const fillPercentage = (lastSuds / 10) * 100;
        document.getElementById("sudsFill").style.width = `${fillPercentage}%`;
        document.getElementById("sudsHandle").style.left = `${fillPercentage}%`;
        
        // Initially hide the SUDS and observations sections
        const sudsSection = document.getElementById("sudsSection");
        const observationsSection = document.getElementById("observationsSection");
        sudsSection.style.opacity = "0.3";
        observationsSection.style.opacity = "0.3";
        
        // Start breathing guidance
        startBreathingGuidance();
      }

      // Breathing guidance
      function startBreathingGuidance() {
        const breathingCircle = document.getElementById("breathingCircle");
        const breathingGuidance = document.getElementById("breathingGuidance");
        const sudsSection = document.getElementById("sudsSection");
        const observationsSection = document.getElementById("observationsSection");
        
        breathingCircle.classList.add("breathing-animation");
        
        let breathCount = 0;
        let inhaling = true;
        
        const breathingInterval = setInterval(() => {
          if (inhaling) {
            breathingGuidance.textContent = "Breathe in...";
            inhaling = false;
          } else {
            breathingGuidance.textContent = "Breathe out...";
            inhaling = true;
            breathCount++;
          }
          
          if (breathCount >= 3) {
            clearInterval(breathingInterval);
            breathingGuidance.textContent = "Breathing complete";
            breathingCircle.classList.remove("breathing-animation");
            
            // Now show the SUDS rating section
            sudsSection.style.opacity = "1";
            setTimeout(() => {
              observationsSection.style.opacity = "1";
            }, 400);
          }
        }, 2000); // 2 seconds per breath phase (in/out)
      }
      
      // Complete the set using values from the modal
      function completeSet() {
        const suds = parseInt(document.getElementById("currentSuds").value);
        const observations = document.getElementById("observations").value.trim();

        processSetCompletion(suds, observations);
      }
      
      // Function to handle set completion from either interface
      function processSetCompletion(suds, observations) {
        if (suds >= 0 && suds <= 10) {
          sessionState.sets.push({
            setNumber: sessionState.currentSet + 1,
            suds: suds,
            observations: observations,
            timestamp: new Date().toISOString(),
          });

          // Update SUDS chart and progress
          updateSudsChart(suds);

          document.getElementById("currentSudsDisplay").textContent = suds;
          sessionState.currentSet++;
          document.getElementById("currentSet").textContent = 
            sessionState.currentSet + 1;
          
          // Hide modal if open
          const modal = document.getElementById("setCompletionModal");
          if (modal.style.display === "flex") {
            const content = document.getElementById("setCompletionContent");
            content.style.opacity = "0";
            content.style.transform = "scale(0.95)";
            setTimeout(() => {
              modal.style.display = "none";
              content.classList.remove("scale-in");
            }, 300);
          }
          
          // Hide old form if visible
          document.getElementById("setComplete").classList.add("hidden");
          
          // Clear inputs
          document.getElementById("currentSuds").value = "";
          document.getElementById("observations").value = "";
          document.getElementById("modalCurrentSuds").value = "";
          document.getElementById("modalObservations").value = "";

          // Add to history
          addToHistory(
            "Set Complete",
            `
                  <div class="space-y-1">
                      <div>SUDS: ${suds}/10</div>
                      ${
                        observations
                          ? `<div>Observations: ${observations}</div>`
                          : ""
                      }
                  </div>
              `
          );

          // Update focus panel
          updateFocusPanel(
            "Processing",
            `
                  <div class="space-y-2">
                      <p><strong>Target Memory:</strong> "${
                        sessionState.memory
                      }"</p>
                      <p><strong>Progress:</strong> ${
                        sessionState.currentSet
                      }/${sessionState.totalSets} sets completed</p>
                      <p><strong>Current Disturbance:</strong> ${suds}/10 (started at ${
            sessionState.initialSuds
          }/10)</p>
                      ${
                        observations
                          ? `<p><strong>Latest Observations:</strong> ${observations}</p>`
                          : ""
                      }
                  </div>
              `
          );

          updateSessionInfo();

          // Add to chat
          addMessage({
            role: "user",
            content: `After set ${
              sessionState.currentSet
            }, my disturbance level is now ${suds}/10.${
              observations ? ` I'm noticing: ${observations}` : ""
            }`,
          });

          // Add to client notes for future AI processing
          sessionState.client_notes.push({
            content: `Set ${
              sessionState.currentSet
            } completed. SUDS: ${suds}/10. Observations: ${
              observations || "None provided"
            }`,
            timestamp: new Date().toISOString(),
            processed: false,
            type: "set_completion",
          });

          // Suggest getting AI guidance after a few sets
          if (
            sessionState.currentSet === 3 &&
            !sessionState.guidance_suggested
          ) {
            sessionState.guidance_suggested = true;
            addMessage({
              role: "system",
              content:
                "You've completed 3 sets. Consider saving your session now to get therapeutic insights from the AI assistant.",
            });
          }

          if (sessionState.currentSet >= sessionState.totalSets || suds <= 1) {
            endSession();
          } else if (
            suds <= 3 &&
            sessionState.currentSet >= Math.floor(sessionState.totalSets / 2)
          ) {
            suggestEndingSession(suds);
          }
        }
      }

      function suggestEndingSession(suds) {
        const modal = document.getElementById("helpModal");
        const title = document.getElementById("helpTitle");
        const content = document.getElementById("helpContent");

        title.textContent = "Progress Check";
        content.innerHTML = `
                <p class="mb-4">Your distress level is now quite low (${suds}/10), and you've completed more than half the sets. Would you like to:</p>
                <div class="space-y-2">
                    <button onclick="endSession()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 session-button">
                        End Session & Save Progress
                    </button>
                    <button onclick="closeHelp()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 session-button">
                        Continue Processing
                    </button>
                </div>
            `;
        modal.style.display = "flex";
      }

      function endSession() {
        sessionState.status = "completed";
        sessionState.endTime = new Date().toISOString();
        updateProgress(4);
        updateSessionInfo();

        const finalSuds = sessionState.sets[sessionState.sets.length - 1].suds;
        const sudsDifference = sessionState.initialSuds - finalSuds;
        const percentImprovement = (
          (sudsDifference / sessionState.initialSuds) *
          100
        ).toFixed(1);

        // Add to chat
        addMessage({
          role: "system",
          content: `Session completed. Initial SUDS: ${sessionState.initialSuds}/10, Final SUDS: ${finalSuds}/10, Improvement: ${percentImprovement}%`,
        });

        // Add completion notes to client notes
        sessionState.client_notes.push({
          content: `Session completed. Initial SUDS: ${sessionState.initialSuds}/10, Final SUDS: ${finalSuds}/10, Improvement: ${percentImprovement}%. Consider getting AI analysis of your completed session.`,
          timestamp: new Date().toISOString(),
          processed: false,
          type: "session_completion",
        });

        const modal = document.getElementById("helpModal");
        const title = document.getElementById("helpTitle");
        const content = document.getElementById("helpContent");

        title.textContent = "Session Complete";
        content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded">
                        <h4 class="font-medium mb-2">Session Summary:</h4>
                        <ul class="list-none space-y-2">
                            <li><strong>Starting distress level:</strong> ${sessionState.initialSuds}/10</li>
                            <li><strong>Final distress level:</strong> ${finalSuds}/10</li>
                            <li><strong>Improvement:</strong> ${percentImprovement}%</li>
                            <li><strong>Sets completed:</strong> ${sessionState.sets.length}</li>
                            <li><strong>Duration:</strong> ${sessionState.duration} minutes</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded">
                        <h4 class="font-medium mb-2">Next Steps:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li>Take time to rest and process</li>
                            <li>Be gentle with yourself</li>
                            <li>Notice any changes over the next few days</li>
                            <li>Consider scheduling a follow-up session if needed</li>
                        </ul>
                    </div>

                    <div class="bg-green-50 p-4 rounded">
                        <h4 class="font-medium mb-2">AI Therapist Analysis:</h4>
                        <p>For professional insights into your session and personalized recommendations:</p>
                        <ol class="list-decimal list-inside space-y-1">
                            <li>Save your session file</li>
                            <li>Submit it to the AI assistant</li>
                            <li>Import the response file back into this app</li>
                        </ol>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="exportSession()" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 session-button">
                            Save Session Data
                        </button>
                        <button onclick="closeHelp(); resetSession();" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 session-button">
                            Start New Session
                        </button>
                    </div>
                </div>
            `;
        modal.style.display = "flex";
      }

      function resetSession() {
        sessionState = {
          id: "session_" + Date.now(),
          startTime: new Date().toISOString(),
          memory: "",
          initialSuds: null,
          currentSet: 0,
          sets: [],
          status: "active",
          totalSets: sessionState.totalSets,
          duration: sessionState.duration,
          therapist_data: {},
          client_notes: [],
        };

        // Reset chat history but keep system messages
        chatHistory = chatHistory.filter((msg) => msg.role === "system");
        // Reset UI
        updateChatDisplay();
        document.getElementById("memoryText").value = "";
        document.getElementById("sudsRating").value = "";
        document.getElementById("sudsSlider").value = 5;
        document.getElementById("initialSudsDisplay").textContent = "-";
        document.getElementById("currentSudsDisplay").textContent = "-";
        document.getElementById("processHistory").classList.add("hidden");
        document.getElementById("historyContent").innerHTML = "";
        document.getElementById("chartContainer").classList.add("hidden");
        document.getElementById("therapistInsights").innerHTML =
          "No insights available yet. The therapist will provide guidance when you save and re-import the session.";

        // Reset progress bar
        document.getElementById("setProgressBar").style.width = "0%";
        
        // Reset immersive mode
        immersiveMode = false;

        // Show memory input
        document.getElementById("memoryInput").classList.remove("hidden");
        document.getElementById("ratingInput").classList.add("hidden");
        document.getElementById("processing").classList.add("hidden");

        // Reset progress
        updateProgress(1);
        updateFocusPanel(
          "Memory Selection",
          `
                <p>Please describe a specific memory you'd like to work on.</p>
                <p class="text-sm text-gray-500 mt-2">Choose something that:</p>
                <ul class="list-disc list-inside text-sm text-gray-500 mt-1">
                    <li>Is a single, specific event</li>
                    <li>Still causes some emotional discomfort</li>
                    <li>You feel ready to work with</li>
                </ul>
            `
        );

        updateSessionInfo();

        // Add welcome message
        addMessage({
          role: "assistant",
          content:
            "Welcome to your new EMDR therapy session. Let's start fresh. What specific memory would you like to work on today?",
        });
      }

      function updateSessionInfo() {
        const info = document.getElementById("sessionInfo");
        const sets = sessionState.sets.length;
        const initialSuds = sessionState.initialSuds;
        const currentSuds = sets > 0 ? sessionState.sets[sets - 1].suds : null;

        let infoText = `Session ${sessionState.id.split("_")[1]} | `;
        infoText += `Sets: ${sets}/${sessionState.totalSets} | `;
        if (initialSuds !== null) {
          infoText += `Initial SUDS: ${initialSuds}`;
          if (currentSuds !== null) {
            infoText += ` → Current: ${currentSuds}`;
          }
        }
        infoText += ` | Status: ${sessionState.status}`;
        info.textContent = infoText;
      }

      function showHelp(topic) {
        const modal = document.getElementById("helpModal");
        const title = document.getElementById("helpTitle");
        const content = document.getElementById("helpContent");

        if (topic === "memory") {
          title.textContent = "Choosing a Memory to Process";
          content.innerHTML = `
                    <div class="space-y-4">
                        <p>Choose a specific memory that:</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Still causes you some distress when you think about it</li>
                            <li>Happened at a specific time (not an ongoing situation)</li>
                            <li>You feel ready to work on</li>
                        </ul>
                        
                        <div class="bg-gray-50 p-4 rounded">
                            <p class="font-medium mb-2">Good examples:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-600">
                                <li>"That time I failed my driving test"</li>
                                <li>"When I gave my first presentation at work"</li>
                                <li>"The argument with my friend last summer"</li>
                            </ul>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded">
                            <p class="font-medium">Start Small:</p>
                            <p>If you're new to EMDR, start with a mildly disturbing memory (rated 3-5 out of 10) rather than your most difficult memories.</p>
                        </div>
                    </div>
                `;
        }

        modal.style.display = "flex";
      }

      function closeHelp() {
        document.getElementById("helpModal").style.display = "none";
      }

      function restoreSession() {
        // Restore memory
        if (sessionState.memory) {
          document.getElementById("memoryText").value = sessionState.memory;
        }

        // Restore rating
        if (sessionState.initialSuds !== null) {
          document.getElementById("sudsRating").value =
            sessionState.initialSuds;
          document.getElementById("sudsSlider").value =
            sessionState.initialSuds;
          document.getElementById("initialSudsDisplay").textContent =
            sessionState.initialSuds;

          if (sessionState.sets.length > 0) {
            const currentSuds =
              sessionState.sets[sessionState.sets.length - 1].suds;
            document.getElementById("currentSudsDisplay").textContent =
              currentSuds;
          }
        }

        // Restore SUDS chart
        if (sessionState.initialSuds !== null) {
          initSudsChart();
          sessionState.sets.forEach((set) => {
            updateSudsChart(set.suds);
          });
        }

        // Restore therapist insights if available
        if (
          sessionState.therapist_data &&
          (sessionState.therapist_data.therapist_observation ||
            sessionState.therapist_data.therapeutic_intervention ||
            sessionState.therapist_data.suggested_focus)
        ) {
          let insights = "";

          if (sessionState.therapist_data.therapist_observation) {
            insights += `<p class="mb-2"><strong>Observation:</strong> ${sessionState.therapist_data.therapist_observation}</p>`;
          }

          if (sessionState.therapist_data.therapeutic_intervention) {
            insights += `<p class="mb-2"><strong>Intervention:</strong> ${sessionState.therapist_data.therapeutic_intervention}</p>`;
          }

          if (sessionState.therapist_data.suggested_focus) {
            insights += `<p class="mb-2"><strong>Suggested Focus:</strong> ${sessionState.therapist_data.suggested_focus}</p>`;
          }

          if (sessionState.therapist_data.recommended_next_steps) {
            insights += `<p><strong>Recommended Next Steps:</strong> ${sessionState.therapist_data.recommended_next_steps}</p>`;
          }

          updateTherapistInsights(insights);
        }

        // Show appropriate stage
        if (!sessionState.memory) {
          document.getElementById("memoryInput").classList.remove("hidden");
          document.getElementById("ratingInput").classList.add("hidden");
          document.getElementById("processing").classList.add("hidden");
        } else if (sessionState.initialSuds === null) {
          document.getElementById("memoryInput").classList.add("hidden");
          document.getElementById("ratingInput").classList.remove("hidden");
          document.getElementById("processing").classList.add("hidden");
        } else {
          document.getElementById("memoryInput").classList.add("hidden");
          document.getElementById("ratingInput").classList.add("hidden");
          document.getElementById("processing").classList.remove("hidden");
          document.getElementById("currentSet").textContent =
            sessionState.currentSet + 1;
          document.getElementById("totalSets").textContent =
            sessionState.totalSets;
            
          // Update progress bar
          updateSetProgressBar();
        }

        // Update progress tracking based on session state
        if (sessionState.status === "completed") {
          updateProgress(4);
        } else if (sessionState.sets.length > 0) {
          updateProgress(3);
        } else if (sessionState.initialSuds !== null) {
          updateProgress(2);
        } else if (sessionState.memory) {
          updateProgress(1);
        }

        // Restore process history
        if (sessionState.sets.length > 0) {
          document.getElementById("processHistory").classList.remove("hidden");
          sessionState.sets.forEach((set) => {
            addToHistory(
              "Set Complete",
              `
                        <div class="space-y-1">
                            <div>SUDS: ${set.suds}/10</div>
                            ${
                              set.observations
                                ? `<div>Observations: ${set.observations}</div>`
                                : ""
                            }
                        </div>
                    `
            );
          });
        }

        // Add a system message noting session restore
        addMessage({
          role: "system",
          content: `Session ${sessionState.id} restored. Current status: ${sessionState.status}. Sets completed: ${sessionState.sets.length}/${sessionState.totalSets}.`,
        });

        // Mark all client notes as processed since they were analyzed
        if (sessionState.client_notes && sessionState.client_notes.length > 0) {
          sessionState.client_notes.forEach((note) => {
            note.processed = true;
          });
        }
      }

      // Event Listeners and Helpers for Fullscreen Mode
      function requestFullscreen() {
        const element = document.getElementById("ballFocusModal");

        if (element.requestFullscreen) {
          return element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
          // Safari
          return element.webkitRequestFullscreen();
        } else if (element.msRequestFullscreen) {
          // IE11
          return element.msRequestFullscreen();
        }
        return Promise.resolve();
      }

      function exitFullscreen() {
        if (document.exitFullscreen) {
          return document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          // Safari
          document.webkitExitFullscreen();
          return Promise.resolve();
        } else if (document.msExitFullscreen) {
          // IE11
          document.msExitFullscreen();
          return Promise.resolve();
        }
        return Promise.resolve();
      }

      // Handle browser visibility changes
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && immersiveMode && isRunning) {
          // Auto-pause when tab loses focus or is minimized
          pauseImmersiveSession();
        }
      });

      // Add swipe support for mobile users to exit immersive mode
      let touchStartY = 0;
      let touchEndY = 0;

      document.getElementById("ballFocusModal").addEventListener(
        "touchstart",
        (e) => {
          touchStartY = e.changedTouches[0].screenY;
        },
        false
      );

      document.getElementById("ballFocusModal").addEventListener(
        "touchend",
        (e) => {
          touchEndY = e.changedTouches[0].screenY;
          handleSwipe();
        },
        false
      );

      function handleSwipe() {
        const swipeDistance = touchEndY - touchStartY;
        // If swiped down more than 100px, exit immersive mode
        if (swipeDistance > 100 && immersiveMode) {
          if (document.fullscreenElement) {
            exitFullscreen().then(() => {
              exitImmersiveMode();
            }).catch(err => {
              console.error("Error exiting fullscreen:", err);
              exitImmersiveMode();
            });
          } else {
            exitImmersiveMode();
          }
        }
      }

      // Handle keyboard shortcuts for immersive mode
      document.addEventListener("keydown", (e) => {
        if (immersiveMode) {
          if (e.key === "Escape") {
            e.preventDefault();
            // Escape key will exit fullscreen automatically
            exitImmersiveMode();
          } else if (e.key === " " || e.key === "Spacebar") {
            // Toggle pause/resume with spacebar
            e.preventDefault();
            if (isRunning) {
              pauseImmersiveSession();
            } else {
              resumeImmersiveSession();
            }
          }
        }
      });

      // NEW EVENT HANDLERS FOR THE IMPROVED CHECK-IN EXPERIENCE
      document.addEventListener('DOMContentLoaded', () => {
        // Set up modal slider interactions
        const sudsHandle = document.getElementById("sudsHandle");
        const sudsFill = document.getElementById("sudsFill");
        const sudsInput = document.getElementById("modalCurrentSuds");
        const liveSudsValue = document.getElementById("liveSudsValue");
        
        // Handle range input via slider UI
        let isDragging = false;
        
        if (sudsHandle) {
          sudsHandle.addEventListener('mousedown', () => {
            isDragging = true;
          });
          
          document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSudsFromMousePosition(e);
          });
          
          document.addEventListener('mouseup', () => {
            isDragging = false;
          });
          
          // Handle clicks on the slider track
          if (sudsFill && sudsFill.parentElement) {
            sudsFill.parentElement.addEventListener('click', (e) =>sudsFill.parentElement.addEventListener('click', (e) => {
              updateSudsFromMousePosition(e);
            }));
          }
          
          function updateSudsFromMousePosition(e) {
            const sliderTrack = sudsFill.parentElement;
            const rect = sliderTrack.getBoundingClientRect();
            const position = (e.clientX - rect.left) / rect.width;
            let value = Math.round(position * 10);
            value = Math.max(0, Math.min(10, value));
            
            // Update the position and value
            const percentage = (value / 10) * 100;
            sudsFill.style.width = `${percentage}%`;
            sudsHandle.style.left = `${percentage}%`;
            sudsInput.value = value;
            liveSudsValue.textContent = value;
          }
        }
        
        // Sync from number input
        if (sudsInput) {
          sudsInput.addEventListener('input', () => {
            let value = parseInt(sudsInput.value);
            if (isNaN(value)) value = 0;
            value = Math.max(0, Math.min(10, value));
            
            const percentage = (value / 10) * 100;
            sudsFill.style.width = `${percentage}%`;
            sudsHandle.style.left = `${percentage}%`;
            liveSudsValue.textContent = value;
          });
        }
        
        // Continue button for modal
        const continueButton = document.getElementById("continueToNextSet");
        if (continueButton) {
          continueButton.addEventListener('click', () => {
            const modal = document.getElementById("setCompletionModal");
            const content = document.getElementById("setCompletionContent");
            
            // Get the values
            const suds = parseInt(document.getElementById("modalCurrentSuds").value) || 0;
            const observations = document.getElementById("modalObservations").value.trim();
            
            // Fade out animation
            content.style.opacity = "0";
            content.style.transform = "scale(0.95)";
            
            setTimeout(() => {
              modal.style.display = "none";
              content.classList.remove("scale-in");
              // Call the shared function to process the set completion
              processSetCompletion(suds, observations);
            }, 300);
          });
        }
      });

      // Initialize session
      document.addEventListener("DOMContentLoaded", function () {
        // Update speedControl label initially
        document.getElementById('speedLabel').textContent = 'Normal Speed';
        
        // Set up document focus/blur handlers
        window.addEventListener("blur", () => {
          if (immersiveMode && isRunning) {
            pauseImmersiveSession();
            addMessage({
              role: "system",
              content: "Session automatically paused when window lost focus.",
            });
          }
        });

        // Auto-save session data to localStorage periodically
        setInterval(() => {
          if (sessionState.status === "active") {
            localStorage.setItem(
              "emdr_session_backup",
              JSON.stringify(sessionState)
            );
          }
        }, 30000); // Every 30 seconds

        // Check for saved session
        const savedSession = localStorage.getItem("emdr_session_backup");
        if (savedSession) {
          const parsedSession = JSON.parse(savedSession);
          // Only offer to restore if it's from today and not completed
          if (
            parsedSession.status === "active" &&
            new Date(parsedSession.startTime).toDateString() ===
              new Date().toDateString()
          ) {
            // Show recovery option
            setTimeout(() => {
              if (
                confirm(
                  "We found a saved session from today. Would you like to restore it?"
                )
              ) {
                sessionState = parsedSession;
                restoreSession();
                updateSessionInfo();
              } else {
                // Clear the backup if declined
                localStorage.removeItem("emdr_session_backup");
              }
            }, 1000);
          }
        }
      });

      // Fix for toggle button - runs AFTER document is fully loaded
      window.addEventListener("load", function() {
        // Clear all event listeners from toggle button
        setTimeout(() => {
          console.log("Applying toggle button fix");
          
          // Clone the button to remove all event listeners
          const toggleButton = document.getElementById("toggleButton");
          const newToggleButton = toggleButton.cloneNode(true);
          toggleButton.parentNode.replaceChild(newToggleButton, toggleButton);
          
          // Add single correct event listener
          document.getElementById("toggleButton").addEventListener("click", function() {
            console.log("Toggle button clicked, isRunning:", isRunning);
            if (isRunning) {
              stopSet();
            } else {
              // Direct call to startImmersiveMode
              startImmersiveMode();
              
              // Try to enter fullscreen
              try {
                requestFullscreen();
              } catch (e) {
                console.error("Fullscreen request failed:", e);
              }
            }
          });
          
          // Set up modal exit button properly
          document.getElementById("modalExitButton").addEventListener("click", function() {
            // Exit fullscreen first if applicable  
            if (document.fullscreenElement) {
              exitFullscreen().then(() => {
                exitImmersiveMode();
              }).catch(err => {
                console.error("Error exiting fullscreen:", err);
                exitImmersiveMode();
              });
            } else {
              exitImmersiveMode();
            }
          });
          
          console.log("Toggle button fix applied");
        }, 100);
      });
      
      // Support for mobile device orientation change
      window.addEventListener("orientationchange", () => {
        if (immersiveMode) {
          // Pause briefly to let the orientation change complete
          const wasRunning = isRunning;
          if (wasRunning) {
            pauseImmersiveSession();
          }

          // Resume after orientation change completes
          setTimeout(() => {
            if (wasRunning) {
              resumeImmersiveSession();
            }
          }, 500);
        }
      });
    </script>
  </body>
</html>