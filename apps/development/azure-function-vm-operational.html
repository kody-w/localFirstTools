<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Function VM - Fully Operational</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(0, 120, 212, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 28px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .azure-badge {
            background: linear-gradient(135deg, #00d4ff 0%, #0078d4 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 13px;
            backdrop-filter: blur(5px);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px currentColor;
        }

        .status-indicator.azure {
            background: #00d4ff;
        }

        .status-indicator.warning {
            background: #ff9800;
        }

        .status-indicator.error {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .main-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            width: 450px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 120, 212, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #00d4ff;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .terminal {
            background: #0c0c0c;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-y: auto;
            min-height: 300px;
            max-height: 400px;
            color: #0f0;
            text-shadow: 0 0 3px #0f0;
            border: 1px solid #222;
        }

        .terminal-line {
            margin: 3px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .terminal-line.azure {
            color: #00d4ff;
            text-shadow: 0 0 3px #00d4ff;
        }

        .terminal-line.http {
            color: #ffeb3b;
            text-shadow: 0 0 3px #ffeb3b;
        }

        .terminal-line.success {
            color: #4caf50;
            text-shadow: 0 0 3px #4caf50;
        }

        .terminal-line.error {
            color: #ff6b6b;
            text-shadow: 0 0 3px #ff6b6b;
        }

        .terminal-line.system {
            color: #64b5f6;
            text-shadow: 0 0 3px #64b5f6;
        }

        .terminal-input {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .terminal-prompt {
            color: #4caf50;
            margin-right: 10px;
            text-shadow: 0 0 3px #4caf50;
        }

        input[type="text"], textarea {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 120, 212, 0.3);
            color: #00d4ff;
            font-family: inherit;
            font-size: 13px;
            outline: none;
            padding: 8px;
            border-radius: 4px;
        }

        input[type="text"]:focus, textarea:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        button {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 120, 212, 0.6);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        button.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        button.danger {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        }

        .code-editor {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            position: relative;
            border: 1px solid rgba(0, 120, 212, 0.3);
        }

        .code-editor textarea {
            width: 100%;
            min-height: 250px;
            background: transparent;
            border: none;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            line-height: 1.5;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .editor-title {
            color: #00d4ff;
            font-size: 12px;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .editor-actions button {
            padding: 4px 12px;
            font-size: 12px;
        }

        .function-endpoint {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .endpoint-url {
            color: #00d4ff;
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .endpoint-url:hover {
            background: rgba(0, 120, 212, 0.2);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .test-panel {
            margin-top: 15px;
        }

        .test-input {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 120, 212, 0.3);
            color: white;
            border-radius: 4px;
            margin: 10px 0;
        }

        .response-viewer {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .response-viewer pre {
            color: #00d4ff;
            margin: 0;
            white-space: pre-wrap;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loader.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 212, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .metric-item {
            padding: 15px;
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.2) 0%, rgba(0, 90, 158, 0.2) 100%);
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.3s;
        }

        .metric-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 120, 212, 0.3);
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .metric-label {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .deployment-config {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-item label {
            flex: 1;
            font-size: 13px;
            color: #aaa;
        }

        .config-item input, .config-item select {
            flex: 2;
            padding: 6px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 120, 212, 0.3);
            color: white;
            border-radius: 4px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(0, 120, 212, 0.3);
        }

        .tab {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: #aaa;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(0, 120, 212, 0.3);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .log-entry {
            padding: 8px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid #0078d4;
            border-radius: 4px;
            font-size: 12px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .right-panel {
                width: 100%;
            }
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            ⚡ Azure Function VM
            <span class="azure-badge">FULLY OPERATIONAL</span>
        </h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="vmIndicator"></div>
                <span>VM: <span id="vmStatus">Initializing</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator azure" id="azureIndicator"></div>
                <span>Azure: <span id="functionStatus">Not Deployed</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="dockerIndicator"></div>
                <span>Docker: <span id="containerStatus">Stopped</span></span>
            </div>
            <div class="status-item">
                <span>Runtime: Node.js 18.17.1</span>
            </div>
            <div class="status-item">
                <span>Region: <span id="azureRegion">East US</span></span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="panel">
                <h3>💻 Container Terminal</h3>
                <div class="terminal" id="terminal"></div>
                <div class="terminal-input">
                    <span class="terminal-prompt">azure@vm:~$</span>
                    <input type="text" id="terminalInput" placeholder="Enter command... (type 'help' for commands)">
                </div>
            </div>

            <div class="panel">
                <h3>📝 Function Editor</h3>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('function')">index.js</button>
                    <button class="tab" onclick="switchTab('config')">function.json</button>
                    <button class="tab" onclick="switchTab('package')">package.json</button>
                </div>
                <div class="code-editor">
                    <div class="tab-content active" id="function-tab">
                        <div class="editor-toolbar">
                            <span class="editor-title">Azure Function Code</span>
                            <div class="editor-actions">
                                <button onclick="formatCode()">Format</button>
                                <button onclick="saveFunction()">Save</button>
                            </div>
                        </div>
                        <textarea id="functionCode">module.exports = async function (context, req) {
    // Azure Function HTTP Trigger
    context.log('JavaScript HTTP trigger function processed a request.');
    
    const name = req.query.name || (req.body && req.body.name) || 'Azure';
    const timestamp = new Date().toISOString();
    
    // Custom business logic
    const responseMessage = {
        message: \`Hello, \${name}! Welcome to Azure Functions.\`,
        timestamp: timestamp,
        requestId: context.invocationId,
        environment: {
            platform: 'Azure Functions',
            runtime: 'Node.js 18.17.1',
            region: process.env.AZURE_REGION || 'East US',
            containerized: true
        },
        headers: req.headers,
        method: req.method,
        url: req.url
    };
    
    // Log metrics
    context.log(\`Request processed for: \${name}\`);
    
    // Return response
    context.res = {
        status: 200,
        body: responseMessage,
        headers: {
            'Content-Type': 'application/json',
            'X-Powered-By': 'Azure Functions',
            'X-Request-ID': context.invocationId
        }
    };
};</textarea>
                    </div>
                    <div class="tab-content" id="config-tab">
                        <div class="editor-toolbar">
                            <span class="editor-title">Function Configuration</span>
                        </div>
                        <textarea id="configCode">{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get", "post", "put", "delete"],
      "route": "api/{*route}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ],
  "scriptFile": "index.js"
}</textarea>
                    </div>
                    <div class="tab-content" id="package-tab">
                        <div class="editor-toolbar">
                            <span class="editor-title">Package Configuration</span>
                        </div>
                        <textarea id="packageCode">{
  "name": "azure-function-app",
  "version": "1.0.0",
  "description": "Azure Function running in browser VM",
  "main": "index.js",
  "scripts": {
    "start": "func start",
    "test": "echo \"Running tests...\" && exit 0"
  },
  "dependencies": {
    "@azure/functions": "^4.0.0",
    "axios": "^1.6.0"
  },
  "devDependencies": {
    "azure-functions-core-tools": "^4.0.5455"
  }
}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel">
                <h3>🚀 Deployment Control</h3>
                <div class="deployment-config">
                    <div class="config-item">
                        <label>Function Name:</label>
                        <input type="text" id="functionName" value="HttpTrigger">
                    </div>
                    <div class="config-item">
                        <label>Region:</label>
                        <select id="regionSelect">
                            <option value="eastus">East US</option>
                            <option value="westus">West US</option>
                            <option value="centralus">Central US</option>
                            <option value="northeurope">North Europe</option>
                            <option value="westeurope">West Europe</option>
                            <option value="eastasia">East Asia</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>Auth Level:</label>
                        <select id="authLevel">
                            <option value="anonymous">Anonymous</option>
                            <option value="function">Function</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="controls" style="margin-top: 15px;">
                    <button onclick="buildContainer()" id="buildBtn">📦 Build Container</button>
                    <button onclick="deployFunction()" id="deployBtn" class="success">🚀 Deploy Function</button>
                    <button onclick="startFunction()" id="startBtn" class="success">▶️ Start</button>
                    <button onclick="stopFunction()" id="stopBtn" class="danger">⏹️ Stop</button>
                </div>
                <div class="loader" id="loader">
                    <div class="spinner"></div>
                    <p id="loaderText">Processing...</p>
                </div>
                <div class="function-endpoint" id="functionEndpoint" style="display: none;">
                    <strong>🌐 Live Endpoint:</strong>
                    <div class="endpoint-url" id="endpointUrl" onclick="copyEndpoint()"></div>
                </div>
            </div>

            <div class="panel">
                <h3>🧪 API Testing</h3>
                <div class="test-panel">
                    <select id="methodSelect" style="width: 100%; margin-bottom: 10px;">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                    <input type="text" class="test-input" id="testPath" placeholder="API Path (e.g., /api/hello)">
                    <textarea class="test-input" id="testBody" placeholder="Request Body (JSON)" style="min-height: 80px;">{
  "name": "Azure Developer",
  "data": "test"
}</textarea>
                    <button onclick="testAPI()" id="testBtn" style="width: 100%;">🔬 Send Request</button>
                    <div class="response-viewer" id="responseViewer" style="display: none;">
                        <strong>Response:</strong>
                        <pre id="responseContent"></pre>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>📊 Live Metrics</h3>
                <div class="metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="requestCount">0</div>
                        <div class="metric-label">Requests</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avgResponseTime">0ms</div>
                        <div class="metric-label">Avg Response</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="successRate">100%</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="uptime">0s</div>
                        <div class="metric-label">Uptime</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>📜 Activity Log</h3>
                <div id="activityLog" style="max-height: 200px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Complete Azure Function VM Implementation
        class AzureFunctionVM {
            constructor() {
                this.functions = new Map();
                this.containers = new Map();
                this.isRunning = false;
                this.metrics = {
                    requests: 0,
                    totalResponseTime: 0,
                    errors: 0,
                    startTime: null
                };
                this.httpServer = null;
                this.endpoints = new Map();
                this.currentFunction = null;
                this.dockerImage = null;
                this.containerId = null;
                
                this.initialize();
            }

            initialize() {
                this.addLog('System', 'Azure Function VM initialized');
                this.addTerminal('[System] Azure Function VM Ready', 'system');
                this.addTerminal('[System] Type "help" for available commands', 'system');
                this.updateStatus('vmStatus', 'Ready');
                
                // Setup service worker for intercepting requests
                this.setupServiceWorker();
                
                // Start metrics updater
                setInterval(() => this.updateUptime(), 1000);
            }

            setupServiceWorker() {
                // Create in-browser HTTP handler
                this.httpServer = {
                    routes: new Map(),
                    handle: async (method, path, body, headers) => {
                        const route = this.httpServer.routes.get(path);
                        if (!route) {
                            return {
                                status: 404,
                                body: { error: 'Function not found' }
                            };
                        }
                        
                        const startTime = Date.now();
                        try {
                            const context = this.createContext();
                            const req = {
                                method,
                                url: path,
                                query: this.parseQuery(path),
                                body: body ? JSON.parse(body) : {},
                                headers: headers || {}
                            };
                            
                            await route.handler(context, req);
                            
                            const responseTime = Date.now() - startTime;
                            this.updateMetrics(responseTime, true);
                            
                            return context.res || {
                                status: 200,
                                body: { message: 'Success' }
                            };
                        } catch (error) {
                            this.updateMetrics(Date.now() - startTime, false);
                            return {
                                status: 500,
                                body: { error: error.message }
                            };
                        }
                    }
                };
            }

            createContext() {
                const invocationId = this.generateId();
                return {
                    invocationId,
                    log: (msg) => this.addTerminal(`[Function] ${msg}`, 'azure'),
                    res: null,
                    done: () => {}
                };
            }

            parseQuery(url) {
                const queryString = url.split('?')[1];
                if (!queryString) return {};
                
                const params = new URLSearchParams(queryString);
                const query = {};
                for (const [key, value] of params) {
                    query[key] = value;
                }
                return query;
            }

            async buildContainer() {
                this.addTerminal('[Docker] Building Azure Functions container...', 'azure');
                this.addLog('Docker', 'Starting container build');
                
                await this.delay(500);
                this.addTerminal('[Docker] Creating Dockerfile...', 'system');
                
                await this.delay(800);
                this.addTerminal('[Docker] FROM mcr.microsoft.com/azure-functions/node:4-node18');
                
                await this.delay(600);
                this.addTerminal('[Docker] Installing Azure Functions Core Tools...');
                
                await this.delay(700);
                this.addTerminal('[Docker] Copying function files...');
                
                await this.delay(500);
                this.addTerminal('[Docker] Running npm install...');
                this.addTerminal('[npm] + @azure/functions@4.0.0');
                this.addTerminal('[npm] + axios@1.6.0');
                this.addTerminal('[npm] added 45 packages in 2.3s');
                
                await this.delay(400);
                const imageId = this.generateId().substring(0, 12);
                this.dockerImage = {
                    id: imageId,
                    name: 'azurefunc:latest',
                    created: new Date().toISOString()
                };
                
                this.addTerminal(`[Docker] Successfully built ${imageId}`, 'success');
                this.addTerminal('[Docker] Tagged as azurefunc:latest', 'success');
                this.addLog('Docker', 'Container build completed');
                
                this.updateStatus('dockerIndicator', 'warning');
                this.updateStatus('containerStatus', 'Image Ready');
                
                return this.dockerImage;
            }

            async deployFunction() {
                if (!this.dockerImage) {
                    this.addTerminal('[Error] Build container first!', 'error');
                    this.showNotification('Please build the container first', 'error');
                    return;
                }
                
                this.addTerminal('[Azure] Deploying function to Azure...', 'azure');
                this.addLog('Deploy', 'Starting deployment process');
                
                const functionName = document.getElementById('functionName').value;
                const region = document.getElementById('regionSelect').value;
                const authLevel = document.getElementById('authLevel').value;
                
                await this.delay(600);
                this.addTerminal(`[Azure] Creating function app "${functionName}"...`);
                
                await this.delay(800);
                this.addTerminal(`[Azure] Region: ${region}`);
                this.addTerminal(`[Azure] Runtime: Node.js 18.17.1`);
                this.addTerminal(`[Azure] Auth Level: ${authLevel}`);
                
                await this.delay(700);
                this.addTerminal('[Azure] Uploading function code...');
                
                // Get the function code from editor
                const functionCode = document.getElementById('functionCode').value;
                
                // Create the function
                const func = new Function('return ' + functionCode)();
                this.currentFunction = {
                    name: functionName,
                    handler: func,
                    config: JSON.parse(document.getElementById('configCode').value),
                    region: region
                };
                
                // Register the function endpoint
                const endpoint = `/api/${functionName.toLowerCase()}`;
                this.httpServer.routes.set(endpoint, {
                    handler: func,
                    config: this.currentFunction.config
                });
                
                await this.delay(500);
                this.addTerminal('[Azure] Creating HTTP trigger binding...', 'system');
                
                await this.delay(400);
                this.addTerminal('[Azure] Function deployed successfully!', 'success');
                this.addTerminal(`[Azure] Endpoint: https://localhost:7071${endpoint}`, 'http');
                
                // Update UI
                document.getElementById('functionStatus').textContent = 'Deployed';
                document.getElementById('azureIndicator').classList.add('azure');
                document.getElementById('endpointUrl').textContent = `https://localhost:7071${endpoint}`;
                document.getElementById('functionEndpoint').style.display = 'block';
                document.getElementById('azureRegion').textContent = this.getRegionName(region);
                
                this.addLog('Deploy', `Function deployed to ${region}`);
                this.showNotification('Function deployed successfully!', 'success');
                
                return true;
            }

            async startFunction() {
                if (!this.currentFunction) {
                    this.addTerminal('[Error] Deploy a function first!', 'error');
                    return;
                }
                
                if (this.isRunning) {
                    this.addTerminal('[Warning] Function already running', 'warning');
                    return;
                }
                
                this.addTerminal('[Azure] Starting Azure Functions runtime...', 'azure');
                this.addLog('Runtime', 'Starting function runtime');
                
                await this.delay(500);
                this.containerId = this.generateId().substring(0, 12);
                this.addTerminal(`[Docker] Starting container ${this.containerId}...`);
                
                await this.delay(600);
                this.addTerminal('[Host] Azure Functions Core Tools');
                this.addTerminal('[Host] Version: 4.0.5455');
                this.addTerminal('[Host] Function Runtime: 4.27.5.21554');
                
                await this.delay(400);
                this.addTerminal('[Host] Starting HTTP server...');
                
                await this.delay(500);
                this.addTerminal('[Host] HTTP server listening on port 7071', 'http');
                this.addTerminal('[Host] Function URLs:', 'http');
                
                for (const [path, route] of this.httpServer.routes) {
                    this.addTerminal(`[Host]   ${path}: https://localhost:7071${path}`, 'http');
                }
                
                this.addTerminal('[Host] Host started successfully', 'success');
                
                this.isRunning = true;
                this.metrics.startTime = Date.now();
                
                // Update status
                this.updateStatus('containerStatus', 'Running');
                this.updateStatus('functionStatus', 'Active');
                this.updateStatus('dockerIndicator', 'success');
                
                this.addLog('Runtime', 'Function runtime started');
                this.showNotification('Function is now running!', 'success');
                
                // Start health check
                this.startHealthCheck();
            }

            async stopFunction() {
                if (!this.isRunning) {
                    this.addTerminal('[Warning] No function running', 'warning');
                    return;
                }
                
                this.addTerminal('[Azure] Stopping function runtime...', 'azure');
                this.addLog('Runtime', 'Stopping function runtime');
                
                await this.delay(500);
                this.addTerminal('[Host] Stopping HTTP server...');
                
                await this.delay(400);
                this.addTerminal(`[Docker] Stopping container ${this.containerId}...`);
                
                await this.delay(300);
                this.addTerminal('[Docker] Container stopped', 'success');
                
                this.isRunning = false;
                this.containerId = null;
                
                // Update status
                this.updateStatus('containerStatus', 'Stopped');
                this.updateStatus('functionStatus', 'Inactive');
                this.updateStatus('dockerIndicator', 'error');
                
                this.addLog('Runtime', 'Function runtime stopped');
                this.showNotification('Function stopped', 'warning');
            }

            async testAPI() {
                if (!this.isRunning) {
                    this.addTerminal('[Error] Start the function first!', 'error');
                    this.showNotification('Function is not running', 'error');
                    return;
                }
                
                const method = document.getElementById('methodSelect').value;
                const path = document.getElementById('testPath').value || `/api/${this.currentFunction.name.toLowerCase()}`;
                const body = document.getElementById('testBody').value;
                
                this.addTerminal(`[HTTP] ${method} ${path}`, 'http');
                this.addLog('API Test', `${method} ${path}`);
                
                try {
                    const response = await this.httpServer.handle(method, path, body, {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Azure-Function-VM/1.0'
                    });
                    
                    this.addTerminal(`[HTTP] Response: ${response.status}`, 'success');
                    
                    // Display response
                    document.getElementById('responseViewer').style.display = 'block';
                    document.getElementById('responseContent').textContent = 
                        JSON.stringify(response.body, null, 2);
                    
                    this.showNotification('Request successful!', 'success');
                } catch (error) {
                    this.addTerminal(`[Error] ${error.message}`, 'error');
                    this.showNotification('Request failed', 'error');
                }
            }

            startHealthCheck() {
                setInterval(() => {
                    if (this.isRunning && Math.random() > 0.8) {
                        this.addTerminal('[Health] Function health check: Healthy', 'system');
                        this.addLog('Health', 'Health check passed');
                    }
                }, 15000);
            }

            updateMetrics(responseTime, success) {
                this.metrics.requests++;
                this.metrics.totalResponseTime += responseTime;
                if (!success) this.metrics.errors++;
                
                document.getElementById('requestCount').textContent = this.metrics.requests;
                
                const avgTime = Math.round(this.metrics.totalResponseTime / this.metrics.requests);
                document.getElementById('avgResponseTime').textContent = `${avgTime}ms`;
                
                const successRate = Math.round(((this.metrics.requests - this.metrics.errors) / this.metrics.requests) * 100);
                document.getElementById('successRate').textContent = `${successRate}%`;
            }

            updateUptime() {
                if (this.isRunning && this.metrics.startTime) {
                    const uptime = Math.floor((Date.now() - this.metrics.startTime) / 1000);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    const seconds = uptime % 60;
                    
                    let uptimeStr = '';
                    if (hours > 0) uptimeStr += `${hours}h `;
                    if (minutes > 0) uptimeStr += `${minutes}m `;
                    uptimeStr += `${seconds}s`;
                    
                    document.getElementById('uptime').textContent = uptimeStr;
                }
            }

            processCommand(command) {
                const parts = command.split(' ');
                const cmd = parts[0];
                
                switch(cmd) {
                    case 'help':
                        this.showHelp();
                        break;
                    case 'func':
                        this.processFuncCommand(parts.slice(1));
                        break;
                    case 'docker':
                        this.processDockerCommand(parts.slice(1));
                        break;
                    case 'az':
                        this.processAzureCommand(parts.slice(1));
                        break;
                    case 'clear':
                        document.getElementById('terminal').innerHTML = '';
                        break;
                    case 'status':
                        this.showStatus();
                        break;
                    case 'logs':
                        this.showLogs();
                        break;
                    default:
                        this.addTerminal(`Command not found: ${cmd}. Type 'help' for commands.`, 'error');
                }
            }

            showHelp() {
                this.addTerminal('Available commands:', 'system');
                this.addTerminal('  help              Show this help message');
                this.addTerminal('  func start        Start Azure Functions runtime');
                this.addTerminal('  func stop         Stop Azure Functions runtime');
                this.addTerminal('  func list         List deployed functions');
                this.addTerminal('  docker ps         List running containers');
                this.addTerminal('  docker images     List Docker images');
                this.addTerminal('  docker build      Build container image');
                this.addTerminal('  az function list  List Azure functions');
                this.addTerminal('  az regions        List available regions');
                this.addTerminal('  status            Show system status');
                this.addTerminal('  logs              Show recent logs');
                this.addTerminal('  clear             Clear terminal');
            }

            processFuncCommand(args) {
                if (args.length === 0) {
                    this.addTerminal('Azure Functions Core Tools 4.0.5455');
                    return;
                }
                
                switch(args[0]) {
                    case 'start':
                        this.startFunction();
                        break;
                    case 'stop':
                        this.stopFunction();
                        break;
                    case 'list':
                        if (this.httpServer.routes.size > 0) {
                            this.addTerminal('Deployed functions:');
                            for (const [path] of this.httpServer.routes) {
                                this.addTerminal(`  ${path}`);
                            }
                        } else {
                            this.addTerminal('No functions deployed');
                        }
                        break;
                    default:
                        this.addTerminal(`Unknown func command: ${args[0]}`, 'error');
                }
            }

            processDockerCommand(args) {
                if (args.length === 0) return;
                
                switch(args[0]) {
                    case 'ps':
                        if (this.containerId && this.isRunning) {
                            this.addTerminal('CONTAINER ID   IMAGE              STATUS');
                            this.addTerminal(`${this.containerId}   azurefunc:latest   running`);
                        } else {
                            this.addTerminal('No containers running');
                        }
                        break;
                    case 'images':
                        if (this.dockerImage) {
                            this.addTerminal('REPOSITORY   TAG      IMAGE ID');
                            this.addTerminal(`azurefunc    latest   ${this.dockerImage.id}`);
                        } else {
                            this.addTerminal('No images available');
                        }
                        break;
                    case 'build':
                        this.buildContainer();
                        break;
                    default:
                        this.addTerminal(`Unknown docker command: ${args[0]}`, 'error');
                }
            }

            processAzureCommand(args) {
                if (args.length < 2) return;
                
                if (args[0] === 'function' && args[1] === 'list') {
                    if (this.currentFunction) {
                        this.addTerminal('Azure Functions:', 'azure');
                        this.addTerminal(`  Name: ${this.currentFunction.name}`);
                        this.addTerminal(`  Region: ${this.currentFunction.region}`);
                        this.addTerminal(`  Runtime: Node.js 18.17.1`);
                    } else {
                        this.addTerminal('No functions deployed to Azure');
                    }
                } else if (args[0] === 'regions') {
                    this.addTerminal('Available Azure regions:', 'azure');
                    this.addTerminal('  eastus       - East US');
                    this.addTerminal('  westus       - West US');
                    this.addTerminal('  centralus    - Central US');
                    this.addTerminal('  northeurope  - North Europe');
                    this.addTerminal('  westeurope   - West Europe');
                    this.addTerminal('  eastasia     - East Asia');
                }
            }

            showStatus() {
                this.addTerminal('System Status:', 'system');
                this.addTerminal(`  VM Status: ${document.getElementById('vmStatus').textContent}`);
                this.addTerminal(`  Function Status: ${document.getElementById('functionStatus').textContent}`);
                this.addTerminal(`  Container Status: ${document.getElementById('containerStatus').textContent}`);
                this.addTerminal(`  Runtime: ${this.isRunning ? 'Running' : 'Stopped'}`);
                if (this.currentFunction) {
                    this.addTerminal(`  Deployed Function: ${this.currentFunction.name}`);
                    this.addTerminal(`  Region: ${this.currentFunction.region}`);
                }
            }

            showLogs() {
                const logs = document.getElementById('activityLog').children;
                if (logs.length === 0) {
                    this.addTerminal('No recent logs');
                    return;
                }
                
                this.addTerminal('Recent activity logs:', 'system');
                for (let i = Math.max(0, logs.length - 5); i < logs.length; i++) {
                    this.addTerminal(logs[i].textContent);
                }
            }

            getRegionName(region) {
                const regions = {
                    'eastus': 'East US',
                    'westus': 'West US',
                    'centralus': 'Central US',
                    'northeurope': 'North Europe',
                    'westeurope': 'West Europe',
                    'eastasia': 'East Asia'
                };
                return regions[region] || region;
            }

            addTerminal(text, className = '') {
                const terminal = document.getElementById('terminal');
                const line = document.createElement('div');
                line.className = `terminal-line ${className}`;
                line.textContent = text;
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            }

            addLog(category, message) {
                const log = document.getElementById('activityLog');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const timestamp = new Date().toLocaleTimeString();
                entry.textContent = `[${timestamp}] ${category}: ${message}`;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }

            updateStatus(elementId, status) {
                document.getElementById(elementId).textContent = status;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                
                if (type === 'error') {
                    notification.style.background = 'linear-gradient(135deg, #f44336 0%, #da190b 100%)';
                } else if (type === 'warning') {
                    notification.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
                }
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            generateId() {
                return Array.from({length: 32}, () => 
                    Math.floor(Math.random() * 16).toString(16)
                ).join('');
            }
        }

        // Initialize VM
        const vm = new AzureFunctionVM();

        // UI Functions
        async function buildContainer() {
            const btn = document.getElementById('buildBtn');
            btn.disabled = true;
            btn.textContent = 'Building...';
            
            await vm.buildContainer();
            
            btn.disabled = false;
            btn.textContent = '📦 Build Container';
        }

        async function deployFunction() {
            const btn = document.getElementById('deployBtn');
            const loader = document.getElementById('loader');
            
            btn.disabled = true;
            loader.classList.add('active');
            document.getElementById('loaderText').textContent = 'Deploying to Azure...';
            
            await vm.deployFunction();
            
            loader.classList.remove('active');
            btn.disabled = false;
        }

        async function startFunction() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'Starting...';
            
            await vm.startFunction();
            
            btn.disabled = false;
            btn.textContent = '▶️ Start';
        }

        async function stopFunction() {
            const btn = document.getElementById('stopBtn');
            btn.disabled = true;
            btn.textContent = 'Stopping...';
            
            await vm.stopFunction();
            
            btn.disabled = false;
            btn.textContent = '⏹️ Stop';
        }

        async function testAPI() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            await vm.testAPI();
            
            btn.disabled = false;
            btn.textContent = '🔬 Send Request';
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        function formatCode() {
            // Simple code formatting
            const code = document.getElementById('functionCode');
            try {
                // Basic formatting - in production would use a proper formatter
                let formatted = code.value;
                formatted = formatted.replace(/;/g, ';\n');
                formatted = formatted.replace(/{/g, ' {\n    ');
                formatted = formatted.replace(/}/g, '\n}');
                code.value = formatted;
                vm.showNotification('Code formatted', 'success');
            } catch (e) {
                vm.showNotification('Format failed', 'error');
            }
        }

        function saveFunction() {
            // Save to localStorage
            const functionCode = document.getElementById('functionCode').value;
            const configCode = document.getElementById('configCode').value;
            const packageCode = document.getElementById('packageCode').value;
            
            localStorage.setItem('azureFunction', JSON.stringify({
                function: functionCode,
                config: configCode,
                package: packageCode,
                saved: new Date().toISOString()
            }));
            
            vm.showNotification('Function saved to local storage', 'success');
            vm.addLog('Save', 'Function code saved');
        }

        function copyEndpoint() {
            const endpoint = document.getElementById('endpointUrl').textContent;
            navigator.clipboard.writeText(endpoint);
            vm.showNotification('Endpoint copied to clipboard', 'success');
        }

        // Terminal input handler
        document.getElementById('terminalInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const command = this.value.trim();
                if (command) {
                    vm.addTerminal(`azure@vm:~$ ${command}`);
                    vm.processCommand(command);
                    this.value = '';
                }
            }
        });

        // Load saved function on startup
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('azureFunction');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('functionCode').value = data.function;
                    document.getElementById('configCode').value = data.config;
                    document.getElementById('packageCode').value = data.package;
                    vm.addLog('Load', `Restored function from ${new Date(data.saved).toLocaleString()}`);
                } catch (e) {
                    console.error('Failed to load saved function', e);
                }
            }
        });

        // Auto-save periodically
        setInterval(() => {
            if (document.getElementById('functionCode').value) {
                saveFunction();
            }
        }, 60000); // Auto-save every minute
    </script>
</body>
</html>