<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container2WASM - Real Containers in Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .status.ready {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .container-selector {
            margin: 20px 0;
        }

        .container-selector label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .container-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }

        .container-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .terminal-container {
            margin: 20px 0;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            min-height: 400px;
        }

        #terminal {
            width: 100%;
            height: 400px;
            padding: 10px;
        }

        .info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .feature h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .feature p {
            color: #666;
            line-height: 1.6;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logs {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Container2WASM Browser Runner</h1>
            <p>Run real Linux containers in your browser using WebAssembly and WASI</p>
        </div>

        <div class="info">
            <strong>Technology:</strong> This demo uses container2wasm to convert real Linux containers to WebAssembly, 
            browser_wasi_shim for WASI runtime, and xterm.js for terminal emulation. Containers run entirely in your browser!
        </div>

        <div class="container-selector">
            <label for="containerSelect">Select Container Image:</label>
            <select id="containerSelect">
                <option value="">Choose a container...</option>
                <option value="debian" data-url="https://ktock.github.io/container2wasm-demo/containers/amd64-debian-wasi-container" data-arch="x86_64">Debian (x86_64) - 130MB</option>
                <option value="debian-riscv" data-url="https://ktock.github.io/container2wasm-demo/containers/riscv64-debian-wasi-container" data-arch="riscv64">Debian (RISC-V) - 78MB</option>
                <option value="python" data-url="https://ktock.github.io/container2wasm-demo/containers/amd64-python-wasi-container" data-arch="x86_64">Python (x86_64) - 200MB</option>
                <option value="python-riscv" data-url="https://ktock.github.io/container2wasm-demo/containers/riscv64-python-wasi-container" data-arch="riscv64">Python (RISC-V) - 136MB</option>
                <option value="vim" data-url="https://ktock.github.io/container2wasm-demo/containers/amd64-vim-wasi-container" data-arch="x86_64">Vim Editor (x86_64) - 140MB</option>
                <option value="vim-riscv" data-url="https://ktock.github.io/container2wasm-demo/containers/riscv64-vim-wasi-container" data-arch="riscv64">Vim Editor (RISC-V) - 95MB</option>
            </select>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="loadBtn" disabled>Load Container</button>
            <button class="btn btn-secondary" id="startBtn" disabled>Start Container</button>
            <button class="btn btn-secondary" id="resetBtn">Reset Terminal</button>
        </div>

        <div id="statusDiv" class="status loading" style="display: none;">
            <div class="loading-spinner" id="spinner" style="display: none;"></div>
            <span id="statusText">Ready to load container</span>
        </div>

        <div class="terminal-container">
            <div id="terminal"></div>
        </div>

        <div class="logs" id="logs" style="display: none;">
            <strong>Console Logs:</strong><br>
        </div>

        <div class="features">
            <div class="feature">
                <h3>Real Container Execution</h3>
                <p>Runs actual Linux containers converted to WebAssembly using container2wasm technology.</p>
            </div>
            <div class="feature">
                <h3>Multiple Architectures</h3>
                <p>Supports both x86_64 and RISC-V container images with CPU emulation in WebAssembly.</p>
            </div>
            <div class="feature">
                <h3>Full Terminal Access</h3>
                <p>Complete shell access with xterm.js terminal emulation for real Linux interaction.</p>
            </div>
            <div class="feature">
                <h3>Browser Native</h3>
                <p>No server required - everything runs locally in your browser using WASI polyfills.</p>
            </div>
        </div>
    </div>

    <!-- Load required libraries -->
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script type="module">
        // Import browser_wasi_shim as ES module
        import { WASI, File, OpenFile, ConsoleStdout, PreopenDirectory } from 'https://unpkg.com/@bjorn3/browser_wasi_shim@0.3.0/dist/index.js';
        
        // Make WASI available globally for the main script
        window.WASI = { WASI, File, OpenFile, ConsoleStdout, PreopenDirectory };
        
        // Trigger initialization after WASI is loaded
        window.dispatchEvent(new CustomEvent('wasiLoaded'));
    </script>
    
    <script>
        // Import CSS for xterm
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/xterm@5.3.0/css/xterm.css';
        document.head.appendChild(link);

        class Container2WasmRunner {
            constructor() {
                this.terminal = null;
                this.wasi = null;
                this.wasmInstance = null;
                this.isLoaded = false;
                this.isRunning = false;
                
                this.initializeTerminal();
                this.setupEventListeners();
                this.setupCrossOriginIsolation();
            }

            log(message) {
                console.log(`[Container2WASM] ${message}`);
                const logs = document.getElementById('logs');
                logs.style.display = 'block';
                logs.innerHTML += `${new Date().toISOString()}: ${message}\n`;
                logs.scrollTop = logs.scrollHeight;
            }

            updateStatus(message, type = 'loading', showSpinner = false) {
                const statusDiv = document.getElementById('statusDiv');
                const statusText = document.getElementById('statusText');
                const spinner = document.getElementById('spinner');
                
                statusDiv.style.display = 'block';
                statusDiv.className = `status ${type}`;
                statusText.textContent = message;
                spinner.style.display = showSpinner ? 'block' : 'none';
                
                this.log(message);
            }

            async setupCrossOriginIsolation() {
                // Check if we have the required isolation for SharedArrayBuffer
                if (typeof SharedArrayBuffer === 'undefined') {
                    this.updateStatus('Cross-Origin Isolation required for SharedArrayBuffer. Loading COI polyfill...', 'loading', true);
                    
                    try {
                        // Load COI service worker for cross-origin isolation
                        await this.loadCOIServiceWorker();
                    } catch (error) {
                        this.updateStatus('Failed to setup Cross-Origin Isolation. Some features may not work.', 'error');
                        this.log(`COI Error: ${error.message}`);
                    }
                } else {
                    this.updateStatus('Cross-Origin Isolation already enabled', 'ready');
                }
            }

            async loadCOIServiceWorker() {
                // Inline COI service worker
                const coiWorkerCode = `
                self.addEventListener("install", () => self.skipWaiting());
                self.addEventListener("activate", event => event.waitUntil(self.clients.claim()));
                self.addEventListener("fetch", event => {
                    if (event.request.cache === "only-if-cached" && event.request.mode !== "same-origin") {
                        return;
                    }
                    event.respondWith(
                        fetch(event.request).then(response => {
                            const newHeaders = new Headers(response.headers);
                            newHeaders.set("Cross-Origin-Embedder-Policy", "require-corp");
                            newHeaders.set("Cross-Origin-Opener-Policy", "same-origin");
                            return new Response(response.body, {
                                status: response.status,
                                statusText: response.statusText,
                                headers: newHeaders
                            });
                        }).catch(error => {
                            console.error('Service worker fetch error:', error);
                            return new Response('Service worker error', { status: 500 });
                        })
                    );
                });
                `;

                const blob = new Blob([coiWorkerCode], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);

                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register(workerUrl);
                    await navigator.serviceWorker.ready;
                    
                    // Reload page if service worker is newly installed
                    if (registration.installing) {
                        window.location.reload();
                    }
                }
            }

            initializeTerminal() {
                this.terminal = new Terminal({
                    rows: 24,
                    cols: 80,
                    cursorBlink: true,
                    convertEol: true,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    fontSize: 14,
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#d4d4d4',
                        cursor: '#d4d4d4',
                        selection: '#264f78',
                        black: '#000000',
                        red: '#cd3131',
                        green: '#0dbc79',
                        yellow: '#e5e510',
                        blue: '#2472c8',
                        magenta: '#bc3fbc',
                        cyan: '#11a8cd',
                        white: '#e5e5e5',
                        brightBlack: '#666666',
                        brightRed: '#f14c4c',
                        brightGreen: '#23d18b',
                        brightYellow: '#f5f543',
                        brightBlue: '#3b8eea',
                        brightMagenta: '#d670d6',
                        brightCyan: '#29b8db',
                        brightWhite: '#e5e5e5'
                    }
                });

                // Add fit addon for responsive terminal
                if (window.FitAddon) {
                    this.fitAddon = new window.FitAddon.FitAddon();
                    this.terminal.loadAddon(this.fitAddon);
                }

                this.terminal.open(document.getElementById('terminal'));
                
                // Fit terminal to container
                if (this.fitAddon) {
                    this.fitAddon.fit();
                    window.addEventListener('resize', () => this.fitAddon.fit());
                }
                
                this.terminal.writeln('\x1b[1;34mContainer2WASM Browser Runner\x1b[0m');
                this.terminal.writeln('\x1b[2mRun real Linux containers using WebAssembly and WASI\x1b[0m');
                this.terminal.writeln('');
                this.terminal.writeln('\x1b[1;33m1.\x1b[0m Select a container from the dropdown above');
                this.terminal.writeln('\x1b[1;33m2.\x1b[0m Click "Load Container" to download and compile');
                this.terminal.writeln('\x1b[1;33m3.\x1b[0m Click "Start Container" to run the Linux environment');
                this.terminal.writeln('');
            }

            setupEventListeners() {
                const containerSelect = document.getElementById('containerSelect');
                const loadBtn = document.getElementById('loadBtn');
                const startBtn = document.getElementById('startBtn');
                const resetBtn = document.getElementById('resetBtn');

                containerSelect.addEventListener('change', () => {
                    const isSelected = containerSelect.value !== '';
                    loadBtn.disabled = !isSelected;
                    
                    if (isSelected) {
                        const option = containerSelect.selectedOptions[0];
                        const arch = option.dataset.arch;
                        this.updateStatus(`Ready to load ${containerSelect.value} (${arch})`, 'ready');
                    }
                });

                loadBtn.addEventListener('click', () => this.loadContainer());
                startBtn.addEventListener('click', () => this.startContainer());
                resetBtn.addEventListener('click', () => this.resetTerminal());
            }

            resetTerminal() {
                this.terminal.clear();
                this.terminal.writeln('Terminal Reset');
                this.terminal.writeln('');
            }

            async loadContainer() {
                const containerSelect = document.getElementById('containerSelect');
                const selectedOption = containerSelect.selectedOptions[0];
                
                if (!selectedOption) {
                    this.updateStatus('Please select a container first', 'error');
                    return;
                }

                const containerUrl = selectedOption.dataset.url;
                const containerName = selectedOption.value;
                const arch = selectedOption.dataset.arch;

                this.updateStatus(`Loading ${containerName} container (${arch})...`, 'loading', true);
                this.terminal.writeln(`Loading ${containerName} container from container2wasm...`);

                try {
                    // Load the WASM container
                    const response = await fetch(containerUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch container: ${response.status} ${response.statusText}`);
                    }

                    const wasmBytes = await response.arrayBuffer();
                    this.terminal.writeln(`Downloaded ${(wasmBytes.byteLength / 1024 / 1024).toFixed(1)}MB WASM container`);

                    // Setup WASI environment
                    this.setupWASI();

                    // Compile WebAssembly module
                    this.updateStatus('Compiling WebAssembly module...', 'loading', true);
                    const wasmModule = await WebAssembly.compile(wasmBytes);
                    
                    // Create WASM instance with WASI imports
                    this.wasmInstance = await WebAssembly.instantiate(wasmModule, {
                        wasi_snapshot_preview1: this.wasi.wasiImport,
                    });

                    this.isLoaded = true;
                    this.updateStatus(`Container ${containerName} loaded successfully!`, 'ready');
                    this.terminal.writeln('Container loaded and ready to start!');
                    
                    document.getElementById('startBtn').disabled = false;

                } catch (error) {
                    this.updateStatus(`Failed to load container: ${error.message}`, 'error');
                    this.terminal.writeln(`Error: ${error.message}`);
                    this.log(`Load error: ${error.stack}`);
                }
            }

            setupWASI() {
                // Create custom stdout/stderr that writes to terminal
                class TerminalStdout {
                    constructor(terminal) {
                        this.terminal = terminal;
                    }
                    
                    write(buffer) {
                        const text = new TextDecoder().decode(buffer);
                        this.terminal.write(text);
                        return buffer.length;
                    }
                }

                // Create custom stdin that reads from terminal
                class TerminalStdin {
                    constructor() {
                        this.buffer = new Uint8Array(0);
                        this.pos = 0;
                    }
                    
                    read(buffer) {
                        const available = Math.min(buffer.length, this.buffer.length - this.pos);
                        buffer.set(this.buffer.slice(this.pos, this.pos + available));
                        this.pos += available;
                        return available;
                    }
                    
                    addInput(text) {
                        const encoder = new TextEncoder();
                        const newData = encoder.encode(text);
                        const newBuffer = new Uint8Array(this.buffer.length + newData.length);
                        newBuffer.set(this.buffer);
                        newBuffer.set(newData, this.buffer.length);
                        this.buffer = newBuffer;
                    }
                }

                this.terminalStdin = new TerminalStdin();
                
                // Create file descriptors
                const fds = [
                    new WASI.OpenFile(new WASI.File([])), // stdin - basic implementation
                    new TerminalStdout(this.terminal), // stdout to terminal
                    new TerminalStdout(this.terminal), // stderr to terminal
                ];

                // Create virtual file system with common Linux directories
                const rootDir = new Map();
                const tmpDir = new Map();
                const homeDir = new Map();
                const usrDir = new Map();
                const binDir = new Map();
                const etcDir = new Map();
                const varDir = new Map();

                // Add some basic files for Linux compatibility
                rootDir.set("tmp", tmpDir);
                rootDir.set("home", homeDir);
                rootDir.set("usr", usrDir);
                rootDir.set("bin", binDir);
                rootDir.set("etc", etcDir);
                rootDir.set("var", varDir);

                // Add preopen directories
                fds.push(new WASI.PreopenDirectory("/", rootDir));
                fds.push(new WASI.PreopenDirectory("/tmp", tmpDir));
                fds.push(new WASI.PreopenDirectory("/home", homeDir));

                // Setup comprehensive environment variables for Linux container
                const env = {
                    'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin',
                    'HOME': '/root',
                    'USER': 'root',
                    'LOGNAME': 'root',
                    'SHELL': '/bin/bash',
                    'TERM': 'xterm-256color',
                    'LANG': 'C.UTF-8',
                    'LC_ALL': 'C.UTF-8',
                    'PWD': '/',
                    'HOSTNAME': 'container2wasm',
                    'TMPDIR': '/tmp',
                    'TZ': 'UTC'
                };

                // Container2wasm typically expects no arguments initially
                const args = [];

                // Create WASI instance
                this.wasi = new WASI.WASI(args, env, fds);
                
                this.terminal.writeln('\x1b[32m✓\x1b[0m WASI environment configured with Linux compatibility');
                this.terminal.writeln('\x1b[2m  - Virtual file system created');
                this.terminal.writeln('\x1b[2m  - Environment variables set');
                this.terminal.writeln('\x1b[2m  - Terminal I/O configured\x1b[0m');
            }

            async startContainer() {
                if (!this.isLoaded || !this.wasmInstance) {
                    this.updateStatus('No container loaded', 'error');
                    return;
                }

                if (this.isRunning) {
                    this.updateStatus('Container is already running', 'error');
                    return;
                }

                this.updateStatus('Starting container...', 'loading', true);
                this.terminal.writeln('\x1b[33m⚡\x1b[0m Starting Linux container in WebAssembly...');

                try {
                    this.isRunning = true;
                    
                    // Setup terminal interaction before starting
                    this.setupTerminalInput();
                    
                    this.terminal.writeln('\x1b[2mInitializing WASI runtime...\x1b[0m');
                    
                    // For container2wasm, we need to handle the startup differently
                    // The container expects to be started as a WASI command
                    if (this.wasmInstance.exports._start) {
                        // Use _start export for WASI command
                        this.terminal.writeln('\x1b[2mStarting via WASI _start...\x1b[0m');
                        this.wasi.start(this.wasmInstance);
                    } else if (this.wasmInstance.exports._initialize) {
                        // Some WASM modules use _initialize
                        this.terminal.writeln('\x1b[2mInitializing WASI module...\x1b[0m');
                        this.wasmInstance.exports._initialize();
                    } else {
                        // Fallback to manual initialization
                        this.terminal.writeln('\x1b[2mFallback initialization...\x1b[0m');
                        // Look for main or other entry points
                        const exports = Object.keys(this.wasmInstance.exports);
                        this.terminal.writeln(`\x1b[2mAvailable exports: ${exports.join(', ')}\x1b[0m`);
                    }
                    
                    this.updateStatus('Container is running!', 'ready');
                    this.terminal.writeln('');
                    this.terminal.writeln('\x1b[32m✓ Linux container started successfully!\x1b[0m');
                    this.terminal.writeln('\x1b[2mContainer is running in WebAssembly with WASI runtime\x1b[0m');
                    this.terminal.writeln('\x1b[2mNote: This is experimental - not all features may work\x1b[0m');
                    this.terminal.writeln('');
                    
                    // Show a simple prompt - container2wasm handles the actual shell
                    this.terminal.write('\x1b[1;32mcontainer2wasm\x1b[0m:\x1b[1;34m~\x1b[0m$ ');

                } catch (error) {
                    this.isRunning = false;
                    this.updateStatus(`Container startup failed: ${error.message}`, 'error');
                    this.terminal.writeln('');
                    this.terminal.writeln(`\x1b[31m✗ Error starting container:\x1b[0m`);
                    this.terminal.writeln(`\x1b[31m${error.message}\x1b[0m`);
                    this.terminal.writeln('');
                    this.terminal.writeln('\x1b[33mDebugging info:\x1b[0m');
                    this.terminal.writeln(`\x1b[2mError name: ${error.name}\x1b[0m`);
                    this.terminal.writeln(`\x1b[2mError stack: ${error.stack}\x1b[0m`);
                    
                    if (this.wasmInstance && this.wasmInstance.exports) {
                        const exports = Object.keys(this.wasmInstance.exports);
                        this.terminal.writeln(`\x1b[2mWASM exports: ${exports.join(', ')}\x1b[0m`);
                    }
                    
                    this.log(`Start error: ${error.stack}`);
                }
            }

            setupTerminalInput() {
                let currentLine = '';
                
                // Setup advanced terminal interaction
                this.terminal.onData(data => {
                    // Handle different control characters
                    switch (data) {
                        case '\r': // Enter
                        case '\n':
                            this.terminal.write('\r\n');
                            this.processCommand(currentLine);
                            currentLine = '';
                            this.terminal.write('\x1b[1;32mcontainer2wasm\x1b[0m:\x1b[1;34m~\x1b[0m$ ');
                            break;
                            
                        case '\u007f': // Backspace
                            if (currentLine.length > 0) {
                                currentLine = currentLine.slice(0, -1);
                                this.terminal.write('\b \b');
                            }
                            break;
                            
                        case '\u0003': // Ctrl+C
                            this.terminal.write('^C');
                            this.terminal.write('\r\n');
                            currentLine = '';
                            this.terminal.write('\x1b[1;32mcontainer2wasm\x1b[0m:\x1b[1;34m~\x1b[0m$ ');
                            break;
                            
                        case '\u0004': // Ctrl+D (EOF)
                            this.terminal.write('\r\n\x1b[2mlogout\x1b[0m\r\n');
                            break;
                            
                        default:
                            // Regular character input
                            if (data >= ' ' || data === '\t') {
                                currentLine += data;
                                this.terminal.write(data);
                            }
                            break;
                    }
                    
                    // Send input to WASI stdin if available
                    if (this.terminalStdin) {
                        this.terminalStdin.addInput(data);
                    }
                });
            }
            
            processCommand(command) {
                const cmd = command.trim().toLowerCase();
                
                if (!cmd) return;
                
                // Handle basic built-in commands for demonstration
                switch (cmd) {
                    case 'help':
                        this.terminal.writeln('\x1b[33mContainer2WASM Help:\x1b[0m');
                        this.terminal.writeln('  help     - Show this help');
                        this.terminal.writeln('  status   - Show container status');
                        this.terminal.writeln('  env      - Show environment variables');
                        this.terminal.writeln('  clear    - Clear terminal');
                        this.terminal.writeln('');
                        this.terminal.writeln('\x1b[2mNote: Full Linux commands depend on the container image\x1b[0m');
                        break;
                        
                    case 'status':
                        this.terminal.writeln('\x1b[32mContainer Status:\x1b[0m');
                        this.terminal.writeln(`  Running: ${this.isRunning ? 'Yes' : 'No'}`);
                        this.terminal.writeln(`  Loaded: ${this.isLoaded ? 'Yes' : 'No'}`);
                        this.terminal.writeln(`  WASI: ${this.wasi ? 'Initialized' : 'Not initialized'}`);
                        break;
                        
                    case 'env':
                        this.terminal.writeln('\x1b[32mEnvironment Variables:\x1b[0m');
                        if (this.wasi) {
                            const env = this.wasi.env || {};
                            Object.keys(env).forEach(key => {
                                this.terminal.writeln(`  ${key}=${env[key]}`);
                            });
                        }
                        break;
                        
                    case 'clear':
                        this.terminal.clear();
                        break;
                        
                    default:
                        // For other commands, show that we received them but can't execute
                        this.terminal.writeln(`\x1b[2mCommand received: ${command}\x1b[0m`);
                        this.terminal.writeln('\x1b[33mNote: Full command execution requires container runtime integration\x1b[0m');
                        break;
                }
            }
        }

        // Initialize when both DOM and WASI are ready
        let domReady = false;
        let wasiReady = false;
        
        function tryInitialize() {
            if (domReady && wasiReady) {
                try {
                    new Container2WasmRunner();
                } catch (error) {
                    console.error('Failed to initialize Container2WASM:', error);
                    document.getElementById('statusDiv').innerHTML = `
                        <div class="status error">
                            Failed to initialize: ${error.message}
                        </div>
                    `;
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            domReady = true;
            tryInitialize();
        });
        
        window.addEventListener('wasiLoaded', () => {
            wasiReady = true;
            tryInitialize();
        });

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>