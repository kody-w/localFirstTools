<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROJECT: OMEGA-LINK</title>
<style>
    :root {
        --bg: #020204;
        --glass: rgba(10, 15, 25, 0.95);
        --border: 1px solid rgba(0, 240, 255, 0.2);
        --neon-c: #00f3ff; /* Cyan - Arc/Tech */
        --neon-m: #ff0055; /* Magenta - Solar/Threat */
        --neon-y: #ffd700; /* Yellow - Legendary */
        --neon-g: #00ff66; /* Green - Bio/Heal */
        --neon-p: #bc13fe; /* Purple - Void */
        --font: 'Consolas', 'Monaco', monospace;
    }

    /* --- GLOBAL FX --- */
    body { background: var(--bg); color: var(--neon-c); font-family: var(--font); margin: 0; overflow: hidden; height: 100vh; user-select: none; }
    
    .scanline { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; z-index: 999; opacity: 0.3; }
    
    ::-webkit-scrollbar { width: 6px; background: #000; }
    ::-webkit-scrollbar-thumb { background: var(--neon-c); }

    /* --- LAYOUT --- */
    #app-grid {
        display: grid;
        grid-template-columns: 250px 1fr 300px;
        grid-template-rows: 60px 1fr 200px;
        height: 100vh;
        width: 100vw;
    }

    /* --- HEADER --- */
    header { grid-column: 1 / -1; background: #000; border-bottom: var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
    .res-bank { display: flex; gap: 20px; font-size: 12px; }
    .res-val { color: #fff; font-weight: bold; }

    /* --- SIDEBAR (BASE/CIV) --- */
    #sidebar { grid-row: 2 / -1; background: var(--glass); border-right: var(--border); padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    .module-card { border: var(--border); padding: 10px; background: rgba(0,0,0,0.5); font-size: 12px; cursor: pointer; transition: 0.2s; }
    .module-card:hover { border-color: var(--neon-y); background: rgba(255, 215, 0, 0.1); }
    .module-lvl { float: right; color: var(--neon-y); }

    /* --- MAIN VIEWPORT --- */
    #viewport { grid-column: 2; grid-row: 2; position: relative; overflow: hidden; background: radial-gradient(circle at center, #111 0%, #000 100%); }
    
    /* View: Starmap */
    #starmap { width: 100%; height: 100%; }
    
    /* View: Bio-Lab (Roster) */
    #bio-lab { display: none; padding: 20px; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; overflow-y: auto; height: 100%; }
    .pet-card { border: var(--border); padding: 10px; text-align: center; position: relative; background: #050505; cursor: pointer; }
    .pet-card.active { border-color: var(--neon-p); box-shadow: 0 0 15px var(--neon-p); }
    .rarity-S { border-color: var(--neon-y); color: var(--neon-y); }

    /* --- INSPECTOR (RPG/GEAR) --- */
    #inspector { grid-column: 3; grid-row: 2; background: var(--glass); border-left: var(--border); padding: 10px; overflow-y: auto; }
    .gear-slot { border: 1px dashed #444; padding: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 11px; cursor: pointer; }
    .gear-slot:hover { border-color: var(--neon-c); }
    .stat-row { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 2px; }
    .stat-val { color: #fff; }

    /* --- LOG / FOOTER --- */
    #console { grid-column: 2 / 4; grid-row: 3; background: #000; border-top: var(--border); font-family: 'Courier New'; font-size: 12px; padding: 10px; overflow-y: auto; color: #888; }
    .log-crit { color: var(--neon-m); }
    .log-loot { color: var(--neon-y); }
    .log-sys { color: var(--neon-c); }

    /* --- COMBAT OVERLAY --- */
    #combat-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; }
    #field { flex: 1; position: relative; perspective: 800px; }
    .unit { position: absolute; width: 120px; text-align: center; transition: all 0.5s; }
    .unit-visual { font-size: 60px; filter: drop-shadow(0 0 10px currentColor); animation: float 3s infinite ease-in-out; }
    .hp-bar { height: 6px; background: #333; margin-top: 5px; border: 1px solid #555; }
    .hp-fill { height: 100%; background: var(--neon-g); width: 100%; transition: width 0.2s; }
    
    #c-hud { height: 120px; border-top: 2px solid var(--neon-m); background: #111; display: flex; padding: 10px; gap: 10px; }
    .btn { background: #222; border: 1px solid var(--neon-c); color: var(--neon-c); flex: 1; cursor: pointer; font-family: inherit; transition: 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .btn:hover { background: var(--neon-c); color: #000; }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    .cd-overlay { font-size: 10px; color: red; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

</style>
</head>
<body>

<div class="scanline"></div>

<div id="app-grid">
    <header>
        <div>PROJECT: <span style="color:var(--neon-y)">OMEGA-LINK</span> // VER 1.0</div>
        <div class="res-bank">
            <div>‚ö° ENERGY: <span id="res-energy" class="res-val">0</span></div>
            <div>üß± ALLOYS: <span id="res-alloy" class="res-val">0</span></div>
            <div>üß¨ GENOME: <span id="res-bio" class="res-val">0</span></div>
            <div>ü™ô CREDITS: <span id="res-cred" class="res-val">0</span></div>
        </div>
        <div style="font-size:11px; cursor:pointer;" onclick="game.save()">[SAVE SYSTEM]</div>
    </header>

    <div id="sidebar">
        <div style="text-align:center; border-bottom:1px solid #333; padding-bottom:5px;">GARRISON MODULES</div>
        <div class="module-card" onclick="base.upgrade('reactor')">
            <div>ARC REACTOR <span class="module-lvl" id="lvl-reactor">Lv 1</span></div>
            <div style="color:#666">+1 Energy/tick</div>
            <div style="color:var(--neon-y)">Cost: <span id="cost-reactor">50</span> Alloy</div>
        </div>
        <div class="module-card" onclick="base.upgrade('mine')">
            <div>VOID DRILL <span class="module-lvl" id="lvl-mine">Lv 1</span></div>
            <div style="color:#666">+1 Alloy/tick</div>
            <div style="color:var(--neon-y)">Cost: <span id="cost-mine">50</span> Energy</div>
        </div>
        <div class="module-card" onclick="base.upgrade('lab')">
            <div>GENE VAT <span class="module-lvl" id="lvl-lab">Lv 0</span></div>
            <div style="color:#666">Unlocks Breeding</div>
            <div style="color:var(--neon-y)">Cost: <span id="cost-lab">200</span> Alloy</div>
        </div>
        <div style="margin-top:auto">
            <button class="btn" style="height:40px" onclick="ui.view('starmap')">NAV: STARMAP</button>
            <button class="btn" style="height:40px; margin-top:5px;" onclick="ui.view('lab')">BIO: ROSTER</button>
        </div>
    </div>

    <div id="viewport">
        <canvas id="starmap"></canvas>
        <div id="bio-lab"></div>
        
        <div id="combat-overlay">
            <div id="field">
                <div id="enemy-anchor" class="unit" style="top:20%; right:20%; color:var(--neon-m)">
                    <div id="e-vis" class="unit-visual">‚ò†Ô∏è</div>
                    <div class="hp-bar"><div id="e-hp" class="hp-fill"></div></div>
                    <div id="e-name">BOSS</div>
                </div>
                <div id="pet-anchor" class="unit" style="bottom:20%; left:30%; color:var(--neon-p)">
                    <div id="p-vis" class="unit-visual">üêâ</div>
                    <div class="hp-bar"><div id="p-hp" class="hp-fill"></div></div>
                    <div id="p-name">PET</div>
                </div>
                <div id="player-anchor" class="unit" style="bottom:10%; left:10%; color:var(--neon-c); transform:scale(0.8)">
                    <div class="unit-visual">üöÅ</div>
                    <div class="hp-bar"><div id="pl-hp" class="hp-fill"></div></div>
                    <div>CMDR</div>
                </div>
            </div>
            
            <div id="c-hud">
                <div style="width:200px; font-size:11px; color:#666; border-right:1px solid #333;">
                    TARGET INFO:<br>
                    <span id="target-type" style="color:#fff">SOLAR</span><br>
                    THREAT: <span id="threat-meter" style="color:var(--neon-m)">LOW</span>
                </div>
                <button class="btn" id="btn-s1" onclick="combat.useSkill(0)">LASER<br><span style="font-size:9px">DMG</span></button>
                <button class="btn" id="btn-s2" onclick="combat.useSkill(1)">REPAIR<br><span style="font-size:9px">HEAL</span></button>
                <button class="btn" id="btn-s3" onclick="combat.useSkill(2)">SHIELD<br><span style="font-size:9px">BUFF</span></button>
                <button class="btn" style="border-color:var(--neon-p); color:var(--neon-p)" onclick="combat.petUlt()">ULTIMATE<br><span id="ult-charge">0%</span></button>
                <button class="btn" id="btn-catch" style="border-color:var(--neon-y); color:var(--neon-y)" onclick="combat.attemptCapture()">CAPTURE<br><span id="catch-chance">0%</span></button>
            </div>
        </div>
    </div>

    <div id="inspector">
        <div style="text-align:center; border-bottom:1px solid #333; margin-bottom:10px;">COMMANDER GEAR</div>
        
        <div class="stat-row"><span>GEAR SCORE</span><span id="stat-gs" class="stat-val">0</span></div>
        <div class="stat-row"><span>HEAL PWR</span><span id="stat-int" class="stat-val">0</span></div>
        <div class="stat-row"><span>GUN DMG</span><span id="stat-str" class="stat-val">0</span></div>
        <div class="stat-row"><span>HASTE</span><span id="stat-haste" class="stat-val">0%</span></div>

        <hr style="border:0; border-bottom:1px solid #333">

        <div id="gear-list">
            <div class="gear-slot" onclick="gear.craft('weapon')">
                <div>WEAPON</div>
                <div id="slot-weapon" style="color:#666">Standard Laser</div>
            </div>
            <div class="gear-slot" onclick="gear.craft('chest')">
                <div>CHASSIS</div>
                <div id="slot-chest" style="color:#666">Civilian Plating</div>
            </div>
            <div class="gear-slot" onclick="gear.craft('chip')">
                <div>AI CHIP</div>
                <div id="slot-chip" style="color:#666">Basic CPU</div>
            </div>
        </div>
        <div style="font-size:10px; color:#555; text-align:center; margin-top:10px;">
            Click slots to CRAFT UPGRADES<br>(Cost: 100 Alloys + 50 Credits)
        </div>
    </div>

    <div id="console">
        <div>> SYSTEM INITIALIZED...</div>
        <div>> WAITING FOR INPUT...</div>
    </div>
</div>

<script>
/**
 * PROJECT OMEGA-LINK
 * A unified engine merging Idle Civ, RPG Progression, and Creature Collection.
 */

// --- CONFIG & CONSTANTS ---
const TYPES = {
    SOLAR: { weak: 'ARC', strong: 'BIO', color: '#ff0055' },
    ARC:   { weak: 'VOID', strong: 'SOLAR', color: '#00f3ff' },
    VOID:  { weak: 'BIO', strong: 'ARC', color: '#bc13fe' },
    BIO:   { weak: 'SOLAR', strong: 'VOID', color: '#00ff66' }
};

const ICONS = ['ü¶Ç','ü¶Ö','ü¶à','ü¶ñ','üêô','üï∑Ô∏è','üê∫','üêâ'];

const STATE = {
    res: { energy: 100, alloy: 100, bio: 50, cred: 0 },
    base: { reactor: 1, mine: 1, lab: 0 },
    player: {
        hp: 1000, maxHp: 1000,
        gear: { weapon: 1, chest: 1, chip: 1 },
        stats: { str: 50, int: 50, haste: 0 }
    },
    roster: [], // Monsters
    activePetId: null,
    location: null,
    inventory: []
};

// --- LOGGING ---
const logger = {
    log: (msg, type='') => {
        const el = document.getElementById('console');
        const line = document.createElement('div');
        line.innerHTML = `> ${msg}`;
        if(type) line.className = `log-${type}`;
        el.prepend(line);
        if(el.children.length > 50) el.lastChild.remove();
    }
};

// --- ENGINE 1: BASE & ECONOMY (Civ) ---
const base = {
    tick: () => {
        // Passive Generation
        STATE.res.energy += STATE.base.reactor * 1;
        STATE.res.alloy += STATE.base.mine * 0.5;
        
        // Update UI
        document.getElementById('res-energy').innerText = Math.floor(STATE.res.energy);
        document.getElementById('res-alloy').innerText = Math.floor(STATE.res.alloy);
        document.getElementById('res-bio').innerText = Math.floor(STATE.res.bio);
        document.getElementById('res-cred').innerText = Math.floor(STATE.res.cred);
    },

    upgrade: (module) => {
        const costs = {
            reactor: { res: 'alloy', amount: STATE.base.reactor * 50 },
            mine:    { res: 'energy', amount: STATE.base.mine * 50 },
            lab:     { res: 'alloy', amount: 200 }
        };

        const cost = costs[module];
        if(STATE.res[cost.res] >= cost.amount) {
            STATE.res[cost.res] -= cost.amount;
            STATE.base[module]++;
            ui.updateBase();
            logger.log(`Constructed ${module.toUpperCase()} Level ${STATE.base[module]}`, 'sys');
        } else {
            logger.log(`Insufficient Resources for ${module}`, 'crit');
        }
    }
};

// --- ENGINE 2: RPG & GEAR (WoW) ---
const gear = {
    updateStats: () => {
        // Calculate Stats based on Gear Level
        const g = STATE.player.gear;
        STATE.player.stats.str = 50 + (g.weapon * 15);
        STATE.player.stats.int = 50 + (g.chip * 15); // Int = Heal Power
        STATE.player.stats.haste = Math.min(50, (g.chip * 2)); // CD Reduction
        STATE.player.maxHp = 1000 + (g.chest * 200);
        
        // Render
        document.getElementById('stat-str').innerText = STATE.player.stats.str;
        document.getElementById('stat-int').innerText = STATE.player.stats.int;
        document.getElementById('stat-gs').innerText = g.weapon + g.chest + g.chip;
        document.getElementById('stat-haste').innerText = STATE.player.stats.haste + "%";
        
        // Names
        document.getElementById('slot-weapon').innerText = `Plasma Emitter Mk ${g.weapon}`;
        document.getElementById('slot-chest').innerText = `Titanium Plate Mk ${g.chest}`;
    },

    craft: (slot) => {
        if(STATE.res.alloy >= 100 && STATE.res.cred >= 50) {
            STATE.res.alloy -= 100;
            STATE.res.cred -= 50;
            STATE.player.gear[slot]++;
            gear.updateStats();
            logger.log(`Upgraded ${slot} to Mk ${STATE.player.gear[slot]}`, 'loot');
        } else {
            logger.log("Crafting requires 100 Alloy + 50 Credits", 'crit');
        }
    }
};

// --- ENGINE 3: BIOLOGY (Pokemon) ---
const bio = {
    create: (lvl, type=null) => {
        const t = type || Object.keys(TYPES)[Math.floor(Math.random()*4)];
        const baseHp = lvl * 200;
        return {
            id: Date.now() + Math.random(),
            name: `${t} Subject-${Math.floor(Math.random()*999)}`,
            icon: ICONS[Math.floor(Math.random()*ICONS.length)],
            type: t,
            lvl: lvl,
            maxHp: baseHp, hp: baseHp,
            atk: lvl * 20,
            iv: Math.random() // Genetic quality 0.0 - 1.0
        };
    },

    add: (mon) => {
        STATE.roster.push(mon);
        if(!STATE.activePetId) STATE.activePetId = mon.id;
        ui.renderRoster();
    }
};

// --- ENGINE 4: NAVIGATION (Starmap) ---
const map = {
    canvas: document.getElementById('starmap'),
    ctx: document.getElementById('starmap').getContext('2d'),
    stars: [],

    init: () => {
        map.canvas.width = document.getElementById('viewport').clientWidth;
        map.canvas.height = document.getElementById('viewport').clientHeight;
        
        // Generate Systems
        for(let i=0; i<40; i++) {
            map.stars.push({
                x: Math.random() * map.canvas.width,
                y: Math.random() * map.canvas.height,
                lvl: Math.floor(Math.random() * 10) + 1,
                color: Math.random() > 0.9 ? '#ffd700' : '#fff'
            });
        }
        
        // Click Listener
        map.canvas.addEventListener('click', (e) => {
            const rect = map.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            map.stars.forEach(s => {
                const dist = Math.sqrt((x-s.x)**2 + (y-s.y)**2);
                if(dist < 15) map.travel(s);
            });
        });

        map.render();
    },

    travel: (star) => {
        if(STATE.res.energy < 10) { logger.log("Warp Drive Offline: Need 10 Energy", 'crit'); return; }
        STATE.res.energy -= 10;
        logger.log(`Warping to Sector (Threat Lv ${star.lvl})...`, 'sys');
        combat.start(star.lvl);
    },

    render: () => {
        const ctx = map.ctx;
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,map.canvas.width, map.canvas.height);
        
        map.stars.forEach(s => {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.lvl/2 + 2, 0, Math.PI*2);
            ctx.fillStyle = s.color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = s.color;
            ctx.fill();
        });
    }
};

// --- ENGINE 5: COMBAT (WoWmon Trinity) ---
const combat = {
    active: false,
    timer: null,
    playerCDs: [0, 0, 0],
    ultCharge: 0,
    enemy: null,
    pet: null,

    start: (lvl) => {
        if(STATE.roster.length === 0) { logger.log("No Biology Constructs deployed!", 'crit'); return; }
        
        combat.active = true;
        document.getElementById('combat-overlay').style.display = 'flex';
        
        // Load Units
        combat.enemy = bio.create(lvl); // Create Boss
        combat.enemy.maxHp *= 3; // Boss multiplier
        combat.enemy.hp = combat.enemy.maxHp;
        
        const p = STATE.roster.find(m => m.id === STATE.activePetId);
        combat.pet = p;
        p.hp = p.maxHp; // Heal on enter (Simplicity)
        STATE.player.hp = STATE.player.maxHp;

        // UI Setup
        document.getElementById('e-vis').innerText = combat.enemy.icon;
        document.getElementById('e-name').innerText = `Lv${lvl} ${combat.enemy.type} BOSS`;
        document.getElementById('target-type').innerText = combat.enemy.type;
        document.getElementById('target-type').style.color = TYPES[combat.enemy.type].color;
        document.getElementById('p-vis').innerText = p.icon;
        
        logger.log("COMBAT INITIALIZED. HOLD THE LINE.", 'crit');
        combat.loop();
    },

    loop: () => {
        if(!combat.active) return;
        
        combat.timer = requestAnimationFrame(combat.loop);
        
        // Cooldowns
        combat.playerCDs = combat.playerCDs.map(cd => Math.max(0, cd - 1));
        
        // Logic (Every 60 frames approx)
        if(Math.random() < 0.02) combat.tick();
        
        combat.updateUI();
    },

    tick: () => {
        // 1. Enemy Attack
        const target = Math.random() > 0.7 ? 'player' : 'pet'; // 30% chance to hit player
        const dmg = combat.enemy.atk * (target === 'player' ? 0.5 : 1); // Player has armor
        
        if(target === 'pet') {
            combat.pet.hp -= dmg;
            logger.log(`Boss hits Pet for ${Math.floor(dmg)}`);
        } else {
            STATE.player.hp -= dmg;
            logger.log(`Boss hits COMMANDER for ${Math.floor(dmg)}`, 'crit');
        }

        // 2. Pet Auto-Attack
        let pDmg = combat.pet.atk;
        // Type Effectiveness
        const typeData = TYPES[combat.pet.type];
        if(typeData.strong === combat.enemy.type) { pDmg *= 1.5; }
        if(typeData.weak === combat.enemy.type) { pDmg *= 0.5; }
        
        combat.enemy.hp -= pDmg;
        combat.ultCharge = Math.min(100, combat.ultCharge + 2);

        // 3. Death Check
        if(combat.enemy.hp <= 0) combat.end(true);
        if(STATE.player.hp <= 0 || combat.pet.hp <= 0) combat.end(false);
    },

    useSkill: (idx) => {
        if(combat.playerCDs[idx] > 0) return;
        
        // Global Cooldown reduced by Haste
        const cdBase = 120 * (1 - STATE.player.stats.haste/100); 

        if(idx === 0) { // LASER (Dmg)
            const dmg = STATE.player.stats.str * 2;
            combat.enemy.hp -= dmg;
            logger.log(`Commander Laser: ${dmg} Dmg`, 'sys');
            combat.playerCDs[idx] = cdBase;
        }
        else if(idx === 1) { // REPAIR (Heal)
            const heal = STATE.player.stats.int * 3;
            combat.pet.hp = Math.min(combat.pet.maxHp, combat.pet.hp + heal);
            STATE.player.hp = Math.min(STATE.player.maxHp, STATE.player.hp + (heal/2)); // Self heal too
            logger.log(`Nanite Repair: +${heal} HP`, 'sys');
            combat.playerCDs[idx] = cdBase * 1.5;
        }
        else if(idx === 2) { // SHIELD
            logger.log("Shields Deployed (50% Dmg Reduction)", 'sys');
            // Implementation simplified for demo
            combat.playerCDs[idx] = 300;
        }
    },

    petUlt: () => {
        if(combat.ultCharge < 100) return;
        combat.ultCharge = 0;
        const dmg = combat.pet.atk * 5;
        combat.enemy.hp -= dmg;
        logger.log(`PET ULTIMATE: ${dmg} DAMAGE!`, 'crit');
        // Visual Shake
        document.getElementById('field').style.transform = `translate(${Math.random()*10}px, ${Math.random()*10}px)`;
        setTimeout(() => document.getElementById('field').style.transform = 'none', 200);
    },

    attemptCapture: () => {
        const hpPct = combat.enemy.hp / combat.enemy.maxHp;
        const chance = (1 - hpPct) * 100; // Lower HP = Higher Chance
        
        if(Math.random() * 100 < chance) {
            logger.log("CONTAINMENT SUCCESSFUL!", 'loot');
            bio.add({
                ...combat.enemy,
                id: Date.now(),
                hp: combat.enemy.maxHp
            });
            combat.end(true);
        } else {
            logger.log("Containment Failed! Boss Enraged!", 'crit');
            combat.enemy.atk *= 1.2;
        }
    },

    end: (win) => {
        combat.active = false;
        cancelAnimationFrame(combat.timer);
        document.getElementById('combat-overlay').style.display = 'none';
        
        if(win) {
            const reward = combat.enemy.lvl * 20;
            STATE.res.cred += reward;
            STATE.res.bio += reward/2;
            // Chance for Gear
            if(Math.random() > 0.7) {
                STATE.res.alloy += 50;
                logger.log("Salvaged 50 Alloys from wreckage", 'loot');
            }
            logger.log(`Victory! Gained ${reward} Credits.`, 'loot');
        } else {
            logger.log("DEFEAT. Emergency Warp executed.", 'crit');
        }
    },

    updateUI: () => {
        // Bars
        const setBar = (id, cur, max) => document.getElementById(id).style.width = Math.max(0, (cur/max)*100) + '%';
        setBar('e-hp', combat.enemy.hp, combat.enemy.maxHp);
        setBar('p-hp', combat.pet.hp, combat.pet.maxHp);
        setBar('pl-hp', STATE.player.hp, STATE.player.maxHp);
        
        // Text
        document.getElementById('ult-charge').innerText = Math.floor(combat.ultCharge) + "%";
        document.getElementById('catch-chance').innerText = Math.floor((1 - combat.enemy.hp/combat.enemy.maxHp)*100) + "%";
        
        // Buttons
        for(let i=0; i<3; i++) {
            const btn = document.getElementById(`btn-s${i+1}`);
            btn.disabled = combat.playerCDs[i] > 0;
            btn.style.opacity = btn.disabled ? 0.5 : 1;
        }
    }
};

// --- UI MANAGER ---
const ui = {
    view: (id) => {
        document.getElementById('starmap').classList.add('hidden');
        document.getElementById('bio-lab').classList.remove('hidden');
        document.getElementById('bio-lab').style.display = 'none'; // reset
        
        if(id === 'starmap') {
            document.getElementById('starmap').classList.remove('hidden');
            map.render();
        }
        if(id === 'lab') {
            document.getElementById('bio-lab').style.display = 'grid';
            ui.renderRoster();
        }
    },

    renderRoster: () => {
        const c = document.getElementById('bio-lab');
        c.innerHTML = '';
        STATE.roster.forEach(m => {
            const div = document.createElement('div');
            div.className = `pet-card ${m.id === STATE.activePetId ? 'active' : ''}`;
            if(m.iv > 0.9) div.classList.add('rarity-S');
            div.innerHTML = `
                <div style="font-size:30px">${m.icon}</div>
                <div style="font-weight:bold; font-size:12px; margin:5px 0;">${m.name}</div>
                <div style="font-size:10px; color:${TYPES[m.type].color}">${m.type}</div>
                <div style="font-size:10px; color:#666">HP: ${Math.floor(m.maxHp)} | IV: ${(m.iv*100).toFixed(0)}%</div>
            `;
            div.onclick = () => {
                STATE.activePetId = m.id;
                ui.renderRoster();
            };
            c.appendChild(div);
        });
    },

    updateBase: () => {
        ['reactor','mine','lab'].forEach(k => {
            document.getElementById(`lvl-${k}`).innerText = `Lv ${STATE.base[k]}`;
            // Simple cost scaling logic
            const costEl = document.getElementById(`cost-${k}`);
            if(costEl) costEl.innerText = STATE.base[k] * 50; 
        });
    }
};

// --- GAME LOOP ---
const game = {
    init: () => {
        // Initial Starter
        if(STATE.roster.length === 0) bio.add(bio.create(1, 'SOLAR'));
        
        map.init();
        ui.updateBase();
        gear.updateStats();
        
        // Economy Ticker
        setInterval(base.tick, 1000);
        
        logger.log("OMEGA-LINK OS LOADED.");
        logger.log("WARNING: Sector threat levels detected.", 'crit');
    },

    save: () => {
        localStorage.setItem('omega_save', JSON.stringify(STATE));
        logger.log("GAME SAVED.", 'sys');
    },
    
    load: () => {
        const d = localStorage.getItem('omega_save');
        if(d) {
            Object.assign(STATE, JSON.parse(d));
            logger.log("SAVE DATA LOADED.", 'sys');
            gear.updateStats();
            ui.updateBase();
        }
    }
};

// Start
game.load();
game.init();

</script>
</body>
</html>