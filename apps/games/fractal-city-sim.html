<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal City Simulator - Mandelbrot-Powered City Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1f2940;
            --accent: #00d9ff;
            --accent-dim: #0099b3;
            --green: #00ff88;
            --yellow: #ffdd00;
            --orange: #ff8800;
            --red: #ff4444;
            --purple: #aa66ff;
            --text: #e8e8e8;
            --text-dim: #8899aa;
            --border: rgba(255,255,255,0.1);
            --residential: #44aa44;
            --commercial: #4488dd;
            --industrial: #ddaa44;
            --road: #555566;
            --power: #ffaa00;
            --water: #4488ff;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        .top-bar {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 20px;
            border-right: 1px solid var(--border);
        }

        .logo-icon {
            font-size: 24px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 16px;
        }

        .logo-sub {
            font-size: 9px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Resources */
        .resources {
            display: flex;
            gap: 16px;
            flex: 1;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 13px;
        }

        .resource-icon {
            font-size: 16px;
        }

        .resource-value {
            font-weight: 600;
            font-family: 'Consolas', monospace;
        }

        .resource-value.positive { color: var(--green); }
        .resource-value.negative { color: var(--red); }

        .resource-label {
            font-size: 10px;
            color: var(--text-dim);
        }

        /* Time Controls */
        .time-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 16px;
            border-left: 1px solid var(--border);
        }

        .time-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .time-btn:hover {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .time-btn.active {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .date-display {
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
        }

        /* Main Area */
        .main-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            width: 60px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 0.15s ease;
            color: var(--text);
        }

        .tool-btn:hover {
            background: rgba(0,217,255,0.1);
            border-color: var(--accent-dim);
        }

        .tool-btn.active {
            background: rgba(0,217,255,0.2);
            border-color: var(--accent);
        }

        .tool-btn .icon {
            font-size: 18px;
        }

        .tool-btn .label {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tool-separator {
            height: 1px;
            background: var(--border);
            margin: 6px 0;
        }

        .tool-btn.residential.active { border-color: var(--residential); background: rgba(68,170,68,0.2); }
        .tool-btn.commercial.active { border-color: var(--commercial); background: rgba(68,136,221,0.2); }
        .tool-btn.industrial.active { border-color: var(--industrial); background: rgba(221,170,68,0.2); }

        /* Game Canvas */
        .game-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            cursor: crosshair;
        }

        /* Side Panel */
        .side-panel {
            width: 300px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .panel-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.15s ease;
        }

        .panel-tab:hover {
            color: var(--text);
            background: rgba(255,255,255,0.05);
        }

        .panel-tab.active {
            color: var(--accent);
            background: var(--bg-card);
            border-bottom: 2px solid var(--accent);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .panel-section {
            margin-bottom: 16px;
        }

        .panel-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        /* Stats */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 10px;
        }

        .stat-card.full {
            grid-column: span 2;
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .stat-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Demand Meters */
        .demand-meter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .demand-label {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
        }

        .demand-label.r { background: var(--residential); }
        .demand-label.c { background: var(--commercial); }
        .demand-label.i { background: var(--industrial); }

        .demand-bar-container {
            flex: 1;
            height: 20px;
            background: var(--bg-dark);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .demand-bar {
            position: absolute;
            top: 0;
            height: 100%;
            transition: all 0.3s ease;
        }

        .demand-bar.positive {
            left: 50%;
            background: var(--green);
        }

        .demand-bar.negative {
            right: 50%;
            background: var(--red);
        }

        .demand-center {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--text-dim);
            transform: translateX(-50%);
        }

        /* Citizens List */
        .citizen-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .citizen-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .citizen-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .citizen-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
        }

        .citizen-name {
            font-weight: 600;
            font-size: 12px;
        }

        .citizen-job {
            font-size: 10px;
            color: var(--accent);
        }

        .citizen-mood {
            margin-left: auto;
            font-size: 16px;
        }

        .citizen-story {
            font-size: 11px;
            color: var(--text-dim);
            line-height: 1.4;
        }

        /* Building Info */
        .building-info {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
        }

        .building-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .building-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .building-name {
            font-weight: 600;
        }

        .building-type {
            font-size: 11px;
            color: var(--text-dim);
        }

        .building-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 10px;
        }

        .building-stat {
            background: var(--bg-dark);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .building-stat-label {
            color: var(--text-dim);
        }

        .building-stat-value {
            color: var(--accent);
            font-weight: 600;
        }

        /* Budget Panel */
        .budget-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .budget-row:last-child {
            border-bottom: none;
        }

        .budget-row.total {
            font-weight: 700;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 2px solid var(--border);
        }

        .budget-income { color: var(--green); }
        .budget-expense { color: var(--red); }

        /* Mini Map */
        .minimap {
            width: 100%;
            aspect-ratio: 1;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .minimap-canvas {
            width: 100%;
            height: 100%;
        }

        .minimap-viewport {
            position: absolute;
            border: 2px solid var(--accent);
            pointer-events: none;
        }

        /* Toast Messages */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 10px 20px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast.success { border-color: var(--green); }
        .toast.warning { border-color: var(--yellow); }
        .toast.error { border-color: var(--red); }
        .toast.info { border-color: var(--accent); }

        /* Hover Info */
        .hover-info {
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 11px;
            pointer-events: none;
            z-index: 500;
            opacity: 0;
            transition: opacity 0.15s ease;
            max-width: 200px;
        }

        .hover-info.visible {
            opacity: 1;
        }

        .hover-info-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .hover-info-detail {
            color: var(--text-dim);
        }

        /* Bottom Bar */
        .bottom-bar {
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dim);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.good { background: var(--green); }
        .status-dot.warning { background: var(--yellow); }
        .status-dot.bad { background: var(--red); }

        /* Data Controls */
        .data-controls {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .data-btn {
            padding: 4px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .data-btn:hover {
            border-color: var(--accent);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--text-dim);
            font-size: 14px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

        /* Disasters/Events Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-body {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-dim);
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s ease;
        }

        .modal-btn:hover {
            border-color: var(--accent);
        }

        .modal-btn.primary {
            background: var(--accent);
            color: var(--bg-dark);
            border-color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Generating Fractal City...</div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="logo">
            <span class="logo-icon">üèôÔ∏è</span>
            <div>
                <div class="logo-text">Fractal City</div>
                <div class="logo-sub">Mandelbrot-Powered Simulator</div>
            </div>
        </div>

        <div class="resources">
            <div class="resource">
                <span class="resource-icon">üí∞</span>
                <div>
                    <div class="resource-value" id="money">$50,000</div>
                    <div class="resource-label">Treasury</div>
                </div>
            </div>
            <div class="resource">
                <span class="resource-icon">üë•</span>
                <div>
                    <div class="resource-value" id="population">0</div>
                    <div class="resource-label">Population</div>
                </div>
            </div>
            <div class="resource">
                <span class="resource-icon">üòä</span>
                <div>
                    <div class="resource-value" id="happiness">75%</div>
                    <div class="resource-label">Happiness</div>
                </div>
            </div>
            <div class="resource">
                <span class="resource-icon">‚ö°</span>
                <div>
                    <div class="resource-value" id="power">0/0</div>
                    <div class="resource-label">Power</div>
                </div>
            </div>
            <div class="resource">
                <span class="resource-icon">üíß</span>
                <div>
                    <div class="resource-value" id="water">0/0</div>
                    <div class="resource-label">Water</div>
                </div>
            </div>
        </div>

        <div class="time-controls">
            <button class="time-btn" id="pauseBtn" onclick="setSpeed(0)">‚è∏</button>
            <button class="time-btn active" id="play1Btn" onclick="setSpeed(1)">‚ñ∂</button>
            <button class="time-btn" id="play2Btn" onclick="setSpeed(2)">‚ñ∂‚ñ∂</button>
            <button class="time-btn" id="play3Btn" onclick="setSpeed(3)">‚ñ∂‚ñ∂‚ñ∂</button>
            <div class="date-display" id="dateDisplay">Jan 2025</div>
        </div>
    </div>

    <!-- Main Area -->
    <div class="main-area">
        <!-- Toolbar -->
        <div class="toolbar">
            <button class="tool-btn active" onclick="selectTool('pointer')" id="tool-pointer" title="Select">
                <span class="icon">üñ±Ô∏è</span>
                <span class="label">Select</span>
            </button>
            <button class="tool-btn" onclick="selectTool('bulldoze')" id="tool-bulldoze" title="Bulldoze">
                <span class="icon">üöß</span>
                <span class="label">Doze</span>
            </button>

            <div class="tool-separator"></div>

            <button class="tool-btn residential" onclick="selectTool('residential')" id="tool-residential" title="Residential Zone ($100)">
                <span class="icon">üè†</span>
                <span class="label">Res</span>
            </button>
            <button class="tool-btn commercial" onclick="selectTool('commercial')" id="tool-commercial" title="Commercial Zone ($100)">
                <span class="icon">üè™</span>
                <span class="label">Com</span>
            </button>
            <button class="tool-btn industrial" onclick="selectTool('industrial')" id="tool-industrial" title="Industrial Zone ($100)">
                <span class="icon">üè≠</span>
                <span class="label">Ind</span>
            </button>

            <div class="tool-separator"></div>

            <button class="tool-btn" onclick="selectTool('road')" id="tool-road" title="Road ($10)">
                <span class="icon">üõ§Ô∏è</span>
                <span class="label">Road</span>
            </button>
            <button class="tool-btn" onclick="selectTool('power')" id="tool-power" title="Power Plant ($3000)">
                <span class="icon">‚ö°</span>
                <span class="label">Power</span>
            </button>
            <button class="tool-btn" onclick="selectTool('water')" id="tool-water" title="Water Tower ($1500)">
                <span class="icon">üíß</span>
                <span class="label">Water</span>
            </button>

            <div class="tool-separator"></div>

            <button class="tool-btn" onclick="selectTool('park')" id="tool-park" title="Park ($500)">
                <span class="icon">üå≥</span>
                <span class="label">Park</span>
            </button>
            <button class="tool-btn" onclick="selectTool('police')" id="tool-police" title="Police ($500)">
                <span class="icon">üöî</span>
                <span class="label">Police</span>
            </button>
            <button class="tool-btn" onclick="selectTool('fire')" id="tool-fire" title="Fire Station ($500)">
                <span class="icon">üöí</span>
                <span class="label">Fire</span>
            </button>
        </div>

        <!-- Game Canvas -->
        <div class="game-container" id="gameContainer">
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- Side Panel -->
        <div class="side-panel">
            <div class="panel-tabs">
                <button class="panel-tab active" onclick="switchTab('stats')" id="tab-stats">Stats</button>
                <button class="panel-tab" onclick="switchTab('citizens')" id="tab-citizens">Citizens</button>
                <button class="panel-tab" onclick="switchTab('budget')" id="tab-budget">Budget</button>
            </div>

            <div class="panel-content" id="panelContent">
                <!-- Stats Tab -->
                <div id="stats-content">
                    <div class="panel-section">
                        <div class="panel-section-title">City Overview</div>
                        <canvas class="minimap-canvas" id="minimapCanvas" width="276" height="200"></canvas>
                    </div>

                    <div class="panel-section">
                        <div class="panel-section-title">Zone Demand</div>
                        <div class="demand-meter">
                            <div class="demand-label r">R</div>
                            <div class="demand-bar-container">
                                <div class="demand-center"></div>
                                <div class="demand-bar positive" id="demand-r" style="width: 20%"></div>
                            </div>
                        </div>
                        <div class="demand-meter">
                            <div class="demand-label c">C</div>
                            <div class="demand-bar-container">
                                <div class="demand-center"></div>
                                <div class="demand-bar positive" id="demand-c" style="width: 15%"></div>
                            </div>
                        </div>
                        <div class="demand-meter">
                            <div class="demand-label i">I</div>
                            <div class="demand-bar-container">
                                <div class="demand-center"></div>
                                <div class="demand-bar positive" id="demand-i" style="width: 25%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-section">
                        <div class="panel-section-title">Statistics</div>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-label">Residential</div>
                                <div class="stat-value" id="stat-res">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Commercial</div>
                                <div class="stat-value" id="stat-com">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Industrial</div>
                                <div class="stat-value" id="stat-ind">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Jobs</div>
                                <div class="stat-value" id="stat-jobs">0</div>
                            </div>
                            <div class="stat-card full">
                                <div class="stat-label">Employment Rate</div>
                                <div class="stat-value" id="stat-employment">0%</div>
                                <div class="stat-bar">
                                    <div class="stat-bar-fill" id="employment-bar" style="width: 0%; background: var(--green);"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-section">
                        <div class="panel-section-title">Selected Building</div>
                        <div class="building-info" id="buildingInfo">
                            <div style="color: var(--text-dim); font-size: 12px; text-align: center; padding: 20px;">
                                Click a building to view details
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Citizens Tab -->
                <div id="citizens-content" style="display: none;">
                    <div class="panel-section">
                        <div class="panel-section-title">Notable Citizens</div>
                        <div id="citizensList">
                            <div style="color: var(--text-dim); font-size: 12px; text-align: center; padding: 20px;">
                                Citizens will appear as your city grows
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget Tab -->
                <div id="budget-content" style="display: none;">
                    <div class="panel-section">
                        <div class="panel-section-title">Monthly Income</div>
                        <div class="budget-row">
                            <span>Residential Tax</span>
                            <span class="budget-income" id="income-res">+$0</span>
                        </div>
                        <div class="budget-row">
                            <span>Commercial Tax</span>
                            <span class="budget-income" id="income-com">+$0</span>
                        </div>
                        <div class="budget-row">
                            <span>Industrial Tax</span>
                            <span class="budget-income" id="income-ind">+$0</span>
                        </div>
                        <div class="budget-row total">
                            <span>Total Income</span>
                            <span class="budget-income" id="income-total">+$0</span>
                        </div>
                    </div>

                    <div class="panel-section">
                        <div class="panel-section-title">Monthly Expenses</div>
                        <div class="budget-row">
                            <span>Road Maintenance</span>
                            <span class="budget-expense" id="expense-road">-$0</span>
                        </div>
                        <div class="budget-row">
                            <span>Power Plants</span>
                            <span class="budget-expense" id="expense-power">-$0</span>
                        </div>
                        <div class="budget-row">
                            <span>Water Service</span>
                            <span class="budget-expense" id="expense-water">-$0</span>
                        </div>
                        <div class="budget-row">
                            <span>Services</span>
                            <span class="budget-expense" id="expense-services">-$0</span>
                        </div>
                        <div class="budget-row total">
                            <span>Net Income</span>
                            <span id="net-income">$0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
        <div class="status-item">
            <div class="status-dot good" id="power-status"></div>
            <span>Power Grid</span>
        </div>
        <div class="status-item">
            <div class="status-dot good" id="water-status"></div>
            <span>Water Supply</span>
        </div>
        <div class="status-item">
            <div class="status-dot good" id="traffic-status"></div>
            <span>Traffic</span>
        </div>
        <div class="status-item">
            <div class="status-dot good" id="crime-status"></div>
            <span>Safety</span>
        </div>

        <div class="data-controls">
            <button class="data-btn" onclick="exportCity()">üíæ Save</button>
            <button class="data-btn" onclick="document.getElementById('importFile').click()">üìÇ Load</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importCity(event)">
            <button class="data-btn" onclick="newCity()">üÜï New</button>
        </div>
    </div>

    <!-- Hover Info -->
    <div class="hover-info" id="hoverInfo">
        <div class="hover-info-title"></div>
        <div class="hover-info-detail"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title" id="modalTitle">üéâ Welcome!</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // FRACTAL CITY SIMULATOR
        // A SimCity clone powered by Mandelbrot math
        // =============================================

        const APP_NAME = 'fractal-city-sim';

        // ========== CONFIGURATION ==========
        const CONFIG = {
            MAP_SIZE: 64,
            TILE_SIZE: 24,
            COSTS: {
                residential: 100,
                commercial: 100,
                industrial: 100,
                road: 10,
                power: 3000,
                water: 1500,
                park: 500,
                police: 500,
                fire: 500,
                bulldoze: 5
            },
            POWER_OUTPUT: 500,
            WATER_OUTPUT: 400,
            TAX_RATE: 0.08,
            MAINTENANCE: {
                road: 1,
                power: 50,
                water: 30,
                police: 100,
                fire: 100,
                park: 10
            }
        };

        // ========== GAME STATE ==========
        let game = {
            map: [],
            buildings: [],
            citizens: [],
            money: 50000,
            population: 0,
            happiness: 75,
            month: 0,
            year: 2025,
            speed: 1,
            selectedTool: 'pointer',
            selectedBuilding: null,
            camera: { x: 0, y: 0 },
            demand: { r: 80, c: 70, i: 75 },
            power: { supply: 0, demand: 0 },
            water: { supply: 0, demand: 0 },
            stats: {
                residential: 0,
                commercial: 0,
                industrial: 0,
                roads: 0,
                jobs: 0
            },
            fractalSeed: Date.now()
        };

        // Canvas
        let canvas, ctx, minimapCanvas, minimapCtx;
        let canvasWidth, canvasHeight;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let cameraStart = { x: 0, y: 0 };
        let lastTickTime = 0;
        let tickInterval = null;

        // ========== SEEDED RANDOM ==========
        function mulberry32(seed) {
            return function() {
                let t = seed += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            };
        }

        function seededRandom(x, y) {
            const seed = (x * 374761393 + y * 668265263 + game.fractalSeed) | 0;
            return mulberry32(seed)();
        }

        // ========== MANDELBROT FUNCTIONS ==========
        function mandelbrot(re, im, maxIter = 50) {
            let zRe = 0, zIm = 0;
            let n = 0;
            while (n < maxIter && zRe * zRe + zIm * zIm < 4) {
                const temp = zRe * zRe - zIm * zIm + re;
                zIm = 2 * zRe * zIm + im;
                zRe = temp;
                n++;
            }
            return n / maxIter;
        }

        function getTileMandelbrotValue(x, y) {
            // Map tile coordinates to an interesting region of the Mandelbrot set
            const scale = 3 / CONFIG.MAP_SIZE;
            const re = (x - CONFIG.MAP_SIZE / 2) * scale - 0.5;
            const im = (y - CONFIG.MAP_SIZE / 2) * scale;
            return mandelbrot(re, im, 100);
        }

        // ========== INITIALIZATION ==========
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            minimapCanvas = document.getElementById('minimapCanvas');
            minimapCtx = minimapCanvas.getContext('2d');

            resize();
            window.addEventListener('resize', resize);

            setupEventListeners();
            loadGame();

            if (game.map.length === 0) {
                initializeMap();
                generateStarterCity();
            }

            startSimulation();
            render();
            updateUI();

            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                showModal('üèôÔ∏è Welcome, Mayor!',
                    `<strong>Population: ${game.population.toLocaleString()}</strong> citizens are counting on you!<br><br>` +
                    'Your thriving city is powered by the <em>Mandelbrot set</em> ‚Äî every building and citizen is mathematically generated from fractal coordinates.<br><br>' +
                    '<strong>Quick Start:</strong><br>' +
                    '‚Ä¢ <span style="color:#4a4">‚ñ†</span> <strong>Click any building</strong> to meet its residents<br>' +
                    '‚Ä¢ <span style="color:#48d">‚ñ†</span> <strong>Expand downtown</strong> with Commercial zones<br>' +
                    '‚Ä¢ <span style="color:#da4">‚ñ†</span> <strong>Add Industry</strong> to create jobs<br>' +
                    '‚Ä¢ <span style="color:#4a4">‚ñ†</span> <strong>Build Housing</strong> for population growth<br><br>' +
                    '<strong>Controls:</strong> WASD/Arrows to pan ‚Ä¢ Click to build ‚Ä¢ Scroll to... admire your city');
            }, 500);
        }

        function resize() {
            const container = document.getElementById('gameContainer');
            canvasWidth = container.clientWidth;
            canvasHeight = container.clientHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // Center camera on map
            if (game.camera.x === 0 && game.camera.y === 0) {
                game.camera.x = (CONFIG.MAP_SIZE * CONFIG.TILE_SIZE - canvasWidth) / 2;
                game.camera.y = (CONFIG.MAP_SIZE * CONFIG.TILE_SIZE - canvasHeight) / 2;
            }

            render();
        }

        function initializeMap() {
            game.map = [];
            for (let y = 0; y < CONFIG.MAP_SIZE; y++) {
                game.map[y] = [];
                for (let x = 0; x < CONFIG.MAP_SIZE; x++) {
                    const mandel = getTileMandelbrotValue(x, y);
                    game.map[y][x] = {
                        type: 'empty',
                        zone: null,
                        building: null,
                        powered: false,
                        watered: false,
                        mandelbrot: mandel,
                        landValue: Math.floor(mandel * 100)
                    };
                }
            }
        }

        function generateStarterCity() {
            const c = Math.floor(CONFIG.MAP_SIZE / 2);

            // ===== ROAD NETWORK =====
            // Main boulevards (the "spine" of the city)
            for (let i = -15; i <= 15; i++) {
                setTile(c + i, c, 'road');      // Main Street (horizontal)
                setTile(c, c + i, 'road');      // Central Avenue (vertical)
            }

            // Downtown grid (dense 3x3 block pattern)
            for (let block = -2; block <= 2; block++) {
                const offset = block * 4;
                for (let i = -10; i <= 10; i++) {
                    if (Math.abs(i) <= 10) {
                        setTile(c + i, c + offset, 'road');
                        setTile(c + offset, c + i, 'road');
                    }
                }
            }

            // Outer ring road
            for (let i = -12; i <= 12; i++) {
                setTile(c + i, c - 12, 'road');
                setTile(c + i, c + 12, 'road');
                setTile(c - 12, c + i, 'road');
                setTile(c + 12, c + i, 'road');
            }

            // ===== UTILITIES (placed first, connected to road network) =====
            // Power plants - corners for coverage
            placeBuildingAt(c - 11, c - 11, 'power');
            placeBuildingAt(c + 11, c - 11, 'power');
            placeBuildingAt(c - 11, c + 11, 'power');

            // Water towers - distributed
            placeBuildingAt(c + 11, c + 11, 'water');
            placeBuildingAt(c - 5, c - 11, 'water');
            placeBuildingAt(c + 5, c + 11, 'water');

            // ===== SERVICES =====
            // Police stations
            placeBuildingAt(c - 3, c - 3, 'police');
            placeBuildingAt(c + 3, c + 3, 'police');
            placeBuildingAt(c - 9, c + 5, 'police');

            // Fire stations
            placeBuildingAt(c + 3, c - 3, 'fire');
            placeBuildingAt(c - 3, c + 3, 'fire');
            placeBuildingAt(c + 9, c - 5, 'fire');

            // ===== PARKS (green spaces throughout) =====
            placeBuildingAt(c - 1, c - 1, 'park');
            placeBuildingAt(c + 1, c + 1, 'park');
            placeBuildingAt(c - 6, c - 6, 'park');
            placeBuildingAt(c + 6, c + 6, 'park');
            placeBuildingAt(c - 6, c + 6, 'park');
            placeBuildingAt(c + 6, c - 6, 'park');

            // ===== DOWNTOWN COMMERCIAL DISTRICT (center) =====
            const downtownCommercial = [];
            for (let dy = -3; dy <= 3; dy++) {
                for (let dx = -3; dx <= 3; dx++) {
                    if (Math.abs(dx) <= 3 && Math.abs(dy) <= 3) {
                        downtownCommercial.push([dx, dy]);
                    }
                }
            }
            downtownCommercial.forEach(([dx, dy]) => {
                const x = c + dx, y = c + dy;
                if (game.map[y][x].type === 'empty') {
                    placeBuildingAt(x, y, 'commercial');
                }
            });

            // ===== RESIDENTIAL NEIGHBORHOODS =====
            // North residential (suburbs feel)
            for (let dy = -11; dy <= -5; dy++) {
                for (let dx = -7; dx <= 7; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty' && Math.abs(dx) !== 4 && Math.abs(dx) !== 8) {
                        placeBuildingAt(x, y, 'residential');
                    }
                }
            }

            // South residential
            for (let dy = 5; dy <= 11; dy++) {
                for (let dx = -7; dx <= 7; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty' && Math.abs(dx) !== 4 && Math.abs(dx) !== 8) {
                        placeBuildingAt(x, y, 'residential');
                    }
                }
            }

            // West residential
            for (let dy = -3; dy <= 3; dy++) {
                for (let dx = -11; dx <= -5; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty' && dy !== 0 && Math.abs(dy) !== 4) {
                        placeBuildingAt(x, y, 'residential');
                    }
                }
            }

            // ===== INDUSTRIAL DISTRICT (east side) =====
            for (let dy = -3; dy <= 3; dy++) {
                for (let dx = 5; dx <= 11; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty' && dy !== 0 && Math.abs(dy) !== 4) {
                        placeBuildingAt(x, y, 'industrial');
                    }
                }
            }

            // ===== EXPANSION ZONES (pre-zoned for easy growth) =====
            // Zone corners for future expansion
            for (let dy = -11; dy <= -9; dy++) {
                for (let dx = 9; dx <= 11; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty') setTile(x, y, 'zone', 'industrial');
                }
            }
            for (let dy = -11; dy <= -9; dy++) {
                for (let dx = -11; dx <= -9; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty') setTile(x, y, 'zone', 'residential');
                }
            }
            for (let dy = 9; dy <= 11; dy++) {
                for (let dx = -11; dx <= -9; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty') setTile(x, y, 'zone', 'residential');
                }
            }
            for (let dy = 9; dy <= 11; dy++) {
                for (let dx = 9; dx <= 11; dx++) {
                    const x = c + dx, y = c + dy;
                    if (game.map[y][x].type === 'empty') setTile(x, y, 'zone', 'commercial');
                }
            }

            // ===== RUN SIMULATION TO INITIALIZE =====
            // Update utilities first so buildings get power/water
            updateUtilities();

            // Calculate stats from all buildings
            calculateIncome(); // This populates game.population and game.stats
            calculateExpenses();

            // Run a few more ticks silently
            for (let i = 0; i < 6; i++) {
                simulateTick(true);
            }

            // ===== SET THRIVING CITY STATE =====
            game.money = 75000;
            game.year = 2045;
            game.month = 3;
            game.happiness = 82;
            game.demand = { r: 65, c: 55, i: 60 };

            // Force recalculate population from buildings
            game.population = 0;
            game.stats.residential = 0;
            game.stats.commercial = 0;
            game.stats.industrial = 0;
            game.stats.jobs = 0;
            game.buildings.forEach(b => {
                if (b.type === 'residential') {
                    game.stats.residential++;
                    game.population += b.population;
                } else if (b.type === 'commercial') {
                    game.stats.commercial++;
                    game.stats.jobs += b.jobs;
                } else if (b.type === 'industrial') {
                    game.stats.industrial++;
                    game.stats.jobs += b.jobs;
                }
            });

            updateUI();
        }

        // ========== TILE OPERATIONS ==========
        function setTile(x, y, type, zone = null) {
            if (x < 0 || x >= CONFIG.MAP_SIZE || y < 0 || y >= CONFIG.MAP_SIZE) return false;

            const tile = game.map[y][x];
            tile.type = type;
            tile.zone = zone;

            if (type === 'zone') {
                tile.type = 'zone';
            }

            return true;
        }

        function placeBuildingAt(x, y, type) {
            if (x < 0 || x >= CONFIG.MAP_SIZE || y < 0 || y >= CONFIG.MAP_SIZE) return false;

            const tile = game.map[y][x];
            tile.type = type;
            tile.building = generateBuilding(x, y, type);

            return true;
        }

        function generateBuilding(x, y, type) {
            const seed = x * 1000 + y + game.fractalSeed;
            const rng = mulberry32(seed);

            const building = {
                id: seed,
                x, y,
                type,
                level: 1,
                population: 0,
                jobs: 0,
                happiness: 75,
                name: generateBuildingName(type, rng),
                inhabitants: [],
                powered: false,
                watered: false,
                landValue: game.map[y][x].landValue
            };

            if (type === 'residential') {
                building.population = Math.floor(rng() * 10) + 5;
                building.inhabitants = generateInhabitants(seed, building.population, rng);
            } else if (type === 'commercial' || type === 'industrial') {
                building.jobs = Math.floor(rng() * 15) + 5;
            }

            game.buildings.push(building);
            return building;
        }

        function generateBuildingName(type, rng) {
            const names = {
                residential: {
                    prefixes: ['Sunrise', 'Oak', 'Maple', 'Crystal', 'Golden', 'Silver', 'Emerald', 'Royal', 'Grand', 'Harmony'],
                    suffixes: ['Apartments', 'Residences', 'Heights', 'Towers', 'Place', 'Gardens', 'Manor', 'Court', 'Village', 'Estates']
                },
                commercial: {
                    prefixes: ['Metro', 'Central', 'Prime', 'Elite', 'Global', 'Fusion', 'Apex', 'Summit', 'Nexus', 'Core'],
                    suffixes: ['Plaza', 'Center', 'Mall', 'Market', 'Exchange', 'Hub', 'Square', 'Complex', 'Galleria', 'Arcade']
                },
                industrial: {
                    prefixes: ['Steel', 'Iron', 'Tech', 'Precision', 'Dynamic', 'Nova', 'Quantum', 'Alpha', 'Titan', 'Atlas'],
                    suffixes: ['Works', 'Industries', 'Manufacturing', 'Factory', 'Plant', 'Foundry', 'Labs', 'Systems', 'Corp', 'Solutions']
                },
                park: {
                    prefixes: ['Sunny', 'Green', 'Peaceful', 'Harmony', 'Liberty', 'Unity', 'Serenity', 'Eden', 'Paradise', 'Haven'],
                    suffixes: ['Park', 'Gardens', 'Green', 'Commons', 'Grove', 'Meadow', 'Sanctuary', 'Reserve', 'Oasis', 'Fields']
                },
                power: {
                    prefixes: ['Thunder', 'Lightning', 'Volt', 'Amp', 'Spark', 'Energy', 'Electron', 'Dynamo', 'Power', 'Current'],
                    suffixes: ['Station', 'Plant', 'Generator', 'Facility', 'Complex', 'Hub', 'Core', 'Grid', 'Center', 'Works']
                },
                water: {
                    prefixes: ['Crystal', 'Clear', 'Pure', 'Aqua', 'Blue', 'Fresh', 'Spring', 'Flow', 'Stream', 'River'],
                    suffixes: ['Tower', 'Station', 'Works', 'Facility', 'Plant', 'Reserve', 'Supply', 'Center', 'Hub', 'System']
                },
                police: {
                    prefixes: ['Central', 'Metro', 'City', 'District', 'Main', 'North', 'South', 'East', 'West', 'Civic'],
                    suffixes: ['Police Station', 'Precinct', 'HQ', 'Department', 'Division', 'Unit', 'Center', 'Office', 'Bureau', 'Post']
                },
                fire: {
                    prefixes: ['Central', 'Metro', 'City', 'District', 'Main', 'North', 'South', 'East', 'West', 'Civic'],
                    suffixes: ['Fire Station', 'Firehouse', 'Engine Co.', 'Rescue', 'Department', 'Unit', 'Brigade', 'Squad', 'Response', 'Services']
                }
            };

            const typeNames = names[type] || names.residential;
            const prefix = typeNames.prefixes[Math.floor(rng() * typeNames.prefixes.length)];
            const suffix = typeNames.suffixes[Math.floor(rng() * typeNames.suffixes.length)];

            return `${prefix} ${suffix}`;
        }

        function generateInhabitants(seed, count, rng) {
            const inhabitants = [];
            const firstNames = ['Alex', 'Jordan', 'Taylor', 'Morgan', 'Casey', 'Riley', 'Quinn', 'Avery', 'Sage', 'River', 'Phoenix', 'Skyler', 'Dakota', 'Cameron', 'Blake', 'Drew', 'Finley', 'Harper', 'Emerson', 'Reese'];
            const lastNames = ['Chen', 'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Wilson', 'Anderson', 'Taylor', 'Thomas', 'Moore', 'Jackson', 'Martin', 'Lee', 'Kim'];
            const jobs = ['Engineer', 'Teacher', 'Doctor', 'Artist', 'Chef', 'Writer', 'Scientist', 'Designer', 'Musician', 'Architect', 'Developer', 'Manager', 'Analyst', 'Consultant', 'Researcher', 'Entrepreneur', 'Nurse', 'Accountant', 'Lawyer', 'Therapist'];

            for (let i = 0; i < Math.min(count, 5); i++) {
                const iRng = mulberry32(seed + i * 777);

                const firstName = firstNames[Math.floor(iRng() * firstNames.length)];
                const lastName = lastNames[Math.floor(iRng() * lastNames.length)];
                const job = jobs[Math.floor(iRng() * jobs.length)];
                const age = Math.floor(iRng() * 50) + 20;

                const moods = ['üòä', 'üòê', 'üò¢', 'üò¥', 'ü§î', 'üòé', 'ü•≥', 'üòå'];
                const mood = moods[Math.floor(iRng() * moods.length)];

                const hue = Math.floor(iRng() * 360);

                inhabitants.push({
                    name: `${firstName} ${lastName}`,
                    age,
                    job,
                    mood,
                    avatar: `hsl(${hue}, 60%, 50%)`,
                    story: generateStory(seed + i, firstName, job, iRng),
                    happiness: Math.floor(iRng() * 30) + 60
                });
            }

            if (!game.citizens) game.citizens = [];
            inhabitants.forEach(i => {
                if (game.citizens.length < 50) {
                    game.citizens.push(i);
                }
            });

            return inhabitants;
        }

        function generateStory(seed, name, job, rng) {
            const origins = [
                `moved here seeking new opportunities`,
                `was born and raised in this neighborhood`,
                `relocated from across the country for work`,
                `followed a dream to this vibrant city`,
                `came here to start a new chapter in life`
            ];

            const activities = [
                `enjoys exploring local parks on weekends`,
                `is known for hosting neighborhood gatherings`,
                `volunteers at the community center`,
                `is passionate about urban gardening`,
                `loves discovering hidden gems in the city`
            ];

            const dreams = [
                `hopes to open their own business someday`,
                `dreams of seeing the city become greener`,
                `wants to help make the community safer`,
                `aspires to bring more art to public spaces`,
                `wishes for better public transportation`
            ];

            return `${name} ${origins[Math.floor(rng() * origins.length)]}. As a ${job}, they work hard but always find time for what matters. ${name} ${activities[Math.floor(rng() * activities.length)]} and ${dreams[Math.floor(rng() * dreams.length)]}.`;
        }

        // ========== EVENT HANDLERS ==========
        function setupEventListeners() {
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('click', handleClick);
            canvas.addEventListener('contextmenu', e => e.preventDefault());

            document.addEventListener('keydown', handleKeyDown);
        }

        function handleMouseDown(e) {
            if (e.button === 2 || e.button === 1) {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
                cameraStart = { ...game.camera };
                canvas.style.cursor = 'grabbing';
            } else if (e.button === 0 && game.selectedTool !== 'pointer') {
                handleToolUse(e);
            }
        }

        function handleMouseMove(e) {
            if (isDragging) {
                game.camera.x = cameraStart.x - (e.clientX - dragStart.x);
                game.camera.y = cameraStart.y - (e.clientY - dragStart.y);
                render();
            } else {
                updateHoverInfo(e);
            }
        }

        function handleMouseUp(e) {
            isDragging = false;
            canvas.style.cursor = 'crosshair';
        }

        function handleWheel(e) {
            e.preventDefault();
            const zoomSpeed = 5;
            game.camera.x += e.deltaX * 0.5;
            game.camera.y += e.deltaY * 0.5;
            render();
        }

        function handleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left + game.camera.x;
            const mouseY = e.clientY - rect.top + game.camera.y;

            const tileX = Math.floor(mouseX / CONFIG.TILE_SIZE);
            const tileY = Math.floor(mouseY / CONFIG.TILE_SIZE);

            if (tileX < 0 || tileX >= CONFIG.MAP_SIZE || tileY < 0 || tileY >= CONFIG.MAP_SIZE) return;

            if (game.selectedTool === 'pointer') {
                selectBuilding(tileX, tileY);
            } else {
                handleToolUse(e);
            }
        }

        function handleToolUse(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left + game.camera.x;
            const mouseY = e.clientY - rect.top + game.camera.y;

            const tileX = Math.floor(mouseX / CONFIG.TILE_SIZE);
            const tileY = Math.floor(mouseY / CONFIG.TILE_SIZE);

            if (tileX < 0 || tileX >= CONFIG.MAP_SIZE || tileY < 0 || tileY >= CONFIG.MAP_SIZE) return;

            const tool = game.selectedTool;
            const cost = CONFIG.COSTS[tool] || 0;

            if (game.money < cost) {
                showToast('Not enough funds!', 'error');
                return;
            }

            const tile = game.map[tileY][tileX];

            if (tool === 'bulldoze') {
                if (tile.type !== 'empty') {
                    tile.type = 'empty';
                    tile.zone = null;
                    if (tile.building) {
                        game.buildings = game.buildings.filter(b => b !== tile.building);
                        tile.building = null;
                    }
                    game.money -= cost;
                    showToast('Area cleared', 'info');
                }
            } else if (tool === 'road') {
                if (tile.type === 'empty') {
                    setTile(tileX, tileY, 'road');
                    game.money -= cost;
                }
            } else if (tool === 'residential' || tool === 'commercial' || tool === 'industrial') {
                if (tile.type === 'empty') {
                    setTile(tileX, tileY, 'zone', tool);
                    game.money -= cost;
                }
            } else if (['power', 'water', 'park', 'police', 'fire'].includes(tool)) {
                if (tile.type === 'empty') {
                    placeBuildingAt(tileX, tileY, tool);
                    game.money -= cost;
                    showToast(`${tool.charAt(0).toUpperCase() + tool.slice(1)} built!`, 'success');
                }
            }

            updateUtilities();
            render();
            updateUI();
        }

        function handleKeyDown(e) {
            if (e.key === '1') selectTool('pointer');
            else if (e.key === '2') selectTool('bulldoze');
            else if (e.key === 'r') selectTool('residential');
            else if (e.key === 'c') selectTool('commercial');
            else if (e.key === 'i') selectTool('industrial');
            else if (e.key === 'q') selectTool('road');
            else if (e.key === ' ') {
                e.preventDefault();
                setSpeed(game.speed === 0 ? 1 : 0);
            }
        }

        function selectTool(tool) {
            game.selectedTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool-${tool}`)?.classList.add('active');
        }

        function selectBuilding(x, y) {
            const tile = game.map[y][x];
            game.selectedBuilding = tile.building;

            const info = document.getElementById('buildingInfo');

            if (!tile.building && tile.type === 'zone') {
                info.innerHTML = `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">
                            ${tile.zone === 'residential' ? 'üè†' : tile.zone === 'commercial' ? 'üè™' : 'üè≠'}
                        </div>
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            ${tile.zone.charAt(0).toUpperCase() + tile.zone.slice(1)} Zone
                        </div>
                        <div style="font-size: 11px; color: var(--text-dim);">
                            Awaiting development...<br>
                            ${!tile.powered ? '‚ö†Ô∏è No power' : '‚úì Powered'}<br>
                            ${!tile.watered ? '‚ö†Ô∏è No water' : '‚úì Water'}
                        </div>
                    </div>
                `;
            } else if (tile.building) {
                const b = tile.building;
                const icons = {
                    residential: 'üè†',
                    commercial: 'üè™',
                    industrial: 'üè≠',
                    power: '‚ö°',
                    water: 'üíß',
                    park: 'üå≥',
                    police: 'üöî',
                    fire: 'üöí'
                };

                const colors = {
                    residential: 'var(--residential)',
                    commercial: 'var(--commercial)',
                    industrial: 'var(--industrial)',
                    power: 'var(--power)',
                    water: 'var(--water)',
                    park: 'var(--green)',
                    police: 'var(--accent)',
                    fire: 'var(--red)'
                };

                info.innerHTML = `
                    <div class="building-header">
                        <div class="building-icon" style="background: ${colors[b.type]}">${icons[b.type]}</div>
                        <div>
                            <div class="building-name">${b.name}</div>
                            <div class="building-type">${b.type.charAt(0).toUpperCase() + b.type.slice(1)} ‚Ä¢ Level ${b.level}</div>
                        </div>
                    </div>
                    <div class="building-stats">
                        ${b.type === 'residential' ? `
                            <div class="building-stat">
                                <span class="building-stat-label">Population:</span>
                                <span class="building-stat-value">${b.population}</span>
                            </div>
                            <div class="building-stat">
                                <span class="building-stat-label">Happiness:</span>
                                <span class="building-stat-value">${b.happiness}%</span>
                            </div>
                        ` : ''}
                        ${b.type === 'commercial' || b.type === 'industrial' ? `
                            <div class="building-stat">
                                <span class="building-stat-label">Jobs:</span>
                                <span class="building-stat-value">${b.jobs}</span>
                            </div>
                        ` : ''}
                        ${b.type === 'power' ? `
                            <div class="building-stat">
                                <span class="building-stat-label">Output:</span>
                                <span class="building-stat-value">${CONFIG.POWER_OUTPUT} MW</span>
                            </div>
                        ` : ''}
                        ${b.type === 'water' ? `
                            <div class="building-stat">
                                <span class="building-stat-label">Output:</span>
                                <span class="building-stat-value">${CONFIG.WATER_OUTPUT} gal</span>
                            </div>
                        ` : ''}
                        <div class="building-stat">
                            <span class="building-stat-label">Land Value:</span>
                            <span class="building-stat-value">$${b.landValue}</span>
                        </div>
                        <div class="building-stat">
                            <span class="building-stat-label">Coords:</span>
                            <span class="building-stat-value">(${b.x}, ${b.y})</span>
                        </div>
                    </div>
                    ${b.inhabitants && b.inhabitants.length > 0 ? `
                        <div style="margin-top: 10px; font-size: 10px; color: var(--text-dim);">
                            Notable residents: ${b.inhabitants.slice(0, 2).map(i => i.name).join(', ')}
                        </div>
                    ` : ''}
                `;
            } else {
                info.innerHTML = `
                    <div style="color: var(--text-dim); font-size: 12px; text-align: center; padding: 20px;">
                        ${tile.type === 'road' ? 'üõ§Ô∏è Road' : tile.type === 'empty' ? 'Empty land' : tile.type}
                        <br><small>Land value: $${tile.landValue}</small>
                    </div>
                `;
            }

            render();
        }

        function updateHoverInfo(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left + game.camera.x;
            const mouseY = e.clientY - rect.top + game.camera.y;

            const tileX = Math.floor(mouseX / CONFIG.TILE_SIZE);
            const tileY = Math.floor(mouseY / CONFIG.TILE_SIZE);

            const hoverInfo = document.getElementById('hoverInfo');

            if (tileX < 0 || tileX >= CONFIG.MAP_SIZE || tileY < 0 || tileY >= CONFIG.MAP_SIZE) {
                hoverInfo.classList.remove('visible');
                return;
            }

            const tile = game.map[tileY][tileX];
            let title = '';
            let detail = '';

            if (tile.building) {
                title = tile.building.name;
                detail = `${tile.building.type} ‚Ä¢ Click for details`;
            } else if (tile.zone) {
                title = `${tile.zone.charAt(0).toUpperCase() + tile.zone.slice(1)} Zone`;
                detail = tile.powered && tile.watered ? 'Ready for development' : 'Needs utilities';
            } else if (tile.type === 'road') {
                title = 'Road';
                detail = 'Connects your city';
            } else {
                title = 'Empty Land';
                detail = `Value: $${tile.landValue}`;
            }

            hoverInfo.querySelector('.hover-info-title').textContent = title;
            hoverInfo.querySelector('.hover-info-detail').textContent = detail;
            hoverInfo.style.left = (e.clientX + 15) + 'px';
            hoverInfo.style.top = (e.clientY + 15) + 'px';
            hoverInfo.classList.add('visible');
        }

        // ========== SIMULATION ==========
        function startSimulation() {
            if (tickInterval) clearInterval(tickInterval);
            tickInterval = setInterval(() => {
                if (game.speed > 0) {
                    for (let i = 0; i < game.speed; i++) {
                        simulateTick();
                    }
                    render();
                    updateUI();
                }
            }, 1000);
        }

        function simulateTick(silent = false) {
            game.month++;
            if (game.month > 12) {
                game.month = 1;
                game.year++;
            }

            // Update utilities
            updateUtilities();

            // Develop zones
            developZones();

            // Calculate income/expenses
            const income = calculateIncome();
            const expenses = calculateExpenses();
            game.money += income - expenses;

            // Update demand
            updateDemand();

            // Update happiness
            updateHappiness();

            // Random events (occasionally)
            if (Math.random() < 0.01 && !silent) {
                triggerRandomEvent();
            }

            saveGame();
        }

        function updateUtilities() {
            // Reset all
            game.power.supply = 0;
            game.power.demand = 0;
            game.water.supply = 0;
            game.water.demand = 0;

            // Calculate supply
            game.buildings.forEach(b => {
                if (b.type === 'power') game.power.supply += CONFIG.POWER_OUTPUT;
                if (b.type === 'water') game.water.supply += CONFIG.WATER_OUTPUT;
            });

            // Calculate demand and propagate utilities
            for (let y = 0; y < CONFIG.MAP_SIZE; y++) {
                for (let x = 0; x < CONFIG.MAP_SIZE; x++) {
                    const tile = game.map[y][x];
                    tile.powered = false;
                    tile.watered = false;

                    if (tile.building) {
                        if (['residential', 'commercial', 'industrial'].includes(tile.building.type)) {
                            game.power.demand += 10;
                            game.water.demand += 10;
                        }
                    } else if (tile.zone) {
                        game.power.demand += 5;
                        game.water.demand += 5;
                    }
                }
            }

            // Simple utility propagation (from power/water buildings via roads)
            const visited = new Set();
            const queue = [];

            // Start from utility buildings
            game.buildings.forEach(b => {
                if (b.type === 'power' || b.type === 'water') {
                    queue.push({ x: b.x, y: b.y, type: b.type });
                }
            });

            while (queue.length > 0) {
                const { x, y, type } = queue.shift();
                const key = `${x},${y},${type}`;
                if (visited.has(key)) continue;
                visited.add(key);

                if (x < 0 || x >= CONFIG.MAP_SIZE || y < 0 || y >= CONFIG.MAP_SIZE) continue;

                const tile = game.map[y][x];

                if (type === 'power') tile.powered = true;
                if (type === 'water') tile.watered = true;

                if (tile.building) tile.building[type === 'power' ? 'powered' : 'watered'] = true;

                // Spread through roads and adjacent tiles
                const neighbors = [
                    { x: x - 1, y }, { x: x + 1, y },
                    { x, y: y - 1 }, { x, y: y + 1 }
                ];

                neighbors.forEach(n => {
                    if (n.x >= 0 && n.x < CONFIG.MAP_SIZE && n.y >= 0 && n.y < CONFIG.MAP_SIZE) {
                        const nTile = game.map[n.y][n.x];
                        if (nTile.type === 'road' || nTile.building || nTile.zone) {
                            queue.push({ x: n.x, y: n.y, type });
                        }
                    }
                });
            }
        }

        function developZones() {
            for (let y = 0; y < CONFIG.MAP_SIZE; y++) {
                for (let x = 0; x < CONFIG.MAP_SIZE; x++) {
                    const tile = game.map[y][x];

                    if (tile.type === 'zone' && !tile.building) {
                        // Check if near road
                        const nearRoad = checkNearRoad(x, y);
                        if (!nearRoad) continue;

                        // Check utilities
                        if (!tile.powered || !tile.watered) continue;

                        // Check demand
                        const demand = game.demand[tile.zone.charAt(0)];
                        if (demand < 15) continue;

                        // Random chance to develop (higher chance = faster development)
                        if (Math.random() < 0.25) {
                            tile.type = tile.zone;
                            tile.building = generateBuilding(x, y, tile.zone);
                            game.demand[tile.zone.charAt(0)] -= 5;
                        }
                    }
                }
            }
        }

        function checkNearRoad(x, y) {
            const neighbors = [
                { x: x - 1, y }, { x: x + 1, y },
                { x, y: y - 1 }, { x, y: y + 1 }
            ];

            return neighbors.some(n => {
                if (n.x >= 0 && n.x < CONFIG.MAP_SIZE && n.y >= 0 && n.y < CONFIG.MAP_SIZE) {
                    return game.map[n.y][n.x].type === 'road';
                }
                return false;
            });
        }

        function calculateIncome() {
            let income = 0;
            game.stats.residential = 0;
            game.stats.commercial = 0;
            game.stats.industrial = 0;
            game.stats.jobs = 0;
            game.population = 0;

            game.buildings.forEach(b => {
                if (b.type === 'residential') {
                    game.stats.residential++;
                    game.population += b.population;
                    income += b.population * 10 * CONFIG.TAX_RATE;
                } else if (b.type === 'commercial') {
                    game.stats.commercial++;
                    game.stats.jobs += b.jobs;
                    income += b.jobs * 15 * CONFIG.TAX_RATE;
                } else if (b.type === 'industrial') {
                    game.stats.industrial++;
                    game.stats.jobs += b.jobs;
                    income += b.jobs * 12 * CONFIG.TAX_RATE;
                }
            });

            return Math.floor(income);
        }

        function calculateExpenses() {
            let expenses = 0;
            game.stats.roads = 0;

            for (let y = 0; y < CONFIG.MAP_SIZE; y++) {
                for (let x = 0; x < CONFIG.MAP_SIZE; x++) {
                    const tile = game.map[y][x];
                    if (tile.type === 'road') {
                        game.stats.roads++;
                        expenses += CONFIG.MAINTENANCE.road;
                    }
                }
            }

            game.buildings.forEach(b => {
                if (CONFIG.MAINTENANCE[b.type]) {
                    expenses += CONFIG.MAINTENANCE[b.type];
                }
            });

            return expenses;
        }

        function updateDemand() {
            const residentialRatio = game.stats.residential / Math.max(1, game.stats.commercial + game.stats.industrial);
            const commercialRatio = game.stats.commercial / Math.max(1, game.stats.residential);
            const industrialRatio = game.stats.industrial / Math.max(1, game.stats.residential);

            // Demand increases when ratio is low
            game.demand.r = Math.max(0, Math.min(100, 50 + (1 - residentialRatio) * 30 + Math.random() * 10 - 5));
            game.demand.c = Math.max(0, Math.min(100, 40 + (0.5 - commercialRatio) * 40 + Math.random() * 10 - 5));
            game.demand.i = Math.max(0, Math.min(100, 60 + (0.3 - industrialRatio) * 30 + Math.random() * 10 - 5));
        }

        function updateHappiness() {
            let factors = [];

            // Employment
            const employmentRate = game.stats.jobs / Math.max(1, game.population);
            factors.push(Math.min(100, employmentRate * 100));

            // Utilities
            factors.push(game.power.supply >= game.power.demand ? 80 : 40);
            factors.push(game.water.supply >= game.water.demand ? 80 : 40);

            // Services
            const hasPolice = game.buildings.some(b => b.type === 'police');
            const hasFire = game.buildings.some(b => b.type === 'fire');
            const hasParks = game.buildings.some(b => b.type === 'park');

            factors.push(hasPolice ? 85 : 60);
            factors.push(hasFire ? 85 : 60);
            factors.push(hasParks ? 90 : 70);

            game.happiness = Math.floor(factors.reduce((a, b) => a + b, 0) / factors.length);
        }

        function triggerRandomEvent() {
            const events = [
                { title: 'üéâ Festival!', msg: 'A local festival boosted happiness!', effect: () => game.happiness = Math.min(100, game.happiness + 10) },
                { title: 'üèÜ Award', msg: 'Your city won a planning award! +$5000', effect: () => game.money += 5000 },
                { title: 'üìà Boom', msg: 'Economic boom! Commercial demand increased.', effect: () => game.demand.c = Math.min(100, game.demand.c + 20) },
                { title: 'üè≠ Industry Grant', msg: 'Federal grant for industry! +$3000', effect: () => game.money += 3000 }
            ];

            const event = events[Math.floor(Math.random() * events.length)];
            event.effect();
            showToast(`${event.title} ${event.msg}`, 'success');
        }

        // ========== RENDERING ==========
        function render() {
            if (!ctx || game.map.length === 0) return;

            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            const startX = Math.floor(game.camera.x / CONFIG.TILE_SIZE);
            const startY = Math.floor(game.camera.y / CONFIG.TILE_SIZE);
            const endX = Math.min(CONFIG.MAP_SIZE, startX + Math.ceil(canvasWidth / CONFIG.TILE_SIZE) + 2);
            const endY = Math.min(CONFIG.MAP_SIZE, startY + Math.ceil(canvasHeight / CONFIG.TILE_SIZE) + 2);

            for (let y = Math.max(0, startY); y < endY; y++) {
                for (let x = Math.max(0, startX); x < endX; x++) {
                    renderTile(x, y);
                }
            }

            // Render selection
            if (game.selectedBuilding) {
                const sx = game.selectedBuilding.x * CONFIG.TILE_SIZE - game.camera.x;
                const sy = game.selectedBuilding.y * CONFIG.TILE_SIZE - game.camera.y;
                ctx.strokeStyle = '#00d9ff';
                ctx.lineWidth = 2;
                ctx.strokeRect(sx, sy, CONFIG.TILE_SIZE, CONFIG.TILE_SIZE);
            }

            renderMinimap();
        }

        function renderTile(x, y) {
            const tile = game.map[y][x];
            const px = x * CONFIG.TILE_SIZE - game.camera.x;
            const py = y * CONFIG.TILE_SIZE - game.camera.y;
            const size = CONFIG.TILE_SIZE;

            // Base color from Mandelbrot value
            const m = tile.mandelbrot;
            const baseGreen = Math.floor(20 + m * 30);
            ctx.fillStyle = `rgb(${baseGreen - 10}, ${baseGreen + 10}, ${baseGreen - 5})`;
            ctx.fillRect(px, py, size, size);

            // Render based on type
            if (tile.type === 'road') {
                // Check adjacent roads for proper connection rendering
                const hasNorth = y > 0 && game.map[y-1][x].type === 'road';
                const hasSouth = y < CONFIG.MAP_SIZE-1 && game.map[y+1][x].type === 'road';
                const hasWest = x > 0 && game.map[y][x-1].type === 'road';
                const hasEast = x < CONFIG.MAP_SIZE-1 && game.map[y][x+1].type === 'road';

                // Road base
                ctx.fillStyle = '#3a3a4a';
                ctx.fillRect(px, py, size, size);

                // Road pavement (connected segments)
                ctx.fillStyle = '#555566';
                const roadWidth = size * 0.7;
                const roadOffset = (size - roadWidth) / 2;

                // Center piece
                ctx.fillRect(px + roadOffset, py + roadOffset, roadWidth, roadWidth);

                // Extensions to connect to adjacent roads
                if (hasNorth) ctx.fillRect(px + roadOffset, py, roadWidth, roadOffset + 1);
                if (hasSouth) ctx.fillRect(px + roadOffset, py + roadOffset + roadWidth - 1, roadWidth, roadOffset + 1);
                if (hasWest) ctx.fillRect(px, py + roadOffset, roadOffset + 1, roadWidth);
                if (hasEast) ctx.fillRect(px + roadOffset + roadWidth - 1, py + roadOffset, roadOffset + 1, roadWidth);

                // Center line markings (yellow for horizontal, white for vertical)
                ctx.fillStyle = '#888899';
                if ((hasNorth || hasSouth) && !(hasEast && hasWest)) {
                    // Vertical road - draw dashed center line
                    ctx.fillRect(px + size/2 - 1, py + 4, 2, size/4 - 2);
                    ctx.fillRect(px + size/2 - 1, py + size/2 + 2, 2, size/4 - 2);
                }
                if ((hasEast || hasWest) && !(hasNorth && hasSouth)) {
                    // Horizontal road
                    ctx.fillRect(px + 4, py + size/2 - 1, size/4 - 2, 2);
                    ctx.fillRect(px + size/2 + 2, py + size/2 - 1, size/4 - 2, 2);
                }
            } else if (tile.type === 'zone' && !tile.building) {
                const colors = {
                    residential: 'rgba(68, 170, 68, 0.3)',
                    commercial: 'rgba(68, 136, 221, 0.3)',
                    industrial: 'rgba(221, 170, 68, 0.3)'
                };
                ctx.fillStyle = colors[tile.zone];
                ctx.fillRect(px + 1, py + 1, size - 2, size - 2);

                // Zone indicator
                ctx.strokeStyle = colors[tile.zone].replace('0.3', '0.8');
                ctx.lineWidth = 1;
                ctx.setLineDash([2, 2]);
                ctx.strokeRect(px + 2, py + 2, size - 4, size - 4);
                ctx.setLineDash([]);
            } else if (tile.building) {
                renderBuilding(px, py, size, tile.building);
            }

            // Grid lines
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            ctx.strokeRect(px, py, size, size);
        }

        function renderBuilding(px, py, size, building) {
            const colors = {
                residential: { base: '#3a7a3a', roof: '#4a9a4a' },
                commercial: { base: '#3a5a8a', roof: '#4a7aba' },
                industrial: { base: '#8a7a3a', roof: '#aa9a4a' },
                power: { base: '#8a5a2a', roof: '#ffaa00' },
                water: { base: '#3a5a7a', roof: '#4a88ff' },
                park: { base: '#2a6a2a', roof: '#3a8a3a' },
                police: { base: '#3a4a6a', roof: '#5a7aaa' },
                fire: { base: '#7a3a3a', roof: '#aa4a4a' }
            };

            const c = colors[building.type] || colors.residential;

            // Building body
            const margin = 3;
            const height = size - margin * 2;
            const buildingHeight = height * (0.6 + building.level * 0.1);

            ctx.fillStyle = c.base;
            ctx.fillRect(px + margin, py + size - margin - buildingHeight, size - margin * 2, buildingHeight);

            // Roof
            ctx.fillStyle = c.roof;
            ctx.fillRect(px + margin, py + size - margin - buildingHeight, size - margin * 2, 3);

            // Windows (for residential/commercial/industrial)
            if (['residential', 'commercial', 'industrial'].includes(building.type)) {
                ctx.fillStyle = building.powered ? '#ffff99' : '#333';
                for (let wy = 0; wy < 2; wy++) {
                    for (let wx = 0; wx < 2; wx++) {
                        ctx.fillRect(
                            px + margin + 4 + wx * 7,
                            py + size - margin - buildingHeight + 6 + wy * 7,
                            3, 3
                        );
                    }
                }
            }

            // Special icons
            const icons = {
                power: '‚ö°',
                water: 'üíß',
                park: 'üå≥',
                police: 'üöî',
                fire: 'üöí'
            };

            if (icons[building.type]) {
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(icons[building.type], px + size/2, py + size/2 + 4);
            }

            // Utility status indicators
            if (!building.powered && building.type !== 'power') {
                ctx.fillStyle = 'rgba(255,0,0,0.5)';
                ctx.beginPath();
                ctx.arc(px + size - 5, py + 5, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function renderMinimap() {
            const scale = 276 / CONFIG.MAP_SIZE;

            minimapCtx.fillStyle = '#111';
            minimapCtx.fillRect(0, 0, 276, 200);

            for (let y = 0; y < CONFIG.MAP_SIZE; y++) {
                for (let x = 0; x < CONFIG.MAP_SIZE; x++) {
                    const tile = game.map[y][x];
                    let color = '#1a2a1a';

                    if (tile.type === 'road') color = '#555';
                    else if (tile.building?.type === 'residential' || tile.zone === 'residential') color = '#4a4';
                    else if (tile.building?.type === 'commercial' || tile.zone === 'commercial') color = '#48d';
                    else if (tile.building?.type === 'industrial' || tile.zone === 'industrial') color = '#da4';
                    else if (tile.building?.type === 'power') color = '#fa0';
                    else if (tile.building?.type === 'water') color = '#48f';
                    else if (tile.building?.type === 'park') color = '#4a4';

                    minimapCtx.fillStyle = color;
                    minimapCtx.fillRect(x * scale, y * scale, Math.max(1, scale), Math.max(1, scale));
                }
            }

            // Viewport indicator
            const vpX = (game.camera.x / (CONFIG.MAP_SIZE * CONFIG.TILE_SIZE)) * 276;
            const vpY = (game.camera.y / (CONFIG.MAP_SIZE * CONFIG.TILE_SIZE)) * 200;
            const vpW = (canvasWidth / (CONFIG.MAP_SIZE * CONFIG.TILE_SIZE)) * 276;
            const vpH = (canvasHeight / (CONFIG.MAP_SIZE * CONFIG.TILE_SIZE)) * 200;

            minimapCtx.strokeStyle = '#00d9ff';
            minimapCtx.lineWidth = 1;
            minimapCtx.strokeRect(vpX, vpY, vpW, vpH);
        }

        // ========== UI UPDATES ==========
        function updateUI() {
            document.getElementById('money').textContent = '$' + game.money.toLocaleString();
            document.getElementById('population').textContent = game.population.toLocaleString();
            document.getElementById('happiness').textContent = game.happiness + '%';
            document.getElementById('power').textContent = `${game.power.demand}/${game.power.supply}`;
            document.getElementById('water').textContent = `${game.water.demand}/${game.water.supply}`;

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.getElementById('dateDisplay').textContent = `${months[game.month - 1]} ${game.year}`;

            // Demand meters
            updateDemandMeter('r', game.demand.r);
            updateDemandMeter('c', game.demand.c);
            updateDemandMeter('i', game.demand.i);

            // Stats
            document.getElementById('stat-res').textContent = game.stats.residential;
            document.getElementById('stat-com').textContent = game.stats.commercial;
            document.getElementById('stat-ind').textContent = game.stats.industrial;
            document.getElementById('stat-jobs').textContent = game.stats.jobs;

            const employmentRate = Math.min(100, Math.floor((game.stats.jobs / Math.max(1, game.population)) * 100));
            document.getElementById('stat-employment').textContent = employmentRate + '%';
            document.getElementById('employment-bar').style.width = employmentRate + '%';

            // Budget
            const income = calculateIncome();
            const expenses = calculateExpenses();
            document.getElementById('income-res').textContent = '+$' + Math.floor(game.stats.residential * 80 * CONFIG.TAX_RATE);
            document.getElementById('income-com').textContent = '+$' + Math.floor(game.stats.commercial * 150 * CONFIG.TAX_RATE);
            document.getElementById('income-ind').textContent = '+$' + Math.floor(game.stats.industrial * 120 * CONFIG.TAX_RATE);
            document.getElementById('income-total').textContent = '+$' + income;

            document.getElementById('expense-road').textContent = '-$' + (game.stats.roads * CONFIG.MAINTENANCE.road);
            document.getElementById('expense-power').textContent = '-$' + (game.buildings.filter(b => b.type === 'power').length * CONFIG.MAINTENANCE.power);
            document.getElementById('expense-water').textContent = '-$' + (game.buildings.filter(b => b.type === 'water').length * CONFIG.MAINTENANCE.water);
            document.getElementById('expense-services').textContent = '-$' + (game.buildings.filter(b => ['police', 'fire', 'park'].includes(b.type)).length * 100);

            const net = income - expenses;
            const netEl = document.getElementById('net-income');
            netEl.textContent = (net >= 0 ? '+$' : '-$') + Math.abs(net);
            netEl.className = net >= 0 ? 'budget-income' : 'budget-expense';

            // Status indicators
            document.getElementById('power-status').className = 'status-dot ' + (game.power.supply >= game.power.demand ? 'good' : 'bad');
            document.getElementById('water-status').className = 'status-dot ' + (game.water.supply >= game.water.demand ? 'good' : 'bad');
            document.getElementById('crime-status').className = 'status-dot ' + (game.buildings.some(b => b.type === 'police') ? 'good' : 'warning');
            document.getElementById('traffic-status').className = 'status-dot ' + (game.stats.roads > 20 ? 'good' : 'warning');

            // Citizens list
            updateCitizensList();
        }

        function updateDemandMeter(type, value) {
            const bar = document.getElementById(`demand-${type}`);
            const centered = value - 50;
            const width = Math.abs(centered);

            bar.className = 'demand-bar ' + (centered >= 0 ? 'positive' : 'negative');
            bar.style.width = width + '%';
        }

        function updateCitizensList() {
            const list = document.getElementById('citizensList');
            if (game.citizens.length === 0) {
                list.innerHTML = '<div style="color: var(--text-dim); font-size: 12px; text-align: center; padding: 20px;">Citizens will appear as your city grows</div>';
                return;
            }

            list.innerHTML = game.citizens.slice(0, 10).map(c => `
                <div class="citizen-card">
                    <div class="citizen-header">
                        <div class="citizen-avatar" style="background: ${c.avatar}">${c.name.charAt(0)}</div>
                        <div>
                            <div class="citizen-name">${c.name}</div>
                            <div class="citizen-job">${c.job}, Age ${c.age}</div>
                        </div>
                        <div class="citizen-mood">${c.mood}</div>
                    </div>
                    <div class="citizen-story">${c.story}</div>
                </div>
            `).join('');
        }

        // ========== TABS ==========
        function switchTab(tab) {
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.getElementById('stats-content').style.display = tab === 'stats' ? 'block' : 'none';
            document.getElementById('citizens-content').style.display = tab === 'citizens' ? 'block' : 'none';
            document.getElementById('budget-content').style.display = tab === 'budget' ? 'block' : 'none';
        }

        // ========== SPEED CONTROLS ==========
        function setSpeed(speed) {
            game.speed = speed;
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            if (speed === 0) document.getElementById('pauseBtn').classList.add('active');
            else if (speed === 1) document.getElementById('play1Btn').classList.add('active');
            else if (speed === 2) document.getElementById('play2Btn').classList.add('active');
            else if (speed === 3) document.getElementById('play3Btn').classList.add('active');
        }

        // ========== MODALS & TOASTS ==========
        function showModal(title, body) {
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalOverlay').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('visible');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '‚ö†' : '‚Ñπ'}</span> ${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========== SAVE/LOAD ==========
        function saveGame() {
            const saveData = {
                map: game.map,
                buildings: game.buildings,
                citizens: game.citizens,
                money: game.money,
                month: game.month,
                year: game.year,
                demand: game.demand,
                fractalSeed: game.fractalSeed,
                camera: game.camera
            };
            localStorage.setItem(APP_NAME, JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem(APP_NAME);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    Object.assign(game, data);
                } catch (e) {
                    console.warn('Failed to load game:', e);
                }
            }
        }

        function exportCity() {
            const data = {
                map: game.map,
                buildings: game.buildings,
                citizens: game.citizens,
                money: game.money,
                month: game.month,
                year: game.year,
                demand: game.demand,
                fractalSeed: game.fractalSeed,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fractal-city-${game.year}-${game.month}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('City saved!', 'success');
        }

        function importCity(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.assign(game, data);
                    render();
                    updateUI();
                    showToast('City loaded!', 'success');
                } catch (err) {
                    showToast('Invalid save file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function newCity() {
            if (confirm('Start a new city? Current progress will be lost unless you save first.')) {
                localStorage.removeItem(APP_NAME);
                game = {
                    map: [],
                    buildings: [],
                    citizens: [],
                    money: 75000,
                    population: 0,
                    happiness: 82,
                    month: 3,
                    year: 2045,
                    speed: 1,
                    selectedTool: 'pointer',
                    selectedBuilding: null,
                    camera: { x: 0, y: 0 },
                    demand: { r: 65, c: 55, i: 60 },
                    power: { supply: 0, demand: 0 },
                    water: { supply: 0, demand: 0 },
                    stats: { residential: 0, commercial: 0, industrial: 0, roads: 0, jobs: 0 },
                    fractalSeed: Date.now()
                };
                initializeMap();
                generateStarterCity();
                game.camera = { x: 0, y: 0 }; // Reset camera so resize() centers it
                resize();
                render();
                updateUI();
                showToast('Your new city awaits, Mayor!', 'success');
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>
