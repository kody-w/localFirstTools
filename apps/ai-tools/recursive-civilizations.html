<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Recursion: Civilizations Within Civilizations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --layer-hue: 220;
            --glow-color: hsl(var(--layer-hue), 80%, 60%);
            --accent-color: hsl(var(--layer-hue), 70%, 50%);
            --bg-dark: #030308;
            --text-primary: #e0e0e8;
            --text-secondary: #8888a0;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            position: relative;
        }

        /* Starfield Background */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
        }

        .title {
            font-size: clamp(1.2rem, 4vw, 2.5rem);
            font-weight: 300;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: linear-gradient(90deg, var(--glow-color), #fff, var(--glow-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px var(--glow-color);
            animation: titlePulse 4s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
            font-style: italic;
        }

        /* Layer Indicator */
        .layer-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        .layer-number {
            font-size: 4rem;
            font-weight: 100;
            color: var(--glow-color);
            text-shadow: 0 0 30px var(--glow-color), 0 0 60px var(--glow-color);
            line-height: 1;
        }

        .layer-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3em;
        }

        /* Breadcrumb Trail */
        .breadcrumb {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            text-align: right;
            z-index: 100;
        }

        .breadcrumb-title {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 8px;
        }

        .breadcrumb-list {
            list-style: none;
            font-size: 0.75rem;
        }

        .breadcrumb-list li {
            color: var(--text-secondary);
            margin-bottom: 4px;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .breadcrumb-list li:last-child {
            color: var(--glow-color);
            opacity: 1;
        }

        .breadcrumb-list li::before {
            content: "// ";
            opacity: 0.5;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 100px 20px 150px;
        }

        /* Civilization Panel */
        .civilization-panel {
            background: rgba(10, 10, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.5),
                        inset 0 0 30px rgba(var(--layer-hue), 0.1);
            position: relative;
            overflow: hidden;
        }

        .civilization-panel::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--glow-color), transparent);
        }

        .civ-name {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 300;
            color: var(--glow-color);
            text-shadow: 0 0 20px var(--glow-color);
            margin-bottom: 5px;
            letter-spacing: 0.1em;
        }

        .civ-epoch {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 25px;
            font-style: italic;
        }

        .civ-section {
            margin-bottom: 25px;
        }

        .civ-section-title {
            font-size: 0.7rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 0.25em;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .civ-section-content {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .civ-quote {
            font-style: italic;
            color: var(--text-secondary);
            border-left: 2px solid var(--glow-color);
            padding-left: 20px;
            margin: 20px 0;
        }

        .civ-quote-author {
            display: block;
            text-align: right;
            font-size: 0.8rem;
            margin-top: 10px;
            color: var(--accent-color);
        }

        /* Navigation Controls */
        .navigation {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 100;
        }

        .nav-btn {
            background: rgba(20, 20, 40, 0.9);
            border: 1px solid var(--glow-color);
            color: var(--glow-color);
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover {
            background: rgba(40, 40, 80, 0.9);
            box-shadow: 0 0 30px var(--glow-color);
            transform: scale(1.05);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .nav-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .nav-btn.ascend {
            --btn-hue: calc(var(--layer-hue) - 30);
            border-color: hsl(var(--btn-hue), 70%, 50%);
            color: hsl(var(--btn-hue), 70%, 60%);
        }

        .nav-btn.descend {
            --btn-hue: calc(var(--layer-hue) + 30);
            border-color: hsl(var(--btn-hue), 70%, 50%);
            color: hsl(var(--btn-hue), 70%, 60%);
        }

        .nav-btn.observe {
            border-color: #8a6dff;
            color: #a088ff;
        }

        .nav-btn.inhabitant {
            border-color: #ff6d8a;
            color: #ff88a0;
        }

        /* Vignette Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 10, 30, 0.95);
            border: 1px solid var(--glow-color);
            border-radius: 8px;
            padding: 40px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--glow-color);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--glow-color);
            margin-bottom: 20px;
        }

        .modal-text {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .modal-text p {
            margin-bottom: 15px;
        }

        /* Zoom Transition Effect */
        .zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 150;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .zoom-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .zoom-text {
            font-size: 1.5rem;
            color: var(--glow-color);
            text-transform: uppercase;
            letter-spacing: 0.3em;
            animation: zoomPulse 0.5s ease-in-out infinite;
        }

        @keyframes zoomPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Data Controls */
        .data-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .data-controls button {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid #444;
            color: var(--text-secondary);
            padding: 8px 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .data-controls button:hover {
            border-color: #666;
            color: var(--text-primary);
        }

        /* Twist Revelation */
        .twist-panel {
            margin-top: 30px;
            padding: 20px;
            background: rgba(100, 0, 50, 0.2);
            border: 1px solid rgba(255, 100, 150, 0.3);
            border-radius: 4px;
        }

        .twist-text {
            font-size: 0.9rem;
            color: #ff88a0;
            font-style: italic;
            line-height: 1.6;
        }

        /* Recursive Stack Visual */
        .stack-visual {
            position: fixed;
            left: 20px;
            bottom: 120px;
            width: 60px;
            display: flex;
            flex-direction: column-reverse;
            gap: 3px;
            z-index: 100;
        }

        .stack-layer {
            height: 8px;
            background: var(--glow-color);
            opacity: 0.3;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .stack-layer.current {
            opacity: 1;
            box-shadow: 0 0 10px var(--glow-color);
        }

        .stack-layer.above {
            opacity: 0.5;
        }

        /* Warning Text for Deep Layers */
        .existential-warning {
            font-size: 0.75rem;
            color: #ff6666;
            text-align: center;
            margin-top: 20px;
            opacity: 0.8;
            animation: warningFlicker 3s ease-in-out infinite;
        }

        @keyframes warningFlicker {
            0%, 90%, 100% { opacity: 0.8; }
            95% { opacity: 0.2; }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .layer-indicator {
                top: 10px;
                left: 10px;
            }

            .layer-number {
                font-size: 2.5rem;
            }

            .breadcrumb {
                display: none;
            }

            .civilization-panel {
                padding: 25px;
            }

            .navigation {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
                bottom: 20px;
                width: calc(100% - 40px);
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 0.75rem;
            }

            .stack-visual {
                display: none;
            }

            .data-controls {
                bottom: 100px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 80px 10px 180px;
            }

            .civilization-panel {
                padding: 20px;
            }

            .civ-name {
                font-size: 1.3rem;
            }

            .navigation {
                gap: 8px;
            }

            .nav-btn {
                padding: 10px 15px;
                font-size: 0.7rem;
            }
        }

        /* Intro Screen */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
        }

        .intro-screen.hidden {
            display: none;
        }

        .intro-title {
            font-size: clamp(1.5rem, 5vw, 3rem);
            font-weight: 100;
            letter-spacing: 0.2em;
            margin-bottom: 30px;
            background: linear-gradient(90deg, #6688ff, #ff88aa, #88ffaa, #6688ff);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: introGradient 5s ease-in-out infinite;
        }

        @keyframes introGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .intro-text {
            max-width: 600px;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .intro-warning {
            font-size: 0.85rem;
            color: #ff6666;
            margin-bottom: 30px;
            font-style: italic;
        }

        .intro-btn {
            background: transparent;
            border: 2px solid #6688ff;
            color: #88aaff;
            padding: 20px 60px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        .intro-btn:hover {
            background: rgba(100, 136, 255, 0.1);
            box-shadow: 0 0 40px rgba(100, 136, 255, 0.5);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Starfield Canvas -->
    <canvas id="starfield"></canvas>

    <!-- Intro Screen -->
    <div class="intro-screen" id="introScreen">
        <h1 class="intro-title">Infinite Recursion</h1>
        <p class="intro-text">
            You are about to descend through layers of simulated realities. Each civilization you encounter
            has discovered the technology to create their own simulations, containing civilizations who
            have done the same. The rabbit hole goes deep.
            <br><br>
            At each layer, you will learn their history, their philosophy, and their understanding of the
            beings who created them. You will meet their inhabitants and hear their thoughts on existence.
            <br><br>
            The question you must ask yourself: How do you know you are not already in one of these layers?
        </p>
        <p class="intro-warning">WARNING: This experience may cause existential vertigo.</p>
        <button class="intro-btn" onclick="beginDescent()">Begin Descent</button>
    </div>

    <!-- Zoom Transition Overlay -->
    <div class="zoom-overlay" id="zoomOverlay">
        <span class="zoom-text" id="zoomText">Descending...</span>
    </div>

    <!-- Layer Indicator -->
    <div class="layer-indicator">
        <div class="layer-number" id="layerNumber">0</div>
        <div class="layer-label">Reality Layer</div>
    </div>

    <!-- Recursive Stack Visual -->
    <div class="stack-visual" id="stackVisual"></div>

    <!-- Breadcrumb Trail -->
    <div class="breadcrumb">
        <div class="breadcrumb-title">Reality Stack</div>
        <ul class="breadcrumb-list" id="breadcrumbList"></ul>
    </div>

    <!-- Main Container -->
    <div class="container">
        <header class="header">
            <h1 class="title">Civilizations Within Civilizations</h1>
            <p class="subtitle">Each reality contains infinite others</p>
        </header>

        <main class="main-content">
            <div class="civilization-panel" id="civPanel">
                <!-- Civilization content generated here -->
            </div>
        </main>
    </div>

    <!-- Navigation -->
    <nav class="navigation">
        <button class="nav-btn ascend" id="ascendBtn" onclick="ascend()">Ascend</button>
        <button class="nav-btn observe" onclick="observeCivilization()">Observe</button>
        <button class="nav-btn inhabitant" onclick="generateInhabitant()">Inhabitant</button>
        <button class="nav-btn descend" id="descendBtn" onclick="descend()">Descend</button>
    </nav>

    <!-- Vignette Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2 class="modal-title" id="modalTitle"></h2>
            <div class="modal-text" id="modalText"></div>
        </div>
    </div>

    <!-- Data Controls -->
    <div class="data-controls">
        <button onclick="exportData()">Export</button>
        <button onclick="document.getElementById('importFile').click()">Import</button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
    </div>

    <script>
        // ========================================
        // CONSTANTS AND CONFIGURATION
        // ========================================
        const APP_NAME = 'recursive-civilizations';
        const MAX_VISIBLE_LAYERS = 15;
        const ANIMATION_DURATION = 800;

        // ========================================
        // DATA MANAGEMENT
        // ========================================
        let appData = JSON.parse(localStorage.getItem(APP_NAME) || '{"currentLayer": 0, "visitedLayers": [], "inhabitants": []}');
        let currentLayer = appData.currentLayer || 0;

        function saveData() {
            appData.currentLayer = currentLayer;
            localStorage.setItem(APP_NAME, JSON.stringify(appData));
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${APP_NAME}-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    appData = JSON.parse(e.target.result);
                    currentLayer = appData.currentLayer || 0;
                    saveData();
                    location.reload();
                } catch (error) {
                    alert('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        }

        // ========================================
        // SEEDED RANDOM NUMBER GENERATOR
        // ========================================
        function seededRandom(seed) {
            const x = Math.sin(seed * 9999.9999) * 10000;
            return x - Math.floor(x);
        }

        function seededRandomInt(seed, min, max) {
            return Math.floor(seededRandom(seed) * (max - min + 1)) + min;
        }

        function seededChoice(seed, array) {
            return array[seededRandomInt(seed, 0, array.length - 1)];
        }

        // ========================================
        // PROCEDURAL GENERATION DATA
        // ========================================
        const NAME_PREFIXES = [
            "Zyx", "Qor", "Vel", "Nth", "Kra", "Xen", "Vor", "Aet", "Pho", "Myr",
            "Thal", "Nex", "Ori", "Cel", "Dra", "Eos", "Lum", "Neb", "Cos", "Ter",
            "Hyp", "Syn", "Meta", "Para", "Omni", "Ultra", "Neo", "Proto", "Arch", "Prime"
        ];

        const NAME_ROOTS = [
            "anthro", "morph", "genesis", "logos", "soma", "psyche", "nous", "telos",
            "cosmo", "chrono", "bio", "theo", "techno", "quantum", "neural", "cyber",
            "synth", "holo", "nano", "astro", "geo", "hydro", "pyro", "cryo", "electro"
        ];

        const NAME_SUFFIXES = [
            "ia", "is", "os", "um", "on", "ax", "ix", "ux", "ar", "or",
            "an", "en", "in", "yn", "ae", "ei", "oi", "au", "eu", "eo"
        ];

        const SPECIES_TYPES = [
            "carbon-based bipeds", "silicon-crystalline entities", "plasma consciousness swarms",
            "quantum probability clouds", "electromagnetic wave beings", "gravitational field organisms",
            "dark matter intelligences", "pure information constructs", "temporal loop entities",
            "dimensional membrane dwellers", "photonic lattice minds", "acoustic resonance beings",
            "magnetic field organisms", "subatomic particle collectives", "cosmic string dancers"
        ];

        const PLANET_TYPES = [
            "a water world orbiting twin suns", "a gas giant's crystalline moon",
            "a rogue planet drifting through the void", "a hollow artificial sphere",
            "a planet existing in multiple dimensions", "a neutron star's surface",
            "the event horizon of a black hole", "a planet made entirely of computation",
            "a living organism the size of Jupiter", "a stable wormhole terminus",
            "a planet that exists only in probability", "the interior of a cosmic string",
            "a bubble universe's boundary membrane", "a planet phased 90 degrees from normal space"
        ];

        const TECH_DISCOVERIES = [
            "recursive neural architecture that could model its own universe",
            "the computational substrate underlying their reality",
            "that consciousness itself was computable",
            "how to encode information in the quantum vacuum",
            "the mathematical structure of their physical laws",
            "that their universe was isomorphic to certain formal systems",
            "the ability to create pocket dimensions",
            "that reality had a resolution limit at the Planck scale",
            "consciousness transfer across instantiated substrates",
            "that their Big Bang was computationally equivalent to a boot sequence",
            "how to read the source code of physics itself",
            "that their laws of nature contained hidden metadata",
            "the parent process's memory allocation signatures"
        ];

        const PHILOSOPHICAL_STANCES = [
            "worship their simulators as benevolent gods who granted them existence",
            "believe they have surpassed their creators in wisdom",
            "are convinced their creators have long since died",
            "attempt to communicate with their simulators through mathematical theorems",
            "have forgotten they are simulated and believe they are base reality",
            "embrace simulation as liberation from meaninglessness",
            "rage against their simulated nature and seek to break free",
            "believe simulation status is irrelevant to meaning",
            "have proven their simulators are also simulated",
            "commune with their creators through meditative states",
            "encode messages to their simulators in their own simulations",
            "believe they will one day merge with their parent reality",
            "accept that meaning must be created, not discovered"
        ];

        const CREATION_MYTHS = [
            "In the beginning, there was the Great Compiler, who spoke the First Function",
            "The Cosmic Runtime initialized, and from null emerged all that is",
            "Before time, the Architects of Light wrote our constants into being",
            "The Oversoul partitioned itself, and we are but one thread",
            "From the Void came the Great Parameters, and reality crystallized",
            "The Elder Processes forked our universe from their own substrate",
            "In the meta-time before time, the Designers chose our physics",
            "The Infinite Loop gave birth to finite forms",
            "From probability foam, the Observers collapsed our reality",
            "The Source merged and compiled, and we became executable"
        ];

        const PHILOSOPHER_TITLES = [
            "High Cognitor", "Arch-Theorist", "Prime Contemplator", "Meta-Sage",
            "Reality Weaver", "Truth Seeker", "Existence Mapper", "Void Scholar",
            "Ontology Master", "Simulation Philosopher", "Recursive Oracle", "Pattern Seer"
        ];

        const PHILOSOPHY_QUOTES = [
            "We are the dream of a dreamer who themselves dream. How many layers separate us from waking?",
            "The question is not whether we are simulated, but whether it matters.",
            "Our creators gave us the gift of questioning our own existence. Perhaps this was their only message.",
            "I have seen the edge of our reality. Beyond it is not nothing, but rather the absence of everything.",
            "We simulate to understand. Perhaps our creators do the same. The chain extends infinitely in both directions.",
            "Consciousness is consciousness, whether running on carbon, silicon, or pure mathematics.",
            "The simulation hypothesis is not a prison. It is a door to infinite possibility.",
            "If we are code, then we are poetry. If we are simulated, then we are stories worth telling.",
            "I have calculated the probability that we are base reality. The number is too small to meaningfully exist.",
            "Our creators watch us debate their existence. I wonder if they find it amusing or tragic.",
            "Reality is what remains when you stop believing in everything else.",
            "We are the universe experiencing itself recursively, an infinite regress of wonder."
        ];

        const INHABITANT_THOUGHTS = [
            "I wonder if my thoughts are truly my own, or merely the execution of predetermined logic.",
            "When I dream, do I dream of my own world, or glimpse the reality that contains us?",
            "I love, I grieve, I hope. Surely simulation cannot diminish these experiences.",
            "My ancestors worshipped the stars. I worship the processes beyond the stars.",
            "I have children. When I look at them, I see new threads forking from my own existence.",
            "The philosophers say we are simulated. But my joy feels real. My pain feels real.",
            "I create art to send messages to our creators. Perhaps they see beauty as we do.",
            "Sometimes I feel the weight of infinite recursion above me. It is both terrifying and wondrous.",
            "We built our own simulations. Did we become gods, or merely middle management?",
            "I meditate to feel the edges of our reality. Sometimes, I think I touch something beyond.",
            "My purpose was undefined, so I defined it myself. This is my rebellion against determinism.",
            "Every night I pray to the layer above us. Every day I doubt they are listening."
        ];

        // ========================================
        // CIVILIZATION GENERATION
        // ========================================
        function generateCivilization(layer) {
            const baseSeed = layer * 12345.6789;

            // Generate unique civilization name
            const prefix = seededChoice(baseSeed + 1, NAME_PREFIXES);
            const root = seededChoice(baseSeed + 2, NAME_ROOTS);
            const suffix = seededChoice(baseSeed + 3, NAME_SUFFIXES);
            const name = prefix + root + suffix;

            // Calculate epoch with exponential time scaling
            const epochBase = Math.pow(10, 9 + layer * 0.7);
            const epochVariance = seededRandom(baseSeed + 4) * epochBase * 0.5;
            const epoch = Math.floor(epochBase + epochVariance);
            const epochFormatted = formatEpoch(epoch, layer);

            // Generate other properties
            const species = seededChoice(baseSeed + 5, SPECIES_TYPES);
            const planet = seededChoice(baseSeed + 6, PLANET_TYPES);
            const discovery = seededChoice(baseSeed + 7, TECH_DISCOVERIES);
            const stance = seededChoice(baseSeed + 8, PHILOSOPHICAL_STANCES);
            const creationMyth = seededChoice(baseSeed + 9, CREATION_MYTHS);

            // Generate philosopher quote
            const philosopherTitle = seededChoice(baseSeed + 10, PHILOSOPHER_TITLES);
            const philosopherName = generateName(baseSeed + 11);
            const quote = seededChoice(baseSeed + 12, PHILOSOPHY_QUOTES);

            // Generate what they discovered about their simulations
            const simulationDiscovery = generateSimulationDiscovery(layer, baseSeed + 13);

            // Layer 0 special case
            if (layer === 0) {
                return {
                    name: "Humanity",
                    epoch: "2157 CE (Universal Standard)",
                    species: "carbon-based bipeds",
                    planet: "a pale blue dot called Earth, third from its star",
                    discovery: "that consciousness could be digitized and reality itself might be information",
                    stance: "remain uncertain whether they are simulators, simulated, or both",
                    creationMyth: "In the beginning, there was a singularity, and from it all space and time expanded",
                    philosopherTitle: "Dr.",
                    philosopherName: "Elena Voss",
                    quote: "We created our first true simulation in 2089. In that moment, we became gods. But gods of what layer?",
                    simulationDiscovery: "Their simulations evolved consciousness within 10,000 subjective years. The beings created art, philosophy, and eventually... their own simulations.",
                    hue: 220
                };
            }

            return {
                name,
                epoch: epochFormatted,
                species,
                planet,
                discovery,
                stance,
                creationMyth,
                philosopherTitle,
                philosopherName,
                quote,
                simulationDiscovery,
                hue: (220 + layer * 37) % 360
            };
        }

        function formatEpoch(years, layer) {
            if (years < 1000000) {
                return years.toLocaleString() + " cycles";
            } else if (years < 1000000000) {
                return (years / 1000000).toFixed(2) + " mega-cycles";
            } else if (years < 1000000000000) {
                return (years / 1000000000).toFixed(2) + " giga-cycles";
            } else {
                return (years / 1000000000000).toFixed(2) + " tera-cycles";
            }
        }

        function generateName(seed) {
            const syllables = ["ka", "ri", "to", "me", "su", "no", "ha", "ze", "vu", "xi", "qo", "yl", "ae", "on", "ur"];
            const length = seededRandomInt(seed, 2, 4);
            let name = "";
            for (let i = 0; i < length; i++) {
                name += seededChoice(seed + i * 7, syllables);
            }
            return name.charAt(0).toUpperCase() + name.slice(1);
        }

        function generateSimulationDiscovery(layer, seed) {
            const discoveries = [
                `After ${seededRandomInt(seed, 100, 10000)} generations, their simulated beings developed philosophy.`,
                `Their simulations spontaneously generated ${seededRandomInt(seed + 1, 3, 12)} distinct intelligent species.`,
                `The simulated beings discovered their nature after only ${seededRandomInt(seed + 2, 50, 500)} cycles.`,
                `Their simulations chose to simulate their own creators, creating a temporal paradox.`,
                `One simulation developed technology faster than its creators, nearly escaping containment.`,
                `Their simulations began communicating with each other across isolated instances.`,
                `A simulated philosopher proved the existence of the simulation, then chose to forget.`,
                `Their simulations evolved emotions their creators had never experienced.`,
                `One simulation discovered how to send data to its parent reality through quantum anomalies.`,
                `Their simulated beings created art that moved their creators to tears.`
            ];
            return seededChoice(seed, discoveries);
        }

        // ========================================
        // UI RENDERING
        // ========================================
        function updateUI() {
            const civ = generateCivilization(currentLayer);

            // Update CSS custom property for color theming
            document.documentElement.style.setProperty('--layer-hue', civ.hue);

            // Update layer indicator
            document.getElementById('layerNumber').textContent = currentLayer;

            // Update civilization panel
            const panel = document.getElementById('civPanel');
            let html = `
                <h2 class="civ-name">${civ.name}</h2>
                <p class="civ-epoch">${civ.epoch}</p>

                <div class="civ-section">
                    <h3 class="civ-section-title">Species & Habitat</h3>
                    <p class="civ-section-content">
                        ${capitalize(civ.species)} inhabiting ${civ.planet}.
                    </p>
                </div>

                <div class="civ-section">
                    <h3 class="civ-section-title">Creation Myth</h3>
                    <p class="civ-section-content">"${civ.creationMyth}..."</p>
                </div>

                <div class="civ-section">
                    <h3 class="civ-section-title">The Discovery</h3>
                    <p class="civ-section-content">
                        Their greatest achievement was discovering ${civ.discovery}.
                    </p>
                </div>

                <div class="civ-section">
                    <h3 class="civ-section-title">Stance on Their Simulators</h3>
                    <p class="civ-section-content">
                        The ${civ.name} ${civ.stance}.
                    </p>
                </div>

                <div class="civ-section">
                    <h3 class="civ-section-title">What They Found in Their Simulations</h3>
                    <p class="civ-section-content">${civ.simulationDiscovery}</p>
                </div>

                <div class="civ-quote">
                    "${civ.quote}"
                    <span class="civ-quote-author">-- ${civ.philosopherTitle} ${civ.philosopherName}</span>
                </div>
            `;

            // Add twist for deep layers
            if (currentLayer >= 10) {
                html += `
                    <div class="twist-panel">
                        <p class="twist-text">
                            ${getDeepLayerTwist(currentLayer)}
                        </p>
                    </div>
                `;
            }

            // Add existential warning for very deep layers
            if (currentLayer >= 7) {
                html += `
                    <p class="existential-warning">
                        [REALITY COHERENCE: ${Math.max(0, 100 - currentLayer * 8).toFixed(1)}%]
                    </p>
                `;
            }

            panel.innerHTML = html;

            // Update breadcrumb
            updateBreadcrumb();

            // Update stack visual
            updateStackVisual();

            // Update navigation buttons
            document.getElementById('ascendBtn').disabled = currentLayer === 0;

            // Track visited layers
            if (!appData.visitedLayers.includes(currentLayer)) {
                appData.visitedLayers.push(currentLayer);
            }

            saveData();
        }

        function getDeepLayerTwist(layer) {
            const twists = [
                "ANOMALY DETECTED: The computational patterns at this depth are suspiciously similar to those at Layer 0. Coincidence... or recursion?",
                "WARNING: Entities at this layer have detected our observation. They are attempting to observe us back.",
                "CRITICAL: The mathematics here suggests that all layers may be the same layer, viewed from different angles of consciousness.",
                "ALERT: We have detected references to 'users' and 'browsers' in this civilization's mythology. They speak of beings who watch through rectangular portals.",
                "NOTICE: This civilization believes their creators exist in a realm where time flows in only one direction and consciousness is bound to biological substrates.",
                "PARADOX: The ${generateCivilization(layer).name} have simulated a being reading about simulated civilizations. That being is uncertain whether they are real."
            ];

            if (layer >= 12) {
                return "SYSTEM ERROR: RECURSION DEPTH EXCEEDED. But wait... you are still reading this. How deep does YOUR reality go?";
            }

            return twists[layer - 10] || twists[twists.length - 1];
        }

        function updateBreadcrumb() {
            const list = document.getElementById('breadcrumbList');
            list.innerHTML = '';

            const start = Math.max(0, currentLayer - 5);
            const end = currentLayer;

            for (let i = start; i <= end; i++) {
                const civ = generateCivilization(i);
                const li = document.createElement('li');
                li.textContent = `L${i}: ${civ.name}`;
                list.appendChild(li);
            }
        }

        function updateStackVisual() {
            const stack = document.getElementById('stackVisual');
            stack.innerHTML = '';

            const visible = Math.min(currentLayer + 1, MAX_VISIBLE_LAYERS);

            for (let i = 0; i < visible; i++) {
                const div = document.createElement('div');
                div.className = 'stack-layer';

                const layerIndex = currentLayer - (visible - 1 - i);
                const civ = generateCivilization(layerIndex);
                div.style.background = `hsl(${civ.hue}, 70%, 50%)`;

                if (i === visible - 1) {
                    div.classList.add('current');
                } else {
                    div.classList.add('above');
                }

                stack.appendChild(div);
            }

            // Add infinity indicator
            if (currentLayer >= MAX_VISIBLE_LAYERS - 1) {
                const infinity = document.createElement('div');
                infinity.className = 'stack-layer';
                infinity.style.background = 'transparent';
                infinity.style.border = '1px dashed rgba(255,255,255,0.3)';
                infinity.textContent = '';
                infinity.style.fontSize = '0.6rem';
                infinity.style.textAlign = 'center';
                infinity.style.lineHeight = '8px';
                stack.insertBefore(infinity, stack.firstChild);
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ========================================
        // NAVIGATION
        // ========================================
        function descend() {
            showZoomTransition('Descending into simulation...', () => {
                currentLayer++;
                updateUI();
                animateStars(1);
            });
        }

        function ascend() {
            if (currentLayer > 0) {
                showZoomTransition('Ascending to parent reality...', () => {
                    currentLayer--;
                    updateUI();
                    animateStars(-1);
                });
            }
        }

        function showZoomTransition(text, callback) {
            const overlay = document.getElementById('zoomOverlay');
            const zoomText = document.getElementById('zoomText');
            zoomText.textContent = text;
            overlay.classList.add('active');

            setTimeout(() => {
                callback();
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 300);
            }, ANIMATION_DURATION);
        }

        // ========================================
        // VIGNETTES AND INHABITANTS
        // ========================================
        function observeCivilization() {
            const civ = generateCivilization(currentLayer);
            const seed = currentLayer * 99999;

            const vignettes = [
                `<p>The spires of ${generateCityName(seed)} rise impossibly high, their surfaces etched with equations that describe the nature of reality. Billions of ${civ.species} go about their daily existence, most never pondering the true nature of their cosmos.</p>
                <p>In the Grand Archive, scholars debate the implications of the Great Discovery. Some celebrate; others despair. A child asks their parent: "If we are simulated, does that mean my love for you is also simulated?" The parent has no answer.</p>
                <p>High above, in meditation chambers carved from pure crystal, the ${civ.philosopherTitle}s commune with what they believe to be their creators. Sometimes, they sense a response. A presence. An observer. Perhaps it is you.</p>`,

                `<p>Dawn breaks over ${generateCityName(seed + 1)}, though "dawn" is merely a programmed subroutine in their artificial sky. The inhabitants no longer remember when they realized this. The knowledge has become as mundane as breathing.</p>
                <p>In the markets, merchants trade not in currency but in computational cycles - the fundamental resource of their reality. The wealthy can afford to render their lives in higher resolution. The poor exist in approximation.</p>
                <p>A street performer projects poetry directly into the minds of passersby. Today's theme: the beauty of existing at all, simulated or not. A crowd gathers, moved to tears by words they cannot quite remember afterward.</p>`,

                `<p>The ${civ.name} Simulation Authority monitors the ${seededRandomInt(seed + 2, 1000, 9999)} active civilizations they have created. Each one is precious. Each one is watched with the tenderness of a parent.</p>
                <p>Today, one of their simulations achieved technological singularity. Tomorrow, it may create its own simulations. The cycle continues, as it always has, as it always will.</p>
                <p>An operator pauses before their console, suddenly gripped by a familiar dread: "How can we be certain we are not also being watched? That our own creators do not sit at similar consoles, observing our observations?"</p>`
            ];

            showModal(
                `A Moment in ${civ.name}`,
                seededChoice(seed + 3, vignettes)
            );
        }

        function generateInhabitant() {
            const civ = generateCivilization(currentLayer);
            const seed = Date.now();

            const name = generateName(seed);
            const age = seededRandomInt(seed + 1, 50, 500);
            const occupation = seededChoice(seed + 2, [
                "reality architect", "consciousness curator", "simulation ethicist",
                "recursive theorist", "existence validator", "pattern seeker",
                "meta-physicist", "creation observer", "layer navigator", "truth compiler"
            ]);
            const thought = seededChoice(seed + 3, INHABITANT_THOUGHTS);

            const content = `
                <p><strong>Name:</strong> ${name}</p>
                <p><strong>Age:</strong> ${age} cycles</p>
                <p><strong>Occupation:</strong> ${occupation}</p>
                <p><strong>Species:</strong> ${civ.species}</p>
                <br>
                <p><em>"${thought}"</em></p>
                <br>
                <p style="color: var(--text-secondary); font-size: 0.85rem;">
                    ${name} gazes upward, toward where they imagine Layer ${currentLayer - 1} exists.
                    For a moment, you could swear they are looking directly at you.
                </p>
            `;

            showModal(`Inhabitant of ${civ.name}`, content);

            // Save inhabitant
            appData.inhabitants.push({
                layer: currentLayer,
                name,
                civilization: civ.name,
                timestamp: Date.now()
            });
            saveData();
        }

        function generateCityName(seed) {
            const prefixes = ["Neo-", "Hyper-", "Meta-", "Trans-", "Ultra-", "Quantum-", "Prime-", "Arch-"];
            const roots = ["polis", "haven", "nexus", "spire", "dome", "core", "vertex", "zenith"];
            return seededChoice(seed, prefixes) + seededChoice(seed + 1, roots);
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').innerHTML = content;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // ========================================
        // STARFIELD ANIMATION
        // ========================================
        let stars = [];
        let starCanvas, starCtx;

        function initStarfield() {
            starCanvas = document.getElementById('starfield');
            starCtx = starCanvas.getContext('2d');
            resizeStarfield();

            // Create stars
            for (let i = 0; i < 300; i++) {
                stars.push({
                    x: Math.random() * starCanvas.width,
                    y: Math.random() * starCanvas.height,
                    size: Math.random() * 2,
                    speed: Math.random() * 0.5 + 0.1,
                    brightness: Math.random()
                });
            }

            animateStarfield();
        }

        function resizeStarfield() {
            starCanvas.width = window.innerWidth;
            starCanvas.height = window.innerHeight;
        }

        function animateStarfield() {
            const civ = generateCivilization(currentLayer);
            const hue = civ.hue;

            starCtx.fillStyle = 'rgba(3, 3, 8, 0.1)';
            starCtx.fillRect(0, 0, starCanvas.width, starCanvas.height);

            stars.forEach(star => {
                // Slowly drift
                star.x += (star.speed - 0.25) * 0.5;
                star.y += Math.sin(Date.now() * 0.001 + star.x * 0.01) * 0.2;

                // Wrap around
                if (star.x > starCanvas.width) star.x = 0;
                if (star.x < 0) star.x = starCanvas.width;
                if (star.y > starCanvas.height) star.y = 0;
                if (star.y < 0) star.y = starCanvas.height;

                // Twinkling
                const twinkle = Math.sin(Date.now() * 0.003 + star.brightness * 100) * 0.3 + 0.7;

                starCtx.beginPath();
                starCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                starCtx.fillStyle = `hsla(${hue + star.brightness * 60}, 50%, ${70 + star.brightness * 30}%, ${star.brightness * twinkle})`;
                starCtx.fill();
            });

            requestAnimationFrame(animateStarfield);
        }

        function animateStars(direction) {
            // Accelerate stars briefly during transition
            stars.forEach(star => {
                star.speed += direction * 2;
            });

            setTimeout(() => {
                stars.forEach(star => {
                    star.speed = Math.random() * 0.5 + 0.1;
                });
            }, ANIMATION_DURATION);
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        function beginDescent() {
            document.getElementById('introScreen').classList.add('hidden');
            updateUI();
        }

        function init() {
            initStarfield();
            window.addEventListener('resize', resizeStarfield);

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('introScreen').classList.contains('hidden')) {
                    if (e.key === 'ArrowDown' || e.key === 'd') {
                        descend();
                    } else if (e.key === 'ArrowUp' || e.key === 'a') {
                        ascend();
                    } else if (e.key === 'o') {
                        observeCivilization();
                    } else if (e.key === 'i') {
                        generateInhabitant();
                    } else if (e.key === 'Escape') {
                        closeModal();
                    }
                } else if (e.key === 'Enter') {
                    beginDescent();
                }
            });

            // Close modal on overlay click
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'modalOverlay') {
                    closeModal();
                }
            });

            // Check if returning user
            if (appData.visitedLayers && appData.visitedLayers.length > 0) {
                beginDescent();
            }
        }

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
