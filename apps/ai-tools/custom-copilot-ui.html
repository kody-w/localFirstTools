<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAC (Migration Assessment Copilot) - Automated Actions</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --power-purple: #742774;
            --power-purple-light: #9168b6;
            --power-purple-dark: #4f1c4f;
            --ms-gray-10: #faf9f8;
            --ms-gray-20: #f3f2f1;
            --ms-gray-30: #edebe9;
            --ms-gray-40: #e1dfdd;
            --ms-gray-100: #323130;
            --ms-gray-130: #242424;
            --header-height: 48px;
            --footer-height: 68px;
            --shadow-small: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 4px;
        }

        @font-face {
            font-family: "Segoe UI Web";
            src: local("Segoe UI");
            font-weight: normal;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Segoe UI Web", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--ms-gray-10);
            color: var(--ms-gray-100);
            line-height: 1.5;
        }

        .app-container {
            display: grid;
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: var(--shadow-medium);
        }

        .header {
            background: var(--power-purple);
            color: white;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-small);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .header-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            padding: 20px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--power-purple);
        }

        .quick-actions {
            margin-bottom: 24px;
        }

        .icon-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .text-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .text-icon:hover {
            transform: translateY(-3px);
        }

        .icon-symbol {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background-color: var(--power-purple);
            color: white;
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .icon-label {
            font-size: 12px;
            color: var(--ms-gray-100);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--ms-gray-30);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .agent-badge {
            display: inline-block;
            background-color: rgba(116, 39, 116, 0.1);
            color: var(--power-purple);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--ms-gray-100);
        }

        .card-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            height: 60px;
            overflow: hidden;
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            width: 100%;
        }

        .button-primary {
            background-color: var(--power-purple);
            color: white;
        }

        .button-primary:hover {
            background-color: var(--power-purple-dark);
        }

        .response-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 16px;
            margin-top: 24px;
            border: 1px solid var(--ms-gray-30);
        }

        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .response-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--power-purple);
        }

        .response-content {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
            background-color: var(--ms-gray-20);
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        .response-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }

        .response-content strong {
            font-weight: 600;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(116, 39, 116, 0.3);
            border-radius: 50%;
            border-top-color: var(--power-purple);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #666;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .status-success {
            background-color: #ECFAED;
            color: #107C10;
            border-left: 4px solid #107C10;
        }

        .status-error {
            background-color: #FDEFE8;
            color: #D83B01;
            border-left: 4px solid #D83B01;
        }

        .import-export {
            margin-top: 24px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .button-secondary {
            background-color: var(--ms-gray-20);
            color: var(--ms-gray-100);
        }

        .button-secondary:hover {
            background-color: var(--ms-gray-30);
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--power-purple);
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid var(--power-purple);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .file-label:hover {
            background-color: rgba(116, 39, 116, 0.05);
        }

        /* MAC Logo SVG styles */
        .mac-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        /* Dark mode styles */
        body.dark {
            background: var(--ms-gray-130);
            color: white;
        }

        body.dark .app-container {
            background: var(--ms-gray-100);
        }

        body.dark .card {
            background: var(--ms-gray-100);
            border-color: var(--ms-gray-40);
        }

        body.dark .response-container {
            background: var(--ms-gray-100);
            border-color: var(--ms-gray-40);
        }

        body.dark .response-content {
            background-color: var(--ms-gray-130);
            color: white;
        }

        body.dark .button-secondary {
            background-color: var(--ms-gray-130);
            color: white;
        }

        body.dark .card-title {
            color: white;
        }

        body.dark .icon-label {
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            width: 500px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--power-purple);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        body.dark .modal-content {
            background-color: var(--ms-gray-100);
        }

        body.dark .modal-title {
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .icon-container {
                justify-content: center;
            }

            .grid-container {
                grid-template-columns: 1fr;
            }

            .import-export {
                flex-direction: column;
                align-items: stretch;
            }

            .button, .file-label {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <!-- Custom MAC (Migration Assessment Copilot) Logo SVG -->
                    <svg class="mac-logo" viewBox="0 0 24 24" width="24" height="24">
                        <circle cx="12" cy="12" r="11" fill="#742774" />
                        <path d="M7 9L12 6L17 9V15L12 18L7 15V9Z" fill="white" stroke="#742774" stroke-width="0.5" />
                        <path d="M12 6V12M12 12V18M12 12L7 9M12 12L17 9" stroke="white" stroke-width="1.2" />
                        <circle cx="12" cy="12" r="2" fill="white" />
                    </svg>
                </div>
                <div class="logo-text">MAC (Migration Assessment Copilot)</div>
            </div>
            <div class="header-controls">
                <button class="header-button" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                    <span>Theme</span>
                </button>
                <button class="header-button" id="settings-button">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </div>
        </header>

        <main class="main-content">
            <section class="quick-actions">
                <h2 class="section-title">Quick Actions</h2>
                <div class="icon-container">
                    <div class="text-icon" onclick="sendStatusEmail()">
                        <div class="icon-symbol">📧</div>
                        <div class="icon-label">Status Update</div>
                    </div>
                    
                    <div class="text-icon" onclick="scheduleClientMeeting()">
                        <div class="icon-symbol">📅</div>
                        <div class="icon-label">Schedule Meeting</div>
                    </div>
                    
                    <div class="text-icon" onclick="getOpportunities()">
                        <div class="icon-symbol">💼</div>
                        <div class="icon-label">Opportunities</div>
                    </div>
                    
                    <div class="text-icon" onclick="createLead()">
                        <div class="icon-symbol">👤</div>
                        <div class="icon-label">New Lead</div>
                    </div>
                    
                    <div class="text-icon" onclick="saveDailySummary()">
                        <div class="icon-symbol">📝</div>
                        <div class="icon-label">Save Summary</div>
                    </div>
                    
                    <div class="text-icon" onclick="recallContext()">
                        <div class="icon-symbol">🔍</div>
                        <div class="icon-label">Recall Context</div>
                    </div>
                    
                    <div class="text-icon" id="processDocsIcon">
                        <div class="icon-symbol">📄</div>
                        <div class="icon-label">Process Docs</div>
                    </div>
                    
                    <div class="text-icon" id="autoAnswerIcon">
                        <div class="icon-symbol">❓</div>
                        <div class="icon-label">Auto-Answer</div>
                    </div>
                </div>
            </section>

            <div id="statusMessage" class="status-message"></div>

            <section class="predefined-actions">
                <h2 class="section-title">Predefined Actions</h2>
                <div class="grid-container">
                    <!-- Email Actions -->
                    <div class="card">
                        <span class="agent-badge">EmailDrafting Agent</span>
                        <div class="card-title">Send Status Update Email</div>
                        <div class="card-description">
                            Send a weekly status update to your team lead with project progress and metrics.
                        </div>
                        <button class="button button-primary" onclick="sendStatusEmail()">Run Action</button>
                    </div>
                    
                    <div class="card">
                        <span class="agent-badge">EmailDrafting Agent</span>
                        <div class="card-title">Schedule Client Meeting</div>
                        <div class="card-description">
                            Send a professional email to schedule a meeting with a client including agenda and details.
                        </div>
                        <button class="button button-primary" onclick="scheduleClientMeeting()">Run Action</button>
                    </div>
                    
                    <!-- Dynamics 365 Actions -->
                    <div class="card">
                        <span class="agent-badge">Dynamics365CRUD Agent</span>
                        <div class="card-title">View My Opportunities</div>
                        <div class="card-description">
                            Retrieve all active sales opportunities assigned to you from Dynamics 365.
                        </div>
                        <button class="button button-primary" onclick="getOpportunities()">Run Action</button>
                    </div>
                    
                    <div class="card">
                        <span class="agent-badge">Dynamics365CRUD Agent</span>
                        <div class="card-title">Create Lead from Business Card</div>
                        <div class="card-description">
                            Create a new lead in Dynamics 365 using scanned business card information.
                        </div>
                        <button class="button button-primary" onclick="createLead()">Run Action</button>
                    </div>
                    
                    <!-- Memory Actions -->
                    <div class="card">
                        <span class="agent-badge">ManageMemory Agent</span>
                        <div class="card-title">Save Daily Summary</div>
                        <div class="card-description">
                            Save a summary of today's activities and outcomes to your personal memory.
                        </div>
                        <button class="button button-primary" onclick="saveDailySummary()">Run Action</button>
                    </div>
                    
                    <div class="card">
                        <span class="agent-badge">ContextMemory Agent</span>
                        <div class="card-title">Recall Previous Interactions</div>
                        <div class="card-description">
                            Retrieve context from your previous interactions with clients and projects.
                        </div>
                        <button class="button button-primary" onclick="recallContext()">Run Action</button>
                    </div>
                </div>
            </section>

            <section class="imported-actions">
                <h2 class="section-title">Imported Actions</h2>
                <div class="grid-container" id="importedActionsContainer">
                    <!-- Process Documents -->
                    <div class="card">
                        <span class="agent-badge">SOWAutoAnswerEfficient Agent</span>
                        <div class="card-title">Process Documents</div>
                        <div class="card-description">
                            Process document files for analysis and prepare them for question answering.
                        </div>
                        <button class="button button-primary" onclick="processDocuments()">Run Action</button>
                    </div>
                    
                    <!-- Auto Answer Questions -->
                    <div class="card">
                        <span class="agent-badge">SOWAutoAnswerEfficient Agent</span>
                        <div class="card-title">Auto-Answer Questions</div>
                        <div class="card-description">
                            Automatically answer questions from processed documents based on confidence thresholds.
                        </div>
                        <button class="button button-primary" onclick="autoAnswerQuestions()">Run Action</button>
                    </div>
                </div>
            </section>

            <div class="import-export">
                <input type="file" id="fileInput" class="file-input" accept=".json">
                <label for="fileInput" class="file-label">
                    <i class="fas fa-file-import"></i>
                    Import Conversation
                </label>
                <button id="exportBtn" class="button button-secondary">
                    <i class="fas fa-file-export"></i>
                    Export Actions
                </button>
                <button id="clearCustomBtn" class="button button-secondary">
                    <i class="fas fa-trash"></i>
                    Clear Imported Actions
                </button>
            </div>

            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div class="loading-text">Processing your request...</div>
            </div>

            <div class="response-container">
                <div class="response-header">
                    <div class="response-title">Response</div>
                    <button id="clearResponseBtn" class="button button-secondary" style="width: auto;">Clear</button>
                </div>
                <div class="response-content" id="responseContent"></div>
            </div>
        </main>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal" id="jsonModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Export Actions</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="jsonContent" placeholder="Paste JSON here or view exported JSON" style="width: 100%; height: 200px; padding: 8px; font-family: monospace;"></textarea>
            </div>
            <div class="modal-footer">
                <button class="button button-secondary" id="modalCancel">Cancel</button>
                <button class="button button-primary" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // User GUID for memory operations
        const userGuid = "7b8e8f63-4d1b-42f0-95c2-d24b12345678";
        const apiUrl = "/api/businessinsightbot_function";
        
        // Store custom actions
        let customActions = [];
        
        // DOM elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const responseContent = document.getElementById('responseContent');
        const statusMessage = document.getElementById('statusMessage');
        const importedActionsContainer = document.getElementById('importedActionsContainer');
        const fileInput = document.getElementById('fileInput');
        const exportBtn = document.getElementById('exportBtn');
        const clearCustomBtn = document.getElementById('clearCustomBtn');
        const clearResponseBtn = document.getElementById('clearResponseBtn');
        const themeToggle = document.getElementById('theme-toggle');
        
        // Modal elements
        const jsonModal = document.getElementById('jsonModal');
        const modalTitle = document.getElementById('modalTitle');
        const jsonContent = document.getElementById('jsonContent');
        const modalClose = document.getElementById('modalClose');
        const modalCancel = document.getElementById('modalCancel');
        const modalConfirm = document.getElementById('modalConfirm');
        
        // Show loading indicator
        function showLoading() {
            loadingIndicator.style.display = 'flex';
        }
        
        // Hide loading indicator
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }
        
        // Show status message
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError 
                ? 'status-message status-error' 
                : 'status-message status-success';
            statusMessage.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Format response with markdown-like syntax highlighting
        function formatResponse(text) {
            if (!text) return '';
            
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^#\s+(.*?)$/gm, '<h1>$1</h1>')
                .replace(/^##\s+(.*?)$/gm, '<h2>$1</h2>')
                .replace(/^###\s+(.*?)$/gm, '<h3>$1</h3>')
                .replace(/\n/g, '<br>');
        }
        
        // Send request to API
        async function sendRequest(message) {
            showLoading();
            responseContent.innerHTML = '';
            
            try {
                // For demo purposes, we'll simulate the API call
                const simulateAPI = true;
                
                if (simulateAPI) {
                    // Wait for a simulated response time
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Generate a simulated response based on the message
                    let simulatedResponse;
                    
                    if (message.includes('EmailDrafting')) {
                        simulatedResponse = {
                            assistant_response: "**Email Action Completed**\n\nI've processed your email request with the following details:\n\n- **Subject**: " + 
                                (message.includes("Status Update") ? "Weekly Status Update - Project Alpha" : "Proposal Discussion - [Client Company]") + 
                                "\n- **Sent to**: " + (message.includes("Status Update") ? "manager@example.com" : "client@example.com") + 
                                "\n- **Status**: Success\n\nThe email has been drafted and sent through the EmailDrafting agent. Is there anything else you would like me to help with?",
                            user_guid: userGuid
                        };
                    } else if (message.includes('Dynamics365CRUD')) {
                        if (message.includes('opportunities')) {
                            simulatedResponse = {
                                assistant_response: "**Active Opportunities Retrieved**\n\nI've queried your active opportunities from Dynamics 365:\n\n1. **Enterprise Cloud Migration** - $120,000 (75% probability)\n2. **Data Analytics Platform** - $85,500 (60% probability)\n3. **Security Compliance Assessment** - $45,000 (90% probability)\n\nTotal potential value: **$250,500**\n\nWould you like more details about any specific opportunity?",
                                user_guid: userGuid
                            };
                        } else {
                            simulatedResponse = {
                                assistant_response: "**Lead Created Successfully**\n\nI've created a new lead in Dynamics 365:\n\n- **Name**: John Smith\n- **Company**: Innovative Tech Solutions\n- **Position**: CTO\n- **Contact**: john.smith@innovativetech.example.com\n- **Phone**: (555) 123-4567\n- **Status**: New\n- **Source**: Direct Input\n\nThe lead has been assigned to your queue. Would you like to add any additional information to this lead?",
                                user_guid: userGuid
                            };
                        }
                    } else if (message.includes('ManageMemory')) {
                        simulatedResponse = {
                            assistant_response: "**Daily Summary Saved**\n\nI've saved today's summary to your personal memory:\n\n- **Theme**: Daily Summary\n- **Memory ID**: daily-summary-" + new Date().toISOString().slice(0, 10) + "\n- **Status**: Successfully stored\n\nYour daily activities and accomplishments have been recorded for future reference. You can recall this information later using the ContextMemory agent.",
                            user_guid: userGuid
                        };
                    } else if (message.includes('ContextMemory')) {
                        simulatedResponse = {
                            assistant_response: "**Previous Interactions Retrieved**\n\nHere's what I remember from your previous conversations:\n\n- On 2025-03-15, you discussed project timelines for the Enterprise Cloud Migration with the client team\n- On 2025-03-16, you recorded completion of the security assessment documentation\n- On 2025-03-17, you saved notes about the upcoming quarterly business review\n\nIs there any specific information from these interactions you'd like me to elaborate on?",
                            user_guid: userGuid
                        };
                    } else if (message === 'process_documents') {
                        simulatedResponse = {
                            assistant_response: "**Document Processing Complete**\n\n- **File Processed**: `folder (2).txt`\n- **Chunks Processed**: 23\n- **Processing Timestamp**: " + new Date().toISOString() + "\n\nIf there is anything more you need regarding the processed document or further actions,let me know!",
                            user_guid: userGuid
                        };
                    } else if (message === 'auto_answer_questions') {
                        simulatedResponse = {
                            assistant_response: "**Auto-Answer Process Complete**\n\n- **Questions Processed**: 5\n- **Questions Auto-Answered**: 0 (with confidence >= 0.85)\n\nIt seems there were no questions with high enough confidence to be auto-answered. If you need any further assistance or have specific requirements, feel free to let me know!",
                            user_guid: userGuid
                        };
                    } else {
                        simulatedResponse = {
                            assistant_response: "I've processed your request, but I'm not sure how to handle it specifically. Could you provide more details about what you're trying to do?",
                            user_guid: userGuid
                        };
                    }
                    
                    responseContent.innerHTML = formatResponse(simulatedResponse.assistant_response);
                } else {
                    // Real API call
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_input: message,
                            conversation_history: [],
                            user_guid: userGuid
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }
                    
                    const data = await response.json();
                    responseContent.innerHTML = formatResponse(data.assistant_response);
                }
            } catch (error) {
                console.error('Error:', error);
                responseContent.innerHTML = `<div style="color: #D83B01;">Error: ${error.message}</div>`;
                showStatus(`Failed to process request: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        }
        
        // Default action handlers
        function sendStatusEmail() {
            const message = `Use the EmailDrafting agent to send a weekly status update email with the following parameters:
                subject: "Weekly Status Update - Project Alpha",
                to: "manager@example.com",
                cc: ["team@example.com"],
                body: "Hello Team,\n\nHere is this week's status update for Project Alpha:\n\n- Completed user authentication module\n- Fixed 3 critical bugs in payment processing\n- Started work on reporting dashboard\n\nCurrent velocity: 85% of planned sprint points\nRisks: Third-party API integration may be delayed\n\nPlease let me know if you have any questions.\n\nBest regards,\n[User Name]",
                importance: "normal"`;
            
            sendRequest(message);
        }
        
        function scheduleClientMeeting() {
            const message = `Use the EmailDrafting agent to send a client meeting invitation with the following parameters:
                subject: "Proposal Discussion - [Client Company]",
                to: "client@example.com",
                cc: ["account.manager@ourcompany.com"],
                body: "Dear [Client Name],\n\nI hope this email finds you well. I would like to schedule a meeting to discuss our proposal for the [Project Name] initiative.\n\nProposed times (EST):\n- Thursday, March 20th at 2:00 PM\n- Friday, March 21st at 10:00 AM\n\nAgenda:\n1. Review of requirements\n2. Discussion of proposed solutions\n3. Timeline and next steps\n\nPlease let me know which time works best for you, or suggest an alternative.\n\nBest regards,\n[Your Name]\n[Your Title]\n[Phone Number]",
                importance: "high"`;
            
            sendRequest(message);
        }
        
        function getOpportunities() {
            const message = `Use the Dynamics365CRUD agent to retrieve my active opportunities with the following parameters:
                operation: "query",
                entity: "opportunities",
                fetchxml: "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'><entity name='opportunity'><attribute name='name'/><attribute name='estimatedvalue'/><attribute name='closeprobability'/><attribute name='createdon'/><filter type='and'><condition attribute='statecode' operator='eq' value='0'/><condition attribute='ownerid' operator='eq-userid'/></filter></entity></fetch>",
                select: "name,estimatedvalue,closeprobability,createdon"`;
            
            sendRequest(message);
        }
        
        function createLead() {
            const message = `Use the Dynamics365CRUD agent to create a new lead with the following parameters:
                operation: "create",
                entity: "leads",
                data: {"firstname":"John","lastname":"Smith","jobtitle":"CTO","companyname":"Innovative Tech Solutions","emailaddress1":"john.smith@innovativetech.example.com","telephone1":"(555) 123-4567","leadsourcecode":1,"description":"Met at the Tech Conference. Interested in our cloud solutions package."}`;
            
            sendRequest(message);
        }
        
        function saveDailySummary() {
            const today = new Date().toISOString().slice(0, 10);
            
            const message = `Use the ManageMemory agent to save a daily summary with the following parameters:
                conversation_id: "daily-summary-${today}",
                session_id: "automated-ui-session",
                conversation_context: "Today I completed the product demo for Client ABC, prepared the quarterly report for the executive team, and resolved the integration issue with the payment gateway. Client ABC was impressed with the demo and requested a follow-up meeting next week to discuss contract details. The quarterly report shows a 12% increase in customer satisfaction and 8% growth in recurring revenue.",
                companion_id: "BusinessInsightBot",
                mood: "productive",
                theme: "daily summary",
                user_guid: "${userGuid}"`;
            
            sendRequest(message);
        }
        
        function recallContext() {
            const message = `Use the ContextMemory agent to retrieve my conversation history and previous interactions with the following parameters:
                user_guid: "${userGuid}"`;
            
            sendRequest(message);
        }
        
        function processDocuments() {
            const message = `process_documents`;
            sendRequest(message);
        }
        
        function autoAnswerQuestions() {
            const message = `auto_answer_questions`;
            sendRequest(message);
        }
        
        // Parse conversation JSON
        function parseConversationJSON(json) {
            try {
                const data = JSON.parse(json);
                const extracted = [];
                
                // Check if it's a valid conversation
                if (!data.conversation || !Array.isArray(data.conversation)) {
                    throw new Error('Invalid conversation format');
                }
                
                // Extract commands from user messages
                for (let i = 0; i < data.conversation.length; i++) {
                    const message = data.conversation[i];
                    
                    // Only look at user messages
                    if (message.role === 'user') {
                        const content = message.content.trim();
                        
                        // Extract command-like messages
                        if (content && (
                            content.startsWith('process_documents') ||
                            content.startsWith('auto_answer_questions') ||
                            content.includes('agent') || 
                            content.includes('Agent') ||
                            content.includes('Use the') ||
                            content.toLowerCase().includes('parameters')
                        )) {
                            // Create a nice title based on the content
                            let title = content;
                            
                            if (content === 'process_documents') {
                                title = 'Process Documents';
                            } else if (content === 'auto_answer_questions') {
                                title = 'Auto-Answer Questions';
                            } else if (content.length > 50) {
                                title = content.substring(0, 47) + '...';
                            }
                            
                            // Determine agent type
                            let agentType = 'Custom Agent';
                            if (content.includes('EmailDrafting')) {
                                agentType = 'EmailDrafting Agent';
                            } else if (content.includes('Dynamics365CRUD')) {
                                agentType = 'Dynamics365CRUD Agent';
                            } else if (content.includes('ManageMemory')) {
                                agentType = 'ManageMemory Agent';
                            } else if (content.includes('ContextMemory')) {
                                agentType = 'ContextMemory Agent';
                            } else if (content.includes('process_documents') || content.includes('auto_answer_questions')) {
                                agentType = 'SOWAutoAnswerEfficient Agent';
                            }
                            
                            // Get a short description
                            let description = 'Custom command from imported conversation.';
                            
                            if (content.includes('email')) {
                                description = 'Send an email with specific parameters.';
                            } else if (content.includes('opportunities')) {
                                description = 'Retrieve active sales opportunities from Dynamics 365.';
                            } else if (content.includes('lead')) {
                                description = 'Create a new sales lead in Dynamics 365.';
                            } else if (content.includes('memory') || content.includes('Memory')) {
                                description = 'Save or retrieve memory information.';
                            } else if (content === 'process_documents') {
                                description = 'Process document files for analysis.';
                            } else if (content === 'auto_answer_questions') {
                                description = 'Automatically answer questions from processed documents.';
                            }
                            
                            extracted.push({
                                id: `imported-action-${extracted.length + 1}`,
                                title: title,
                                agentType: agentType,
                                description: description,
                                content: content
                            });
                        }
                    }
                }
                
                return extracted;
            } catch (error) {
                console.error('Error parsing JSON:', error);
                showStatus(`Failed to parse JSON: ${error.message}`, true);
                return [];
            }
        }
        
        // Add imported actions to UI
        function addImportedActions(actions) {
            if (!actions || actions.length === 0) return;
            
            const container = document.getElementById('importedActionsContainer');
            
            actions.forEach(action => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.id = action.id;
                
                card.innerHTML = `
                    <span class="agent-badge">${action.agentType}</span>
                    <div class="card-title">${action.title}</div>
                    <div class="card-description">
                        ${action.description}
                    </div>
                    <button class="button button-primary">Run Action</button>
                `;
                
                card.querySelector('button').addEventListener('click', () => {
                    sendRequest(action.content);
                });
                
                container.appendChild(card);
            });
        }
        
        // Event Listeners
        document.getElementById('processDocsIcon').addEventListener('click', processDocuments);
        document.getElementById('autoAnswerIcon').addEventListener('click', autoAnswerQuestions);
        
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonContent = e.target.result;
                    const newActions = parseConversationJSON(jsonContent);
                    
                    if (newActions.length > 0) {
                        customActions = [...customActions, ...newActions];
                        addImportedActions(newActions);
                        showStatus(`Successfully imported ${newActions.length} actions from conversation`);
                    } else {
                        showStatus('No actionable commands found in the imported conversation', true);
                    }
                } catch (error) {
                    showStatus(`Failed to import: ${error.message}`, true);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            fileInput.value = '';
        });
        
        exportBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Export Actions';
            jsonContent.value = JSON.stringify({
                defaultActions: [
                    { action: 'sendStatusEmail', title: 'Send Status Update Email' },
                    { action: 'scheduleClientMeeting', title: 'Schedule Client Meeting' },
                    { action: 'getOpportunities', title: 'View My Opportunities' },
                    { action: 'createLead', title: 'Create Lead from Business Card' },
                    { action: 'saveDailySummary', title: 'Save Daily Summary' },
                    { action: 'recallContext', title: 'Recall Previous Interactions' },
                    { action: 'processDocuments', title: 'Process Documents' },
                    { action: 'autoAnswerQuestions', title: 'Auto-Answer Questions' }
                ],
                customActions: customActions
            }, null, 2);
            
            // Configure modal for export
            modalConfirm.style.display = 'none';
            modalCancel.textContent = 'Close';
            
            jsonModal.style.display = 'flex';
        });
        
        clearCustomBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear imported actions?')) {
                // Remove all custom action cards
                const container = document.getElementById('importedActionsContainer');
                const customCards = container.querySelectorAll('[data-id^="imported-action"]');
                customCards.forEach(card => card.remove());
                
                customActions = [];
                showStatus('Imported actions cleared');
            }
        });
        
        clearResponseBtn.addEventListener('click', () => {
            responseContent.innerHTML = '';
        });
        
        // Modal close handlers
        modalClose.addEventListener('click', () => {
            jsonModal.style.display = 'none';
        });
        
        modalCancel.addEventListener('click', () => {
            jsonModal.style.display = 'none';
        });
        
        modalConfirm.addEventListener('click', () => {
            // For future import functionality
            jsonModal.style.display = 'none';
        });
        
        // Close modal if clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === jsonModal) {
                jsonModal.style.display = 'none';
            }
        });
        
        // Theme toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            
            const icon = themeToggle.querySelector('i');
            if (document.body.classList.contains('dark')) {
                icon.classList.replace('fa-moon', 'fa-sun');
            } else {
                icon.classList.replace('fa-sun', 'fa-moon');
            }
            
            // Save theme preference
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        });
        
        // Initialize theme based on saved preference
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark');
            themeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
        }
    </script>
</body>
</html>