<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database File Viewer</title>
    
    <!-- Load SQL.js from CDN for SQLite database handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #718096;
            font-size: 16px;
        }
        
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f7fafc;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .upload-area.drag-over {
            border-color: #667eea;
            background: #e9d8fd;
            transform: scale(1.02);
        }
        
        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-icon svg {
            width: 40px;
            height: 40px;
            fill: white;
        }
        
        .upload-text {
            font-size: 20px;
            color: #4a5568;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .upload-subtext {
            font-size: 14px;
            color: #718096;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .file-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .file-size {
            color: #718096;
            font-size: 14px;
        }
        
        .tables-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .tables-section.show {
            display: block;
        }
        
        .section-title {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .table-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .table-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .table-button.active {
            background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
        }
        
        .data-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .data-section.show {
            display: block;
        }
        
        .table-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-name {
            font-size: 20px;
            color: #2d3748;
            font-weight: 600;
        }
        
        .row-count {
            background: #edf2f7;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        th {
            padding: 15px;
            text-align: left;
            color: white;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #f7fafc;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            fill: #cbd5e0;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #718096;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .export-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(72, 187, 120, 0.4);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header, .upload-section, .tables-section, .data-section {
                padding: 20px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .table-list {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: scroll;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Database File Viewer</h1>
            <p class="subtitle">Upload and explore SQLite database files directly in your browser</p>
        </div>
        
        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L16,16H13.5V19H10.5V16H8L12,12Z"/>
                    </svg>
                </div>
                <div class="upload-text">Drop your database file here</div>
                <div class="upload-subtext">or click to browse (supports .db, .sqlite, .sqlite3 files)</div>
            </div>
            <input type="file" id="fileInput" accept=".db,.sqlite,.sqlite3">
            
            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Processing database...</div>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <!-- Tables List Section -->
        <div class="tables-section" id="tablesSection">
            <h2 class="section-title">Database Tables</h2>
            <div class="table-list" id="tableList"></div>
        </div>
        
        <!-- Data Display Section -->
        <div class="data-section" id="dataSection">
            <div class="table-info">
                <div class="table-name" id="currentTableName"></div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="row-count" id="rowCount"></div>
                    <button class="export-button" id="exportButton" onclick="exportTableAsCSV()">Export as CSV</button>
                </div>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let SQL = null;
        let db = null;
        let currentTable = null;
        let currentData = null;
        
        // Initialize SQL.js
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(sql => {
            SQL = sql;
            console.log('SQL.js initialized successfully');
        }).catch(err => {
            console.error('Failed to initialize SQL.js:', err);
            showError('Failed to initialize database engine. Please refresh the page.');
        });
        
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const tablesSection = document.getElementById('tablesSection');
        const tableList = document.getElementById('tableList');
        const dataSection = document.getElementById('dataSection');
        const currentTableName = document.getElementById('currentTableName');
        const rowCount = document.getElementById('rowCount');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        
        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // File Handling
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            // Validate file extension
            const validExtensions = ['.db', '.sqlite', '.sqlite3'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                showError('Please select a valid SQLite database file (.db, .sqlite, .sqlite3)');
                return;
            }
            
            // Show file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
            
            // Show loading
            loading.classList.add('show');
            hideError();
            
            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    loadDatabase(new Uint8Array(e.target.result));
                } catch (err) {
                    showError('Failed to load database: ' + err.message);
                    loading.classList.remove('show');
                }
            };
            reader.onerror = function() {
                showError('Failed to read file');
                loading.classList.remove('show');
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Database Loading
        function loadDatabase(data) {
            if (!SQL) {
                showError('Database engine not initialized. Please wait and try again.');
                loading.classList.remove('show');
                return;
            }
            
            try {
                // Close existing database if any
                if (db) {
                    db.close();
                }
                
                // Open new database
                db = new SQL.Database(data);
                
                // Get tables
                const tables = getTables();
                
                if (tables.length === 0) {
                    showError('No tables found in the database');
                    loading.classList.remove('show');
                    return;
                }
                
                // Display tables
                displayTables(tables);
                loading.classList.remove('show');
                
            } catch (err) {
                showError('Failed to parse database: ' + err.message);
                loading.classList.remove('show');
            }
        }
        
        // Get Tables from Database
        function getTables() {
            try {
                const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
                if (result.length > 0) {
                    return result[0].values.map(row => row[0]);
                }
                return [];
            } catch (err) {
                console.error('Error getting tables:', err);
                return [];
            }
        }
        
        // Display Tables List
        function displayTables(tables) {
            tableList.innerHTML = '';
            tables.forEach(table => {
                const button = document.createElement('button');
                button.className = 'table-button';
                button.textContent = table;
                button.onclick = () => loadTable(table, button);
                tableList.appendChild(button);
            });
            tablesSection.classList.add('show');
        }
        
        // Load Table Data
        function loadTable(tableName, buttonElement) {
            try {
                // Update active button
                document.querySelectorAll('.table-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                buttonElement.classList.add('active');
                
                // Get table data
                const result = db.exec(`SELECT * FROM "${tableName}"`);
                
                if (result.length === 0) {
                    showTableData(tableName, [], []);
                    return;
                }
                
                const columns = result[0].columns;
                const values = result[0].values;
                
                currentTable = tableName;
                currentData = { columns, values };
                
                showTableData(tableName, columns, values);
                
            } catch (err) {
                showError('Failed to load table: ' + err.message);
            }
        }
        
        // Display Table Data
        function showTableData(tableName, columns, rows) {
            // Update table info
            currentTableName.textContent = tableName;
            rowCount.textContent = `${rows.length} rows`;
            
            // Clear existing data
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (columns.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #718096;">No data in this table</td></tr>';
                dataSection.classList.add('show');
                return;
            }
            
            // Create header
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            // Create body rows
            rows.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    // Handle null values
                    if (cell === null) {
                        td.textContent = 'NULL';
                        td.style.color = '#a0aec0';
                        td.style.fontStyle = 'italic';
                    } else if (typeof cell === 'object') {
                        // Handle blob data
                        td.textContent = '[BLOB]';
                        td.style.color = '#a0aec0';
                    } else {
                        td.textContent = cell;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            
            dataSection.classList.add('show');
        }
        
        // Export Table as CSV
        function exportTableAsCSV() {
            if (!currentData || !currentTable) {
                showError('No table data to export');
                return;
            }
            
            const { columns, values } = currentData;
            
            // Create CSV content
            let csvContent = '';
            
            // Add headers
            csvContent += columns.map(col => `"${col}"`).join(',') + '\n';
            
            // Add data rows
            values.forEach(row => {
                csvContent += row.map(cell => {
                    if (cell === null) return '';
                    if (typeof cell === 'string') {
                        // Escape quotes and wrap in quotes
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                }).join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentTable}.csv`);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Utility Functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }
        
        function hideError() {
            errorMessage.classList.remove('show');
        }
    </script>
</body>
</html>