<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Manager Test Suite</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
        }

        .test-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-section h2 {
            color: #569cd6;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #1177bb;
        }

        button.success {
            background: #4caf50;
        }

        button.danger {
            background: #f44336;
        }

        button.warning {
            background: #ff9800;
        }

        .test-output {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-entry.info {
            border-left-color: #569cd6;
        }

        .log-entry.success {
            border-left-color: #4ec9b0;
        }

        .log-entry.error {
            border-left-color: #f48771;
        }

        .log-entry.warning {
            border-left-color: #dcdcaa;
        }

        .log-time {
            color: #6a9955;
            margin-right: 10px;
        }

        .log-type {
            color: #ce9178;
            margin-right: 10px;
            font-weight: bold;
        }

        .state-display {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }

        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
        }

        .state-label {
            color: #dcdcaa;
        }

        .state-value {
            color: #ce9178;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }

        .metric-value {
            font-size: 32px;
            color: #4ec9b0;
            font-weight: bold;
        }

        .metric-label {
            font-size: 14px;
            color: #858585;
            margin-top: 5px;
        }

        .code-block {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Game Manager System - Test Suite</h1>

        <!-- State Display -->
        <div class="test-section">
            <h2>üìä Current State</h2>
            <div class="state-display" id="state-display"></div>
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="metric-total">0</div>
                    <div class="metric-label">Total Games</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-installed">0</div>
                    <div class="metric-label">Installed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-favorites">0</div>
                    <div class="metric-label">Favorites</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-visible">0</div>
                    <div class="metric-label">Visible</div>
                </div>
            </div>
        </div>

        <!-- Basic Operations Tests -->
        <div class="test-section">
            <h2>üîß Basic Operations</h2>
            <div class="test-controls">
                <button onclick="testAddGame()">Add Game</button>
                <button onclick="testRemoveGame()">Remove Game</button>
                <button onclick="testGetGame()">Get Game</button>
                <button onclick="testGetAllGames()">Get All Games</button>
                <button class="success" onclick="testAddMultipleGames()">Add 5 Games</button>
                <button class="danger" onclick="testClearAllGames()">Clear All Games</button>
            </div>
            <div class="test-output" id="basic-output"></div>
        </div>

        <!-- State Management Tests -->
        <div class="test-section">
            <h2>üíæ State Management</h2>
            <div class="test-controls">
                <button onclick="testSaveState()">Save State</button>
                <button onclick="testLoadState()">Load State</button>
                <button onclick="testUpdateState()">Update State</button>
                <button class="warning" onclick="testClearLocalStorage()">Clear localStorage</button>
            </div>
            <div class="test-output" id="state-output"></div>
        </div>

        <!-- Favorites Tests -->
        <div class="test-section">
            <h2>‚≠ê Favorites System</h2>
            <div class="test-controls">
                <button onclick="testToggleFavorite()">Toggle Favorite</button>
                <button onclick="testGetFavorites()">Get All Favorites</button>
                <button onclick="testBulkFavorite()">Favorite 3 Games</button>
                <button class="danger" onclick="testClearFavorites()">Clear All Favorites</button>
            </div>
            <div class="test-output" id="favorites-output"></div>
        </div>

        <!-- Filtering Tests -->
        <div class="test-section">
            <h2>üîç Filtering System</h2>
            <div class="test-controls">
                <button onclick="testFilterByCategory()">Filter by Category</button>
                <button onclick="testFilterByView()">Filter by View</button>
                <button onclick="testSearch()">Search Games</button>
                <button onclick="testCombinedFilters()">Combined Filters</button>
                <button class="success" onclick="testResetFilters()">Reset Filters</button>
            </div>
            <div class="test-output" id="filter-output"></div>
        </div>

        <!-- Game Launching Tests -->
        <div class="test-section">
            <h2>üöÄ Game Launching</h2>
            <div class="test-controls">
                <button onclick="testLaunchEmbeddedGame()">Launch Embedded Game</button>
                <button onclick="testLaunchIframeGame()">Launch Iframe Game</button>
                <button onclick="testLaunchLocalGame()">Launch Local Game</button>
                <button class="danger" onclick="testCloseEmulator()">Close Emulator</button>
            </div>
            <div class="test-output" id="launch-output"></div>
        </div>

        <!-- Performance Tests -->
        <div class="test-section">
            <h2>‚ö° Performance Tests</h2>
            <div class="test-controls">
                <button onclick="testRenderPerformance()">Test Render Speed</button>
                <button onclick="testFilterPerformance()">Test Filter Speed</button>
                <button onclick="testStatePerformance()">Test State Speed</button>
                <button class="success" onclick="testRunAllPerformance()">Run All Tests</button>
            </div>
            <div class="test-output" id="performance-output"></div>
        </div>

        <!-- Stress Tests -->
        <div class="test-section">
            <h2>üèãÔ∏è Stress Tests</h2>
            <div class="test-controls">
                <button onclick="testManyGames()">Add 100 Games</button>
                <button onclick="testRapidFiltering()">Rapid Filtering</button>
                <button onclick="testMemoryLeaks()">Memory Leak Test</button>
                <button class="warning" onclick="testEdgeCases()">Edge Cases</button>
            </div>
            <div class="test-output" id="stress-output"></div>
        </div>

        <!-- Full Integration Test -->
        <div class="test-section">
            <h2>üéØ Full Integration Test</h2>
            <div class="test-controls">
                <button class="success" onclick="testFullWorkflow()">Run Complete Workflow</button>
            </div>
            <div class="test-output" id="integration-output"></div>
        </div>
    </div>

    <!-- Hidden elements for GameManager -->
    <div id="games-grid" style="display: none;"></div>
    <div id="emulator-container" style="display: none;">
        <button id="close-emulator"></button>
        <iframe id="game-iframe"></iframe>
        <div id="game-display"></div>
    </div>
    <div id="modal-overlay" style="display: none;">
        <div id="game-details-modal">
            <button class="close-modal"></button>
            <div id="modal-game-icon"></div>
            <div id="modal-game-title"></div>
            <div id="modal-game-description"></div>
            <div id="modal-game-category"></div>
            <div id="modal-game-rating"></div>
            <div id="modal-game-plays"></div>
            <button id="play-from-modal"></button>
        </div>
    </div>
    <select id="view-toggle" style="display: none;">
        <option value="store">Store</option>
        <option value="library">Library</option>
    </select>
    <select id="category-filter" style="display: none;">
        <option value="all">All</option>
    </select>
    <input type="text" id="search-input" style="display: none;">
    <div id="visible-games-count" style="display: none;"></div>

    <script src="game-manager-system.js"></script>
    <script>
        // Initialize system
        let stateManager;
        let gameManager;
        let testGameId = 0;

        function init() {
            stateManager = new StateManager();
            gameManager = new GameManager(stateManager, {});

            // Subscribe to state changes
            stateManager.subscribe('stateChanged', updateStateDisplay);

            // Initial display
            updateStateDisplay(stateManager.getState());

            log('info', 'System initialized successfully', 'basic-output');
        }

        // Logging utility
        function log(type, message, outputId) {
            const output = document.getElementById(outputId);
            if (!output) return;

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-type">${type.toUpperCase()}</span>
                <span>${message}</span>
            `;

            output.insertBefore(entry, output.firstChild);
        }

        // Update state display
        function updateStateDisplay(state) {
            const display = document.getElementById('state-display');
            display.innerHTML = `
                <div class="state-item">
                    <span class="state-label">Current View:</span>
                    <span class="state-value">${state.currentView}</span>
                </div>
                <div class="state-item">
                    <span class="state-label">Current Category:</span>
                    <span class="state-value">${state.currentCategory}</span>
                </div>
                <div class="state-item">
                    <span class="state-label">Search Query:</span>
                    <span class="state-value">${state.searchQuery || '(none)'}</span>
                </div>
                <div class="state-item">
                    <span class="state-label">Current Game:</span>
                    <span class="state-value">${state.currentGame || '(none)'}</span>
                </div>
                <div class="state-item">
                    <span class="state-label">History Length:</span>
                    <span class="state-value">${state.gameHistory.length}</span>
                </div>
            `;

            // Update metrics
            document.getElementById('metric-total').textContent = gameManager.getAllGames().length;
            document.getElementById('metric-installed').textContent = state.installedGames.size;
            document.getElementById('metric-favorites').textContent = state.favorites.size;
        }

        // Helper: Create test game
        function createTestGame(category = 'action') {
            return {
                id: `test-game-${++testGameId}`,
                name: `Test Game ${testGameId}`,
                description: `Test game description ${testGameId}`,
                icon: ['üéÆ', 'üéØ', 'üé≤', 'üé™'][Math.floor(Math.random() * 4)],
                category: category,
                rating: Math.random() * 5,
                plays: Math.floor(Math.random() * 1000),
                type: 'embedded'
            };
        }

        // Basic Operations Tests
        function testAddGame() {
            const game = createTestGame();
            gameManager.addGame(game);
            log('success', `Added game: ${game.name} (${game.id})`, 'basic-output');
            updateStateDisplay(stateManager.getState());
        }

        function testRemoveGame() {
            const games = gameManager.getAllGames();
            if (games.length === 0) {
                log('error', 'No games to remove', 'basic-output');
                return;
            }
            const game = games[0];
            gameManager.removeGame(game.id);
            log('success', `Removed game: ${game.name}`, 'basic-output');
            updateStateDisplay(stateManager.getState());
        }

        function testGetGame() {
            const games = gameManager.getAllGames();
            if (games.length === 0) {
                log('error', 'No games available', 'basic-output');
                return;
            }
            const game = gameManager.getGameById(games[0].id);
            log('info', `Retrieved: ${JSON.stringify(game, null, 2)}`, 'basic-output');
        }

        function testGetAllGames() {
            const games = gameManager.getAllGames();
            log('info', `Total games: ${games.length}`, 'basic-output');
        }

        function testAddMultipleGames() {
            const categories = ['action', 'puzzle', 'arcade', 'sports'];
            for (let i = 0; i < 5; i++) {
                const category = categories[Math.floor(Math.random() * categories.length)];
                gameManager.addGame(createTestGame(category));
            }
            log('success', 'Added 5 games', 'basic-output');
            updateStateDisplay(stateManager.getState());
        }

        function testClearAllGames() {
            const games = gameManager.getAllGames();
            games.forEach(game => gameManager.removeGame(game.id));
            log('warning', 'Cleared all games', 'basic-output');
            updateStateDisplay(stateManager.getState());
        }

        // State Management Tests
        function testSaveState() {
            stateManager.saveState();
            log('success', 'State saved to localStorage', 'state-output');
        }

        function testLoadState() {
            stateManager.loadState();
            log('success', 'State loaded from localStorage', 'state-output');
            updateStateDisplay(stateManager.getState());
        }

        function testUpdateState() {
            stateManager.updateState({
                currentView: 'library',
                currentCategory: 'action'
            });
            log('success', 'State updated: view=library, category=action', 'state-output');
        }

        function testClearLocalStorage() {
            localStorage.removeItem('retroplay_state');
            log('warning', 'localStorage cleared', 'state-output');
        }

        // Favorites Tests
        function testToggleFavorite() {
            const games = gameManager.getAllGames();
            if (games.length === 0) {
                log('error', 'No games available', 'favorites-output');
                return;
            }
            const game = games[0];
            gameManager.toggleFavorite(game.id);
            const state = stateManager.getState();
            const isFav = state.favorites.has(game.id);
            log('success', `Toggled favorite for ${game.name}: ${isFav ? 'Added' : 'Removed'}`, 'favorites-output');
            updateStateDisplay(state);
        }

        function testGetFavorites() {
            const favorites = gameManager.getFavoriteGames();
            log('info', `Favorite games: ${favorites.length}`, 'favorites-output');
            favorites.forEach(game => {
                log('info', `  - ${game.name}`, 'favorites-output');
            });
        }

        function testBulkFavorite() {
            const games = gameManager.getAllGames().slice(0, 3);
            games.forEach(game => gameManager.toggleFavorite(game.id));
            log('success', `Added ${games.length} games to favorites`, 'favorites-output');
            updateStateDisplay(stateManager.getState());
        }

        function testClearFavorites() {
            const state = stateManager.getState();
            state.favorites.clear();
            stateManager.updateState({ favorites: state.favorites });
            log('warning', 'Cleared all favorites', 'favorites-output');
            updateStateDisplay(state);
        }

        // Filtering Tests
        function testFilterByCategory() {
            stateManager.updateState({ currentCategory: 'action' });
            gameManager.filterGames();
            log('success', 'Filtered by category: action', 'filter-output');
        }

        function testFilterByView() {
            stateManager.updateState({ currentView: 'library' });
            gameManager.filterGames();
            log('success', 'Filtered by view: library', 'filter-output');
        }

        function testSearch() {
            stateManager.updateState({ searchQuery: 'test' });
            gameManager.filterGames();
            log('success', 'Search query: "test"', 'filter-output');
        }

        function testCombinedFilters() {
            stateManager.updateState({
                currentView: 'store',
                currentCategory: 'action',
                searchQuery: 'game'
            });
            gameManager.filterGames();
            log('success', 'Applied combined filters', 'filter-output');
        }

        function testResetFilters() {
            stateManager.updateState({
                currentView: 'store',
                currentCategory: 'all',
                searchQuery: ''
            });
            gameManager.filterGames();
            log('success', 'Reset all filters', 'filter-output');
        }

        // Game Launching Tests
        async function testLaunchEmbeddedGame() {
            const game = {
                id: 'embedded-test',
                name: 'Embedded Test Game',
                type: 'embedded',
                initialize: (display) => {
                    display.innerHTML = '<h2>Test Game Loaded!</h2>';
                }
            };
            gameManager.addGame(game);
            await gameManager.launchGame(game.id);
            log('success', 'Launched embedded game', 'launch-output');
        }

        async function testLaunchIframeGame() {
            const game = {
                id: 'iframe-test',
                name: 'Iframe Test Game',
                type: 'iframe',
                url: 'about:blank'
            };
            gameManager.addGame(game);
            await gameManager.launchGame(game.id);
            log('success', 'Launched iframe game', 'launch-output');
        }

        async function testLaunchLocalGame() {
            const game = {
                id: 'local-test',
                name: 'Local Test Game',
                type: 'local',
                htmlContent: '<html><body><h1>Local Game</h1></body></html>'
            };
            gameManager.addGame(game);
            await gameManager.launchGame(game.id);
            log('success', 'Launched local game with blob URL', 'launch-output');
        }

        function testCloseEmulator() {
            gameManager.closeEmulator();
            log('success', 'Closed emulator', 'launch-output');
        }

        // Performance Tests
        function testRenderPerformance() {
            const start = performance.now();
            for (let i = 0; i < 100; i++) {
                gameManager.addGame(createTestGame());
            }
            gameManager.renderAllGames();
            const end = performance.now();
            log('info', `Rendered 100 games in ${(end - start).toFixed(2)}ms`, 'performance-output');
        }

        function testFilterPerformance() {
            const start = performance.now();
            for (let i = 0; i < 100; i++) {
                gameManager.filterGames();
            }
            const end = performance.now();
            log('info', `100 filter operations in ${(end - start).toFixed(2)}ms`, 'performance-output');
        }

        function testStatePerformance() {
            const start = performance.now();
            for (let i = 0; i < 1000; i++) {
                stateManager.updateState({ currentView: i % 2 === 0 ? 'store' : 'library' });
            }
            const end = performance.now();
            log('info', `1000 state updates in ${(end - start).toFixed(2)}ms`, 'performance-output');
        }

        function testRunAllPerformance() {
            testRenderPerformance();
            setTimeout(() => testFilterPerformance(), 100);
            setTimeout(() => testStatePerformance(), 200);
        }

        // Stress Tests
        function testManyGames() {
            for (let i = 0; i < 100; i++) {
                gameManager.addGame(createTestGame(['action', 'puzzle', 'arcade'][i % 3]));
            }
            log('success', 'Added 100 games', 'stress-output');
            updateStateDisplay(stateManager.getState());
        }

        function testRapidFiltering() {
            const categories = ['all', 'action', 'puzzle', 'arcade', 'favorites'];
            let count = 0;
            const interval = setInterval(() => {
                const category = categories[count % categories.length];
                stateManager.updateState({ currentCategory: category });
                gameManager.filterGames();
                count++;
                if (count >= 20) {
                    clearInterval(interval);
                    log('success', 'Completed 20 rapid filter changes', 'stress-output');
                }
            }, 100);
        }

        function testMemoryLeaks() {
            log('info', 'Starting memory leak test...', 'stress-output');
            for (let i = 0; i < 50; i++) {
                const game = createTestGame();
                gameManager.addGame(game);
                gameManager.launchGame(game.id);
                gameManager.closeEmulator();
                gameManager.removeGame(game.id);
            }
            log('success', 'Memory leak test completed (check DevTools)', 'stress-output');
        }

        function testEdgeCases() {
            log('info', 'Testing edge cases...', 'stress-output');

            // Test with null/undefined
            try {
                gameManager.launchGame(null);
            } catch (e) {
                log('success', 'Handled null game ID', 'stress-output');
            }

            // Test with non-existent game
            try {
                gameManager.launchGame('non-existent');
            } catch (e) {
                log('success', 'Handled non-existent game', 'stress-output');
            }

            // Test duplicate game ID
            const game = createTestGame();
            gameManager.addGame(game);
            gameManager.addGame(game);
            log('success', 'Handled duplicate game', 'stress-output');
        }

        // Full Integration Test
        async function testFullWorkflow() {
            log('info', 'Starting full workflow test...', 'integration-output');

            // Clear everything
            testClearAllGames();
            testClearFavorites();

            // Add games
            log('info', 'Step 1: Adding games...', 'integration-output');
            testAddMultipleGames();

            await sleep(500);

            // Mark some as favorites
            log('info', 'Step 2: Adding favorites...', 'integration-output');
            testBulkFavorite();

            await sleep(500);

            // Test filtering
            log('info', 'Step 3: Testing filters...', 'integration-output');
            testFilterByCategory();
            await sleep(300);
            testFilterByView();
            await sleep(300);
            testResetFilters();

            await sleep(500);

            // Launch a game
            log('info', 'Step 4: Launching game...', 'integration-output');
            await testLaunchEmbeddedGame();
            await sleep(500);
            testCloseEmulator();

            await sleep(500);

            // Save state
            log('info', 'Step 5: Saving state...', 'integration-output');
            testSaveState();

            await sleep(500);

            log('success', '‚úÖ Full workflow test completed successfully!', 'integration-output');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
