<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local HTML Browser</title>
    <link rel="icon" href="data:,">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .navbar {
            background-color: #f0f0f0;
            padding: 10px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        #urlInput {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        button {
            padding: 8px 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover {
            background-color: #3367d6;
        }
        #frame-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        iframe {
            border: none;
            width: 100%;
            height: 100%;
            flex-grow: 1;
        }
        .file-input {
            display: none;
        }
        .load-local-button {
            background-color: #34a853;
        }
        .load-local-button:hover {
            background-color: #2e8b57;
        }
        .back-button {
            background-color: #ea4335;
        }
        .back-button:hover {
            background-color: #d62516;
        }
        .home-button {
            background-color: #fbbc05;
            color: #333;
        }
        .home-button:hover {
            background-color: #e8ac04;
        }
        #status {
            margin-left: 10px;
            color: #666;
        }
        .file-list {
            list-style-type: none;
            padding: 0;
            margin: 20px 0;
        }
        .file-list li {
            margin-bottom: 10px;
        }
        .file-list a {
            display: block;
            padding: 10px 15px;
            background-color: #f8f8f8;
            border-radius: 4px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .file-list a:hover {
            background-color: #e8e8e8;
        }
        .repo-input-container {
            margin: 20px 0;
        }
        #repoInput {
            width: 70%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        .history-dropdown {
            position: relative;
            display: inline-block;
        }
        .history-button {
            background-color: #673ab7;
        }
        .history-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 250px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .history-content a:hover {
            background-color: #f1f1f1;
        }
        .show {
            display: block;
        }
        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .app-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .app-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .app-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .app-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .app-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .app-description {
            color: #555;
            margin-bottom: 10px;
        }
        .app-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .app-tag {
            background-color: #f0f0f0;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .app-button {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.2s;
        }
        .app-button:hover {
            background-color: #3367d6;
        }
        .tab-container {
            margin: 20px 0;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f8f8f8;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            margin-right: 5px;
        }
        .tab-button.active {
            background-color: #4285f4;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .app-note {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
        }
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .error-message {
            color: #d32f2f;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success-message {
            color: #388e3c;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
            margin: 10px 0;
        }
        /* Resource control panel */
        .resource-control {
            background-color: #f8f9fa;
            padding: 10px;
            margin-top: 5px;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
        }
        .resource-toggle {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        .resource-toggle label {
            margin-left: 5px;
            cursor: pointer;
        }
        .resource-toggle input {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <button id="homeButton" class="home-button">Home</button>
        <button id="backButton" class="back-button">Back</button>
        <input type="text" id="urlInput" placeholder="Enter URL or file path">
        <button id="loadButton">Load URL</button>
        <button class="load-local-button" id="loadLocalButton">Load Local File</button>
        <div class="history-dropdown">
            <button class="history-button" id="historyButton">History</button>
            <div id="historyDropdown" class="history-content"></div>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".html,.htm">
        <span id="status"></span>
    </div>
    <div class="resource-control">
        <div class="resource-toggle">
            <input type="checkbox" id="allowScripts" checked>
            <label for="allowScripts">Allow Scripts</label>
        </div>
        <div class="resource-toggle">
            <input type="checkbox" id="allowSameOrigin" checked>
            <label for="allowSameOrigin">Allow Same Origin</label>
        </div>
        <div class="resource-toggle">
            <input type="checkbox" id="enableUrlFixer" checked>
            <label for="enableUrlFixer">Fix Relative URLs</label>
        </div>
    </div>
    <div id="frame-container">
        <iframe id="contentFrame" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('urlInput');
            const loadButton = document.getElementById('loadButton');
            const loadLocalButton = document.getElementById('loadLocalButton');
            const fileInput = document.getElementById('fileInput');
            const contentFrame = document.getElementById('contentFrame');
            const status = document.getElementById('status');
            const homeButton = document.getElementById('homeButton');
            const backButton = document.getElementById('backButton');
            const historyButton = document.getElementById('historyButton');
            const historyDropdown = document.getElementById('historyDropdown');
            const allowScripts = document.getElementById('allowScripts');
            const allowSameOrigin = document.getElementById('allowSameOrigin');
            const enableUrlFixer = document.getElementById('enableUrlFixer');
            
            // Repository data cache to reduce API calls
            const repoCache = {};
            
            // Browser history
            let browserHistory = [];
            let currentHistoryIndex = -1;
            let isHistoryNavigation = false;
            
            // Update sandbox attributes based on toggles
            function updateSandboxAttributes() {
                let sandboxValues = [];
                
                if (allowScripts.checked) {
                    sandboxValues.push('allow-scripts');
                }
                
                if (allowSameOrigin.checked) {
                    sandboxValues.push('allow-same-origin');
                }
                
                contentFrame.setAttribute('sandbox', sandboxValues.join(' '));
            }
            
            // Add event listeners for toggles
            allowScripts.addEventListener('change', updateSandboxAttributes);
            allowSameOrigin.addEventListener('change', updateSandboxAttributes);
            
            // Load from URL
            loadButton.addEventListener('click', function() {
                loadURL();
            });

            // Enter key in input
            urlInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadURL();
                }
            });

            // Load from local file trigger
            loadLocalButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Go back in history
            backButton.addEventListener('click', function() {
                if (currentHistoryIndex > 0) {
                    isHistoryNavigation = true;
                    currentHistoryIndex--;
                    const prevURL = browserHistory[currentHistoryIndex];
                    urlInput.value = prevURL;
                    loadURL(true);
                }
            });
            
            // Go to home
            homeButton.addEventListener('click', function() {
                loadHomePage();
            });
            
            // Toggle history dropdown
            historyButton.addEventListener('click', function() {
                historyDropdown.classList.toggle('show');
                populateHistoryDropdown();
            });
            
            // Close dropdown when clicking outside of it
            window.addEventListener('click', function(event) {
                if (!event.target.matches('.history-button')) {
                    if (historyDropdown.classList.contains('show')) {
                        historyDropdown.classList.remove('show');
                    }
                }
            });
            
            // Populate history dropdown
            function populateHistoryDropdown() {
                historyDropdown.innerHTML = '';
                
                // Create history items (most recent first)
                const reversedHistory = [...browserHistory].reverse();
                reversedHistory.forEach((url, index) => {
                    const historyItem = document.createElement('a');
                    historyItem.href = '#';
                    
                    // Create a shorter display version if URL is too long
                    const displayUrl = url.length > 40 ? url.substring(0, 37) + '...' : url;
                    historyItem.textContent = displayUrl;
                    
                    historyItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        urlInput.value = url;
                        loadURL();
                        historyDropdown.classList.remove('show');
                    });
                    
                    historyDropdown.appendChild(historyItem);
                });
                
                // If history is empty
                if (browserHistory.length === 0) {
                    const emptyItem = document.createElement('a');
                    emptyItem.href = '#';
                    emptyItem.textContent = 'No history yet';
                    emptyItem.style.fontStyle = 'italic';
                    emptyItem.style.color = '#999';
                    historyDropdown.appendChild(emptyItem);
                }
            }

            // When file is selected
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        displayContent(content, file.name);
                    };
                    reader.readAsText(file);
                    const fileUrl = `file: ${file.name}`;
                    urlInput.value = fileUrl;
                    status.textContent = `Loaded: ${file.name}`;
                    
                    // Add to history only if not navigating through history
                    if (!isHistoryNavigation) {
                        addToHistory(fileUrl);
                    } else {
                        isHistoryNavigation = false;
                    }
                }
            });
            
            // Add URL to browser history
            function addToHistory(url) {
                // If we're not at the end of the history, truncate the forward history
                if (currentHistoryIndex < browserHistory.length - 1) {
                    browserHistory = browserHistory.slice(0, currentHistoryIndex + 1);
                }
                
                // Add the new URL to history
                browserHistory.push(url);
                currentHistoryIndex = browserHistory.length - 1;
                
                // Limit history size to 50 items
                if (browserHistory.length > 50) {
                    browserHistory.shift();
                    currentHistoryIndex--;
                }
            }

            // Handle URL loading
            function loadURL(isBackNavigation = false) {
                const url = urlInput.value.trim();
                
                if (!url) {
                    status.textContent = "Please enter a URL";
                    return;
                }

                status.textContent = `Loading: ${url}`;
                status.className = '';
                
                // Add to history only if not navigating back
                if (!isBackNavigation && !isHistoryNavigation) {
                    addToHistory(url);
                } else if (isHistoryNavigation) {
                    isHistoryNavigation = false;
                }

                if (url.startsWith('file:')) {
                    status.textContent = "Please use the 'Load Local File' button for local files";
                    status.className = 'error-message';
                    return;
                }
                
                if (url.includes('github.com') && !url.includes('raw.githubusercontent.com')) {
                    // If it's a GitHub repo URL, convert it to raw.githubusercontent.com for content
                    const convertedUrl = convertGitHubUrlToRaw(url);
                    if (convertedUrl) {
                        fetchContentFromUrl(convertedUrl, url);
                    } else {
                        // If it's a repo URL without a specific file, scan the repo
                        try {
                            const githubUrl = new URL(url);
                            if (githubUrl.hostname === 'github.com') {
                                const path = githubUrl.pathname.split('/').filter(part => part);
                                if (path.length >= 2 && path.length < 5) {
                                    // This is likely a repo URL without a specific file
                                    createHomePage(url);
                                    return;
                                }
                            }
                        } catch (e) {
                            console.error("Error parsing GitHub URL:", e);
                        }
                        
                        status.textContent = "Could not parse GitHub URL";
                        status.className = 'error-message';
                    }
                } else if (url.startsWith('http://') || url.startsWith('https://')) {
                    // Direct URL loading
                    fetchContentFromUrl(url);
                } else {
                    // Try to load as URL with https prefix
                    const fullUrl = url.startsWith('//') ? 'https:' + url : 'https://' + url;
                    urlInput.value = fullUrl;
                    loadURL(isBackNavigation);
                }
            }
            
            // Fix relative URLs in HTML content
            function fixRelativeUrls(html, baseUrl) {
                if (!enableUrlFixer.checked) {
                    return html;
                }
                
                try {
                    const base = new URL(baseUrl);
                    const baseUrlWithoutFilename = base.origin + base.pathname.substring(0, base.pathname.lastIndexOf('/') + 1);
                    
                    // Replace relative URLs in src and href attributes
                    html = html.replace(/\s(src|href)=["'](?!http|https|data:|\/\/|#)([^"']+)/gi, function(match, attr, url) {
                        if (url.startsWith('/')) {
                            // Root-relative URL
                            return ` ${attr}="${base.origin}${url}`;
                        } else {
                            // Relative URL
                            return ` ${attr}="${baseUrlWithoutFilename}${url}`;
                        }
                    });
                    
                    // Add base tag to head
                    if (!html.includes('<base')) {
                        html = html.replace(/<head>/i, `<head><base href="${baseUrlWithoutFilename}">`);
                    }
                    
                    return html;
                } catch (e) {
                    console.error("Error fixing relative URLs:", e);
                    return html;
                }
            }
            
            // Fetch content from a URL
            function fetchContentFromUrl(url, originalUrl) {
                const baseUrl = originalUrl || url;
                
                // Show loading spinner
                status.innerHTML = `Loading: ${url} <div class="loading-indicator"></div>`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Process the HTML to fix relative URLs
                        const processedHtml = fixRelativeUrls(html, baseUrl);
                        displayContent(processedHtml, url);
                        status.textContent = `Loaded: ${url}`;
                        status.className = 'success-message';
                    })
                    .catch(error => {
                        console.error('Error fetching URL:', error);
                        status.textContent = `Error: ${error.message}`;
                        status.className = 'error-message';
                    });
            }

            // Convert GitHub URL to raw content URL
            function convertGitHubUrlToRaw(url) {
                try {
                    const githubUrl = new URL(url);
                    
                    // If it's already a raw URL, return as is
                    if (githubUrl.hostname === 'raw.githubusercontent.com') {
                        return url;
                    }
                    
                    // For regular GitHub URLs
                    if (githubUrl.hostname === 'github.com') {
                        const path = githubUrl.pathname;
                        
                        // Extract username, repo, branch, and file path
                        const parts = path.split('/');
                        
                        if (parts.length >= 5 && parts[3] === 'blob') {
                            // It's a file URL: github.com/username/repo/blob/branch/path/to/file
                            const username = parts[1];
                            const repo = parts[2];
                            const branch = parts[4];
                            const filePath = parts.slice(5).join('/');
                            
                            return `https://raw.githubusercontent.com/${username}/${repo}/${branch}/${filePath}`;
                        }
                    }
                } catch (e) {
                    console.error("Error converting GitHub URL:", e);
                }
                
                return null;
            }
            
            // Extract GitHub repo details from URL
            function extractGitHubRepoInfo(url) {
                try {
                    const githubUrl = new URL(url);
                    if (githubUrl.hostname === 'github.com') {
                        const pathParts = githubUrl.pathname.split('/').filter(part => part);
                        if (pathParts.length >= 2) {
                            const username = pathParts[0];
                            const repo = pathParts[1];
                            
                            // Default to main branch if not specified
                            let branch = 'main';
                            if (pathParts.length > 3 && (pathParts[2] === 'tree' || pathParts[2] === 'blob')) {
                                branch = pathParts[3];
                            }
                            
                            return {
                                owner: username,
                                name: repo,
                                branch: branch,
                                url: `https://github.com/${username}/${repo}`
                            };
                        }
                    }
                } catch (e) {
                    console.error("Error parsing GitHub URL:", e);
                }
                
                return null;
            }

            // Display content in iframe
            function displayContent(html, source) {
                // Create blob and object URL
                const blob = new Blob([html], { 
                    type: 'text/html'
                });
                const objectURL = URL.createObjectURL(blob);
                
                // Update sandbox attributes before setting iframe src
                updateSandboxAttributes();
                
                // Set iframe src to blob URL
                contentFrame.src = objectURL;
                
                // Clean up the URL object when done
                contentFrame.onload = function() {
                    // Wait before revoking to ensure iframe has loaded
                    setTimeout(() => URL.revokeObjectURL(objectURL), 100);
                };
            }
            
            // Fetch files from a GitHub repository
            async function fetchGitHubRepoFiles(repoUrl) {
                try {
                    status.innerHTML = `Scanning repository... <div class="loading-indicator"></div>`;
                    
                    const repoInfo = extractGitHubRepoInfo(repoUrl);
                    if (!repoInfo) {
                        throw new Error("Invalid repository URL");
                    }
                    
                    // Check if repo is in cache
                    const cacheKey = `${repoInfo.owner}/${repoInfo.name}/${repoInfo.branch}`;
                    if (repoCache[cacheKey] && (Date.now() - repoCache[cacheKey].timestamp < 300000)) { // Cache for 5 minutes
                        status.textContent = `Loaded from cache: ${repoInfo.owner}/${repoInfo.name}`;
                        return repoCache[cacheKey].data;
                    }
                    
                    // GitHub API URL to get repository contents
                    const apiUrl = `https://api.github.com/repos/${repoInfo.owner}/${repoInfo.name}/git/trees/${repoInfo.branch}?recursive=1`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Filter for HTML files
                    const htmlFiles = data.tree
                        .filter(item => item.type === 'blob' && 
                               (item.path.endsWith('.html') || item.path.endsWith('.htm')))
                        .map(item => {
                            return {
                                path: item.path,
                                url: `https://github.com/${repoInfo.owner}/${repoInfo.name}/blob/${repoInfo.branch}/${item.path}`,
                                raw_url: `https://raw.githubusercontent.com/${repoInfo.owner}/${repoInfo.name}/${repoInfo.branch}/${item.path}`
                            };
                        });
                    
                    // Check if there's a config file
                    const configFile = data.tree.find(item => 
                        item.type === 'blob' && 
                        (item.path === 'utility_apps_config.json' || item.path.endsWith('/utility_apps_config.json'))
                    );
                    
                    let configData = null;
                    if (configFile) {
                        try {
                            const configUrl = `https://raw.githubusercontent.com/${repoInfo.owner}/${repoInfo.name}/${repoInfo.branch}/${configFile.path}`;
                            const configResponse = await fetch(configUrl);
                            if (configResponse.ok) {
                                configData = await configResponse.json();
                            }
                        } catch (e) {
                            console.error("Error fetching config file:", e);
                        }
                    }
                    
                    const repoData = {
                        repo: repoInfo,
                        files: htmlFiles,
                        config: configData
                    };
                    
                    // Save to cache
                    repoCache[cacheKey] = {
                        data: repoData,
                        timestamp: Date.now()
                    };
                    
                    return repoData;
                } catch (error) {
                    console.error("Error fetching repository files:", error);
                    status.textContent = `Error: ${error.message}`;
                    status.className = 'error-message';
                    return null;
                }
            }

            // Create and display the home page with repository files
            async function createHomePage(repoUrl = "") {
                // Default configuration for demonstration purposes
                const defaultConfig = {
                    "version": "1.0",
                    "lastUpdated": "2025-02-18T00:03:32.250Z",
                    "apps": [
                        {
                            "id": "emdr-complete",
                            "title": "EMDR Therapy Tool",
                            "description": "Eye Movement Desensitization and Reprocessing (EMDR) therapy assistant",
                            "tags": ["health", "therapy", "mental-health"],
                            "path": "./emdr-complete.html",
                            "icon": "üëÅÔ∏è"
                        },
                        {
                            "id": "mermaid-viewer",
                            "title": "Mermaid Diagram Viewer",
                            "description": "Create and view Mermaid diagrams in real-time",
                            "tags": ["visualization", "diagrams", "development"],
                            "path": "./mermaid-viewer.html",
                            "icon": "üìä"
                        },
                        {
                            "id": "task-tracker",
                            "title": "Task Tracker",
                            "description": "Track and manage your tasks with priorities and status updates",
                            "tags": ["productivity", "organization"],
                            "path": "./task-tracker.html",
                            "icon": "üìã"
                        }
                    ]
                };
                
                let homePageHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Local HTML Browser</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            max-width: 1000px;
                            margin: 40px auto;
                            padding: 20px;
                            line-height: 1.6;
                        }
                        h1, h2 {
                            color: #4285f4;
                        }
                        .instruction {
                            background-color: #f8f9fa;
                            padding: 15px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                        }
                        .repo-input-container {
                            margin: 20px 0;
                        }
                        #repoInput {
                            width: 70%;
                            padding: 10px;
                            border: 1px solid #ccc;
                            border-radius: 4px;
                            margin-right: 10px;
                        }
                        code {
                            background-color: #eee;
                            padding: 2px 4px;
                            border-radius: 3px;
                        }
                        .file-list {
                            list-style-type: none;
                            padding: 0;
                            margin: 20px 0;
                        }
                        .file-list li {
                            margin-bottom: 10px;
                        }
                        .file-list a {
                            display: block;
                            padding: 10px 15px;
                            background-color: #f8f8f8;
                            border-radius: 4px;
                            color: #333;
                            text-decoration: none;
                            transition: background-color 0.2s;
                        }
                        .file-list a:hover {
                            background-color: #e8e8e8;
                        }
                        .button {
                            padding: 10px 15px;
                            background-color: #4285f4;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        }
                        .button:hover {
                            background-color: #3367d6;
                        }
                        .loading {
                            display: inline-block;
                            margin-left: 10px;
                            color: #666;
                        }
                        .app-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                            gap: 20px;
                            margin: 20px 0;
                        }
                        .app-card {
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 15px;
                            background-color: #fff;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            transition: transform 0.2s, box-shadow 0.2s;
                        }
                        .app-card:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        }
                        .app-header {
                            display: flex;
                            align-items: center;
                            margin-bottom: 10px;
                        }
                        .app-icon {
                            font-size: 24px;
                            margin-right: 10px;
                        }
                        .app-title {
                            font-size: 18px;
                            font-weight: bold;
                            margin: 0;
                        }
                        .app-description {
                            color: #555;
                            margin-bottom: 10px;
                        }
                        .app-tags {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 5px;
                        }
                        .app-tag {
                            background-color: #f0f0f0;
                            color: #333;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                        }
                        .app-button {
                            background-color: #4285f4;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 8px 12px;
                            cursor: pointer;
                            margin-top: 10px;
                            width: 100%;
                            transition: background-color 0.2s;
                        }
                        .app-button:hover {
                            background-color: #3367d6;
                        }
                        .tab-container {
                            margin: 20px 0;
                        }
                        .tab-buttons {
                            display: flex;
                            margin-bottom: 15px;
                            border-bottom: 1px solid #ddd;
                        }
                        .tab-button {
                            padding: 10px 20px;
                            background-color: #f8f8f8;
                            border: none;
                            border-radius: 4px 4px 0 0;
                            cursor: pointer;
                            margin-right: 5px;
                        }
                        .tab-button.active {
                            background-color: #4285f4;
                            color: white;
                        }
                        .tab-content {
                            display: none;
                        }
                        .tab-content.active {
                            display: block;
                        }
                        .app-note {
                            font-style: italic;
                            color: #666;
                            font-size: 0.9em;
                        }
                        .loading-indicator {
                            display: inline-block;
                            width: 16px;
                            height: 16px;
                            border: 2px solid rgba(0, 0, 0, 0.1);
                            border-top-color: #4285f4;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin-left: 10px;
                            vertical-align: middle;
                        }
                        @keyframes spin {
                            to {
                                transform: rotate(360deg);
                            }
                        }
                        .error-message {
                            color: #d32f2f;
                            padding: 10px;
                            background-color: #ffebee;
                            border-radius: 4px;
                            margin: 10px 0;
                        }
                        .success-message {
                            color: #388e3c;
                            padding: 10px;
                            background-color: #e8f5e9;
                            border-radius: 4px;
                            margin: 10px 0;
                        }
                    </style>
                </head>
                <body>
                    <h1>Local HTML Browser</h1>
                    <p>This browser allows you to view HTML files from GitHub repositories or local files.</p>
                    
                    <div class="instruction">
                        <h3>Browse GitHub Repository:</h3>
                        <div class="repo-input-container">
                            <input type="text" id="repoInput" placeholder="Enter GitHub repository URL (e.g., https://github.com/username/repo)" 
                                value="${repoUrl}">
                            <button id="scanRepoButton" class="button">Scan Repository</button>
                            <span id="loadingIndicator" class="loading"></span>
                        </div>
                    </div>
                    
                    <div id="repoFilesContainer">`;
                
                // If a repo URL was provided, try to fetch and display files
                if (repoUrl) {
                    try {
                        const repoData = await fetchGitHubRepoFiles(repoUrl);
                        
                        if (repoData) {
                            homePageHTML += `
                                <h2>${repoData.repo.name} Repository</h2>
                                <p>Repository: <a href="${repoData.repo.url}" target="_blank">${repoData.repo.owner}/${repoData.repo.name}</a> (${repoData.repo.branch} branch)</p>`;
                            
                            // Create tabs for Apps (if config exists) and Files
                            homePageHTML += `
                                <div class="tab-container">
                                    <div class="tab-buttons">
                                        <button class="tab-button active" data-tab="apps">Apps</button>
                                        <button class="tab-button" data-tab="files">Files</button>
                                    </div>
                                    
                                    <div class="tab-content active" id="apps-tab">`;
                            
                            // Apps Tab Content - Use config from repo or default
                            const configData = repoData.config || defaultConfig;
                            if (configData && configData.apps && configData.apps.length > 0) {
                                homePageHTML += `
                                    <div class="app-grid">`;
                                
                                configData.apps.forEach(app => {
                                    // Create raw URL for the app path
                                    const appPath = app.path.startsWith('./') ? app.path.substring(2) : app.path;
                                    const appRawUrl = `https://raw.githubusercontent.com/${repoData.repo.owner}/${repoData.repo.name}/${repoData.repo.branch}/${appPath}`;
                                    
                                    homePageHTML += `
                                        <div class="app-card">
                                            <div class="app-header">
                                                <div class="app-icon">${app.icon || 'üìÑ'}</div>
                                                <h3 class="app-title">${app.title}</h3>
                                            </div>
                                            <p class="app-description">${app.description}</p>
                                            <div class="app-tags">`;
                                    
                                    if (app.tags && app.tags.length > 0) {
                                        app.tags.forEach(tag => {
                                            homePageHTML += `<span class="app-tag">${tag}</span>`;
                                        });
                                    }
                                    
                                    homePageHTML += `
                                            </div>
                                            <button class="app-button" data-url="${appRawUrl}">Open App</button>
                                        </div>`;
                                });
                                
                                homePageHTML += `
                                    </div>`;
                            } else {
                                homePageHTML += `
                                    <p>No apps found in this repository.</p>`;
                            }
                            
                            homePageHTML += `
                                    </div>
                                    
                                    <div class="tab-content" id="files-tab">`;
                            
                            // Files Tab Content
                            if (repoData.files.length > 0) {
                                homePageHTML += `
                                    <p>Click on a file to view it in this browser:</p>
                                    <ul class="file-list">`;
                                
                                repoData.files.forEach(file => {
                                    homePageHTML += `
                                        <li>
                                            <a href="#" class="file-link" data-url="${file.raw_url}" data-original-url="${file.url}">
                                                ${file.path}
                                            </a>
                                        </li>`;
                                });
                                
                                homePageHTML += `</ul>`;
                            } else {
                                homePageHTML += `
                                    <p>No HTML files were found in the repository.</p>`;
                            }
                            
                            homePageHTML += `
                                    </div>
                                </div>`;
                                
                        } else {
                            homePageHTML += `
                                <h2>No Files Found</h2>
                                <p>No files were found in the repository. Try another repository or check if the URL is correct.</p>`;
                        }
                    } catch (error) {
                        homePageHTML += `
                            <h2>Error</h2>
                            <p>Failed to fetch repository files: ${error.message}</p>`;
                    }
                } else {
                    // Default homepage content with example apps from default config
                    homePageHTML += `
                        <h2>Featured Apps</h2>
                        <div class="app-grid">`;
                    
                    // Display sample apps from default config
                    defaultConfig.apps.forEach(app => {
                        homePageHTML += `
                            <div class="app-card">
                                <div class="app-header">
                                    <div class="app-icon">${app.icon || 'üìÑ'}</div>
                                    <h3 class="app-title">${app.title}</h3>
                                </div>
                                <p class="app-description">${app.description}</p>
                                <div class="app-tags">`;
                        
                        if (app.tags && app.tags.length > 0) {
                            app.tags.forEach(tag => {
                                homePageHTML += `<span class="app-tag">${tag}</span>`;
                            });
                        }
                        
                        homePageHTML += `
                                </div>
                                <p class="app-note">Enter a repository URL above to see actual apps</p>
                            </div>`;
                    });
                    
                    homePageHTML += `
                        </div>`;
                }
                
                homePageHTML += `
                    </div>
                    
                    <div class="instruction">
                        <h3>Or view a local HTML file:</h3>
                        <button id="loadLocalFileButton" class="button">Load Local File</button>
                    </div>
                    
                    <div class="instruction">
                        <h3>Example Repositories:</h3>
                        <ul class="file-list">
                            <li><a href="#" class="repo-link" data-url="https://github.com/kody-w/localFirstTools">kody-w/localFirstTools</a></li>
                        </ul>
                    </div>
                    
                    <script>
                        // Browser Communication API
                        function sendMessageToParent(type, data) {
                            window.parent.postMessage({ type, ...data }, '*');
                        }
                        
                        // Handle repository scanning
                        document.getElementById('scanRepoButton').addEventListener('click', function() {
                            const repoUrl = document.getElementById('repoInput').value.trim();
                            if (repoUrl) {
                                document.getElementById('loadingIndicator').textContent = "Scanning...";
                                sendMessageToParent('scanRepo', { url: repoUrl });
                            }
                        });
                        
                        // Handle file links
                        document.querySelectorAll('.file-link').forEach(link => {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                const fileUrl = this.getAttribute('data-url');
                                const originalUrl = this.getAttribute('data-original-url') || fileUrl;
                                sendMessageToParent('loadUrl', { url: fileUrl, originalUrl: originalUrl });
                            });
                        });
                        
                        // Handle app buttons
                        document.querySelectorAll('.app-button').forEach(button => {
                            button.addEventListener('click', function(e) {
                                e.preventDefault();
                                const appUrl = this.getAttribute('data-url');
                                sendMessageToParent('loadUrl', { url: appUrl });
                            });
                        });
                        
                        // Handle example repo links
                        document.querySelectorAll('.repo-link').forEach(link => {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                const repoUrl = this.getAttribute('data-url');
                                sendMessageToParent('scanRepo', { url: repoUrl });
                            });
                        });
                        
                        // Handle local file button
                        document.getElementById('loadLocalFileButton').addEventListener('click', function() {
                            sendMessageToParent('loadLocalFile', {});
                        });
                        
                        // Handle tabs
                        document.querySelectorAll('.tab-button').forEach(button => {
                            button.addEventListener('click', function() {
                                // Remove active class from all buttons and content
                                document.querySelectorAll('.tab-button').forEach(btn => {
                                    btn.classList.remove('active');
                                });
                                document.querySelectorAll('.tab-content').forEach(content => {
                                    content.classList.remove('active');
                                });
                                
                                // Add active class to clicked button and corresponding content
                                this.classList.add('active');
                                const tabId = this.getAttribute('data-tab') + '-tab';
                                document.getElementById(tabId).classList.add('active');
                            });
                        });
                    </script>
                </body>
                </html>
                `;
                
                displayContent(homePageHTML, 'homepage');
            }
            
            // Load the home page
            function loadHomePage() {
                // If there's a repo URL in the urlInput that looks like a GitHub repo, use it
                const currentUrl = urlInput.value.trim();
                let repoUrl = "";
                
                if (currentUrl.includes('github.com') && !currentUrl.includes('raw.githubusercontent.com')) {
                    try {
                        const url = new URL(currentUrl);
                        if (url.hostname === 'github.com') {
                            const pathParts = url.pathname.split('/').filter(part => part);
                            if (pathParts.length >= 2) {
                                // Take just the username/repo part
                                repoUrl = `https://github.com/${pathParts[0]}/${pathParts[1]}`;
                            }
                        }
                    } catch (e) {
                        console.error("Error parsing URL:", e);
                    }
                }
                
                createHomePage(repoUrl);
            }
            
            // Custom event handler for iframe messages
            window.addEventListener('message', async function(event) {
                // Security check to only process messages from our iframe
                if (event.source !== contentFrame.contentWindow) {
                    return;
                }
                
                const message = event.data;
                
                if (message.type === 'scanRepo') {
                    urlInput.value = message.url;
                    await createHomePage(message.url);
                } else if (message.type === 'loadUrl') {
                    urlInput.value = message.url;
                    // If originalUrl is provided, use it for fixing relative URLs
                    if (message.originalUrl) {
                        fetchContentFromUrl(message.url, message.originalUrl);
                    } else {
                        loadURL();
                    }
                } else if (message.type === 'loadLocalFile') {
                    loadLocalButton.click();
                }
            });

            // Handle dropped files
            document.body.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.body.style.backgroundColor = '#f8f8f8';
            });

            document.body.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.body.style.backgroundColor = '';
            });

            document.body.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.body.style.backgroundColor = '';
                
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.html') || file.name.endsWith('.htm'))) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        displayContent(content, file.name);
                    };
                    reader.readAsText(file);
                    const fileUrl = `file: ${file.name}`;
                    urlInput.value = fileUrl;
                    status.textContent = `Loaded: ${file.name}`;
                    status.className = 'success-message';
                    
                    // Add to history
                    addToHistory(fileUrl);
                } else {
                    status.textContent = "Please drop an HTML file";
                    status.className = 'error-message';
                }
            });

            // Load initial home page
            loadHomePage();
            
            // Pre-populate with example repo if requested
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('repo')) {
                const initialRepo = urlParams.get('repo');
                if (initialRepo) {
                    setTimeout(() => {
                        createHomePage(`https://github.com/${initialRepo}`);
                    }, 500);
                }
            }
        });
    </script>
</body>
</html>