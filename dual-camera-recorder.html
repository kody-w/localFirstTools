<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dual Camera Recorder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            height: 100vh;
            height: -webkit-fill-available;
            -webkit-overflow-scrolling: touch;
        }
        
        .container {
            display: flex;
            height: 100vh;
            height: -webkit-fill-available;
            flex-direction: column;
            position: relative;
        }
        
        .cameras {
            flex: 1;
            display: flex;
            gap: 2px;
            position: relative;
        }
        
        .camera-box {
            flex: 1;
            position: relative;
            background: #222;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .label {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10;
        }
        
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-align: center;
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            margin: 0 10px;
            min-width: 140px;
            font-weight: 600;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }
        
        button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        button:disabled {
            opacity: 0.5;
        }
        
        #status {
            margin-bottom: 20px;
            font-size: 16px;
            color: #fff;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .red { 
            background: #FF3B30; 
        }
        
        .green {
            background: #34C759;
        }
        
        /* Fullscreen prompt */
        .fullscreen-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            text-align: center;
        }
        
        .fullscreen-prompt h2 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .fullscreen-prompt p {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .fullscreen-prompt button {
            background: #007AFF;
            padding: 18px 40px;
            font-size: 18px;
            min-width: 200px;
        }
        
        /* Hide prompt when in standalone mode */
        @media all and (display-mode: standalone) {
            .fullscreen-prompt {
                display: none !important;
            }
        }
        
        /* iOS specific adjustments */
        @supports (-webkit-touch-callout: none) {
            .container {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <!-- Fullscreen Prompt -->
    <div class="fullscreen-prompt" id="fullscreenPrompt">
        <h2>üì± Add to Home Screen</h2>
        <p>For the best camera experience, add this app to your home screen:</p>
        <p style="font-size: 14px;">
            1. Tap the Share button <span style="font-size: 20px;">‚¨ÜÔ∏è</span><br>
            2. Scroll down and tap "Add to Home Screen"<br>
            3. Tap "Add"
        </p>
        <button onclick="continueInBrowser()">Continue in Browser</button>
    </div>

    <div class="container">
        <div class="cameras">
            <div class="camera-box">
                <video id="video1" playsinline autoplay muted></video>
                <div class="label">Camera 1</div>
            </div>
            <div class="camera-box">
                <video id="video2" playsinline autoplay muted></video>
                <div class="label">Camera 2</div>
            </div>
        </div>
        
        <div class="controls">
            <div id="status">Tap Setup to start</div>
            <button id="setupBtn" onclick="setupCameras()">Setup Cameras</button>
            <button id="startBtn" onclick="startRecording()" style="display:none">Start Recording</button>
            <button id="stopBtn" onclick="stopRecording()" style="display:none" class="red">Stop Recording</button>
            <button id="downloadBtn" onclick="downloadVideos()" style="display:none" class="green">Download Videos</button>
        </div>
    </div>

    <script>
        // Check if running as standalone app
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone || 
                           document.referrer.includes('android-app://');
        
        // Check if iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        // Show fullscreen prompt only on iOS and not in standalone mode
        if (isIOS && !isStandalone) {
            document.getElementById('fullscreenPrompt').style.display = 'flex';
        } else {
            document.getElementById('fullscreenPrompt').style.display = 'none';
        }
        
        function continueInBrowser() {
            document.getElementById('fullscreenPrompt').style.display = 'none';
        }
        
        let stream1, stream2;
        let recorder1, recorder2;
        let chunks1 = [], chunks2 = [];
        let blob1, blob2;
        
        async function setupCameras() {
            const status = document.getElementById('status');
            const setupBtn = document.getElementById('setupBtn');
            const startBtn = document.getElementById('startBtn');
            
            try {
                status.textContent = 'Requesting camera access...';
                setupBtn.disabled = true;
                
                // First request permission with a simple constraint
                const permission = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                permission.getTracks().forEach(track => track.stop());
                
                status.textContent = 'Getting cameras...';
                
                // Get all cameras
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                
                console.log('Available cameras:', cameras);
                status.textContent = `Found ${cameras.length} camera${cameras.length !== 1 ? 's' : ''}`;
                
                if (cameras.length >= 2) {
                    // Try to get two different cameras
                    stream1 = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            deviceId: cameras[0].deviceId,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });
                    
                    stream2 = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            deviceId: cameras[1].deviceId,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });
                } else if (cameras.length === 1) {
                    // Use same camera for both if only one
                    stream1 = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false 
                    });
                    stream2 = stream1.clone();
                    status.textContent = 'Using single camera for both views';
                } else {
                    throw new Error('No cameras found');
                }
                
                // Set video sources
                const video1 = document.getElementById('video1');
                const video2 = document.getElementById('video2');
                
                video1.srcObject = stream1;
                video2.srcObject = stream2;
                
                // Ensure videos play
                await video1.play();
                await video2.play();
                
                status.textContent = 'Cameras ready!';
                setupBtn.style.display = 'none';
                startBtn.style.display = 'inline-block';
                
            } catch (err) {
                console.error('Camera error:', err);
                status.textContent = 'Error: ' + err.message;
                
                if (err.name === 'NotAllowedError') {
                    status.textContent = 'Camera access denied. Please enable in Settings > Safari > Camera';
                } else if (err.name === 'NotFoundError') {
                    status.textContent = 'No cameras found on this device';
                }
                
                setupBtn.disabled = false;
            }
        }
        
        function startRecording() {
            const status = document.getElementById('status');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            chunks1 = [];
            chunks2 = [];
            
            // Determine best format for recording
            let options = { mimeType: 'video/webm;codecs=vp8' };
            
            if (MediaRecorder.isTypeSupported('video/mp4')) {
                options = { mimeType: 'video/mp4' };
            } else if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options = {}; // Use default
            }
            
            try {
                recorder1 = new MediaRecorder(stream1, options);
                recorder2 = new MediaRecorder(stream2, options);
                
                recorder1.ondataavailable = e => {
                    if (e.data.size > 0) chunks1.push(e.data);
                };
                
                recorder2.ondataavailable = e => {
                    if (e.data.size > 0) chunks2.push(e.data);
                };
                
                recorder1.onstop = () => {
                    blob1 = new Blob(chunks1, { type: chunks1[0]?.type || 'video/webm' });
                };
                
                recorder2.onstop = () => {
                    blob2 = new Blob(chunks2, { type: chunks2[0]?.type || 'video/webm' });
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                };
                
                recorder1.start(100); // Collect data every 100ms
                recorder2.start(100);
                
                status.textContent = 'üî¥ Recording...';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                
            } catch (err) {
                console.error('Recording error:', err);
                status.textContent = 'Recording error: ' + err.message;
            }
        }
        
        function stopRecording() {
            const status = document.getElementById('status');
            const stopBtn = document.getElementById('stopBtn');
            const startBtn = document.getElementById('startBtn');
            
            if (recorder1 && recorder1.state !== 'inactive') {
                recorder1.stop();
            }
            if (recorder2 && recorder2.state !== 'inactive') {
                recorder2.stop();
            }
            
            status.textContent = 'Recording stopped';
            stopBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
        }
        
        function downloadVideos() {
            const status = document.getElementById('status');
            
            if (!blob1 || !blob2) {
                status.textContent = 'No recordings to download';
                return;
            }
            
            // Determine file extension
            const ext = blob1.type.includes('mp4') ? 'mp4' : 'webm';
            
            // Download video 1
            const a1 = document.createElement('a');
            a1.href = URL.createObjectURL(blob1);
            a1.download = `camera1_${Date.now()}.${ext}`;
            a1.click();
            
            // Download video 2 with slight delay
            setTimeout(() => {
                const a2 = document.createElement('a');
                a2.href = URL.createObjectURL(blob2);
                a2.download = `camera2_${Date.now()}.${ext}`;
                a2.click();
                
                status.textContent = 'Videos downloaded!';
            }, 100);
        }
        
        // Prevent iOS bounce scrolling
        document.body.addEventListener('touchmove', (e) => {
            if (e.target === document.body) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
        });
        
        // Ensure fullscreen on iOS
        if (isIOS) {
            window.scrollTo(0, 1);
        }
    </script>
</body>
</html>