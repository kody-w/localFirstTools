<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="description" content="Secure AI Chat Interface with Power Platform Integration" />
    <meta name="theme-color" content="#742774" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>AI Assistant</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" as="style" />
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github-dark.min.css" as="style" />

    <!-- Stylesheets -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github-dark.min.css" rel="stylesheet" id="hljs-theme" />

    <style>
      :root {
        --power-purple: #742774;
        --power-purple-light: #9168b6;
        --power-purple-dark: #4f1c4f;
        --ms-gray-10: #faf9f8;
        --ms-gray-20: #f3f2f1;
        --ms-gray-30: #edebe9;
        --ms-gray-40: #e1dfdd;
        --ms-gray-100: #323130;
        --ms-gray-130: #242424;
        --power-apps-color: #742774;
        --power-automate-color: #0066ff;
        --power-bi-color: #f2c811;
        --power-pages-color: #008272;
        --space-xs: 4px;
        --space-s: 8px;
        --space-m: 16px;
        --space-l: 24px;
        --space-xl: 32px;
        --border-radius: 8px;
        --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.1);
        --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.1);
        --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.15);
        --header-height: 64px;
        --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @font-face {
        font-family: "Segoe UI Web";
        src: local("Segoe UI");
        font-weight: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        height: 100%;
        -webkit-text-size-adjust: 100%;
      }

      body {
        font-family: "Segoe UI Web", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, var(--ms-gray-10) 0%, #ffffff 100%);
        color: var(--ms-gray-100);
        line-height: 1.6;
        height: 100%;
        overflow: hidden;
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Improve focus visibility */
      *:focus {
        outline: 2px solid var(--power-purple);
        outline-offset: 2px;
      }

      *:focus:not(:focus-visible) {
        outline: none;
      }

      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-large);
        overflow: hidden;
        position: relative;
      }

      .header {
        background: linear-gradient(135deg, var(--power-purple) 0%, var(--power-purple-dark) 100%);
        color: white;
        padding: 0 var(--space-l);
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow-medium);
        z-index: 100;
        min-height: var(--header-height);
        flex-shrink: 0;
        position: relative;
      }

      .header h1 {
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--space-m);
        letter-spacing: -0.02em;
      }

      .header h1::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 32px;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c.83 0 1.5.67 1.5 1.5S12.83 8 12 8s-1.5-.67-1.5-1.5S11.17 5 12 5zm4 11.5c0 .83-.67 1.5-1.5 1.5h-5c-.83 0-1.5-.67-1.5-1.5V16h1.5v.5h5v-.5H16v.5zm-3-4h-2V9h2v3.5z"/></svg>')
          center/contain no-repeat;
        opacity: 0.9;
        transition: var(--transition);
      }

      .header h1:hover::before {
        transform: rotate(360deg);
      }

      /* Connection status indicator */
      .connection-status {
        position: absolute;
        top: 50%;
        right: var(--space-l);
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        gap: var(--space-s);
        font-size: 12px;
        opacity: 0.8;
      }

      .connection-status::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4caf50;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .chat-container {
        flex: 1;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
        background: transparent;
        min-height: 0;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-l);
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: var(--power-purple-light) transparent;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }

      .chat-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: var(--power-purple-light);
        border-radius: 10px;
        transition: var(--transition);
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--power-purple);
      }

      /* Typing indicator */
      .typing-indicator {
        display: none;
        padding: var(--space-m);
        margin: var(--space-m) 0;
        max-width: 100px;
      }

      .typing-indicator.active {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .typing-indicator span {
        width: 8px;
        height: 8px;
        background: var(--power-purple);
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%, 80%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Menu System - Enhanced */
      .menu-container {
        position: fixed;
        top: calc(var(--header-height) + 16px);
        right: 16px;
        z-index: 200;
      }

      .menu-toggle {
        background: var(--power-purple);
        border: none;
        color: white;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow-medium);
        font-size: 20px;
        position: relative;
        overflow: hidden;
      }

      .menu-toggle::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .menu-toggle:hover::before {
        width: 100px;
        height: 100px;
      }

      .menu-toggle:hover {
        background: var(--power-purple-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-large);
      }

      .menu-toggle:active {
        transform: translateY(0);
      }

      .menu-toggle.active {
        transform: rotate(45deg);
        background: var(--power-purple-dark);
      }

      .menu-items {
        position: absolute;
        top: 70px;
        right: 0;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-large);
        min-width: 220px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px) scale(0.95);
        transition: var(--transition);
        border: 1px solid var(--ms-gray-30);
        overflow: hidden;
      }

      .menu-items.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      .menu-item {
        display: flex;
        align-items: center;
        gap: var(--space-m);
        padding: var(--space-m) var(--space-l);
        cursor: pointer;
        transition: var(--transition-fast);
        border-bottom: 1px solid var(--ms-gray-20);
        font-size: 14px;
        color: var(--ms-gray-100);
        position: relative;
        overflow: hidden;
      }

      .menu-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: var(--power-purple);
        transform: translateX(-100%);
        transition: var(--transition-fast);
      }

      .menu-item:hover::before {
        transform: translateX(0);
      }

      .menu-item:last-child {
        border-bottom: none;
      }

      .menu-item:hover {
        background: var(--ms-gray-10);
        color: var(--power-purple);
        padding-left: calc(var(--space-l) + 6px);
      }

      .menu-item i {
        width: 16px;
        text-align: center;
        opacity: 0.8;
        transition: var(--transition-fast);
      }

      .menu-item:hover i {
        opacity: 1;
        transform: scale(1.1);
      }

      /* Keyboard shortcut hints */
      .menu-item kbd {
        margin-left: auto;
        font-size: 11px;
        padding: 2px 6px;
        background: var(--ms-gray-20);
        border-radius: 3px;
        border: 1px solid var(--ms-gray-30);
        font-family: monospace;
      }

      .guid-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid var(--ms-gray-30);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-large);
        min-width: 320px;
        max-height: 400px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
        margin-top: var(--space-s);
      }

      .guid-dropdown.show {
        display: block;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .guid-dropdown-item {
        padding: var(--space-m);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--ms-gray-20);
        transition: var(--transition-fast);
        position: relative;
      }

      .guid-dropdown-item::after {
        content: "";
        position: absolute;
        left: 0;
        bottom: 0;
        width: 0;
        height: 2px;
        background: var(--power-purple);
        transition: var(--transition-fast);
      }

      .guid-dropdown-item:hover::after {
        width: 100%;
      }

      .guid-dropdown-item .guid-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
      }

      .guid-dropdown-item .guid {
        font-family: "SF Mono", Monaco, Consolas, monospace;
        font-size: 12px;
        color: var(--ms-gray-100);
        word-break: break-all;
      }

      .guid-dropdown-item .guid-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--power-purple);
      }

      .guid-dropdown-item .timestamp {
        font-size: 11px;
        color: var(--ms-gray-100);
        opacity: 0.7;
      }

      .guid-dropdown-item .actions {
        display: flex;
        gap: var(--space-s);
        align-items: center;
      }

      .guid-dropdown-item button {
        background: none;
        border: none;
        color: var(--power-purple);
        opacity: 0.7;
        transition: var(--transition-fast);
        cursor: pointer;
        padding: 6px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .guid-dropdown-item .delete-guid {
        color: #d32f2f;
      }

      .guid-dropdown-item button:hover {
        opacity: 1;
        background: var(--ms-gray-10);
        transform: scale(1.1);
      }

      .guid-dropdown-item:last-child {
        border-bottom: none;
      }

      .guid-dropdown-item:hover {
        background: var(--ms-gray-10);
      }

      /* Messages - Enhanced */
      .message {
        max-width: 85%;
        margin: var(--space-m) 0;
        padding: var(--space-l);
        border-radius: 20px;
        position: relative;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-shadow: var(--shadow-small);
        transition: var(--transition);
        animation: messageSlide 0.3s ease-out;
      }

      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-medium);
      }

      .user-message {
        background: linear-gradient(135deg, var(--power-purple) 0%, var(--power-purple-light) 100%);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 8px;
        position: relative;
      }

      .user-message::after {
        content: "";
        position: absolute;
        bottom: -2px;
        right: 20px;
        width: 20px;
        height: 20px;
        background: inherit;
        transform: rotate(45deg);
        border-radius: 0 0 4px 0;
        z-index: -1;
      }

      .assistant-message {
        background: white;
        margin-right: auto;
        border: 1px solid var(--ms-gray-20);
        border-bottom-left-radius: 8px;
        position: relative;
      }

      .assistant-message::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 20px;
        width: 20px;
        height: 20px;
        background: white;
        transform: rotate(45deg);
        border: 1px solid var(--ms-gray-20);
        border-top: none;
        border-right: none;
        border-radius: 0 0 0 4px;
        z-index: -1;
      }

      .system-message {
        background: rgba(116, 39, 116, 0.05);
        margin: var(--space-l) auto;
        width: 90%;
        font-family: "SF Mono", Monaco, Consolas, monospace;
        white-space: pre-wrap;
        padding: var(--space-l);
        border-radius: var(--border-radius);
        position: relative;
        border: 1px solid rgba(116, 39, 116, 0.1);
        overflow: hidden;
      }

      .system-message::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--power-purple);
        opacity: 0.3;
      }

      .system-message .agent-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-m);
        cursor: pointer;
        padding: var(--space-s);
        border-radius: var(--border-radius);
        transition: var(--transition-fast);
      }

      .system-message .agent-header:hover {
        background: rgba(116, 39, 116, 0.05);
      }

      .system-message .message-content {
        display: none;
        margin-top: var(--space-m);
        padding-top: var(--space-m);
        border-top: 1px solid rgba(116, 39, 116, 0.1);
        animation: expandContent 0.3s ease-out;
      }

      @keyframes expandContent {
        from {
          opacity: 0;
          max-height: 0;
        }
        to {
          opacity: 1;
          max-height: 1000px;
        }
      }

      .system-message.expanded .message-content {
        display: block;
      }

      .system-message .agent-name {
        font-weight: bold;
        color: var(--power-purple);
      }

      .system-message .expand-button {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        opacity: 0.7;
        padding: var(--space-s);
        transition: var(--transition-fast);
        border-radius: 50%;
      }

      .system-message .expand-button:hover {
        opacity: 1;
        background: rgba(116, 39, 116, 0.1);
      }

      .system-message .expand-button i {
        transition: var(--transition-fast);
      }

      .system-message.expanded .expand-button i {
        transform: rotate(180deg);
      }

      /* Message metadata */
      .message-meta {
        display: flex;
        align-items: center;
        gap: var(--space-s);
        margin-top: var(--space-s);
        padding-top: var(--space-s);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        font-size: 11px;
        opacity: 0.7;
      }

      .message-time {
        margin-right: auto;
      }

      .message-actions {
        display: flex;
        gap: var(--space-xs);
      }

      .message-action {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: var(--transition-fast);
        opacity: 0.7;
      }

      .message-action:hover {
        opacity: 1;
        background: rgba(0, 0, 0, 0.05);
      }

      /* Enhanced message content styling */
      .sender-label {
        font-size: 12px;
        margin-bottom: 6px;
        opacity: 0.7;
        font-weight: 500;
      }

      .message-content {
        position: relative;
      }

      .message a {
        color: #0078d4;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: var(--transition-fast);
        word-break: break-word;
      }

      .message a:hover {
        border-bottom-color: #0078d4;
      }

      .user-message a {
        color: white;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }

      .user-message a:hover {
        border-bottom-color: white;
      }

      .message pre {
        background: var(--ms-gray-10);
        padding: var(--space-l);
        border-radius: var(--border-radius);
        overflow-x: auto;
        margin: var(--space-m) 0;
        border: 1px solid var(--ms-gray-20);
        position: relative;
      }

      .message code {
        font-family: "SF Mono", Monaco, Consolas, monospace;
        font-size: 14px;
        tab-size: 2;
      }

      .user-message pre,
      .user-message code {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-color: rgba(255, 255, 255, 0.2);
      }

      /* Copy code button */
      .code-block-wrapper {
        position: relative;
      }

      .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--power-purple);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        transition: var(--transition-fast);
      }

      .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
      }

      .copy-code-button:hover {
        background: var(--power-purple-dark);
      }

      .copy-code-button.copied {
        background: #4caf50;
      }

      /* Tables */
      .message table {
        border-collapse: collapse;
        width: 100%;
        margin: var(--space-m) 0;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-small);
      }

      .message th,
      .message td {
        padding: var(--space-m);
        text-align: left;
        border-bottom: 1px solid var(--ms-gray-20);
      }

      .message th {
        background: var(--ms-gray-10);
        font-weight: 600;
        color: var(--power-purple);
      }

      .message tr:hover {
        background: var(--ms-gray-10);
      }

      .message tr:last-child td {
        border-bottom: none;
      }

      /* Input container - Enhanced */
      .input-container {
        background: white;
        border-top: 1px solid var(--ms-gray-20);
        padding: var(--space-l);
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: var(--space-m);
        align-items: end;
        backdrop-filter: blur(20px);
        flex-shrink: 0;
        position: relative;
        z-index: 10;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }

      #image-preview-container {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid var(--ms-gray-20);
        padding: var(--space-m);
        box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-m);
        max-height: 120px;
        overflow-y: auto;
      }

      .input-field-wrapper {
        position: relative;
        width: 100%;
      }

      .input-field {
        padding: var(--space-m) var(--space-l);
        border: 2px solid var(--ms-gray-30);
        border-radius: 25px;
        font-size: 16px;
        resize: none;
        min-height: 50px;
        max-height: 150px;
        transition: var(--transition-fast);
        width: 100%;
        background: var(--ms-gray-10);
        font-family: inherit;
        line-height: 1.5;
      }

      .input-field:focus {
        outline: none;
        border-color: var(--power-purple);
        background: white;
        box-shadow: 0 0 0 4px rgba(116, 39, 116, 0.1);
      }

      .input-field::placeholder {
        color: var(--ms-gray-100);
        opacity: 0.6;
      }

      /* Character counter */
      .char-counter {
        position: absolute;
        bottom: 8px;
        right: 20px;
        font-size: 11px;
        color: var(--ms-gray-100);
        opacity: 0.5;
        pointer-events: none;
      }

      .char-counter.warning {
        color: #ff9800;
        opacity: 0.8;
      }

      .char-counter.error {
        color: #f44336;
        opacity: 1;
      }

      .button {
        background: linear-gradient(135deg, var(--power-purple) 0%, var(--power-purple-light) 100%);
        color: white;
        border: none;
        border-radius: 50%;
        padding: 0;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
        min-width: 50px;
        box-shadow: var(--shadow-small);
        position: relative;
        overflow: hidden;
      }

      .button::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .button:hover::before {
        width: 100px;
        height: 100px;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .button:active {
        transform: translateY(0);
      }

      .button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .upload-button {
        position: relative;
        overflow: hidden;
        background: var(--ms-gray-30);
        color: var(--ms-gray-100);
      }

      .upload-button:hover {
        background: var(--ms-gray-40);
        color: var(--power-purple);
      }

      .upload-button input[type="file"] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      .loading {
        display: none;
        padding: var(--space-l);
        align-items: center;
        justify-content: center;
        gap: var(--space-s);
      }

      .loading span {
        width: 12px;
        height: 12px;
        background: var(--power-purple);
        border-radius: 50%;
        display: inline-block;
        animation: bounce 1.2s infinite;
      }

      .loading span:nth-child(2) {
        animation-delay: 0.3s;
      }

      .loading span:nth-child(3) {
        animation-delay: 0.6s;
      }

      @keyframes bounce {
        0%, 80%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      /* Modal styles - Enhanced */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: var(--transition);
      }

      .modal.show {
        opacity: 1;
      }

      .modal-content {
        background: white;
        padding: var(--space-xl);
        border-radius: var(--border-radius);
        min-width: 400px;
        max-width: 90%;
        box-shadow: var(--shadow-large);
        transform: scale(0.9);
        transition: var(--transition);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal.show .modal-content {
        transform: scale(1);
      }

      .modal h2 {
        margin: 0;
        color: var(--power-purple);
        font-size: 24px;
        margin-bottom: var(--space-l);
        display: flex;
        align-items: center;
        gap: var(--space-m);
      }

      .modal h2 i {
        font-size: 20px;
        opacity: 0.8;
      }

      .input-group {
        margin: var(--space-l) 0;
      }

      .input-group label {
        display: block;
        margin-bottom: var(--space-s);
        color: var(--ms-gray-100);
        font-weight: 500;
        font-size: 14px;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: var(--space-m);
        border: 2px solid var(--ms-gray-30);
        border-radius: var(--border-radius);
        font-size: 16px;
        transition: var(--transition-fast);
        font-family: inherit;
        background: var(--ms-gray-10);
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: var(--power-purple);
        background: white;
      }

      .input-group .helper-text {
        font-size: 12px;
        color: var(--ms-gray-100);
        opacity: 0.7;
        margin-top: var(--space-xs);
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-m);
        margin-top: var(--space-xl);
      }

      .button.secondary {
        background: var(--ms-gray-20);
        color: var(--ms-gray-100);
        border-radius: var(--border-radius);
        padding: var(--space-m) var(--space-l);
        height: auto;
        min-width: auto;
      }

      .button.secondary:hover {
        background: var(--ms-gray-30);
      }

      .button.primary {
        background: linear-gradient(135deg, var(--power-purple) 0%, var(--power-purple-light) 100%);
        border-radius: var(--border-radius);
        padding: var(--space-m) var(--space-l);
        height: auto;
        min-width: auto;
      }

      /* Image preview - Enhanced */
      .image-preview {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: var(--border-radius);
        overflow: hidden;
        border: 2px solid var(--ms-gray-30);
        transition: var(--transition-fast);
      }

      .image-preview:hover {
        border-color: var(--power-purple);
        transform: scale(1.05);
      }

      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-image {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-fast);
        opacity: 0;
      }

      .image-preview:hover .remove-image {
        opacity: 1;
      }

      .remove-image:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
      }

      .user-message .uploaded-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: var(--border-radius);
        margin-top: var(--space-m);
        display: block;
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .user-message .uploaded-image:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow-medium);
      }

      /* Paste indicator - Enhanced */
      .paste-indicator {
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 12px;
        color: var(--ms-gray-100);
        opacity: 0.7;
        pointer-events: none;
        transition: var(--transition-fast);
      }

      .paste-active .input-field {
        background-color: rgba(116, 39, 116, 0.05);
      }

      .paste-active .paste-indicator {
        opacity: 1;
        color: var(--power-purple);
      }

      /* Drop zone - Enhanced */
      .drop-zone {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(116, 39, 116, 0.1);
        border: 3px dashed var(--power-purple);
        z-index: 1000;
        display: flex;
        opacity: 0;
        pointer-events: none;
        transition: var(--transition);
        backdrop-filter: blur(8px);
      }

      .drop-zone.active {
        opacity: 1;
        pointer-events: all;
      }

      .drop-zone-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--power-purple);
        animation: dropZonePulse 2s infinite;
      }

      @keyframes dropZonePulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.05); }
      }

      .drop-zone-content i {
        font-size: 64px;
        margin-bottom: var(--space-l);
      }

      .drop-zone-content p {
        font-size: 20px;
        font-weight: 600;
      }

      /* Time Machine Styles - Enhanced */
      .time-machine-controls {
        position: fixed;
        bottom: calc(80px + 20px);
        left: 50%;
        transform: translate(-50%, 150%);
        background: var(--power-purple);
        padding: var(--space-m) var(--space-l);
        border-radius: 30px;
        display: flex;
        gap: var(--space-l);
        align-items: center;
        box-shadow: var(--shadow-large);
        z-index: 1000;
        transition: var(--transition);
        opacity: 0;
        pointer-events: none;
      }

      .time-machine-controls.visible {
        transform: translate(-50%, 0);
        opacity: 1;
        pointer-events: all;
      }

      .time-machine-button {
        background: transparent;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: var(--space-s);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.8;
        transition: var(--transition-fast);
        border-radius: 50%;
        width: 40px;
        height: 40px;
      }

      .time-machine-button:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
      }

      .time-machine-button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        transform: none;
      }

      .time-machine-button:disabled:hover {
        background: transparent;
      }

      .time-machine-progress {
        color: white;
        font-size: 14px;
        min-width: 100px;
        text-align: center;
        font-weight: 500;
      }

      .time-machine-toggle {
        position: fixed;
        bottom: 80px;
        right: 80px;
        background: var(--power-purple);
        color: white;
        border: none;
        padding: var(--space-m);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        z-index: 1000;
        box-shadow: var(--shadow-medium);
        transition: var(--transition);
        width: 56px;
        height: 56px;
      }

      .time-machine-toggle:hover {
        background: var(--power-purple-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-large);
      }

      .replay-mode .input-container {
        opacity: 0.5;
        pointer-events: none;
      }

      .replay-mode .input-field {
        background: var(--ms-gray-30);
      }

      @keyframes messageAppear {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.replay-animation {
        animation: messageAppear 0.5s ease forwards;
      }

      /* Paste notification - Enhanced */
      .paste-notification {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--power-purple);
        color: white;
        padding: var(--space-m) var(--space-l);
        border-radius: 25px;
        font-size: 14px;
        opacity: 0;
        transition: var(--transition);
        pointer-events: none;
        z-index: 100;
        box-shadow: var(--shadow-medium);
      }

      .paste-notification.active {
        opacity: 1;
        animation: notificationBounce 0.5s ease-out;
      }

      @keyframes notificationBounce {
        0% { transform: translateX(-50%) translateY(10px); }
        50% { transform: translateX(-50%) translateY(-5px); }
        100% { transform: translateX(-50%) translateY(0); }
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: calc(var(--header-height) + 20px);
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: var(--space-s);
        pointer-events: none;
      }

      .toast {
        background: white;
        padding: var(--space-m) var(--space-l);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-medium);
        display: flex;
        align-items: center;
        gap: var(--space-m);
        min-width: 300px;
        animation: slideInDown 0.3s ease-out;
        pointer-events: all;
      }

      @keyframes slideInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .toast.success {
        border-left: 4px solid #4caf50;
      }

      .toast.error {
        border-left: 4px solid #f44336;
      }

      .toast.info {
        border-left: 4px solid #2196f3;
      }

      .toast.warning {
        border-left: 4px solid #ff9800;
      }

      .toast i {
        font-size: 20px;
      }

      .toast.success i { color: #4caf50; }
      .toast.error i { color: #f44336; }
      .toast.info i { color: #2196f3; }
      .toast.warning i { color: #ff9800; }

      /* Dark mode styles - Enhanced */
      body.dark {
        background: linear-gradient(135deg, var(--ms-gray-130) 0%, #1a1a1a 100%);
        color: white;
      }

      body.dark .app-container {
        background: rgba(36, 36, 36, 0.95);
      }

      body.dark .chat-container {
        background: transparent;
      }

      body.dark .input-container {
        background: var(--ms-gray-100);
        border-top-color: var(--ms-gray-40);
      }

      body.dark .input-field {
        background: var(--ms-gray-130);
        color: white;
        border-color: var(--ms-gray-40);
      }

      body.dark .input-field:focus {
        background: var(--ms-gray-100);
        border-color: var(--power-purple-light);
        box-shadow: 0 0 0 4px rgba(145, 104, 182, 0.2);
      }

      body.dark .assistant-message {
        background: var(--ms-gray-130);
        color: white;
        border-color: var(--ms-gray-40);
      }

      body.dark .assistant-message::after {
        background: var(--ms-gray-130);
        border-color: var(--ms-gray-40);
      }

      body.dark .menu-items {
        background: var(--ms-gray-100);
        border-color: var(--ms-gray-40);
      }

      body.dark .menu-item {
        color: white;
        border-color: var(--ms-gray-40);
      }

      body.dark .menu-item:hover {
        background: var(--ms-gray-130);
        color: var(--power-purple-light);
      }

      body.dark .modal-content {
        background: var(--ms-gray-100);
        color: white;
      }

      body.dark .modal h2 {
        color: var(--power-purple-light);
      }

      body.dark .input-group label {
        color: white;
      }

      body.dark .input-group input,
      body.dark .input-group textarea {
        background: var(--ms-gray-130);
        color: white;
        border-color: var(--ms-gray-40);
      }

      body.dark .input-group input:focus,
      body.dark .input-group textarea:focus {
        border-color: var(--power-purple-light);
        background: var(--ms-gray-100);
      }

      body.dark .button.secondary {
        background: var(--ms-gray-130);
        color: white;
      }

      body.dark .button.secondary:hover {
        background: var(--ms-gray-40);
      }

      body.dark .guid-dropdown {
        background: var(--ms-gray-100);
        border-color: var(--ms-gray-40);
      }

      body.dark .guid-dropdown-item {
        border-color: var(--ms-gray-40);
      }

      body.dark .guid-dropdown-item:hover {
        background: var(--ms-gray-130);
      }

      body.dark .guid-dropdown-item .timestamp {
        color: white;
      }

      body.dark .drop-zone {
        background: rgba(255, 255, 255, 0.1);
      }

      body.dark .drop-zone-content {
        color: white;
      }

      body.dark .message a {
        color: #4cc9ff;
      }

      body.dark .message a:hover {
        border-bottom-color: #4cc9ff;
      }

      body.dark .message pre {
        background: var(--ms-gray-130);
        border-color: var(--ms-gray-40);
      }

      body.dark .message th {
        background: var(--ms-gray-130);
      }

      body.dark .message tr:hover {
        background: var(--ms-gray-130);
      }

      body.dark .toast {
        background: var(--ms-gray-100);
        color: white;
      }

      body.dark #image-preview-container {
        background: var(--ms-gray-100);
        border-color: var(--ms-gray-40);
      }

      body.dark .system-message {
        background: rgba(145, 104, 182, 0.1);
        border-color: rgba(145, 104, 182, 0.2);
      }

      body.dark .system-message::before {
        background: var(--power-purple-light);
      }

      body.dark .hljs {
        background: var(--ms-gray-130) !important;
      }

      /* Responsive design - Enhanced */
      @media (max-width: 768px) {
        :root {
          --header-height: 56px;
          --space-xs: 2px;
          --space-s: 4px;
          --space-m: 8px;
          --space-l: 16px;
          --space-xl: 24px;
        }

        .app-container {
          height: 100vh;
          width: 100vw;
          max-width: 100%;
          border-radius: 0;
        }

        .header {
          padding: 0 var(--space-m);
          min-height: var(--header-height);
        }

        .header h1 {
          font-size: 18px;
        }

        .header h1::before {
          width: 24px;
          height: 24px;
        }

        .connection-status {
          display: none;
        }

        .message {
          max-width: 95%;
          padding: var(--space-m);
        }

        .menu-container {
          top: calc(var(--header-height) + 8px);
          right: 8px;
        }

        .menu-toggle {
          width: 48px;
          height: 48px;
          font-size: 18px;
        }

        .time-machine-toggle {
          bottom: 70px;
          right: 60px;
          width: 48px;
          height: 48px;
        }

        .time-machine-controls {
          bottom: 80px;
          padding: var(--space-s) var(--space-m);
          gap: var(--space-m);
        }

        .input-field {
          font-size: 16px;
          padding: var(--space-s) var(--space-m);
        }

        .modal-content {
          width: 95%;
          margin: 20px;
          padding: var(--space-l);
          min-width: auto;
        }

        .chat-messages {
          padding: var(--space-m);
        }

        .input-container {
          padding: var(--space-m);
          grid-template-columns: auto 1fr auto;
          gap: var(--space-s);
        }

        .button {
          width: 44px;
          height: 44px;
        }

        .toast {
          min-width: 250px;
          max-width: 90vw;
        }

        .user-message::after,
        .assistant-message::after {
          display: none;
        }

        .user-message,
        .assistant-message {
          border-radius: 20px;
        }

        .guid-dropdown {
          min-width: 280px;
          max-width: 90vw;
        }

        .menu-item kbd {
          display: none;
        }
      }

      /* iOS specific fixes */
      @supports (-webkit-touch-callout: none) {
        .app-container {
          height: -webkit-fill-available;
          min-height: -webkit-fill-available;
        }
        
        body {
          height: -webkit-fill-available;
          min-height: -webkit-fill-available;
        }

        /* Prevent iOS rubber band scrolling */
        .chat-messages {
          -webkit-overflow-scrolling: touch;
          overscroll-behavior-y: contain;
        }
      }

      /* Safe area insets for notched devices */
      @supports (padding: max(0px)) {
        .header {
          padding-top: max(0px, env(safe-area-inset-top));
        }
        
        .input-container {
          padding-bottom: max(var(--space-l), env(safe-area-inset-bottom));
        }

        .menu-container {
          top: max(calc(var(--header-height) + 16px), calc(env(safe-area-inset-top) + var(--header-height) + 16px));
        }
      }

      /* Print styles */
      @media print {
        .menu-container,
        .time-machine-toggle,
        .input-container,
        .connection-status,
        .message-actions,
        .loading {
          display: none !important;
        }

        .app-container {
          box-shadow: none;
          height: auto;
        }

        .chat-container {
          height: auto;
        }

        .message {
          break-inside: avoid;
          box-shadow: none;
        }
      }

      /* Accessibility improvements */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }

      /* High contrast mode */
      @media (prefers-contrast: high) {
        :root {
          --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.3);
          --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.3);
          --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .message {
          border: 2px solid currentColor;
        }

        .input-field {
          border-width: 3px;
        }

        *:focus {
          outline-width: 3px;
        }
      }
    </style>
  </head>
  <body data-assistant-name="AI Assistant">
    <div class="app-container">
      <header class="header">
        <h1>AI Assistant</h1>
        <div class="connection-status">Connected</div>
      </header>

      <main class="chat-container" role="main">
        <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="Chat messages"></div>

        <div class="typing-indicator" id="typing-indicator" aria-label="Assistant is typing">
          <span></span>
          <span></span>
          <span></span>
        </div>

        <div class="loading" id="loading" aria-label="Loading">
          <span></span>
          <span></span>
          <span></span>
        </div>

        <!-- Menu System -->
        <div class="menu-container">
          <button class="menu-toggle" id="menu-toggle" aria-label="Open menu" aria-expanded="false">
            <i class="fas fa-plus" aria-hidden="true"></i>
          </button>
          
          <div class="menu-items" id="menu-items" role="menu" aria-labelledby="menu-toggle">
            <div class="menu-item" id="create-guid" role="menuitem" tabindex="-1" title="Create new GUID">
              <i class="fas fa-fingerprint" aria-hidden="true"></i>
              <span>New User ID</span>
              <kbd>Ctrl+N</kbd>
            </div>
            <div class="menu-item" id="reset-guid" role="menuitem" tabindex="-1" title="Manage user IDs" style="display: none">
              <i class="fas fa-users" aria-hidden="true"></i>
              <span>Manage IDs</span>
            </div>
            <div class="menu-item" id="clear-chat" role="menuitem" tabindex="-1" title="Clear chat">
              <i class="fas fa-trash-alt" aria-hidden="true"></i>
              <span>Clear Chat</span>
              <kbd>Ctrl+K</kbd>
            </div>
            <div class="menu-item" id="theme-toggle" role="menuitem" tabindex="-1" title="Toggle theme">
              <i class="fas fa-moon" aria-hidden="true"></i>
              <span>Dark Mode</span>
              <kbd>Ctrl+D</kbd>
            </div>
            <div class="menu-item" id="sound-toggle" role="menuitem" tabindex="-1" title="Toggle sounds">
              <i class="fas fa-volume-mute" aria-hidden="true"></i>
              <span>Toggle Sound</span>
            </div>
            <div class="menu-item" id="export-chat" role="menuitem" tabindex="-1" title="Export chat">
              <i class="fas fa-file-export" aria-hidden="true"></i>
              <span>Export Chat</span>
              <kbd>Ctrl+E</kbd>
            </div>
            <div class="menu-item" id="import-chat" role="menuitem" tabindex="-1" title="Import chat">
              <i class="fas fa-file-import" aria-hidden="true"></i>
              <span>Import Chat</span>
            </div>
            <div class="menu-item" id="export-guids" role="menuitem" tabindex="-1" title="Export GUIDs">
              <i class="fas fa-download" aria-hidden="true"></i>
              <span>Export IDs</span>
            </div>
            <div class="menu-item" id="import-guids" role="menuitem" tabindex="-1" title="Import GUIDs">
              <i class="fas fa-upload" aria-hidden="true"></i>
              <span>Import IDs</span>
            </div>
          </div>
          
          <div class="guid-dropdown" id="guid-dropdown" role="menu"></div>
        </div>

        <input type="file" id="chat-file-input" accept=".json" style="display: none" aria-hidden="true" />
        <input type="file" id="guid-file-input" accept=".json" style="display: none" aria-hidden="true" />

        <div id="drop-zone" class="drop-zone">
          <div class="drop-zone-content">
            <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
            <p>Drop conversation file here</p>
          </div>
        </div>

        <button class="time-machine-toggle" id="time-machine-toggle" title="Time Machine" aria-label="Open time machine">
          <i class="fas fa-clock" aria-hidden="true"></i>
        </button>

        <div class="time-machine-controls" id="time-machine-controls" role="toolbar" aria-label="Time machine controls">
          <button class="time-machine-button" id="step-backward" title="Previous message" aria-label="Previous message">
            <i class="fas fa-step-backward" aria-hidden="true"></i>
          </button>
          <button class="time-machine-button" id="play-pause" title="Play/Pause" aria-label="Play or pause">
            <i class="fas fa-play" aria-hidden="true"></i>
          </button>
          <button class="time-machine-button" id="step-forward" title="Next message" aria-label="Next message">
            <i class="fas fa-step-forward" aria-hidden="true"></i>
          </button>
          <div class="time-machine-progress" id="progress" aria-live="polite">0 / 0</div>
        </div>
        
        <div class="paste-notification" id="paste-notification" role="status" aria-live="polite">
          Image pasted! Click send to analyze.
        </div>
      </main>

      <div class="input-container">
        <div id="image-preview-container" class="image-preview-container" style="display: none"></div>
        <div class="button upload-button" title="Upload image" aria-label="Upload image">
          <i class="fas fa-image" aria-hidden="true"></i>
          <input type="file" id="image-upload" accept="image/*" aria-label="Choose image file" />
        </div>
        <div class="input-field-wrapper">
          <textarea
            class="input-field"
            id="user-input"
            placeholder="Type your message or paste an image..."
            aria-label="Message input"
            autocomplete="off"
            autocapitalize="sentences"
            rows="1"
            maxlength="10000"
          ></textarea>
          <div class="paste-indicator" id="paste-indicator" aria-hidden="true"></div>
          <div class="char-counter" id="char-counter" aria-live="polite" aria-atomic="true"></div>
        </div>
        <button class="button" id="send-button" aria-label="Send message">
          <i class="fas fa-paper-plane" aria-hidden="true"></i>
        </button>
      </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Modal for creating new GUID -->
    <div id="create-guid-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
      <div class="modal-content">
        <h2 id="modal-title">
          <i class="fas fa-fingerprint" aria-hidden="true"></i>
          Create New User ID
        </h2>
        <div class="input-group">
          <label for="guid-name">Name (optional):</label>
          <input 
            type="text" 
            id="guid-name" 
            placeholder="Enter a name for this ID" 
            maxlength="50"
            autocomplete="off"
          />
          <div class="helper-text">Give your ID a memorable name for easy identification</div>
        </div>
        <div class="modal-actions">
          <button id="modal-cancel" class="button secondary">Cancel</button>
          <button id="modal-create" class="button primary">Create</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const assistantName = document.body.dataset.assistantName || "AI Assistant";
        const azureFunctionUrl = "https://azfbusinessbot.azurewebsites.net/api/businessinsightbot_function";
        let functionKey = localStorage.getItem("functionKey");

        // Utility functions
        const debounce = (func, wait) => {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        };

        const throttle = (func, limit) => {
          let inThrottle;
          return function(...args) {
            if (!inThrottle) {
              func.apply(this, args);
              inThrottle = true;
              setTimeout(() => inThrottle = false, limit);
            }
          };
        };

        // Toast notification system
        class ToastManager {
          constructor() {
            this.container = document.getElementById("toast-container");
          }

          show(message, type = "info", duration = 3000) {
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            
            const icons = {
              success: "fa-check-circle",
              error: "fa-exclamation-circle",
              info: "fa-info-circle",
              warning: "fa-exclamation-triangle"
            };

            toast.innerHTML = `
              <i class="fas ${icons[type]}" aria-hidden="true"></i>
              <span>${message}</span>
            `;

            this.container.appendChild(toast);

            setTimeout(() => {
              toast.style.opacity = "0";
              toast.style.transform = "translateY(-20px)";
              setTimeout(() => toast.remove(), 300);
            }, duration);
          }
        }

        const toastManager = new ToastManager();

        // Enhanced Menu System
        const menuToggle = document.getElementById("menu-toggle");
        const menuItems = document.getElementById("menu-items");
        let menuOpen = false;

        const toggleMenu = (open = !menuOpen) => {
          menuOpen = open;
          menuToggle.classList.toggle("active", menuOpen);
          menuItems.classList.toggle("open", menuOpen);
          menuToggle.setAttribute("aria-expanded", menuOpen);
          
          if (menuOpen) {
            menuItems.querySelector(".menu-item").focus();
          }
        };

        menuToggle.addEventListener("click", () => toggleMenu());

        // Keyboard navigation for menu
        menuItems.addEventListener("keydown", (e) => {
          const items = Array.from(menuItems.querySelectorAll(".menu-item"));
          const currentIndex = items.indexOf(document.activeElement);

          switch(e.key) {
            case "ArrowDown":
              e.preventDefault();
              items[(currentIndex + 1) % items.length].focus();
              break;
            case "ArrowUp":
              e.preventDefault();
              items[(currentIndex - 1 + items.length) % items.length].focus();
              break;
            case "Escape":
              toggleMenu(false);
              menuToggle.focus();
              break;
          }
        });

        // Close menu when clicking outside
        document.addEventListener("click", (e) => {
          if (!menuToggle.contains(e.target) && !menuItems.contains(e.target)) {
            toggleMenu(false);
          }
        });

        // Close menu when clicking on menu items
        document.querySelectorAll(".menu-item").forEach(item => {
          item.addEventListener("click", () => toggleMenu(false));
        });

        // Auto-resize textarea with max height
        const userInput = document.getElementById("user-input");
        const charCounter = document.getElementById("char-counter");
        
        const updateCharCounter = () => {
          const length = userInput.value.length;
          const maxLength = parseInt(userInput.getAttribute("maxlength"));
          charCounter.textContent = `${length}/${maxLength}`;
          
          if (length > maxLength * 0.9) {
            charCounter.classList.add("error");
            charCounter.classList.remove("warning");
          } else if (length > maxLength * 0.75) {
            charCounter.classList.add("warning");
            charCounter.classList.remove("error");
          } else {
            charCounter.classList.remove("warning", "error");
          }
        };

        userInput.addEventListener("input", function() {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 150) + "px";
          updateCharCounter();
        });

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
              case "k":
                e.preventDefault();
                document.getElementById("clear-chat").click();
                break;
              case "n":
                e.preventDefault();
                document.getElementById("create-guid").click();
                break;
              case "d":
                e.preventDefault();
                document.getElementById("theme-toggle").click();
                break;
              case "e":
                e.preventDefault();
                document.getElementById("export-chat").click();
                break;
              case "/":
                e.preventDefault();
                userInput.focus();
                break;
            }
          }
        });

        // Image Upload Handler Class - Enhanced
        class ImageUploadHandler {
          constructor() {
            this.uploadedImages = [];
            this.imagePreviewContainer = document.getElementById("image-preview-container");
            this.imageUploadInput = document.getElementById("image-upload");
            this.userInputField = document.getElementById("user-input");
            this.pasteIndicator = document.getElementById("paste-indicator");
            this.pasteNotification = document.getElementById("paste-notification");

            this.initImageUploadEvents();
            this.initPasteEvents();
          }

          initImageUploadEvents() {
            this.imageUploadInput.addEventListener("change", (event) => {
              const files = event.target.files;
              if (files && files.length > 0) {
                this.handleImageFiles(files);
              }
              event.target.value = "";
            });

            const preventDefaults = this.preventDefaults.bind(this);
            const handleDrop = this.handleDrop.bind(this);

            ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
              document.body.addEventListener(eventName, preventDefaults, false);
            });

            ["dragenter", "dragover"].forEach((eventName) => {
              document.body.addEventListener(eventName, () => {
                document.getElementById("drop-zone").classList.add("active");
              });
            });

            ["dragleave", "drop"].forEach((eventName) => {
              document.body.addEventListener(eventName, () => {
                document.getElementById("drop-zone").classList.remove("active");
              });
            });

            document.body.addEventListener("drop", handleDrop);
          }

          initPasteEvents() {
            this.userInputField.addEventListener("paste", async (event) => {
              const items = (event.clipboardData || event.originalEvent.clipboardData).items;
              let hasImage = false;

              for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                  hasImage = true;
                  const blob = items[i].getAsFile();
                  
                  try {
                    const imageData = await this.readImageAsDataURL(blob);
                    this.clearImages();
                    this.uploadedImages.push(imageData);
                    this.updateImagePreview();
                    this.showPasteNotification();
                    event.preventDefault();
                  } catch (error) {
                    toastManager.show("Failed to paste image", "error");
                  }
                  break;
                }
              }
              
              if (!hasImage) {
                this.pasteIndicator.textContent = "";
              }
            });

            this.userInputField.addEventListener("focus", () => {
              this.userInputField.parentElement.classList.add("paste-active");
              this.pasteIndicator.textContent = "Ctrl+V to paste image";
            });

            this.userInputField.addEventListener("blur", () => {
              this.userInputField.parentElement.classList.remove("paste-active");
              this.pasteIndicator.textContent = "";
            });
          }

          showPasteNotification() {
            this.pasteNotification.classList.add("active");
            
            if (this.notificationTimeout) {
              clearTimeout(this.notificationTimeout);
            }
            
            this.notificationTimeout = setTimeout(() => {
              this.pasteNotification.classList.remove("active");
            }, 3000);
          }

          preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
          }

          handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files && files.length > 0) {
              // Check if it's a JSON file for chat import
              if (files[0].type === "application/json") {
                handleChatFileImport(files[0]);
              } else {
                this.handleImageFiles(files);
              }
            }
          }

          async handleImageFiles(files) {
            const imageFiles = Array.from(files).filter(file => file.type.startsWith("image/"));
            
            if (imageFiles.length === 0) {
              toastManager.show("Please select image files only", "warning");
              return;
            }

            if (imageFiles.length + this.uploadedImages.length > 5) {
              toastManager.show("Maximum 5 images allowed", "warning");
              return;
            }

            for (const file of imageFiles) {
              if (file.size > 10 * 1024 * 1024) { // 10MB limit
                toastManager.show(`${file.name} is too large (max 10MB)`, "error");
                continue;
              }
              await this.readAndPreviewImage(file);
            }
          }

          readImageAsDataURL(blob) {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => resolve(e.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            });
          }

          async readAndPreviewImage(file) {
            try {
              const imageData = await this.readImageAsDataURL(file);
              this.uploadedImages.push(imageData);
              this.updateImagePreview();
              toastManager.show(`${file.name} uploaded`, "success");
            } catch (error) {
              toastManager.show(`Failed to upload ${file.name}`, "error");
            }
          }

          updateImagePreview() {
            if (this.uploadedImages.length === 0) {
              this.imagePreviewContainer.style.display = "none";
              return;
            }

            this.imagePreviewContainer.innerHTML = "";
            this.imagePreviewContainer.style.display = "flex";

            this.uploadedImages.forEach((imageData, index) => {
              const previewDiv = document.createElement("div");
              previewDiv.className = "image-preview";

              previewDiv.innerHTML = `
                <img src="${imageData}" alt="Preview ${index + 1}"/>
                <button class="remove-image" data-index="${index}" aria-label="Remove image">
                  <i class="fas fa-times" aria-hidden="true"></i>
                </button>
              `;

              this.imagePreviewContainer.appendChild(previewDiv);

              previewDiv.querySelector(".remove-image").addEventListener("click", (e) => {
                const idx = parseInt(e.currentTarget.dataset.index);
                this.uploadedImages.splice(idx, 1);
                this.updateImagePreview();
                toastManager.show("Image removed", "info");
              });
            });
          }

          clearImages() {
            this.uploadedImages = [];
            this.updateImagePreview();
          }

          hasImages() {
            return this.uploadedImages.length > 0;
          }

          getImages() {
            return [...this.uploadedImages];
          }
        }

        // Enhanced Sound Manager
        class SoundManager {
          constructor() {
            this.audioContext = null;
            this.bellBuffer = null;
            this.responseBuffer = null;
            this.errorBuffer = null;
            this.loopTimeout = null;
            this.isPlaying = false;

            const savedSoundPreference = localStorage.getItem("soundEnabled");
            this.volume = savedSoundPreference === "on" ? 0.3 : 0;
            this.isInitialized = false;

            this.initializeAudio();
          }

          async initializeAudio() {
            if (this.isInitialized) return;

            try {
              this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

              // Bell sound
              const bellBuffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 1, this.audioContext.sampleRate);
              const bellData = bellBuffer.getChannelData(0);
              for (let i = 0; i < bellBuffer.length; i++) {
                bellData[i] = Math.sin((440 * Math.PI * 2 * i) / this.audioContext.sampleRate) * Math.exp((-3 * i) / bellBuffer.length);
              }
              this.bellBuffer = bellBuffer;

              // Response sound
              const responseBuffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 0.5, this.audioContext.sampleRate);
              const responseData = responseBuffer.getChannelData(0);
              for (let i = 0; i < responseBuffer.length; i++) {
                responseData[i] = Math.sin((880 * Math.PI * 2 * i) / this.audioContext.sampleRate) * Math.exp((-5 * i) / responseBuffer.length);
              }
              this.responseBuffer = responseBuffer;

              // Error sound
              const errorBuffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 0.3, this.audioContext.sampleRate);
              const errorData = errorBuffer.getChannelData(0);
              for (let i = 0; i < errorBuffer.length; i++) {
                errorData[i] = Math.sin((220 * Math.PI * 2 * i) / this.audioContext.sampleRate) * Math.exp((-8 * i) / errorBuffer.length);
              }
              this.errorBuffer = errorBuffer;

              this.isInitialized = true;
            } catch (error) {
              console.warn("Error initializing audio:", error);
            }
          }

          async playSound(buffer, volume = 0.3) {
            if (!this.isInitialized || !this.audioContext || !buffer || this.volume === 0) return;

            try {
              const source = this.audioContext.createBufferSource();
              const gainNode = this.audioContext.createGain();

              source.buffer = buffer;
              gainNode.gain.value = volume * this.volume;

              source.connect(gainNode);
              gainNode.connect(this.audioContext.destination);

              source.start(0);
              gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 2.0);
            } catch (error) {
              console.warn("Error playing sound:", error);
            }
          }

          async startBellSequence() {
            if (this.isPlaying) return;

            if (this.audioContext?.state === "suspended") {
              await this.audioContext.resume();
            }

            this.isPlaying = true;
            await this.playSound(this.bellBuffer);
            this.scheduleNextBell();
          }

          async scheduleNextBell() {
            if (!this.isPlaying) return;

            this.loopTimeout = setTimeout(async () => {
              if (this.isPlaying) {
                await this.playSound(this.bellBuffer, 0.15);
                this.scheduleNextBell();
              }
            }, 3000);
          }

          stopBellSequence() {
            this.isPlaying = false;
            if (this.loopTimeout) {
              clearTimeout(this.loopTimeout);
              this.loopTimeout = null;
            }
          }

          async playResponseSound() {
            await this.playSound(this.responseBuffer, 0.2);
          }

          async playErrorSound() {
            await this.playSound(this.errorBuffer, 0.3);
          }

          setVolume(volume) {
            this.volume = volume;
          }

          mute() {
            this.volume = 0;
            localStorage.setItem("soundEnabled", "off");
          }

          unmute() {
            this.volume = 0.3;
            localStorage.setItem("soundEnabled", "on");
          }
        }

        const soundManager = new SoundManager();

        // Enhanced Conversation Manager
        class ConversationManager {
          constructor() {
            this.conversationHistory = [];
            this.cachedGuid = localStorage.getItem("userGuid");
            this.guidHistory = JSON.parse(localStorage.getItem("guidHistory") || "[]");
            this.typingIndicator = document.getElementById("typing-indicator");
            this.loadHistory();
            this.initializeGuidHandling();
          }

          initializeGuidHandling() {
            const resetButton = document.getElementById("reset-guid");
            const dropdown = document.getElementById("guid-dropdown");
            const createGuidButton = document.getElementById("create-guid");
            const createGuidModal = document.getElementById("create-guid-modal");
            const modalCancel = document.getElementById("modal-cancel");
            const modalCreate = document.getElementById("modal-create");
            const guidNameInput = document.getElementById("guid-name");

            if (this.cachedGuid) {
              resetButton.style.display = "flex";
              if (this.conversationHistory.length === 0) {
                this.addMessage("user", this.cachedGuid);
              }
            }

            this.updateGuidDropdown();

            createGuidButton.addEventListener("click", () => {
              createGuidModal.style.display = "flex";
              setTimeout(() => createGuidModal.classList.add("show"), 10);
              guidNameInput.focus();
            });

            modalCancel.addEventListener("click", () => {
              this.closeModal(createGuidModal, guidNameInput);
            });

            modalCreate.addEventListener("click", () => {
              const name = guidNameInput.value.trim();
              const newGuid = this.generateGuid();

              this.guidHistory.unshift({
                guid: newGuid,
                name: name,
                timestamp: new Date().toISOString(),
              });

              this.switchToGuid(newGuid);
              localStorage.setItem("guidHistory", JSON.stringify(this.guidHistory));
              
              this.closeModal(createGuidModal, guidNameInput);
              toastManager.show("New User ID created", "success");
            });

            // Modal keyboard handling
            createGuidModal.addEventListener("keydown", (e) => {
              if (e.key === "Escape") {
                this.closeModal(createGuidModal, guidNameInput);
              }
            });

            guidNameInput.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                modalCreate.click();
              }
            });

            createGuidModal.addEventListener("click", (e) => {
              if (e.target === createGuidModal) {
                this.closeModal(createGuidModal, guidNameInput);
              }
            });

            resetButton.addEventListener("click", (e) => {
              e.stopPropagation();
              dropdown.classList.toggle("show");
            });

            document.addEventListener("click", (e) => {
              if (!dropdown.contains(e.target) && !resetButton.contains(e.target)) {
                dropdown.classList.remove("show");
              }
            });

            document.getElementById("export-guids").addEventListener("click", () => this.exportGuids());
            document.getElementById("import-guids").addEventListener("click", () => this.importGuids());
            document.getElementById("guid-file-input").addEventListener("change", (event) => {
              const file = event.target.files[0];
              if (file) {
                this.handleGuidFileImport(file);
              }
              event.target.value = "";
            });
          }

          closeModal(modal, input) {
            modal.classList.remove("show");
            setTimeout(() => {
              modal.style.display = "none";
              if (input) input.value = "";
            }, 300);
          }

          generateGuid() {
            return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
              const r = (Math.random() * 16) | 0;
              const v = c === "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            });
          }

          exportGuids() {
            const exportData = {
              cachedGuid: this.cachedGuid,
              guidHistory: this.guidHistory,
              timestamp: new Date().toISOString(),
              version: "1.0"
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `user-ids-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            toastManager.show("User IDs exported successfully", "success");
          }

          importGuids() {
            document.getElementById("guid-file-input").click();
          }

          async handleGuidFileImport(file) {
            if (!file || file.type !== "application/json") {
              toastManager.show("Please select a valid JSON file", "error");
              return;
            }

            try {
              const text = await file.text();
              const importedData = JSON.parse(text);

              if (!importedData.guidHistory || !Array.isArray(importedData.guidHistory)) {
                throw new Error("Invalid GUID history format");
              }

              this.guidHistory = importedData.guidHistory;
              localStorage.setItem("guidHistory", JSON.stringify(this.guidHistory));

              if (importedData.cachedGuid) {
                this.cachedGuid = importedData.cachedGuid;
                localStorage.setItem("userGuid", importedData.cachedGuid);
                document.getElementById("reset-guid").style.display = "flex";
              }

              this.updateGuidDropdown();
              toastManager.show("User IDs imported successfully", "success");
            } catch (error) {
              toastManager.show(`Error importing User IDs: ${error.message}`, "error");
            }
          }

          loadHistory() {
            try {
              const saved = localStorage.getItem("chatHistory");
              if (saved) {
                this.conversationHistory = JSON.parse(saved);
                this.displayLoadedHistory();
              }
            } catch (e) {
              console.warn("Failed to load chat history:", e);
              localStorage.removeItem("chatHistory");
            }
          }

          displayLoadedHistory() {
            document.getElementById("chat-messages").innerHTML = "";
            this.conversationHistory.forEach((msg) => {
              this.addMessage(msg.role, msg.content, false);
            });
          }

          saveHistory() {
            try {
              localStorage.setItem("chatHistory", JSON.stringify(this.conversationHistory));
            } catch (e) {
              console.warn("Failed to save chat history:", e);
              if (e.name === "QuotaExceededError") {
                toastManager.show("Storage full. Consider exporting your chat.", "warning");
              }
            }
          }

          updateGuidDropdown() {
            const dropdown = document.getElementById("guid-dropdown");
            dropdown.innerHTML = "";

            this.guidHistory.forEach((guidInfo, index) => {
              const item = document.createElement("div");
              item.className = "guid-dropdown-item";
              item.setAttribute("role", "menuitem");
              item.innerHTML = `
                <div class="guid-info">
                  ${guidInfo.name ? `<div class="guid-name">${this.escapeHtml(guidInfo.name)}</div>` : ""}
                  <div class="guid">${guidInfo.guid}</div>
                  <div class="timestamp">${new Date(guidInfo.timestamp).toLocaleString()}</div>
                </div>
                <div class="actions">
                  <button class="edit-name" title="Edit name" aria-label="Edit name">
                    <i class="fas fa-edit" aria-hidden="true"></i>
                  </button>
                  <button class="delete-guid" title="Remove from history" aria-label="Remove from history">
                    <i class="fas fa-times" aria-hidden="true"></i>
                  </button>
                </div>
              `;

              item.addEventListener("click", (e) => {
                if (!e.target.closest(".edit-name") && !e.target.closest(".delete-guid")) {
                  this.switchToGuid(guidInfo.guid);
                  dropdown.classList.remove("show");
                }
              });

              item.querySelector(".edit-name").addEventListener("click", (e) => {
                e.stopPropagation();
                const newName = prompt("Enter a name for this User ID:", guidInfo.name || "");
                if (newName !== null) {
                  this.updateGuidName(index, newName);
                }
              });

              item.querySelector(".delete-guid").addEventListener("click", (e) => {
                e.stopPropagation();
                if (confirm("Remove this User ID from history?")) {
                  this.removeGuidFromHistory(index);
                }
              });

              dropdown.appendChild(item);
            });

            if (this.cachedGuid) {
              const clearItem = document.createElement("div");
              clearItem.className = "guid-dropdown-item";
              clearItem.setAttribute("role", "menuitem");
              clearItem.innerHTML = `
                <div class="guid-info">
                  <div class="guid">Clear current User ID</div>
                </div>
              `;
              clearItem.addEventListener("click", () => {
                this.clearCurrentGuid();
                dropdown.classList.remove("show");
              });
              dropdown.appendChild(clearItem);
            }
          }

          escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
          }

          updateGuidName(index, newName) {
            this.guidHistory[index].name = newName.trim();
            localStorage.setItem("guidHistory", JSON.stringify(this.guidHistory));
            this.updateGuidDropdown();
            toastManager.show("Name updated", "success");
          }

          removeGuidFromHistory(index) {
            const guidToRemove = this.guidHistory[index].guid;
            this.guidHistory.splice(index, 1);
            localStorage.setItem("guidHistory", JSON.stringify(this.guidHistory));

            if (this.cachedGuid === guidToRemove) {
              this.clearCurrentGuid();
            }

            this.updateGuidDropdown();
            toastManager.show("User ID removed", "info");
          }

          switchToGuid(guid) {
            this.cachedGuid = guid;
            localStorage.setItem("userGuid", guid);
            document.getElementById("reset-guid").style.display = "flex";

            this.clear();
            this.addMessage("user", guid);
            this.addGuidToHistory(guid);
          }

          clearCurrentGuid() {
            if (confirm("Are you sure you want to clear the current User ID? This will clear your conversation history.")) {
              localStorage.removeItem("userGuid");
              this.cachedGuid = null;
              this.clear();
              this.updateGuidDropdown();
              toastManager.show("User ID cleared", "info");
            }
          }

          addGuidToHistory(guid) {
            const existingIndex = this.guidHistory.findIndex((item) => item.guid === guid);
            if (existingIndex !== -1) {
              this.guidHistory[existingIndex].timestamp = new Date().toISOString();
            } else {
              this.guidHistory.push({
                guid: guid,
                name: "",
                timestamp: new Date().toISOString(),
              });
            }

            this.guidHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            localStorage.setItem("guidHistory", JSON.stringify(this.guidHistory));
            this.updateGuidDropdown();
          }

          showTypingIndicator() {
            this.typingIndicator.classList.add("active");
            this.scrollToBottom();
          }

          hideTypingIndicator() {
            this.typingIndicator.classList.remove("active");
          }

          addMessage(role, content, shouldSave = true) {
            const hasImage = content && content.startsWith && (
              content.startsWith('data:image') ||
              content.includes('<img src="data:image')
            );

            const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (role === "user" && guidPattern.test(content)) {
              this.cachedGuid = content;
              localStorage.setItem("userGuid", content);
              document.getElementById("reset-guid").style.display = "flex";
              this.addGuidToHistory(content);
            }

            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${role}-message`;
            
            // Add message metadata
            const timestamp = new Date().toISOString();
            messageDiv.dataset.timestamp = timestamp;

            if (role === "system") {
              this.formatSystemMessage(messageDiv, content);
            } else {
              this.formatUserOrAssistantMessage(messageDiv, role, content, hasImage);
            }

            // Add message actions
            if (role !== "system") {
              this.addMessageActions(messageDiv, content);
            }

            document.getElementById("chat-messages").appendChild(messageDiv);

            if (shouldSave) {
              this.conversationHistory.push({ role, content, timestamp });
              this.saveHistory();
            }

            this.scrollToBottom();

            if (role === "assistant" || role === "system") {
              messageDiv.querySelectorAll("pre code").forEach((block) => {
                hljs.highlightBlock(block);
                this.addCopyButton(block);
              });
            }
          }

          addMessageActions(messageDiv, content) {
            const meta = document.createElement("div");
            meta.className = "message-meta";
            
            const time = document.createElement("span");
            time.className = "message-time";
            time.textContent = new Date(messageDiv.dataset.timestamp).toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit'
            });
            
            const actions = document.createElement("div");
            actions.className = "message-actions";
            
            // Copy button
            const copyBtn = document.createElement("button");
            copyBtn.className = "message-action";
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            copyBtn.addEventListener("click", () => {
              navigator.clipboard.writeText(content).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied';
                setTimeout(() => {
                  copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                }, 2000);
              });
            });
            
            actions.appendChild(copyBtn);
            meta.appendChild(time);
            meta.appendChild(actions);
            messageDiv.appendChild(meta);
          }

          addCopyButton(codeBlock) {
            const wrapper = document.createElement("div");
            wrapper.className = "code-block-wrapper";
            codeBlock.parentNode.insertBefore(wrapper, codeBlock);
            wrapper.appendChild(codeBlock);

            const button = document.createElement("button");
            button.className = "copy-code-button";
            button.innerHTML = '<i class="fas fa-copy"></i> Copy';
            
            button.addEventListener("click", () => {
              const code = codeBlock.textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.innerHTML = '<i class="fas fa-check"></i> Copied';
                button.classList.add("copied");
                setTimeout(() => {
                  button.innerHTML = '<i class="fas fa-copy"></i> Copy';
                  button.classList.remove("copied");
                }, 2000);
              });
            });

            wrapper.appendChild(button);
          }

          formatSystemMessage(messageDiv, content) {
            const multipleAgentCalls = content.includes("Performed ") &&
              content.indexOf("Performed ", content.indexOf("Performed ") + 1) > 0;

            if (multipleAgentCalls) {
              const parts = content.split(/(?=Performed )/);

              const headerDiv = document.createElement("div");
              headerDiv.className = "agent-header";
              headerDiv.innerHTML = `
                <span>Multiple agents were called</span>
                <button class="expand-button" title="Show details">
                  <i class="fas fa-chevron-down"></i>
                </button>
              `;

              const contentDiv = document.createElement("div");
              contentDiv.className = "message-content";

              parts.forEach((part, index) => {
                if (part.trim()) {
                  const agentMatch = part.match(/^Performed (\w+)/);
                  if (agentMatch) {
                    const agentName = agentMatch[1];
                    const agentSection = document.createElement("div");
                    agentSection.className = "agent-section";
                    agentSection.innerHTML = `
                      <div class="agent-subheader">
                        <span>Agent #${index + 1}: <span class="agent-name">${agentName}</span></span>
                      </div>
                      <div class="agent-content">
                        ${this.formatResponse(part.replace(/^Performed \w+ and got result: /, ""))}
                      </div>
                    `;
                    contentDiv.appendChild(agentSection);

                    if (index < parts.length - 1) {
                      const separator = document.createElement("hr");
                      separator.style.margin = "15px 0";
                      separator.style.opacity = "0.3";
                      contentDiv.appendChild(separator);
                    }
                  }
                }
              });

              messageDiv.appendChild(headerDiv);
              messageDiv.appendChild(contentDiv);

              headerDiv.addEventListener("click", this.handleSystemMessageExpand);
            } else {
              const agentMatch = content.match(/^Performed (\w+)/);
              if (agentMatch) {
                const agentName = agentMatch[1];
                const headerDiv = document.createElement("div");
                headerDiv.className = "agent-header";
                headerDiv.innerHTML = `
                  <span>Performed <span class="agent-name">${agentName}</span></span>
                  <button class="expand-button" title="Show details">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                `;

                const contentDiv = document.createElement("div");
                contentDiv.className = "message-content";
                contentDiv.innerHTML = this.formatResponse(content.replace(/^Performed \w+ and got result: /, ""));

                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);

                headerDiv.addEventListener("click", this.handleSystemMessageExpand);
              } else {
                messageDiv.innerHTML = this.formatResponse(content);
              }
            }
          }

          formatUserOrAssistantMessage(messageDiv, role, content, hasImage = false) {
            const senderName = role === "user" ? "You" : assistantName;
            const senderLabel = document.createElement("div");
            senderLabel.className = "sender-label";
            senderLabel.textContent = senderName;

            const contentDiv = document.createElement("div");
            contentDiv.className = "message-content";

            if (hasImage && role === "user") {
              if (content.startsWith('data:image')) {
                const img = document.createElement("img");
                img.src = content;
                img.alt = "Uploaded image";
                img.className = "uploaded-image";
                img.addEventListener("click", () => this.openImageModal(content));
                contentDiv.appendChild(img);
              } else if (content.includes('<img src="data:image')) {
                contentDiv.innerHTML = content;
                contentDiv.querySelectorAll("img").forEach(img => {
                  img.addEventListener("click", () => this.openImageModal(img.src));
                });
              }
            } else {
              contentDiv.innerHTML = role === "user" ? this.escapeHtml(content) : this.formatResponse(content);
            }

            messageDiv.appendChild(senderLabel);
            messageDiv.appendChild(contentDiv);
          }

          openImageModal(src) {
            const modal = document.createElement("div");
            modal.className = "modal show";
            modal.style.display = "flex";
            modal.innerHTML = `
              <div style="position: relative; max-width: 90%; max-height: 90%;">
                <img src="${src}" style="max-width: 100%; max-height: 90vh; border-radius: var(--border-radius);" />
                <button class="button" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7);">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;
            
            modal.addEventListener("click", (e) => {
              if (e.target === modal || e.target.closest("button")) {
                modal.remove();
              }
            });
            
            document.body.appendChild(modal);
          }

          formatResponse(text) {
            if (text.trim().startsWith("{") || text.trim().startsWith("[")) {
              try {
                const json = JSON.parse(text);
                return `<pre><code class="json">${JSON.stringify(json, null, 2)}</code></pre>`;
              } catch (e) {
                // Not valid JSON, continue formatting
              }
            }

            const codeBlocks = [];
            text = text.replace(/```(\w+)?\n([\s\S]+?)```/g, (match, language, code) => {
              codeBlocks.push({
                language: language || "",
                code: code.trim(),
              });
              return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
            });

            // Format tables
            text = text.replace(/(\|[^\n]+\|\n)+/g, (match) => {
              const lines = match.trim().split('\n');
              if (lines.length < 2) return match;

              const headerLine = lines[0];
              const separatorLine = lines[1];
              
              if (!headerLine.includes('|') || !separatorLine.includes('|')) {
                return match;
              }

              const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
              const isSeparator = separatorLine.includes('-') || separatorLine.includes('=');
              const dataStartIndex = isSeparator ? 2 : 1;
              
              if (headers.length === 0) return match;

              let tableHTML = '<table><thead><tr>';
              headers.forEach(header => {
                tableHTML += `<th>${this.escapeHtml(header)}</th>`;
              });
              tableHTML += '</tr></thead><tbody>';

              for (let i = dataStartIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line.includes('|')) continue;
                
                const cells = line.split('|').map(c => c.trim()).filter(c => c);
                if (cells.length === 0) continue;

                tableHTML += '<tr>';
                cells.forEach((cell, index) => {
                  const label = headers[index] || '';
                  tableHTML += `<td data-label="${this.escapeHtml(label)}">${this.escapeHtml(cell)}</td>`;
                });
                tableHTML += '</tr>';
              }

              tableHTML += '</tbody></table>';
              return tableHTML;
            });

            // Format links
            text = text.replace(/\(URL: ([^)]+)\)/g, (match, url) => {
              return `<a href="${url.trim()}" target="_blank" rel="noopener noreferrer">${url.trim()}</a>`;
            });

            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
              const decodedUrl = url.replace(/&amp;/g, "&");
              return `<a href="${decodedUrl}" target="_blank" rel="noopener noreferrer">${this.escapeHtml(linkText)}</a>`;
            });

            text = text.replace(/(?<!["\'])(https?:\/\/[^\s<>]+)(?![^<]*>|[^<>]*<\/)/g,
              '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
            );

            // Format text
            text = text
              .replace(/`([^`]+)`/g, "<code>$1</code>")
              .replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>")
              .replace(/\*([^*]+)\*/g, "<em>$1</em>")
              .replace(/\n/g, "<br>");

            // Restore code blocks
            text = text.replace(/__CODE_BLOCK_(\d+)__/g, (match, index) => {
              const block = codeBlocks[parseInt(index)];
              const highlightedCode = hljs.highlightAuto(block.code, block.language ? [block.language] : undefined).value;
              return `<pre><code class="${block.language}">${highlightedCode}</code></pre>`;
            });

            return text;
          }

          handleSystemMessageExpand(e) {
            if (e.target.closest(".expand-button") || e.target === this) {
              const messageDiv = this.closest(".message");
              messageDiv.classList.toggle("expanded");
              e.stopPropagation();
            }
          }

          scrollToBottom(immediate = false) {
            const chatMessages = document.getElementById("chat-messages");
            chatMessages.scrollTo({
              top: chatMessages.scrollHeight,
              behavior: immediate ? "auto" : "smooth",
            });
          }

          clear() {
            document.getElementById("chat-messages").innerHTML = "";
            this.conversationHistory = [];
            localStorage.removeItem("chatHistory");
          }
        }

        const conversationManager = new ConversationManager();

        // Time Machine class - Enhanced
        class TimeMachine {
          constructor(conversationManager) {
            this.conversationManager = conversationManager;
            this.currentIndex = 0;
            this.isPlaying = false;
            this.playbackSpeed = 1000;
            this.playbackTimeout = null;
            this.originalHistory = [];

            this.initializeControls();
          }

          initializeControls() {
            const timeMachineToggle = document.getElementById("time-machine-toggle");
            const controls = document.getElementById("time-machine-controls");
            const stepBackward = document.getElementById("step-backward");
            const stepForward = document.getElementById("step-forward");
            const playPause = document.getElementById("play-pause");

            timeMachineToggle.addEventListener("click", () => {
              controls.classList.toggle("visible");
              if (!controls.classList.contains("visible")) {
                this.stopPlayback();
                document.body.classList.remove("replay-mode");
                this.restoreOriginalConversation();
              } else {
                document.body.classList.add("replay-mode");
                this.startReplay();
              }
            });

            stepBackward.addEventListener("click", () => this.stepBackward());
            stepForward.addEventListener("click", () => this.stepForward());
            playPause.addEventListener("click", () => this.togglePlayback());

            // Keyboard shortcuts for time machine
            document.addEventListener("keydown", (e) => {
              if (controls.classList.contains("visible")) {
                switch(e.key) {
                  case "ArrowLeft":
                    e.preventDefault();
                    this.stepBackward();
                    break;
                  case "ArrowRight":
                    e.preventDefault();
                    this.stepForward();
                    break;
                  case " ":
                    e.preventDefault();
                    this.togglePlayback();
                    break;
                }
              }
            });
          }

          startReplay() {
            this.originalHistory = [...this.conversationManager.conversationHistory];
            this.currentIndex = this.originalHistory.length;
            this.updateControls();
          }

          stepForward() {
            if (this.currentIndex < this.originalHistory.length) {
              this.currentIndex++;
              this.updateDisplay();
              this.updateControls();
            }
          }

          stepBackward() {
            if (this.currentIndex > 0) {
              this.currentIndex--;
              this.updateDisplay();
              this.updateControls();
            }
          }

          updateDisplay() {
            document.getElementById("chat-messages").innerHTML = "";
            
            for (let i = 0; i < this.currentIndex; i++) {
              const message = this.originalHistory[i];
              this.addMessageWithAnimation(message.role, message.content);
            }
          }

          togglePlayback() {
            const playPauseButton = document.getElementById("play-pause");
            const playIcon = playPauseButton.querySelector("i");

            if (this.isPlaying) {
              this.stopPlayback();
              playIcon.classList.replace("fa-pause", "fa-play");
            } else {
              this.startPlayback();
              playIcon.classList.replace("fa-play", "fa-pause");
            }
          }

          startPlayback() {
            this.isPlaying = true;
            if (this.currentIndex >= this.originalHistory.length) {
              this.currentIndex = 0;
              this.updateDisplay();
            }
            this.playMessage();
          }

          stopPlayback() {
            this.isPlaying = false;
            if (this.playbackTimeout) {
              clearTimeout(this.playbackTimeout);
              this.playbackTimeout = null;
            }
          }

          playMessage() {
            if (!this.isPlaying) return;

            if (this.currentIndex < this.originalHistory.length) {
              this.currentIndex++;
              this.updateDisplay();
              this.updateControls();

              this.playbackTimeout = setTimeout(() => {
                this.playMessage();
              }, this.playbackSpeed);
            } else {
              this.stopPlayback();
              const playPauseButton = document.getElementById("play-pause");
              playPauseButton.querySelector("i").classList.replace("fa-pause", "fa-play");
            }
          }

          addMessageWithAnimation(role, content) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${role}-message replay-animation`;

            if (role === "system") {
              this.conversationManager.formatSystemMessage(messageDiv, content);
            } else {
              this.conversationManager.formatUserOrAssistantMessage(messageDiv, role, content);
            }

            document.getElementById("chat-messages").appendChild(messageDiv);

            if (role === "assistant" || role === "system") {
              messageDiv.querySelectorAll("pre code").forEach((block) => {
                hljs.highlightBlock(block);
                this.conversationManager.addCopyButton(block);
              });
            }

            this.conversationManager.scrollToBottom();
            return messageDiv;
          }

          updateControls() {
            const stepBackward = document.getElementById("step-backward");
            const stepForward = document.getElementById("step-forward");
            const progress = document.getElementById("progress");

            stepBackward.disabled = this.currentIndex === 0;
            stepForward.disabled = this.currentIndex >= this.originalHistory.length;
            progress.textContent = `${this.currentIndex} / ${this.originalHistory.length}`;
          }

          restoreOriginalConversation() {
            this.conversationManager.displayLoadedHistory();
          }
        }

        const timeMachine = new TimeMachine(conversationManager);
        const imageUploadHandler = new ImageUploadHandler();

        // Main send message function
        async function sendMessage(userInput, imageData = null) {
          if (!userInput.trim() && !imageData) return;

          if (imageData) {
            conversationManager.addMessage("user", imageData);
            imageUploadHandler.clearImages();
          } else {
            conversationManager.addMessage("user", userInput);
          }

          document.getElementById("user-input").value = "";
          document.getElementById("user-input").style.height = "auto";
          updateCharCounter();
          
          conversationManager.showTypingIndicator();
          document.getElementById("loading").style.display = "flex";

          await soundManager.startBellSequence();

          if (!functionKey) {
            await promptForFunctionKey();
            soundManager.stopBellSequence();
            conversationManager.hideTypingIndicator();
            return;
          }

          try {
            let payload = {
              user_input: userInput,
              conversation_history: conversationManager.conversationHistory,
              user_guid: conversationManager.cachedGuid,
            };

            if (imageData) {
              if (!userInput.trim()) {
                payload.user_input = "Please analyze this image";
              }
            }

            const response = await fetch(azureFunctionUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-functions-key": functionKey,
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              if (response.status === 401) {
                localStorage.removeItem("functionKey");
                await promptForFunctionKey();
                soundManager.stopBellSequence();
                conversationManager.hideTypingIndicator();
                return;
              }
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            handleResponse(data);

            soundManager.stopBellSequence();
            await soundManager.playResponseSound();
          } catch (error) {
            handleError(error);
            soundManager.stopBellSequence();
            await soundManager.playErrorSound();
          } finally {
            document.getElementById("loading").style.display = "none";
            conversationManager.hideTypingIndicator();
          }
        }

        function handleResponse(response) {
          const assistantResponse = response.assistant_response || response.text;
          conversationManager.addMessage("assistant", assistantResponse);

          if (response.agent_logs) {
            conversationManager.addMessage("system", response.agent_logs);
          }

          if (response.user_guid && response.user_guid !== conversationManager.cachedGuid) {
            conversationManager.cachedGuid = response.user_guid;
            localStorage.setItem("userGuid", response.user_guid);
            document.getElementById("reset-guid").style.display = "flex";
            conversationManager.addGuidToHistory(response.user_guid);
          }
        }

        function handleError(error) {
          const errorMessage = `Error: ${error.message || "Something went wrong. Please try again."}`;
          conversationManager.addMessage("system", errorMessage);
          toastManager.show("An error occurred", "error");
        }

        async function promptForFunctionKey() {
          const key = prompt("Please enter your function key:");
          if (key) {
            functionKey = key;
            localStorage.setItem("functionKey", key);
            toastManager.show("Function key saved", "success");
          }
          document.getElementById("loading").style.display = "none";
        }

        // Event Listeners
        document.getElementById("send-button").addEventListener("click", () => {
          const input = document.getElementById("user-input");
          const hasImages = imageUploadHandler.hasImages();

          if (hasImages) {
            const images = imageUploadHandler.getImages();
            sendMessage(input.value.trim(), images[0]);
          } else {
            sendMessage(input.value.trim());
          }
        });

        document.getElementById("user-input").addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            const input = e.target;
            const hasImages = imageUploadHandler.hasImages();

            if (hasImages) {
              const images = imageUploadHandler.getImages();
              sendMessage(input.value.trim(), images[0]);
            } else {
              sendMessage(input.value.trim());
            }
          }
        });

        document.getElementById("clear-chat").addEventListener("click", () => {
          if (confirm("Are you sure you want to clear the chat history?")) {
            conversationManager.clear();
            imageUploadHandler.clearImages();
            toastManager.show("Chat cleared", "info");
          }
        });

        document.getElementById("theme-toggle").addEventListener("click", () => {
          document.body.classList.toggle("dark");
          const isDark = document.body.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
          
          const icon = document.querySelector("#theme-toggle i");
          const text = document.querySelector("#theme-toggle span");
          
          if (isDark) {
            icon.classList.replace("fa-moon", "fa-sun");
            text.textContent = "Light Mode";
            document.getElementById("hljs-theme").href = 
              "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github-dark.min.css";
          } else {
            icon.classList.replace("fa-sun", "fa-moon");
            text.textContent = "Dark Mode";
            document.getElementById("hljs-theme").href = 
              "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github.min.css";
          }
        });

        document.getElementById("sound-toggle").addEventListener("click", function () {
          const icon = this.querySelector("i");
          const text = this.querySelector("span");
          
          if (icon.classList.contains("fa-volume-up")) {
            icon.classList.replace("fa-volume-up", "fa-volume-mute");
            text.textContent = "Enable Sound";
            soundManager.mute();
            toastManager.show("Sound disabled", "info");
          } else {
            icon.classList.replace("fa-volume-mute", "fa-volume-up");
            text.textContent = "Disable Sound";
            soundManager.unmute();
            toastManager.show("Sound enabled", "info");
          }
        });

        // Initialize theme
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark");
          const icon = document.querySelector("#theme-toggle i");
          const text = document.querySelector("#theme-toggle span");
          icon.classList.replace("fa-moon", "fa-sun");
          text.textContent = "Light Mode";
          document.getElementById("hljs-theme").href = 
            "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github-dark.min.css";
        }

        // Initialize sound toggle state
        const soundToggleIcon = document.querySelector("#sound-toggle i");
        const soundToggleText = document.querySelector("#sound-toggle span");
        if (localStorage.getItem("soundEnabled") === "on") {
          soundToggleIcon.classList.replace("fa-volume-mute", "fa-volume-up");
          soundToggleText.textContent = "Disable Sound";
        } else {
          soundToggleText.textContent = "Enable Sound";
        }

        // File import/export handling
        const importChatButton = document.getElementById("import-chat");
        const chatFileInput = document.getElementById("chat-file-input");

        importChatButton.addEventListener("click", () => {
          chatFileInput.click();
        });

        chatFileInput.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            handleChatFileImport(file);
          }
          event.target.value = "";
        });

        async function handleChatFileImport(file) {
          if (!file || file.type !== "application/json") {
            toastManager.show("Please select a valid JSON file", "error");
            return;
          }

          try {
            const text = await file.text();
            const importedData = JSON.parse(text);
            
            let validConversation = null;

            if (importedData.messages && Array.isArray(importedData.messages)) {
              validConversation = importedData.messages;
            } else if (importedData.conversation && Array.isArray(importedData.conversation)) {
              validConversation = importedData.conversation;
            } else if (Array.isArray(importedData) && importedData.length > 0 && 
                       importedData[0] && typeof importedData[0] === "object" &&
                       (importedData[0].role || importedData[0].content)) {
              validConversation = importedData;
            }

            if (!validConversation) {
              throw new Error('Could not find a valid conversation structure in the imported file.');
            }

            validConversation = validConversation.filter((item) => {
              return item && typeof item === "object" && 
                     (item.role || item.sender || item.type) &&
                     (item.content || item.message || item.text);
            });

            validConversation = validConversation.map((item) => ({
              role: item.role || item.sender || 
                    (item.type === "human" ? "user" : 
                     item.type === "ai" ? "assistant" : 
                     item.type || "user"),
              content: item.content || item.message || item.text || "",
              timestamp: item.timestamp || new Date().toISOString()
            }));

            if (validConversation.length === 0) {
              throw new Error("No valid messages found in the imported conversation");
            }

            if (conversationManager.conversationHistory.length > 0) {
              if (!confirm("This will replace your current conversation. Continue?")) {
                return;
              }
            }

            conversationManager.conversationHistory = validConversation;
            conversationManager.saveHistory();
            conversationManager.displayLoadedHistory();

            let guid = null;
            if (importedData.guid) {
              guid = importedData.guid;
            } else if (validConversation.length > 0) {
              const firstUserMessage = validConversation.find((msg) => msg.role === "user");
              if (firstUserMessage) {
                const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (guidPattern.test(firstUserMessage.content.trim())) {
                  guid = firstUserMessage.content.trim();
                }
              }
            }

            if (guid) {
              conversationManager.cachedGuid = guid;
              localStorage.setItem("userGuid", guid);
              document.getElementById("reset-guid").style.display = "flex";
              conversationManager.addGuidToHistory(guid);
            }

            toastManager.show("Conversation imported successfully", "success");
          } catch (error) {
            console.error("Import error:", error);
            toastManager.show(`Error importing conversation: ${error.message}`, "error");
          }
        }

        document.getElementById("export-chat").addEventListener("click", () => {
          if (conversationManager.conversationHistory.length === 0) {toastManager.show("No conversation to export", "warning");
            return;
          }

          const exportData = {
            conversation: conversationManager.conversationHistory,
            guid: conversationManager.cachedGuid,
            timestamp: new Date().toISOString(),
            appName: assistantName,
            version: "2.0"
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `conversation-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          toastManager.show("Conversation exported successfully", "success");
        });

        // Mobile viewport handling
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          // Handle viewport changes for iOS keyboard
          window.visualViewport?.addEventListener("resize", throttle(() => {
            const app = document.querySelector(".app-container");
            if (app) {
              app.style.height = `${window.visualViewport.height}px`;
            }
          }, 100));

          // Prevent zoom on input focus
          document.querySelectorAll('input, textarea').forEach(el => {
            el.addEventListener('focus', () => {
              el.style.fontSize = '16px';
            });
          });
        }

        // Network status monitoring
        class NetworkMonitor {
          constructor() {
            this.statusElement = document.querySelector(".connection-status");
            this.isOnline = navigator.onLine;
            this.initializeMonitoring();
          }

          initializeMonitoring() {
            this.updateStatus();

            window.addEventListener("online", () => {
              this.isOnline = true;
              this.updateStatus();
              toastManager.show("Connection restored", "success");
            });

            window.addEventListener("offline", () => {
              this.isOnline = false;
              this.updateStatus();
              toastManager.show("Connection lost", "error");
            });
          }

          updateStatus() {
            if (this.statusElement) {
              this.statusElement.textContent = this.isOnline ? "Connected" : "Offline";
              this.statusElement.style.color = this.isOnline ? "#4caf50" : "#f44336";
            }
          }
        }

        const networkMonitor = new NetworkMonitor();

        // Performance optimizations
        const optimizePerformance = () => {
          // Lazy load highlight.js languages
          const loadHighlightLanguage = async (lang) => {
            try {
              const script = document.createElement('script');
              script.src = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/languages/${lang}.min.js`;
              document.head.appendChild(script);
            } catch (error) {
              console.warn(`Failed to load highlight.js language: ${lang}`);
            }
          };

          // Intersection Observer for lazy loading
          const messageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const message = entry.target;
                // Load images lazily
                message.querySelectorAll('img[data-src]').forEach(img => {
                  img.src = img.dataset.src;
                  img.removeAttribute('data-src');
                });
              }
            });
          }, {
            rootMargin: '50px'
          });

          // Observe new messages
          const observeMessage = (messageElement) => {
            messageObserver.observe(messageElement);
          };

          // Clean up old messages to prevent memory leaks
          const cleanupOldMessages = () => {
            const messages = document.querySelectorAll('.message');
            if (messages.length > 100) {
              const messagesToRemove = messages.length - 100;
              for (let i = 0; i < messagesToRemove; i++) {
                messages[i].remove();
              }
            }
          };

          return { observeMessage, cleanupOldMessages };
        };

        const { observeMessage, cleanupOldMessages } = optimizePerformance();

        // Periodic cleanup
        setInterval(cleanupOldMessages, 60000); // Every minute

        // PWA Support
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }

        // Handle visibility change to pause/resume animations
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            // Pause animations and timers
            if (soundManager.isPlaying) {
              soundManager.stopBellSequence();
            }
          }
        });

        // Enhanced error handling
        window.addEventListener('unhandledrejection', event => {
          console.error('Unhandled promise rejection:', event.reason);
          toastManager.show('An unexpected error occurred', 'error');
        });

        // Auto-save draft
        const draftKey = 'chat-draft';
        const saveDraft = debounce(() => {
          const content = userInput.value.trim();
          if (content) {
            localStorage.setItem(draftKey, content);
          } else {
            localStorage.removeItem(draftKey);
          }
        }, 1000);

        userInput.addEventListener('input', saveDraft);

        // Restore draft
        const draft = localStorage.getItem(draftKey);
        if (draft) {
          userInput.value = draft;
          userInput.dispatchEvent(new Event('input'));
          toastManager.show('Draft restored', 'info');
        }

        // Clear draft after sending
        const originalSendMessage = sendMessage;
        sendMessage = async (...args) => {
          localStorage.removeItem(draftKey);
          return originalSendMessage(...args);
        };

        // Focus management
        const focusManager = {
          trap: (element) => {
            const focusableElements = element.querySelectorAll(
              'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            element.addEventListener('keydown', (e) => {
              if (e.key === 'Tab') {
                if (e.shiftKey) {
                  if (document.activeElement === firstFocusable) {
                    lastFocusable.focus();
                    e.preventDefault();
                  }
                } else {
                  if (document.activeElement === lastFocusable) {
                    firstFocusable.focus();
                    e.preventDefault();
                  }
                }
              }
            });
          }
        };

        // Apply focus trap to modals
        document.querySelectorAll('.modal').forEach(modal => {
          focusManager.trap(modal);
        });

        // Welcome message
        if (conversationManager.conversationHistory.length === 0 && !conversationManager.cachedGuid) {
          const welcomeMessage = `Welcome to ${assistantName}! I'm here to help you with your questions and tasks. 

To get started, you can:
- Type a message in the input field below
- Upload an image for analysis
- Create a User ID to personalize your experience

Feel free to ask me anything!`;
          
          conversationManager.addMessage("assistant", welcomeMessage);
        }

        // Initialize focus on input
        userInput.focus();

        // Log initialization complete
        console.log(`${assistantName} initialized successfully`);
      });
    </script>
  </body>
</html>