<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Dealer Suite</title>
    <meta name="description" content="A comprehensive card game suite featuring a Virtual Dealer. Play War, Blackjack, and Texas Hold'em against an AI opponent that teaches and challenges you.">
    <style>
        :root {
            --table-color: #2d5e3e;
            --table-dark: #1a3c26;
            --card-width: 100px;
            --card-height: 140px;
            --accent: #ffd700;
            --text-color: #ffffff;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: radial-gradient(circle at center, var(--table-color), var(--table-dark));
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header & Dealer Area */
        header {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .dealer-persona {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dealer-avatar {
            width: 60px;
            height: 60px;
            background: #333;
            border-radius: 50%;
            border: 2px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23444"/><circle cx="35" cy="40" r="5" fill="white"/><circle cx="65" cy="40" r="5" fill="white"/><path d="M 30 70 Q 50 80 70 70" stroke="white" stroke-width="3" fill="none"/></svg>');
        }

        .dealer-info h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--accent);
        }

        .dealer-info p {
            margin: 5px 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
            font-style: italic;
        }

        /* Game Selection */
        #game-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .menu-title {
            font-size: 3rem;
            margin-bottom: 40px;
            color: var(--accent);
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 900px;
            width: 90%;
        }

        .game-card {
            background: linear-gradient(145deg, #333, #222);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            border: 2px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .game-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .game-card p {
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Game Area */
        #game-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .table-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .hand-area {
            height: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
        }

        .dealer-hand {
            align-items: flex-start;
        }

        .player-hand {
            align-items: flex-end;
        }

        /* Cards */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            font-weight: bold;
            font-size: 24px;
            position: relative;
            transition: transform 0.3s;
        }

        .card.red { color: #d40000; }
        .card.black { color: #000000; }

        .card-corner {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .card-corner.bottom {
            transform: rotate(180deg);
        }

        .card-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
        }

        .card-back {
            background: repeating-linear-gradient(
                45deg,
                #b71c1c,
                #b71c1c 10px,
                #c62828 10px,
                #c62828 20px
            );
            border: 5px solid white;
        }

        .card-back * { display: none; }

        /* Controls */
        #controls {
            height: 100px;
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 0 20px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 120px;
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
        }

        .btn-primary:hover {
            background: #ffed4a;
            transform: scale(1.05);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Messages */
        #message-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 10px;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 50;
        }

        #message-overlay.visible {
            opacity: 1;
        }

        #message-overlay h2 {
            color: var(--accent);
            font-size: 2rem;
            margin: 0;
        }

        /* Chips */
        .chip-stack {
            position: absolute;
            bottom: 120px;
            right: 20px;
            text-align: right;
        }

        .chip-count {
            font-size: 1.5rem;
            color: var(--accent);
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* Animations */
        @keyframes dealCard {
            from { transform: translateY(-200px) rotate(180deg); opacity: 0; }
            to { transform: translateY(0) rotate(0deg); opacity: 1; }
        }
        @keyframes winToPlayer {
            to { transform: translateY(400px) scale(0.5); opacity: 0; }
        }
        @keyframes winToDealer {
            to { transform: translateY(-400px) scale(0.5); opacity: 0; }
        }
        .dealing { animation: dealCard 0.5s ease-out forwards; }
        .win-player { animation: winToPlayer 0.6s ease-in forwards; }
        .win-dealer { animation: winToDealer 0.6s ease-in forwards; }

        /* War Specific UI */
        .war-stats {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 20px;
            text-align: right;
            font-family: monospace;
            color: var(--accent);
        }
        .advice-box {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 200px;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            font-size: 0.9rem;
            display: none;
        }
        .advice-box.visible { display: block; }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --card-width: 70px;
                --card-height: 100px;
            }
            
            .game-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                min-width: auto;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="dealer-persona">
            <div class="dealer-avatar"></div>
            <div class="dealer-info">
                <h2>The Dealer</h2>
                <p id="dealer-text">"Select a game to begin."</p>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="showMenu()">Menu</button>
    </header>

    <div id="game-menu">
        <h1 class="menu-title">Virtual Dealer Suite</h1>
        <div class="game-grid">
            <div class="game-card" onclick="startGame('war')">
                <h3>War</h3>
                <p>The classic game of chance. High card wins.</p>
            </div>
            <div class="game-card" onclick="startGame('blackjack')">
                <h3>Blackjack</h3>
                <p>Get closer to 21 than the dealer without going over.</p>
            </div>
            <div class="game-card" onclick="startGame('poker')">
                <h3>Texas Hold'em</h3>
                <p>Heads-up poker. Best 5-card hand wins.</p>
            </div>
        </div>

        <div style="margin-top: 30px; width: 90%; max-width: 900px;">
            <button class="btn btn-primary" onclick="startTutorMode()" style="width: 100%; padding: 20px; font-size: 1.2rem; background: linear-gradient(45deg, #4a90e2, #003973); border: none;">
                ðŸŽ“ Physical Deck Tutor Mode
                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px; text-transform: none; font-weight: normal;">
                    Use your own real cards! I'll teach you how to play and give advice.
                </div>
            </button>
        </div>

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #333; text-align: center;">
            <h3 style="margin-bottom: 15px; color: #888;">Data Management</h3>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="action-btn" onclick="DataManager.save()" style="width: auto; padding: 10px 20px;">Export Save</button>
                <button class="action-btn" onclick="document.getElementById('file-input').click()" style="width: auto; padding: 10px 20px;">Import Save</button>
                <input type="file" id="file-input" style="display: none" onchange="DataManager.load(this)">
            </div>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">Progress is automatically saved to your browser.</p>
        </div>
    </div>

    <div id="game-area">
        <div class="hand-area dealer-hand" id="dealer-hand">
            <!-- Dealer cards go here -->
        </div>

        <div class="table-center" id="table-center">
            <div id="message-overlay">
                <h2 id="overlay-text">Player Wins!</h2>
            </div>
            <div id="community-cards" class="hand-area" style="display:none;">
                <!-- Community cards for Poker -->
            </div>
        </div>

        <div class="hand-area player-hand" id="player-hand">
            <!-- Player cards go here -->
        </div>

        <div class="chip-stack" id="chip-display" style="display:none;">
            Chips: <span class="chip-count" id="chips">1000</span>
        </div>
    </div>

    <div id="controls">
        <!-- Dynamic controls -->
    </div>

    <!-- Tutor Interface -->
    <div id="tutor-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--accent); margin: 0;">Physical Deck Tutor</h2>
            <button class="btn btn-secondary" onclick="closeTutor()">Exit Tutor</button>
        </div>
        
        <div id="tutor-menu" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;">
            <h3>Select a game to learn with your cards:</h3>
            <div class="game-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="game-card" onclick="startTutorGame('war')"><h3>War</h3></div>
                <div class="game-card" onclick="startTutorGame('blackjack')"><h3>Blackjack</h3></div>
                <div class="game-card" onclick="startTutorGame('poker')"><h3>Poker</h3></div>
            </div>
        </div>

        <div id="tutor-game" style="display: none; flex: 1; flex-direction: column;">
            <div id="tutor-instructions" style="text-align: center; margin-bottom: 20px; font-size: 1.2rem; color: #ddd;"></div>
            
            <div style="flex: 1; display: flex; gap: 20px;">
                <!-- Card Selector -->
                <div style="width: 300px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; overflow-y: auto;">
                    <h4 style="margin-top: 0;">Select Card</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px;">
                        <button class="btn-suit" onclick="selectSuit('â™ ')" style="color: white">â™ </button>
                        <button class="btn-suit" onclick="selectSuit('â™¥')" style="color: red">â™¥</button>
                        <button class="btn-suit" onclick="selectSuit('â™£')" style="color: white">â™£</button>
                        <button class="btn-suit" onclick="selectSuit('â™¦')" style="color: red">â™¦</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;">
                        <!-- Ranks generated by JS -->
                        <div id="rank-buttons" style="display: contents;"></div>
                    </div>
                </div>

                <!-- Game State Display -->
                <div style="flex: 1; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; display: flex; flex-direction: column;">
                    <div id="tutor-table" style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
                        <!-- Dynamic table content -->
                    </div>
                    <div id="tutor-advice" style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 5px; border-left: 4px solid var(--accent); margin-top: 20px;">
                        Waiting for input...
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-secondary" onclick="resetTutorRound()">Reset Round</button>
                <button class="btn btn-primary" id="tutor-action-btn" onclick="evaluateTutor()">Get Advice</button>
            </div>
        </div>
    </div>

    <style>
        .btn-suit {
            background: #333; border: 1px solid #555; font-size: 1.5rem; padding: 10px; cursor: pointer; border-radius: 5px;
        }
        .btn-suit.selected { background: #555; border-color: var(--accent); }
        .btn-rank {
            background: #333; border: 1px solid #555; padding: 10px; cursor: pointer; border-radius: 5px; color: white;
        }
        .btn-rank.selected { background: var(--accent); color: black; }
        
        .tutor-slot {
            border: 2px dashed #555;
            min-height: 100px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tutor-slot:hover { border-color: var(--accent); background: rgba(255,255,255,0.05); }
        .tutor-slot.active { border-color: var(--accent); background: rgba(255,215,0,0.1); }
    </style>

    <script>
        // --- Tutor Mode Logic ---
        let TUTOR = {
            game: null,
            selectedSuit: null,
            selectedRank: null,
            activeSlot: null,
            slots: {}
        };

        function startTutorMode() {
            document.getElementById('tutor-overlay').style.display = 'flex';
            document.getElementById('tutor-menu').style.display = 'flex';
            document.getElementById('tutor-game').style.display = 'none';
            
            // Generate rank buttons
            const rankContainer = document.getElementById('rank-buttons');
            rankContainer.innerHTML = '';
            RANKS.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'btn-rank';
                btn.textContent = r;
                btn.onclick = () => selectRank(r, btn);
                rankContainer.appendChild(btn);
            });
        }

        function closeTutor() {
            document.getElementById('tutor-overlay').style.display = 'none';
        }

        function startTutorGame(game) {
            TUTOR.game = game;
            document.getElementById('tutor-menu').style.display = 'none';
            document.getElementById('tutor-game').style.display = 'flex';
            resetTutorRound();
        }

        function selectSuit(s) {
            TUTOR.selectedSuit = s;
            document.querySelectorAll('.btn-suit').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            checkCardSelection();
        }

        function selectRank(r, btn) {
            TUTOR.selectedRank = r;
            document.querySelectorAll('.btn-rank').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            checkCardSelection();
        }

        function checkCardSelection() {
            if (TUTOR.selectedSuit && TUTOR.selectedRank && TUTOR.activeSlot) {
                // Create card and place in slot
                const card = new Card(TUTOR.selectedSuit, TUTOR.selectedRank);
                const slotId = TUTOR.activeSlot;
                
                // Store card data
                if (!TUTOR.slots[slotId]) TUTOR.slots[slotId] = [];
                
                // For single card slots, replace. For multi, push.
                const isMulti = slotId.includes('multi');
                if (isMulti) {
                    TUTOR.slots[slotId].push(card);
                } else {
                    TUTOR.slots[slotId] = [card];
                }

                renderTutorSlots();
                
                // Reset selection
                TUTOR.selectedSuit = null;
                TUTOR.selectedRank = null;
                document.querySelectorAll('.btn-suit').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.btn-rank').forEach(b => b.classList.remove('selected'));
                
                // Auto-evaluate if enough cards
                evaluateTutor();
            }
        }

        function activateSlot(id) {
            TUTOR.activeSlot = id;
            document.querySelectorAll('.tutor-slot').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('tutor-advice').textContent = `Select a Suit and Rank for ${id.replace('-', ' ')}...`;
        }

        function renderTutorSlots() {
            // Re-render the visual state of slots based on TUTOR.slots
            for (let id in TUTOR.slots) {
                const container = document.getElementById(id);
                if (!container) continue;
                
                container.innerHTML = '';
                const cards = TUTOR.slots[id];
                
                if (cards.length === 0) {
                    container.textContent = `Tap to add ${id.replace('-', ' ')}`;
                } else {
                    cards.forEach(c => {
                        const el = c.render();
                        el.style.transform = 'scale(0.8)';
                        container.appendChild(el);
                    });
                }
            }
        }

        function resetTutorRound() {
            TUTOR.slots = {};
            TUTOR.selectedSuit = null;
            TUTOR.selectedRank = null;
            
            const table = document.getElementById('tutor-table');
            table.innerHTML = '';
            
            if (TUTOR.game === 'war') {
                document.getElementById('tutor-instructions').textContent = "War Tutor: Place both cards to see who wins.";
                table.innerHTML = `
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        <div style="text-align: center;">
                            <h4>Your Card</h4>
                            <div id="player-card" class="tutor-slot" onclick="activateSlot('player-card')">Tap to add</div>
                        </div>
                        <div style="text-align: center;">
                            <h4>Dealer Card</h4>
                            <div id="dealer-card" class="tutor-slot" onclick="activateSlot('dealer-card')">Tap to add</div>
                        </div>
                    </div>
                `;
            } else if (TUTOR.game === 'blackjack') {
                document.getElementById('tutor-instructions').textContent = "Blackjack Tutor: Enter your hand and dealer's up card.";
                table.innerHTML = `
                    <div style="text-align: center;">
                        <h4>Dealer Up Card</h4>
                        <div id="dealer-up" class="tutor-slot" onclick="activateSlot('dealer-up')" style="width: 120px; margin: 0 auto;">Tap to add</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <h4>Your Hand</h4>
                        <div id="player-hand-multi" class="tutor-slot" onclick="activateSlot('player-hand-multi')" style="min-height: 150px;">Tap to add cards</div>
                    </div>
                `;
            } else if (TUTOR.game === 'poker') {
                document.getElementById('tutor-instructions').textContent = "Poker Tutor: Enter your hole cards and community cards.";
                table.innerHTML = `
                    <div style="text-align: center;">
                        <h4>Community Cards</h4>
                        <div id="community-multi" class="tutor-slot" onclick="activateSlot('community-multi')" style="min-height: 120px;">Tap to add cards</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <h4>Your Hole Cards</h4>
                        <div id="hole-cards-multi" class="tutor-slot" onclick="activateSlot('hole-cards-multi')" style="min-height: 150px;">Tap to add cards</div>
                    </div>
                `;
            }
            
            document.getElementById('tutor-advice').textContent = "Select a slot to begin inputting cards.";
        }

        function evaluateTutor() {
            const advice = document.getElementById('tutor-advice');
            
            if (TUTOR.game === 'war') {
                const p = TUTOR.slots['player-card']?.[0];
                const d = TUTOR.slots['dealer-card']?.[0];
                
                if (p && d) {
                    if (p.pokerValue > d.pokerValue) advice.innerHTML = "<span style='color:#4f4'>You Win!</span> Your card is higher.";
                    else if (d.pokerValue > p.pokerValue) advice.innerHTML = "<span style='color:#f44'>Dealer Wins.</span> Their card is higher.";
                    else advice.innerHTML = "<span style='color:#ff4'>It's a Tie!</span> Go to War!";
                }
            } else if (TUTOR.game === 'blackjack') {
                const pHand = TUTOR.slots['player-hand-multi'];
                const dCard = TUTOR.slots['dealer-up']?.[0];
                
                if (pHand && pHand.length >= 2 && dCard) {
                    const score = BlackjackGame.getScore(pHand);
                    const dVal = dCard.value;
                    
                    let msg = `Your score: ${score}. Dealer shows: ${dVal}.<br>`;
                    
                    if (score > 21) msg += "<strong>BUST!</strong> You went over 21.";
                    else if (score === 21) msg += "<strong>BLACKJACK!</strong> Stand and hope for a payout.";
                    else {
                        // Basic Strategy Simplified
                        if (score >= 17) msg += "<strong>STAND.</strong> You have a strong hand.";
                        else if (score <= 11) msg += "<strong>HIT.</strong> Always hit on 11 or less.";
                        else if (score >= 12 && score <= 16) {
                            if (dVal >= 7) msg += "<strong>HIT.</strong> Dealer has a strong up-card.";
                            else msg += "<strong>STAND.</strong> Dealer has a weak up-card, let them bust.";
                        }
                    }
                    advice.innerHTML = msg;
                }
            } else if (TUTOR.game === 'poker') {
                const hole = TUTOR.slots['hole-cards-multi'];
                const comm = TUTOR.slots['community-multi'] || [];
                
                if (hole && hole.length === 2) {
                    const score = PokerGame.evaluate(hole, comm);
                    let msg = "<strong>Hand Analysis:</strong><br>";
                    
                    // Simple pair check for advice
                    const all = [...hole, ...comm];
                    const ranks = all.map(c => c.rank);
                    const hasPair = ranks.some((r, i) => ranks.indexOf(r) !== i);
                    
                    if (hasPair) msg += "You have at least a Pair. Good start.";
                    else if (hole[0].pokerValue > 10 || hole[1].pokerValue > 10) msg += "You have high cards. Playable.";
                    else msg += "Low cards and no pair. Proceed with caution.";
                    
                    if (comm.length === 0) msg += "<br><em>Pre-flop advice: Raise if you have pairs or high cards.</em>";
                    else if (comm.length === 3) msg += "<br><em>Flop advice: Bet if you connected with the board.</em>";
                    
                    advice.innerHTML = msg;
                }
            }
        }

        // --- Game State ---
        const STATE = {
            game: null,
            deck: [],
            playerHand: [],
            dealerHand: [],
            communityCards: [],
            chips: 1000,
            bet: 0,
            phase: 'idle', // idle, dealing, playing, resolving
            messageTimer: null
        };

        // --- Card System ---
        const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        class Card {
            constructor(suit, rank) {
                this.suit = suit;
                this.rank = rank;
                this.color = (suit === 'â™¥' || suit === 'â™¦') ? 'red' : 'black';
                this.faceUp = true;
            }

            get value() {
                if (this.rank === 'A') return 14;
                if (['K', 'Q', 'J'].includes(this.rank)) return 10; // For Blackjack mostly, handled specifically in logic
                return parseInt(this.rank) || 10;
            }

            get pokerValue() {
                const map = {'2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14};
                return map[this.rank];
            }

            render() {
                const el = document.createElement('div');
                el.className = `card ${this.color} ${this.faceUp ? '' : 'card-back'}`;
                
                if (this.faceUp) {
                    el.innerHTML = `
                        <div class="card-corner top">
                            <div>${this.rank}</div>
                            <div>${this.suit}</div>
                        </div>
                        <div class="card-center">${this.suit}</div>
                        <div class="card-corner bottom">
                            <div>${this.rank}</div>
                            <div>${this.suit}</div>
                        </div>
                    `;
                }
                return el;
            }
        }

        function createDeck() {
            const deck = [];
            for (let s of SUITS) {
                for (let r of RANKS) {
                    deck.push(new Card(s, r));
                }
            }
            return shuffle(deck);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- UI Functions ---
        function showMenu() {
            document.getElementById('game-menu').style.display = 'flex';
            STATE.game = null;
            updateDealer("Select a game to begin.");
        }

        function updateDealer(msg) {
            document.getElementById('dealer-text').textContent = `"${msg}"`;
        }

        function showOverlay(msg, duration = 2000) {
            const el = document.getElementById('message-overlay');
            document.getElementById('overlay-text').textContent = msg;
            el.classList.add('visible');
            if (STATE.messageTimer) clearTimeout(STATE.messageTimer);
            if (duration > 0) {
                STATE.messageTimer = setTimeout(() => {
                    el.classList.remove('visible');
                }, duration);
            }
        }

        function renderHands() {
            const pContainer = document.getElementById('player-hand');
            const dContainer = document.getElementById('dealer-hand');
            const cContainer = document.getElementById('community-cards');

            pContainer.innerHTML = '';
            dContainer.innerHTML = '';
            cContainer.innerHTML = '';

            STATE.playerHand.forEach(c => pContainer.appendChild(c.render()));
            STATE.dealerHand.forEach(c => dContainer.appendChild(c.render()));
            STATE.communityCards.forEach(c => cContainer.appendChild(c.render()));

            document.getElementById('chips').textContent = STATE.chips;
        }

        function setControls(buttons) {
            const c = document.getElementById('controls');
            c.innerHTML = '';
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.className = `btn ${b.primary ? 'btn-primary' : 'btn-secondary'}`;
                btn.textContent = b.text;
                btn.onclick = b.action;
                if (b.disabled) btn.disabled = true;
                c.appendChild(btn);
            });
        }

        // --- Data Management ---
        const DataManager = {
            save: () => {
                const data = {
                    chips: STATE.chips,
                    stats: STATE.stats,
                    timestamp: Date.now()
                };
                const json = JSON.stringify(data);
                const blob = new Blob([json], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `virtual-dealer-save-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            load: (inputElement) => {
                const file = inputElement.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.chips !== undefined) STATE.chips = data.chips;
                        if (data.stats) STATE.stats = data.stats;
                        
                        DataManager.autoSave();
                        alert("Data loaded successfully!");
                        location.reload(); // Reload to ensure state is fresh
                    } catch (err) {
                        alert("Invalid save file");
                    }
                };
                reader.readAsText(file);
            },
            autoSave: () => {
                const data = {
                    chips: STATE.chips,
                    stats: STATE.stats
                };
                localStorage.setItem('virtualDealerSave', JSON.stringify(data));
            },
            autoLoad: () => {
                const saved = localStorage.getItem('virtualDealerSave');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        if (data.chips !== undefined) STATE.chips = data.chips;
                        if (data.stats) STATE.stats = data.stats;
                    } catch (e) { console.error(e); }
                }
            }
        };

        // --- Shared Helpers ---
        function ensureAdviceBox() {
            let box = document.getElementById('game-advice');
            if (!box) {
                const gameArea = document.getElementById('game-area');
                box = document.createElement('div');
                box.id = 'game-advice';
                box.className = 'advice-box visible';
                gameArea.appendChild(box);
            }
            box.style.display = 'block';
            return box;
        }

        function showGameAdvice(text, enabled) {
            const box = ensureAdviceBox();
            if (enabled) {
                box.style.display = 'block';
                box.innerHTML = text;
            } else {
                box.style.display = 'none';
            }
        }

        function animateDeal() {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('dealing'));
            // Force reflow
            void document.body.offsetWidth;
            document.querySelectorAll('.card').forEach(c => c.classList.add('dealing'));
        }

        function animateWin(winner) {
            const cls = winner === 'Player' ? 'win-player' : 'win-dealer';
            document.querySelectorAll('.card').forEach(c => c.classList.add(cls));
        }

        // --- Game Logic: WAR ---
        const WarGame = {
            deck: [],
            playerDeck: [],
            dealerDeck: [],
            pot: [],
            state: 'idle', // idle, war
            adviceEnabled: true,

            init: () => {
                // Create and split deck
                const fullDeck = createDeck();
                STATE.deck = []; // Not used in War, we use split decks
                WarGame.playerDeck = fullDeck.slice(0, 26);
                WarGame.dealerDeck = fullDeck.slice(26, 52);
                WarGame.pot = [];
                WarGame.state = 'idle';
                
                // Setup UI
                document.getElementById('community-cards').style.display = 'none';
                document.getElementById('chip-display').style.display = 'none';
                
                // Add War specific UI elements if not present
                if (!document.getElementById('war-stats')) {
                    const gameArea = document.getElementById('game-area');
                    const stats = document.createElement('div');
                    stats.id = 'war-stats';
                    stats.className = 'war-stats';
                    gameArea.appendChild(stats);
                }
                document.getElementById('war-stats').style.display = 'block';
                ensureAdviceBox();

                updateDealer("War. I have 26 cards, you have 26. Collect them all to become the Dealer.");
                WarGame.updateUI();
                WarGame.nextRound();
            },

            updateUI: () => {
                const stats = document.getElementById('war-stats');
                if (stats) {
                    stats.innerHTML = `
                        <div>Dealer Deck: ${WarGame.dealerDeck.length}</div>
                        <div style="margin-top:10px">Player Deck: ${WarGame.playerDeck.length}</div>
                        <div style="margin-top:10px; font-size:0.8em; opacity:0.7">Pot: ${WarGame.pot.length}</div>
                    `;
                }
            },

            nextRound: () => {
                if (WarGame.playerDeck.length === 0) {
                    WarGame.endGame('Dealer');
                    return;
                }
                if (WarGame.dealerDeck.length === 0) {
                    WarGame.endGame('Player');
                    return;
                }

                STATE.playerHand = [];
                STATE.dealerHand = [];
                renderHands();
                
                setControls([
                    { text: 'Battle', action: WarGame.battle, primary: true },
                    { text: 'Toggle Advice', action: WarGame.toggleAdvice, primary: false }
                ]);
            },

            toggleAdvice: () => {
                WarGame.adviceEnabled = !WarGame.adviceEnabled;
                showGameAdvice("Advice " + (WarGame.adviceEnabled ? "enabled." : "disabled."), WarGame.adviceEnabled);
            },

            showAdvice: (text) => {
                showGameAdvice(text, WarGame.adviceEnabled);
            },

            battle: () => {
                if (WarGame.playerDeck.length === 0 || WarGame.dealerDeck.length === 0) {
                    WarGame.nextRound(); // Trigger end game check
                    return;
                }

                const pCard = WarGame.playerDeck.shift();
                const dCard = WarGame.dealerDeck.shift();
                
                STATE.playerHand = [pCard];
                STATE.dealerHand = [dCard];
                
                renderHands();
                animateDeal();

                WarGame.pot.push(pCard, dCard);
                WarGame.updateUI();

                const pVal = pCard.pokerValue;
                const dVal = dCard.pokerValue;

                setTimeout(() => {
                    if (pVal > dVal) {
                        WarGame.resolveRound('Player', pCard, dCard);
                    } else if (dVal > pVal) {
                        WarGame.resolveRound('Dealer', pCard, dCard);
                    } else {
                        WarGame.triggerWar(pCard, dCard);
                    }
                }, 600);
            },

            resolveRound: (winner, pCard, dCard) => {
                let msg = "";
                if (winner === 'Player') {
                    msg = `You win! ${pCard.rank} beats ${dCard.rank}.`;
                    WarGame.showAdvice(`<strong>Nice!</strong> High card wins. You collect ${WarGame.pot.length} cards.`);
                    showOverlay("Round Won");
                    animateWin('Player');
                    
                    setTimeout(() => {
                        WarGame.playerDeck.push(...WarGame.pot);
                        WarGame.pot = [];
                        WarGame.updateUI();
                        WarGame.nextRound();
                    }, 600);
                } else {
                    msg = `I win. ${dCard.rank} beats ${pCard.rank}.`;
                    WarGame.showAdvice(`<strong>Ouch.</strong> Dealer had the higher card. You lost the pot.`);
                    showOverlay("Round Lost");
                    animateWin('Dealer');

                    setTimeout(() => {
                        WarGame.dealerDeck.push(...WarGame.pot);
                        WarGame.pot = [];
                        WarGame.updateUI();
                        WarGame.nextRound();
                    }, 600);
                }
                updateDealer(msg);
            },

            triggerWar: (pCard, dCard) => {
                updateDealer("WAR! We tied. 3 cards down, 1 card up.");
                WarGame.showAdvice(`<strong>WAR!</strong> A tie on ${pCard.rank}s. The stakes just got higher.`);
                
                setControls([
                    { text: 'Go to War', action: WarGame.executeWar, primary: true }
                ]);
            },

            executeWar: () => {
                // Check if enough cards
                if (WarGame.playerDeck.length < 4 || WarGame.dealerDeck.length < 4) {
                    // Special case: not enough cards for full war
                    // Simplified: whoever runs out loses immediately in this version
                    if (WarGame.playerDeck.length < 1) WarGame.endGame('Dealer');
                    else if (WarGame.dealerDeck.length < 1) WarGame.endGame('Player');
                    else {
                        // Play what we have
                        WarGame.battle();
                    }
                    return;
                }

                // Burn 3 cards
                for(let i=0; i<3; i++) WarGame.pot.push(WarGame.playerDeck.shift());
                for(let i=0; i<3; i++) WarGame.pot.push(WarGame.dealerDeck.shift());
                
                WarGame.updateUI();
                WarGame.battle(); // Play the war card
            },

            endGame: (winner) => {
                if (winner === 'Player') {
                    updateDealer("Impossible... You have taken everything.");
                    showOverlay("YOU ARE THE DEALER NOW!", 5000);
                    WarGame.showAdvice("<strong>CONGRATULATIONS!</strong> You have collected the entire deck. You are now the master of the table.");
                } else {
                    updateDealer("The house always wins eventually.");
                    showOverlay("GAME OVER", 3000);
                    WarGame.showAdvice("<strong>Game Over.</strong> You ran out of cards. Try again!");
                }
                setControls([
                    { text: 'Play Again', action: WarGame.init, primary: true },
                    { text: 'Menu', action: showMenu, primary: false }
                ]);
            }
        };

        // --- Game Logic: BLACKJACK ---
        const BlackjackGame = {
            adviceEnabled: true,
            init: () => {
                STATE.deck = createDeck();
                document.getElementById('community-cards').style.display = 'none';
                document.getElementById('chip-display').style.display = 'block';
                if (document.getElementById('war-stats')) document.getElementById('war-stats').style.display = 'none';
                ensureAdviceBox();
                
                updateDealer("Blackjack. Place your bet.");
                BlackjackGame.bettingPhase();
            },
            toggleAdvice: () => {
                BlackjackGame.adviceEnabled = !BlackjackGame.adviceEnabled;
                showGameAdvice("Advice " + (BlackjackGame.adviceEnabled ? "enabled." : "disabled."), BlackjackGame.adviceEnabled);
            },
            showAdvice: (text) => {
                showGameAdvice(text, BlackjackGame.adviceEnabled);
            },
            bettingPhase: () => {
                STATE.playerHand = [];
                STATE.dealerHand = [];
                renderHands();
                BlackjackGame.showAdvice("<strong>Betting:</strong> Choose your stake to begin.");
                setControls([
                    { text: 'Bet 10', action: () => BlackjackGame.deal(10), primary: true },
                    { text: 'Bet 50', action: () => BlackjackGame.deal(50), primary: true },
                    { text: 'Toggle Advice', action: BlackjackGame.toggleAdvice, primary: false }
                ]);
            },
            deal: (bet) => {
                if (STATE.chips < bet) {
                    updateDealer("Insufficient funds.");
                    return;
                }
                STATE.bet = bet;
                STATE.chips -= bet;
                
                if (STATE.deck.length < 10) STATE.deck = createDeck();

                STATE.playerHand = [STATE.deck.pop(), STATE.deck.pop()];
                STATE.dealerHand = [STATE.deck.pop(), STATE.deck.pop()];
                STATE.dealerHand[1].faceUp = false; // Hide hole card

                renderHands();
                animateDeal();
                BlackjackGame.checkBlackjack();
            },
            getScore: (hand) => {
                let score = 0;
                let aces = 0;
                for (let c of hand) {
                    let val = c.rank === 'A' ? 11 : (['K','Q','J'].includes(c.rank) ? 10 : parseInt(c.rank));
                    score += val;
                    if (c.rank === 'A') aces++;
                }
                while (score > 21 && aces > 0) {
                    score -= 10;
                    aces--;
                }
                return score;
            },
            checkBlackjack: () => {
                const pScore = BlackjackGame.getScore(STATE.playerHand);
                if (pScore === 21) {
                    BlackjackGame.resolve(true); // Player Blackjack
                } else {
                    BlackjackGame.playerTurn();
                }
            },
            playerTurn: () => {
                const score = BlackjackGame.getScore(STATE.playerHand);
                const dUp = STATE.dealerHand[0].value;
                updateDealer(`You have ${score}. Hit or Stand?`);
                
                // Advice Logic
                let advice = "";
                if (score >= 17) advice = "<strong>Stand.</strong> You have a strong hand.";
                else if (score <= 11) advice = "<strong>Hit.</strong> No risk of busting.";
                else if (dUp >= 7) advice = "<strong>Hit.</strong> Dealer shows strength (" + dUp + ").";
                else advice = "<strong>Stand.</strong> Dealer shows weakness (" + dUp + "), let them bust.";
                
                BlackjackGame.showAdvice(advice);

                setControls([
                    { text: 'Hit', action: BlackjackGame.hit, primary: true },
                    { text: 'Stand', action: BlackjackGame.stand, primary: false },
                    { text: 'Toggle Advice', action: BlackjackGame.toggleAdvice, primary: false }
                ]);
            },
            hit: () => {
                STATE.playerHand.push(STATE.deck.pop());
                renderHands();
                animateDeal();
                const score = BlackjackGame.getScore(STATE.playerHand);
                if (score > 21) {
                    updateDealer("Bust! House wins.");
                    BlackjackGame.showAdvice("<strong>Bust!</strong> You went over 21.");
                    showOverlay("Bust!");
                    animateWin('Dealer');
                    setTimeout(BlackjackGame.bettingPhase, 2000);
                } else {
                    BlackjackGame.playerTurn();
                }
            },
            stand: () => {
                STATE.dealerHand[1].faceUp = true;
                renderHands();
                BlackjackGame.dealerTurn();
            },
            dealerTurn: () => {
                let dScore = BlackjackGame.getScore(STATE.dealerHand);
                
                const playDealer = () => {
                    if (dScore < 17) {
                        STATE.dealerHand.push(STATE.deck.pop());
                        renderHands();
                        animateDeal();
                        dScore = BlackjackGame.getScore(STATE.dealerHand);
                        setTimeout(playDealer, 1000);
                    } else {
                        BlackjackGame.resolve();
                    }
                };
                playDealer();
            },
            resolve: (playerBlackjack = false) => {
                const pScore = BlackjackGame.getScore(STATE.playerHand);
                const dScore = BlackjackGame.getScore(STATE.dealerHand);
                
                let win = false;
                let push = false;

                if (playerBlackjack) {
                    // Check if dealer also has blackjack
                    STATE.dealerHand[1].faceUp = true;
                    renderHands();
                    if (BlackjackGame.getScore(STATE.dealerHand) === 21) push = true;
                    else win = true;
                } else if (dScore > 21) {
                    win = true;
                } else if (pScore > dScore) {
                    win = true;
                } else if (pScore === dScore) {
                    push = true;
                }

                if (win) {
                    const payout = playerBlackjack ? 2.5 : 2;
                    STATE.chips += STATE.bet * payout;
                    updateDealer(playerBlackjack ? "Blackjack!" : "You win.");
                    BlackjackGame.showAdvice("<strong>Winner!</strong> " + (playerBlackjack ? "Blackjack pays 3:2." : "You beat the dealer."));
                    showOverlay("You Win!");
                    animateWin('Player');
                    
                    // Win Condition
                    if (STATE.chips >= 5000) {
                        setTimeout(() => {
                            showOverlay("YOU BROKE THE BANK!", 5000);
                            updateDealer("You have cleaned me out. You are the Dealer now.");
                        }, 2000);
                        return;
                    }
                } else if (push) {
                    STATE.chips += STATE.bet;
                    updateDealer("Push.");
                    BlackjackGame.showAdvice("<strong>Push.</strong> Bets returned.");
                    showOverlay("Push");
                } else {
                    updateDealer("House wins.");
                    BlackjackGame.showAdvice("<strong>Loss.</strong> Better luck next hand.");
                    showOverlay("Dealer Wins");
                    animateWin('Dealer');
                }

                setTimeout(BlackjackGame.bettingPhase, 3000);
            }
        };

        // --- Game Logic: POKER (Simplified Heads-Up) ---
        const PokerGame = {
            adviceEnabled: true,
            init: () => {
                STATE.deck = createDeck();
                document.getElementById('community-cards').style.display = 'flex';
                document.getElementById('chip-display').style.display = 'block';
                if (document.getElementById('war-stats')) document.getElementById('war-stats').style.display = 'none';
                ensureAdviceBox();
                
                updateDealer("Texas Hold'em. Ante up.");
                PokerGame.startRound();
            },
            toggleAdvice: () => {
                PokerGame.adviceEnabled = !PokerGame.adviceEnabled;
                showGameAdvice("Advice " + (PokerGame.adviceEnabled ? "enabled." : "disabled."), PokerGame.adviceEnabled);
                if (PokerGame.adviceEnabled && STATE.playerHand.length > 0) {
                    PokerGame.analyzeHand("Current");
                }
            },
            showAdvice: (text) => {
                showGameAdvice(text, PokerGame.adviceEnabled);
            },
            startRound: () => {
                STATE.playerHand = [];
                STATE.dealerHand = [];
                STATE.communityCards = [];
                renderHands();
                PokerGame.showAdvice("<strong>Ante Up:</strong> Pay the blind to see your cards.");
                setControls([
                    { text: 'Ante 20', action: () => PokerGame.deal(20), primary: true },
                    { text: 'Toggle Advice', action: PokerGame.toggleAdvice, primary: false }
                ]);
            },
            deal: (ante) => {
                if (STATE.chips < ante) return;
                STATE.bet = ante;
                STATE.chips -= ante;
                
                if (STATE.deck.length < 15) STATE.deck = createDeck();

                STATE.playerHand = [STATE.deck.pop(), STATE.deck.pop()];
                STATE.dealerHand = [STATE.deck.pop(), STATE.deck.pop()];
                STATE.dealerHand.forEach(c => c.faceUp = false);

                renderHands();
                animateDeal();
                updateDealer("Pre-flop. Call or Fold?");
                
                PokerGame.analyzeHand("Pre-flop");

                setControls([
                    { text: 'Call (20)', action: () => PokerGame.flop(20), primary: true },
                    { text: 'Fold', action: PokerGame.fold, primary: false },
                    { text: 'Toggle Advice', action: PokerGame.toggleAdvice, primary: false }
                ]);
            },
            flop: (bet) => {
                if (STATE.chips < bet) return;
                STATE.chips -= bet;
                STATE.bet += bet;

                STATE.communityCards.push(STATE.deck.pop(), STATE.deck.pop(), STATE.deck.pop());
                renderHands();
                animateDeal();
                updateDealer("The Flop. Check or Bet?");
                
                PokerGame.analyzeHand("Flop");

                setControls([
                    { text: 'Check', action: () => PokerGame.turn(0), primary: false },
                    { text: 'Bet 50', action: () => PokerGame.turn(50), primary: true },
                    { text: 'Toggle Advice', action: PokerGame.toggleAdvice, primary: false }
                ]);
            },
            turn: (bet) => {
                if (STATE.chips < bet) return;
                STATE.chips -= bet;
                STATE.bet += bet;

                STATE.communityCards.push(STATE.deck.pop());
                renderHands();
                animateDeal();
                updateDealer("The Turn.");
                
                PokerGame.analyzeHand("Turn");

                setControls([
                    { text: 'Check', action: () => PokerGame.river(0), primary: false },
                    { text: 'Bet 50', action: () => PokerGame.river(50), primary: true },
                    { text: 'Toggle Advice', action: PokerGame.toggleAdvice, primary: false }
                ]);
            },
            river: (bet) => {
                if (STATE.chips < bet) return;
                STATE.chips -= bet;
                STATE.bet += bet;

                STATE.communityCards.push(STATE.deck.pop());
                renderHands();
                animateDeal();
                updateDealer("The River. Final decision.");
                
                PokerGame.analyzeHand("River");

                setControls([
                    { text: 'Check', action: () => PokerGame.showdown(0), primary: false },
                    { text: 'Bet 100', action: () => PokerGame.showdown(100), primary: true },
                    { text: 'Toggle Advice', action: PokerGame.toggleAdvice, primary: false }
                ]);
            },
            analyzeHand: (stage) => {
                const score = PokerGame.evaluate(STATE.playerHand, STATE.communityCards);
                const winProb = PokerGame.calculateOdds();
                
                let advice = `<strong>${stage}:</strong> Win Probability: ${winProb}%<br>`;
                
                if (score > 60000) advice += "Full House or better! All in.";
                else if (score > 50000) advice += "Flush! Very strong.";
                else if (score > 40000) advice += "Straight! Strong hand.";
                else if (score > 30000) advice += "Three of a Kind. Good position.";
                else if (score > 20000) advice += "Two Pair. Strong.";
                else if (score > 10000) advice += "Pair. Decent.";
                else if (winProb > 60) advice += "High Card but good odds.";
                else advice += "Weak hand. Caution.";
                
                PokerGame.showAdvice(advice);
            },
            showdown: (bet) => {
                if (STATE.chips < bet) return;
                STATE.chips -= bet;
                STATE.bet += bet;

                STATE.dealerHand.forEach(c => c.faceUp = true);
                renderHands();

                const pScore = PokerGame.evaluate(STATE.playerHand, STATE.communityCards);
                const dScore = PokerGame.evaluate(STATE.dealerHand, STATE.communityCards);

                if (pScore > dScore) {
                    STATE.chips += STATE.bet * 2;
                    updateDealer("You have the better hand.");
                    showOverlay("You Win!");
                    animateWin('Player');
                    PokerGame.showAdvice("<strong>Winner!</strong> Your hand was stronger.");
                    
                    if (STATE.chips >= 5000) {
                        setTimeout(() => {
                            showOverlay("POKER CHAMPION!", 5000);
                            updateDealer("You cleaned me out. The table is yours.");
                        }, 2000);
                        return;
                    }
                } else {
                    updateDealer("My hand is stronger.");
                    showOverlay("Dealer Wins");
                    animateWin('Dealer');
                    PokerGame.showAdvice("<strong>Lost.</strong> Dealer had a better hand.");
                }

                setTimeout(PokerGame.startRound, 4000);
            },
            fold: () => {
                updateDealer("Folded.");
                PokerGame.showAdvice("<strong>Folded.</strong> Saving chips for a better hand.");
                setTimeout(PokerGame.startRound, 1000);
            },
            evaluate: (hand, community) => {
                const all = [...hand, ...community];
                if (all.length === 0) return 0;
                
                // Sort by rank descending
                all.sort((a, b) => b.pokerValue - a.pokerValue);
                
                // Check Flush
                const suits = {};
                all.forEach(c => suits[c.suit] = (suits[c.suit] || 0) + 1);
                let flushSuit = null;
                for (let s in suits) if (suits[s] >= 5) flushSuit = s;
                
                let flushScore = 0;
                if (flushSuit) {
                    const flushCards = all.filter(c => c.suit === flushSuit);
                    flushScore = 50000 + flushCards[0].pokerValue;
                }

                // Check Straight
                let straightScore = 0;
                let uniqueRanks = [...new Set(all.map(c => c.pokerValue))];
                let streak = 0;
                let maxStraightRank = 0;
                for (let i = 0; i < uniqueRanks.length - 1; i++) {
                    if (uniqueRanks[i] - uniqueRanks[i+1] === 1) {
                        streak++;
                        if (streak >= 4) maxStraightRank = uniqueRanks[i - 3];
                    } else {
                        streak = 0;
                    }
                }
                // Wheel (A-5)
                if (!maxStraightRank && uniqueRanks.includes(14) && uniqueRanks.includes(5) && uniqueRanks.includes(4) && uniqueRanks.includes(3) && uniqueRanks.includes(2)) {
                    maxStraightRank = 5;
                }
                
                if (maxStraightRank) straightScore = 40000 + maxStraightRank;

                // Check Pairs/Trips/Quads
                const counts = {};
                all.forEach(c => counts[c.pokerValue] = (counts[c.pokerValue] || 0) + 1);
                
                let pairScore = 0;
                let four = 0, three = 0, pair1 = 0, pair2 = 0;
                
                for (let r in counts) {
                    const rank = parseInt(r);
                    const count = counts[r];
                    if (count === 4) four = rank;
                    else if (count === 3) {
                        if (three > 0) pair1 = three; // downgrade previous three to pair
                        three = rank;
                    }
                    else if (count === 2) {
                        if (pair1 > 0) pair2 = pair1;
                        pair1 = rank;
                    }
                }
                
                if (four) pairScore = 70000 + four;
                else if (three && pair1) pairScore = 60000 + three; // Full House
                else if (flushScore) return flushScore; // Flush beats straight
                else if (straightScore) return straightScore;
                else if (three) pairScore = 30000 + three;
                else if (pair1 && pair2) pairScore = 20000 + pair1;
                else if (pair1) pairScore = 10000 + pair1;
                else pairScore = all[0].pokerValue; // High card
                
                return pairScore;
            },
            calculateOdds: () => {
                // Monte Carlo Simulation
                const iterations = 500;
                let wins = 0;
                let ties = 0;
                
                // Known cards
                const knownCards = [...STATE.playerHand, ...STATE.communityCards];
                const knownIds = new Set(knownCards.map(c => c.suit + c.rank));
                
                // Create a deck of remaining cards
                const fullDeck = createDeck();
                const remainingDeck = fullDeck.filter(c => !knownIds.has(c.suit + c.rank));
                
                for (let i = 0; i < iterations; i++) {
                    // Shuffle remaining deck
                    const simDeck = [...remainingDeck];
                    for (let j = simDeck.length - 1; j > 0; j--) {
                        const k = Math.floor(Math.random() * (j + 1));
                        [simDeck[j], simDeck[k]] = [simDeck[k], simDeck[j]];
                    }
                    
                    // Deal opponent hand
                    const oppHand = [simDeck.pop(), simDeck.pop()];
                    
                    // Deal remaining community cards
                    const simCommunity = [...STATE.communityCards];
                    while (simCommunity.length < 5) {
                        simCommunity.push(simDeck.pop());
                    }
                    
                    const myScore = PokerGame.evaluate(STATE.playerHand, simCommunity);
                    const oppScore = PokerGame.evaluate(oppHand, simCommunity);
                    
                    if (myScore > oppScore) wins++;
                    else if (myScore === oppScore) ties++;
                }
                
                return ((wins + ties/2) / iterations * 100).toFixed(1);
            }
        };

        // --- Main ---
        function startGame(gameType) {
            document.getElementById('game-menu').style.display = 'none';
            STATE.game = gameType;
            
            if (gameType === 'war') WarGame.init();
            if (gameType === 'blackjack') BlackjackGame.init();
            if (gameType === 'poker') PokerGame.init();
        }

        // Initialize
        DataManager.autoLoad();
        
        // Auto-save on chip changes (simple hook)
        const originalUpdateDealer = updateDealer;
        updateDealer = (msg) => {
            originalUpdateDealer(msg);
            DataManager.autoSave();
        };


    </script>
</body>
</html>