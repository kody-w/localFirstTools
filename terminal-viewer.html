<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Terminal Log Visualizer</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-color: #1e1e1e;
        --panel-bg: #252526;
        --text-color: #f0f0f0;
        --header-bg: #323233;
        --accent-color: #0078d7;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --error-color: #f44336;
        --border-color: #3e3e42;
        --menu-hover: #3a3a3a;
        --http-color: #2196f3;
        --storage-color: #9c27b0;
        --openai-color: #00bcd4;
        --json-color: #ff79c6;
        --separator-color: #444;
        --hover-bg: #2d2d30;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header {
        background-color: var(--header-bg);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .header-title {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-title h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 400;
      }

      .header-title i {
        font-size: 1.5rem;
        color: var(--accent-color);
      }

      .controls {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      .sidebar {
        width: 250px;
        background-color: var(--panel-bg);
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
      }

      .filter-group {
        margin-bottom: 8px;
      }

      .filter-group-title {
        padding: 10px 15px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        background-color: var(--header-bg);
        border-bottom: 1px solid var(--border-color);
      }

      .filter-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
      }

      .filter-item:hover {
        background-color: var(--menu-hover);
      }

      .filter-item.active {
        background-color: var(--accent-color);
      }

      .filter-item-label {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .workspace {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      .input-panel {
        padding: 15px;
        background-color: var(--panel-bg);
        border-bottom: 1px solid var(--border-color);
      }

      #log-textarea {
        width: 100%;
        height: 150px;
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 10px;
        font-family: "Consolas", "Courier New", monospace;
        resize: vertical;
        margin-bottom: 10px;
      }

      .btn-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s, transform 0.1s;
      }

      .btn:hover {
        background-color: #0066b5;
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn-clear {
        background-color: #555;
      }

      .btn-clear:hover {
        background-color: #666;
      }

      .btn-success {
        background-color: var(--success-color);
      }

      .btn-success:hover {
        background-color: #388e3c;
      }

      .search-container {
        display: flex;
        align-items: center;
        position: relative;
        margin-top: 10px;
      }

      .search-box {
        padding: 8px 12px 8px 36px;
        border-radius: 20px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
        color: var(--text-color);
        width: 100%;
        font-size: 0.9rem;
      }

      .search-icon {
        position: absolute;
        left: 12px;
        color: #777;
        font-size: 0.9rem;
      }

      /* Log visualization area */
      .logs-panel {
        flex: 1;
        overflow: auto;
        background-color: var(--bg-color);
        padding: 0;
        position: relative;
      }

      .log-categories {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--panel-bg);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .log-category {
        padding: 8px 16px;
        cursor: pointer;
        border-right: 1px solid var(--border-color);
        font-size: 0.9rem;
        transition: background-color 0.2s;
      }

      .log-category:hover {
        background-color: var(--menu-hover);
      }

      .log-category.active {
        background-color: var(--accent-color);
      }

      .log-container {
        padding: 0;
      }

      .log-entry {
        margin-bottom: 1px;
        display: flex;
        flex-direction: column;
        border-left: 3px solid transparent;
        transition: background-color 0.15s;
      }

      .log-entry:hover {
        background-color: var(--hover-bg);
      }

      .log-entry.http-entry {
        border-left-color: var(--http-color);
      }

      .log-entry.success-entry {
        border-left-color: var(--success-color);
      }

      .log-entry.error-entry {
        border-left-color: var(--error-color);
      }

      .log-entry.warning-entry {
        border-left-color: var(--warning-color);
      }

      .log-entry.storage-entry {
        border-left-color: var(--storage-color);
      }

      .log-entry.openai-entry {
        border-left-color: var(--openai-color);
      }

      .log-header {
        padding: 6px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        border-bottom: 1px solid var(--separator-color);
        position: relative;
      }

      .log-icon {
        margin-right: 8px;
        font-size: 14px;
      }

      .timestamp {
        color: #888;
        font-size: 13px;
        margin-right: 10px;
        white-space: nowrap;
      }

      .log-summary {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 13px;
      }

      .log-http {
        color: var(--http-color);
      }

      .log-success {
        color: var(--success-color);
      }

      .log-warning {
        color: var(--warning-color);
      }

      .log-error {
        color: var(--error-color);
      }

      .log-storage {
        color: var(--storage-color);
      }

      .log-openai {
        color: var(--openai-color);
      }

      .log-json {
        color: var(--json-color);
      }

      .log-tools {
        display: flex;
        gap: 8px;
      }

      .log-tool {
        color: #888;
        cursor: pointer;
        font-size: 14px;
        transition: color 0.2s;
      }

      .log-tool:hover {
        color: var(--text-color);
      }

      .log-details {
        display: none;
        padding: 10px;
        background-color: var(--panel-bg);
        border-bottom: 1px solid var(--separator-color);
        font-family: "Consolas", "Courier New", monospace;
        font-size: 13px;
        white-space: pre-wrap;
        word-wrap: break-word;
        position: relative;
      }

      .log-entry.expanded .log-details {
        display: block;
      }

      .log-entry.expanded .fa-angle-down {
        transform: rotate(180deg);
      }

      .log-property {
        margin-bottom: 5px;
      }

      .property-name {
        font-weight: bold;
        color: #888;
      }

      .property-value {
        margin-left: 20px;
      }

      .status-bar {
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--header-bg);
        border-top: 1px solid var(--border-color);
        font-size: 0.9rem;
      }

      .theme-switch {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #555;
        transition: 0.4s;
        border-radius: 20px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--accent-color);
      }

      input:checked + .slider:before {
        transform: translateX(20px);
      }

      .badge {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: normal;
        min-width: 24px;
        text-align: center;
      }

      .badge-http {
        background-color: var(--http-color);
        color: white;
      }

      .badge-success {
        background-color: var(--success-color);
        color: white;
      }

      .badge-error {
        background-color: var(--error-color);
        color: white;
      }

      .badge-warning {
        background-color: var(--warning-color);
        color: black;
      }

      .badge-storage {
        background-color: var(--storage-color);
        color: white;
      }

      .badge-openai {
        background-color: var(--openai-color);
        color: white;
      }

      .badge-json {
        background-color: var(--json-color);
        color: black;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--accent-color);
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .highlighted {
        background-color: rgba(255, 215, 0, 0.2);
        border-radius: 2px;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 20px;
        text-align: center;
        color: #888;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #555;
      }

      .empty-state-title {
        font-size: 20px;
        margin-bottom: 10px;
      }

      .empty-state-message {
        font-size: 14px;
        max-width: 500px;
      }

      .copy-tooltip {
        position: absolute;
        background-color: var(--accent-color);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        bottom: -10px;
        right: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s, transform 0.3s;
        transform: translateY(10px);
        z-index: 100;
      }

      .copy-tooltip.visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* Light theme */
      body.light-theme {
        --bg-color: #f8f8f8;
        --panel-bg: #f1f1f1;
        --text-color: #333;
        --header-bg: #e5e5e5;
        --border-color: #ccc;
        --menu-hover: #e0e0e0;
        --separator-color: #ddd;
        --hover-bg: #e8e8e8;
      }

      body.light-theme .log-details {
        background-color: #fff;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          max-height: 200px;
          overflow-y: auto;
        }

        .log-header {
          flex-wrap: wrap;
        }

        .log-tools {
          margin-top: 5px;
        }

        .controls {
          flex-wrap: wrap;
        }
      }

      /* Collapse/Expand All Buttons */
      .log-controls {
        display: flex;
        gap: 10px;
        padding: 5px 10px;
        background-color: var(--panel-bg);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 35px;
        z-index: 5;
      }

      .log-controls button {
        background-color: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 3px 8px;
        font-size: 0.8rem;
        border-radius: 3px;
        cursor: pointer;
      }

      .log-controls button:hover {
        background-color: var(--menu-hover);
      }

      /* Status indicators */
      .status-indicators {
        display: flex;
        gap: 15px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
      }

      .indicator-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #888;
      }

      .indicator-dot.http {
        background-color: var(--http-color);
      }

      .indicator-dot.success {
        background-color: var(--success-color);
      }

      .indicator-dot.error {
        background-color: var(--error-color);
      }

      .indicator-dot.warning {
        background-color: var(--warning-color);
      }

      .indicator-dot.storage {
        background-color: var(--storage-color);
      }

      .indicator-dot.openai {
        background-color: var(--openai-color);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-title">
        <i class="fas fa-terminal"></i>
        <h1>Advanced Terminal Log Visualizer</h1>
      </div>
      <div class="controls">
        <div class="theme-switch">
          <i class="fas fa-moon"></i>
          <label class="switch">
            <input type="checkbox" id="theme-toggle" />
            <span class="slider"></span>
          </label>
          <i class="fas fa-sun"></i>
        </div>
      </div>
    </header>

    <div class="main-container">
      <div class="sidebar">
        <div class="filter-group">
          <div class="filter-group-title">Log Types</div>
          <div class="filter-item active" data-filter="all">
            <div class="filter-item-label">
              <i class="fas fa-list"></i>
              All Logs
            </div>
            <span id="count-all" class="badge badge-http">0</span>
          </div>
          <div class="filter-item" data-filter="http">
            <div class="filter-item-label">
              <i class="fas fa-exchange-alt"></i>
              HTTP Requests
            </div>
            <span id="count-http" class="badge badge-http">0</span>
          </div>
          <div class="filter-item" data-filter="success">
            <div class="filter-item-label">
              <i class="fas fa-check-circle"></i>
              Success
            </div>
            <span id="count-success" class="badge badge-success">0</span>
          </div>
          <div class="filter-item" data-filter="error">
            <div class="filter-item-label">
              <i class="fas fa-exclamation-circle"></i>
              Errors
            </div>
            <span id="count-error" class="badge badge-error">0</span>
          </div>
          <div class="filter-item" data-filter="warning">
            <div class="filter-item-label">
              <i class="fas fa-exclamation-triangle"></i>
              Warnings
            </div>
            <span id="count-warning" class="badge badge-warning">0</span>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-group-title">Services</div>
          <div class="filter-item" data-filter="storage">
            <div class="filter-item-label">
              <i class="fas fa-database"></i>
              Storage
            </div>
            <span id="count-storage" class="badge badge-storage">0</span>
          </div>
          <div class="filter-item" data-filter="openai">
            <div class="filter-item-label">
              <i class="fas fa-brain"></i>
              OpenAI API
            </div>
            <span id="count-openai" class="badge badge-openai">0</span>
          </div>
          <div class="filter-item" data-filter="json">
            <div class="filter-item-label">
              <i class="fas fa-code"></i>
              JSON Data
            </div>
            <span id="count-json" class="badge badge-json">0</span>
          </div>
        </div>
      </div>

      <div class="workspace">
        <div class="input-panel">
          <textarea
            id="log-textarea"
            placeholder="Paste your terminal logs here..."
          ></textarea>
          <div class="btn-group">
            <button class="btn" id="parse-logs">
              <i class="fas fa-play"></i>
              Parse Logs
            </button>
            <button class="btn btn-clear" id="clear-logs">
              <i class="fas fa-trash"></i>
              Clear
            </button>
            <button class="btn btn-success" id="copy-all">
              <i class="fas fa-copy"></i>
              Copy All
            </button>
            <button class="btn" id="auto-fix">
              <i class="fas fa-magic"></i>
              Auto-Fix
            </button>
            <button class="btn" id="toggle-timestamp">
              <i class="fas fa-clock"></i>
              <span id="timestamp-text">Hide Timestamps</span>
            </button>
          </div>
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              class="search-box"
              id="search-input"
              placeholder="Search logs..."
            />
          </div>
        </div>

        <div class="logs-panel">
          <div class="log-categories">
            <div class="log-category active" data-view="grouped">Grouped</div>
            <div class="log-category" data-view="timeline">Timeline</div>
            <div class="log-category" data-view="raw">Raw</div>
          </div>

          <div class="log-controls">
            <button id="expand-all">
              <i class="fas fa-expand-alt"></i> Expand All
            </button>
            <button id="collapse-all">
              <i class="fas fa-compress-alt"></i> Collapse All
            </button>
            <div class="status-indicators">
              <div class="status-indicator">
                <div class="indicator-dot http"></div>
                <span>HTTP</span>
              </div>
              <div class="status-indicator">
                <div class="indicator-dot success"></div>
                <span>Success</span>
              </div>
              <div class="status-indicator">
                <div class="indicator-dot error"></div>
                <span>Error</span>
              </div>
              <div class="status-indicator">
                <div class="indicator-dot warning"></div>
                <span>Warning</span>
              </div>
            </div>
          </div>

          <div id="spinner" class="spinner"></div>

          <div class="log-container" id="log-container">
            <div class="empty-state">
              <i class="fas fa-terminal"></i>
              <div class="empty-state-title">No Logs to Display</div>
              <div class="empty-state-message">
                Paste your terminal logs in the text area above and click "Parse
                Logs" to visualize them.
              </div>
            </div>
          </div>
        </div>

        <div class="status-bar">
          <div id="status-text">Ready to parse logs</div>
          <div id="line-count">Lines: 0</div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // DOM Elements
        const logTextarea = document.getElementById("log-textarea");
        const logContainer = document.getElementById("log-container");
        const parseLogsBtn = document.getElementById("parse-logs");
        const clearLogsBtn = document.getElementById("clear-logs");
        const copyAllBtn = document.getElementById("copy-all");
        const autoFixBtn = document.getElementById("auto-fix");
        const searchInput = document.getElementById("search-input");
        const toggleTimestampBtn = document.getElementById("toggle-timestamp");
        const timestampText = document.getElementById("timestamp-text");
        const themeToggle = document.getElementById("theme-toggle");
        const statusText = document.getElementById("status-text");
        const lineCount = document.getElementById("line-count");
        const spinner = document.getElementById("spinner");
        const expandAllBtn = document.getElementById("expand-all");
        const collapseAllBtn = document.getElementById("collapse-all");
        const filterItems = document.querySelectorAll(".filter-item");
        const logCategories = document.querySelectorAll(".log-category");

        // Variables
        let showTimestamps = true;
        let currentView = "grouped";
        let currentFilter = "all";
        let logEntries = [];
        let processedLogEntries = [];

        // Count variables for different log types
        let counts = {
          all: 0,
          http: 0,
          success: 0,
          error: 0,
          warning: 0,
          storage: 0,
          openai: 0,
          json: 0,
        };

        // Parse logs button click
        parseLogsBtn.addEventListener("click", function () {
          const logContent = logTextarea.value.trim();
          if (!logContent) {
            statusText.textContent = "No logs to parse.";
            return;
          }

          spinner.style.display = "block";
          logContainer.innerHTML = "";

          // Reset counts
          for (let key in counts) {
            counts[key] = 0;
          }

          setTimeout(() => {
            processLogs(logContent);
            displayLogEntries();
            updateCounts();
            spinner.style.display = "none";
          }, 100);
        });

        // Clear logs button click
        clearLogsBtn.addEventListener("click", function () {
          logTextarea.value = "";
          logContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-terminal"></i>
                        <div class="empty-state-title">No Logs to Display</div>
                        <div class="empty-state-message">
                            Paste your terminal logs in the text area above and click "Parse Logs" to visualize them.
                        </div>
                    </div>
                `;
          statusText.textContent = "Logs cleared.";
          lineCount.textContent = "Lines: 0";

          // Reset counts
          for (let key in counts) {
            counts[key] = 0;
            document.getElementById(`count-${key}`).textContent = "0";
          }

          logEntries = [];
          processedLogEntries = [];
        });

        // Copy all button click
        copyAllBtn.addEventListener("click", function () {
          let textToCopy;

          if (logEntries.length === 0) {
            statusText.textContent = "No logs to copy.";
            return;
          }

          if (currentView === "raw") {
            // Copy raw log text
            textToCopy = logEntries.map((entry) => entry.rawText).join("\n");
          } else {
            // Copy processed log content
            textToCopy = logEntries
              .map((entry) => {
                return `[${entry.timestamp}] ${entry.summary}${
                  entry.details ? "\n" + entry.details : ""
                }`;
              })
              .join("\n\n");
          }

          navigator.clipboard
            .writeText(textToCopy)
            .then(() => {
              statusText.textContent = "Logs copied to clipboard!";
              setTimeout(() => {
                statusText.textContent = "Ready";
              }, 2000);
            })
            .catch((err) => {
              statusText.textContent = "Failed to copy: " + err;
            });
        });

        // Auto-fix button click
        autoFixBtn.addEventListener("click", function () {
          const content = logTextarea.value.trim();
          if (!content) {
            statusText.textContent = "No logs to fix.";
            return;
          }

          // Try to fix truncated logs
          const fixedContent = fixTruncatedLogs(content);
          logTextarea.value = fixedContent;

          // Re-parse with fixed logs
          parseLogsBtn.click();
          statusText.textContent = "Attempted to fix truncated logs.";
        });

        // Search input
        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          filterLogEntries();
        });

        // Toggle timestamps
        toggleTimestampBtn.addEventListener("click", function () {
          showTimestamps = !showTimestamps;
          timestampText.textContent = showTimestamps
            ? "Hide Timestamps"
            : "Show Timestamps";

          const timestamps = document.querySelectorAll(".timestamp");
          timestamps.forEach((ts) => {
            ts.style.display = showTimestamps ? "inline-block" : "none";
          });
        });

        // Theme toggle
        themeToggle.addEventListener("change", function () {
          document.body.classList.toggle("light-theme", this.checked);
        });

        // Expand all button
        expandAllBtn.addEventListener("click", function () {
          document.querySelectorAll(".log-entry").forEach((entry) => {
            entry.classList.add("expanded");
          });
        });

        // Collapse all button
        collapseAllBtn.addEventListener("click", function () {
          document.querySelectorAll(".log-entry").forEach((entry) => {
            entry.classList.remove("expanded");
          });
        });

        // Filter items click
        filterItems.forEach((item) => {
          item.addEventListener("click", function () {
            filterItems.forEach((i) => i.classList.remove("active"));
            this.classList.add("active");
            currentFilter = this.getAttribute("data-filter");
            filterLogEntries();
          });
        });

        // Log categories click
        logCategories.forEach((category) => {
          category.addEventListener("click", function () {
            logCategories.forEach((c) => c.classList.remove("active"));
            this.classList.add("active");
            currentView = this.getAttribute("data-view");
            displayLogEntries();
          });
        });

        // Function to process logs
        function processLogs(content) {
          // Reset variables
          logEntries = [];

          // First normalize line endings and split into lines
          const lines = content.replace(/\r\n/g, "\n").split("\n");

          let currentEntry = null;
          let buffer = "";

          lines.forEach((line, index) => {
            // Check if this is a new log entry (has timestamp)
            const timestampMatch = line.match(
              /^\[(20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\]/
            );

            if (timestampMatch) {
              // Save previous entry if exists
              if (currentEntry !== null) {
                if (buffer.trim()) {
                  currentEntry.details = buffer.trim();
                }
                logEntries.push(currentEntry);
              }

              // Start a new entry
              buffer = "";
              const timestamp = timestampMatch[1];

              // Remove timestamp from line for summary
              const summaryText = line.replace(timestampMatch[0], "").trim();

              // Determine entry type
              let type = "info";

              if (
                line.includes("HTTP Request:") ||
                line.includes("Status Code:") ||
                line.includes("GET") ||
                line.includes("POST") ||
                line.includes("PUT") ||
                line.includes("DELETE")
              ) {
                type = "http";
                counts.http++;
              } else if (
                line.includes("Status Code: 200") ||
                line.includes("success") ||
                line.includes("Success")
              ) {
                type = "success";
                counts.success++;
              } else if (line.includes("warning") || line.includes("Warning")) {
                type = "warning";
                counts.warning++;
              } else if (
                line.includes("error") ||
                line.includes("Error") ||
                line.includes("Exception") ||
                line.includes("Status Code: 4") ||
                line.includes("Status Code: 5")
              ) {
                type = "error";
                counts.error++;
              }

              // Determine service type
              let service = "";

              if (
                line.includes("Storage") ||
                line.includes("File/1.0") ||
                line.includes("/azfbusinessbot3c92ab/")
              ) {
                service = "storage";
                counts.storage++;
              } else if (
                line.includes("OpenAI") ||
                line.includes("openai") ||
                line.includes("/deployments/gpt")
              ) {
                service = "openai";
                counts.openai++;
              } else if (line.includes("JSON data") || line.includes('{"')) {
                service = "json";
                counts.json++;
              }

              currentEntry = {
                timestamp,
                summary: summaryText,
                type,
                service,
                rawText: line,
              };
            } else {
              // Add to current entry details
              if (currentEntry !== null) {
                buffer += line + "\n";
                currentEntry.rawText += "\n" + line;
              } else {
                // This is a truncated log, create an entry for it
                currentEntry = {
                  timestamp: "",
                  summary: line,
                  type: detectLogType(line),
                  service: detectServiceType(line),
                  rawText: line,
                };

                // Count based on detected type
                if (currentEntry.type) {
                  counts[currentEntry.type]++;
                }

                // Count based on detected service
                if (currentEntry.service) {
                  counts[currentEntry.service]++;
                }
              }
            }
          });

          // Add the last entry
          if (currentEntry !== null) {
            if (buffer.trim()) {
              currentEntry.details = buffer.trim();
            }
            logEntries.push(currentEntry);
          }

          // Total count
          counts.all = logEntries.length;

          lineCount.textContent = `Lines: ${lines.length}`;
          statusText.textContent = `Processed ${logEntries.length} log entries`;
        }

        // Function to detect log type from a line
        function detectLogType(line) {
          if (
            line.includes("HTTP Request:") ||
            line.includes("Status Code:") ||
            line.includes("GET") ||
            line.includes("POST") ||
            line.includes("PUT") ||
            line.includes("DELETE")
          ) {
            return "http";
          } else if (
            line.includes("Status Code: 200") ||
            line.includes("success") ||
            line.includes("Success")
          ) {
            return "success";
          } else if (line.includes("warning") || line.includes("Warning")) {
            return "warning";
          } else if (
            line.includes("error") ||
            line.includes("Error") ||
            line.includes("Exception") ||
            line.includes("Status Code: 4") ||
            line.includes("Status Code: 5")
          ) {
            return "error";
          }
          return "info";
        }

        // Function to detect service type from a line
        function detectServiceType(line) {
          if (
            line.includes("Storage") ||
            line.includes("File/1.0") ||
            line.includes("/azfbusinessbot3c92ab/")
          ) {
            return "storage";
          } else if (
            line.includes("OpenAI") ||
            line.includes("openai") ||
            line.includes("/deployments/gpt")
          ) {
            return "openai";
          } else if (line.includes("JSON data") || line.includes('{"')) {
            return "json";
          }
          return "";
        }

        // Function to update the counter badges
        function updateCounts() {
          for (let key in counts) {
            document.getElementById(`count-${key}`).textContent = counts[key];
          }
        }

        // Function to display log entries based on current view
        function displayLogEntries() {
          logContainer.innerHTML = "";

          if (logEntries.length === 0) {
            logContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-terminal"></i>
                            <div class="empty-state-title">No Logs to Display</div>
                            <div class="empty-state-message">
                                Paste your terminal logs in the text area above and click "Parse Logs" to visualize them.
                            </div>
                        </div>
                    `;
            return;
          }

          // Filter entries based on current filter
          const filteredEntries =
            currentFilter === "all"
              ? logEntries
              : logEntries.filter(
                  (entry) =>
                    entry.type === currentFilter ||
                    entry.service === currentFilter
                );

          // Filter by search term if present
          const searchTerm = searchInput.value.toLowerCase();
          const searchFilteredEntries = searchTerm
            ? filteredEntries.filter(
                (entry) =>
                  entry.summary.toLowerCase().includes(searchTerm) ||
                  (entry.details &&
                    entry.details.toLowerCase().includes(searchTerm))
              )
            : filteredEntries;

          if (searchFilteredEntries.length === 0) {
            logContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <div class="empty-state-title">No Matching Logs</div>
                            <div class="empty-state-message">
                                No logs match your current filter and search criteria.
                            </div>
                        </div>
                    `;
            return;
          }

          // Process entries based on current view
          switch (currentView) {
            case "grouped":
              displayGroupedView(searchFilteredEntries);
              break;
            case "timeline":
              displayTimelineView(searchFilteredEntries);
              break;
            case "raw":
              displayRawView(searchFilteredEntries);
              break;
          }
        }

        // Display logs in grouped view
        function displayGroupedView(entries) {
          // Group entries by type
          const groupedEntries = {
            error: entries.filter((entry) => entry.type === "error"),
            warning: entries.filter((entry) => entry.type === "warning"),
            http: entries.filter((entry) => entry.type === "http"),
            success: entries.filter((entry) => entry.type === "success"),
            other: entries.filter(
              (entry) =>
                !["error", "warning", "http", "success"].includes(entry.type)
            ),
          };

          // Start with errors
          if (groupedEntries.error.length > 0) {
            appendGroupHeader("Errors", "error", groupedEntries.error.length);
            groupedEntries.error.forEach((entry) => appendLogEntry(entry));
          }

          // Then warnings
          if (groupedEntries.warning.length > 0) {
            appendGroupHeader(
              "Warnings",
              "warning",
              groupedEntries.warning.length
            );
            groupedEntries.warning.forEach((entry) => appendLogEntry(entry));
          }

          // Then HTTP requests
          if (groupedEntries.http.length > 0) {
            appendGroupHeader(
              "HTTP Requests",
              "http",
              groupedEntries.http.length
            );
            groupedEntries.http.forEach((entry) => appendLogEntry(entry));
          }

          // Then success messages
          if (groupedEntries.success.length > 0) {
            appendGroupHeader(
              "Success",
              "success",
              groupedEntries.success.length
            );
            groupedEntries.success.forEach((entry) => appendLogEntry(entry));
          }

          // Then everything else
          if (groupedEntries.other.length > 0) {
            appendGroupHeader("Other", "info", groupedEntries.other.length);
            groupedEntries.other.forEach((entry) => appendLogEntry(entry));
          }
        }

        // Display logs in timeline view
        function displayTimelineView(entries) {
          // Sort entries by timestamp
          const sortedEntries = [...entries].sort((a, b) => {
            if (!a.timestamp) return -1;
            if (!b.timestamp) return 1;
            return new Date(a.timestamp) - new Date(b.timestamp);
          });

          sortedEntries.forEach((entry) => appendLogEntry(entry));
        }

        // Display logs in raw view
        function displayRawView(entries) {
          const rawContainer = document.createElement("pre");
          rawContainer.className = "raw-logs";
          rawContainer.style.padding = "10px";
          rawContainer.style.fontFamily = "Consolas, monospace";

          entries.forEach((entry) => {
            const line = document.createElement("div");

            if (entry.type) {
              line.className = `log-${entry.type}`;
            }

            line.textContent = entry.rawText;
            rawContainer.appendChild(line);
          });

          logContainer.appendChild(rawContainer);
        }

        // Append a group header to the log container
        function appendGroupHeader(title, type, count) {
          const header = document.createElement("div");
          header.className = "filter-group-title";
          header.innerHTML = `${title} <span class="badge badge-${type}">${count}</span>`;
          logContainer.appendChild(header);
        }

        // Append a log entry to the log container
        function appendLogEntry(entry) {
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry ${entry.type}-entry`;

          // Determine icon based on type
          let icon = "fa-info-circle";

          if (entry.type === "http") {
            icon = "fa-exchange-alt";
          } else if (entry.type === "success") {
            icon = "fa-check-circle";
          } else if (entry.type === "warning") {
            icon = "fa-exclamation-triangle";
          } else if (entry.type === "error") {
            icon = "fa-exclamation-circle";
          }

          // Create header
          const logHeader = document.createElement("div");
          logHeader.className = "log-header";

          let timestamp = "";
          if (entry.timestamp) {
            timestamp = `<span class="timestamp" style="${
              showTimestamps ? "" : "display:none;"
            }">[${entry.timestamp}]</span>`;
          }

          logHeader.innerHTML = `
                    <div>
                        <i class="fas ${icon} log-icon log-${entry.type}"></i>
                        ${timestamp}
                        <span class="log-summary">${highlightSearchText(
                          entry.summary
                        )}</span>
                    </div>
                    <div class="log-tools">
                        <i class="fas fa-copy log-tool copy-log" title="Copy log entry"></i>
                        <i class="fas fa-angle-down log-tool"></i>
                    </div>
                `;
          logEntry.appendChild(logHeader);

          // Create details section if entry has details
          if (entry.details) {
            const logDetails = document.createElement("div");
            logDetails.className = "log-details";

            // Attempt to parse JSON in details
            if (entry.details.includes("{") && entry.details.includes("}")) {
              try {
                // Find JSON objects in the text
                const jsonRegex = /(\{[\s\S]*?\})/g;
                const matches = entry.details.match(jsonRegex);

                if (matches) {
                  let processedDetails = entry.details;

                  matches.forEach((match) => {
                    try {
                      const formatted = JSON.stringify(
                        JSON.parse(match),
                        null,
                        2
                      );
                      processedDetails = processedDetails.replace(
                        match,
                        formatted
                      );
                    } catch (e) {
                      // Not valid JSON, ignore
                    }
                  });

                  logDetails.innerHTML = highlightSearchText(processedDetails);
                } else {
                  logDetails.innerHTML = highlightSearchText(entry.details);
                }
              } catch (e) {
                logDetails.innerHTML = highlightSearchText(entry.details);
              }
            } else {
              logDetails.innerHTML = highlightSearchText(entry.details);
            }

            // Create copy tooltip
            const copyTooltip = document.createElement("div");
            copyTooltip.className = "copy-tooltip";
            copyTooltip.textContent = "Copied!";
            logDetails.appendChild(copyTooltip);

            logEntry.appendChild(logDetails);
          }

          logContainer.appendChild(logEntry);
        }

        // Function to highlight search text
        function highlightSearchText(text) {
          const searchTerm = searchInput.value.toLowerCase();
          if (!searchTerm || !text) return text;

          // Escape regex special chars
          const escapedSearchTerm = searchTerm.replace(
            /[.*+?^${}()|[\]\\]/g,
            "\\$&"
          );
          const regex = new RegExp(`(${escapedSearchTerm})`, "gi");

          return text.replace(regex, '<span class="highlighted">$1</span>');
        }

        // Function to filter log entries based on current filter
        function filterLogEntries() {
          displayLogEntries();
        }

        // Function to attempt fixing truncated logs
        function fixTruncatedLogs(content) {
          let lines = content.replace(/\r\n/g, "\n").split("\n");
          let fixedLines = [];
          let currentLine = "";

          // Check first line for truncation
          const firstLine = lines[0];
          if (
            !firstLine.match(
              /^\[(20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\]/
            )
          ) {
            // First line is truncated, mark it as a comment
            fixedLines.push(`// TRUNCATED: ${firstLine}`);
          } else {
            fixedLines.push(firstLine);
          }

          // Process remaining lines
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i];

            // Check if this is a new log entry or continuation
            if (
              line.match(/^\[(20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\]/)
            ) {
              // This is a new log entry
              fixedLines.push(line);
            } else if (line.trim() === "") {
              // Empty line, preserve it
              fixedLines.push(line);
            } else if (line.includes("Headers={") && !line.includes("}")) {
              // This is a headers line that's truncated or spans multiple lines
              currentLine = line;

              // Keep consuming lines until we find the end of headers
              let j = i + 1;
              while (
                j < lines.length &&
                !lines[j].match(
                  /^\[(20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\]/
                )
              ) {
                currentLine += " " + lines[j].trim();
                j++;
              }

              fixedLines.push(currentLine);
              i = j - 1; // Skip consumed lines
            } else {
              // Regular continuation line or unknown format
              fixedLines.push(line);
            }
          }

          return fixedLines.join("\n");
        }

        // Event delegation for log entry clicks
        logContainer.addEventListener("click", function (e) {
          // Toggle expand/collapse
          if (
            e.target.classList.contains("log-header") ||
            e.target.closest(".log-header")
          ) {
            const logEntry = e.target.closest(".log-entry");
            if (logEntry) {
              logEntry.classList.toggle("expanded");
            }
          }

          // Copy log entry
          if (
            e.target.classList.contains("copy-log") ||
            e.target.closest(".copy-log")
          ) {
            const logEntry = e.target.closest(".log-entry");
            if (logEntry) {
              // Get text content to copy
              const summaryEl = logEntry.querySelector(".log-summary");
              const detailsEl = logEntry.querySelector(".log-details");

              let textToCopy = summaryEl.textContent;

              if (detailsEl) {
                textToCopy += "\n\n" + detailsEl.textContent;
              }

              navigator.clipboard
                .writeText(textToCopy)
                .then(() => {
                  // Show tooltip
                  const tooltip = logEntry.querySelector(".copy-tooltip");
                  if (tooltip) {
                    tooltip.classList.add("visible");
                    setTimeout(() => {
                      tooltip.classList.remove("visible");
                    }, 2000);
                  }
                })
                .catch((err) => {
                  console.error("Failed to copy: ", err);
                  statusText.textContent = "Failed to copy log entry";
                });
            }
          }
        });

        // Auto-parse logs when pasted
        logTextarea.addEventListener("paste", function () {
          setTimeout(() => {
            parseLogsBtn.click();
          }, 100);
        });
      });
    </script>
  </body>
</html>
