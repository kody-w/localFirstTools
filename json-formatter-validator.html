<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional JSON formatter, validator, and tree viewer with syntax highlighting, real-time validation, and advanced features">
    <title>JSON Formatter & Validator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f1419;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #00d4ff;
            --accent-hover: #00b8e6;
            --success: #00ff88;
            --error: #ff4757;
            --warning: #ffa502;
            --border: #2d3748;
            --json-string: #98c379;
            --json-number: #d19a66;
            --json-boolean: #c678dd;
            --json-null: #e06c75;
            --json-key: #61afef;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f7f9fc;
            --bg-tertiary: #e8eef5;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent: #0077cc;
            --accent-hover: #005fa3;
            --success: #00a854;
            --error: #d32f2f;
            --warning: #ff9800;
            --border: #cbd5e0;
            --json-string: #22863a;
            --json-number: #d73a49;
            --json-boolean: #6f42c1;
            --json-null: #d73a49;
            --json-key: #005cc5;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--border);
            box-shadow: 0 2px 10px var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--shadow);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .secondary-btn:hover {
            background: var(--bg-secondary);
        }

        .danger-btn {
            background: var(--error);
        }

        .danger-btn:hover {
            background: #e63946;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .panel-actions {
            display: flex;
            gap: 0.5rem;
        }

        textarea {
            flex: 1;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            resize: none;
            line-height: 1.6;
        }

        textarea:focus {
            outline: 2px solid var(--accent);
            outline-offset: 0;
        }

        .output-container {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            position: relative;
        }

        .tree-view {
            line-height: 1.8;
        }

        .tree-node {
            position: relative;
        }

        .tree-key {
            color: var(--json-key);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        .tree-key:hover {
            text-decoration: underline;
        }

        .tree-value-string {
            color: var(--json-string);
        }

        .tree-value-number {
            color: var(--json-number);
        }

        .tree-value-boolean {
            color: var(--json-boolean);
            font-weight: 600;
        }

        .tree-value-null {
            color: var(--json-null);
            font-style: italic;
        }

        .tree-expand {
            display: inline-block;
            width: 1rem;
            text-align: center;
            cursor: pointer;
            user-select: none;
            color: var(--text-secondary);
        }

        .tree-expand:hover {
            color: var(--accent);
        }

        .tree-children {
            margin-left: 1.5rem;
            border-left: 1px solid var(--border);
            padding-left: 0.5rem;
        }

        .tree-children.collapsed {
            display: none;
        }

        .tree-path {
            position: absolute;
            right: 0;
            color: var(--text-secondary);
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tree-node:hover > .tree-path {
            opacity: 1;
        }

        .status-bar {
            background: var(--bg-secondary);
            padding: 0.5rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-indicator.valid {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-indicator.invalid {
            background: var(--error);
            box-shadow: 0 0 8px var(--error);
        }

        .error-message {
            background: var(--error);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .success-message {
            background: var(--success);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideDown 0.3s;
        }

        .divider {
            width: 2px;
            background: var(--border);
            margin: 0 0.5rem;
        }

        .examples-dropdown {
            position: relative;
        }

        .examples-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-top: 0.5rem;
            min-width: 200px;
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 1000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .examples-menu.show {
            display: block;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .example-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .example-item:last-child {
            border-bottom: none;
        }

        .example-item:hover {
            background: var(--bg-tertiary);
        }

        .example-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .example-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        .search-container {
            margin-bottom: 0.5rem;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .search-input:focus {
            outline: 2px solid var(--accent);
            outline-offset: 0;
        }

        .search-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
        }

        .highlight {
            background: var(--warning);
            color: var(--bg-primary);
            padding: 0.1rem 0.2rem;
            border-radius: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .history-panel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 2px solid var(--border);
            box-shadow: -4px 0 20px var(--shadow);
            transition: right 0.3s;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .history-panel.show {
            right: 0;
        }

        .history-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .history-item {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            transform: translateX(-4px);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .history-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .history-preview {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
            margin-top: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .divider {
                height: 2px;
                width: 100%;
                margin: 0.5rem 0;
            }

            .controls {
                width: 100%;
                justify-content: flex-start;
            }

            button {
                flex: 1;
                min-width: 0;
            }

            .history-panel {
                width: 100%;
                right: -100%;
            }
        }

        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.1rem 0.4rem;
            font-family: monospace;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>JSON Formatter & Validator</h1>
                <div class="controls">
                    <button id="beautifyBtn" class="tooltip" data-tooltip="Ctrl+B">
                        <span>⚡</span> Beautify
                    </button>
                    <button id="minifyBtn" class="tooltip" data-tooltip="Ctrl+M">
                        <span>🔥</span> Minify
                    </button>
                    <button id="copyBtn" class="secondary-btn tooltip" data-tooltip="Ctrl+C">
                        <span>📋</span> Copy
                    </button>
                    <button id="clearBtn" class="secondary-btn danger-btn tooltip" data-tooltip="Ctrl+K">
                        <span>🗑️</span> Clear
                    </button>
                    <div class="examples-dropdown">
                        <button id="examplesBtn" class="secondary-btn">
                            <span>📚</span> Examples
                        </button>
                        <div id="examplesMenu" class="examples-menu"></div>
                    </div>
                    <button id="historyBtn" class="secondary-btn">
                        <span>📜</span> History
                    </button>
                    <button id="themeBtn" class="secondary-btn tooltip" data-tooltip="Ctrl+T">
                        <span id="themeIcon">🌙</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Input</div>
                    <div class="panel-actions">
                        <button id="pasteBtn" class="secondary-btn">
                            <span>📄</span> Paste
                        </button>
                    </div>
                </div>
                <div id="errorContainer"></div>
                <textarea id="jsonInput" placeholder="Paste or type JSON here..." spellcheck="false"></textarea>
            </div>

            <div class="divider"></div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Output</div>
                    <div class="panel-actions">
                        <button id="expandAllBtn" class="secondary-btn">
                            <span>➕</span> Expand All
                        </button>
                        <button id="collapseAllBtn" class="secondary-btn">
                            <span>➖</span> Collapse All
                        </button>
                        <button id="viewToggleBtn" class="secondary-btn">
                            <span>🔄</span> <span id="viewModeText">Tree View</span>
                        </button>
                    </div>
                </div>
                <div id="successContainer"></div>
                <div id="statsContainer"></div>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search JSON (key or value)..." />
                    <button id="searchClear" class="search-clear">✕</button>
                </div>
                <div id="output" class="output-container"></div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Ready</span>
            </div>
            <div class="status-item">
                <span>Characters: <strong id="charCount">0</strong></span>
            </div>
            <div class="status-item">
                <span>Lines: <strong id="lineCount">0</strong></span>
            </div>
            <div class="status-item">
                <span>Size: <strong id="sizeCount">0 B</strong></span>
            </div>
            <div class="status-item">
                <span>Keyboard: <kbd>Ctrl+B</kbd> Beautify <kbd>Ctrl+M</kbd> Minify <kbd>Ctrl+T</kbd> Theme</span>
            </div>
        </div>

        <div id="historyPanel" class="history-panel">
            <div class="history-header">
                <h3>History</h3>
                <button id="closeHistoryBtn" class="secondary-btn">✕</button>
            </div>
            <div class="history-content" id="historyContent">
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No history yet</p>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            jsonData: null,
            viewMode: 'tree', // 'tree' or 'formatted'
            expandedNodes: new Set(),
            theme: localStorage.getItem('jsonFormatter_theme') || 'dark',
            history: JSON.parse(localStorage.getItem('jsonFormatter_history') || '[]')
        };

        // DOM elements
        const elements = {
            input: document.getElementById('jsonInput'),
            output: document.getElementById('output'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            charCount: document.getElementById('charCount'),
            lineCount: document.getElementById('lineCount'),
            sizeCount: document.getElementById('sizeCount'),
            errorContainer: document.getElementById('errorContainer'),
            successContainer: document.getElementById('successContainer'),
            statsContainer: document.getElementById('statsContainer'),
            searchInput: document.getElementById('searchInput'),
            examplesMenu: document.getElementById('examplesMenu'),
            historyPanel: document.getElementById('historyPanel'),
            historyContent: document.getElementById('historyContent'),
            themeIcon: document.getElementById('themeIcon'),
            viewModeText: document.getElementById('viewModeText')
        };

        // Sample JSON examples
        const examples = [
            {
                title: 'Simple Object',
                description: 'Basic JSON object',
                json: { name: 'John Doe', age: 30, city: 'New York', active: true }
            },
            {
                title: 'Nested Object',
                description: 'Object with nested structures',
                json: {
                    user: {
                        id: 1,
                        profile: { name: 'Alice', email: 'alice@example.com' },
                        settings: { theme: 'dark', notifications: true }
                    }
                }
            },
            {
                title: 'Array Example',
                description: 'Array of objects',
                json: {
                    users: [
                        { id: 1, name: 'Alice', role: 'admin' },
                        { id: 2, name: 'Bob', role: 'user' },
                        { id: 3, name: 'Charlie', role: 'moderator' }
                    ]
                }
            },
            {
                title: 'Complex Structure',
                description: 'Deeply nested with arrays',
                json: {
                    company: 'TechCorp',
                    departments: [
                        {
                            name: 'Engineering',
                            teams: [
                                { name: 'Frontend', members: ['Alice', 'Bob'] },
                                { name: 'Backend', members: ['Charlie', 'David'] }
                            ]
                        },
                        { name: 'Design', teams: [{ name: 'UX', members: ['Eve'] }] }
                    ],
                    metadata: { version: '1.0', lastUpdated: '2025-01-15' }
                }
            },
            {
                title: 'API Response',
                description: 'Typical REST API response',
                json: {
                    status: 'success',
                    data: {
                        items: [
                            { id: 1, title: 'Item 1', price: 29.99, inStock: true },
                            { id: 2, title: 'Item 2', price: 49.99, inStock: false }
                        ],
                        pagination: { page: 1, perPage: 10, total: 2 }
                    },
                    timestamp: '2025-01-15T12:00:00Z'
                }
            },
            {
                title: 'Data Types',
                description: 'All JSON data types',
                json: {
                    string: 'Hello World',
                    number: 42,
                    float: 3.14159,
                    boolean: true,
                    nullValue: null,
                    array: [1, 2, 3, 4, 5],
                    object: { nested: 'value' }
                }
            }
        ];

        // Initialize
        function init() {
            applyTheme();
            setupEventListeners();
            renderExamplesMenu();
            updateStats();
        }

        // Event listeners
        function setupEventListeners() {
            elements.input.addEventListener('input', debounce(handleInput, 300));
            document.getElementById('beautifyBtn').addEventListener('click', beautify);
            document.getElementById('minifyBtn').addEventListener('click', minify);
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('clearBtn').addEventListener('click', clear);
            document.getElementById('pasteBtn').addEventListener('click', pasteFromClipboard);
            document.getElementById('themeBtn').addEventListener('click', toggleTheme);
            document.getElementById('expandAllBtn').addEventListener('click', expandAll);
            document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
            document.getElementById('viewToggleBtn').addEventListener('click', toggleViewMode);
            document.getElementById('examplesBtn').addEventListener('click', toggleExamplesMenu);
            document.getElementById('historyBtn').addEventListener('click', toggleHistory);
            document.getElementById('closeHistoryBtn').addEventListener('click', toggleHistory);
            elements.searchInput.addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('searchClear').addEventListener('click', clearSearch);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);

            // Click outside to close menus
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.examples-dropdown')) {
                    elements.examplesMenu.classList.remove('show');
                }
            });
        }

        // Handle input
        function handleInput() {
            const input = elements.input.value.trim();
            updateStats();

            if (!input) {
                clearMessages();
                elements.output.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Enter JSON to see formatted output</p>';
                setStatus('Ready', 'neutral');
                return;
            }

            try {
                state.jsonData = JSON.parse(input);
                clearMessages();
                showSuccess('Valid JSON');
                setStatus('Valid JSON', 'valid');
                renderOutput();
                saveToHistory(input);
            } catch (error) {
                state.jsonData = null;
                showError(error.message);
                setStatus('Invalid JSON', 'invalid');
                elements.output.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Fix JSON errors to see output</p>';
            }
        }

        // Render output based on view mode
        function renderOutput() {
            if (!state.jsonData) return;

            if (state.viewMode === 'tree') {
                renderTreeView();
            } else {
                renderFormattedView();
            }

            showStats();
        }

        // Render tree view
        function renderTreeView() {
            elements.output.innerHTML = '';
            const tree = document.createElement('div');
            tree.className = 'tree-view';
            renderNode(state.jsonData, tree, 'root');
            elements.output.appendChild(tree);
        }

        // Render a tree node recursively
        function renderNode(data, container, path) {
            if (data === null) {
                const span = document.createElement('span');
                span.className = 'tree-value-null';
                span.textContent = 'null';
                container.appendChild(span);
                return;
            }

            if (typeof data !== 'object') {
                const span = document.createElement('span');
                if (typeof data === 'string') {
                    span.className = 'tree-value-string';
                    span.textContent = `"${data}"`;
                } else if (typeof data === 'number') {
                    span.className = 'tree-value-number';
                    span.textContent = data;
                } else if (typeof data === 'boolean') {
                    span.className = 'tree-value-boolean';
                    span.textContent = data;
                }
                container.appendChild(span);
                return;
            }

            const isArray = Array.isArray(data);
            const entries = isArray ? data.map((v, i) => [i, v]) : Object.entries(data);

            entries.forEach(([key, value], index) => {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                const nodePath = `${path}.${key}`;

                const isComplex = value !== null && typeof value === 'object';
                const isExpanded = state.expandedNodes.has(nodePath);

                if (isComplex) {
                    const expand = document.createElement('span');
                    expand.className = 'tree-expand';
                    expand.textContent = isExpanded ? '▼' : '▶';
                    expand.onclick = () => toggleNode(nodePath);
                    nodeDiv.appendChild(expand);
                } else {
                    nodeDiv.appendChild(document.createTextNode('  '));
                }

                if (!isArray) {
                    const keySpan = document.createElement('span');
                    keySpan.className = 'tree-key';
                    keySpan.textContent = `"${key}": `;
                    nodeDiv.appendChild(keySpan);
                }

                if (!isComplex) {
                    renderNode(value, nodeDiv, nodePath);
                } else {
                    const bracket = document.createElement('span');
                    bracket.className = 'tree-key';
                    const itemCount = isArray ? value.length : Object.keys(value).length;
                    bracket.textContent = isArray ? `Array(${itemCount})` : `Object{${itemCount}}`;
                    nodeDiv.appendChild(bracket);

                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'tree-children';
                    if (!isExpanded) childrenDiv.classList.add('collapsed');
                    renderNode(value, childrenDiv, nodePath);
                    nodeDiv.appendChild(childrenDiv);
                }

                const pathSpan = document.createElement('span');
                pathSpan.className = 'tree-path';
                pathSpan.textContent = nodePath;
                nodeDiv.appendChild(pathSpan);

                container.appendChild(nodeDiv);
            });
        }

        // Toggle tree node
        function toggleNode(path) {
            if (state.expandedNodes.has(path)) {
                state.expandedNodes.delete(path);
            } else {
                state.expandedNodes.add(path);
            }
            renderOutput();
        }

        // Expand all nodes
        function expandAll() {
            state.expandedNodes.clear();
            collectAllPaths(state.jsonData, 'root');
            renderOutput();
        }

        // Collapse all nodes
        function collapseAll() {
            state.expandedNodes.clear();
            renderOutput();
        }

        // Collect all paths for expansion
        function collectAllPaths(data, path) {
            if (data === null || typeof data !== 'object') return;
            state.expandedNodes.add(path);
            const entries = Array.isArray(data) ? data.map((v, i) => [i, v]) : Object.entries(data);
            entries.forEach(([key, value]) => {
                collectAllPaths(value, `${path}.${key}`);
            });
        }

        // Render formatted view
        function renderFormattedView() {
            const formatted = JSON.stringify(state.jsonData, null, 2);
            const highlighted = syntaxHighlight(formatted);
            elements.output.innerHTML = `<pre style="margin: 0; line-height: 1.8;">${highlighted}</pre>`;
        }

        // Syntax highlighting
        function syntaxHighlight(json) {
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                let cls = 'tree-value-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'tree-key';
                    } else {
                        cls = 'tree-value-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'tree-value-boolean';
                } else if (/null/.test(match)) {
                    cls = 'tree-value-null';
                }
                return `<span class="${cls}">${match}</span>`;
            });
        }

        // Toggle view mode
        function toggleViewMode() {
            state.viewMode = state.viewMode === 'tree' ? 'formatted' : 'tree';
            elements.viewModeText.textContent = state.viewMode === 'tree' ? 'Tree View' : 'Formatted View';
            if (state.jsonData) renderOutput();
        }

        // Beautify
        function beautify() {
            const input = elements.input.value.trim();
            if (!input) return;

            try {
                const parsed = JSON.parse(input);
                elements.input.value = JSON.stringify(parsed, null, 2);
                handleInput();
            } catch (error) {
                showError('Cannot beautify invalid JSON');
            }
        }

        // Minify
        function minify() {
            const input = elements.input.value.trim();
            if (!input) return;

            try {
                const parsed = JSON.parse(input);
                elements.input.value = JSON.stringify(parsed);
                handleInput();
            } catch (error) {
                showError('Cannot minify invalid JSON');
            }
        }

        // Copy to clipboard
        async function copyToClipboard() {
            const text = elements.input.value.trim();
            if (!text) return;

            try {
                await navigator.clipboard.writeText(text);
                showSuccess('Copied to clipboard!');
            } catch (error) {
                showError('Failed to copy to clipboard');
            }
        }

        // Paste from clipboard
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                elements.input.value = text;
                handleInput();
            } catch (error) {
                showError('Failed to paste from clipboard');
            }
        }

        // Clear input
        function clear() {
            elements.input.value = '';
            state.jsonData = null;
            state.expandedNodes.clear();
            clearMessages();
            elements.output.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Enter JSON to see formatted output</p>';
            setStatus('Ready', 'neutral');
            updateStats();
        }

        // Show error message
        function showError(message) {
            clearMessages();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<span>❌</span> <span>${message}</span>`;
            elements.errorContainer.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Show success message
        function showSuccess(message) {
            clearMessages();
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<span>✅</span> <span>${message}</span>`;
            elements.successContainer.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Clear messages
        function clearMessages() {
            elements.errorContainer.innerHTML = '';
            elements.successContainer.innerHTML = '';
        }

        // Set status
        function setStatus(text, state) {
            elements.statusText.textContent = text;
            elements.statusIndicator.className = 'status-indicator';
            if (state === 'valid') elements.statusIndicator.classList.add('valid');
            if (state === 'invalid') elements.statusIndicator.classList.add('invalid');
        }

        // Update stats
        function updateStats() {
            const text = elements.input.value;
            elements.charCount.textContent = text.length;
            elements.lineCount.textContent = text.split('\n').length;
            elements.sizeCount.textContent = formatBytes(new Blob([text]).size);
        }

        // Show stats
        function showStats() {
            if (!state.jsonData) {
                elements.statsContainer.innerHTML = '';
                return;
            }

            const stats = analyzeJSON(state.jsonData);
            elements.statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.objects}</div>
                        <div class="stat-label">Objects</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.arrays}</div>
                        <div class="stat-label">Arrays</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.keys}</div>
                        <div class="stat-label">Keys</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.depth}</div>
                        <div class="stat-label">Max Depth</div>
                    </div>
                </div>
            `;
        }

        // Analyze JSON structure
        function analyzeJSON(data, depth = 0) {
            const stats = { objects: 0, arrays: 0, keys: 0, depth };

            if (data === null || typeof data !== 'object') return stats;

            if (Array.isArray(data)) {
                stats.arrays = 1;
                data.forEach(item => {
                    const childStats = analyzeJSON(item, depth + 1);
                    stats.objects += childStats.objects;
                    stats.arrays += childStats.arrays;
                    stats.keys += childStats.keys;
                    stats.depth = Math.max(stats.depth, childStats.depth);
                });
            } else {
                stats.objects = 1;
                stats.keys = Object.keys(data).length;
                Object.values(data).forEach(value => {
                    const childStats = analyzeJSON(value, depth + 1);
                    stats.objects += childStats.objects;
                    stats.arrays += childStats.arrays;
                    stats.keys += childStats.keys;
                    stats.depth = Math.max(stats.depth, childStats.depth);
                });
            }

            return stats;
        }

        // Search functionality
        function handleSearch() {
            const query = elements.searchInput.value.toLowerCase();
            if (!query) {
                renderOutput();
                return;
            }

            if (!state.jsonData) return;

            // Re-render with highlights
            renderOutput();
            highlightSearch(query);
        }

        // Highlight search results
        function highlightSearch(query) {
            const walker = document.createTreeWalker(
                elements.output,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                if (node.nodeValue.toLowerCase().includes(query)) {
                    textNodes.push(node);
                }
            }

            textNodes.forEach(textNode => {
                const span = document.createElement('span');
                span.innerHTML = textNode.nodeValue.replace(
                    new RegExp(`(${query})`, 'gi'),
                    '<span class="highlight">$1</span>'
                );
                textNode.parentNode.replaceChild(span, textNode);
            });
        }

        // Clear search
        function clearSearch() {
            elements.searchInput.value = '';
            handleSearch();
        }

        // Theme toggle
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('jsonFormatter_theme', state.theme);
            applyTheme();
        }

        // Apply theme
        function applyTheme() {
            if (state.theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                elements.themeIcon.textContent = '☀️';
            } else {
                document.documentElement.removeAttribute('data-theme');
                elements.themeIcon.textContent = '🌙';
            }
        }

        // Examples menu
        function renderExamplesMenu() {
            examples.forEach(example => {
                const item = document.createElement('div');
                item.className = 'example-item';
                item.innerHTML = `
                    <div class="example-title">${example.title}</div>
                    <div class="example-desc">${example.description}</div>
                `;
                item.onclick = () => loadExample(example.json);
                elements.examplesMenu.appendChild(item);
            });
        }

        // Toggle examples menu
        function toggleExamplesMenu() {
            elements.examplesMenu.classList.toggle('show');
        }

        // Load example
        function loadExample(json) {
            elements.input.value = JSON.stringify(json, null, 2);
            handleInput();
            elements.examplesMenu.classList.remove('show');
        }

        // History management
        function saveToHistory(json) {
            const entry = {
                json,
                timestamp: new Date().toISOString(),
                preview: json.substring(0, 100)
            };

            state.history.unshift(entry);
            if (state.history.length > 20) state.history.pop();

            localStorage.setItem('jsonFormatter_history', JSON.stringify(state.history));
        }

        // Toggle history panel
        function toggleHistory() {
            elements.historyPanel.classList.toggle('show');
            if (elements.historyPanel.classList.contains('show')) {
                renderHistory();
            }
        }

        // Render history
        function renderHistory() {
            if (state.history.length === 0) {
                elements.historyContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No history yet</p>';
                return;
            }

            elements.historyContent.innerHTML = state.history.map((entry, index) => `
                <div class="history-item" onclick="loadFromHistory(${index})">
                    <div class="history-time">${new Date(entry.timestamp).toLocaleString()}</div>
                    <div class="history-preview">${entry.preview}...</div>
                </div>
            `).join('');
        }

        // Load from history
        function loadFromHistory(index) {
            const entry = state.history[index];
            elements.input.value = entry.json;
            handleInput();
            toggleHistory();
        }
        window.loadFromHistory = loadFromHistory;

        // Keyboard shortcuts
        function handleKeyboard(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'b') {
                    e.preventDefault();
                    beautify();
                } else if (e.key === 'm') {
                    e.preventDefault();
                    minify();
                } else if (e.key === 'k') {
                    e.preventDefault();
                    clear();
                } else if (e.key === 't') {
                    e.preventDefault();
                    toggleTheme();
                }
            }
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Start the app
        init();
    </script>
</body>
</html>