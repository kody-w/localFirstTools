<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Dynamics Simulator</title>
    <meta name="description" content="Real-time fluid dynamics simulation with interactive particle physics, viscosity control, gravity, color mixing, and visual effects">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            height: 100vh;
            overflow: hidden;
            color: #e0e0e0;
        }
        #app { display: flex; height: 100vh; }
        #sidebar {
            width: 300px;
            background: rgba(20, 20, 40, 0.95);
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #667eea;
        }
        h1 { font-size: 18px; color: #667eea; margin-bottom: 20px; }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .section h3 {
            font-size: 12px;
            color: #667eea;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 11px;
            color: #aaa;
        }
        input[type="range"] {
            width: 100%;
            margin-bottom: 15px;
        }
        input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        select {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #667eea;
            color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 8px;
            font-weight: bold;
        }
        button:hover { background: #7789f0; }
        .value-display {
            float: right;
            color: #667eea;
            font-weight: bold;
        }
        #main { flex: 1; display: flex; flex-direction: column; }
        #header {
            background: rgba(20, 20, 40, 0.95);
            padding: 15px 20px;
            border-bottom: 2px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .preset-btn {
            padding: 10px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid #667eea;
            color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 8px;
            text-align: center;
            font-size: 12px;
        }
        .preset-btn:hover { background: rgba(102, 126, 234, 0.4); }
        #stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 40, 0.9);
            padding: 15px;
            border-radius: 8px;
            font-size: 11px;
            border: 1px solid #667eea;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            gap: 15px;
        }
        .stat-value { color: #667eea; font-weight: bold; }
        .info-text {
            font-size: 11px;
            color: #aaa;
            line-height: 1.5;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sidebar">
            <h1>üíß Fluid Dynamics</h1>

            <div class="section">
                <h3>Brush Settings</h3>
                <label>Brush Size <span class="value-display" id="sizeVal">30</span></label>
                <input type="range" id="brushSize" min="5" max="100" value="30">

                <label>Force <span class="value-display" id="forceVal">50</span></label>
                <input type="range" id="force" min="1" max="100" value="50">

                <label>Fluid Color</label>
                <input type="color" id="fluidColor" value="#667eea">
            </div>

            <div class="section">
                <h3>Physics Parameters</h3>
                <label>Viscosity <span class="value-display" id="viscosityVal">0.5</span></label>
                <input type="range" id="viscosity" min="0.1" max="2" step="0.1" value="0.5">

                <label>Gravity <span class="value-display" id="gravityVal">0</span></label>
                <input type="range" id="gravity" min="0" max="2" step="0.1" value="0">

                <label>Diffusion <span class="value-display" id="diffusionVal">0.8</span></label>
                <input type="range" id="diffusion" min="0" max="1" step="0.1" value="0.8">

                <label>Pressure <span class="value-display" id="pressureVal">1</span></label>
                <input type="range" id="pressure" min="0.1" max="2" step="0.1" value="1">
            </div>

            <div class="section">
                <h3>Rendering</h3>
                <label>Particle Count <span class="value-display" id="particleVal">5000</span></label>
                <input type="range" id="particleCount" min="1000" max="20000" step="1000" value="5000">

                <label>Trail Length <span class="value-display" id="trailVal">10</span></label>
                <input type="range" id="trailLength" min="0" max="50" value="10">

                <label>Render Mode</label>
                <select id="renderMode">
                    <option value="particles">Particles</option>
                    <option value="fluid">Fluid Field</option>
                    <option value="velocity">Velocity Vectors</option>
                    <option value="pressure">Pressure Map</option>
                </select>
            </div>

            <div class="section">
                <h3>Presets</h3>
                <div class="preset-btn" onclick="loadPreset('smoke')">üí® Smoke</div>
                <div class="preset-btn" onclick="loadPreset('water')">üåä Water</div>
                <div class="preset-btn" onclick="loadPreset('ink')">üñãÔ∏è Ink Drop</div>
                <div class="preset-btn" onclick="loadPreset('fire')">üî• Fire</div>
                <div class="preset-btn" onclick="loadPreset('galaxy')">üåå Galaxy</div>
            </div>

            <div class="section">
                <h3>Actions</h3>
                <button onclick="togglePause()">‚èØÔ∏è Pause/Resume</button>
                <button onclick="clearSimulation()">üóëÔ∏è Clear</button>
                <button onclick="exportFrame()">üì∏ Export Frame</button>
            </div>

            <div class="info-text">
                Click and drag to add fluid. The simulation uses particle-based fluid dynamics with real-time physics.
            </div>
        </div>

        <div id="main">
            <div id="header">
                <h2 style="color: #667eea;">Fluid Dynamics Simulator</h2>
                <div style="font-size: 12px; color: #aaa;">
                    Click and drag to interact
                </div>
            </div>

            <div id="canvas-container">
                <canvas id="canvas"></canvas>
                <div id="stats">
                    <div class="stat-row">
                        <span>Particles:</span>
                        <span class="stat-value" id="particlesActive">0</span>
                    </div>
                    <div class="stat-row">
                        <span>FPS:</span>
                        <span class="stat-value" id="fps">60</span>
                    </div>
                    <div class="stat-row">
                        <span>Simulation:</span>
                        <span class="stat-value" id="simStatus">Running</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let particles = [];
        let velocityField = [];
        let pressureField = [];
        let mouseX = 0, mouseY = 0;
        let prevMouseX = 0, prevMouseY = 0;
        let isMouseDown = false;
        let isPaused = false;
        let frameCount = 0;
        let lastTime = Date.now();

        // Simulation parameters
        let params = {
            brushSize: 30,
            force: 50,
            viscosity: 0.5,
            gravity: 0,
            diffusion: 0.8,
            pressure: 1,
            particleCount: 5000,
            trailLength: 10,
            renderMode: 'particles',
            fluidColor: '#667eea'
        };

        class Particle {
            constructor(x, y, vx, vy, color) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.life = 1.0;
                this.color = color;
                this.trail = [];
            }

            update(dt) {
                // Apply velocity
                this.x += this.vx * dt;
                this.y += this.vy * dt;

                // Apply gravity
                this.vy += params.gravity * dt * 100;

                // Apply viscosity (friction)
                this.vx *= (1 - params.viscosity * dt);
                this.vy *= (1 - params.viscosity * dt);

                // Boundaries with bounce
                if (this.x < 0) {
                    this.x = 0;
                    this.vx *= -0.5;
                }
                if (this.x > width) {
                    this.x = width;
                    this.vx *= -0.5;
                }
                if (this.y < 0) {
                    this.y = 0;
                    this.vy *= -0.5;
                }
                if (this.y > height) {
                    this.y = height;
                    this.vy *= -0.5;
                }

                // Update trail
                if (params.trailLength > 0) {
                    this.trail.push({ x: this.x, y: this.y });
                    if (this.trail.length > params.trailLength) {
                        this.trail.shift();
                    }
                }

                // Decay life
                this.life -= dt * 0.1;
            }

            draw() {
                if (params.renderMode === 'particles') {
                    ctx.globalAlpha = this.life * 0.6;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw trail
                    if (this.trail.length > 1) {
                        ctx.strokeStyle = this.color;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(this.trail[0].x, this.trail[0].y);
                        for (let i = 1; i < this.trail.length; i++) {
                            ctx.lineTo(this.trail[i].x, this.trail[i].y);
                        }
                        ctx.stroke();
                    }
                }
            }
        }

        function resizeCanvas() {
            width = canvas.parentElement.clientWidth;
            height = canvas.parentElement.clientHeight;
            canvas.width = width;
            canvas.height = height;
            initializeFields();
        }

        function initializeFields() {
            const gridW = Math.floor(width / 10);
            const gridH = Math.floor(height / 10);
            velocityField = Array(gridH).fill().map(() =>
                Array(gridW).fill().map(() => ({ vx: 0, vy: 0 }))
            );
            pressureField = Array(gridH).fill().map(() => Array(gridW).fill(0));
        }

        function addFluid(x, y, vx, vy) {
            const color = params.fluidColor;
            const count = Math.floor(params.brushSize / 5);

            for (let i = 0; i < count && particles.length < params.particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * params.brushSize;
                const px = x + Math.cos(angle) * radius;
                const py = y + Math.sin(angle) * radius;

                particles.push(new Particle(
                    px, py,
                    vx * params.force * 0.5 + (Math.random() - 0.5) * 50,
                    vy * params.force * 0.5 + (Math.random() - 0.5) * 50,
                    color
                ));
            }
        }

        function updateParticles(dt) {
            // Update particles
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update(dt);

                // Remove dead particles
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }

            // Apply diffusion - particles influence each other
            if (params.diffusion > 0) {
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = particles[j].x - particles[i].x;
                        const dy = particles[j].y - particles[i].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < 20 && dist > 0) {
                            const force = (20 - dist) * params.diffusion * 0.01;
                            const fx = (dx / dist) * force;
                            const fy = (dy / dist) * force;

                            particles[i].vx -= fx;
                            particles[i].vy -= fy;
                            particles[j].vx += fx;
                            particles[j].vy += fy;
                        }
                    }
                }
            }
        }

        function render() {
            // Fade effect for trails
            ctx.fillStyle = 'rgba(15, 12, 41, 0.1)';
            ctx.fillRect(0, 0, width, height);

            if (params.renderMode === 'particles') {
                particles.forEach(p => p.draw());
            } else if (params.renderMode === 'fluid') {
                renderFluidField();
            } else if (params.renderMode === 'velocity') {
                renderVelocityField();
            } else if (params.renderMode === 'pressure') {
                renderPressureMap();
            }

            ctx.globalAlpha = 1;
        }

        function renderFluidField() {
            const gridSize = 20;
            for (let y = 0; y < height; y += gridSize) {
                for (let x = 0; x < width; x += gridSize) {
                    const count = particles.filter(p =>
                        p.x >= x && p.x < x + gridSize &&
                        p.y >= y && p.y < y + gridSize
                    ).length;

                    if (count > 0) {
                        const alpha = Math.min(count / 10, 1);
                        ctx.fillStyle = `rgba(102, 126, 234, ${alpha})`;
                        ctx.fillRect(x, y, gridSize, gridSize);
                    }
                }
            }
        }

        function renderVelocityField() {
            particles.forEach(p => {
                const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
                if (speed > 5) {
                    ctx.strokeStyle = `rgba(102, 126, 234, ${Math.min(speed / 100, 1)})`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + p.vx * 0.2, p.y + p.vy * 0.2);
                    ctx.stroke();
                }
            });
        }

        function renderPressureMap() {
            const gridSize = 20;
            for (let y = 0; y < height; y += gridSize) {
                for (let x = 0; x < width; x += gridSize) {
                    const count = particles.filter(p =>
                        p.x >= x && p.x < x + gridSize &&
                        p.y >= y && p.y < y + gridSize
                    ).length;

                    const pressure = count * params.pressure * 10;
                    const hue = Math.min(pressure, 240);
                    ctx.fillStyle = `hsla(${240 - hue}, 100%, 50%, 0.5)`;
                    ctx.fillRect(x, y, gridSize, gridSize);
                }
            }
        }

        function animate() {
            if (!isPaused) {
                const now = Date.now();
                const dt = Math.min((now - lastTime) / 1000, 0.033); // Cap at 30fps
                lastTime = now;

                updateParticles(dt);
                render();

                // Update FPS
                if (frameCount % 10 === 0) {
                    const fps = Math.round(1 / dt);
                    document.getElementById('fps').textContent = fps;
                }
                frameCount++;
            }

            document.getElementById('particlesActive').textContent = particles.length;
            requestAnimationFrame(animate);
        }

        function loadPreset(name) {
            const presets = {
                smoke: {
                    viscosity: 1.5,
                    gravity: -0.3,
                    diffusion: 0.9,
                    trailLength: 30,
                    fluidColor: '#aaaaaa',
                    force: 30
                },
                water: {
                    viscosity: 0.3,
                    gravity: 1.5,
                    diffusion: 0.5,
                    trailLength: 5,
                    fluidColor: '#4fc3f7',
                    force: 60
                },
                ink: {
                    viscosity: 0.8,
                    gravity: 0,
                    diffusion: 0.95,
                    trailLength: 40,
                    fluidColor: '#667eea',
                    force: 40
                },
                fire: {
                    viscosity: 0.2,
                    gravity: -1,
                    diffusion: 0.7,
                    trailLength: 20,
                    fluidColor: '#ff6b6b',
                    force: 50
                },
                galaxy: {
                    viscosity: 0.1,
                    gravity: 0,
                    diffusion: 0.3,
                    trailLength: 50,
                    fluidColor: '#8a2be2',
                    force: 70
                }
            };

            const preset = presets[name];
            if (preset) {
                Object.assign(params, preset);
                document.getElementById('viscosity').value = preset.viscosity;
                document.getElementById('gravity').value = preset.gravity;
                document.getElementById('diffusion').value = preset.diffusion;
                document.getElementById('trailLength').value = preset.trailLength;
                document.getElementById('fluidColor').value = preset.fluidColor;
                document.getElementById('force').value = preset.force;
                updateAllDisplays();
            }
        }

        function updateAllDisplays() {
            document.getElementById('sizeVal').textContent = params.brushSize;
            document.getElementById('forceVal').textContent = params.force;
            document.getElementById('viscosityVal').textContent = params.viscosity.toFixed(1);
            document.getElementById('gravityVal').textContent = params.gravity.toFixed(1);
            document.getElementById('diffusionVal').textContent = params.diffusion.toFixed(1);
            document.getElementById('pressureVal').textContent = params.pressure.toFixed(1);
            document.getElementById('particleVal').textContent = params.particleCount;
            document.getElementById('trailVal').textContent = params.trailLength;
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('simStatus').textContent = isPaused ? 'Paused' : 'Running';
        }

        function clearSimulation() {
            particles = [];
            ctx.fillStyle = 'rgba(15, 12, 41, 1)';
            ctx.fillRect(0, 0, width, height);
        }

        function exportFrame() {
            const link = document.createElement('a');
            link.download = `fluid-sim-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // Event listeners
        canvas.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            prevMouseX = mouseX;
            prevMouseY = mouseY;
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            prevMouseX = mouseX;
            prevMouseY = mouseY;
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;

            if (isMouseDown) {
                const vx = mouseX - prevMouseX;
                const vy = mouseY - prevMouseY;
                addFluid(mouseX, mouseY, vx, vy);
            }
        });

        canvas.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isMouseDown = false;
        });

        // Touch support
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isMouseDown = true;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            mouseX = touch.clientX - rect.left;
            mouseY = touch.clientY - rect.top;
            prevMouseX = mouseX;
            prevMouseY = mouseY;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            prevMouseX = mouseX;
            prevMouseY = mouseY;
            mouseX = touch.clientX - rect.left;
            mouseY = touch.clientY - rect.top;

            if (isMouseDown) {
                const vx = mouseX - prevMouseX;
                const vy = mouseY - prevMouseY;
                addFluid(mouseX, mouseY, vx, vy);
            }
        });

        canvas.addEventListener('touchend', () => {
            isMouseDown = false;
        });

        // Parameter controls
        ['brushSize', 'force', 'viscosity', 'gravity', 'diffusion', 'pressure', 'particleCount', 'trailLength'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                params[id] = parseFloat(e.target.value);
                updateAllDisplays();
            });
        });

        document.getElementById('renderMode').addEventListener('change', (e) => {
            params.renderMode = e.target.value;
        });

        document.getElementById('fluidColor').addEventListener('change', (e) => {
            params.fluidColor = e.target.value;
        });

        window.addEventListener('resize', resizeCanvas);

        // Initialize
        resizeCanvas();
        updateAllDisplays();
        animate();
    </script>
</body>
</html>