name: Build Chrome Extension

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'data/**'
      - 'chrome-extension/**'
      - 'index.html'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“Š Run Meta Analysis
        run: |
          python3 scripts/meta-analyzer.py
          echo "âœ… Meta analysis complete"

      - name: ðŸ—ï¸ Build Chrome Extension
        run: |
          chmod +x scripts/build-chrome-extension.sh
          ./scripts/build-chrome-extension.sh
          echo "âœ… Extension built successfully"

      - name: ðŸ“¦ Create ZIP Archive
        run: |
          cd chrome-extension-build
          zip -r ../local-first-tools-extension.zip .
          cd ..
          echo "âœ… ZIP created"
          ls -lh local-first-tools-extension.zip

      - name: ðŸ“ˆ Generate Build Report
        id: build_report
        run: |
          APP_COUNT=$(find chrome-extension-build/apps -name "*.html" | wc -l)
          ZIP_SIZE=$(ls -lh local-first-tools-extension.zip | awk '{print $5}')
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          echo "app_count=$APP_COUNT" >> $GITHUB_OUTPUT
          echo "zip_size=$ZIP_SIZE" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

          cat > build-report.md << EOF
          ## ðŸš€ Chrome Extension Build Report

          **Build Date:** $BUILD_DATE
          **Applications:** $APP_COUNT
          **Package Size:** $ZIP_SIZE
          **Commit:** \`${GITHUB_SHA:0:7}\`

          ### âœ… Build Successful

          The extension has been built and packaged successfully.

          ### ðŸ“¦ Artifact Details
          - File: \`local-first-tools-extension.zip\`
          - Format: Chrome Extension (Manifest V3)
          - Installation: Unpacked extension

          ### ðŸ”— Quick Links
          - [Download Page](https://github.com/${{ github.repository }}/blob/main/extension-download.html)
          - [Installation Guide](https://github.com/${{ github.repository }}#installation)
          EOF

          cat build-report.md

      - name: ðŸ“¤ Upload Extension Artifact
        uses: actions/upload-artifact@v3
        with:
          name: local-first-tools-extension
          path: local-first-tools-extension.zip
          retention-days: 90

      - name: ðŸ“¤ Upload Build Report
        uses: actions/upload-artifact@v3
        with:
          name: build-report
          path: build-report.md
          retention-days: 30

      - name: ðŸ’¾ Commit Built Files
        if: github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add generated files
          git add data/meta-analysis.json
          git add local-first-tools-extension.zip

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update meta-analysis and extension build

          - Apps analyzed: ${{ steps.build_report.outputs.app_count }}
          - Package size: ${{ steps.build_report.outputs.zip_size }}
          - Build date: ${{ steps.build_report.outputs.build_date }}

          ðŸ¤– Auto-generated by GitHub Actions"

            git push
            echo "âœ… Changes committed and pushed"
          fi

      - name: ðŸŽ‰ Create GitHub Release
        if: github.event.inputs.create_release == 'true' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[release]'))
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Local First Tools Extension v1.0.${{ github.run_number }}
          body_path: build-report.md
          files: |
            local-first-tools-extension.zip
            data/meta-analysis.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Summary
        run: |
          echo "### ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Applications Packaged:** ${{ steps.build_report.outputs.app_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package Size:** ${{ steps.build_report.outputs.zip_size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** ${{ steps.build_report.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifact" >> $GITHUB_STEP_SUMMARY
          echo "The extension ZIP is available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Download" >> $GITHUB_STEP_SUMMARY
          echo "[Extension Download Page](https://github.com/${{ github.repository }}/blob/main/extension-download.html)" >> $GITHUB_STEP_SUMMARY
