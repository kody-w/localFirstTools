<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVIATHAN: MULTIVERSE CLIENT</title>
    <style>
        :root {
            --bg-color: #050510;
            --text-color: #00ffff;
            --accent-color: #bf00ff;
            --panel-bg: rgba(10, 20, 30, 0.8);
            --border-color: #00ffff;
        }
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 10px 20px;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--text-color);
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        button {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        button:hover {
            background: var(--text-color);
            color: #000;
            box-shadow: 0 0 15px var(--text-color);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #555;
            color: #555;
            box-shadow: none;
            background: transparent;
        }
        #multiverse-container {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            overflow: auto;
            align-content: flex-start;
        }
        .reality-frame {
            position: relative;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            transition: all 0.3s;
            min-width: 300px;
            min-height: 200px;
            flex: 1 1 400px; /* Grow and shrink, base 400px */
            height: calc(50vh - 20px); /* Default to half height */
            display: flex;
            flex-direction: column;
        }
        .reality-header {
            background: linear-gradient(90deg, #2a0033, #000);
            padding: 5px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--accent-color);
        }
        .reality-id {
            color: var(--accent-color);
            font-weight: bold;
        }
        .reality-controls button {
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 5px;
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .reality-controls button:hover {
            background: var(--accent-color);
            color: #fff;
        }
        iframe {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            font-size: 14px;
            z-index: 10;
        }
        .status-bar {
            padding: 5px 20px;
            font-size: 11px;
            color: #888;
            border-top: 1px solid #333;
            background: #000;
        }
    </style>
</head>
<body>
    <header>
        <h1>LEVIATHAN: MULTIVERSE CLIENT</h1>
        <div class="controls">
            <button id="add-reality-btn" onclick="showVersionSelector()">Initialize Reality (+)</button>
            <button onclick="addReality('apps/games/leviv4-client.html', 'NESTED MULTIVERSE')" style="border-color: #00ff88; color: #00ff88;">Spawn Nested Client</button>
            <button onclick="resetMultiverse()" style="border-color: #ff4444; color: #ff4444;">Collapse All</button>
        </div>
    </header>

    <div id="multiverse-container">
        <!-- Realities will be injected here -->
    </div>

    <div class="status-bar" id="status-bar">
        System Ready. 0/5 Realities Active.
    </div>

    <!-- Version Selector Modal -->
    <div id="version-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center;">
        <div style="background: #111; border: 2px solid var(--accent-color); padding: 20px; width: 500px; max-height: 80vh; display: flex; flex-direction: column; border-radius: 10px;">
            <h2 style="margin-top: 0; color: var(--accent-color);">Select Reality Version</h2>
            <input type="text" id="version-search" placeholder="Search versions..." style="background: #222; border: 1px solid #444; color: #fff; padding: 8px; margin-bottom: 10px; width: 100%; box-sizing: border-box;">
            <div id="version-list" style="flex: 1; overflow-y: auto; border: 1px solid #333; margin-bottom: 10px;">
                <!-- Versions injected here -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeVersionModal()" style="border-color: #888; color: #888;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_REALITIES = 5;
        let realityCount = 0;
        let manifest = null;
        
        // Configuration
        const MANIFEST_URL = '../../vibe_gallery_config.json';
        const GITHUB_BASE = 'https://raw.githubusercontent.com/kody-w/localFirstTools/main/';

        async function loadManifest() {
            if (manifest) return manifest;
            try {
                const response = await fetch(MANIFEST_URL);
                const data = await response.json();
                
                // Flatten categories into a single list of apps
                let apps = [];
                if (data.vibeGallery && data.vibeGallery.categories) {
                    Object.values(data.vibeGallery.categories).forEach(cat => {
                        if (cat.apps) apps = apps.concat(cat.apps);
                    });
                }
                
                // Filter for Leviathan versions (and others if needed)
                // We look for 'levi' in filename or title
                manifest = apps.filter(app => 
                    (app.filename && app.filename.toLowerCase().includes('levi')) || 
                    (app.title && app.title.toLowerCase().includes('leviathan'))
                ).sort((a, b) => a.title.localeCompare(b.title));
                
                return manifest;
            } catch (e) {
                console.error('Failed to load manifest:', e);
                return [];
            }
        }

        async function showVersionSelector() {
            if (realityCount >= MAX_REALITIES) {
                alert('Multiverse stability limit reached (5/5). Collapse a reality to create a new one.');
                return;
            }

            const versions = await loadManifest();
            const list = document.getElementById('version-list');
            list.innerHTML = '';

            if (versions.length === 0) {
                list.innerHTML = '<div style="padding: 10px; color: #f00;">No versions found in manifest.</div>';
            } else {
                versions.forEach(app => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 8px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                    item.innerHTML = `
                        <div>
                            <div style="font-weight: bold; color: #fff;">${app.title || app.filename}</div>
                            <div style="font-size: 10px; color: #888;">${app.filename}</div>
                        </div>
                        <button style="font-size: 10px; padding: 4px 8px;" onclick="selectVersion('${app.path}', '${app.filename}')">SELECT</button>
                    `;
                    item.onmouseover = () => item.style.background = '#222';
                    item.onmouseout = () => item.style.background = 'transparent';
                    item.onclick = (e) => {
                        if (e.target.tagName !== 'BUTTON') selectVersion(app.path, app.filename);
                    };
                    list.appendChild(item);
                });
            }

            // Search functionality
            const search = document.getElementById('version-search');
            search.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                Array.from(list.children).forEach(child => {
                    const text = child.innerText.toLowerCase();
                    child.style.display = text.includes(term) ? 'flex' : 'none';
                });
            };

            document.getElementById('version-modal').style.display = 'flex';
        }

        function closeVersionModal() {
            document.getElementById('version-modal').style.display = 'none';
        }

        function selectVersion(path, filename) {
            closeVersionModal();
            addReality(path, filename);
        }

        async function fetchGameCode(path) {
            const status = document.getElementById('status-bar');
            status.textContent = `Fetching quantum data for ${path}...`;

            // Determine local path (relative to this file)
            // This file is in apps/games/
            // Paths in manifest are like "apps/games/leviv4.html" or just "leviv4.html"
            // We need to handle both.
            
            let localUrl = path;
            if (path.startsWith('apps/games/')) {
                localUrl = path.replace('apps/games/', '');
            } else if (path.startsWith('/')) {
                localUrl = '../..' + path; // Go up to root then path
            } else {
                // Assume it's in the same directory if no prefix, or try to find it
                // If it's just "leviv4.html", it works.
            }

            try {
                // Try Local first (Local First philosophy!)
                console.log(`Fetching local: ${localUrl}`);
                let response = await fetch(localUrl);
                if (response.ok) {
                    const code = await response.text();
                    status.textContent = 'Quantum data loaded from local source.';
                    return code;
                }
                throw new Error('Local fetch failed');
            } catch (e) {
                console.warn('Local fetch failed, trying GitHub...', e);
                try {
                    // Fallback to GitHub
                    const githubUrl = GITHUB_BASE + path;
                    console.log(`Fetching GitHub: ${githubUrl}`);
                    let response = await fetch(githubUrl);
                    if (!response.ok) throw new Error('GitHub fetch failed');
                    const code = await response.text();
                    status.textContent = 'Quantum data loaded from GitHub source.';
                    return code;
                } catch (err) {
                    console.error('All fetch attempts failed', err);
                    status.textContent = 'CRITICAL ERROR: Could not load game code.';
                    alert(`Failed to load game code for ${path}. Check console.`);
                    return null;
                }
            }
        }

        async function addReality(path = 'apps/games/leviv4.html', filename = 'leviv4.html') {
            if (realityCount >= MAX_REALITIES) {
                alert('Multiverse stability limit reached (5/5). Collapse a reality to create a new one.');
                return;
            }

            const btn = document.getElementById('add-reality-btn');
            btn.disabled = true;

            const code = await fetchGameCode(path);
            if (!code) {
                btn.disabled = false;
                return;
            }

            realityCount++;
            updateStatus();

            const container = document.getElementById('multiverse-container');
            const id = 'reality-' + Date.now();
            
            const frame = document.createElement('div');
            frame.className = 'reality-frame';
            frame.id = id;
            frame.dataset.path = path; // Store path for reload
            frame.innerHTML = `
                <div class="reality-header">
                    <span class="reality-id">REALITY #${realityCount} [${filename}]</span>
                    <div class="reality-controls">
                        <button onclick="reloadReality('${id}')">↻</button>
                        <button onclick="closeReality('${id}')">✕</button>
                    </div>
                </div>
                <div class="loading-overlay">Initializing Universe...</div>
                <iframe sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-popups allow-modals" allow="gamepad; fullscreen; accelerometer; gyroscope; payment; midi; clipboard-read; clipboard-write"></iframe>
            `;

            container.appendChild(frame);

            // Inject <base> tag to fix relative paths in Blob URL
            // This ensures fetch calls like '../../vibe_gallery_config.json' work relative to the original file location
            // v2: Use document.baseURI to handle nested recursion correctly
            const currentBase = document.baseURI;
            const baseUrl = new URL(path, currentBase).href;
            
            // HACK: Inject a script to patch fetch/XHR in the nested environment if needed
            // and ensure it can spawn its own children by propagating the base URI
            const hackScript = `
                <script>
                    // Recursive Base URI Hack
                    // Ensure this nested reality knows its true origin for further fetching
                    if (!document.querySelector('base')) {
                        const base = document.createElement('base');
                        base.href = "${baseUrl}";
                        document.head.appendChild(base);
                    }
                    console.log('[MULTIVERSE] Reality initialized with base:', "${baseUrl}");
                <\/script>
            `;

            let codeWithBase = code;
            if (code.includes('<head>')) {
                codeWithBase = code.replace('<head>', `<head><base href="${baseUrl}">${hackScript}`);
            } else {
                codeWithBase = `${hackScript}${code}`;
            }

            const blob = new Blob([codeWithBase], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const iframe = frame.querySelector('iframe');
            iframe.onload = () => {
                const loader = frame.querySelector('.loading-overlay');
                if (loader) loader.style.display = 'none';
                URL.revokeObjectURL(url);
            };
            iframe.src = url;

            btn.disabled = false;
        }

        function closeReality(id) {
            const frame = document.getElementById(id);
            if (frame) {
                frame.remove();
                realityCount--;
                updateStatus();
            }
        }

        async function reloadReality(id) {
            const frame = document.getElementById(id);
            if (frame) {
                const path = frame.dataset.path;
                const iframe = frame.querySelector('iframe');
                const loader = frame.querySelector('.loading-overlay');
                loader.style.display = 'flex';
                
                const code = await fetchGameCode(path);
                if (code) {
                    const blob = new Blob([code], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    iframe.src = url;
                    iframe.onload = () => {
                        loader.style.display = 'none';
                        URL.revokeObjectURL(url);
                    };
                } else {
                    loader.textContent = "Reload Failed";
                }
            }
        }

        function resetMultiverse() {
            const container = document.getElementById('multiverse-container');
            container.innerHTML = '';
            realityCount = 0;
            updateStatus();
        }

        function updateStatus() {
            const status = document.getElementById('status-bar');
            status.textContent = `Multiverse Stability: ${realityCount}/${MAX_REALITIES} Realities Active.`;
        }

        // Auto-initialize default reality
        window.onload = () => {
            setTimeout(() => addReality('apps/games/leviv4.html', 'leviv4.html'), 500);
        };
    </script>
</body>
</html>