<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Tag Arena - Multiplayer Chase Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .main-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .start-screen, .host-screen, .game-screen {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .qr-container {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 15px;
            display: inline-block;
        }

        .qr-container img {
            display: block;
            max-width: 300px;
            height: auto;
        }

        .session-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            word-break: break-all;
        }

        .game-canvas-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        #gameCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .player-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-tag.it {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .player-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-message {
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0;
            padding: 10px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .status-message.tagged {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: flash 0.5s;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .share-link {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .share-link:hover {
            background: rgba(255, 255, 255, 1);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .start-screen, .host-screen, .game-screen {
                padding: 20px;
            }

            button {
                padding: 12px 30px;
                font-size: 1em;
            }

            .button-group {
                flex-direction: column;
            }

            .qr-container img {
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>QR Tag Arena</h1>
        <p>Scan the code, join the chase, don't get tagged!</p>
    </div>

    <div class="main-container">
        <!-- Start Screen -->
        <div id="startScreen" class="start-screen">
            <h2>Welcome to QR Tag Arena!</h2>
            <p style="margin: 20px 0;">A multiplayer chase game where one player is "it" and tries to tag others. Use your keyboard or touch to move around the arena.</p>
            <div class="button-group">
                <button onclick="hostGame()">Host Game</button>
                <button class="secondary" onclick="showJoinOptions()">Join Game</button>
            </div>
        </div>

        <!-- Host Screen -->
        <div id="hostScreen" class="host-screen hidden">
            <h2>Game Hosted!</h2>
            <p>Share this QR code for others to join:</p>
            <div class="qr-container">
                <img id="qrCode" alt="QR Code">
            </div>
            <div class="share-link" id="shareLink" onclick="copyLink()">
                Click to copy link
            </div>
            <div class="session-info">
                <strong>Session ID:</strong> <span id="sessionId"></span>
            </div>
            <div class="player-list" id="lobbyPlayers"></div>
            <button onclick="startGame()">Start Game</button>
            <button class="secondary" onclick="cancelHost()">Cancel</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="game-screen hidden">
            <div class="status-message" id="statusMessage">Get ready!</div>
            <div class="player-list" id="gamePlayers"></div>
            <div class="game-canvas-container">
                <canvas id="gameCanvas" width="600" height="400"></canvas>
            </div>
            <div class="controls">
                Use Arrow Keys or WASD to move | Touch screen to move on mobile
            </div>
            <button class="secondary" onclick="leaveGame()">Leave Game</button>
        </div>
    </div>

    <!-- PeerJS Library -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

    <script>
        const APP_NAME = 'qr-tag-arena';

        // Game State
        let peer = null;
        let connections = [];
        let isHost = false;
        let gameStarted = false;
        let myPlayerId = null;
        let players = {};
        let canvas, ctx;
        let gameLoop = null;

        // Game Settings
        const CANVAS_WIDTH = 600;
        const CANVAS_HEIGHT = 400;
        const PLAYER_SIZE = 20;
        const PLAYER_SPEED = 4;
        const TAG_DISTANCE = 30;

        // Player Colors
        const COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

        // Input State
        let keys = {};
        let touchActive = false;
        let touchTarget = { x: 0, y: 0 };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');

            // Check if joining via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const joinId = urlParams.get('join');
            if (joinId) {
                joinGame(joinId);
            }

            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                    e.preventDefault();
                }
            });

            document.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });

            // Touch controls
            canvas.addEventListener('touchstart', handleTouch, { passive: false });
            canvas.addEventListener('touchmove', handleTouch, { passive: false });
            canvas.addEventListener('touchend', () => { touchActive = false; }, { passive: false });

            // Mouse controls (for mobile)
            canvas.addEventListener('mousedown', handleMouse);
            canvas.addEventListener('mousemove', handleMouse);
            canvas.addEventListener('mouseup', () => { touchActive = false; });
        });

        function handleTouch(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const touch = e.touches[0];

            if (touch) {
                touchActive = true;
                touchTarget.x = (touch.clientX - rect.left) * scaleX;
                touchTarget.y = (touch.clientY - rect.top) * scaleY;
            }
        }

        function handleMouse(e) {
            if (e.buttons === 1) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                touchActive = true;
                touchTarget.x = (e.clientX - rect.left) * scaleX;
                touchTarget.y = (e.clientY - rect.top) * scaleY;
            }
        }

        function hostGame() {
            showScreen('hostScreen');
            document.getElementById('lobbyPlayers').innerHTML = '<div class="loading"><div class="spinner"></div><p>Initializing session...</p></div>';

            // Create peer connection
            peer = new Peer();

            peer.on('open', (id) => {
                myPlayerId = id;
                isHost = true;

                // Generate session URL
                const baseUrl = window.location.origin + window.location.pathname;
                const sessionUrl = `${baseUrl}?join=${id}`;

                // Generate QR code
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(sessionUrl)}`;
                document.getElementById('qrCode').src = qrCodeUrl;
                document.getElementById('sessionId').textContent = id;
                document.getElementById('shareLink').textContent = sessionUrl;
                document.getElementById('shareLink').dataset.url = sessionUrl;

                // Initialize host player
                players[id] = {
                    id: id,
                    name: 'Host',
                    x: CANVAS_WIDTH / 2,
                    y: CANVAS_HEIGHT / 2,
                    color: COLORS[0],
                    isIt: true
                };

                updateLobbyPlayers();
            });

            peer.on('connection', (conn) => {
                setupConnection(conn);
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                alert('Connection error: ' + err.message);
            });
        }

        function showJoinOptions() {
            const joinId = prompt('Enter Session ID:');
            if (joinId) {
                joinGame(joinId);
            }
        }

        function joinGame(hostId) {
            showScreen('hostScreen');
            document.getElementById('lobbyPlayers').innerHTML = '<div class="loading"><div class="spinner"></div><p>Connecting to host...</p></div>';

            // Hide host controls
            document.querySelector('#hostScreen button:first-of-type').style.display = 'none';
            document.getElementById('qrCode').parentElement.style.display = 'none';
            document.getElementById('shareLink').style.display = 'none';

            peer = new Peer();

            peer.on('open', (id) => {
                myPlayerId = id;
                isHost = false;

                document.getElementById('sessionId').textContent = `Joining ${hostId}...`;

                // Connect to host
                const conn = peer.connect(hostId);
                setupConnection(conn);

                conn.on('open', () => {
                    // Send join request
                    conn.send({
                        type: 'join',
                        playerId: id,
                        name: `Player ${Math.floor(Math.random() * 1000)}`
                    });
                });
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                alert('Failed to connect: ' + err.message);
                showScreen('startScreen');
            });
        }

        function setupConnection(conn) {
            connections.push(conn);

            conn.on('data', (data) => {
                handleMessage(data, conn);
            });

            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
                if (players[conn.peer]) {
                    delete players[conn.peer];
                    updateLobbyPlayers();
                    updateGamePlayers();
                    broadcast({ type: 'player-left', playerId: conn.peer });
                }
            });
        }

        function handleMessage(data, conn) {
            switch (data.type) {
                case 'join':
                    if (isHost) {
                        // Add new player
                        const colorIndex = Object.keys(players).length % COLORS.length;
                        players[data.playerId] = {
                            id: data.playerId,
                            name: data.name,
                            x: Math.random() * (CANVAS_WIDTH - 40) + 20,
                            y: Math.random() * (CANVAS_HEIGHT - 40) + 20,
                            color: COLORS[colorIndex],
                            isIt: false
                        };

                        // Send current game state to new player
                        conn.send({
                            type: 'game-state',
                            players: players,
                            gameStarted: gameStarted
                        });

                        // Broadcast new player to others
                        broadcast({ type: 'new-player', player: players[data.playerId] }, conn);

                        updateLobbyPlayers();
                    }
                    break;

                case 'game-state':
                    players = data.players;
                    gameStarted = data.gameStarted;
                    updateLobbyPlayers();
                    if (gameStarted) {
                        showScreen('gameScreen');
                        startGameLoop();
                    }
                    break;

                case 'new-player':
                    players[data.player.id] = data.player;
                    updateLobbyPlayers();
                    updateGamePlayers();
                    break;

                case 'start-game':
                    gameStarted = true;
                    showScreen('gameScreen');
                    startGameLoop();
                    break;

                case 'player-update':
                    if (players[data.playerId]) {
                        players[data.playerId].x = data.x;
                        players[data.playerId].y = data.y;
                    }
                    break;

                case 'tag':
                    handleTag(data.taggerId, data.taggedId);
                    break;

                case 'player-left':
                    delete players[data.playerId];
                    updateLobbyPlayers();
                    updateGamePlayers();
                    break;
            }
        }

        function broadcast(message, except = null) {
            connections.forEach(conn => {
                if (conn !== except && conn.open) {
                    conn.send(message);
                }
            });
        }

        function updateLobbyPlayers() {
            const container = document.getElementById('lobbyPlayers');
            const playerCount = Object.keys(players).length;

            let html = `<div style="width: 100%; margin-bottom: 10px;">Players: ${playerCount}</div>`;

            for (let id in players) {
                const player = players[id];
                html += `
                    <div class="player-tag ${player.isIt ? 'it' : ''}">
                        <span class="player-color" style="background: ${player.color}"></span>
                        ${player.name} ${player.isIt ? '(IT)' : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function updateGamePlayers() {
            const container = document.getElementById('gamePlayers');
            let html = '';

            for (let id in players) {
                const player = players[id];
                html += `
                    <div class="player-tag ${player.isIt ? 'it' : ''}">
                        <span class="player-color" style="background: ${player.color}"></span>
                        ${player.name} ${player.isIt ? '(IT)' : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function startGame() {
            if (Object.keys(players).length < 2) {
                alert('Need at least 2 players to start!');
                return;
            }

            gameStarted = true;
            broadcast({ type: 'start-game' });
            showScreen('gameScreen');
            startGameLoop();
        }

        function startGameLoop() {
            if (gameLoop) return;

            updateGamePlayers();
            gameLoop = setInterval(() => {
                updateGame();
                renderGame();
            }, 1000 / 60);
        }

        function updateGame() {
            if (!players[myPlayerId]) return;

            const player = players[myPlayerId];
            let moved = false;

            // Keyboard movement
            if (keys['arrowup'] || keys['w']) {
                player.y = Math.max(PLAYER_SIZE, player.y - PLAYER_SPEED);
                moved = true;
            }
            if (keys['arrowdown'] || keys['s']) {
                player.y = Math.min(CANVAS_HEIGHT - PLAYER_SIZE, player.y + PLAYER_SPEED);
                moved = true;
            }
            if (keys['arrowleft'] || keys['a']) {
                player.x = Math.max(PLAYER_SIZE, player.x - PLAYER_SPEED);
                moved = true;
            }
            if (keys['arrowright'] || keys['d']) {
                player.x = Math.min(CANVAS_WIDTH - PLAYER_SIZE, player.x + PLAYER_SPEED);
                moved = true;
            }

            // Touch/Mouse movement
            if (touchActive) {
                const dx = touchTarget.x - player.x;
                const dy = touchTarget.y - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > 5) {
                    const moveX = (dx / distance) * PLAYER_SPEED;
                    const moveY = (dy / distance) * PLAYER_SPEED;

                    player.x = Math.max(PLAYER_SIZE, Math.min(CANVAS_WIDTH - PLAYER_SIZE, player.x + moveX));
                    player.y = Math.max(PLAYER_SIZE, Math.min(CANVAS_HEIGHT - PLAYER_SIZE, player.y + moveY));
                    moved = true;
                }
            }

            // Broadcast position if moved
            if (moved) {
                broadcast({
                    type: 'player-update',
                    playerId: myPlayerId,
                    x: player.x,
                    y: player.y
                });
            }

            // Check for tags (only if I'm "it")
            if (player.isIt) {
                for (let id in players) {
                    if (id === myPlayerId) continue;

                    const other = players[id];
                    const dx = player.x - other.x;
                    const dy = player.y - other.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < TAG_DISTANCE) {
                        // Tag!
                        tagPlayer(myPlayerId, id);
                        break;
                    }
                }
            }
        }

        function tagPlayer(taggerId, taggedId) {
            broadcast({
                type: 'tag',
                taggerId: taggerId,
                taggedId: taggedId
            });

            handleTag(taggerId, taggedId);
        }

        function handleTag(taggerId, taggedId) {
            if (players[taggerId]) players[taggerId].isIt = false;
            if (players[taggedId]) players[taggedId].isIt = true;

            updateGamePlayers();

            const statusMsg = document.getElementById('statusMessage');
            if (taggedId === myPlayerId) {
                statusMsg.textContent = "You're IT!";
                statusMsg.className = 'status-message tagged';
            } else if (taggerId === myPlayerId) {
                statusMsg.textContent = `You tagged ${players[taggedId]?.name}!`;
                statusMsg.className = 'status-message';
            } else {
                statusMsg.textContent = `${players[taggedId]?.name} is IT!`;
                statusMsg.className = 'status-message';
            }
        }

        function renderGame() {
            // Clear canvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let x = 0; x < CANVAS_WIDTH; x += 40) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, CANVAS_HEIGHT);
                ctx.stroke();
            }
            for (let y = 0; y < CANVAS_HEIGHT; y += 40) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(CANVAS_WIDTH, y);
                ctx.stroke();
            }

            // Draw players
            for (let id in players) {
                const player = players[id];

                // Draw shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(player.x + 2, player.y + 2, PLAYER_SIZE, 0, Math.PI * 2);
                ctx.fill();

                // Draw player
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, PLAYER_SIZE, 0, Math.PI * 2);
                ctx.fill();

                // Draw "IT" indicator
                if (player.isIt) {
                    ctx.strokeStyle = '#ff4757';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, PLAYER_SIZE + 5, 0, Math.PI * 2);
                    ctx.stroke();

                    // Pulsing effect
                    const pulse = Math.sin(Date.now() / 200) * 3;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, PLAYER_SIZE + 10 + pulse, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // Draw name
                ctx.fillStyle = '#fff';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(player.name, player.x, player.y - PLAYER_SIZE - 5);

                // Highlight my player
                if (id === myPlayerId) {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, PLAYER_SIZE + 8, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
        }

        function copyLink() {
            const link = document.getElementById('shareLink').dataset.url;
            navigator.clipboard.writeText(link).then(() => {
                const linkEl = document.getElementById('shareLink');
                const originalText = linkEl.textContent;
                linkEl.textContent = 'Link copied!';
                setTimeout(() => {
                    linkEl.textContent = originalText;
                }, 2000);
            });
        }

        function cancelHost() {
            cleanup();
            showScreen('startScreen');
        }

        function leaveGame() {
            cleanup();
            showScreen('startScreen');
        }

        function cleanup() {
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = null;
            }

            connections.forEach(conn => conn.close());
            connections = [];

            if (peer) {
                peer.destroy();
                peer = null;
            }

            players = {};
            gameStarted = false;
            isHost = false;
            myPlayerId = null;
        }

        function showScreen(screenId) {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('hostScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }
    </script>
</body>
</html>