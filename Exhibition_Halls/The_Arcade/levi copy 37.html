<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LEVIATHAN: OMEGA PROTOCOL</title>
    <style>
        /* --- CORE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; touch-action: none; }
        body { background: #000; color: #0ff; font-family: 'Segoe UI', monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* --- HUD LAYOUT --- */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Top Bar */
        .hud-top {
            display: flex; justify-content: space-between; padding: 15px;
            background: linear-gradient(to bottom, rgba(0,10,20,0.95), transparent);
            pointer-events: auto;
        }
        .game-title { font-size: 24px; font-weight: 900; letter-spacing: 2px; color: #0ff; text-shadow: 0 0 10px #0ff; }
        .game-subtitle { font-size: 10px; color: #666; letter-spacing: 1px; }
        
        /* --- UNIT FRAMES (WOW STYLE) --- */
        .unit-frame {
            position: absolute; top: 60px; width: 250px;
            background: rgba(0, 0, 0, 0.6); border: 1px solid #333;
            border-radius: 4px; padding: 5px; pointer-events: auto;
            transition: all 0.2s;
        }
        .unit-frame.player { left: 20px; border-color: #0ff; }
        .unit-frame.target { right: 20px; border-color: #f44; display: none; }
        .unit-frame.construct { left: 20px; top: 160px; border-color: #bf00ff; }
        
        .bar-group { display: flex; flex-direction: column; gap: 2px; }
        .bar { height: 12px; background: #111; position: relative; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.2s; }
        .hp-fill { background: linear-gradient(90deg, #0f0, #005500); }
        .mp-fill { background: linear-gradient(90deg, #00f, #000055); }
        .threat-fill { background: linear-gradient(90deg, #f44, #550000); }
        
        .unit-name { font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .unit-level { color: #ffd700; font-size: 10px; }
        .unit-val { position: absolute; right: 4px; top: -1px; font-size: 9px; color: #fff; text-shadow: 1px 1px 0 #000; }

        /* --- ELEMENTAL BADGES --- */
        .elem-badge {
            padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold;
            text-transform: uppercase; display: inline-block; margin-left: 5px;
        }
        .elem-SOLAR { background: #ff4400; color: white; }
        .elem-VOID { background: #8800ff; color: white; }
        .elem-ARC { background: #00ffff; color: black; }
        .elem-BIO { background: #00ff44; color: black; }

        /* --- ACTION BARS --- */
        .action-deck {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: auto;
        }
        
        .skill-btn {
            width: 50px; height: 50px; background: rgba(0,0,0,0.8);
            border: 1px solid #444; border-radius: 6px; color: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer; position: relative;
            transition: transform 0.1s, border-color 0.1s;
        }
        .skill-btn:hover { border-color: #fff; transform: translateY(-2px); }
        .skill-btn:active { transform: translateY(1px); }
        .skill-btn.construct { border-color: #bf00ff; color: #bf00ff; }
        .skill-btn .key { position: absolute; top: 2px; left: 4px; font-size: 8px; color: #888; }
        .skill-btn .cd-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(0,0,0,0.8); transition: height 0.1s linear;
        }

        /* --- ASSIMILATE (CATCH) BUTTON --- */
        #assimilate-btn {
            position: absolute; top: -60px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.2); border: 2px solid #0f0; color: #0f0;
            padding: 10px 20px; font-weight: bold; font-size: 14px;
            cursor: pointer; display: none; animation: pulse 1s infinite;
            backdrop-filter: blur(4px);
        }
        @keyframes pulse { 0% { box-shadow: 0 0 10px #0f0; } 50% { box-shadow: 0 0 25px #0f0; } 100% { box-shadow: 0 0 10px #0f0; } }

        /* --- LOOT TOAST --- */
        .loot-toast {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 1px solid #ffd700;
            padding: 15px; text-align: center; border-radius: 8px;
            animation: floatUp 2s forwards; pointer-events: none;
        }
        @keyframes floatUp { 0% { opacity:0; transform:translate(-50%, 20px); } 20% { opacity:1; transform:translate(-50%, 0); } 80% { opacity:1; } 100% { opacity:0; transform:translate(-50%, -50px); } }

        /* --- RAPPID CHAT --- */
        .copilot-overlay {
            position: absolute; bottom: 100px; right: 20px; width: 300px;
            background: rgba(0, 10, 20, 0.9); border: 1px solid #0ff;
            border-radius: 8px; display: none; flex-direction: column;
            pointer-events: auto; font-size: 12px;
        }
        .chat-log { height: 200px; overflow-y: auto; padding: 10px; color: #ccc; }
        .chat-input { background: #000; border: none; border-top: 1px solid #333; padding: 10px; color: #fff; outline: none; }

        /* --- MENU --- */
        .menu-btn { position: absolute; top: 15px; right: 15px; pointer-events: auto; background: none; border: 1px solid #0ff; color: #0ff; padding: 5px 10px; cursor: pointer; }
        
        /* --- DAMAGE NUMBERS --- */
        .dmg-num { position: absolute; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 0 #000; pointer-events: none; animation: dmgFloat 1s forwards; }
        @keyframes dmgFloat { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-50px); } }
    </style>
</head>
<body>

<div id="game-container"></div>

<div class="ui-layer">
    
    <div class="hud-top">
        <div>
            <div class="game-title">LEVIATHAN</div>
            <div class="game-subtitle">OMEGA PROTOCOL (WOWMON ENGINE)</div>
        </div>
        <button class="menu-btn" onclick="toggleRappid()">AI COPILOT</button>
    </div>

    <!-- PLAYER FRAME -->
    <div class="unit-frame player">
        <div class="unit-name">COMMANDER <span class="unit-level">Lv 60</span></div>
        <div class="bar-group">
            <div class="bar"><div class="bar-fill hp-fill" id="p-hp" style="width: 100%"></div><span class="unit-val" id="p-hp-txt">100%</span></div>
            <div class="bar"><div class="bar-fill mp-fill" id="p-mp" style="width: 100%"></div><span class="unit-val">ENERGY</span></div>
        </div>
    </div>

    <!-- CONSTRUCT FRAME (PET) -->
    <div class="unit-frame construct" id="construct-frame" style="display:none">
        <div class="unit-name">
            <span id="c-name">Construct</span>
            <span id="c-elem" class="elem-badge elem-VOID">VOID</span>
        </div>
        <div class="bar-group">
            <div class="bar"><div class="bar-fill hp-fill" id="c-hp" style="width: 100%"></div><span class="unit-val" id="c-hp-txt">100%</span></div>
            <div class="bar"><div class="bar-fill threat-fill" id="c-th" style="width: 0%"></div><span class="unit-val">THREAT</span></div>
        </div>
        <div style="font-size:10px; color:#aaa; margin-top:2px;">ROLE: <span id="c-role" style="color:#fff">TANK</span></div>
    </div>

    <!-- TARGET FRAME -->
    <div class="unit-frame target" id="target-frame">
        <div class="unit-name">
            <span id="t-name">Target</span>
            <span id="t-elem" class="elem-badge elem-SOLAR">SOLAR</span>
        </div>
        <div class="bar-group">
            <div class="bar"><div class="bar-fill hp-fill" id="t-hp" style="width: 100%; background: #f44;"></div><span class="unit-val" id="t-hp-txt">100%</span></div>
        </div>
    </div>

    <!-- COMMAND DECK -->
    <div class="action-deck">
        <div id="assimilate-btn" onclick="Combat.attemptCapture()">ðŸ§¬ ASSIMILATE GENOME</div>
        
        <!-- Player Skills -->
        <div class="skill-btn" onclick="Combat.playerCast('shot')">
            <span class="key">1</span>
            LASER
        </div>
        <div class="skill-btn" onclick="Combat.playerCast('heal')">
            <span class="key">2</span>
            REPAIR
        </div>
        <div class="skill-btn" onclick="Combat.playerCast('scan')">
            <span class="key">3</span>
            SCAN
        </div>

        <div style="width:20px"></div> <!-- Spacer -->

        <!-- Construct Skills -->
        <div class="skill-btn construct" onclick="Combat.constructCast('q')">
            <span class="key">Q</span>
            ATTACK
        </div>
        <div class="skill-btn construct" onclick="Combat.constructCast('w')">
            <span class="key">W</span>
            TAUNT
        </div>
        <div class="skill-btn construct" onclick="Combat.constructCast('e')">
            <span class="key">E</span>
            SPECIAL
        </div>
        <div class="skill-btn construct" onclick="Combat.constructCast('r')">
            <span class="key">R</span>
            ULT
        </div>
    </div>

    <!-- RAPPID AI OVERLAY -->
    <div class="copilot-overlay" id="rappid-ui">
        <div class="chat-log" id="chat-log">
            <div>SYSTEM: Leviathan-RAPPID Link Established.</div>
        </div>
        <input class="chat-input" type="text" placeholder="Ask Copilot..." onkeydown="if(event.key==='Enter') sendChat(this)">
    </div>

</div>

<!-- Three.js & Logic -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
/**
 * LEVIATHAN: OMEGA PROTOCOL (WOWMON ENGINE)
 * Merges Space Exploration with Creature Taming & Trinity Combat
 */

// --- CONFIGURATION ---
const CONFIG = {
    colors: {
        SOLAR: 0xff4400,
        VOID: 0x8800ff,
        ARC: 0x00ffff,
        BIO: 0x00ff44
    },
    types: {
        SOLAR: { weak: 'ARC', strong: 'BIO' },
        VOID: { weak: 'SOLAR', strong: 'ARC' },
        ARC: { weak: 'BIO', strong: 'SOLAR' },
        BIO: { weak: 'VOID', strong: 'SOLAR' }
    }
};

// --- GLOBAL STATE ---
const STATE = {
    player: { hp: 1000, maxHp: 1000, energy: 100, pos: new THREE.Vector3(0,0,0) },
    construct: null, // The active pet
    target: null,    // Current enemy
    inventory: [],
    constructs: [    // Caught pets
        { name: "Void Walker", type: "VOID", role: "TANK", hp: 2000, maxHp: 2000, dmg: 20 },
        { name: "Solar Flare", type: "SOLAR", role: "DPS", hp: 1200, maxHp: 1200, dmg: 60 }
    ]
};

// --- THREE.JS SETUP ---
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x000510, 0.02);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.getElementById('game-container').appendChild(renderer.domElement);

// Lighting
const ambientLight = new THREE.AmbientLight(0x404040, 2);
scene.add(ambientLight);
const dirLight = new THREE.DirectionalLight(0xffffff, 1);
dirLight.position.set(10, 20, 10);
scene.add(dirLight);

// --- ENTITY FACTORY ---
const entities = [];

class Entity {
    constructor(type, color, x, z, isMob = false) {
        this.type = type;
        this.hp = 1000;
        this.maxHp = 1000;
        this.isMob = isMob;
        this.threatTable = {}; // { sourceId: amount }
        
        // Visuals
        const geo = isMob ? new THREE.DodecahedronGeometry(1) : new THREE.BoxGeometry(1, 2, 1);
        const mat = new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: 0.5 });
        this.mesh = new THREE.Mesh(geo, mat);
        this.mesh.position.set(x, 1, z);
        
        // Health Bar (3D)
        const hpBg = new THREE.Mesh(new THREE.PlaneGeometry(2, 0.2), new THREE.MeshBasicMaterial({color:0x000000}));
        hpBg.position.y = 2.5;
        this.mesh.add(hpBg);
        
        const hpFg = new THREE.Mesh(new THREE.PlaneGeometry(2, 0.2), new THREE.MeshBasicMaterial({color:0x00ff00}));
        hpFg.position.y = 2.5;
        hpFg.position.z = 0.01;
        this.hpBar = hpFg;
        this.mesh.add(hpFg);

        // Aggro Ring (WoW Mechanic)
        if (isMob) {
            const ringGeo = new THREE.RingGeometry(1.5, 1.6, 32);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0, side: THREE.DoubleSide });
            this.aggroRing = new THREE.Mesh(ringGeo, ringMat);
            this.aggroRing.rotation.x = -Math.PI / 2;
            this.aggroRing.position.y = -0.9;
            this.mesh.add(this.aggroRing);
        }

        scene.add(this.mesh);
        entities.push(this);
    }

    update(dt) {
        // Float animation
        this.mesh.position.y = 1 + Math.sin(Date.now() * 0.002) * 0.1;
        this.mesh.rotation.y += 0.01;

        // AI Logic (if mob)
        if (this.isMob && this.hp > 0) {
            this.mobLogic(dt);
        }

        // HP Bar Update
        const pct = Math.max(0, this.hp / this.maxHp);
        this.hpBar.scale.x = pct;
        this.hpBar.position.x = (pct - 1); // Center scaling hack
        this.hpBar.material.color.setHSL(pct * 0.3, 1, 0.5);
    }

    mobLogic(dt) {
        // Find highest threat target
        let topThreat = 0;
        let target = null;
        
        // Check player
        if (STATE.player.mesh && this.mesh.position.distanceTo(STATE.player.mesh.position) < 10) {
             // Base player threat
        }

        // Check construct
        if (STATE.construct && STATE.construct.mesh) {
             const cThreat = this.threatTable['construct'] || 0;
             if (cThreat > topThreat) { topThreat = cThreat; target = STATE.construct; }
        }

        // Simple Chase
        if (target) {
            this.aggroRing.material.opacity = 1;
            const dir = new THREE.Vector3().subVectors(target.mesh.position, this.mesh.position).normalize();
            this.mesh.position.add(dir.multiplyScalar(dt * 2)); // Speed
        } else {
            this.aggroRing.material.opacity = 0;
        }
    }

    takeDamage(amount, source, type) {
        // Elemental Calc
        let mult = 1.0;
        let text = "";
        if (this.elemType && type) {
            if (CONFIG.types[this.elemType].weak === type) { mult = 2.0; text = "CRIT!"; }
            if (CONFIG.types[this.elemType].strong === type) { mult = 0.5; text = "RESIST"; }
        }

        const finalDmg = Math.floor(amount * mult);
        this.hp -= finalDmg;
        spawnDmgText(this.mesh.position, finalDmg, text, type);

        // Threat Gen
        if (source === 'construct') {
            // Tank role generates 3x threat
            const threatMod = STATE.construct.role === 'TANK' ? 3 : 1;
            this.threatTable['construct'] = (this.threatTable['construct'] || 0) + (finalDmg * threatMod);
        }

        // Death / Capture Check
        if (this.hp <= 0) {
            this.die();
        } else if (this.hp < this.maxHp * 0.2) {
            document.getElementById('assimilate-btn').style.display = 'block';
        }

        if (this === STATE.target) UI.updateTarget();
    }

    die() {
        scene.remove(this.mesh);
        entities.splice(entities.indexOf(this), 1);
        if (this === STATE.target) {
            STATE.target = null;
            document.getElementById('target-frame').style.display = 'none';
            document.getElementById('assimilate-btn').style.display = 'none';
        }
        spawnLoot(this.mesh.position);
    }
}

// --- PLAYER & CONSTRUCT SETUP ---
const player = new Entity('PLAYER', 0x00ff00, 0, 0);
STATE.player.mesh = player.mesh;

function spawnConstruct(idx) {
    if (STATE.construct) scene.remove(STATE.construct.mesh);
    
    const data = STATE.constructs[idx];
    const c = new Entity('CONSTRUCT', CONFIG.colors[data.type], 2, 2);
    c.role = data.role;
    c.maxHp = data.maxHp;
    c.hp = data.hp;
    c.dmg = data.dmg;
    c.elemType = data.type;
    
    STATE.construct = c;
    
    // UI Update
    document.getElementById('construct-frame').style.display = 'block';
    document.getElementById('c-name').innerText = data.name;
    document.getElementById('c-role').innerText = data.role;
    const badge = document.getElementById('c-elem');
    badge.className = `elem-badge elem-${data.type}`;
    badge.innerText = data.type;
    
    UI.updateConstruct();
}

// Initial Spawn
spawnConstruct(0); // Spawn Void Walker

// Spawn Random Mobs
for(let i=0; i<5; i++) {
    const x = (Math.random() - 0.5) * 30;
    const z = (Math.random() - 0.5) * 30;
    const type = Object.keys(CONFIG.colors)[Math.floor(Math.random()*4)];
    const mob = new Entity(type, CONFIG.colors[type], x, z, true);
    mob.elemType = type;
}

// --- COMBAT SYSTEM ---
const Combat = {
    playerCast: (spell) => {
        if (!STATE.target) return;
        
        if (spell === 'shot') {
            // Basic shot
            STATE.target.takeDamage(50, 'player', 'ARC');
            // Visual Laser
            createBeam(STATE.player.mesh.position, STATE.target.mesh.position, 0x00ffff);
        }
        if (spell === 'heal') {
            if (STATE.construct) {
                STATE.construct.hp = Math.min(STATE.construct.maxHp, STATE.construct.hp + 200);
                UI.updateConstruct();
                spawnDmgText(STATE.construct.mesh.position, "+200", "HEAL", "BIO");
            }
        }
    },

    constructCast: (key) => {
        if (!STATE.construct || !STATE.target) return;
        const c = STATE.construct;

        if (key === 'q') { // Attack
            STATE.target.takeDamage(c.dmg, 'construct', c.elemType);
            // Construct bumps target
            c.mesh.position.lerp(STATE.target.mesh.position, 0.2); 
        }
        if (key === 'w') { // Taunt
            STATE.target.threatTable['construct'] += 5000;
            spawnDmgText(STATE.target.mesh.position, "TAUNTED", "!", "void");
        }
        
        UI.updateConstruct();
    },

    attemptCapture: () => {
        if (!STATE.target || STATE.target.hp > STATE.target.maxHp * 0.2) return;
        
        // Success!
        const newPet = {
            name: "Subject " + Math.floor(Math.random()*999),
            type: STATE.target.elemType,
            role: Math.random() > 0.5 ? "DPS" : "TANK",
            hp: STATE.target.maxHp,
            maxHp: STATE.target.maxHp,
            dmg: 40
        };
        STATE.constructs.push(newPet);
        STATE.target.die(); // Remove mob
        
        // Show Toast
        const toast = document.createElement('div');
        toast.className = 'loot-toast';
        toast.innerHTML = `<span style="color:#0f0">GENOME ASSIMILATED!</span><br>New Construct Available`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }
};

// --- INPUT & CONTROLS ---
// Raycaster for clicking targets
window.addEventListener('mousedown', (e) => {
    const mouse = new THREE.Vector2(
        (e.clientX / window.innerWidth) * 2 - 1,
        -(e.clientY / window.innerHeight) * 2 + 1
    );
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(scene.children);
    
    for (let hit of intersects) {
        const ent = entities.find(e => e.mesh === hit.object || e.mesh.children.includes(hit.object));
        if (ent && ent.isMob) {
            STATE.target = ent;
            UI.updateTarget();
            break;
        }
    }
});

// WASD Movement
const keys = {};
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

function updatePlayerMove(dt) {
    const speed = 10 * dt;
    if (keys['w']) STATE.player.mesh.position.z -= speed;
    if (keys['s']) STATE.player.mesh.position.z += speed;
    if (keys['a']) STATE.player.mesh.position.x -= speed;
    if (keys['d']) STATE.player.mesh.position.x += speed;
    
    // Camera Follow
    camera.position.x = STATE.player.mesh.position.x;
    camera.position.z = STATE.player.mesh.position.z + 10;
    camera.position.y = 15;
    camera.lookAt(STATE.player.mesh.position);

    // Construct Follow
    if (STATE.construct) {
        const dist = STATE.construct.mesh.position.distanceTo(STATE.player.mesh.position);
        if (dist > 3 && !STATE.target) { // Only follow if far and not fighting
            const dir = new THREE.Vector3().subVectors(STATE.player.mesh.position, STATE.construct.mesh.position).normalize();
            STATE.construct.mesh.position.add(dir.multiplyScalar(speed * 0.9));
        }
    }
}

// --- VISUAL FX ---
function createBeam(start, end, color) {
    const geo = new THREE.BufferGeometry().setFromPoints([start, end]);
    const mat = new THREE.LineBasicMaterial({ color: color });
    const line = new THREE.Line(geo, mat);
    scene.add(line);
    setTimeout(() => scene.remove(line), 100);
}

function spawnDmgText(pos, amount, msg="", type="SOLAR") {
    const div = document.createElement('div');
    div.className = 'dmg-num';
    div.innerText = msg + amount;
    div.style.color = CONFIG.colors[type] ? '#' + CONFIG.colors[type].toString(16) : '#fff';
    
    // Project 3D pos to 2D screen
    const tempV = pos.clone();
    tempV.project(camera);
    const x = (tempV.x * .5 + .5) * window.innerWidth;
    const y = (-(tempV.y * .5) + .5) * window.innerHeight;
    
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 1000);
}

function spawnLoot(pos) {
    const geo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
    const mat = new THREE.MeshBasicMaterial({ color: 0xffd700 });
    const loot = new THREE.Mesh(geo, mat);
    loot.position.copy(pos);
    scene.add(loot);
    // Simple logic: auto collect logic would go here
}

// --- UI MANAGER ---
const UI = {
    updateConstruct: () => {
        if (!STATE.construct) return;
        const pct = (STATE.construct.hp / STATE.construct.maxHp) * 100;
        document.getElementById('c-hp').style.width = pct + '%';
        document.getElementById('c-hp-txt').innerText = Math.floor(STATE.construct.hp);
        
        // Threat bar logic (simplified)
        if (STATE.target) {
            const t = STATE.target.threatTable['construct'] || 0;
            const p = Math.min(100, t / 100); // visual scale
            document.getElementById('c-th').style.width = p + '%';
        }
    },
    updateTarget: () => {
        const t = STATE.target;
        const frame = document.getElementById('target-frame');
        if (!t || t.hp <= 0) {
            frame.style.display = 'none';
            document.getElementById('assimilate-btn').style.display = 'none';
            return;
        }
        frame.style.display = 'block';
        document.getElementById('t-name').innerText = "Hostile Entity";
        const badge = document.getElementById('t-elem');
        badge.className = `elem-badge elem-${t.elemType}`;
        badge.innerText = t.elemType;
        
        const pct = (t.hp / t.maxHp) * 100;
        document.getElementById('t-hp').style.width = pct + '%';
        document.getElementById('t-hp-txt').innerText = Math.floor(t.hp);
    }
};

// --- RAPPID COPILOT ---
function toggleRappid() {
    const ui = document.getElementById('rappid-ui');
    ui.style.display = ui.style.display === 'flex' ? 'none' : 'flex';
}

function sendChat(input) {
    const msg = input.value;
    if(!msg) return;
    
    const log = document.getElementById('chat-log');
    log.innerHTML += `<div style="color:#fff">> ${msg}</div>`;
    input.value = '';

    // Simulate RAPPID Response
    setTimeout(() => {
        let response = "Analyzing...";
        if (msg.includes("target")) response = "Target is weak to ARC damage. Recommend swapping Construct.";
        if (msg.includes("pet")) response = "Your Construct is at 90% integrity. Threat levels nominal.";
        log.innerHTML += `<div style="color:#0ff">RAPPID: ${response}</div>`;
        log.scrollTop = log.scrollHeight;
    }, 500);
}

// --- MAIN LOOP ---
const clock = new THREE.Clock();

function animate() {
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    
    updatePlayerMove(dt);
    entities.forEach(e => e.update(dt));
    
    renderer.render(scene, camera);
}

animate();

</script>
</body>
</html>