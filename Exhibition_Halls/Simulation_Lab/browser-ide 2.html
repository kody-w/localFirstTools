<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser IDE - Code Compiler & Runtime Sandbox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Consolas', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            height: 45px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 8px;
        }

        .toolbar select, .toolbar button {
            padding: 6px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
        }

        .toolbar button:hover {
            background: #505050;
        }

        .toolbar button.run {
            background: #0e639c;
            border-color: #1177bb;
        }

        .toolbar button.run:hover {
            background: #1177bb;
        }

        .toolbar .status {
            margin-left: auto;
            font-size: 12px;
            color: #888;
        }

        /* Main Container */
        .container {
            display: flex;
            height: calc(100vh - 45px);
        }

        /* Sidebar - File Tree */
        .sidebar {
            width: 220px;
            background: #252526;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 10px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            font-size: 11px;
            text-transform: uppercase;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .file-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
        }

        .file-item:hover {
            background: #2a2d2e;
        }

        .file-item.active {
            background: #37373d;
            border-left: 2px solid #0e639c;
        }

        .file-item .icon {
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .panes {
            flex: 1;
            display: flex;
        }

        /* Editor Pane */
        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #404040;
        }

        .editor-header {
            height: 35px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 12px;
            color: #888;
        }

        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            width: 50px;
            background: #1e1e1e;
            color: #858585;
            font-size: 13px;
            line-height: 1.6;
            padding: 12px 8px;
            text-align: right;
            user-select: none;
            overflow: hidden;
        }

        .code-editor {
            position: absolute;
            left: 50px;
            top: 0;
            right: 0;
            bottom: 0;
            padding: 12px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-size: 13px;
            line-height: 1.6;
            font-family: 'SF Mono', 'Monaco', monospace;
            border: none;
            outline: none;
            resize: none;
            overflow: auto;
            white-space: pre;
            tab-size: 4;
        }

        .code-display {
            position: absolute;
            left: 50px;
            top: 0;
            right: 0;
            bottom: 0;
            padding: 12px;
            background: transparent;
            font-size: 13px;
            line-height: 1.6;
            pointer-events: none;
            overflow: hidden;
            white-space: pre;
            tab-size: 4;
        }

        /* Output Pane */
        .output-pane {
            width: 45%;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        .output-header {
            height: 35px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 12px;
            color: #888;
        }

        .output-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            font-size: 13px;
            line-height: 1.6;
            font-family: 'SF Mono', monospace;
        }

        .output-line {
            margin: 2px 0;
            word-wrap: break-word;
        }

        .output-line.error {
            color: #f48771;
        }

        .output-line.success {
            color: #89d185;
        }

        .output-line.warning {
            color: #e5c07b;
        }

        /* Console/REPL */
        .console-pane {
            height: 200px;
            background: #1e1e1e;
            border-top: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .console-header {
            height: 30px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: #888;
        }

        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
            font-size: 12px;
        }

        .console-input-area {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #252526;
            border-top: 1px solid #404040;
        }

        .console-prompt {
            color: #4ec9b0;
            margin-right: 8px;
        }

        .console-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #d4d4d4;
            font-family: inherit;
            font-size: 12px;
            outline: none;
        }

        /* Right Sidebar - Performance */
        .right-sidebar {
            width: 250px;
            background: #252526;
            border-left: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .perf-section {
            padding: 16px;
            border-bottom: 1px solid #404040;
        }

        .perf-title {
            font-size: 11px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 12px;
        }

        .perf-metric {
            margin: 8px 0;
            font-size: 12px;
        }

        .perf-label {
            color: #888;
            margin-bottom: 4px;
        }

        .perf-value {
            color: #4ec9b0;
            font-size: 18px;
            font-weight: 600;
        }

        .memory-graph {
            height: 100px;
            background: #1e1e1e;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .memory-bar {
            position: absolute;
            bottom: 0;
            width: 2px;
            background: #0e639c;
        }

        /* Syntax Highlighting */
        .keyword { color: #c586c0; }
        .string { color: #ce9178; }
        .number { color: #b5cea8; }
        .comment { color: #6a9955; }
        .function { color: #dcdcaa; }
        .operator { color: #d4d4d4; }
        .builtin { color: #4ec9b0; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 16px;
            margin-bottom: 16px;
            color: #fff;
        }

        .modal-input {
            width: 100%;
            padding: 8px 12px;
            background: #1e1e1e;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-family: inherit;
            margin-bottom: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            cursor: pointer;
            font-family: inherit;
        }

        .btn:hover {
            background: #505050;
        }

        .btn.primary {
            background: #0e639c;
            border-color: #1177bb;
        }

        .btn.primary:hover {
            background: #1177bb;
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <select id="language-select" onchange="IDE.changeLanguage(this.value)">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="html">HTML/CSS</option>
        </select>

        <button class="run" onclick="IDE.runCode()">‚ñ∂ Run</button>
        <button onclick="IDE.clearOutput()">Clear Output</button>
        <button onclick="IDE.formatCode()">Format</button>
        <button onclick="IDE.showPackageInstaller()">üì¶ Install Package</button>
        <button onclick="IDE.showGitHistory()">üìú Git History</button>
        <button onclick="IDE.exportProject()">üíæ Export</button>
        <button onclick="IDE.importProject()">üìÇ Import</button>

        <div class="status" id="status">Ready</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Sidebar - File Tree -->
        <div class="sidebar">
            <div class="sidebar-header">
                Explorer
                <button onclick="IDE.newFile()" style="background: transparent; border: none; color: #888; cursor: pointer; padding: 2px 6px;">+</button>
            </div>
            <div class="file-tree" id="file-tree"></div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Editor and Output Panes -->
            <div class="panes">
                <!-- Editor Pane -->
                <div class="editor-pane">
                    <div class="editor-header">
                        <span id="current-file">main.js</span>
                    </div>
                    <div class="editor-container">
                        <div class="line-numbers" id="line-numbers">1</div>
                        <div class="code-display" id="code-display"></div>
                        <textarea
                            class="code-editor"
                            id="code-editor"
                            spellcheck="false"
                            oninput="IDE.updateEditor()"
                            onkeydown="IDE.handleKeyDown(event)"
                            onscroll="IDE.syncScroll()"
                        >// Welcome to Browser IDE!
// Write your code here and click Run

console.log('Hello, World!');

function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

console.log('Fibonacci(10):', fibonacci(10));</textarea>
                    </div>
                </div>

                <!-- Output Pane -->
                <div class="output-pane">
                    <div class="output-header">Output</div>
                    <div class="output-content" id="output"></div>
                </div>
            </div>

            <!-- Console/REPL -->
            <div class="console-pane">
                <div class="console-header">Console / REPL</div>
                <div class="console-content" id="console"></div>
                <div class="console-input-area">
                    <span class="console-prompt">></span>
                    <input
                        type="text"
                        class="console-input"
                        id="console-input"
                        placeholder="Enter command..."
                        onkeydown="IDE.handleConsoleInput(event)"
                    >
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Performance -->
        <div class="right-sidebar">
            <div class="perf-section">
                <div class="perf-title">Performance</div>
                <div class="perf-metric">
                    <div class="perf-label">Execution Time</div>
                    <div class="perf-value" id="exec-time">0ms</div>
                </div>
                <div class="perf-metric">
                    <div class="perf-label">Lines of Code</div>
                    <div class="perf-value" id="loc">0</div>
                </div>
            </div>

            <div class="perf-section">
                <div class="perf-title">Memory Usage</div>
                <div class="perf-metric">
                    <div class="perf-label">Heap Used</div>
                    <div class="perf-value" id="memory-used">0 MB</div>
                </div>
                <div class="memory-graph" id="memory-graph"></div>
            </div>

            <div class="perf-section">
                <div class="perf-title">Packages</div>
                <div id="package-list" style="font-size: 12px; color: #888;">
                    No packages installed
                </div>
            </div>
        </div>
    </div>

    <!-- Package Installer Modal -->
    <div class="modal" id="package-modal">
        <div class="modal-content">
            <div class="modal-title">Install NPM Package</div>
            <input
                type="text"
                class="modal-input"
                id="package-name"
                placeholder="e.g., lodash, axios, date-fns"
            >
            <div class="modal-buttons">
                <button class="btn" onclick="IDE.closeModal('package-modal')">Cancel</button>
                <button class="btn primary" onclick="IDE.installPackage()">Install</button>
            </div>
        </div>
    </div>

    <!-- Git History Modal -->
    <div class="modal" id="git-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title">Git Commit History</div>
            <div id="git-history" style="max-height: 400px; overflow-y: auto; font-size: 12px;"></div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button class="btn" onclick="IDE.closeModal('git-modal')">Close</button>
                <button class="btn primary" onclick="IDE.createCommit()">New Commit</button>
            </div>
        </div>
    </div>

    <script>
        const IDE = {
            currentFile: 'main.js',
            currentLanguage: 'javascript',
            files: {},
            packages: [],
            gitHistory: [],
            memoryHistory: [],
            worker: null,
            pyodideReady: false,

            // Initialize IDE
            init() {
                this.loadFromLocalStorage();
                this.updateFileTree();
                this.updateEditor();
                this.initWorker();
                this.startMemoryMonitor();

                // Load saved code
                const editor = document.getElementById('code-editor');
                if (this.files[this.currentFile]) {
                    editor.value = this.files[this.currentFile].content;
                } else {
                    this.files[this.currentFile] = {
                        name: 'main.js',
                        content: editor.value,
                        language: 'javascript'
                    };
                }

                this.updateEditor();
            },

            // Initialize Web Worker
            initWorker() {
                const workerCode = `
                    self.onmessage = function(e) {
                        const { code, language } = e.data;
                        const logs = [];
                        const errors = [];

                        // Capture console
                        const console = {
                            log: (...args) => logs.push({ type: 'log', args }),
                            error: (...args) => errors.push({ type: 'error', args }),
                            warn: (...args) => logs.push({ type: 'warn', args })
                        };

                        try {
                            const startTime = performance.now();

                            if (language === 'javascript') {
                                const result = eval(code);
                                const endTime = performance.now();

                                self.postMessage({
                                    success: true,
                                    result,
                                    logs,
                                    errors,
                                    executionTime: endTime - startTime
                                });
                            }
                        } catch (error) {
                            self.postMessage({
                                success: false,
                                error: error.message,
                                stack: error.stack,
                                logs,
                                errors
                            });
                        }
                    };
                `;

                const blob = new Blob([workerCode], { type: 'application/javascript' });
                this.worker = new Worker(URL.createObjectURL(blob));

                this.worker.onmessage = (e) => {
                    this.handleWorkerResult(e.data);
                };
            },

            // Handle Web Worker result
            handleWorkerResult(data) {
                const output = document.getElementById('output');

                if (data.success) {
                    // Display logs
                    data.logs.forEach(log => {
                        this.addOutput(log.args.join(' '), log.type);
                    });

                    // Display errors
                    data.errors.forEach(err => {
                        this.addOutput(err.args.join(' '), 'error');
                    });

                    // Display result if not undefined
                    if (data.result !== undefined) {
                        this.addOutput(`‚Üí ${JSON.stringify(data.result)}`, 'success');
                    }

                    // Update performance
                    document.getElementById('exec-time').textContent = data.executionTime.toFixed(2) + 'ms';
                } else {
                    this.addOutput(`Error: ${data.error}`, 'error');
                    if (data.stack) {
                        this.addOutput(data.stack, 'error');
                    }
                }

                this.updateStatus('Ready');
            },

            // Run code
            async runCode() {
                const editor = document.getElementById('code-editor');
                const code = editor.value;
                const language = this.currentLanguage;

                this.updateStatus('Running...');
                this.clearOutput();

                if (language === 'javascript') {
                    this.worker.postMessage({ code, language });
                } else if (language === 'python') {
                    await this.runPython(code);
                } else if (language === 'html') {
                    this.runHTML(code);
                }

                // Update LOC
                const loc = code.split('\n').filter(line => line.trim()).length;
                document.getElementById('loc').textContent = loc;

                // Update memory (mock)
                this.updateMemory();
            },

            // Run Python code
            async runPython(code) {
                try {
                    if (!window.pyodide) {
                        this.addOutput('Loading Python runtime...', 'warning');
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
                        document.head.appendChild(script);

                        await new Promise((resolve) => {
                            script.onload = async () => {
                                window.pyodide = await loadPyodide();
                                this.addOutput('Python ready!', 'success');
                                resolve();
                            };
                        });
                    }

                    const startTime = performance.now();

                    // Capture stdout
                    await window.pyodide.runPythonAsync(`
import sys
from io import StringIO
sys.stdout = StringIO()
`);

                    await window.pyodide.runPythonAsync(code);

                    const output = await window.pyodide.runPythonAsync('sys.stdout.getvalue()');
                    const endTime = performance.now();

                    if (output) {
                        this.addOutput(output, 'log');
                    }

                    document.getElementById('exec-time').textContent = (endTime - startTime).toFixed(2) + 'ms';
                    this.updateStatus('Ready');
                } catch (error) {
                    this.addOutput(`Python Error: ${error.message}`, 'error');
                    this.updateStatus('Error');
                }
            },

            // Run HTML code
            runHTML(code) {
                const output = document.getElementById('output');
                output.innerHTML = '';

                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.background = 'white';

                output.appendChild(iframe);

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(code);
                iframeDoc.close();

                this.updateStatus('Ready');
            },

            // Add output line
            addOutput(text, type = 'log') {
                const output = document.getElementById('output');
                const line = document.createElement('div');
                line.className = `output-line ${type}`;
                line.textContent = text;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            },

            // Clear output
            clearOutput() {
                document.getElementById('output').innerHTML = '';
            },

            // Update editor with syntax highlighting
            updateEditor() {
                const editor = document.getElementById('code-editor');
                const display = document.getElementById('code-display');
                const lineNumbers = document.getElementById('line-numbers');

                const code = editor.value;
                const lines = code.split('\n');

                // Update line numbers
                lineNumbers.innerHTML = lines.map((_, i) => i + 1).join('\n');

                // Syntax highlighting
                display.innerHTML = this.highlightSyntax(code);

                // Save to current file
                if (this.files[this.currentFile]) {
                    this.files[this.currentFile].content = code;
                    this.saveToLocalStorage();
                }
            },

            // Simple syntax highlighter
            highlightSyntax(code) {
                if (this.currentLanguage === 'javascript') {
                    return code
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\b(function|const|let|var|if|else|for|while|return|class|extends|import|export|async|await|try|catch|throw|new)\b/g, '<span class="keyword">$1</span>')
                        .replace(/\b(console|Math|Array|Object|String|Number|Boolean|Date|JSON)\b/g, '<span class="builtin">$1</span>')
                        .replace(/(['"`])(.*?)\1/g, '<span class="string">$1$2$1</span>')
                        .replace(/\b(\d+)\b/g, '<span class="number">$1</span>')
                        .replace(/(\/\/.*$)/gm, '<span class="comment">$1</span>')
                        .replace(/\b([a-zA-Z_]\w*)\s*\(/g, '<span class="function">$1</span>(');
                } else if (this.currentLanguage === 'python') {
                    return code
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|with|lambda|yield|async|await)\b/g, '<span class="keyword">$1</span>')
                        .replace(/\b(print|len|range|str|int|list|dict|set|tuple|open|input)\b/g, '<span class="builtin">$1</span>')
                        .replace(/(['"`])(.*?)\1/g, '<span class="string">$1$2$1</span>')
                        .replace(/\b(\d+)\b/g, '<span class="number">$1</span>')
                        .replace(/(#.*$)/gm, '<span class="comment">$1</span>');
                }
                return code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            },

            // Handle keyboard shortcuts
            handleKeyDown(event) {
                // Tab key
                if (event.key === 'Tab') {
                    event.preventDefault();
                    const editor = event.target;
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    const value = editor.value;

                    editor.value = value.substring(0, start) + '    ' + value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 4;

                    this.updateEditor();
                }

                // Cmd/Ctrl + Enter to run
                if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                    event.preventDefault();
                    this.runCode();
                }

                // Cmd/Ctrl + S to save
                if ((event.metaKey || event.ctrlKey) && event.key === 's') {
                    event.preventDefault();
                    this.saveToLocalStorage();
                    this.updateStatus('Saved');
                }
            },

            // Sync scroll between editor and display
            syncScroll() {
                const editor = document.getElementById('code-editor');
                const display = document.getElementById('code-display');
                const lineNumbers = document.getElementById('line-numbers');

                display.scrollTop = editor.scrollTop;
                display.scrollLeft = editor.scrollLeft;
                lineNumbers.scrollTop = editor.scrollTop;
            },

            // Change language
            changeLanguage(lang) {
                this.currentLanguage = lang;
                this.updateEditor();
            },

            // Format code (basic)
            formatCode() {
                const editor = document.getElementById('code-editor');
                let code = editor.value;

                if (this.currentLanguage === 'javascript') {
                    // Basic formatting
                    code = code.replace(/\{/g, ' {\n').replace(/\}/g, '\n}').replace(/;/g, ';\n');
                }

                editor.value = code;
                this.updateEditor();
            },

            // File Management
            newFile() {
                const name = prompt('Enter file name:');
                if (!name) return;

                const ext = name.split('.').pop();
                const language = ext === 'py' ? 'python' : ext === 'html' ? 'html' : 'javascript';

                this.files[name] = {
                    name,
                    content: '',
                    language
                };

                this.currentFile = name;
                this.currentLanguage = language;

                document.getElementById('code-editor').value = '';
                document.getElementById('current-file').textContent = name;
                document.getElementById('language-select').value = language;

                this.updateFileTree();
                this.updateEditor();
            },

            openFile(name) {
                if (!this.files[name]) return;

                this.currentFile = name;
                this.currentLanguage = this.files[name].language;

                document.getElementById('code-editor').value = this.files[name].content;
                document.getElementById('current-file').textContent = name;
                document.getElementById('language-select').value = this.currentLanguage;

                this.updateFileTree();
                this.updateEditor();
            },

            updateFileTree() {
                const tree = document.getElementById('file-tree');
                tree.innerHTML = '';

                Object.values(this.files).forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item' + (file.name === this.currentFile ? ' active' : '');

                    const icon = file.language === 'javascript' ? '‚ö°' :
                                 file.language === 'python' ? 'üêç' :
                                 file.language === 'html' ? 'üåê' : 'üìÑ';

                    item.innerHTML = `<span class="icon">${icon}</span>${file.name}`;
                    item.onclick = () => this.openFile(file.name);

                    tree.appendChild(item);
                });
            },

            // Console/REPL
            handleConsoleInput(event) {
                if (event.key === 'Enter') {
                    const input = event.target.value;
                    if (!input.trim()) return;

                    // Add to console
                    const consoleEl = document.getElementById('console');
                    const line = document.createElement('div');
                    line.innerHTML = `<span style="color: #4ec9b0;">> </span>${input}`;
                    consoleEl.appendChild(line);

                    // Execute
                    try {
                        const result = eval(input);
                        const resultLine = document.createElement('div');
                        resultLine.innerHTML = `<span style="color: #89d185;">‚Üí </span>${JSON.stringify(result)}`;
                        consoleEl.appendChild(resultLine);
                    } catch (error) {
                        const errorLine = document.createElement('div');
                        errorLine.innerHTML = `<span style="color: #f48771;">‚úñ </span>${error.message}`;
                        consoleEl.appendChild(errorLine);
                    }

                    event.target.value = '';
                    consoleEl.scrollTop = consoleEl.scrollHeight;
                }
            },

            // Package Management
            showPackageInstaller() {
                document.getElementById('package-modal').classList.add('active');
            },

            async installPackage() {
                const name = document.getElementById('package-name').value.trim();
                if (!name) return;

                this.updateStatus(`Installing ${name}...`);

                try {
                    // Use Skypack CDN
                    const url = `https://cdn.skypack.dev/${name}`;
                    const response = await fetch(url);

                    if (response.ok) {
                        this.packages.push({ name, url });
                        this.updatePackageList();
                        this.addOutput(`‚úì Installed ${name} from Skypack`, 'success');
                        this.addOutput(`Import with: import pkg from '${url}'`, 'log');
                    } else {
                        this.addOutput(`‚úñ Package ${name} not found`, 'error');
                    }
                } catch (error) {
                    this.addOutput(`‚úñ Failed to install ${name}: ${error.message}`, 'error');
                }

                this.closeModal('package-modal');
                this.updateStatus('Ready');
            },

            updatePackageList() {
                const list = document.getElementById('package-list');

                if (this.packages.length === 0) {
                    list.textContent = 'No packages installed';
                } else {
                    list.innerHTML = this.packages.map(pkg =>
                        `<div style="margin: 4px 0;">‚Ä¢ ${pkg.name}</div>`
                    ).join('');
                }

                this.saveToLocalStorage();
            },

            // Git History
            showGitHistory() {
                const modal = document.getElementById('git-modal');
                const history = document.getElementById('git-history');

                history.innerHTML = this.gitHistory.length === 0 ?
                    '<div style="color: #888; padding: 20px; text-align: center;">No commits yet</div>' :
                    this.gitHistory.map((commit, i) => `
                        <div style="padding: 12px; background: ${i === 0 ? '#2a2d2e' : 'transparent'}; border-radius: 4px; margin-bottom: 8px;">
                            <div style="color: #4ec9b0; font-weight: 600;">${commit.hash}</div>
                            <div style="margin: 4px 0;">${commit.message}</div>
                            <div style="color: #888; font-size: 11px;">${commit.date} - ${commit.files} files changed</div>
                        </div>
                    `).join('');

                modal.classList.add('active');
            },

            createCommit() {
                const message = prompt('Commit message:');
                if (!message) return;

                const commit = {
                    hash: Math.random().toString(36).substring(2, 9),
                    message,
                    date: new Date().toLocaleString(),
                    files: Object.keys(this.files).length,
                    snapshot: JSON.parse(JSON.stringify(this.files))
                };

                this.gitHistory.unshift(commit);
                this.saveToLocalStorage();
                this.showGitHistory();
            },

            // Memory Monitor
            startMemoryMonitor() {
                setInterval(() => {
                    this.updateMemory();
                }, 1000);
            },

            updateMemory() {
                const mockMemory = 5 + Math.random() * 15; // 5-20 MB
                document.getElementById('memory-used').textContent = mockMemory.toFixed(1) + ' MB';

                // Update graph
                this.memoryHistory.push(mockMemory);
                if (this.memoryHistory.length > 50) {
                    this.memoryHistory.shift();
                }

                const graph = document.getElementById('memory-graph');
                graph.innerHTML = '';

                this.memoryHistory.forEach((mem, i) => {
                    const bar = document.createElement('div');
                    bar.className = 'memory-bar';
                    bar.style.left = (i * 5) + 'px';
                    bar.style.height = (mem / 20 * 100) + '%';
                    graph.appendChild(bar);
                });
            },

            // Import/Export
            exportProject() {
                const data = {
                    files: this.files,
                    packages: this.packages,
                    gitHistory: this.gitHistory
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'browser-ide-project.json';
                a.click();
                URL.revokeObjectURL(url);
            },

            importProject() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            this.files = data.files || {};
                            this.packages = data.packages || [];
                            this.gitHistory = data.gitHistory || [];

                            this.updateFileTree();
                            this.updatePackageList();
                            this.saveToLocalStorage();

                            alert('Project imported successfully!');
                        } catch (error) {
                            alert('Failed to import project: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            // LocalStorage
            saveToLocalStorage() {
                localStorage.setItem('browserIDE', JSON.stringify({
                    files: this.files,
                    packages: this.packages,
                    gitHistory: this.gitHistory,
                    currentFile: this.currentFile
                }));
            },

            loadFromLocalStorage() {
                const data = localStorage.getItem('browserIDE');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.files = parsed.files || {};
                    this.packages = parsed.packages || [];
                    this.gitHistory = parsed.gitHistory || [];
                    this.currentFile = parsed.currentFile || 'main.js';
                }
            },

            // Modal
            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            },

            // Status
            updateStatus(text) {
                document.getElementById('status').textContent = text;
            }
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            IDE.init();
        });
    </script>
</body>
</html>
