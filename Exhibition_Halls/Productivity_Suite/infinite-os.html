<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniteOS</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;
            --fg:#c9d1d9;--fg2:#8b949e;--accent:#58a6ff;--accent2:#1f6feb;
            --green:#3fb950;--red:#f85149;--yellow:#d29922;--purple:#a371f7;
            --radius:6px;--taskbar:44px;--shadow:0 8px 24px rgba(0,0,0,0.4)
        }
        html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:13px;background:var(--bg);color:var(--fg)}

        /* Boot */
        #boot{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;transition:opacity .3s}
        #boot.done{opacity:0;pointer-events:none}
        #boot .logo{font-size:48px;animation:pulse 1s infinite alternate}
        @keyframes pulse{to{opacity:.5;transform:scale(1.1)}}
        #boot .bar{width:200px;height:3px;background:#222;border-radius:2px;margin-top:30px;overflow:hidden}
        #boot .bar div{height:100%;background:var(--accent);width:0;transition:width .2s}

        /* Lock */
        #lock{position:fixed;inset:0;background:linear-gradient(135deg,#0d1117,#1a1f29);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
        #lock .time{font-size:72px;font-weight:200;margin-bottom:8px}
        #lock .date{color:var(--fg2);margin-bottom:60px}
        #lock .avatar{width:96px;height:96px;border-radius:50%;background:var(--accent2);display:flex;align-items:center;justify-content:center;font-size:40px;margin-bottom:16px}
        #lock .user{font-size:18px;margin-bottom:24px}
        #lock input{width:240px;padding:12px 16px;border:1px solid var(--bg4);border-radius:20px;background:var(--bg2);color:var(--fg);text-align:center;outline:none}
        #lock input:focus{border-color:var(--accent)}
        #lock .hint{margin-top:16px;color:var(--fg2);font-size:12px}

        /* Desktop */
        #desktop{position:fixed;inset:0;bottom:var(--taskbar);display:none;background:linear-gradient(135deg,#0d1117 0%,#161b22 50%,#1a1f29 100%)}
        #desktop-icons{display:grid;grid-template-columns:repeat(auto-fill,80px);grid-auto-rows:90px;gap:4px;padding:12px;align-content:start}
        .dicon{padding:8px;text-align:center;border-radius:var(--radius);cursor:pointer;transition:background .15s}
        .dicon:hover{background:rgba(255,255,255,.08)}
        .dicon.sel{background:rgba(88,166,255,.2)}
        .dicon-img{font-size:32px;margin-bottom:4px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
        .dicon-lbl{font-size:11px;text-shadow:0 1px 3px #000;word-break:break-word;line-height:1.3}

        /* Taskbar */
        #taskbar{position:fixed;bottom:0;left:0;right:0;height:var(--taskbar);background:rgba(22,27,34,.85);backdrop-filter:blur(20px);display:none;align-items:center;padding:0 8px;border-top:1px solid var(--bg4);z-index:1000}
        #start-btn{width:40px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius);cursor:pointer;font-size:18px;transition:background .15s}
        #start-btn:hover{background:rgba(255,255,255,.1)}
        #taskbar-apps{flex:1;display:flex;gap:2px;padding:0 8px;overflow-x:auto}
        .tapp{height:36px;min-width:44px;max-width:180px;display:flex;align-items:center;gap:8px;padding:0 12px;border-radius:var(--radius);cursor:pointer;transition:background .15s;border-bottom:2px solid transparent}
        .tapp:hover{background:rgba(255,255,255,.08)}
        .tapp.active{background:rgba(255,255,255,.1);border-bottom-color:var(--accent)}
        .tapp-icon{font-size:16px}
        .tapp-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px}
        #tray{display:flex;align-items:center;gap:4px;padding:0 8px}
        .tray-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius);cursor:pointer;font-size:14px}
        .tray-btn:hover{background:rgba(255,255,255,.1)}
        #clock{padding:6px 12px;text-align:right;font-size:12px;line-height:1.4;border-radius:var(--radius);cursor:pointer}
        #clock:hover{background:rgba(255,255,255,.1)}

        /* Start Menu */
        #start{position:fixed;bottom:calc(var(--taskbar) + 8px);left:8px;width:560px;max-width:calc(100vw - 16px);background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;display:none;flex-direction:column;z-index:2000;box-shadow:var(--shadow);max-height:calc(100vh - 70px)}
        #start-search{padding:12px}
        #start-search input{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--fg);outline:none}
        #start-search input:focus{border-color:var(--accent)}
        #start-grid{flex:1;overflow-y:auto;padding:8px 12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:4px}
        .sapp{padding:12px 8px;text-align:center;border-radius:var(--radius);cursor:pointer;transition:background .15s}
        .sapp:hover{background:rgba(255,255,255,.08)}
        .sapp-icon{font-size:28px;margin-bottom:6px}
        .sapp-name{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        #start-footer{padding:12px;border-top:1px solid var(--bg4);display:flex;justify-content:space-between;align-items:center}
        #start-user{display:flex;align-items:center;gap:10px}
        #start-avatar{width:32px;height:32px;border-radius:50%;background:var(--accent2);display:flex;align-items:center;justify-content:center;font-size:14px}
        #start-power{display:flex;gap:4px}
        #start-power button{width:32px;height:32px;background:transparent;border:none;color:var(--fg);border-radius:var(--radius);cursor:pointer;font-size:14px}
        #start-power button:hover{background:rgba(255,255,255,.1)}

        /* Windows */
        .win{position:absolute;background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;display:flex;flex-direction:column;box-shadow:var(--shadow);min-width:280px;min-height:180px;overflow:hidden}
        .win.max{inset:0!important;width:100%!important;height:calc(100vh - var(--taskbar))!important;border-radius:0;border:none}
        .win.min{display:none}
        .win-head{height:36px;background:var(--bg);display:flex;align-items:center;padding:0 8px;cursor:move;flex-shrink:0;gap:8px}
        .win-icon{font-size:14px}
        .win-title{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .win-btns{display:flex}
        .win-btn{width:36px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s;font-size:11px}
        .win-btn:hover{background:rgba(255,255,255,.1)}
        .win-btn.close:hover{background:#f85149}
        .win-body{flex:1;overflow:auto;background:var(--bg)}
        .win-resize{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:se-resize}

        /* Quick Settings */
        #qpanel{position:fixed;bottom:calc(var(--taskbar) + 8px);right:8px;width:320px;background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;display:none;padding:16px;z-index:2000;box-shadow:var(--shadow)}
        .qrow{display:flex;gap:8px;margin-bottom:12px}
        .qtile{flex:1;padding:12px;background:var(--bg3);border-radius:var(--radius);text-align:center;cursor:pointer;transition:background .15s}
        .qtile:hover{background:var(--bg4)}
        .qtile.on{background:var(--accent2)}
        .qtile-icon{font-size:20px;margin-bottom:4px}
        .qtile-label{font-size:11px}
        .qslider{margin-bottom:12px}
        .qslider label{display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px}
        .qslider input{width:100%;accent-color:var(--accent)}

        /* Notifications */
        #notifs{position:fixed;top:12px;right:12px;width:320px;display:flex;flex-direction:column;gap:8px;z-index:5000;pointer-events:none}
        .notif{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:12px;animation:slideIn .2s;pointer-events:auto;box-shadow:var(--shadow)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}}
        .notif-head{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-weight:500}
        .notif-body{font-size:12px;color:var(--fg2)}

        /* Context Menu */
        #ctx{position:fixed;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);min-width:180px;display:none;z-index:6000;padding:4px 0;box-shadow:var(--shadow)}
        .ctx-item{padding:8px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:12px}
        .ctx-item:hover{background:rgba(255,255,255,.08)}
        .ctx-sep{height:1px;background:var(--bg4);margin:4px 0}

        /* Spotlight Search */
        #spotlight{position:fixed;top:20%;left:50%;transform:translateX(-50%);width:560px;max-width:calc(100vw - 40px);background:var(--bg2);border:1px solid var(--bg4);border-radius:12px;display:none;z-index:8000;box-shadow:0 20px 60px rgba(0,0,0,.5)}
        #spotlight input{width:100%;padding:16px 20px;background:transparent;border:none;color:var(--fg);font-size:18px;outline:none}
        #spotlight-results{max-height:300px;overflow-y:auto;border-top:1px solid var(--bg4)}
        .spot-item{padding:12px 20px;cursor:pointer;display:flex;align-items:center;gap:12px}
        .spot-item:hover,.spot-item.sel{background:rgba(255,255,255,.08)}
        .spot-icon{font-size:24px}
        .spot-info{flex:1}
        .spot-title{font-weight:500}
        .spot-sub{font-size:11px;color:var(--fg2)}

        /* App Styles */

        /* File Explorer */
        .files{display:flex;height:100%}
        .files-side{width:180px;background:var(--bg);border-right:1px solid var(--bg4);padding:8px;flex-shrink:0;overflow-y:auto}
        .files-side-item{padding:8px 10px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:8px;font-size:12px;margin-bottom:2px}
        .files-side-item:hover,.files-side-item.sel{background:rgba(255,255,255,.08)}
        .files-main{flex:1;display:flex;flex-direction:column;min-width:0}
        .files-toolbar{padding:8px;background:var(--bg2);border-bottom:1px solid var(--bg4);display:flex;gap:8px;align-items:center}
        .files-path{flex:1;padding:6px 10px;background:var(--bg);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--fg);font-size:12px}
        .files-grid{flex:1;padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;align-content:start;overflow-y:auto}
        .file{padding:12px 8px;text-align:center;border-radius:var(--radius);cursor:pointer;transition:background .15s}
        .file:hover{background:rgba(255,255,255,.08)}
        .file.sel{background:rgba(88,166,255,.2)}
        .file-icon{font-size:36px;margin-bottom:6px}
        .file-name{font-size:11px;word-break:break-word;line-height:1.3}

        /* Terminal */
        .term{height:100%;background:#0c0c0c;font-family:'Cascadia Code','Fira Code',Consolas,monospace;padding:12px;overflow-y:auto;font-size:13px;line-height:1.5}
        .term-line{white-space:pre-wrap;word-break:break-all}
        .term-prompt{color:var(--green)}
        .term-input{display:flex}
        .term-input input{flex:1;background:transparent;border:none;color:#d4d4d4;font:inherit;outline:none}

        /* Editor */
        .editor{display:flex;flex-direction:column;height:100%}
        .editor-bar{padding:6px 8px;background:var(--bg2);border-bottom:1px solid var(--bg4);display:flex;gap:4px}
        .editor-bar button{padding:4px 10px;background:transparent;border:none;color:var(--fg);border-radius:var(--radius);cursor:pointer;font-size:12px}
        .editor-bar button:hover{background:rgba(255,255,255,.1)}
        .editor textarea{flex:1;background:var(--bg);border:none;color:var(--fg);padding:12px;font-family:'Cascadia Code',Consolas,monospace;font-size:13px;resize:none;outline:none;line-height:1.6}

        /* Code Editor */
        .code{display:flex;flex-direction:column;height:100%}
        .code-tabs{display:flex;background:var(--bg);border-bottom:1px solid var(--bg4);padding:0 8px}
        .code-tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;font-size:12px;display:flex;align-items:center;gap:6px}
        .code-tab:hover{background:rgba(255,255,255,.05)}
        .code-tab.active{border-bottom-color:var(--accent);background:var(--bg2)}
        .code-tab .close{opacity:0;margin-left:4px}
        .code-tab:hover .close{opacity:1}
        .code-body{display:flex;flex:1;overflow:hidden}
        .code-lines{width:40px;background:var(--bg);border-right:1px solid var(--bg4);padding:12px 8px;text-align:right;color:var(--fg2);font-family:'Cascadia Code',Consolas,monospace;font-size:13px;line-height:1.6;overflow:hidden}
        .code-area{flex:1;background:var(--bg2);padding:12px;font-family:'Cascadia Code',Consolas,monospace;font-size:13px;line-height:1.6;overflow:auto;white-space:pre;color:var(--fg);outline:none}

        /* Calculator */
        .calc{padding:16px;max-width:280px;margin:0 auto}
        .calc-display{background:var(--bg);padding:16px;text-align:right;font-size:28px;border-radius:var(--radius);margin-bottom:12px;font-family:'Cascadia Code',monospace;overflow:hidden}
        .calc-btns{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
        .calc-btn{padding:16px;font-size:18px;border:none;border-radius:var(--radius);cursor:pointer;background:var(--bg3);color:var(--fg);transition:background .15s}
        .calc-btn:hover{background:var(--bg4)}
        .calc-btn.op{background:var(--accent2)}
        .calc-btn.eq{background:var(--green);grid-column:span 2}

        /* Settings */
        .settings{display:flex;height:100%}
        .settings-nav{width:200px;background:var(--bg);border-right:1px solid var(--bg4);padding:12px 8px;overflow-y:auto}
        .settings-nav-item{padding:10px 12px;border-radius:var(--radius);cursor:pointer;display:flex;align-items:center;gap:10px;margin-bottom:2px}
        .settings-nav-item:hover,.settings-nav-item.active{background:rgba(255,255,255,.08)}
        .settings-body{flex:1;padding:24px;overflow-y:auto}
        .settings-title{font-size:20px;margin-bottom:20px}
        .settings-section{margin-bottom:24px}
        .settings-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--bg4)}
        .settings-row h4{margin-bottom:2px}
        .settings-row p{font-size:11px;color:var(--fg2)}
        .toggle{width:44px;height:24px;background:var(--bg4);border-radius:12px;cursor:pointer;position:relative;transition:background .2s}
        .toggle.on{background:var(--accent2)}
        .toggle::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform .2s}
        .toggle.on::after{transform:translateX(20px)}

        /* Browser */
        .browser{display:flex;flex-direction:column;height:100%}
        .browser-bar{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg2)}
        .browser-nav{display:flex;gap:4px}
        .browser-nav button{width:28px;height:28px;background:var(--bg3);border:none;border-radius:50%;color:var(--fg);cursor:pointer;font-size:12px}
        .browser-nav button:hover{background:var(--bg4)}
        .browser-url{flex:1;padding:8px 14px;background:var(--bg);border:1px solid var(--bg4);border-radius:20px;color:var(--fg);font-size:12px;outline:none}
        .browser-url:focus{border-color:var(--accent)}
        .browser-open-external{padding:6px 12px;background:var(--accent2);border:none;border-radius:16px;color:#fff;cursor:pointer;font-size:11px;white-space:nowrap}
        .browser-open-external:hover{background:var(--accent)}
        .browser-content{flex:1;position:relative;overflow:hidden}
        .browser-frame{width:100%;height:100%;border:none;background:#fff}
        .browser-blocked{position:absolute;inset:0;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;padding:32px;text-align:center}
        .browser-blocked.show{display:flex}
        .browser-blocked-icon{font-size:64px;margin-bottom:16px;opacity:.6}
        .browser-blocked-title{font-size:20px;font-weight:600;margin-bottom:8px}
        .browser-blocked-msg{color:var(--fg2);max-width:400px;line-height:1.6;margin-bottom:24px}
        .browser-blocked-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:32px}
        .browser-blocked-btn{padding:10px 20px;border-radius:var(--radius);border:none;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px}
        .browser-blocked-btn.primary{background:var(--accent2);color:#fff}
        .browser-blocked-btn.primary:hover{background:var(--accent)}
        .browser-blocked-btn.secondary{background:var(--bg3);color:var(--fg)}
        .browser-blocked-btn.secondary:hover{background:var(--bg4)}
        .browser-suggestions{border-top:1px solid var(--bg4);padding-top:24px;width:100%;max-width:500px}
        .browser-suggestions h4{margin-bottom:12px;color:var(--fg2);font-weight:500}
        .browser-suggest-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
        .browser-suggest-item{padding:10px;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);cursor:pointer;text-align:center;font-size:12px;transition:all .15s}
        .browser-suggest-item:hover{background:var(--bg3);border-color:var(--accent)}
        .browser-suggest-icon{font-size:20px;margin-bottom:4px}
        .browser-loading{position:absolute;inset:0;background:var(--bg);display:none;align-items:center;justify-content:center}
        .browser-loading.show{display:flex}
        .browser-spinner{width:32px;height:32px;border:3px solid var(--bg4);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .browser-mode-toggle{padding:4px 10px;background:var(--bg3);border:1px solid var(--bg4);border-radius:12px;color:var(--fg2);cursor:pointer;font-size:10px;display:flex;align-items:center;gap:4px}
        .browser-mode-toggle:hover{background:var(--bg4)}
        .browser-mode-toggle.active{background:var(--green);border-color:var(--green);color:#fff}
        .browser-reader{position:absolute;inset:0;background:var(--bg);overflow-y:auto;padding:32px;display:none}
        .browser-reader.show{display:block}
        .browser-reader-content{max-width:700px;margin:0 auto;font-size:16px;line-height:1.8;color:var(--fg)}
        .browser-reader-content h1,.browser-reader-content h2,.browser-reader-content h3{margin:24px 0 12px}
        .browser-reader-content p{margin-bottom:16px}
        .browser-reader-content img{max-width:100%;height:auto;border-radius:8px;margin:16px 0}
        .browser-reader-content a{color:var(--accent)}
        .browser-reader-content pre,.browser-reader-content code{background:var(--bg2);padding:2px 6px;border-radius:4px;font-family:monospace}
        .browser-reader-content pre{padding:16px;overflow-x:auto;margin:16px 0}
        .browser-reader-header{text-align:center;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--bg4)}
        .browser-reader-title{font-size:28px;font-weight:600;margin-bottom:8px}
        .browser-reader-source{font-size:12px;color:var(--fg2)}
        .browser-fetch-status{position:absolute;top:8px;right:8px;padding:6px 12px;background:var(--bg2);border:1px solid var(--bg4);border-radius:16px;font-size:11px;display:none;align-items:center;gap:6px;z-index:10}
        .browser-fetch-status.show{display:flex}

        /* DevTools */
        .devtools{display:none;flex-direction:column;height:280px;min-height:150px;max-height:60%;background:#1e1e1e;border-top:1px solid #3c3c3c;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:11px;color:#d4d4d4}
        .devtools.open{display:flex}
        .devtools-header{display:flex;align-items:center;background:#252526;border-bottom:1px solid #3c3c3c;padding:0 8px;height:32px;flex-shrink:0}
        .devtools-tabs{display:flex;gap:0;flex:1}
        .devtools-tab{padding:8px 14px;cursor:pointer;border-bottom:2px solid transparent;color:#969696;white-space:nowrap}
        .devtools-tab:hover{color:#d4d4d4;background:#2d2d2d}
        .devtools-tab.active{color:#75beff;border-bottom-color:#75beff}
        .devtools-actions{display:flex;gap:4px;margin-left:auto}
        .devtools-btn{width:24px;height:24px;border:none;background:transparent;color:#969696;cursor:pointer;border-radius:4px;font-size:12px}
        .devtools-btn:hover{background:#3c3c3c;color:#d4d4d4}
        .devtools-resize{height:4px;background:#252526;cursor:ns-resize}
        .devtools-resize:hover{background:#007acc}
        .devtools-body{flex:1;overflow:hidden;display:flex}
        .devtools-panel{display:none;flex:1;overflow:auto}
        .devtools-panel.active{display:flex}

        /* Elements Panel */
        .dt-elements{display:flex;flex:1}
        .dt-dom-tree{flex:1;overflow:auto;padding:8px;border-right:1px solid #3c3c3c}
        .dt-dom-node{padding:2px 0;cursor:pointer;white-space:nowrap}
        .dt-dom-node:hover{background:#2d2d2d}
        .dt-dom-node.selected{background:#264f78}
        .dt-dom-expand{width:16px;display:inline-block;color:#969696;cursor:pointer}
        .dt-dom-tag{color:#569cd6}
        .dt-dom-attr{color:#9cdcfe}
        .dt-dom-attr-val{color:#ce9178}
        .dt-dom-text{color:#d4d4d4;font-style:italic;opacity:.7}
        .dt-dom-comment{color:#6a9955;font-style:italic}
        .dt-dom-children{padding-left:16px}
        .dt-styles{width:280px;overflow:auto;padding:8px;background:#1e1e1e}
        .dt-styles-section{margin-bottom:12px}
        .dt-styles-title{color:#569cd6;font-weight:bold;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid #3c3c3c}
        .dt-style-prop{display:flex;padding:2px 0}
        .dt-style-name{color:#9cdcfe;min-width:120px}
        .dt-style-val{color:#ce9178;word-break:break-all}
        .dt-box-model{padding:16px;text-align:center}
        .dt-box{position:relative;display:inline-block}
        .dt-box-margin{background:rgba(249,204,157,.2);padding:12px;border:1px dashed rgba(249,204,157,.4)}
        .dt-box-border{background:rgba(253,221,155,.3);padding:12px}
        .dt-box-padding{background:rgba(195,222,183,.3);padding:12px}
        .dt-box-content{background:rgba(164,206,249,.3);padding:16px 24px;min-width:60px}
        .dt-box-label{position:absolute;font-size:9px;color:#969696}
        .dt-box-val{font-size:10px;color:#d4d4d4}

        /* Console Panel */
        .dt-console{flex-direction:column;flex:1}
        .dt-console-toolbar{display:flex;gap:8px;padding:6px 8px;background:#252526;border-bottom:1px solid #3c3c3c}
        .dt-console-toolbar button{padding:4px 8px;background:#3c3c3c;border:none;border-radius:3px;color:#d4d4d4;cursor:pointer;font-size:10px}
        .dt-console-toolbar button:hover{background:#4c4c4c}
        .dt-console-filter{padding:4px 8px;background:#3c3c3c;border:1px solid #3c3c3c;border-radius:3px;color:#d4d4d4;font-size:10px;outline:none}
        .dt-console-filter:focus{border-color:#007acc}
        .dt-console-logs{flex:1;overflow:auto;padding:4px}
        .dt-log{padding:4px 8px;border-bottom:1px solid #2d2d2d;display:flex;align-items:flex-start;gap:8px}
        .dt-log:hover{background:#2d2d2d}
        .dt-log-icon{width:14px;text-align:center;flex-shrink:0}
        .dt-log.log .dt-log-icon{color:#d4d4d4}
        .dt-log.warn{background:rgba(255,204,0,.1)}
        .dt-log.warn .dt-log-icon{color:#ffcc00}
        .dt-log.error{background:rgba(255,85,85,.1)}
        .dt-log.error .dt-log-icon{color:#f44}
        .dt-log.info .dt-log-icon{color:#75beff}
        .dt-log-content{flex:1;word-break:break-all}
        .dt-log-time{color:#666;font-size:10px;flex-shrink:0}
        .dt-console-input{display:flex;padding:8px;background:#252526;border-top:1px solid #3c3c3c}
        .dt-console-prompt{color:#569cd6;margin-right:8px}
        .dt-console-input input{flex:1;background:transparent;border:none;color:#d4d4d4;font-family:inherit;font-size:11px;outline:none}
        .dt-object{color:#9cdcfe}
        .dt-string{color:#ce9178}
        .dt-number{color:#b5cea8}
        .dt-boolean{color:#569cd6}
        .dt-null{color:#569cd6}
        .dt-undefined{color:#666}
        .dt-function{color:#dcdcaa;font-style:italic}

        /* Sources Panel */
        .dt-sources{display:flex;flex:1}
        .dt-sources-sidebar{width:180px;background:#252526;border-right:1px solid #3c3c3c;overflow:auto}
        .dt-sources-file{padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:6px}
        .dt-sources-file:hover{background:#2d2d2d}
        .dt-sources-file.active{background:#37373d}
        .dt-sources-file-icon{font-size:12px}
        .dt-sources-code{flex:1;overflow:auto;padding:0}
        .dt-code-line{display:flex;padding:0 8px;min-height:18px;line-height:18px}
        .dt-code-line:hover{background:#2d2d2d}
        .dt-code-num{width:40px;color:#5a5a5a;text-align:right;padding-right:12px;user-select:none;flex-shrink:0}
        .dt-code-content{white-space:pre;flex:1}
        .dt-syntax-tag{color:#569cd6}
        .dt-syntax-attr{color:#9cdcfe}
        .dt-syntax-string{color:#ce9178}
        .dt-syntax-comment{color:#6a9955}
        .dt-syntax-keyword{color:#c586c0}
        .dt-syntax-function{color:#dcdcaa}
        .dt-syntax-number{color:#b5cea8}

        /* Network Panel */
        .dt-network{flex-direction:column;flex:1}
        .dt-network-toolbar{display:flex;gap:8px;padding:6px 8px;background:#252526;border-bottom:1px solid #3c3c3c;align-items:center}
        .dt-network-list{flex:1;overflow:auto}
        .dt-network-header,.dt-network-row{display:grid;grid-template-columns:30px 1fr 80px 80px 80px 60px;gap:8px;padding:6px 8px;border-bottom:1px solid #2d2d2d;align-items:center}
        .dt-network-header{background:#252526;font-weight:bold;color:#969696;position:sticky;top:0}
        .dt-network-row:hover{background:#2d2d2d}
        .dt-network-row.selected{background:#264f78}
        .dt-network-status{width:24px;height:16px;border-radius:3px;font-size:9px;display:flex;align-items:center;justify-content:center}
        .dt-network-status.s2{background:#4caf50;color:#fff}
        .dt-network-status.s3{background:#ff9800;color:#fff}
        .dt-network-status.s4,.dt-network-status.s5{background:#f44;color:#fff}
        .dt-network-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .dt-network-detail{width:300px;background:#252526;border-left:1px solid #3c3c3c;overflow:auto;padding:8px;display:none}
        .dt-network-detail.show{display:block}
        .dt-network-detail-section{margin-bottom:16px}
        .dt-network-detail h4{color:#569cd6;margin-bottom:8px;font-size:11px}
        .dt-network-timing{height:8px;background:#3c3c3c;border-radius:2px;overflow:hidden;margin-bottom:4px}
        .dt-network-timing-bar{height:100%;background:#4caf50}

        /* Storage Panel */
        .dt-storage{display:flex;flex:1}
        .dt-storage-sidebar{width:160px;background:#252526;border-right:1px solid #3c3c3c;overflow:auto}
        .dt-storage-cat{padding:8px 12px;cursor:pointer}
        .dt-storage-cat:hover{background:#2d2d2d}
        .dt-storage-cat.active{background:#37373d;color:#75beff}
        .dt-storage-content{flex:1;overflow:auto;padding:8px}
        .dt-storage-table{width:100%;border-collapse:collapse}
        .dt-storage-table th,.dt-storage-table td{padding:6px 8px;text-align:left;border-bottom:1px solid #3c3c3c}
        .dt-storage-table th{background:#252526;color:#969696;position:sticky;top:0}
        .dt-storage-table td{cursor:pointer}
        .dt-storage-table tr:hover td{background:#2d2d2d}
        .dt-storage-key{color:#9cdcfe;max-width:150px;overflow:hidden;text-overflow:ellipsis}
        .dt-storage-val{color:#ce9178;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .dt-storage-actions{margin-bottom:12px;display:flex;gap:8px}
        .dt-storage-actions button{padding:4px 10px;background:#3c3c3c;border:none;border-radius:3px;color:#d4d4d4;cursor:pointer;font-size:10px}
        .dt-storage-actions button:hover{background:#4c4c4c}
        .dt-storage-actions button.danger:hover{background:#f44}

        /* Performance Panel */
        .dt-perf{flex-direction:column;flex:1;padding:12px}
        .dt-perf-section{margin-bottom:16px}
        .dt-perf-title{color:#569cd6;font-weight:bold;margin-bottom:8px}
        .dt-perf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
        .dt-perf-card{background:#252526;padding:12px;border-radius:4px;text-align:center}
        .dt-perf-value{font-size:24px;font-weight:bold;color:#75beff;margin-bottom:4px}
        .dt-perf-label{font-size:10px;color:#969696}
        .dt-perf-bar{height:20px;background:#3c3c3c;border-radius:3px;overflow:hidden;margin-bottom:8px}
        .dt-perf-bar-fill{height:100%;transition:width .3s}
        .dt-perf-bar-fill.good{background:#4caf50}
        .dt-perf-bar-fill.warn{background:#ff9800}
        .dt-perf-bar-fill.bad{background:#f44}
        .dt-perf-list{background:#252526;padding:8px;border-radius:4px}
        .dt-perf-item{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #3c3c3c}
        .dt-perf-item:last-child{border-bottom:none}

        /* Tasks/Todo */
        .tasks{padding:16px;max-width:600px;margin:0 auto}
        .tasks-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .tasks-add{display:flex;gap:8px;margin-bottom:16px}
        .tasks-add input{flex:1;padding:10px 14px;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--fg);outline:none}
        .tasks-add button{padding:10px 20px;background:var(--accent2);border:none;border-radius:var(--radius);color:#fff;cursor:pointer}
        .task{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg2);border-radius:var(--radius);margin-bottom:8px}
        .task-check{width:20px;height:20px;border:2px solid var(--bg4);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .task-check.done{background:var(--green);border-color:var(--green)}
        .task-text{flex:1}
        .task.done .task-text{text-decoration:line-through;opacity:.5}
        .task-del{opacity:0;cursor:pointer;color:var(--red)}
        .task:hover .task-del{opacity:1}

        /* Calendar */
        .calendar{padding:16px}
        .cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .cal-title{font-size:18px}
        .cal-nav{display:flex;gap:8px}
        .cal-nav button{padding:6px 12px;background:var(--bg3);border:none;border-radius:var(--radius);color:var(--fg);cursor:pointer}
        .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .cal-day-head{padding:8px;text-align:center;font-size:11px;color:var(--fg2)}
        .cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;font-size:13px}
        .cal-day:hover{background:rgba(255,255,255,.1)}
        .cal-day.today{background:var(--accent2)}
        .cal-day.other{opacity:.3}

        /* Notes */
        .notes{display:flex;height:100%}
        .notes-list{width:220px;background:var(--bg);border-right:1px solid var(--bg4);display:flex;flex-direction:column}
        .notes-list-head{padding:12px;border-bottom:1px solid var(--bg4);display:flex;justify-content:space-between;align-items:center}
        .notes-list-body{flex:1;overflow-y:auto}
        .note-item{padding:12px;border-bottom:1px solid var(--bg4);cursor:pointer}
        .note-item:hover,.note-item.active{background:rgba(255,255,255,.05)}
        .note-item-title{font-weight:500;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .note-item-preview{font-size:11px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .note-item-date{font-size:10px;color:var(--fg2);margin-top:4px}
        .notes-editor{flex:1;display:flex;flex-direction:column}
        .notes-editor-title{padding:12px;background:var(--bg2);border-bottom:1px solid var(--bg4)}
        .notes-editor-title input{width:100%;background:transparent;border:none;color:var(--fg);font-size:16px;font-weight:500;outline:none}
        .notes-editor-body{flex:1;padding:12px}
        .notes-editor-body textarea{width:100%;height:100%;background:transparent;border:none;color:var(--fg);font-size:13px;line-height:1.6;resize:none;outline:none}

        /* Photo Editor */
        .photo{display:flex;flex-direction:column;height:100%}
        .photo-bar{padding:8px;background:var(--bg2);border-bottom:1px solid var(--bg4);display:flex;gap:8px;align-items:center}
        .photo-bar button{padding:6px 12px;background:var(--bg3);border:none;border-radius:var(--radius);color:var(--fg);cursor:pointer;font-size:12px}
        .photo-bar button:hover{background:var(--bg4)}
        .photo-filters{display:flex;gap:4px}
        .photo-filter{padding:4px 8px;background:var(--bg3);border:none;border-radius:var(--radius);color:var(--fg);cursor:pointer;font-size:11px}
        .photo-filter:hover,.photo-filter.active{background:var(--accent2)}
        .photo-canvas-wrap{flex:1;display:flex;align-items:center;justify-content:center;background:#1a1a1a;overflow:hidden}
        .photo-canvas{max-width:100%;max-height:100%}

        /* Markdown */
        .md{display:flex;height:100%}
        .md-edit{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--bg4)}
        .md-edit textarea{flex:1;background:var(--bg);border:none;color:var(--fg);padding:12px;font-family:'Cascadia Code',monospace;font-size:13px;resize:none;outline:none;line-height:1.6}
        .md-preview{flex:1;padding:16px;overflow-y:auto;background:var(--bg2)}
        .md-preview h1,.md-preview h2,.md-preview h3{margin-bottom:12px}
        .md-preview p{margin-bottom:8px;line-height:1.6}
        .md-preview code{background:var(--bg);padding:2px 6px;border-radius:3px;font-family:monospace}
        .md-preview pre{background:var(--bg);padding:12px;border-radius:var(--radius);overflow-x:auto;margin-bottom:12px}

        /* Music */
        .music{padding:24px;text-align:center}
        .music-cover{width:180px;height:180px;background:linear-gradient(135deg,var(--accent2),var(--purple));border-radius:8px;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:60px}
        .music-title{font-size:18px;margin-bottom:4px}
        .music-artist{color:var(--fg2);margin-bottom:20px}
        .music-progress{height:4px;background:var(--bg3);border-radius:2px;margin-bottom:8px;overflow:hidden}
        .music-progress-bar{height:100%;background:var(--accent);width:35%}
        .music-times{display:flex;justify-content:space-between;font-size:11px;color:var(--fg2);margin-bottom:20px}
        .music-controls{display:flex;justify-content:center;align-items:center;gap:16px}
        .music-btn{width:44px;height:44px;border-radius:50%;background:var(--bg3);border:none;color:var(--fg);cursor:pointer;font-size:18px}
        .music-btn.play{width:56px;height:56px;background:var(--accent2)}

        /* Weather */
        .weather{padding:24px;background:linear-gradient(135deg,#1e3a5f,#2d5a87);height:100%;text-align:center}
        .weather-icon{font-size:64px;margin-bottom:8px}
        .weather-temp{font-size:56px;font-weight:200;margin-bottom:4px}
        .weather-desc{font-size:18px;margin-bottom:24px}
        .weather-details{display:flex;justify-content:center;gap:32px}
        .weather-detail{text-align:center}
        .weather-detail-val{font-size:20px;margin-bottom:2px}
        .weather-detail-lbl{font-size:11px;opacity:.7}

        /* Task Manager */
        .taskmgr{padding:12px}
        .taskmgr table{width:100%;border-collapse:collapse}
        .taskmgr th,.taskmgr td{padding:10px;text-align:left;border-bottom:1px solid var(--bg4)}
        .taskmgr th{background:var(--bg2);font-weight:500}
        .taskmgr tr:hover{background:rgba(255,255,255,.03)}

        /* Clock Widget */
        .clock-widget{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg)}
        .clock-time{font-size:72px;font-weight:200}
        .clock-date{font-size:18px;color:var(--fg2);margin-top:8px}
        .clock-seconds{font-size:14px;color:var(--fg2);margin-top:4px}

        /* About */
        .about{padding:32px;text-align:center}
        .about-logo{font-size:64px;margin-bottom:16px}
        .about-title{font-size:28px;margin-bottom:4px}
        .about-ver{color:var(--fg2);margin-bottom:24px}
        .about-info{max-width:360px;margin:0 auto;text-align:left}
        .about-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bg4)}

        /* Recursive */
        .recursive-frame{width:100%;height:100%;border:none}

        /* Scrollbar */
        ::-webkit-scrollbar{width:8px;height:8px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:4px}
        ::-webkit-scrollbar-thumb:hover{background:var(--fg2)}

        /* WASM Runtime Loader */
        .wasm-loader{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:10}
        .wasm-loader-icon{font-size:64px;margin-bottom:24px;animation:wasm-pulse 2s infinite}
        @keyframes wasm-pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.7}}
        .wasm-loader-title{font-size:18px;font-weight:600;margin-bottom:8px}
        .wasm-loader-status{color:var(--fg2);margin-bottom:24px;text-align:center;max-width:300px}
        .wasm-loader-bar{width:280px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-bottom:12px}
        .wasm-loader-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--purple));width:0;transition:width .3s;border-radius:3px}
        .wasm-loader-percent{font-size:14px;color:var(--accent);font-weight:600;margin-bottom:24px}
        .wasm-loader-size{font-size:12px;color:var(--fg2)}
        .wasm-loader-cached{display:flex;align-items:center;gap:8px;color:var(--green);font-size:13px;margin-top:12px}
        .wasm-loader-btn{margin-top:20px;padding:10px 24px;background:var(--accent2);border:none;color:#fff;border-radius:var(--radius);cursor:pointer;font-size:13px}
        .wasm-loader-btn:hover{background:var(--accent)}

        /* Python IDE */
        .pyide{display:flex;flex-direction:column;height:100%}
        .pyide-toolbar{display:flex;gap:4px;padding:8px;background:var(--bg2);border-bottom:1px solid var(--bg4)}
        .pyide-toolbar button{padding:6px 12px;background:var(--bg3);border:none;color:var(--fg);border-radius:var(--radius);cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px}
        .pyide-toolbar button:hover{background:var(--bg4)}
        .pyide-toolbar button.run{background:var(--green);color:#000}
        .pyide-toolbar button.run:hover{background:#4eca61}
        .pyide-main{display:flex;flex:1;overflow:hidden}
        .pyide-editor{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--bg4)}
        .pyide-code{flex:1;background:#1e1e1e;font-family:'Cascadia Code','Fira Code',Consolas,monospace;font-size:13px;line-height:1.6;padding:12px;color:#d4d4d4;resize:none;border:none;outline:none;overflow:auto}
        .pyide-output{width:40%;display:flex;flex-direction:column;min-width:200px}
        .pyide-output-header{padding:8px 12px;background:var(--bg2);border-bottom:1px solid var(--bg4);font-size:12px;font-weight:600}
        .pyide-console{flex:1;background:#0c0c0c;font-family:'Cascadia Code',Consolas,monospace;font-size:12px;padding:12px;overflow:auto;white-space:pre-wrap;color:#d4d4d4}
        .pyide-console .error{color:var(--red)}
        .pyide-console .success{color:var(--green)}
        .pyide-repl{display:flex;background:#0c0c0c;border-top:1px solid var(--bg4);padding:8px 12px}
        .pyide-repl input{flex:1;background:transparent;border:none;color:#d4d4d4;font-family:inherit;font-size:12px;outline:none}
        .pyide-repl-prompt{color:var(--green);margin-right:8px}

        /* VM/Emulator */
        .vm-container{height:100%;display:flex;flex-direction:column;background:#000}
        .vm-toolbar{display:flex;gap:4px;padding:6px 8px;background:var(--bg2);border-bottom:1px solid var(--bg4)}
        .vm-toolbar button{padding:4px 10px;background:transparent;border:none;color:var(--fg);border-radius:var(--radius);cursor:pointer;font-size:12px}
        .vm-toolbar button:hover{background:rgba(255,255,255,.1)}
        .vm-toolbar .status{margin-left:auto;color:var(--fg2);font-size:11px;display:flex;align-items:center;gap:6px}
        .vm-toolbar .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 1s infinite}
        @keyframes blink{50%{opacity:.5}}
        .vm-screen{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .vm-screen canvas,.vm-screen iframe{max-width:100%;max-height:100%}

        /* Video Editor */
        .videoeditor{display:flex;flex-direction:column;height:100%}
        .videoeditor-toolbar{display:flex;gap:4px;padding:8px;background:var(--bg2);border-bottom:1px solid var(--bg4);flex-wrap:wrap}
        .videoeditor-toolbar button{padding:6px 12px;background:var(--bg3);border:none;color:var(--fg);border-radius:var(--radius);cursor:pointer;font-size:12px}
        .videoeditor-toolbar button:hover{background:var(--bg4)}
        .videoeditor-main{flex:1;display:flex;overflow:hidden}
        .videoeditor-preview{flex:1;display:flex;align-items:center;justify-content:center;background:#000;min-height:200px}
        .videoeditor-preview video{max-width:100%;max-height:100%}
        .videoeditor-sidebar{width:280px;background:var(--bg2);border-left:1px solid var(--bg4);overflow-y:auto}
        .videoeditor-section{padding:12px;border-bottom:1px solid var(--bg4)}
        .videoeditor-section-title{font-size:11px;color:var(--fg2);text-transform:uppercase;margin-bottom:8px}
        .videoeditor-timeline{height:120px;background:var(--bg);border-top:1px solid var(--bg4);padding:8px}
        .videoeditor-drop{border:2px dashed var(--bg4);border-radius:var(--radius);padding:40px;text-align:center;color:var(--fg2)}

        /* Dev Environment */
        .devenv{display:flex;flex-direction:column;height:100%;background:var(--bg)}
        .devenv-toolbar{display:flex;gap:6px;padding:8px 12px;background:var(--bg2);border-bottom:1px solid var(--bg4);align-items:center}
        .devenv-toolbar input{flex:1;padding:8px 12px;background:var(--bg);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--fg);font-size:13px}
        .devenv-toolbar input:focus{border-color:var(--accent);outline:none}
        .devenv-toolbar button{padding:8px 16px;background:var(--accent2);border:none;color:#fff;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:500}
        .devenv-toolbar button:hover{background:var(--accent)}
        .devenv-toolbar button.secondary{background:var(--bg3);color:var(--fg)}
        .devenv-toolbar button.secondary:hover{background:var(--bg4)}
        .devenv-main{flex:1;display:flex;overflow:hidden}
        .devenv-sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--bg4);display:flex;flex-direction:column}
        .devenv-sidebar-header{padding:10px 12px;border-bottom:1px solid var(--bg4);font-size:11px;color:var(--fg2);text-transform:uppercase;display:flex;justify-content:space-between;align-items:center}
        .devenv-files{flex:1;overflow-y:auto;font-size:12px}
        .devenv-file{padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-left:2px solid transparent}
        .devenv-file:hover{background:rgba(255,255,255,.05)}
        .devenv-file.sel{background:rgba(88,166,255,.15);border-left-color:var(--accent)}
        .devenv-file.folder{color:var(--fg2)}
        .devenv-file-indent{display:inline-block}
        .devenv-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .devenv-tabs{display:flex;background:var(--bg);border-bottom:1px solid var(--bg4);overflow-x:auto}
        .devenv-tab{padding:8px 16px;font-size:12px;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;display:flex;align-items:center;gap:6px}
        .devenv-tab:hover{background:rgba(255,255,255,.05)}
        .devenv-tab.active{border-bottom-color:var(--accent);background:var(--bg2)}
        .devenv-tab .close{opacity:0;font-size:10px;margin-left:4px}
        .devenv-tab:hover .close{opacity:.6}
        .devenv-editor{flex:1;display:flex;overflow:hidden}
        .devenv-code{flex:1;background:#1e1e1e;font-family:'Cascadia Code','Fira Code',Consolas,monospace;font-size:13px;padding:12px;color:#d4d4d4;overflow:auto;white-space:pre;tab-size:4;outline:none;border:none;resize:none}
        .devenv-terminal{height:200px;background:#0c0c0c;border-top:1px solid var(--bg4);display:flex;flex-direction:column}
        .devenv-terminal-header{padding:6px 12px;background:var(--bg2);border-bottom:1px solid var(--bg4);font-size:11px;display:flex;align-items:center;gap:8px}
        .devenv-terminal-header .status{width:8px;height:8px;border-radius:50%;background:var(--green)}
        .devenv-terminal-output{flex:1;padding:8px 12px;overflow-y:auto;font-family:'Cascadia Code',Consolas,monospace;font-size:12px;line-height:1.5}
        .devenv-terminal-output .cmd{color:var(--accent)}
        .devenv-terminal-output .err{color:var(--red)}
        .devenv-terminal-output .success{color:var(--green)}
        .devenv-terminal-output .info{color:var(--fg2)}
        .devenv-terminal-input{display:flex;padding:8px 12px;background:rgba(0,0,0,.3)}
        .devenv-terminal-input span{color:var(--green);margin-right:8px}
        .devenv-terminal-input input{flex:1;background:transparent;border:none;color:#d4d4d4;font-family:inherit;font-size:12px;outline:none}
        .devenv-status{padding:4px 12px;background:var(--bg2);border-top:1px solid var(--bg4);font-size:11px;color:var(--fg2);display:flex;gap:16px}
        .devenv-clone-modal{position:absolute;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:100}
        .devenv-clone-box{background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:24px;width:500px;max-width:90%}
        .devenv-clone-box h3{margin-bottom:16px;font-size:16px}
        .devenv-clone-box input{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--fg);font-size:13px;margin-bottom:12px}
        .devenv-clone-box .buttons{display:flex;gap:8px;justify-content:flex-end}
        .devenv-runtime-badge{padding:2px 8px;background:var(--bg3);border-radius:10px;font-size:10px;color:var(--fg2)}
        .devenv-runtime-badge.python{background:rgba(55,118,171,.3);color:#3776ab}
        .devenv-runtime-badge.node{background:rgba(104,159,99,.3);color:#68a063}
        .devenv-runtime-badge.azure{background:rgba(0,127,255,.3);color:#0078d4}
    </style>
</head>
<body>
    <div id="boot"><div class="logo">‚ôæÔ∏è</div><div class="bar"><div id="boot-bar"></div></div></div>
    <div id="lock"><div class="time" id="lock-time">00:00</div><div class="date" id="lock-date"></div><div class="avatar">üë§</div><div class="user" id="lock-user">User</div><input type="password" id="lock-pass" placeholder="Press Enter to unlock"><div class="hint">Hint: Just press Enter</div></div>
    <div id="desktop"><div id="desktop-icons"></div></div>
    <div id="taskbar"><div id="start-btn">‚ôæÔ∏è</div><div id="taskbar-apps"></div><div id="tray"><div class="tray-btn" onclick="$.toggleWifi()">üì∂</div><div class="tray-btn" onclick="$.toggleSound()">üîä</div><div class="tray-btn" onclick="$.toggleQPanel()">‚öôÔ∏è</div></div><div id="clock" onclick="$.toggleQPanel()"></div></div>
    <div id="start"><div id="start-search"><input type="text" placeholder="Search apps, files, settings..." id="search-input"></div><div id="start-grid"></div><div id="start-footer"><div id="start-user"><div id="start-avatar">üë§</div><span id="start-name">User</span></div><div id="start-power"><button onclick="$.lock()" title="Lock">üîí</button><button onclick="$.restart()" title="Restart">üîÑ</button><button onclick="$.shutdown()" title="Shutdown">‚èª</button></div></div></div>
    <div id="qpanel"><div class="qrow"><div class="qtile on" onclick="this.classList.toggle('on')"><div class="qtile-icon">üì∂</div><div class="qtile-label">Wi-Fi</div></div><div class="qtile on" onclick="this.classList.toggle('on')"><div class="qtile-icon">üîµ</div><div class="qtile-label">Bluetooth</div></div><div class="qtile" onclick="this.classList.toggle('on')"><div class="qtile-icon">‚úàÔ∏è</div><div class="qtile-label">Airplane</div></div></div><div class="qrow"><div class="qtile on" onclick="this.classList.toggle('on')"><div class="qtile-icon">üåô</div><div class="qtile-label">Night Light</div></div><div class="qtile" onclick="this.classList.toggle('on')"><div class="qtile-icon">üîï</div><div class="qtile-label">Focus</div></div><div class="qtile" onclick="this.classList.toggle('on')"><div class="qtile-icon">üìç</div><div class="qtile-label">Location</div></div></div><div class="qslider"><label><span>üîÜ Brightness</span><span>80%</span></label><input type="range" value="80"></div><div class="qslider"><label><span>üîä Volume</span><span>65%</span></label><input type="range" value="65"></div></div>
    <div id="spotlight"><input type="text" placeholder="Search..." id="spot-input"><div id="spotlight-results"></div></div>
    <div id="ctx"></div>
    <div id="notifs"></div>
    <div id="wins"></div>

<script>
// InfiniteOS v7.2 - Interactive VM Tutorial
// Every component runs REAL code via WebAssembly - not simulations
const $ = {
    v: '7.2.0',
    wins: [],
    z: 100,
    user: { name: 'User' },
    startOpen: false,
    qpanelOpen: false,
    spotOpen: false,

    // ========== REAL OS KERNEL ==========
    // This is not a simulation - these are actual OS primitives

    // Real Filesystem using OPFS + IndexedDB
    realFS: {
        root: null,
        db: null,
        initialized: false,

        async init() {
            if (this.initialized) return;

            // Try OPFS first (modern browsers)
            try {
                this.root = await navigator.storage.getDirectory();
                console.log('[Kernel] OPFS filesystem mounted');
            } catch (e) {
                console.log('[Kernel] OPFS unavailable, using IndexedDB fallback');
            }

            // Initialize IndexedDB for metadata and fallback
            this.db = await new Promise((resolve, reject) => {
                const req = indexedDB.open('InfiniteOS-FS', 2);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files', { keyPath: 'path' });
                    }
                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'key' });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });

            this.initialized = true;
            console.log('[Kernel] Filesystem initialized');
        },

        async writeFile(path, content) {
            await this.init();
            const data = typeof content === 'string' ? new TextEncoder().encode(content) : content;

            // Try OPFS first
            if (this.root) {
                try {
                    const parts = path.split('/').filter(p => p);
                    let dir = this.root;
                    for (let i = 0; i < parts.length - 1; i++) {
                        dir = await dir.getDirectoryHandle(parts[i], { create: true });
                    }
                    const fileHandle = await dir.getFileHandle(parts[parts.length - 1], { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(data);
                    await writable.close();
                    return true;
                } catch (e) {
                    console.warn('[FS] OPFS write failed, using IndexedDB:', e);
                }
            }

            // Fallback to IndexedDB
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction('files', 'readwrite');
                tx.objectStore('files').put({ path, content: Array.from(data), modified: Date.now() });
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => reject(tx.error);
            });
        },

        async readFile(path) {
            await this.init();

            // Try OPFS first
            if (this.root) {
                try {
                    const parts = path.split('/').filter(p => p);
                    let dir = this.root;
                    for (let i = 0; i < parts.length - 1; i++) {
                        dir = await dir.getDirectoryHandle(parts[i]);
                    }
                    const fileHandle = await dir.getFileHandle(parts[parts.length - 1]);
                    const file = await fileHandle.getFile();
                    return new Uint8Array(await file.arrayBuffer());
                } catch (e) {
                    // File not in OPFS, try IndexedDB
                }
            }

            // Fallback to IndexedDB
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction('files', 'readonly');
                const req = tx.objectStore('files').get(path);
                req.onsuccess = () => {
                    if (req.result) {
                        resolve(new Uint8Array(req.result.content));
                    } else {
                        reject(new Error('File not found: ' + path));
                    }
                };
                req.onerror = () => reject(req.error);
            });
        },

        async readText(path) {
            const data = await this.readFile(path);
            return new TextDecoder().decode(data);
        },

        async exists(path) {
            try {
                await this.readFile(path);
                return true;
            } catch {
                return false;
            }
        },

        async mkdir(path) {
            await this.init();
            if (this.root) {
                try {
                    const parts = path.split('/').filter(p => p);
                    let dir = this.root;
                    for (const part of parts) {
                        dir = await dir.getDirectoryHandle(part, { create: true });
                    }
                    return true;
                } catch (e) {
                    console.warn('[FS] mkdir failed:', e);
                }
            }
            // For IndexedDB, directories are implicit
            return true;
        },

        async readdir(path) {
            await this.init();
            const entries = [];

            if (this.root) {
                try {
                    const parts = path.split('/').filter(p => p);
                    let dir = this.root;
                    for (const part of parts) {
                        dir = await dir.getDirectoryHandle(part);
                    }
                    for await (const [name, handle] of dir.entries()) {
                        entries.push({
                            name,
                            type: handle.kind === 'directory' ? 'dir' : 'file'
                        });
                    }
                } catch (e) {
                    // Directory doesn't exist in OPFS
                }
            }

            // Also check IndexedDB
            const idbEntries = await new Promise((resolve) => {
                const tx = this.db.transaction('files', 'readonly');
                const req = tx.objectStore('files').getAll();
                req.onsuccess = () => {
                    const prefix = path === '/' ? '' : path + '/';
                    const found = req.result
                        .filter(f => f.path.startsWith(prefix))
                        .map(f => {
                            const rel = f.path.slice(prefix.length);
                            const name = rel.split('/')[0];
                            return { name, type: rel.includes('/') ? 'dir' : 'file' };
                        });
                    resolve(found);
                };
                req.onerror = () => resolve([]);
            });

            // Merge and dedupe
            const seen = new Set(entries.map(e => e.name));
            for (const e of idbEntries) {
                if (!seen.has(e.name)) {
                    entries.push(e);
                    seen.add(e.name);
                }
            }

            return entries;
        },

        async delete(path) {
            await this.init();

            if (this.root) {
                try {
                    const parts = path.split('/').filter(p => p);
                    let dir = this.root;
                    for (let i = 0; i < parts.length - 1; i++) {
                        dir = await dir.getDirectoryHandle(parts[i]);
                    }
                    await dir.removeEntry(parts[parts.length - 1], { recursive: true });
                } catch (e) {
                    // Not in OPFS
                }
            }

            // Also remove from IndexedDB
            return new Promise((resolve) => {
                const tx = this.db.transaction('files', 'readwrite');
                tx.objectStore('files').delete(path);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => resolve(false);
            });
        }
    },

    // Real Process Management
    processes: {
        list: new Map(),
        nextPid: 1,

        spawn(name, workerCode, onMessage) {
            const pid = this.nextPid++;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const worker = new Worker(URL.createObjectURL(blob));

            const proc = {
                pid,
                name,
                worker,
                started: Date.now(),
                status: 'running'
            };

            worker.onmessage = (e) => onMessage?.(e.data);
            worker.onerror = (e) => {
                proc.status = 'error';
                console.error(`[Process ${pid}] Error:`, e);
            };

            this.list.set(pid, proc);
            console.log(`[Kernel] Process spawned: ${name} (PID ${pid})`);
            return pid;
        },

        kill(pid) {
            const proc = this.list.get(pid);
            if (proc) {
                proc.worker.terminate();
                proc.status = 'terminated';
                this.list.delete(pid);
                console.log(`[Kernel] Process killed: PID ${pid}`);
                return true;
            }
            return false;
        },

        getAll() {
            return Array.from(this.list.values());
        }
    },

    // Real Shell - Executes actual commands
    shell: {
        cwd: '/home/user',
        env: {
            PATH: '/usr/bin:/bin',
            HOME: '/home/user',
            USER: 'user',
            SHELL: '/bin/bash',
            TERM: 'xterm-256color'
        },
        history: [],

        async exec(cmd, onOutput) {
            this.history.push(cmd);
            const parts = cmd.trim().split(/\s+/);
            const command = parts[0];
            const args = parts.slice(1);

            const builtins = {
                // Real filesystem commands
                pwd: async () => this.cwd,

                cd: async () => {
                    const target = args[0] || this.env.HOME;
                    const newPath = target.startsWith('/') ? target : this.cwd + '/' + target;
                    // Normalize path
                    const normalized = newPath.split('/').reduce((acc, part) => {
                        if (part === '..') acc.pop();
                        else if (part && part !== '.') acc.push(part);
                        return acc;
                    }, []);
                    this.cwd = '/' + normalized.join('/');
                    return '';
                },

                ls: async () => {
                    const path = args[0] || this.cwd;
                    try {
                        const entries = await $.realFS.readdir(path);
                        return entries.map(e => e.type === 'dir' ? `\x1b[34m${e.name}/\x1b[0m` : e.name).join('  ');
                    } catch {
                        return `ls: cannot access '${path}': No such file or directory`;
                    }
                },

                cat: async () => {
                    if (!args[0]) return 'cat: missing operand';
                    const path = args[0].startsWith('/') ? args[0] : this.cwd + '/' + args[0];
                    try {
                        return await $.realFS.readText(path);
                    } catch {
                        return `cat: ${args[0]}: No such file or directory`;
                    }
                },

                mkdir: async () => {
                    if (!args[0]) return 'mkdir: missing operand';
                    const path = args[0].startsWith('/') ? args[0] : this.cwd + '/' + args[0];
                    await $.realFS.mkdir(path);
                    return '';
                },

                touch: async () => {
                    if (!args[0]) return 'touch: missing operand';
                    const path = args[0].startsWith('/') ? args[0] : this.cwd + '/' + args[0];
                    if (!await $.realFS.exists(path)) {
                        await $.realFS.writeFile(path, '');
                    }
                    return '';
                },

                rm: async () => {
                    if (!args[0]) return 'rm: missing operand';
                    const path = args[0].startsWith('/') ? args[0] : this.cwd + '/' + args[0];
                    await $.realFS.delete(path);
                    return '';
                },

                echo: async () => args.join(' '),

                env: async () => Object.entries(this.env).map(([k, v]) => `${k}=${v}`).join('\n'),

                export: async () => {
                    if (!args[0]) return Object.entries(this.env).map(([k, v]) => `export ${k}="${v}"`).join('\n');
                    const [key, ...val] = args[0].split('=');
                    this.env[key] = val.join('=');
                    return '';
                },

                whoami: async () => this.env.USER,

                hostname: async () => 'infiniteos',

                uname: async () => args.includes('-a')
                    ? 'InfiniteOS 5.0.0 WebAssembly wasm32 InfiniteOS'
                    : 'InfiniteOS',

                date: async () => new Date().toString(),

                clear: async () => '\x1b[2J\x1b[H',

                history: async () => this.history.map((c, i) => `${i + 1}  ${c}`).join('\n'),

                // Python execution (real via Pyodide)
                python: async () => {
                    if (!$.wasmRuntimes.python.loaded) {
                        onOutput?.('Loading Python runtime...\n');
                        await $.loadPyodide((p, s) => onOutput?.(`${s} (${p}%)\n`));
                    }
                    const pyodide = $.wasmRuntimes.python.instance;
                    if (args[0]) {
                        // Execute file
                        const path = args[0].startsWith('/') ? args[0] : this.cwd + '/' + args[0];
                        try {
                            const code = await $.realFS.readText(path);
                            return await pyodide.runPythonAsync(code);
                        } catch (e) {
                            return `python: ${e.message}`;
                        }
                    } else {
                        return 'Python ' + pyodide.version + ' (Pyodide)\nType python <file.py> to run a script';
                    }
                },

                pip: async () => {
                    if (!$.wasmRuntimes.python.loaded) {
                        onOutput?.('Loading Python runtime...\n');
                        await $.loadPyodide((p, s) => onOutput?.(`${s} (${p}%)\n`));
                    }
                    const pyodide = $.wasmRuntimes.python.instance;
                    if (args[0] === 'install' && args[1]) {
                        try {
                            onOutput?.(`Installing ${args[1]}...\n`);
                            await pyodide.loadPackage(args[1]);
                            return `Successfully installed ${args[1]}`;
                        } catch (e) {
                            return `ERROR: Could not install ${args[1]}: ${e.message}`;
                        }
                    }
                    return 'Usage: pip install <package>';
                },

                // Git (real via isomorphic-git)
                git: async () => {
                    if (!window.git) {
                        onOutput?.('Loading git runtime...\n');
                        await $.loadIsomorphicGit();
                    }
                    return await $.gitCommand(args, onOutput);
                },

                // Node.js info
                node: async () => {
                    return 'Node.js available via WebContainers\nUse: webcontainer init';
                },

                // Process management
                ps: async () => {
                    const procs = $.processes.getAll();
                    let out = 'PID\tSTATUS\t\tNAME\n';
                    for (const p of procs) {
                        out += `${p.pid}\t${p.status}\t\t${p.name}\n`;
                    }
                    return out || 'No running processes';
                },

                kill: async () => {
                    if (!args[0]) return 'kill: usage: kill <pid>';
                    const pid = parseInt(args[0]);
                    return $.processes.kill(pid) ? `Killed process ${pid}` : `No such process: ${pid}`;
                },

                sleep: async () => {
                    const secs = parseFloat(args[0]) || 1;
                    await new Promise(r => setTimeout(r, secs * 1000));
                    return '';
                },

                // ========== SQLite Database (Real sql.js) ==========
                sqlite: async () => {
                    if (!$.wasmRuntimes.sqlite.loaded) {
                        onOutput?.('Loading SQLite...\n');
                        await $.loadSQLite((p, s) => onOutput?.(`${s} (${p}%)\n`));
                    }
                    const db = $.wasmRuntimes.sqlite.db;

                    if (!args[0]) {
                        return `SQLite 3.x (sql.js WebAssembly)
Usage: sqlite <query>
       sqlite .tables
       sqlite .schema <table>

Examples:
  sqlite "CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)"
  sqlite "INSERT INTO users (name) VALUES ('Alice')"
  sqlite "SELECT * FROM users"
  sqlite .tables`;
                    }

                    const query = args.join(' ');

                    if (query === '.tables') {
                        try {
                            const result = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                            return result[0]?.values.map(r => r[0]).join('\n') || 'No tables';
                        } catch (e) { return `Error: ${e.message}`; }
                    }

                    if (query.startsWith('.schema')) {
                        const table = args[1];
                        if (!table) return 'Usage: sqlite .schema <table>';
                        try {
                            const result = db.exec("SELECT sql FROM sqlite_master WHERE name='" + table + "'");
                            return result[0]?.values[0]?.[0] || 'Table not found';
                        } catch (e) { return 'Error: ' + e.message; }
                    }

                    try {
                        const result = db.exec(query);
                        await $.saveSQLiteDB(); // Persist changes

                        if (result.length === 0) return 'Query executed successfully';

                        // Format results as table
                        const cols = result[0].columns;
                        const rows = result[0].values;
                        let out = cols.join('\t') + '\n';
                        out += cols.map(() => '---').join('\t') + '\n';
                        for (const row of rows) {
                            out += row.join('\t') + '\n';
                        }
                        return out;
                    } catch (e) {
                        return 'SQL Error: ' + e.message;
                    }
                },

                // ========== Cryptography (Web Crypto API) ==========
                sha256: async () => {
                    if (!args[0]) return 'Usage: sha256 <text> or sha256 -f <file>';
                    if (args[0] === '-f' && args[1]) {
                        const path = args[1].startsWith('/') ? args[1] : this.cwd + '/' + args[1];
                        const content = await $.realFS.readText(path);
                        return await $.crypto.sha256(content);
                    }
                    return await $.crypto.sha256(args.join(' '));
                },

                sha512: async () => {
                    if (!args[0]) return 'Usage: sha512 <text> or sha512 -f <file>';
                    if (args[0] === '-f' && args[1]) {
                        const path = args[1].startsWith('/') ? args[1] : this.cwd + '/' + args[1];
                        const content = await $.realFS.readText(path);
                        return await $.crypto.sha512(content);
                    }
                    return await $.crypto.sha512(args.join(' '));
                },

                uuid: async () => $.crypto.uuid(),

                rand: async () => {
                    const len = parseInt(args[0]) || 16;
                    const bytes = $.crypto.randomBytes(len);
                    return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                },

                // ========== Compression (Pako) ==========
                gzip: async () => {
                    if (!args[0]) return 'Usage: gzip <file> - Compress a file';
                    if (!$.wasmRuntimes.compression.loaded) {
                        await $.loadPako((p, s) => onOutput?.(s + '\n'));
                    }
                    const path = args[0].startsWith('/') ? args[0] : this.cwd + '/' + args[0];
                    const content = await $.realFS.readText(path);
                    const compressed = $.wasmRuntimes.compression.instance.gzip(content);
                    const outPath = path + '.gz';
                    await $.realFS.writeFile(outPath, compressed);
                    const ratio = ((1 - compressed.length / content.length) * 100).toFixed(1);
                    return 'Compressed ' + content.length + ' -> ' + compressed.length + ' bytes (' + ratio + '% reduction)\nSaved to ' + outPath;
                },

                gunzip: async () => {
                    if (!args[0]) return 'Usage: gunzip <file.gz> - Decompress a file';
                    if (!$.wasmRuntimes.compression.loaded) {
                        await $.loadPako((p, s) => onOutput?.(s + '\n'));
                    }
                    const path = args[0].startsWith('/') ? args[0] : this.cwd + '/' + args[0];
                    const compressed = await $.realFS.readFile(path);
                    const content = $.wasmRuntimes.compression.instance.ungzip(compressed, { to: 'string' });
                    const outPath = path.replace(/\.gz$/, '');
                    await $.realFS.writeFile(outPath, content);
                    return 'Decompressed to ' + outPath + ' (' + content.length + ' bytes)';
                },

                // ========== Audio (Web Audio API) ==========
                beep: async () => {
                    const freq = parseFloat(args[0]) || 440;
                    const duration = parseFloat(args[1]) || 0.3;
                    const type = args[2] || 'sine';
                    $.playTone(freq, duration, type);
                    return 'Playing ' + freq + 'Hz ' + type + ' for ' + duration + 's';
                },

                speak: async () => {
                    if (!args[0]) return 'Usage: speak <text>';
                    $.speak(args.join(' '));
                    return 'Speaking...';
                },

                play: async () => {
                    if (!args[0]) return 'Usage: play <notes>\nNotes: C D E F G A B (add number for octave: C4, D5)\n       # for sharp (C#4)\nExample: play C4 D4 E4 F4 G4 A4 B4 C5';

                    const noteFreqs = {
                        'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
                        'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
                        'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
                    };

                    for (const note of args) {
                        const match = note.match(/^([A-Ga-g]#?)(\d)?$/);
                        if (match) {
                            let [, n, oct] = match;
                            n = n.toUpperCase();
                            oct = parseInt(oct) || 4;
                            const baseFreq = noteFreqs[n] || 440;
                            const freq = baseFreq * Math.pow(2, oct - 4);
                            $.playTone(freq, 0.3, 'sine');
                            await new Promise(r => setTimeout(r, 350));
                        }
                    }
                    return 'Melody complete';
                },

                // ========== P2P Networking (WebRTC) ==========
                p2p: async () => {
                    const subcmd = args[0];

                    if (!subcmd) {
                        return 'P2P Networking (WebRTC)\nUsage:\n  p2p init [id]     - Initialize with optional custom ID\n  p2p id            - Show your peer ID\n  p2p offer <peer>  - Create connection offer for peer\n  p2p accept <sdp>  - Accept a connection offer\n  p2p peers         - List connected peers\n  p2p send <peer> <msg> - Send message to peer\n  p2p broadcast <msg>   - Send message to all peers';
                    }

                    if (subcmd === 'init') {
                        const id = $.p2p.init(args[1]);
                        return 'P2P initialized. Your ID: ' + id;
                    }

                    if (subcmd === 'id') {
                        return $.p2p.localId || 'Not initialized. Run: p2p init';
                    }

                    if (subcmd === 'offer') {
                        if (!args[1]) return 'Usage: p2p offer <peer-id>';
                        if (!$.p2p.localId) return 'Not initialized. Run: p2p init';
                        const offer = await $.p2p.createOffer(args[1]);
                        return 'Offer created. Share this with peer:\n' + btoa(JSON.stringify(offer));
                    }

                    if (subcmd === 'accept') {
                        if (!args[1]) return 'Usage: p2p accept <encoded-offer>';
                        try {
                            const offer = JSON.parse(atob(args[1]));
                            const answer = await $.p2p.handleOffer(offer, offer.from);
                            return 'Connection accepted. Send this answer back:\n' + btoa(JSON.stringify(answer));
                        } catch (e) {
                            return 'Error: ' + e.message;
                        }
                    }

                    if (subcmd === 'answer') {
                        if (!args[1]) return 'Usage: p2p answer <encoded-answer>';
                        try {
                            const answer = JSON.parse(atob(args[1]));
                            await $.p2p.handleAnswer(answer, answer.from);
                            return 'Answer processed. Connection establishing...';
                        } catch (e) {
                            return 'Error: ' + e.message;
                        }
                    }

                    if (subcmd === 'peers') {
                        const peers = $.p2p.getPeers();
                        return peers.length ? 'Connected peers:\n' + peers.join('\n') : 'No connected peers';
                    }

                    if (subcmd === 'send') {
                        if (!args[1] || !args[2]) return 'Usage: p2p send <peer-id> <message>';
                        const success = $.p2p.send(args[1], args.slice(2).join(' '));
                        return success ? 'Message sent' : 'Failed to send (peer not connected)';
                    }

                    if (subcmd === 'broadcast') {
                        if (!args[1]) return 'Usage: p2p broadcast <message>';
                        $.p2p.broadcast(args.slice(1).join(' '));
                        return 'Message broadcast to all peers';
                    }

                    return 'Unknown p2p command. Type: p2p';
                },

                // ========== Virtual Machines ==========
                linux: async () => {
                    $.openLinux();
                    return 'Opening Linux VM selector...\n\nAvailable distros:\n  - Alpine Linux 3.19 (networking, apk)\n  - Arch Linux (full installation)\n  - Buildroot (minimal, fast boot)\n\nThis boots REAL Linux via x86 emulation (v86).';
                },

                startx: async () => {
                    $.openLinux();
                    return 'Starting graphical Linux environment...';
                },

                // Help
                help: async () => 'InfiniteOS Shell v6.0.0 - Real WebAssembly OS\n\nFILESYSTEM:\n  ls [path]      - List directory\n  cd [path]      - Change directory\n  pwd            - Working directory\n  cat <file>     - View file\n  mkdir <dir>    - Create directory\n  touch <file>   - Create file\n  rm <path>      - Remove file\n\nPROGRAMMING:\n  python <file>  - Run Python (Pyodide WASM)\n  pip install X  - Install package\n  git <cmd>      - Git (isomorphic-git)\n  sqlite <query> - SQL (sql.js WASM)\n\nVIRTUAL MACHINES:\n  linux          - Boot real Linux (Alpine/Arch)\n  startx         - Start Linux GUI\n\nDATA TOOLS:\n  sha256/sha512  - Hash data\n  uuid           - Generate UUID\n  rand [len]     - Random bytes\n  gzip/gunzip    - Compress files\n\nAUDIO:\n  beep [freq]    - Play tone\n  speak <text>   - Text to speech\n  play <notes>   - Play melody\n\nNETWORKING:\n  p2p            - P2P WebRTC\n\nSYSTEM:\n  ps/kill        - Process management\n  sleep <secs>   - Wait\n  clear          - Clear screen\n\nSCRIPTING:\n  ./script.sh    - Run script\n\nAll commands run REAL code via WebAssembly.'
            };

            if (builtins[command]) {
                try {
                    return await builtins[command]();
                } catch (e) {
                    return `${command}: ${e.message}`;
                }
            }

            // Check if it's a script file
            if (command.endsWith('.sh') || command.endsWith('.ios')) {
                const path = command.startsWith('/') ? command : this.cwd + '/' + command;
                return await $.scriptEngine.runFile(path, args, onOutput);
            }

            return `${command}: command not found. Type 'help' for available commands.`;
        }
    },

    // ========== SCRIPTING ENGINE ==========
    // Full scripting support for automation - like bash/PowerShell

    scriptEngine: {
        variables: {},
        functions: {},
        running: false,

        // Run a script file
        async runFile(path, args = [], onOutput) {
            try {
                const content = await $.realFS.readText(path);
                return await this.run(content, args, onOutput);
            } catch (e) {
                return `Script error: ${e.message}`;
            }
        },

        // Run script content
        async run(script, args = [], onOutput) {
            this.running = true;
            this.variables = {
                '0': args[0] || 'script',
                '1': args[0] || '',
                '2': args[1] || '',
                '3': args[2] || '',
                '@': args.join(' '),
                '#': String(args.length),
                '?': '0',
                PWD: $.shell.cwd,
                HOME: $.shell.env.HOME,
                USER: $.shell.env.USER,
                PATH: $.shell.env.PATH
            };

            const lines = script.split('\n');
            let i = 0;
            let output = [];

            const log = (msg) => {
                output.push(msg);
                onOutput?.(msg + '\n');
            };

            try {
                while (i < lines.length && this.running) {
                    let line = lines[i].trim();
                    i++;

                    // Skip empty lines and comments
                    if (!line || line.startsWith('#')) continue;

                    // Variable expansion
                    line = this.expandVars(line);

                    // Variable assignment: VAR=value or VAR="value"
                    const assignMatch = line.match(/^([A-Za-z_][A-Za-z0-9_]*)=(.*)$/);
                    if (assignMatch) {
                        let value = assignMatch[2];
                        // Remove quotes
                        if ((value.startsWith('"') && value.endsWith('"')) ||
                            (value.startsWith("'") && value.endsWith("'"))) {
                            value = value.slice(1, -1);
                        }
                        this.variables[assignMatch[1]] = value;
                        continue;
                    }

                    // Function definition: function name() { or name() {
                    const funcMatch = line.match(/^(?:function\s+)?([A-Za-z_][A-Za-z0-9_]*)\s*\(\)\s*\{?\s*$/);
                    if (funcMatch) {
                        const funcName = funcMatch[1];
                        const funcLines = [];
                        let braceCount = line.includes('{') ? 1 : 0;

                        while (i < lines.length) {
                            const fline = lines[i].trim();
                            i++;
                            if (fline === '{') { braceCount++; continue; }
                            if (fline === '}') { braceCount--; if (braceCount <= 0) break; continue; }
                            if (fline.endsWith('{')) braceCount++;
                            if (fline.endsWith('}')) braceCount--;
                            funcLines.push(fline);
                            if (braceCount <= 0) break;
                        }

                        this.functions[funcName] = funcLines.join('\n');
                        continue;
                    }

                    // If statement
                    if (line.startsWith('if ')) {
                        const condition = line.slice(3).replace(/;?\s*then\s*$/, '').trim();
                        const condResult = await this.evalCondition(condition);

                        const ifBlock = [];
                        const elseBlock = [];
                        let inElse = false;
                        let ifDepth = 1;

                        while (i < lines.length && ifDepth > 0) {
                            const ifline = lines[i].trim();
                            i++;

                            if (ifline.startsWith('if ')) ifDepth++;
                            if (ifline === 'fi') {
                                ifDepth--;
                                if (ifDepth === 0) break;
                            }
                            if (ifline === 'else' && ifDepth === 1) {
                                inElse = true;
                                continue;
                            }
                            if (ifline === 'then') continue;

                            if (inElse) elseBlock.push(ifline);
                            else ifBlock.push(ifline);
                        }

                        const blockToRun = condResult ? ifBlock : elseBlock;
                        if (blockToRun.length > 0) {
                            const result = await this.run(blockToRun.join('\n'), [], onOutput);
                            if (result) output.push(result);
                        }
                        continue;
                    }

                    // For loop: for VAR in items; do ... done
                    const forMatch = line.match(/^for\s+([A-Za-z_][A-Za-z0-9_]*)\s+in\s+(.+?)(?:\s*;\s*do)?$/);
                    if (forMatch) {
                        const varName = forMatch[1];
                        let items = forMatch[2].trim();

                        // Expand glob patterns or command substitution
                        let itemList = [];
                        if (items.includes('*')) {
                            // Glob pattern
                            const entries = await $.realFS.readdir($.shell.cwd);
                            const pattern = items.replace(/\*/g, '.*');
                            const regex = new RegExp(`^${pattern}$`);
                            itemList = entries.filter(e => regex.test(e.name)).map(e => e.name);
                        } else if (items.startsWith('$(') && items.endsWith(')')) {
                            // Command substitution
                            const cmd = items.slice(2, -1);
                            const result = await $.shell.exec(cmd);
                            itemList = result.split(/\s+/).filter(x => x);
                        } else {
                            itemList = items.split(/\s+/).filter(x => x);
                        }

                        const loopLines = [];
                        let loopDepth = 1;

                        while (i < lines.length && loopDepth > 0) {
                            const loopline = lines[i].trim();
                            i++;
                            if (loopline === 'do') continue;
                            if (loopline.startsWith('for ')) loopDepth++;
                            if (loopline === 'done') {
                                loopDepth--;
                                if (loopDepth === 0) break;
                            }
                            loopLines.push(loopline);
                        }

                        for (const item of itemList) {
                            this.variables[varName] = item;
                            const loopScript = loopLines.join('\n');
                            const result = await this.run(loopScript, [], onOutput);
                            if (result) output.push(result);
                        }
                        continue;
                    }

                    // While loop
                    if (line.startsWith('while ')) {
                        const condition = line.slice(6).replace(/;?\s*do\s*$/, '').trim();

                        const loopLines = [];
                        let loopDepth = 1;

                        while (i < lines.length && loopDepth > 0) {
                            const loopline = lines[i].trim();
                            i++;
                            if (loopline === 'do') continue;
                            if (loopline.startsWith('while ')) loopDepth++;
                            if (loopline === 'done') {
                                loopDepth--;
                                if (loopDepth === 0) break;
                            }
                            loopLines.push(loopline);
                        }

                        let iterations = 0;
                        while (await this.evalCondition(condition) && iterations < 1000) {
                            iterations++;
                            const result = await this.run(loopLines.join('\n'), [], onOutput);
                            if (result) output.push(result);
                        }
                        continue;
                    }

                    // Sleep command
                    if (line.startsWith('sleep ')) {
                        const secs = parseFloat(line.slice(6)) || 1;
                        await new Promise(r => setTimeout(r, secs * 1000));
                        continue;
                    }

                    // Exit command
                    if (line.startsWith('exit')) {
                        const code = line.split(' ')[1] || '0';
                        this.variables['?'] = code;
                        this.running = false;
                        break;
                    }

                    // Function call
                    const funcCallMatch = line.match(/^([A-Za-z_][A-Za-z0-9_]*)\s*(.*)$/);
                    if (funcCallMatch && this.functions[funcCallMatch[1]]) {
                        const funcArgs = funcCallMatch[2].split(/\s+/).filter(x => x);
                        const result = await this.run(this.functions[funcCallMatch[1]], funcArgs, onOutput);
                        if (result) output.push(result);
                        continue;
                    }

                    // Regular command - execute via shell
                    try {
                        const result = await $.shell.exec(line, onOutput);
                        if (result) {
                            output.push(result);
                            onOutput?.(result + '\n');
                        }
                        this.variables['?'] = '0';
                    } catch (e) {
                        this.variables['?'] = '1';
                        log(`Error: ${e.message}`);
                    }
                }
            } catch (e) {
                output.push(`Script error at line ${i}: ${e.message}`);
            }

            this.running = false;
            return output.join('\n');
        },

        // Expand variables in a string
        expandVars(str) {
            // Replace ${VAR} and $VAR
            return str.replace(/\$\{([A-Za-z_][A-Za-z0-9_]*)\}/g, (_, name) => this.variables[name] || '')
                      .replace(/\$([A-Za-z_][A-Za-z0-9_]*)/g, (_, name) => this.variables[name] || '')
                      .replace(/\$([0-9@#?])/g, (_, name) => this.variables[name] || '');
        },

        // Evaluate a condition
        async evalCondition(condition) {
            condition = this.expandVars(condition);

            // [ -f file ] - file exists
            const fileMatch = condition.match(/\[\s*-([fdezn])\s+"?([^"\]]+)"?\s*\]/);
            if (fileMatch) {
                const [, flag, path] = fileMatch;
                const fullPath = path.startsWith('/') ? path : $.shell.cwd + '/' + path;

                switch (flag) {
                    case 'f': // file exists
                    case 'e': // exists
                        return await $.realFS.exists(fullPath);
                    case 'd': // directory
                        try {
                            const entries = await $.realFS.readdir(fullPath);
                            return true;
                        } catch { return false; }
                    case 'z': // string is empty
                        return !path || path.length === 0;
                    case 'n': // string is not empty
                        return path && path.length > 0;
                }
            }

            // [ "$VAR" = "value" ] or [ "$VAR" == "value" ]
            const eqMatch = condition.match(/\[\s*"?([^"]*)"?\s*==?\s*"?([^"]*)"?\s*\]/);
            if (eqMatch) {
                return eqMatch[1].trim() === eqMatch[2].trim();
            }

            // [ "$VAR" != "value" ]
            const neqMatch = condition.match(/\[\s*"?([^"]*)"?\s*!=\s*"?([^"]*)"?\s*\]/);
            if (neqMatch) {
                return neqMatch[1].trim() !== neqMatch[2].trim();
            }

            // [ $NUM -gt $NUM2 ] etc.
            const numMatch = condition.match(/\[\s*(\S+)\s+-(gt|lt|ge|le|eq|ne)\s+(\S+)\s*\]/);
            if (numMatch) {
                const [, a, op, b] = numMatch;
                const na = parseInt(a), nb = parseInt(b);
                switch (op) {
                    case 'gt': return na > nb;
                    case 'lt': return na < nb;
                    case 'ge': return na >= nb;
                    case 'le': return na <= nb;
                    case 'eq': return na === nb;
                    case 'ne': return na !== nb;
                }
            }

            // Command success: just run it
            try {
                const result = await $.shell.exec(condition);
                return !result.includes('not found') && !result.includes('Error');
            } catch {
                return false;
            }
        }
    },

    // Load isomorphic-git for real git operations
    async loadIsomorphicGit() {
        if (window.git) return;

        await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/isomorphic-git@1.25.3/index.umd.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });

        // Also load the http plugin
        await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/isomorphic-git@1.25.3/http/web/index.umd.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });

        console.log('[Kernel] isomorphic-git loaded');
    },

    // Execute git commands
    async gitCommand(args, onOutput) {
        const cmd = args[0];
        const git = window.git;
        const http = window.GitHttp;

        // Custom filesystem adapter for isomorphic-git
        const fs = {
            promises: {
                readFile: async (path) => $.realFS.readFile(path),
                writeFile: async (path, data) => $.realFS.writeFile(path, data),
                mkdir: async (path) => $.realFS.mkdir(path),
                rmdir: async (path) => $.realFS.delete(path),
                unlink: async (path) => $.realFS.delete(path),
                stat: async (path) => {
                    const exists = await $.realFS.exists(path);
                    if (!exists) throw new Error('ENOENT');
                    return { isFile: () => true, isDirectory: () => false };
                },
                readdir: async (path) => {
                    const entries = await $.realFS.readdir(path);
                    return entries.map(e => e.name);
                }
            }
        };

        const dir = $.shell.cwd;

        try {
            switch (cmd) {
                case 'clone': {
                    const url = args[1];
                    if (!url) return 'usage: git clone <url>';
                    const repoName = url.split('/').pop().replace('.git', '');
                    const targetDir = dir + '/' + repoName;
                    onOutput?.(`Cloning into '${repoName}'...\n`);

                    await git.clone({
                        fs,
                        http,
                        dir: targetDir,
                        url,
                        singleBranch: true,
                        depth: 1,
                        onProgress: (e) => {
                            if (e.phase) onOutput?.(`${e.phase}: ${e.loaded}/${e.total || '?'}\n`);
                        }
                    });
                    return `Cloned ${url} to ${targetDir}`;
                }

                case 'status': {
                    const status = await git.statusMatrix({ fs, dir });
                    let out = 'On branch main\n\n';
                    const modified = status.filter(([, head, work]) => head !== work);
                    if (modified.length) {
                        out += 'Changes:\n';
                        for (const [file] of modified) {
                            out += `  modified: ${file}\n`;
                        }
                    } else {
                        out += 'Nothing to commit, working tree clean\n';
                    }
                    return out;
                }

                case 'log': {
                    const commits = await git.log({ fs, dir, depth: 5 });
                    return commits.map(c =>
                        `commit ${c.oid.slice(0, 7)}\nAuthor: ${c.commit.author.name}\nDate: ${new Date(c.commit.author.timestamp * 1000).toLocaleString()}\n\n    ${c.commit.message}\n`
                    ).join('\n');
                }

                case 'init': {
                    await git.init({ fs, dir });
                    return `Initialized empty Git repository in ${dir}`;
                }

                case 'add': {
                    const filepath = args[1] || '.';
                    await git.add({ fs, dir, filepath });
                    return '';
                }

                default:
                    return `git: '${cmd}' is not a git command. Available: clone, status, log, init, add`;
            }
        } catch (e) {
            return `git error: ${e.message}`;
        }
    },

    // Initialize the OS kernel
    async initKernel() {
        console.log('[Kernel] Booting InfiniteOS v7.0.0...');

        // Initialize real filesystem
        await this.realFS.init();

        // Create default directories
        await this.realFS.mkdir('/home');
        await this.realFS.mkdir('/home/user');
        await this.realFS.mkdir('/home/user/Documents');
        await this.realFS.mkdir('/home/user/Projects');
        await this.realFS.mkdir('/tmp');
        await this.realFS.mkdir('/usr');
        await this.realFS.mkdir('/usr/bin');

        // Create a welcome file
        if (!await this.realFS.exists('/home/user/README.txt')) {
            await this.realFS.writeFile('/home/user/README.txt',
                `Welcome to InfiniteOS v7.0.0
============================

A REAL operating system running in your browser via WebAssembly.

REAL Components (not simulations):
- Filesystem: OPFS + IndexedDB persistence
- Python: Real CPython via Pyodide WASM
- SQLite: Real SQL database via sql.js WASM
- Git: Real git via isomorphic-git
- Shell: Full bash-like scripting
- Crypto: SHA-256/512, AES-256-GCM encryption
- Audio: Web Audio synthesis + TTS
- Compression: gzip/gunzip via pako
- P2P: WebRTC peer-to-peer networking

Quick Start:
  help                  - See all commands
  ./setup-azure.sh      - Clone Azure Functions project
  sqlite "SELECT 1+1"   - Run SQL query
  sha256 hello          - Hash text
  beep 440              - Play tone
  speak "Hello world"   - Text to speech
  p2p init              - Start P2P networking

Your files persist between sessions!
`);
        }

        // Create the Azure Functions setup script
        await this.realFS.writeFile('/home/user/setup-azure.sh',
            `#!/bin/ios
# ============================================
# InfiniteOS Setup Script for Azure Functions
# ============================================
# This script clones and sets up the Copilot-Agent-365 project
# Run with: ./setup-azure.sh

echo "=========================================="
echo "  InfiniteOS Azure Functions Setup"
echo "=========================================="
echo ""

# Configuration
REPO_URL="https://github.com/kody-w/Copilot-Agent-365"
PROJECT_NAME="Copilot-Agent-365"
PROJECT_DIR="/home/user/Projects/$PROJECT_NAME"

# Step 1: Create projects directory
echo "[1/5] Creating project directory..."
mkdir /home/user/Projects

# Step 2: Clone the repository
echo "[2/5] Cloning repository..."
echo "      $REPO_URL"
cd /home/user/Projects
git clone $REPO_URL

# Step 3: Navigate to project
echo "[3/5] Entering project directory..."
cd $PROJECT_DIR
echo "      Current directory: $PROJECT_DIR"

# Step 4: List project files
echo "[4/5] Project structure:"
ls

# Step 5: Install Python dependencies
echo "[5/5] Setting up Python environment..."
pip install azure-functions

echo ""
echo "=========================================="
echo "  Setup Complete!"
echo "=========================================="
echo ""
echo "Project cloned to: $PROJECT_DIR"
echo ""
echo "Next steps:"
echo "  cd /home/user/Projects/$PROJECT_NAME"
echo "  cat function_app.py"
echo "  python function_app.py"
echo ""
echo "Available scripts:"
echo "  ./run-function.sh  - Run the Azure Function"
echo "  ./test-agent.sh    - Test the AI agent"
echo ""
`);

        // Create a run script for the function
        await this.realFS.writeFile('/home/user/run-function.sh',
            `#!/bin/ios
# Run Azure Function locally
echo "Starting Azure Function..."
cd /home/user/Projects/Copilot-Agent-365

if [ -f "function_app.py" ]
then
    echo "Running function_app.py..."
    python function_app.py
else
    echo "Error: function_app.py not found"
    echo "Run ./setup-azure.sh first"
fi
`);

        // Create a test script
        await this.realFS.writeFile('/home/user/test-agent.sh',
            `#!/bin/ios
# Test the AI Agent
echo "Testing AI Agent..."
cd /home/user/Projects/Copilot-Agent-365

# Check if project exists
if [ -d "/home/user/Projects/Copilot-Agent-365" ]
then
    echo "Project found!"
    echo ""
    echo "Listing agents..."
    ls agents
    echo ""
    echo "Listing utilities..."
    ls utils
else
    echo "Project not found. Run ./setup-azure.sh first"
fi
`);

        // Create a generic project setup script
        await this.realFS.writeFile('/home/user/setup-project.sh',
            `#!/bin/ios
# ============================================
# Generic Project Setup Script
# ============================================
# Usage: ./setup-project.sh <github-url>

if [ "$1" = "" ]
then
    echo "Usage: ./setup-project.sh <github-url>"
    echo ""
    echo "Example:"
    echo "  ./setup-project.sh https://github.com/user/repo"
    exit 1
fi

REPO_URL="$1"
echo "Setting up project from: $REPO_URL"

cd /home/user/Projects
git clone $REPO_URL

echo ""
echo "Project cloned successfully!"
echo "Run 'ls /home/user/Projects' to see your projects"
`);

        // Create an example Python script
        await this.realFS.writeFile('/home/user/hello.py',
            `# Example Python script for InfiniteOS
# Run with: python hello.py

import sys

def greet(name="World"):
    """Say hello to someone."""
    return f"Hello, {name}! Welcome to InfiniteOS."

def fibonacci(n):
    """Generate Fibonacci sequence."""
    a, b = 0, 1
    result = []
    for _ in range(n):
        result.append(a)
        a, b = b, a + b
    return result

if __name__ == "__main__":
    print(greet("Developer"))
    print(f"Fibonacci(10): {fibonacci(10)}")
    print(f"Python version: {sys.version}")
    print("This is REAL Python running via WebAssembly!")
`);

        // Create a demo script showing scripting features
        await this.realFS.writeFile('/home/user/demo.sh',
            `#!/bin/ios
# ============================================
# InfiniteOS Scripting Demo
# ============================================
# This script demonstrates the scripting capabilities

echo "=== InfiniteOS Scripting Demo ==="
echo ""

# Variables
NAME="Developer"
COUNT=5

echo "1. Variables:"
echo "   NAME = $NAME"
echo "   COUNT = $COUNT"
echo ""

# Functions
function greet() {
    echo "   Hello, $NAME!"
}

echo "2. Functions:"
greet
echo ""

# Conditionals
echo "3. Conditionals:"
if [ -f "/home/user/README.txt" ]
then
    echo "   README.txt exists!"
else
    echo "   README.txt not found"
fi
echo ""

# Loops
echo "4. Loops:"
for i in 1 2 3 4 5
do
    echo "   Iteration $i"
done
echo ""

# Command execution
echo "5. Real Commands:"
echo "   Current directory: $(pwd)"
echo "   User: $(whoami)"
echo ""

echo "=== Demo Complete ==="
echo "Try writing your own scripts!"
`);

        // Create scripts directory
        await this.realFS.mkdir('/home/user/scripts');

        console.log('[Kernel] Boot complete');
    },

    // Legacy fs compatibility (for old apps)
    fs: null,

    // Boot
    async boot() {
        const bar = document.getElementById('boot-bar');

        // Initialize kernel (real filesystem, etc.)
        bar.style.width = '20%';
        await this.initKernel();

        for (let i = 20; i <= 100; i += 5) {
            bar.style.width = i + '%';
            await this.delay(20);
        }
        await this.delay(200);
        document.getElementById('boot').classList.add('done');
        this.load();
        await this.delay(400);
        document.getElementById('lock').style.display = 'flex';
        this.updateLockClock();
        setInterval(() => this.updateLockClock(), 1000);
    },

    updateLockClock() {
        const now = new Date();
        document.getElementById('lock-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        document.getElementById('lock-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    },

    unlock() {
        document.getElementById('lock').style.display = 'none';
        document.getElementById('desktop').style.display = 'block';
        document.getElementById('taskbar').style.display = 'flex';
        this.initDesktop();
        this.initStart();
        this.startClock();
        this.notify('Welcome', 'InfiniteOS ' + this.v, '‚ôæÔ∏è');
    },

    lock() {
        document.getElementById('lock').style.display = 'flex';
        document.getElementById('desktop').style.display = 'none';
        document.getElementById('taskbar').style.display = 'none';
        this.closeStart();
    },

    load() {
        try {
            const d = JSON.parse(localStorage.getItem('infOS') || '{}');
            this.user = d.user || this.user;
            this.fs = d.fs || this.initFS();
        } catch { this.fs = this.initFS(); }
        document.getElementById('lock-user').textContent = this.user.name;
        document.getElementById('start-name').textContent = this.user.name;
    },

    save() {
        localStorage.setItem('infOS', JSON.stringify({ user: this.user, fs: this.fs }));
    },

    initFS() {
        return {
            'C:': {
                type: 'drive',
                children: {
                    'Users': { type: 'folder', children: {
                        [this.user.name]: { type: 'folder', children: {
                            'Desktop': { type: 'folder', children: {} },
                            'Documents': { type: 'folder', children: {
                                'Welcome.txt': { type: 'file', content: 'Welcome to InfiniteOS!\n\nThis is your personal computer in the browser.\n\nFeatures:\n- Full window management\n- File system with persistence\n- Terminal with 20+ commands\n- Code editor with syntax highlighting\n- And much more!\n\nPress Cmd/Ctrl+Space for Spotlight search.' },
                                'Notes.md': { type: 'file', content: '# My Notes\n\n## Todo\n- [ ] Explore InfiniteOS\n- [ ] Try the terminal\n- [ ] Open InfiniteOS recursively\n\n## Ideas\n- This is a markdown file\n- Open with Markdown Editor' }
                            }},
                            'Pictures': { type: 'folder', children: {} },
                            'Downloads': { type: 'folder', children: {} }
                        }}
                    }},
                    'System': { type: 'folder', children: {} }
                }
            }
        };
    },

    apps: [
        { id: 'files', name: 'Files', icon: 'üìÅ' },
        { id: 'terminal', name: 'Terminal', icon: 'üíª' },
        { id: 'devenv', name: 'Dev Environment', icon: 'üõ†Ô∏è', wasm: true },
        { id: 'code', name: 'Code', icon: 'üìù' },
        { id: 'browser', name: 'Browser', icon: 'üåê' },
        { id: 'python', name: 'Python', icon: 'üêç', wasm: true },
        { id: 'linux', name: 'Linux', icon: 'üêß', wasm: true },
        { id: 'dosbox', name: 'DOS Box', icon: 'üëæ', wasm: true },
        { id: 'videoeditor', name: 'Video Editor', icon: 'üé¨', wasm: true },
        { id: 'calc', name: 'Calculator', icon: 'üî¢' },
        { id: 'notes', name: 'Notes', icon: 'üìí' },
        { id: 'tasks', name: 'Tasks', icon: '‚úÖ' },
        { id: 'calendar', name: 'Calendar', icon: 'üìÖ' },
        { id: 'music', name: 'Music', icon: 'üéµ' },
        { id: 'weather', name: 'Weather', icon: 'üå§Ô∏è' },
        { id: 'photos', name: 'Photos', icon: 'üñºÔ∏è' },
        { id: 'markdown', name: 'Markdown', icon: 'üìÑ' },
        { id: 'clock', name: 'Clock', icon: 'üïê' },
        { id: 'settings', name: 'Settings', icon: '‚öôÔ∏è' },
        { id: 'taskmgr', name: 'Task Manager', icon: 'üìä' },
        { id: 'about', name: 'About', icon: '‚ÑπÔ∏è' },
        { id: 'infinite', name: 'InfiniteOS', icon: '‚ôæÔ∏è' }
    ],

    // ========== WebAssembly Runtime System ==========
    wasmRuntimes: {
        python: {
            name: 'Python 3.12 (Pyodide)',
            size: '~10 MB',
            loaded: false,
            instance: null,
            cdn: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/'
        },
        v86: {
            name: 'x86 Emulator (v86)',
            size: '~15 MB',
            loaded: false,
            instance: null,
            cdn: 'https://cdn.jsdelivr.net/npm/v86@latest/build/'
        },
        dos: {
            name: 'DOSBox (js-dos)',
            size: '~5 MB',
            loaded: false,
            instance: null,
            cdn: 'https://v8.js-dos.com/latest/js-dos/'
        },
        ffmpeg: {
            name: 'FFmpeg (Video)',
            size: '~25 MB',
            loaded: false,
            instance: null,
            cdn: 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/'
        },
        sqlite: {
            name: 'SQLite (sql.js)',
            size: '~1.5 MB',
            loaded: false,
            instance: null,
            db: null,
            cdn: 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/'
        },
        crypto: {
            name: 'Web Crypto',
            size: 'Native',
            loaded: true,
            instance: window.crypto
        },
        audio: {
            name: 'Web Audio',
            size: 'Native',
            loaded: false,
            instance: null,
            ctx: null
        },
        compression: {
            name: 'Pako (gzip)',
            size: '~45 KB',
            loaded: false,
            instance: null,
            cdn: 'https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/'
        },
        network: {
            name: 'WebRTC P2P',
            size: 'Native',
            loaded: false,
            peers: new Map(),
            rooms: new Map()
        }
    },

    // IndexedDB for caching WASM
    async openWasmCache() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('InfiniteOS-WASM', 1);
            req.onupgradeneeded = () => req.result.createObjectStore('runtimes');
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },

    async getCachedRuntime(id) {
        try {
            const db = await this.openWasmCache();
            return new Promise((resolve) => {
                const tx = db.transaction('runtimes', 'readonly');
                const store = tx.objectStore('runtimes');
                const req = store.get(id);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        } catch { return null; }
    },

    async cacheRuntime(id, data) {
        try {
            const db = await this.openWasmCache();
            const tx = db.transaction('runtimes', 'readwrite');
            tx.objectStore('runtimes').put(data, id);
        } catch (e) { console.warn('Cache failed:', e); }
    },

    // Load runtime with progress
    async loadRuntime(runtimeId, body, onReady) {
        const runtime = this.wasmRuntimes[runtimeId];
        if (!runtime) return;

        // Already loaded
        if (runtime.loaded && runtime.instance) {
            onReady(runtime.instance);
            return;
        }

        // Show loader
        body.innerHTML = `
            <div class="wasm-loader">
                <div class="wasm-loader-icon">${runtimeId === 'python' ? 'üêç' : runtimeId === 'v86' ? 'üêß' : runtimeId === 'dos' ? 'üëæ' : 'üé¨'}</div>
                <div class="wasm-loader-title">Loading ${runtime.name}</div>
                <div class="wasm-loader-status" id="wasm-status">Initializing WebAssembly runtime...</div>
                <div class="wasm-loader-bar"><div class="wasm-loader-fill" id="wasm-fill"></div></div>
                <div class="wasm-loader-percent" id="wasm-percent">0%</div>
                <div class="wasm-loader-size">Download size: ${runtime.size}</div>
            </div>
        `;

        const fill = body.querySelector('#wasm-fill');
        const percent = body.querySelector('#wasm-percent');
        const status = body.querySelector('#wasm-status');

        const updateProgress = (p, s) => {
            fill.style.width = p + '%';
            percent.textContent = Math.round(p) + '%';
            if (s) status.textContent = s;
        };

        try {
            // Load the appropriate runtime
            if (runtimeId === 'python') {
                await this.loadPyodide(updateProgress);
            } else if (runtimeId === 'v86') {
                await this.loadV86(updateProgress);
            } else if (runtimeId === 'dos') {
                await this.loadJsDos(updateProgress);
            } else if (runtimeId === 'ffmpeg') {
                await this.loadFFmpeg(updateProgress);
            }

            runtime.loaded = true;
            onReady(runtime.instance);
        } catch (e) {
            body.innerHTML = `
                <div class="wasm-loader">
                    <div class="wasm-loader-icon">‚ùå</div>
                    <div class="wasm-loader-title">Failed to Load Runtime</div>
                    <div class="wasm-loader-status">${e.message}</div>
                    <button class="wasm-loader-btn" onclick="$.open('${runtimeId}')">Retry</button>
                </div>
            `;
        }
    },

    // Load Pyodide (Real Python)
    async loadPyodide(progress) {
        progress(10, 'Loading Pyodide core...');

        // Load Pyodide script
        if (!window.loadPyodide) {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = this.wasmRuntimes.python.cdn + 'pyodide.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load Pyodide script'));
                document.head.appendChild(script);
            });
        }

        progress(30, 'Initializing Python interpreter...');

        const pyodide = await window.loadPyodide({
            indexURL: this.wasmRuntimes.python.cdn,
            stdout: (text) => this.pyodideOutput?.(text),
            stderr: (text) => this.pyodideOutput?.(text, true)
        });

        progress(80, 'Loading standard library...');

        // Pre-load some useful packages
        await pyodide.loadPackage(['micropip']);

        progress(100, 'Python ready!');
        this.wasmRuntimes.python.instance = pyodide;
        return pyodide;
    },

    // Load v86 (Linux/Windows emulator)
    async loadV86(progress) {
        progress(10, 'Loading x86 emulator...');

        if (!window.V86) {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/v86@0.9.4/build/libv86.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load v86'));
                document.head.appendChild(script);
            });
        }

        progress(50, 'v86 emulator loaded');
        progress(100, 'Ready to boot OS!');
        this.wasmRuntimes.v86.loaded = true;
    },

    // Load js-dos (DOSBox)
    async loadJsDos(progress) {
        progress(10, 'Loading DOSBox emulator...');

        // Load js-dos CSS and JS
        if (!window.Dos) {
            const css = document.createElement('link');
            css.rel = 'stylesheet';
            css.href = 'https://v8.js-dos.com/latest/js-dos.css';
            document.head.appendChild(css);

            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://v8.js-dos.com/latest/js-dos.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load js-dos'));
                document.head.appendChild(script);
            });
        }

        progress(100, 'DOSBox ready!');
        this.wasmRuntimes.dos.loaded = true;
    },

    // Load FFmpeg
    async loadFFmpeg(progress) {
        progress(10, 'Loading FFmpeg...');

        if (!window.FFmpeg) {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load FFmpeg'));
                document.head.appendChild(script);
            });
        }

        progress(50, 'Initializing FFmpeg core...');

        const { FFmpeg } = window.FFmpegWASM || window;
        const ffmpeg = new FFmpeg();

        ffmpeg.on('progress', ({ progress: p }) => {
            progress(50 + p * 50, 'Processing...');
        });

        await ffmpeg.load({
            coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js'
        });

        progress(100, 'FFmpeg ready!');
        this.wasmRuntimes.ffmpeg.instance = ffmpeg;
    },

    // Load SQLite (sql.js - real SQLite in WASM)
    async loadSQLite(progress) {
        progress(10, 'Loading SQLite...');

        if (!window.initSqlJs) {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = this.wasmRuntimes.sqlite.cdn + 'sql-wasm.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load sql.js'));
                document.head.appendChild(script);
            });
        }

        progress(50, 'Initializing SQLite engine...');

        const SQL = await window.initSqlJs({
            locateFile: file => this.wasmRuntimes.sqlite.cdn + file
        });

        // Create or load persistent database
        let savedDb = null;
        try {
            const tx = this.realFS.db.transaction('files', 'readonly');
            const req = tx.objectStore('files').get('/var/db/main.sqlite');
            savedDb = await new Promise(r => { req.onsuccess = () => r(req.result?.content); });
        } catch {}

        const db = savedDb ? new SQL.Database(new Uint8Array(savedDb)) : new SQL.Database();

        progress(100, 'SQLite ready!');
        this.wasmRuntimes.sqlite.instance = SQL;
        this.wasmRuntimes.sqlite.db = db;
        this.wasmRuntimes.sqlite.loaded = true;
        return db;
    },

    // Save SQLite database to persistent storage
    async saveSQLiteDB() {
        if (!this.wasmRuntimes.sqlite.db) return;
        const data = this.wasmRuntimes.sqlite.db.export();
        await this.realFS.mkdir('/var');
        await this.realFS.mkdir('/var/db');
        await this.realFS.writeFile('/var/db/main.sqlite', data);
    },

    // Load Pako (gzip compression)
    async loadPako(progress) {
        progress(10, 'Loading compression library...');

        if (!window.pako) {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = this.wasmRuntimes.compression.cdn + 'pako.min.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load pako'));
                document.head.appendChild(script);
            });
        }

        progress(100, 'Compression ready!');
        this.wasmRuntimes.compression.instance = window.pako;
        this.wasmRuntimes.compression.loaded = true;
        return window.pako;
    },

    // Initialize Web Audio
    initAudio() {
        if (this.wasmRuntimes.audio.ctx) return this.wasmRuntimes.audio.ctx;
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.wasmRuntimes.audio.ctx = ctx;
        this.wasmRuntimes.audio.loaded = true;
        return ctx;
    },

    // Play a tone with Web Audio
    playTone(frequency = 440, duration = 0.5, type = 'sine', volume = 0.5) {
        const ctx = this.initAudio();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.value = frequency;
        gain.gain.value = volume;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
        osc.stop(ctx.currentTime + duration);
    },

    // Text to speech
    speak(text, rate = 1, pitch = 1) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = rate;
        utterance.pitch = pitch;
        window.speechSynthesis.speak(utterance);
    },

    // ========== WebRTC P2P Networking ==========
    p2p: {
        signaling: null,
        localId: null,
        connections: new Map(),
        dataChannels: new Map(),
        onMessage: null,
        onPeerConnect: null,
        onPeerDisconnect: null,

        // Initialize with a unique ID
        init(localId) {
            this.localId = localId || 'user-' + Math.random().toString(36).substr(2, 9);
            $.wasmRuntimes.network.loaded = true;
            console.log('[P2P] Initialized with ID:', this.localId);
            return this.localId;
        },

        // Create offer for peer
        async createOffer(peerId) {
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            const pc = new RTCPeerConnection(config);
            this.connections.set(peerId, pc);

            const dc = pc.createDataChannel('data');
            this.setupDataChannel(dc, peerId);

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    console.log('[P2P] ICE candidate for', peerId);
                }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            return { type: 'offer', sdp: offer.sdp, from: this.localId };
        },

        // Accept offer and create answer
        async handleOffer(offer, peerId) {
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            const pc = new RTCPeerConnection(config);
            this.connections.set(peerId, pc);

            pc.ondatachannel = (e) => {
                this.setupDataChannel(e.channel, peerId);
            };

            await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: offer.sdp }));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            return { type: 'answer', sdp: answer.sdp, from: this.localId };
        },

        // Handle answer
        async handleAnswer(answer, peerId) {
            const pc = this.connections.get(peerId);
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answer.sdp }));
            }
        },

        setupDataChannel(dc, peerId) {
            this.dataChannels.set(peerId, dc);
            dc.onopen = () => {
                console.log('[P2P] Connected to', peerId);
                this.onPeerConnect?.(peerId);
            };
            dc.onclose = () => {
                console.log('[P2P] Disconnected from', peerId);
                this.dataChannels.delete(peerId);
                this.connections.delete(peerId);
                this.onPeerDisconnect?.(peerId);
            };
            dc.onmessage = (e) => {
                try {
                    const msg = JSON.parse(e.data);
                    this.onMessage?.(msg, peerId);
                } catch {
                    this.onMessage?.(e.data, peerId);
                }
            };
        },

        // Send message to peer
        send(peerId, message) {
            const dc = this.dataChannels.get(peerId);
            if (dc && dc.readyState === 'open') {
                dc.send(typeof message === 'string' ? message : JSON.stringify(message));
                return true;
            }
            return false;
        },

        // Broadcast to all peers
        broadcast(message) {
            const data = typeof message === 'string' ? message : JSON.stringify(message);
            for (const [peerId, dc] of this.dataChannels) {
                if (dc.readyState === 'open') dc.send(data);
            }
        },

        // Get list of connected peers
        getPeers() {
            return Array.from(this.dataChannels.keys()).filter(id =>
                this.dataChannels.get(id).readyState === 'open'
            );
        }
    },

    // ========== Cryptography Module (Web Crypto API) ==========
    crypto: {
        // Generate random bytes
        randomBytes(length) {
            return window.crypto.getRandomValues(new Uint8Array(length));
        },

        // Generate UUID
        uuid() {
            return window.crypto.randomUUID();
        },

        // Hash data with SHA-256
        async sha256(data) {
            const encoder = new TextEncoder();
            const buffer = typeof data === 'string' ? encoder.encode(data) : data;
            const hash = await window.crypto.subtle.digest('SHA-256', buffer);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        },

        // Hash data with SHA-512
        async sha512(data) {
            const encoder = new TextEncoder();
            const buffer = typeof data === 'string' ? encoder.encode(data) : data;
            const hash = await window.crypto.subtle.digest('SHA-512', buffer);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        },

        // Generate AES-256-GCM key
        async generateKey() {
            return await window.crypto.subtle.generateKey(
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        },

        // Export key to base64
        async exportKey(key) {
            const raw = await window.crypto.subtle.exportKey('raw', key);
            return btoa(String.fromCharCode(...new Uint8Array(raw)));
        },

        // Import key from base64
        async importKey(base64) {
            const raw = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
            return await window.crypto.subtle.importKey(
                'raw', raw, { name: 'AES-GCM' }, true, ['encrypt', 'decrypt']
            );
        },

        // Encrypt data with AES-256-GCM
        async encrypt(data, key) {
            const encoder = new TextEncoder();
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                key,
                typeof data === 'string' ? encoder.encode(data) : data
            );
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...combined));
        },

        // Decrypt data with AES-256-GCM
        async decrypt(encryptedBase64, key) {
            const combined = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
            const iv = combined.slice(0, 12);
            const encrypted = combined.slice(12);
            const decrypted = await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv },
                key,
                encrypted
            );
            return new TextDecoder().decode(decrypted);
        },

        // Generate RSA key pair for signing
        async generateKeyPair() {
            return await window.crypto.subtle.generateKey(
                { name: 'RSA-PSS', modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: 'SHA-256' },
                true,
                ['sign', 'verify']
            );
        },

        // Sign data
        async sign(data, privateKey) {
            const encoder = new TextEncoder();
            const signature = await window.crypto.subtle.sign(
                { name: 'RSA-PSS', saltLength: 32 },
                privateKey,
                encoder.encode(data)
            );
            return btoa(String.fromCharCode(...new Uint8Array(signature)));
        },

        // Verify signature
        async verify(data, signature, publicKey) {
            const encoder = new TextEncoder();
            const sig = Uint8Array.from(atob(signature), c => c.charCodeAt(0));
            return await window.crypto.subtle.verify(
                { name: 'RSA-PSS', saltLength: 32 },
                publicKey,
                sig,
                encoder.encode(data)
            );
        }
    },

    initDesktop() {
        const c = document.getElementById('desktop-icons');
        c.innerHTML = '';
        const desk = ['files', 'devenv', 'terminal', 'python', 'browser', 'settings'];
        desk.forEach(id => {
            const app = this.apps.find(a => a.id === id);
            if (!app) return;
            const d = document.createElement('div');
            d.className = 'dicon';
            d.innerHTML = `<div class="dicon-img">${app.icon}</div><div class="dicon-lbl">${app.name}</div>`;
            d.ondblclick = () => this.open(id);
            d.onclick = () => { c.querySelectorAll('.dicon').forEach(x => x.classList.remove('sel')); d.classList.add('sel'); };
            c.appendChild(d);
        });
    },

    initStart() {
        const g = document.getElementById('start-grid');
        g.innerHTML = '';
        this.apps.forEach(app => {
            const d = document.createElement('div');
            d.className = 'sapp';
            d.innerHTML = `<div class="sapp-icon">${app.icon}</div><div class="sapp-name">${app.name}</div>`;
            d.onclick = () => { this.open(app.id); this.closeStart(); };
            g.appendChild(d);
        });
    },

    toggleStart() {
        this.startOpen = !this.startOpen;
        document.getElementById('start').style.display = this.startOpen ? 'flex' : 'none';
        if (this.startOpen) document.getElementById('search-input').focus();
        this.qpanelOpen = false;
        document.getElementById('qpanel').style.display = 'none';
    },

    closeStart() {
        this.startOpen = false;
        document.getElementById('start').style.display = 'none';
    },

    toggleQPanel() {
        this.qpanelOpen = !this.qpanelOpen;
        document.getElementById('qpanel').style.display = this.qpanelOpen ? 'block' : 'none';
        this.closeStart();
    },

    toggleSpot() {
        this.spotOpen = !this.spotOpen;
        document.getElementById('spotlight').style.display = this.spotOpen ? 'block' : 'none';
        if (this.spotOpen) {
            document.getElementById('spot-input').value = '';
            document.getElementById('spot-input').focus();
            this.updateSpotlight('');
        }
    },

    updateSpotlight(q) {
        const r = document.getElementById('spotlight-results');
        r.innerHTML = '';
        const results = this.apps.filter(a => a.name.toLowerCase().includes(q.toLowerCase()));
        results.forEach((app, i) => {
            const d = document.createElement('div');
            d.className = 'spot-item' + (i === 0 ? ' sel' : '');
            d.innerHTML = `<div class="spot-icon">${app.icon}</div><div class="spot-info"><div class="spot-title">${app.name}</div><div class="spot-sub">Application</div></div>`;
            d.onclick = () => { this.open(app.id); this.toggleSpot(); };
            r.appendChild(d);
        });
    },

    startClock() {
        const update = () => {
            const now = new Date();
            document.getElementById('clock').innerHTML = `<div>${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div><div>${now.toLocaleDateString()}</div>`;
        };
        update();
        setInterval(update, 1000);
    },

    // Window Management
    createWin(opts) {
        const id = 'w' + Date.now();
        const w = document.createElement('div');
        w.className = 'win';
        w.id = id;
        w.style.cssText = `left:${60 + this.wins.length * 24}px;top:${40 + this.wins.length * 24}px;width:${opts.w || 800}px;height:${opts.h || 500}px;z-index:${++this.z}`;
        w.innerHTML = `<div class="win-head"><span class="win-icon">${opts.icon || 'üìÑ'}</span><span class="win-title">${opts.title || 'Window'}</span><div class="win-btns"><div class="win-btn" onclick="$.minWin('${id}')">‚îÄ</div><div class="win-btn" onclick="$.maxWin('${id}')">‚ñ°</div><div class="win-btn close" onclick="$.closeWin('${id}')">‚úï</div></div></div><div class="win-body">${opts.content || ''}</div><div class="win-resize"></div>`;
        document.getElementById('wins').appendChild(w);
        const wData = { id, title: opts.title, icon: opts.icon, el: w, max: false, min: false, prev: null };
        this.wins.push(wData);
        this.makeDrag(w);
        this.makeResize(w);
        w.onmousedown = () => this.focusWin(id);
        this.updateTaskbar();
        if (opts.onInit) opts.onInit(w.querySelector('.win-body'), wData);
        return wData;
    },

    makeDrag(w) {
        const h = w.querySelector('.win-head');
        let drag = false, sx, sy, sl, st;
        h.onmousedown = e => {
            if (e.target.closest('.win-btns')) return;
            drag = true; sx = e.clientX; sy = e.clientY; sl = w.offsetLeft; st = w.offsetTop;
            this.focusWin(w.id);
        };
        document.addEventListener('mousemove', e => {
            if (!drag) return;
            const wd = this.wins.find(x => x.id === w.id);
            if (wd?.max) return;
            w.style.left = (sl + e.clientX - sx) + 'px';
            w.style.top = (st + e.clientY - sy) + 'px';
        });
        document.addEventListener('mouseup', () => drag = false);
    },

    makeResize(w) {
        const r = w.querySelector('.win-resize');
        let resize = false, sx, sy, sw, sh;
        r.onmousedown = e => {
            resize = true; sx = e.clientX; sy = e.clientY; sw = w.offsetWidth; sh = w.offsetHeight;
            e.preventDefault();
        };
        document.addEventListener('mousemove', e => {
            if (!resize) return;
            const wd = this.wins.find(x => x.id === w.id);
            if (wd?.max) return;
            w.style.width = Math.max(280, sw + e.clientX - sx) + 'px';
            w.style.height = Math.max(180, sh + e.clientY - sy) + 'px';
        });
        document.addEventListener('mouseup', () => resize = false);
    },

    focusWin(id) {
        this.wins.forEach(w => w.el.style.zIndex = 100);
        const w = this.wins.find(x => x.id === id);
        if (w) w.el.style.zIndex = ++this.z;
        this.updateTaskbar();
    },

    minWin(id) {
        const w = this.wins.find(x => x.id === id);
        if (w) { w.min = true; w.el.classList.add('min'); this.updateTaskbar(); }
    },

    maxWin(id) {
        const w = this.wins.find(x => x.id === id);
        if (!w) return;
        if (w.max) {
            w.el.classList.remove('max');
            if (w.prev) { w.el.style.left = w.prev.l; w.el.style.top = w.prev.t; w.el.style.width = w.prev.w; w.el.style.height = w.prev.h; }
            w.max = false;
        } else {
            w.prev = { l: w.el.style.left, t: w.el.style.top, w: w.el.style.width, h: w.el.style.height };
            w.el.classList.add('max');
            w.max = true;
        }
    },

    closeWin(id) {
        const i = this.wins.findIndex(x => x.id === id);
        if (i !== -1) { this.wins[i].el.remove(); this.wins.splice(i, 1); this.updateTaskbar(); }
    },

    updateTaskbar() {
        const c = document.getElementById('taskbar-apps');
        c.innerHTML = '';
        this.wins.forEach(w => {
            const d = document.createElement('div');
            d.className = 'tapp' + (!w.min && w.el.style.zIndex == this.z ? ' active' : '');
            d.innerHTML = `<span class="tapp-icon">${w.icon}</span><span class="tapp-title">${w.title}</span>`;
            d.onclick = () => {
                if (w.min) { w.min = false; w.el.classList.remove('min'); }
                this.focusWin(w.id);
            };
            c.appendChild(d);
        });
    },

    // App Openers
    open(id) {
        const openers = {
            files: () => this.openFiles(),
            terminal: () => this.openTerminal(),
            devenv: () => this.openDevEnv(),
            code: () => this.openCode(),
            browser: () => this.openBrowser(),
            python: () => this.openPython(),
            linux: () => this.openLinux(),
            dosbox: () => this.openDosBox(),
            videoeditor: () => this.openVideoEditor(),
            calc: () => this.openCalc(),
            notes: () => this.openNotes(),
            tasks: () => this.openTasks(),
            calendar: () => this.openCalendar(),
            music: () => this.openMusic(),
            weather: () => this.openWeather(),
            photos: () => this.openPhotos(),
            markdown: () => this.openMarkdown(),
            clock: () => this.openClock(),
            settings: () => this.openSettings(),
            taskmgr: () => this.openTaskMgr(),
            about: () => this.openAbout(),
            infinite: () => this.openInfinite()
        };
        if (openers[id]) openers[id]();
    },

    // === APPLICATIONS ===

    currentPath: 'C:/Users/User',

    openFiles(path) {
        path = path || this.currentPath;
        this.createWin({
            title: 'Files', icon: 'üìÅ', w: 850, h: 550,
            content: `<div class="files"><div class="files-side"><div class="files-side-item sel" data-path="C:/Users/User">üè† Home</div><div class="files-side-item" data-path="C:/Users/User/Desktop">üñ•Ô∏è Desktop</div><div class="files-side-item" data-path="C:/Users/User/Documents">üìÑ Documents</div><div class="files-side-item" data-path="C:/Users/User/Pictures">üñºÔ∏è Pictures</div><div class="files-side-item" data-path="C:/Users/User/Downloads">‚¨áÔ∏è Downloads</div></div><div class="files-main"><div class="files-toolbar"><button onclick="$.filesBack(this)">‚Üê</button><input class="files-path" value="${path}" readonly><button onclick="$.newFolder(this)">+ Folder</button><button onclick="$.newFile(this)">+ File</button></div><div class="files-grid"></div></div></div>`,
            onInit: (body) => {
                this.renderFiles(body, path);
                body.querySelectorAll('.files-side-item').forEach(item => {
                    item.onclick = () => {
                        body.querySelectorAll('.files-side-item').forEach(x => x.classList.remove('sel'));
                        item.classList.add('sel');
                        this.renderFiles(body, item.dataset.path);
                    };
                });
            }
        });
    },

    renderFiles(body, path) {
        this.currentPath = path;
        body.querySelector('.files-path').value = path;
        const grid = body.querySelector('.files-grid');
        grid.innerHTML = '';
        const folder = this.getFolder(path);
        if (!folder?.children) return;
        Object.entries(folder.children).forEach(([name, item]) => {
            const d = document.createElement('div');
            d.className = 'file';
            const icon = item.type === 'folder' ? 'üìÅ' : this.fileIcon(name);
            d.innerHTML = `<div class="file-icon">${icon}</div><div class="file-name">${name}</div>`;
            d.ondblclick = () => {
                if (item.type === 'folder') this.renderFiles(body, path + '/' + name);
                else this.openFileWith(path + '/' + name, item);
            };
            grid.appendChild(d);
        });
    },

    filesBack(btn) {
        const body = btn.closest('.files');
        const path = body.querySelector('.files-path').value;
        const parts = path.split('/');
        if (parts.length > 1) {
            parts.pop();
            this.renderFiles(body, parts.join('/') || 'C:');
        }
    },

    newFolder(btn) {
        const name = prompt('Folder name:');
        if (!name) return;
        const body = btn.closest('.files');
        const path = body.querySelector('.files-path').value;
        const folder = this.getFolder(path);
        if (folder?.children) {
            folder.children[name] = { type: 'folder', children: {} };
            this.save();
            this.renderFiles(body, path);
        }
    },

    newFile(btn) {
        const name = prompt('File name:');
        if (!name) return;
        const body = btn.closest('.files');
        const path = body.querySelector('.files-path').value;
        const folder = this.getFolder(path);
        if (folder?.children) {
            folder.children[name] = { type: 'file', content: '' };
            this.save();
            this.renderFiles(body, path);
        }
    },

    getFolder(path) {
        const parts = path.split('/').filter(p => p);
        let cur = this.fs;
        for (const p of parts) {
            if (cur[p]) cur = cur[p].children || cur[p];
            else if (cur.children?.[p]) cur = cur.children[p];
            else return null;
        }
        return cur.children ? cur : { children: cur };
    },

    fileIcon(name) {
        const ext = name.split('.').pop().toLowerCase();
        const icons = { txt: 'üìÑ', md: 'üìÑ', js: 'üìú', html: 'üåê', css: 'üé®', json: 'üìã', jpg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è', mp3: 'üéµ', mp4: 'üé¨', pdf: 'üìï', zip: 'üì¶' };
        return icons[ext] || 'üìÑ';
    },

    openFileWith(path, item) {
        const name = path.split('/').pop();
        const ext = name.split('.').pop().toLowerCase();
        if (ext === 'md') this.openMarkdown(item.content, name);
        else this.openCode(item.content, name);
    },

    openTerminal() {
        this.createWin({
            title: 'Terminal', icon: 'üíª', w: 750, h: 480,
            content: `<div class="term"><div class="term-line" style="color:var(--green)">InfiniteOS v${this.v} - Real WebAssembly Shell</div><div class="term-line" style="color:var(--fg2)">Type 'help' for commands. All commands execute REAL code.</div><div class="term-line"></div></div>`,
            onInit: (body) => this.addTermInput(body.querySelector('.term'))
        });
    },

    addTermInput(term) {
        const line = document.createElement('div');
        line.className = 'term-input';
        // Use real shell cwd
        const cwd = this.shell.cwd.replace('/home/user', '~');
        line.innerHTML = `<span class="term-prompt">${this.user.name}@infiniteos:${cwd}$ </span><input type="text" autofocus>`;
        term.appendChild(line);
        const inp = line.querySelector('input');
        inp.focus();
        inp.onkeydown = async (e) => {
            if (e.key === 'Enter') {
                const cmd = inp.value.trim();
                inp.disabled = true;

                if (!cmd) {
                    this.addTermInput(term);
                    return;
                }

                // Output function for streaming output
                const output = (text) => {
                    const lines = text.split('\n');
                    for (const l of lines) {
                        const o = document.createElement('div');
                        o.className = 'term-line';
                        // Handle ANSI colors
                        o.innerHTML = l.replace(/\x1b\[34m/g, '<span style="color:var(--accent)">')
                                        .replace(/\x1b\[0m/g, '</span>')
                                        .replace(/\x1b\[2J\x1b\[H/g, '');
                        term.appendChild(o);
                    }
                    term.scrollTop = term.scrollHeight;
                };

                // Handle clear specially
                if (cmd === 'clear') {
                    term.innerHTML = '';
                    this.addTermInput(term);
                    return;
                }

                // Execute via REAL shell
                try {
                    const result = await this.shell.exec(cmd, output);
                    if (result) output(result);
                } catch (e) {
                    output(`Error: ${e.message}`);
                }

                this.addTermInput(term);
                term.scrollTop = term.scrollHeight;
            }
        };
    },

    execCmd(cmd) {
        const [c, ...args] = cmd.toLowerCase().split(' ');
        const cmds = {
            help: () => `Commands: help, clear, echo, date, whoami, pwd, ls, cd, cat, mkdir, touch, rm, neofetch, fortune, cowsay, calc, weather, joke, reboot, exit`,
            clear: () => { document.querySelector('.term').innerHTML = ''; return ''; },
            echo: () => args.join(' '),
            date: () => new Date().toString(),
            whoami: () => this.user.name,
            pwd: () => this.currentPath,
            ls: () => {
                const f = this.getFolder(this.currentPath);
                return f?.children ? Object.keys(f.children).join('  ') : 'Empty';
            },
            cd: () => {
                if (!args[0]) return this.currentPath;
                if (args[0] === '..') {
                    const p = this.currentPath.split('/');
                    if (p.length > 1) { p.pop(); this.currentPath = p.join('/') || 'C:'; }
                } else {
                    const newPath = this.currentPath + '/' + args[0];
                    if (this.getFolder(newPath)) this.currentPath = newPath;
                    else return 'Directory not found';
                }
                return '';
            },
            cat: () => {
                if (!args[0]) return 'Usage: cat <filename>';
                const f = this.getFolder(this.currentPath);
                const file = f?.children?.[args[0]];
                return file?.type === 'file' ? file.content : 'File not found';
            },
            mkdir: () => {
                if (!args[0]) return 'Usage: mkdir <dirname>';
                const f = this.getFolder(this.currentPath);
                if (f?.children) { f.children[args[0]] = { type: 'folder', children: {} }; this.save(); return 'Created ' + args[0]; }
                return 'Error';
            },
            touch: () => {
                if (!args[0]) return 'Usage: touch <filename>';
                const f = this.getFolder(this.currentPath);
                if (f?.children) { f.children[args[0]] = { type: 'file', content: '' }; this.save(); return 'Created ' + args[0]; }
                return 'Error';
            },
            rm: () => {
                if (!args[0]) return 'Usage: rm <name>';
                const f = this.getFolder(this.currentPath);
                if (f?.children?.[args[0]]) { delete f.children[args[0]]; this.save(); return 'Deleted ' + args[0]; }
                return 'Not found';
            },
            neofetch: () => `<span style="color:var(--accent)">
   ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ</span>    ${this.user.name}@infiniteos
<span style="color:var(--accent)">   ‚îÇ   ‚ôæÔ∏è ‚ôæÔ∏è ‚ôæÔ∏è   ‚îÇ</span>    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
<span style="color:var(--accent)">   ‚îÇ  ‚ôæÔ∏è    ‚ôæÔ∏è  ‚îÇ</span>    <span style="color:var(--accent)">OS:</span> InfiniteOS ${this.v}
<span style="color:var(--accent)">   ‚îÇ   ‚ôæÔ∏è ‚ôæÔ∏è ‚ôæÔ∏è   ‚îÇ</span>    <span style="color:var(--accent)">Kernel:</span> Browser JS
<span style="color:var(--accent)">   ‚îÇ  ‚ôæÔ∏è    ‚ôæÔ∏è  ‚îÇ</span>    <span style="color:var(--accent)">Shell:</span> InfShell
<span style="color:var(--accent)">   ‚îÇ   ‚ôæÔ∏è ‚ôæÔ∏è ‚ôæÔ∏è   ‚îÇ</span>    <span style="color:var(--accent)">Resolution:</span> ${innerWidth}x${innerHeight}
<span style="color:var(--accent)">   ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ</span>    <span style="color:var(--accent)">Windows:</span> ${this.wins.length}`,
            fortune: () => {
                const f = ['The best time to plant a tree was 20 years ago.', 'In the middle of difficulty lies opportunity.', 'A journey of a thousand miles begins with a single step.', 'The only way to do great work is to love what you do.', 'Everything you can imagine is real.'];
                return f[Math.floor(Math.random() * f.length)];
            },
            cowsay: () => {
                const m = args.join(' ') || 'Moo!';
                return `  ${'_'.repeat(m.length + 2)}
 < ${m} >
  ${'-'.repeat(m.length + 2)}
        \\   ^__^
         \\  (oo)\\_______
            (__)\\       )\\/\\
                ||----w |
                ||     ||`;
            },
            calc: () => { try { return eval(args.join('')); } catch { return 'Error'; } },
            weather: () => 'üå§Ô∏è 72¬∞F Sunny | Humidity: 65% | Wind: 12 mph',
            joke: () => {
                const j = ['Why do programmers prefer dark mode? Because light attracts bugs!', 'There are only 10 types of people: those who understand binary and those who don\'t.', 'A SQL query walks into a bar, walks up to two tables and asks... "Can I join you?"'];
                return j[Math.floor(Math.random() * j.length)];
            },
            reboot: () => { this.restart(); return 'Rebooting...'; },
            exit: () => { setTimeout(() => { const w = this.wins.find(x => x.title === 'Terminal'); if (w) this.closeWin(w.id); }, 50); return 'Goodbye!'; }
        };
        return cmds[c] ? cmds[c]() : (cmd ? `Command not found: ${c}` : '');
    },

    // ========== WASM APPLICATIONS ==========

    // Python IDE with real Pyodide execution
    openPython() {
        this.createWin({
            title: 'Python', icon: 'üêç', w: 1000, h: 650,
            content: '<div class="pyide"></div>',
            onInit: (body) => {
                const container = body.querySelector('.pyide');
                this.loadRuntime('python', container, (pyodide) => {
                    this.initPythonIDE(container, pyodide);
                });
            }
        });
    },

    initPythonIDE(container, pyodide) {
        container.innerHTML = `
            <div class="pyide-toolbar">
                <button class="run" onclick="$.runPython()">‚ñ∂ Run</button>
                <button onclick="$.clearPyConsole()">Clear</button>
                <button onclick="$.installPyPackage()">üì¶ Install Package</button>
                <button onclick="$.loadPyExample('numpy')">NumPy Demo</button>
                <button onclick="$.loadPyExample('matplotlib')">Plot Demo</button>
                <span style="margin-left:auto;color:var(--green);font-size:11px">‚úì Python ${pyodide.version} Ready</span>
            </div>
            <div class="pyide-main">
                <div class="pyide-editor">
                    <textarea class="pyide-code" id="py-code" spellcheck="false"># Python 3.12 - Powered by Pyodide (WebAssembly)
# Full Python with NumPy, Pandas, Matplotlib support!

def fibonacci(n):
    """Generate Fibonacci sequence"""
    a, b = 0, 1
    result = []
    for _ in range(n):
        result.append(a)
        a, b = b, a + b
    return result

# Run it!
fib = fibonacci(15)
print(f"Fibonacci sequence: {fib}")
print(f"Sum: {sum(fib)}")

# You can also use list comprehensions
squares = [x**2 for x in range(10)]
print(f"Squares: {squares}")</textarea>
                </div>
                <div class="pyide-output">
                    <div class="pyide-output-header">Output</div>
                    <div class="pyide-console" id="py-console"></div>
                    <div class="pyide-repl">
                        <span class="pyide-repl-prompt">>>></span>
                        <input type="text" id="py-repl" placeholder="Enter Python expression...">
                    </div>
                </div>
            </div>
        `;

        // Set up output capture
        this.pyodideOutput = (text, isError) => {
            const console = document.getElementById('py-console');
            if (console) {
                const line = document.createElement('div');
                line.className = isError ? 'error' : '';
                line.textContent = text;
                console.appendChild(line);
                console.scrollTop = console.scrollHeight;
            }
        };

        // REPL input
        document.getElementById('py-repl').onkeydown = async (e) => {
            if (e.key === 'Enter') {
                const input = e.target;
                const code = input.value;
                input.value = '';
                this.pyodideOutput(`>>> ${code}`);
                try {
                    const result = await this.wasmRuntimes.python.instance.runPythonAsync(code);
                    if (result !== undefined) this.pyodideOutput(String(result));
                } catch (err) {
                    this.pyodideOutput(err.message, true);
                }
            }
        };
    },

    async runPython() {
        const code = document.getElementById('py-code')?.value;
        const console = document.getElementById('py-console');
        if (!code || !console) return;

        console.innerHTML = '<div class="success">Running...</div>';

        try {
            const pyodide = this.wasmRuntimes.python.instance;
            await pyodide.runPythonAsync(code);
            const lastLine = document.createElement('div');
            lastLine.className = 'success';
            lastLine.textContent = '‚úì Execution complete';
            console.appendChild(lastLine);
        } catch (err) {
            const errLine = document.createElement('div');
            errLine.className = 'error';
            errLine.textContent = err.message;
            console.appendChild(errLine);
        }
    },

    clearPyConsole() {
        const console = document.getElementById('py-console');
        if (console) console.innerHTML = '';
    },

    async installPyPackage() {
        const pkg = prompt('Enter package name (e.g., numpy, pandas, requests):');
        if (!pkg) return;

        const console = document.getElementById('py-console');
        console.innerHTML += `<div>Installing ${pkg}...</div>`;

        try {
            const pyodide = this.wasmRuntimes.python.instance;
            await pyodide.loadPackage(pkg);
            console.innerHTML += `<div class="success">‚úì ${pkg} installed successfully</div>`;
        } catch (err) {
            console.innerHTML += `<div class="error">Failed to install ${pkg}: ${err.message}</div>`;
        }
    },

    loadPyExample(type) {
        const codeEl = document.getElementById('py-code');
        if (!codeEl) return;

        const examples = {
            numpy: `# NumPy Demo - Scientific Computing
import numpy as np

# Create arrays
a = np.array([1, 2, 3, 4, 5])
b = np.linspace(0, 10, 5)

print(f"Array a: {a}")
print(f"Array b: {b}")
print(f"Sum: {a + b}")
print(f"Mean: {np.mean(a)}")
print(f"Std Dev: {np.std(a):.2f}")

# Matrix operations
matrix = np.array([[1, 2], [3, 4]])
print(f"\\nMatrix:\\n{matrix}")
print(f"Determinant: {np.linalg.det(matrix)}")`,

            matplotlib: `# Matplotlib Demo - Data Visualization
# Note: Plots will appear as base64 images

import matplotlib.pyplot as plt
import numpy as np
import io
import base64

# Generate data
x = np.linspace(0, 2 * np.pi, 100)
y1 = np.sin(x)
y2 = np.cos(x)

# Create plot
plt.figure(figsize=(8, 4))
plt.plot(x, y1, label='sin(x)', color='blue')
plt.plot(x, y2, label='cos(x)', color='red')
plt.xlabel('x')
plt.ylabel('y')
plt.title('Trigonometric Functions')
plt.legend()
plt.grid(True, alpha=0.3)

# Save to base64
buf = io.BytesIO()
plt.savefig(buf, format='png', dpi=100)
buf.seek(0)
img_base64 = base64.b64encode(buf.read()).decode('utf-8')
plt.close()

print(f'<img src="data:image/png;base64,{img_base64}" style="max-width:100%">')`
        };

        codeEl.value = examples[type] || examples.numpy;
    },

    // ========== REAL LINUX (v86 x86 Emulator) ==========
    // Boots actual Alpine Linux - full Unix compatibility

    // ===== VIRTUAL MACHINE MANAGER (UTM-like) =====
    vmDB: null,
    vmDBName: 'InfiniteOS_VMs',
    vmStoreName: 'snapshots',
    currentVM: null,
    currentVMId: null,
    vmPaused: false,
    vmClipboard: '',

    // VM Configuration
    vmConfig: {
        ramOptions: [128, 256, 512, 768, 1024], // MB
        defaultRam: 256,
        vgaMemory: 8, // MB
        resolutions: [
            { name: '640x480 (VGA)', w: 640, h: 480 },
            { name: '800x600 (SVGA)', w: 800, h: 600 },
            { name: '1024x768 (XGA)', w: 1024, h: 768 },
            { name: '1280x1024 (SXGA)', w: 1280, h: 1024 }
        ],
        defaultResolution: 1
    },

    linuxImages: {
        alpine: {
            name: 'Alpine Linux 3.19',
            description: 'Lightweight Linux with networking, apk packages, BusyBox',
            cdrom: 'https://copy.sh/v86/images/linux4.iso',
            size: '~25MB',
            features: ['Networking', 'Package Manager', 'Shell'],
            icon: 'üèîÔ∏è'
        },
        arch: {
            name: 'Arch Linux',
            description: 'Full Arch installation - pacman, systemd, full userspace',
            state: 'https://copy.sh/v86/images/arch-state.bin',
            size: '~150MB',
            features: ['Full Desktop', 'Pacman', 'SystemD'],
            icon: 'üéØ'
        },
        buildroot: {
            name: 'Buildroot Linux',
            description: 'Minimal Linux - instant boot, basic shell',
            bzimage: 'https://cdn.jsdelivr.net/npm/v86@0.9.4/images/bzImage',
            initrd: 'https://cdn.jsdelivr.net/npm/v86@0.9.4/images/rootfs.cpio',
            size: '~8MB',
            features: ['Fast Boot', 'Minimal'],
            icon: 'üì¶'
        },
        debian: {
            name: 'Debian',
            description: 'Debian stable with apt package manager',
            state: 'https://copy.sh/v86/images/debian-state-usrmerge.bin',
            size: '~200MB',
            features: ['APT', 'Stable', 'Full System'],
            icon: 'üåÄ'
        },
        windows98: {
            name: 'Windows 98',
            description: 'Classic Windows 98 - GUI, games, nostalgia',
            state: 'https://copy.sh/v86/images/windows98-state.bin',
            size: '~50MB',
            features: ['GUI', 'Classic Games', 'MS-DOS'],
            icon: 'ü™ü'
        },
        freedos: {
            name: 'FreeDOS',
            description: 'DOS-compatible OS - run classic DOS programs',
            cdrom: 'https://copy.sh/v86/images/freedos722.img',
            size: '~1MB',
            features: ['DOS Compatible', 'Fast', 'Retro'],
            icon: 'üíæ'
        },
        kolibri: {
            name: 'KolibriOS',
            description: 'Tiny graphical OS written entirely in assembly',
            cdrom: 'https://copy.sh/v86/images/kolibri.img',
            size: '~1.4MB',
            features: ['GUI', 'Assembly', 'Ultra Fast'],
            icon: 'üê¶'
        },
        haiku: {
            name: 'Haiku (BeOS)',
            description: 'Open-source BeOS successor with unique desktop',
            state: 'https://copy.sh/v86/images/haiku-state.bin',
            size: '~300MB',
            features: ['BeOS', 'Desktop', 'Alternative OS'],
            icon: 'üçÉ'
        }
    },

    // Initialize VM Database (IndexedDB for persistent storage)
    async initVMDatabase() {
        if (this.vmDB) return this.vmDB;

        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.vmDBName, 2);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.vmDB = request.result;
                resolve(this.vmDB);
            };
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.vmStoreName)) {
                    const store = db.createObjectStore(this.vmStoreName, { keyPath: 'id' });
                    store.createIndex('distro', 'distro', { unique: false });
                    store.createIndex('created', 'created', { unique: false });
                }
                if (!db.objectStoreNames.contains('vmDisks')) {
                    db.createObjectStore('vmDisks', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('customISOs')) {
                    db.createObjectStore('customISOs', { keyPath: 'id' });
                }
            };
        });
    },

    // Save VM snapshot to IndexedDB
    async vmSaveSnapshot(name) {
        if (!this.currentVM) return;

        try {
            await this.initVMDatabase();
            const state = await this.currentVM.save_state();
            const snapshot = {
                id: 'snap_' + Date.now(),
                name: name || 'Snapshot ' + new Date().toLocaleString(),
                distro: this.currentVMId,
                state: state,
                created: Date.now(),
                ram: this.currentVMRam || 256,
                thumbnail: await this.vmCaptureThumbnail()
            };

            const tx = this.vmDB.transaction(this.vmStoreName, 'readwrite');
            const store = tx.objectStore(this.vmStoreName);
            await new Promise((resolve, reject) => {
                const req = store.put(snapshot);
                req.onsuccess = resolve;
                req.onerror = reject;
            });

            this.notify('VM Manager', 'Snapshot saved: ' + snapshot.name, 'üíæ');
            return snapshot.id;
        } catch (e) {
            this.notify('VM Manager', 'Snapshot failed: ' + e.message, '‚ùå');
            throw e;
        }
    },

    // Capture thumbnail from VM screen
    async vmCaptureThumbnail() {
        try {
            const canvas = document.querySelector('#vm-screen canvas');
            if (!canvas) return null;
            const thumb = document.createElement('canvas');
            thumb.width = 160;
            thumb.height = 120;
            const ctx = thumb.getContext('2d');
            ctx.drawImage(canvas, 0, 0, 160, 120);
            return thumb.toDataURL('image/jpeg', 0.6);
        } catch (e) {
            return null;
        }
    },

    // Load snapshots from IndexedDB
    async vmGetSnapshots(distro) {
        await this.initVMDatabase();
        return new Promise((resolve, reject) => {
            const tx = this.vmDB.transaction(this.vmStoreName, 'readonly');
            const store = tx.objectStore(this.vmStoreName);
            const index = distro ? store.index('distro') : store;
            const request = distro ? index.getAll(distro) : store.getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
        });
    },

    // Delete snapshot
    async vmDeleteSnapshot(id) {
        await this.initVMDatabase();
        return new Promise((resolve, reject) => {
            const tx = this.vmDB.transaction(this.vmStoreName, 'readwrite');
            const store = tx.objectStore(this.vmStoreName);
            const req = store.delete(id);
            req.onsuccess = resolve;
            req.onerror = reject;
        });
    },

    // Store custom ISO
    async vmStoreCustomISO(file) {
        await this.initVMDatabase();
        const arrayBuffer = await file.arrayBuffer();
        const iso = {
            id: 'iso_' + Date.now(),
            name: file.name,
            size: file.size,
            data: arrayBuffer,
            created: Date.now()
        };

        return new Promise((resolve, reject) => {
            const tx = this.vmDB.transaction('customISOs', 'readwrite');
            const store = tx.objectStore('customISOs');
            const req = store.put(iso);
            req.onsuccess = () => resolve(iso);
            req.onerror = reject;
        });
    },

    // Get stored ISOs
    async vmGetCustomISOs() {
        await this.initVMDatabase();
        return new Promise((resolve, reject) => {
            const tx = this.vmDB.transaction('customISOs', 'readonly');
            const store = tx.objectStore('customISOs');
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = reject;
        });
    },

    // Main VM Manager Window (UTM-style)
    openLinux() {
        this.createWin({
            title: 'Virtual Machines', icon: 'üñ•Ô∏è', w: 1100, h: 750, maximized: false,
            content: '<div class="vm-manager" style="display:flex;height:100%;background:#1a1a2e"></div>',
            onInit: (body) => {
                const container = body.querySelector('.vm-manager');
                this.showVMManager(container);
            }
        });
    },

    // Check if user has seen the VM tutorial
    vmTutorialSeen: localStorage.getItem('infiniteos_vm_tutorial') === 'true',
    vmTutorialStep: 0,

    // Interactive Tutorial
    vmShowTutorial(container) {
        const steps = [
            {
                title: 'Welcome to Virtual Machines! üñ•Ô∏è',
                content: 'This app lets you run <strong>real operating systems</strong> directly in your browser - just like UTM on Mac.',
                icon: 'üëã',
                highlight: null
            },
            {
                title: 'Step 1: Choose an OS',
                content: 'Scroll down to the <strong>"OS Gallery"</strong> section. You\'ll see 16+ operating systems ready to install.',
                icon: 'üì•',
                tip: 'Look for the green "Ready" badge - those work best!'
            },
            {
                title: 'Step 2: One-Click Install',
                content: 'Click the <strong>"üöÄ Install & Boot"</strong> button on any OS. The app will automatically download and start it.',
                icon: 'üöÄ',
                tip: 'Try KolibriOS first - it\'s only 1.4MB and boots instantly!'
            },
            {
                title: 'Step 3: Use the VM',
                content: 'Once booted, you can:<br>‚Ä¢ Use keyboard and mouse normally<br>‚Ä¢ Take screenshots üì∑<br>‚Ä¢ Save your session üíæ<br>‚Ä¢ Go fullscreen ‚õ∂',
                icon: '‚å®Ô∏è'
            },
            {
                title: 'Step 4: Save Your Work',
                content: 'Click <strong>üíæ Save</strong> to create a snapshot. Your entire VM state is saved to your browser - resume anytime!',
                icon: 'üíæ',
                tip: 'Snapshots appear in the sidebar for quick access.'
            },
            {
                title: 'Bonus: Custom ISOs',
                content: 'Have your own ISO file? Just <strong>drag and drop</strong> it into the sidebar to boot any 32-bit OS.',
                icon: 'üíø',
                tip: 'Only 32-bit (i386/x86) ISOs work - not 64-bit.'
            },
            {
                title: 'You\'re Ready! üéâ',
                content: 'That\'s everything! Click <strong>"Let\'s Go"</strong> to start exploring the OS Gallery.',
                icon: '‚ú®',
                final: true
            }
        ];

        this.vmTutorialStep = 0;

        const renderStep = () => {
            const step = steps[this.vmTutorialStep];
            const isFirst = this.vmTutorialStep === 0;
            const isLast = this.vmTutorialStep === steps.length - 1;
            const progress = ((this.vmTutorialStep + 1) / steps.length * 100).toFixed(0);

            let html = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px;text-align:center;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%)">';

            // Progress bar
            html += '<div style="position:absolute;top:0;left:0;right:0;height:4px;background:#333">';
            html += '<div style="height:100%;background:linear-gradient(90deg,#58a6ff,#a371f7);width:' + progress + '%;transition:width 0.3s"></div>';
            html += '</div>';

            // Step indicator
            html += '<div style="position:absolute;top:20px;right:20px;color:#666;font-size:12px">Step ' + (this.vmTutorialStep + 1) + ' of ' + steps.length + '</div>';

            // Skip button
            if (!isLast) {
                html += '<button onclick="$.vmSkipTutorial(this.closest(\'.vm-manager\'))" style="position:absolute;top:20px;left:20px;background:none;border:none;color:#666;cursor:pointer;font-size:12px">Skip Tutorial ‚Üí</button>';
            }

            // Icon
            html += '<div style="font-size:72px;margin-bottom:24px;animation:bounce 1s ease infinite">' + step.icon + '</div>';

            // Add bounce animation
            if (!document.getElementById('tutorial-style')) {
                const style = document.createElement('style');
                style.id = 'tutorial-style';
                style.textContent = '@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}';
                document.head.appendChild(style);
            }

            // Title
            html += '<h2 style="color:#fff;margin:0 0 16px 0;font-size:28px">' + step.title + '</h2>';

            // Content
            html += '<p style="color:#aaa;margin:0 0 20px 0;font-size:16px;line-height:1.6;max-width:500px">' + step.content + '</p>';

            // Tip box
            if (step.tip) {
                html += '<div style="background:#1e3a5f;border:1px solid #2d5a87;border-radius:8px;padding:12px 20px;margin-bottom:24px;max-width:450px">';
                html += '<p style="color:#7dc4ff;margin:0;font-size:13px">üí° <strong>Tip:</strong> ' + step.tip + '</p>';
                html += '</div>';
            }

            // Navigation buttons
            html += '<div style="display:flex;gap:12px;margin-top:16px">';

            if (!isFirst) {
                html += '<button onclick="$.vmTutorialPrev(this.closest(\'.vm-manager\'))" style="padding:12px 24px;background:#333;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:14px">‚Üê Back</button>';
            }

            if (isLast) {
                html += '<button onclick="$.vmFinishTutorial(this.closest(\'.vm-manager\'))" style="padding:12px 32px;background:linear-gradient(90deg,#58a6ff,#a371f7);border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600">üöÄ Let\'s Go!</button>';
            } else {
                html += '<button onclick="$.vmTutorialNext(this.closest(\'.vm-manager\'))" style="padding:12px 32px;background:#58a6ff;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">Next ‚Üí</button>';
            }

            html += '</div>';

            // Dots indicator
            html += '<div style="display:flex;gap:8px;margin-top:32px">';
            for (let i = 0; i < steps.length; i++) {
                const active = i === this.vmTutorialStep;
                html += '<div style="width:' + (active ? '24px' : '8px') + ';height:8px;border-radius:4px;background:' + (active ? '#58a6ff' : '#333') + ';transition:all 0.3s"></div>';
            }
            html += '</div>';

            html += '</div>';
            container.innerHTML = html;
        };

        renderStep();

        // Store render function for navigation
        this._tutorialRender = renderStep;
    },

    vmTutorialNext(container) {
        this.vmTutorialStep++;
        this._tutorialRender();
    },

    vmTutorialPrev(container) {
        this.vmTutorialStep--;
        this._tutorialRender();
    },

    vmSkipTutorial(container) {
        this.vmTutorialSeen = true;
        localStorage.setItem('infiniteos_vm_tutorial', 'true');
        this.showVMManager(container);
    },

    vmFinishTutorial(container) {
        this.vmTutorialSeen = true;
        localStorage.setItem('infiniteos_vm_tutorial', 'true');
        this.notify('VM Manager', 'Tutorial complete! Scroll down to the OS Gallery.', 'üéâ');
        this.showVMManager(container);
    },

    async showVMManager(container) {
        const snapshots = await this.vmGetSnapshots();
        const customISOs = await this.vmGetCustomISOs();

        // Show tutorial on first visit
        if (!this.vmTutorialSeen) {
            this.vmShowTutorial(container);
            return;
        }

        let html = '<div class="vm-sidebar" style="width:280px;background:#12122a;border-right:1px solid #333;display:flex;flex-direction:column;flex-shrink:0">';

        // Header
        html += '<div style="padding:16px;border-bottom:1px solid #333">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center">';
        html += '<h2 style="color:#fff;margin:0 0 4px 0;font-size:18px">üñ•Ô∏è Virtual Machines</h2>';
        html += '<button onclick="$.vmShowTutorial(this.closest(\'.vm-manager\'))" style="background:none;border:none;color:#58a6ff;cursor:pointer;font-size:12px" title="Show Tutorial">‚ùì</button>';
        html += '</div>';
        html += '<p style="color:#666;margin:0;font-size:11px">Like UTM, but in your browser</p>';
        html += '</div>';

        // Create New VM button
        html += '<div style="padding:12px">';
        html += '<button onclick="$.vmShowCreateDialog(this)" style="width:100%;padding:10px;background:#58a6ff;border:none;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">+ Create New VM</button>';
        html += '</div>';

        // Saved Snapshots
        html += '<div style="padding:0 12px;flex:1;overflow-y:auto">';
        html += '<div style="color:#888;font-size:11px;text-transform:uppercase;margin-bottom:8px;padding:0 4px">Saved Snapshots (' + snapshots.length + ')</div>';

        if (snapshots.length === 0) {
            html += '<div style="color:#555;font-size:12px;padding:16px;text-align:center;background:#1a1a2e;border-radius:6px">No saved snapshots yet.<br>Boot a VM and save its state!</div>';
        } else {
            for (const snap of snapshots.sort((a, b) => b.created - a.created)) {
                const img = this.linuxImages[snap.distro] || { icon: 'üíæ', name: snap.distro };
                html += '<div class="vm-snap-item" onclick="$.vmRestoreSnapshot(\'' + snap.id + '\', this)" style="display:flex;gap:10px;padding:10px;background:#252547;border-radius:8px;margin-bottom:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s">';
                if (snap.thumbnail) {
                    html += '<img src="' + snap.thumbnail + '" style="width:48px;height:36px;border-radius:4px;object-fit:cover">';
                } else {
                    html += '<div style="width:48px;height:36px;background:#333;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:16px">' + img.icon + '</div>';
                }
                html += '<div style="flex:1;min-width:0">';
                html += '<div style="color:#fff;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + snap.name + '</div>';
                html += '<div style="color:#666;font-size:10px">' + img.name + ' ‚Ä¢ ' + snap.ram + 'MB</div>';
                html += '</div>';
                html += '<button onclick="event.stopPropagation();$.vmDeleteSnapshotUI(\'' + snap.id + '\',this)" style="background:none;border:none;color:#f85149;cursor:pointer;padding:4px">üóëÔ∏è</button>';
                html += '</div>';
            }
        }

        // Custom ISOs section
        html += '<div style="color:#888;font-size:11px;text-transform:uppercase;margin:16px 0 8px 0;padding:0 4px">Custom ISOs (' + customISOs.length + ')</div>';
        html += '<div ondragover="event.preventDefault();this.style.borderColor=\'#58a6ff\'" ondragleave="this.style.borderColor=\'#333\'" ondrop="$.vmHandleISODrop(event,this)" style="border:2px dashed #333;border-radius:8px;padding:16px;text-align:center;transition:border-color 0.2s">';
        html += '<input type="file" id="iso-upload" accept=".iso,.img" style="display:none" onchange="$.vmHandleISOUpload(event)">';
        html += '<p style="color:#666;margin:0;font-size:12px">Drop ISO/IMG file here</p>';
        html += '<button onclick="document.getElementById(\'iso-upload\').click()" style="margin-top:8px;padding:6px 12px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">Browse Files</button>';
        html += '</div>';

        if (customISOs.length > 0) {
            for (const iso of customISOs) {
                const sizeMB = (iso.size / 1024 / 1024).toFixed(1);
                html += '<div class="vm-iso-item" style="display:flex;gap:10px;padding:8px;background:#252547;border-radius:6px;margin-top:8px;align-items:center">';
                html += '<span style="font-size:18px">üíø</span>';
                html += '<div style="flex:1;min-width:0">';
                html += '<div style="color:#fff;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + iso.name + '</div>';
                html += '<div style="color:#666;font-size:10px">' + sizeMB + ' MB</div>';
                html += '</div>';
                html += '<button onclick="$.vmBootCustomISO(\'' + iso.id + '\',this)" style="padding:4px 8px;background:#3fb950;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:10px">Boot</button>';
                html += '</div>';
            }
        }

        html += '</div></div>'; // End sidebar

        // Main content - OS Gallery
        html += '<div class="vm-main" style="flex:1;padding:20px;overflow-y:auto">';
        html += '<h3 style="color:#fff;margin:0 0 4px 0">Boot Operating System</h3>';
        html += '<p style="color:#666;margin:0 0 20px 0;font-size:12px">Select an OS to boot via x86 WASM emulation. Real binaries, real kernel.</p>';

        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">';

        for (const [id, img] of Object.entries(this.linuxImages)) {
            html += '<div class="vm-os-card" onclick="$.vmShowBootConfig(\'' + id + '\',this)" style="background:#252547;border:2px solid #3a3a5c;border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s">';
            html += '<div style="display:flex;gap:12px;align-items:flex-start">';
            html += '<div style="font-size:36px;line-height:1">' + img.icon + '</div>';
            html += '<div style="flex:1">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<h4 style="color:#fff;margin:0">' + img.name + '</h4>';
            html += '<span style="color:#666;font-size:10px;background:#1a1a2e;padding:2px 6px;border-radius:4px">' + img.size + '</span>';
            html += '</div>';
            html += '<p style="color:#888;margin:6px 0 10px 0;font-size:12px;line-height:1.4">' + img.description + '</p>';
            html += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
            for (const f of (img.features || [])) {
                html += '<span style="font-size:9px;padding:2px 6px;background:#3a3a5c;color:#aaa;border-radius:8px">' + f + '</span>';
            }
            html += '</div></div></div></div>';
        }

        html += '</div>';

        // REAL LINUX - v86 hosted images (no CORS issues!)
        html += '<div style="margin-top:32px;border-top:1px solid #333;padding-top:24px">';
        html += '<h3 style="color:#fff;margin:0 0 4px 0">üêß Real Linux & Operating Systems</h3>';
        html += '<p style="color:#666;margin:0 0 16px 0;font-size:12px">Actual OS images hosted by v86 - real kernels, real shells, no CORS issues!</p>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">';

        // Real v86 images from copy.sh
        const realOS = [
            { id: 'arch', name: 'Arch Linux', icon: 'üêß', desc: 'Full Arch Linux with pacman, bash, networking', size: '~40MB', url: 'https://copy.sh/v86/?profile=archlinux' },
            { id: 'buildroot', name: 'Buildroot Linux', icon: 'üîß', desc: 'Minimal Linux - boots in seconds!', size: '~6MB', url: 'https://copy.sh/v86/?profile=buildroot' },
            { id: 'freebsd', name: 'FreeBSD', icon: 'üòà', desc: 'FreeBSD Unix with sh shell', size: '~15MB', url: 'https://copy.sh/v86/?profile=freebsd' },
            { id: 'freedos', name: 'FreeDOS', icon: 'üíæ', desc: 'DOS-compatible OS with games!', size: '~10MB', url: 'https://copy.sh/v86/?profile=freedos' },
            { id: 'win98', name: 'Windows 98', icon: 'ü™ü', desc: 'Full Windows 98 desktop experience', size: '~100MB', url: 'https://copy.sh/v86/?profile=windows98' },
            { id: 'oberon', name: 'Oberon', icon: 'üìê', desc: 'Wirth\'s Oberon OS - unique GUI', size: '~2MB', url: 'https://copy.sh/v86/?profile=oberon' },
            { id: 'kolibri', name: 'KolibriOS', icon: 'ü¶ã', desc: 'Tiny graphical OS written in assembly', size: '~3MB', url: 'https://copy.sh/v86/?profile=kolibrios' },
            { id: 'dsl', name: 'Damn Small Linux', icon: 'üêß', desc: 'Classic lightweight distro', size: '~50MB', url: 'https://copy.sh/v86/?profile=dsl' }
        ];

        for (const os of realOS) {
            html += '<div class="real-os-card" onclick="$.bootRealOS(\'' + os.id + '\', \'' + os.url + '\', \'' + os.name + '\', \'' + os.icon + '\', this)" style="background:linear-gradient(135deg,#1a2a4a,#1e1e3f);border:2px solid #58a6ff;border-radius:10px;padding:14px;display:flex;gap:12px;cursor:pointer;transition:all 0.2s">';
            html += '<div style="font-size:28px">' + os.icon + '</div>';
            html += '<div style="flex:1">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<h4 style="color:#fff;margin:0;font-size:14px">' + os.name + '</h4>';
            html += '<span style="font-size:9px;padding:2px 8px;background:#58a6ff33;color:#58a6ff;border-radius:4px">üêß REAL</span>';
            html += '</div>';
            html += '<p style="color:#888;margin:4px 0 8px 0;font-size:11px">' + os.desc + '</p>';
            html += '<div style="display:flex;gap:8px;align-items:center">';
            html += '<span style="font-size:9px;color:#666">' + os.size + '</span>';
            html += '<span style="font-size:9px;padding:2px 6px;background:#252547;color:#58a6ff;border-radius:6px">Embedded v86</span>';
            html += '</div></div></div>';
        }

        html += '</div></div>';

        // OFFLINE / EMBEDDED Section - No network needed!
        html += '<div style="margin-top:32px;border-top:1px solid #333;padding-top:24px">';
        html += '<h3 style="color:#fff;margin:0 0 4px 0">‚ö° Instant Boot - No Download</h3>';
        html += '<p style="color:#666;margin:0 0 16px 0;font-size:12px">These boot INSTANTLY - embedded in the app, no network required!</p>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">';

        // Embedded OS options
        const embeddedOS = [
            { id: 'micro-shell', name: 'MicroOS Shell', icon: 'üñ•Ô∏è', size: '512 B', desc: 'Interactive command prompt - type anything!', features: ['Instant', 'Shell', 'x86'] },
            { id: 'micro-dos', name: 'MicroDOS', icon: 'üíæ', size: '1.44 MB', desc: 'DOS-compatible with A:\\> prompt', features: ['DOS', 'FAT12', 'Classic'] },
            { id: 'snake-os', name: 'SnakeOS', icon: 'üêç', size: '512 B', desc: 'Playable Snake game - use arrow keys!', features: ['Game', 'Fun', 'Retro'] },
            { id: 'fractal-os', name: 'FractalOS', icon: 'üåÄ', size: '512 B', desc: 'Renders colorful fractal on boot', features: ['Graphics', 'Art', 'Math'] },
            { id: 'tetris-os', name: 'TetrisOS', icon: 'üß±', size: '512 B', desc: 'Falling blocks demo', features: ['Game', 'Animation', 'Classic'] },
            { id: 'basic-os', name: 'TinyBASIC', icon: 'üìü', size: '8 KB', desc: 'Boot into BASIC interpreter', features: ['BASIC', 'Programming', 'Retro'] }
        ];

        for (const os of embeddedOS) {
            html += '<div class="embedded-os" style="background:linear-gradient(135deg,#1a3a2a,#1e1e3f);border:2px solid #3fb950;border-radius:10px;padding:14px;display:flex;gap:12px;cursor:pointer;transition:all 0.2s" onclick="$.bootEmbeddedOS(\'' + os.id + '\', this)">';
            html += '<div style="font-size:28px">' + os.icon + '</div>';
            html += '<div style="flex:1">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<h4 style="color:#fff;margin:0;font-size:14px">' + os.name + '</h4>';
            html += '<span style="font-size:9px;padding:2px 8px;background:#3fb95033;color:#3fb950;border-radius:4px">‚ö° INSTANT</span>';
            html += '</div>';
            html += '<p style="color:#888;margin:4px 0 8px 0;font-size:11px">' + os.desc + '</p>';
            html += '<div style="display:flex;gap:4px">';
            for (const f of os.features) {
                html += '<span style="font-size:9px;padding:2px 6px;background:#252547;color:#888;border-radius:6px">' + f + '</span>';
            }
            html += '</div></div></div>';
        }
        html += '</div></div>';

        // Download Distros Section - One-Click Install Gallery
        html += '<div style="margin-top:32px;border-top:1px solid #333;padding-top:24px">';
        html += '<h3 style="color:#fff;margin:0 0 4px 0">üì• OS Gallery - One-Click Install</h3>';
        html += '<p style="color:#666;margin:0 0 16px 0;font-size:12px">Click "Install & Boot" to download and run automatically - just like UTM</p>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px">';

        // Store distro catalog in the object for access by download function
        this.distroGallery = [
            { id: 'tinycore', name: 'Tiny Core Linux', icon: 'üêß', size: 23, desc: 'Ultra minimal Linux - boots in seconds, runs in RAM', url: 'https://copy.sh/v86/images/linux4.iso', features: ['16MB RAM', 'GUI Desktop', 'Fast'], ram: 128, ready: true },
            { id: 'kolibrios', name: 'KolibriOS', icon: 'üê¶', size: 1.4, desc: 'Entire OS written in assembly - instant boot', url: 'https://copy.sh/v86/images/kolibri.img', features: ['Assembly', '1.4MB', 'GUI'], ram: 128, ready: true },
            { id: 'freedos', name: 'FreeDOS', icon: 'üíæ', size: 0.7, desc: 'DOS-compatible OS - run classic programs & games', url: 'https://copy.sh/v86/images/freedos722.img', features: ['DOS', 'Retro', 'Fast'], ram: 128, ready: true },
            { id: 'dsl', name: 'Damn Small Linux', icon: 'üîß', size: 50, desc: 'Classic 50MB distro with Fluxbox desktop', url: 'https://distro.ibiblio.org/damnsmall/current/dsl-4.4.10-initrd.iso', features: ['50MB', 'Fluxbox', 'Legacy'], ram: 256, cors: true },
            { id: 'slitaz', name: 'SliTaz Rolling', icon: 'üçï', size: 55, desc: 'Fast, lightweight with GUI and package manager', url: 'https://mirror.slitaz.org/iso/rolling/slitaz-rolling-core.iso', features: ['GUI', 'Tazpkg', 'Rolling'], ram: 256, cors: true },
            { id: 'bootOS', name: 'bootOS', icon: 'üíª', size: 0.5, desc: 'Tiny 512-byte OS that fits in boot sector', url: 'https://copy.sh/v86/images/os8.img', features: ['512 bytes', 'BASIC', 'Minimal'], ram: 128, ready: true },
            { id: 'buildroot', name: 'Buildroot Linux', icon: 'üì¶', size: 8, desc: 'Minimal Linux kernel - instant shell', url: 'https://copy.sh/v86/images/linux.iso', features: ['Minimal', 'Fast', 'Shell'], ram: 128, ready: true },
            { id: 'msdos', name: 'MS-DOS Boot', icon: 'üñ•Ô∏è', size: 0.2, desc: 'Basic DOS boot disk', url: 'https://copy.sh/v86/images/msdos.img', features: ['DOS', 'Minimal', 'Classic'], ram: 128, ready: true },
            { id: 'openbsd', name: 'OpenBSD', icon: 'üê°', size: 350, desc: 'Security-focused BSD operating system', url: 'https://copy.sh/v86/images/openbsd-state.bin', features: ['BSD', 'Secure', 'Unix'], ram: 512, state: true, ready: true },
            { id: 'oberon', name: 'Oberon', icon: 'üî¨', size: 25, desc: 'Research OS by Niklaus Wirth', url: 'https://copy.sh/v86/images/oberon.img', features: ['Research', 'Unique', 'Pascal'], ram: 128, ready: true },
            { id: 'windows1', name: 'Windows 1.01', icon: 'ü™ü', size: 2, desc: 'The original Windows from 1985', url: 'https://copy.sh/v86/images/windows101.img', features: ['1985', 'Historic', 'GUI'], ram: 128, ready: true },
            { id: 'arch', name: 'Arch Linux', icon: 'üéØ', size: 150, desc: 'Full Arch with pacman & systemd (pre-saved state)', url: 'https://copy.sh/v86/images/arch-state.bin', features: ['Pacman', 'SystemD', 'Full'], ram: 512, state: true, ready: true },
            { id: 'debian', name: 'Debian', icon: 'üåÄ', size: 200, desc: 'Debian stable with apt (pre-saved state)', url: 'https://copy.sh/v86/images/debian-state-usrmerge.bin', features: ['APT', 'Stable', 'Full'], ram: 512, state: true, ready: true },
            { id: 'win98', name: 'Windows 98', icon: 'ü™ü', size: 50, desc: 'Classic Windows 98 with GUI (pre-saved state)', url: 'https://copy.sh/v86/images/windows98-state.bin', features: ['GUI', 'Games', 'Classic'], ram: 512, state: true, ready: true },
            { id: 'win2k', name: 'Windows 2000', icon: 'üñ•Ô∏è', size: 80, desc: 'Windows 2000 Professional (pre-saved state)', url: 'https://copy.sh/v86/images/windows2000-state.bin', features: ['NT', 'Pro', '2000'], ram: 512, state: true, ready: true },
            { id: 'winxp', name: 'Windows XP', icon: 'üåÑ', size: 150, desc: 'Windows XP (pre-saved state)', url: 'https://copy.sh/v86/images/windowsxp-state.bin', features: ['XP', 'Classic', 'GUI'], ram: 512, state: true, ready: true }
        ];

        for (const d of this.distroGallery) {
            const sizeStr = d.size < 1 ? (d.size * 1000) + 'KB' : d.size + 'MB';
            const statusColor = d.ready ? '#3fb950' : '#d29922';
            const statusText = d.ready ? 'Ready' : 'CORS proxy needed';

            html += '<div class="distro-card" data-id="' + d.id + '" style="background:#1e1e3f;border:1px solid #333;border-radius:10px;padding:14px;display:flex;gap:12px;align-items:flex-start;transition:all 0.2s">';
            html += '<div style="font-size:32px">' + d.icon + '</div>';
            html += '<div style="flex:1;min-width:0">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">';
            html += '<h4 style="color:#fff;margin:0;font-size:14px">' + d.name + '</h4>';
            html += '<div style="display:flex;gap:6px;align-items:center">';
            html += '<span style="font-size:9px;padding:2px 6px;background:' + statusColor + '22;color:' + statusColor + ';border-radius:4px">' + statusText + '</span>';
            html += '<span style="color:#666;font-size:10px">' + sizeStr + '</span>';
            html += '</div></div>';
            html += '<p style="color:#777;margin:4px 0 8px 0;font-size:11px;line-height:1.4">' + d.desc + '</p>';
            html += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px">';
            for (const f of d.features) {
                html += '<span style="font-size:9px;padding:2px 6px;background:#252547;color:#888;border-radius:6px">' + f + '</span>';
            }
            html += '</div>';
            html += '<div style="display:flex;gap:8px">';
            if (d.ready) {
                html += '<button onclick="$.vmInstallAndBoot(\'' + d.id + '\', this)" style="padding:8px 16px;background:#58a6ff;border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:6px"><span>üöÄ</span> Install & Boot</button>';
            } else {
                html += '<button onclick="$.vmInstallAndBoot(\'' + d.id + '\', this)" style="padding:8px 16px;background:#d29922;border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:6px"><span>‚ö†Ô∏è</span> Try Install</button>';
            }
            html += '<button onclick="$.vmShowDistroInfo(\'' + d.id + '\')" style="padding:8px 12px;background:#252547;border:none;color:#888;border-radius:6px;font-size:12px;cursor:pointer">‚ÑπÔ∏è</button>';
            html += '</div></div></div>';
        }

        html += '</div></div>';

        // Info box
        html += '<div style="margin-top:24px;padding:16px;background:#1e1e3f;border-radius:8px">';
        html += '<p style="color:#888;font-size:12px;margin:0"><strong style="color:#58a6ff">‚ö° How it works:</strong> v86 is an x86 CPU emulator compiled to WebAssembly. ';
        html += 'It boots REAL operating system images - identical to physical hardware. All packages, commands, and programs work exactly as expected. ';
        html += 'Snapshots persist in IndexedDB so you can resume your session anytime.</p>';
        html += '</div>';

        // Important limitations notice
        html += '<div style="margin-top:12px;padding:16px;background:#2d1f1f;border:1px solid #5c3030;border-radius:8px">';
        html += '<p style="color:#e88;font-size:12px;margin:0"><strong>‚ö†Ô∏è Compatibility Note:</strong> v86 emulates 32-bit x86 CPUs. ';
        html += 'Only 32-bit (i386/i686) ISOs will work. 64-bit (x86_64/amd64) ISOs will NOT boot. ';
        html += 'Look for "i386", "i686", or "x86" in download names. Modern distros often drop 32-bit support.</p>';
        html += '</div>';

        html += '</div>'; // End main

        container.innerHTML = html;

        // Add hover effects
        container.querySelectorAll('.vm-os-card').forEach(card => {
            card.onmouseenter = () => { card.style.borderColor = '#58a6ff'; card.style.transform = 'translateY(-2px)'; };
            card.onmouseleave = () => { card.style.borderColor = '#3a3a5c'; card.style.transform = 'none'; };
        });
        container.querySelectorAll('.vm-snap-item').forEach(item => {
            item.onmouseenter = () => item.style.borderColor = '#58a6ff';
            item.onmouseleave = () => item.style.borderColor = 'transparent';
        });
    },

    // Show boot configuration dialog (RAM, resolution, etc.)
    vmShowBootConfig(distro, el) {
        const img = this.linuxImages[distro];
        const container = el.closest('.vm-manager');

        const dialog = document.createElement('div');
        dialog.className = 'vm-config-dialog';
        dialog.style.cssText = 'position:absolute;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:100';

        let html = '<div style="background:#1a1a2e;border:1px solid #333;border-radius:12px;padding:24px;width:400px;max-width:90%">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
        html += '<h3 style="color:#fff;margin:0">' + img.icon + ' Boot ' + img.name + '</h3>';
        html += '<button onclick="this.closest(\'.vm-config-dialog\').remove()" style="background:none;border:none;color:#666;cursor:pointer;font-size:20px">√ó</button>';
        html += '</div>';

        // RAM selection
        html += '<div style="margin-bottom:16px">';
        html += '<label style="color:#888;font-size:12px;display:block;margin-bottom:6px">Memory (RAM)</label>';
        html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
        for (const ram of this.vmConfig.ramOptions) {
            const selected = ram === this.vmConfig.defaultRam ? 'background:#58a6ff;color:#fff' : 'background:#333;color:#aaa';
            html += '<button class="ram-btn" data-ram="' + ram + '" style="padding:8px 16px;border:none;border-radius:6px;cursor:pointer;' + selected + ';font-size:12px" onclick="this.parentNode.querySelectorAll(\'.ram-btn\').forEach(b=>b.style.background=\'#333\');this.style.background=\'#58a6ff\';this.style.color=\'#fff\'">' + ram + ' MB</button>';
        }
        html += '</div></div>';

        // Resolution selection
        html += '<div style="margin-bottom:16px">';
        html += '<label style="color:#888;font-size:12px;display:block;margin-bottom:6px">Screen Resolution</label>';
        html += '<select id="vm-resolution" style="width:100%;padding:10px;background:#252547;border:1px solid #333;border-radius:6px;color:#fff">';
        this.vmConfig.resolutions.forEach((res, i) => {
            const sel = i === this.vmConfig.defaultResolution ? 'selected' : '';
            html += '<option value="' + i + '" ' + sel + '>' + res.name + '</option>';
        });
        html += '</select></div>';

        // 9p filesystem option
        html += '<div style="margin-bottom:20px">';
        html += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer">';
        html += '<input type="checkbox" id="vm-9p" style="width:16px;height:16px">';
        html += '<span style="color:#888;font-size:12px">Enable 9P filesystem (share files with host)</span>';
        html += '</label></div>';

        // Networking
        html += '<div style="margin-bottom:20px">';
        html += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer">';
        html += '<input type="checkbox" id="vm-network" checked style="width:16px;height:16px">';
        html += '<span style="color:#888;font-size:12px">Enable networking (WebSocket relay)</span>';
        html += '</label></div>';

        // Boot button
        html += '<div style="display:flex;gap:12px">';
        html += '<button onclick="this.closest(\'.vm-config-dialog\').remove()" style="flex:1;padding:12px;background:#333;border:none;color:#fff;border-radius:6px;cursor:pointer">Cancel</button>';
        html += '<button onclick="$.vmStartBoot(\'' + distro + '\',this)" style="flex:2;padding:12px;background:#58a6ff;border:none;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">üöÄ Boot</button>';
        html += '</div></div>';

        dialog.innerHTML = html;
        container.style.position = 'relative';
        container.appendChild(dialog);
    },

    // Start VM boot with configuration
    async vmStartBoot(distro, btn) {
        const dialog = btn.closest('.vm-config-dialog');
        const container = dialog.parentElement;

        // Get configuration
        const selectedRamBtn = dialog.querySelector('.ram-btn[style*="58a6ff"]');
        const ram = selectedRamBtn ? parseInt(selectedRamBtn.dataset.ram) : this.vmConfig.defaultRam;
        const resIndex = parseInt(dialog.querySelector('#vm-resolution').value);
        const resolution = this.vmConfig.resolutions[resIndex];
        const enable9p = dialog.querySelector('#vm-9p').checked;
        const enableNetwork = dialog.querySelector('#vm-network').checked;

        dialog.remove();
        await this.bootLinux(distro, container, { ram, resolution, enable9p, enableNetwork });
    },

    // Enhanced boot function
    async bootLinux(distro, container, config = {}) {
        const img = this.linuxImages[distro];
        const ram = config.ram || this.vmConfig.defaultRam;
        const resolution = config.resolution || this.vmConfig.resolutions[this.vmConfig.defaultResolution];

        this.currentVMId = distro;
        this.currentVMRam = ram;

        // Loading screen
        container.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#1a1a2e;padding:40px">' +
            '<div style="font-size:64px;margin-bottom:20px">' + img.icon + '</div>' +
            '<h3 style="color:#fff;margin:0 0 8px 0">Booting ' + img.name + '</h3>' +
            '<p style="color:#666;margin:0 0 24px 0">RAM: ' + ram + 'MB ‚Ä¢ Resolution: ' + resolution.w + 'x' + resolution.h + '</p>' +
            '<div style="width:300px;height:4px;background:#333;border-radius:2px;overflow:hidden">' +
            '<div id="boot-progress" style="width:0%;height:100%;background:linear-gradient(90deg,#58a6ff,#a371f7);transition:width 0.3s"></div>' +
            '</div>' +
            '<p id="boot-status" style="color:#888;font-size:12px;margin-top:16px">Initializing...</p>' +
            '</div>';

        const progress = container.querySelector('#boot-progress');
        const status = container.querySelector('#boot-status');

        // Load v86
        if (!window.V86) {
            status.textContent = 'Loading x86 emulator (v86)...';
            progress.style.width = '15%';
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://copy.sh/v86/build/libv86.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load v86'));
                document.head.appendChild(script);
            });
        }

        status.textContent = 'Configuring virtual machine...';
        progress.style.width = '30%';

        // Build VM configuration
        const vmConfig = {
            wasm_path: 'https://copy.sh/v86/build/v86.wasm',
            memory_size: ram * 1024 * 1024,
            vga_memory_size: this.vmConfig.vgaMemory * 1024 * 1024,
            bios: { url: 'https://copy.sh/v86/bios/seabios.bin' },
            vga_bios: { url: 'https://copy.sh/v86/bios/vgabios.bin' },
            autostart: true,
            disable_keyboard: false,
            disable_mouse: false
        };

        // Configure boot source
        if (img.cdrom) {
            vmConfig.cdrom = { url: img.cdrom };
            vmConfig.boot_order = 0x132;
        } else if (img.state) {
            vmConfig.initial_state = { url: img.state };
        } else {
            vmConfig.bzimage = { url: img.bzimage };
            vmConfig.initrd = { url: img.initrd };
            vmConfig.cmdline = 'rw root=/dev/ram0 init=/bin/sh console=ttyS0';
        }

        // Enable 9p filesystem if requested
        if (config.enable9p) {
            vmConfig.filesystem = {};
        }

        // Enable network relay if requested and available
        if (config.enableNetwork) {
            vmConfig.network_relay_url = 'wss://relay.widgetry.org/';
        }

        status.textContent = 'Starting ' + img.name + '...';
        progress.style.width = '50%';

        await new Promise(r => setTimeout(r, 300));

        // Build VM UI
        container.innerHTML = '';
        let toolbarHtml = '<div class="vm-toolbar" style="display:flex;gap:6px;padding:8px 12px;background:#12122a;border-bottom:1px solid #333;align-items:center;flex-wrap:wrap">';

        // Control buttons
        toolbarHtml += '<div style="display:flex;gap:4px">';
        toolbarHtml += '<button onclick="$.vmSendCtrlAltDel()" title="Send Ctrl+Alt+Del" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚å®Ô∏è CAD</button>';
        toolbarHtml += '<button id="pause-btn" onclick="$.vmTogglePause(this)" title="Pause/Resume" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚è∏Ô∏è</button>';
        toolbarHtml += '<button onclick="$.vmReset()" title="Reset VM" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üîÑ</button>';
        toolbarHtml += '</div>';

        // Snapshot controls
        toolbarHtml += '<div style="display:flex;gap:4px;border-left:1px solid #333;padding-left:8px;margin-left:4px">';
        toolbarHtml += '<button onclick="$.vmQuickSave()" title="Quick Save (F5)" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üíæ Save</button>';
        toolbarHtml += '<button onclick="$.vmQuickLoad()" title="Quick Load (F9)" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üìÇ Load</button>';
        toolbarHtml += '<button onclick="$.vmDownloadState()" title="Download State File" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚¨áÔ∏è</button>';
        toolbarHtml += '</div>';

        // Display controls
        toolbarHtml += '<div style="display:flex;gap:4px;border-left:1px solid #333;padding-left:8px;margin-left:4px">';
        toolbarHtml += '<button onclick="$.vmFullscreen(this)" title="Fullscreen" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚õ∂</button>';
        toolbarHtml += '<button onclick="$.vmScreenshot()" title="Screenshot" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üì∑</button>';
        toolbarHtml += '<button onclick="$.vmToggleSerial(this)" title="Toggle Serial Console" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üìü</button>';
        toolbarHtml += '</div>';

        // Clipboard
        toolbarHtml += '<div style="display:flex;gap:4px;border-left:1px solid #333;padding-left:8px;margin-left:4px">';
        toolbarHtml += '<button onclick="$.vmPasteClipboard()" title="Paste from Host" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üìã Paste</button>';
        toolbarHtml += '</div>';

        // Status
        toolbarHtml += '<div style="margin-left:auto;display:flex;align-items:center;gap:8px">';
        toolbarHtml += '<span style="font-size:10px;color:#666;background:#1a1a2e;padding:2px 6px;border-radius:4px">' + ram + ' MB</span>';
        toolbarHtml += '<div id="vm-status-dot" style="width:8px;height:8px;background:#4ade80;border-radius:50%"></div>';
        toolbarHtml += '<span style="color:#888;font-size:12px">' + img.icon + ' ' + img.name + '</span>';
        toolbarHtml += '</div>';
        toolbarHtml += '</div>';

        container.innerHTML = toolbarHtml +
            '<div id="vm-screen" style="flex:1;background:#000;overflow:hidden;display:flex;align-items:center;justify-content:center"></div>' +
            '<div id="vm-serial" style="display:none;height:200px;background:#0d1117;overflow:auto;font-family:monospace;font-size:12px;padding:8px;color:#c9d1d9;white-space:pre-wrap;border-top:1px solid #333"></div>';

        const screenContainer = container.querySelector('#vm-screen');
        vmConfig.screen_container = screenContainer;

        // Create VM
        this.currentVM = new V86(vmConfig);
        this.vmPaused = false;

        // Event listeners
        this.currentVM.add_listener('emulator-ready', () => {
            console.log('[VM] Emulator ready');
            container.querySelector('#vm-status-dot').style.background = '#4ade80';
        });

        this.currentVM.add_listener('download-progress', (e) => {
            if (e.total > 0) {
                const pct = Math.round((e.loaded / e.total) * 100);
                console.log('[VM] Download progress:', pct + '%');
            }
        });

        // Serial output
        const serialDiv = container.querySelector('#vm-serial');
        this.currentVM.add_listener('serial0-output-byte', (byte) => {
            serialDiv.textContent += String.fromCharCode(byte);
            serialDiv.scrollTop = serialDiv.scrollHeight;
        });

        // Keyboard shortcuts
        screenContainer.addEventListener('keydown', (e) => {
            if (e.key === 'F5') { e.preventDefault(); this.vmQuickSave(); }
            if (e.key === 'F9') { e.preventDefault(); this.vmQuickLoad(); }
        });
    },

    // VM Control Methods
    vmSendCtrlAltDel() {
        if (this.currentVM) {
            this.currentVM.keyboard_send_scancodes([
                0x1D, 0x38, 0x53,
                0x53 | 0x80, 0x38 | 0x80, 0x1D | 0x80
            ]);
        }
    },

    vmTogglePause(btn) {
        if (this.currentVM) {
            if (this.vmPaused) {
                this.currentVM.run();
                this.vmPaused = false;
                btn.textContent = '‚è∏Ô∏è';
                document.querySelector('#vm-status-dot').style.background = '#4ade80';
            } else {
                this.currentVM.stop();
                this.vmPaused = true;
                btn.textContent = '‚ñ∂Ô∏è';
                document.querySelector('#vm-status-dot').style.background = '#d29922';
            }
        }
    },

    vmPause() { this.vmTogglePause(document.querySelector('#pause-btn')); },

    vmReset() {
        if (this.currentVM) {
            this.currentVM.restart();
            this.notify('VM', 'Reset initiated', 'üîÑ');
        }
    },

    async vmQuickSave() {
        if (!this.currentVM) return;
        try {
            await this.vmSaveSnapshot('Quick Save - ' + new Date().toLocaleTimeString());
        } catch (e) {
            console.error('[VM] Quick save failed:', e);
        }
    },

    async vmQuickLoad() {
        const snapshots = await this.vmGetSnapshots(this.currentVMId);
        if (snapshots.length === 0) {
            this.notify('VM', 'No snapshots available', '‚ö†Ô∏è');
            return;
        }
        const latest = snapshots.sort((a, b) => b.created - a.created)[0];
        await this.vmRestoreFromState(latest.state);
        this.notify('VM', 'Restored: ' + latest.name, 'üìÇ');
    },

    async vmRestoreFromState(state) {
        if (this.currentVM && state) {
            await this.currentVM.restore_state(state);
        }
    },

    async vmDownloadState() {
        if (!this.currentVM) return;
        try {
            const state = await this.currentVM.save_state();
            const blob = new Blob([state], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = this.currentVMId + '-state-' + Date.now() + '.bin';
            a.click();
            URL.revokeObjectURL(url);
            this.notify('VM', 'State downloaded', '‚¨áÔ∏è');
        } catch (e) {
            this.notify('VM', 'Download failed: ' + e.message, '‚ùå');
        }
    },

    vmFullscreen(btn) {
        const screen = btn.closest('.vm-manager, .vm-container').querySelector('#vm-screen');
        if (screen) {
            if (screen.requestFullscreen) screen.requestFullscreen();
            else if (screen.webkitRequestFullscreen) screen.webkitRequestFullscreen();
        }
    },

    vmScreenshot() {
        try {
            const canvas = document.querySelector('#vm-screen canvas');
            if (!canvas) return;
            const link = document.createElement('a');
            link.download = 'vm-screenshot-' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            this.notify('VM', 'Screenshot saved', 'üì∑');
        } catch (e) {
            this.notify('VM', 'Screenshot failed', '‚ùå');
        }
    },

    vmToggleSerial(btn) {
        const serial = document.querySelector('#vm-serial');
        if (serial) {
            const visible = serial.style.display !== 'none';
            serial.style.display = visible ? 'none' : 'block';
            btn.style.background = visible ? '#333' : '#58a6ff';
        }
    },

    async vmPasteClipboard() {
        if (!this.currentVM) return;
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                this.currentVM.keyboard_send_text(text);
                this.notify('VM', 'Pasted ' + text.length + ' characters', 'üìã');
            }
        } catch (e) {
            this.notify('VM', 'Clipboard access denied', '‚ö†Ô∏è');
        }
    },

    // Snapshot management
    async vmRestoreSnapshot(snapId, el) {
        await this.initVMDatabase();
        const tx = this.vmDB.transaction(this.vmStoreName, 'readonly');
        const store = tx.objectStore(this.vmStoreName);
        const snap = await new Promise((resolve, reject) => {
            const req = store.get(snapId);
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });

        if (snap) {
            const container = el.closest('.vm-manager');
            await this.bootLinux(snap.distro, container, { ram: snap.ram });
            // Wait for VM to initialize then restore state
            setTimeout(async () => {
                await this.vmRestoreFromState(snap.state);
                this.notify('VM', 'Restored: ' + snap.name, 'üìÇ');
            }, 2000);
        }
    },

    async vmDeleteSnapshotUI(snapId, btn) {
        if (confirm('Delete this snapshot?')) {
            await this.vmDeleteSnapshot(snapId);
            btn.closest('.vm-snap-item').remove();
            this.notify('VM', 'Snapshot deleted', 'üóëÔ∏è');
        }
    },

    // Custom ISO handling
    async vmHandleISODrop(e, dropZone) {
        e.preventDefault();
        dropZone.style.borderColor = '#333';
        const file = e.dataTransfer.files[0];
        if (file && (file.name.endsWith('.iso') || file.name.endsWith('.img'))) {
            await this.vmStoreCustomISO(file);
            this.notify('VM', 'ISO stored: ' + file.name, 'üíø');
            // Refresh sidebar
            const container = dropZone.closest('.vm-manager');
            if (container) this.showVMManager(container);
        }
    },

    async vmHandleISOUpload(e) {
        const file = e.target.files[0];
        if (file) {
            await this.vmStoreCustomISO(file);
            this.notify('VM', 'ISO stored: ' + file.name, 'üíø');
            const container = e.target.closest('.vm-manager');
            if (container) this.showVMManager(container);
        }
    },

    async vmBootCustomISO(isoId, btn) {
        await this.initVMDatabase();
        const tx = this.vmDB.transaction('customISOs', 'readonly');
        const store = tx.objectStore('customISOs');
        const iso = await new Promise((resolve, reject) => {
            const req = store.get(isoId);
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });

        if (iso) {
            const container = btn.closest('.vm-manager');
            this.currentVMId = 'custom';
            this.currentVMRam = this.vmConfig.defaultRam;

            // Boot with custom ISO
            container.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#1a1a2e">' +
                '<div style="font-size:64px;margin-bottom:20px">üíø</div>' +
                '<h3 style="color:#fff">Booting ' + iso.name + '</h3>' +
                '<div style="width:300px;height:4px;background:#333;border-radius:2px;margin:24px 0;overflow:hidden">' +
                '<div id="boot-progress" style="width:20%;height:100%;background:#58a6ff;transition:width 0.3s"></div></div>' +
                '<p style="color:#888;font-size:12px">Loading...</p></div>';

            if (!window.V86) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://copy.sh/v86/build/libv86.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            const vmConfig = {
                wasm_path: 'https://copy.sh/v86/build/v86.wasm',
                memory_size: this.vmConfig.defaultRam * 1024 * 1024,
                vga_memory_size: 8 * 1024 * 1024,
                bios: { url: 'https://copy.sh/v86/bios/seabios.bin' },
                vga_bios: { url: 'https://copy.sh/v86/bios/vgabios.bin' },
                cdrom: { buffer: iso.data },
                boot_order: 0x132,
                autostart: true
            };

            container.innerHTML = '<div class="vm-toolbar" style="display:flex;gap:6px;padding:8px 12px;background:#12122a;border-bottom:1px solid #333;align-items:center">' +
                '<button onclick="$.vmSendCtrlAltDel()" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer">‚å®Ô∏è</button>' +
                '<button onclick="$.vmPause()" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer">‚è∏Ô∏è</button>' +
                '<button onclick="$.vmReset()" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer">üîÑ</button>' +
                '<button onclick="$.vmFullscreen(this)" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer">‚õ∂</button>' +
                '<div style="margin-left:auto;color:#888;font-size:12px">üíø ' + iso.name + '</div></div>' +
                '<div id="vm-screen" style="flex:1;background:#000"></div>';

            vmConfig.screen_container = container.querySelector('#vm-screen');
            this.currentVM = new V86(vmConfig);
        }
    },

    vmShowCreateDialog(btn) {
        // For now just scroll to OS gallery
        const mainArea = btn.closest('.vm-manager').querySelector('.vm-main');
        if (mainArea) mainArea.scrollTop = 0;
    },

    // Show download/usage help dialog
    vmShowDownloadHelp(distroId) {
        const guides = {
            tinycore: {
                name: 'Tiny Core Linux',
                steps: [
                    'Download the .iso file (~23MB)',
                    'In InfiniteOS VM Manager, drag the .iso into the "Custom ISOs" drop zone',
                    'Click "Boot" next to the uploaded ISO',
                    'Wait for boot (very fast - runs in RAM)',
                    'Default user: tc, no password needed'
                ],
                tips: 'Tiny Core runs entirely in RAM. Install packages with: tce-load -wi package-name'
            },
            slitaz: {
                name: 'SliTaz GNU/Linux',
                steps: [
                    'Download slitaz-rolling.iso (~43MB)',
                    'Drag the ISO into InfiniteOS VM Manager',
                    'Click Boot and wait for GUI to load',
                    'Login: root, password: root'
                ],
                tips: 'SliTaz has a GUI and package manager (tazpkg). Very lightweight and fast.'
            },
            dsl: {
                name: 'Damn Small Linux',
                steps: [
                    'Download dsl-4.11.rc2.iso (~50MB)',
                    'Upload to InfiniteOS VM Manager',
                    'Boot and wait for Fluxbox desktop',
                    'Default user: dsl'
                ],
                tips: 'DSL is a classic distro. May need 128MB+ RAM setting for smooth operation.'
            },
            puppy: {
                name: 'Puppy Linux',
                steps: [
                    '‚ö†Ô∏è Download the 32-bit version (not fossapup64)',
                    'Look for "x86" or "i686" versions like BionicPup32',
                    'Upload ISO and boot with 512MB+ RAM',
                    'Follow the first-boot wizard'
                ],
                tips: 'Modern Puppy versions are 64-bit only. Search for older 32-bit releases.'
            },
            antix: {
                name: 'antiX Linux',
                steps: [
                    'Download the 386-core version (32-bit)',
                    'Upload to VM Manager',
                    'Boot with 256MB+ RAM recommended',
                    'Login: demo/demo or root/root'
                ],
                tips: 'antiX is Debian-based. Use apt-get for packages.'
            },
            porteus: {
                name: 'Porteus',
                steps: [
                    'Download the i486 (32-bit) ISO from build.porteus.org',
                    'Choose XFCE or LXDE for lighter weight',
                    'Upload and boot with 256MB+ RAM',
                    'Use guest/guest for login'
                ],
                tips: 'Porteus is modular - you can add/remove modules (.xzm files)'
            },
            'kolibri-dl': {
                name: 'KolibriOS',
                steps: [
                    'Download latest-iso.7z (~3MB compressed)',
                    'Extract the .iso from the .7z archive',
                    'Upload the .iso to VM Manager',
                    'Boot - it starts almost instantly!'
                ],
                tips: 'Entire OS is written in assembly. Extremely fast but limited software.'
            },
            menuetos: {
                name: 'MenuetOS',
                steps: [
                    'Download and extract the .zip file',
                    'Find the .img or .iso file inside',
                    'Upload to VM Manager',
                    '‚ö†Ô∏è Note: 64-bit MenuetOS won\'t work - need 32-bit version'
                ],
                tips: 'MenuetOS 32-bit (M32) works in v86, but M64 requires 64-bit CPU.'
            },
            reactos: {
                name: 'ReactOS',
                steps: [
                    'Download the .zip and extract the .iso',
                    'Upload to VM Manager with 256MB+ RAM',
                    'Boot and run through Windows-like installer',
                    'This is a REAL Windows-compatible OS!'
                ],
                tips: 'ReactOS can run many Windows programs. Installation takes time.'
            },
            'haiku-dl': {
                name: 'Haiku',
                steps: [
                    'Download the x86_gcc2h version (32-bit)',
                    'Extract the .iso from anyboot image',
                    'Upload and boot with 512MB RAM',
                    'Experience the unique BeOS-style desktop'
                ],
                tips: 'Haiku has a unique file system and UI. Very different from Linux/Windows.'
            },
            'freedos-dl': {
                name: 'FreeDOS 1.3',
                steps: [
                    'Download FD13-FullUSB.zip and extract',
                    'Find the .img file inside',
                    'Upload to VM Manager',
                    'Boot into classic DOS environment'
                ],
                tips: 'Full FreeDOS includes games (DOOM!), editors, compilers, and more.'
            },
            templeos: {
                name: 'TempleOS',
                steps: [
                    'Download TempleOSLite.ISO (~20MB)',
                    'Upload to VM Manager',
                    'Boot into the unique TempleOS environment',
                    'Press F1 for help, F5 to run programs'
                ],
                tips: 'TempleOS uses HolyC language. Very unique OS created by Terry A. Davis.'
            }
        };

        const guide = guides[distroId] || {
            name: distroId,
            steps: ['Download the ISO file', 'Drag into VM Manager\'s Custom ISOs area', 'Click Boot'],
            tips: 'Make sure to download 32-bit (i386/i686/x86) versions only!'
        };

        // Create modal
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000';

        let html = '<div style="background:#1a1a2e;border:1px solid #333;border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
        html += '<h3 style="color:#fff;margin:0">üìñ How to Use ' + guide.name + '</h3>';
        html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:#666;font-size:24px;cursor:pointer;padding:0;line-height:1">√ó</button>';
        html += '</div>';

        html += '<div style="background:#252547;border-radius:8px;padding:16px;margin-bottom:16px">';
        html += '<h4 style="color:#58a6ff;margin:0 0 12px 0;font-size:13px">Step-by-Step Guide</h4>';
        html += '<ol style="color:#ccc;margin:0;padding-left:20px;font-size:13px;line-height:1.8">';
        for (const step of guide.steps) {
            const isWarning = step.startsWith('‚ö†Ô∏è');
            html += '<li style="' + (isWarning ? 'color:#e88' : '') + '">' + step + '</li>';
        }
        html += '</ol></div>';

        html += '<div style="background:#1e3a1e;border:1px solid #3a5c3a;border-radius:8px;padding:12px">';
        html += '<p style="color:#8c8;margin:0;font-size:12px"><strong>üí° Tip:</strong> ' + guide.tips + '</p>';
        html += '</div>';

        html += '<div style="margin-top:16px;padding:12px;background:#2d2d1f;border:1px solid #5c5c30;border-radius:8px">';
        html += '<p style="color:#cc8;margin:0;font-size:11px"><strong>‚ö†Ô∏è Important:</strong> v86 only emulates 32-bit x86 CPUs. ';
        html += 'Always download the i386, i686, or x86 version of any distro. 64-bit (x86_64/amd64) ISOs will NOT work.</p>';
        html += '</div>';

        html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="width:100%;margin-top:16px;padding:12px;background:#58a6ff;border:none;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Got it!</button>';
        html += '</div>';

        modal.innerHTML = html;
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        document.body.appendChild(modal);
    },

    // One-click install and boot from gallery
    async vmInstallAndBoot(distroId, btn) {
        const distro = this.distroGallery.find(d => d.id === distroId);
        if (!distro) return;

        const container = btn.closest('.vm-manager');
        const originalBtn = btn.innerHTML;

        // Update button to show progress
        btn.disabled = true;
        btn.innerHTML = '<span class="spin" style="display:inline-block;animation:spin 1s linear infinite">‚è≥</span> Downloading...';
        btn.style.background = '#333';

        // Add spin animation if not exists
        if (!document.getElementById('vm-spin-style')) {
            const style = document.createElement('style');
            style.id = 'vm-spin-style';
            style.textContent = '@keyframes spin{to{transform:rotate(360deg)}}';
            document.head.appendChild(style);
        }

        try {
            // Show download progress UI
            container.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#1a1a2e;padding:40px">' +
                '<div style="font-size:64px;margin-bottom:20px">' + distro.icon + '</div>' +
                '<h3 style="color:#fff;margin:0 0 8px 0">Installing ' + distro.name + '</h3>' +
                '<p style="color:#666;margin:0 0 24px 0">Downloading ' + distro.size + 'MB...</p>' +
                '<div style="width:400px;max-width:90%;height:8px;background:#333;border-radius:4px;overflow:hidden">' +
                '<div id="dl-progress" style="width:0%;height:100%;background:linear-gradient(90deg,#58a6ff,#a371f7);transition:width 0.2s"></div>' +
                '</div>' +
                '<p id="dl-status" style="color:#888;font-size:12px;margin-top:16px">Connecting...</p>' +
                '<p id="dl-speed" style="color:#666;font-size:11px;margin-top:8px"></p>' +
                '</div>';

            const progressBar = container.querySelector('#dl-progress');
            const statusEl = container.querySelector('#dl-status');
            const speedEl = container.querySelector('#dl-speed');

            // Load v86 first if needed
            if (!window.V86) {
                statusEl.textContent = 'Loading v86 emulator...';
                progressBar.style.width = '10%';
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://copy.sh/v86/build/libv86.js';
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('Failed to load v86'));
                    document.head.appendChild(script);
                });
            }

            statusEl.textContent = 'Downloading ' + distro.name + '...';
            progressBar.style.width = '20%';

            // Fetch the image with progress tracking
            const startTime = Date.now();
            let lastLoaded = 0;
            let lastTime = startTime;

            const response = await fetch(distro.url);
            if (!response.ok) throw new Error('Download failed: ' + response.status);

            const contentLength = response.headers.get('content-length');
            const total = contentLength ? parseInt(contentLength) : distro.size * 1024 * 1024;

            const reader = response.body.getReader();
            const chunks = [];
            let loaded = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                chunks.push(value);
                loaded += value.length;

                // Update progress
                const percent = Math.min(20 + (loaded / total) * 70, 90);
                progressBar.style.width = percent + '%';

                // Calculate speed
                const now = Date.now();
                const elapsed = (now - lastTime) / 1000;
                if (elapsed >= 0.5) {
                    const speed = (loaded - lastLoaded) / elapsed;
                    const speedMB = (speed / 1024 / 1024).toFixed(2);
                    const loadedMB = (loaded / 1024 / 1024).toFixed(1);
                    const totalMB = (total / 1024 / 1024).toFixed(1);
                    speedEl.textContent = loadedMB + ' / ' + totalMB + ' MB ‚Ä¢ ' + speedMB + ' MB/s';
                    lastLoaded = loaded;
                    lastTime = now;
                }

                statusEl.textContent = 'Downloading... ' + Math.round(loaded / total * 100) + '%';
            }

            // Combine chunks into ArrayBuffer
            const buffer = new Uint8Array(loaded);
            let position = 0;
            for (const chunk of chunks) {
                buffer.set(chunk, position);
                position += chunk.length;
            }

            statusEl.textContent = 'Starting virtual machine...';
            progressBar.style.width = '95%';

            // Store in IndexedDB for future use
            await this.initVMDatabase();
            const isoRecord = {
                id: 'gallery_' + distro.id,
                name: distro.name,
                size: buffer.length,
                data: buffer.buffer,
                created: Date.now(),
                icon: distro.icon,
                fromGallery: true
            };

            const tx = this.vmDB.transaction('customISOs', 'readwrite');
            tx.objectStore('customISOs').put(isoRecord);

            // Build VM config
            const vmConfig = {
                wasm_path: 'https://copy.sh/v86/build/v86.wasm',
                memory_size: distro.ram * 1024 * 1024,
                vga_memory_size: 8 * 1024 * 1024,
                bios: { url: 'https://copy.sh/v86/bios/seabios.bin' },
                vga_bios: { url: 'https://copy.sh/v86/bios/vgabios.bin' },
                autostart: true,
                disable_keyboard: false,
                disable_mouse: false
            };

            // Configure boot source based on type
            if (distro.state) {
                vmConfig.initial_state = { buffer: buffer.buffer };
            } else if (distro.url.endsWith('.img')) {
                vmConfig.fda = { buffer: buffer.buffer };
            } else {
                vmConfig.cdrom = { buffer: buffer.buffer };
                vmConfig.boot_order = 0x132;
            }

            progressBar.style.width = '100%';
            statusEl.textContent = 'Booting ' + distro.name + '...';

            await new Promise(r => setTimeout(r, 500));

            // Create VM UI
            this.currentVMId = distro.id;
            this.currentVMRam = distro.ram;

            container.innerHTML = '<div class="vm-toolbar" style="display:flex;gap:6px;padding:8px 12px;background:#12122a;border-bottom:1px solid #333;align-items:center;flex-wrap:wrap">' +
                '<div style="display:flex;gap:4px">' +
                '<button onclick="$.vmSendCtrlAltDel()" title="Ctrl+Alt+Del" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚å®Ô∏è CAD</button>' +
                '<button id="pause-btn" onclick="$.vmTogglePause(this)" title="Pause" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚è∏Ô∏è</button>' +
                '<button onclick="$.vmReset()" title="Reset" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üîÑ</button>' +
                '</div>' +
                '<div style="display:flex;gap:4px;border-left:1px solid #333;padding-left:8px;margin-left:4px">' +
                '<button onclick="$.vmQuickSave()" title="Save State" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üíæ</button>' +
                '<button onclick="$.vmFullscreen(this)" title="Fullscreen" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚õ∂</button>' +
                '<button onclick="$.vmScreenshot()" title="Screenshot" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üì∑</button>' +
                '<button onclick="$.vmPasteClipboard()" title="Paste" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üìã</button>' +
                '</div>' +
                '<div style="margin-left:auto;display:flex;align-items:center;gap:8px">' +
                '<span style="font-size:10px;color:#666;background:#1a1a2e;padding:2px 6px;border-radius:4px">' + distro.ram + ' MB</span>' +
                '<div id="vm-status-dot" style="width:8px;height:8px;background:#4ade80;border-radius:50%"></div>' +
                '<span style="color:#888;font-size:12px">' + distro.icon + ' ' + distro.name + '</span>' +
                '<button onclick="$.vmBackToGallery(this)" style="padding:4px 8px;background:#333;border:none;color:#888;border-radius:4px;cursor:pointer;font-size:10px">‚Üê Back</button>' +
                '</div></div>' +
                '<div id="vm-screen" style="flex:1;background:#000;overflow:hidden;display:flex;align-items:center;justify-content:center"></div>' +
                '<div id="vm-serial" style="display:none;height:150px;background:#0d1117;overflow:auto;font-family:monospace;font-size:12px;padding:8px;color:#c9d1d9;white-space:pre-wrap;border-top:1px solid #333"></div>';

            vmConfig.screen_container = container.querySelector('#vm-screen');

            // Create and start VM
            this.currentVM = new V86(vmConfig);
            this.vmPaused = false;

            // Event listeners
            this.currentVM.add_listener('emulator-ready', () => {
                console.log('[VM] ' + distro.name + ' ready');
                this.notify('VM', distro.name + ' is running!', distro.icon);
            });

            // Serial output
            const serialDiv = container.querySelector('#vm-serial');
            this.currentVM.add_listener('serial0-output-byte', (byte) => {
                serialDiv.textContent += String.fromCharCode(byte);
                serialDiv.scrollTop = serialDiv.scrollHeight;
            });

        } catch (error) {
            console.error('[VM] Install failed:', error);

            container.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#1a1a2e;padding:40px">' +
                '<div style="font-size:64px;margin-bottom:20px">‚ùå</div>' +
                '<h3 style="color:#f85149;margin:0 0 12px 0">Download Failed</h3>' +
                '<p style="color:#888;margin:0 0 24px 0;text-align:center;max-width:400px">' + error.message + '</p>' +
                '<p style="color:#666;margin:0 0 24px 0;font-size:12px;text-align:center">This may be due to CORS restrictions. Try one of the "Ready" distros instead.</p>' +
                '<button onclick="$.showVMManager(this.closest(\'.vm-manager\'))" style="padding:12px 24px;background:#58a6ff;border:none;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">‚Üê Back to Gallery</button>' +
                '</div>';
        }
    },

    // Go back to gallery from running VM
    vmBackToGallery(btn) {
        if (this.currentVM) {
            if (confirm('Stop the current VM and return to gallery?')) {
                this.currentVM.stop();
                this.currentVM = null;
                const container = btn.closest('.vm-manager');
                this.showVMManager(container);
            }
        }
    },

    // Boot embedded OS - no network needed, generates image in JavaScript
    async bootEmbeddedOS(osId, el) {
        const container = el.closest('.vm-manager');
        const osInfo = {
            'micro-shell': { name: 'MicroOS Shell', icon: 'üñ•Ô∏è', ram: 128 },
            'micro-dos': { name: 'MicroDOS', icon: 'üíæ', ram: 128 },
            'snake-os': { name: 'SnakeOS', icon: 'üêç', ram: 128 },
            'fractal-os': { name: 'FractalOS', icon: 'üåÄ', ram: 128 },
            'tetris-os': { name: 'TetrisOS', icon: 'üß±', ram: 128 },
            'basic-os': { name: 'TinyBASIC', icon: 'üìü', ram: 128 }
        }[osId];

        // Show loading
        container.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#1a1a2e">' +
            '<div style="font-size:64px;margin-bottom:16px">' + osInfo.icon + '</div>' +
            '<h3 style="color:#fff;margin:0 0 8px 0">Generating ' + osInfo.name + '</h3>' +
            '<p style="color:#888;margin:0">Building boot image...</p>' +
            '</div>';

        // Load v86 if needed
        if (!window.V86) {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://copy.sh/v86/build/libv86.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Generate the boot image
        const bootImage = this.generateBootImage(osId);

        // Create VM UI
        this.currentVMId = osId;
        this.currentVMRam = osInfo.ram;

        container.innerHTML = '<div class="vm-toolbar" style="display:flex;gap:6px;padding:8px 12px;background:#12122a;border-bottom:1px solid #333;align-items:center">' +
            '<button onclick="$.vmSendCtrlAltDel()" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚å®Ô∏è</button>' +
            '<button onclick="$.vmReset()" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">üîÑ</button>' +
            '<button onclick="$.vmFullscreen(this)" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚õ∂</button>' +
            '<div style="margin-left:auto;display:flex;align-items:center;gap:8px">' +
            '<span style="font-size:9px;padding:2px 8px;background:#3fb95033;color:#3fb950;border-radius:4px">‚ö° EMBEDDED</span>' +
            '<span style="color:#888;font-size:12px">' + osInfo.icon + ' ' + osInfo.name + '</span>' +
            '<button onclick="$.vmBackToGallery(this)" style="padding:4px 8px;background:#333;border:none;color:#888;border-radius:4px;cursor:pointer;font-size:10px">‚Üê Back</button>' +
            '</div></div>' +
            '<div id="vm-screen" style="flex:1;background:#000;display:flex;align-items:center;justify-content:center"></div>';

        // Configure and start VM
        const vmConfig = {
            wasm_path: 'https://copy.sh/v86/build/v86.wasm',
            memory_size: osInfo.ram * 1024 * 1024,
            vga_memory_size: 8 * 1024 * 1024,
            bios: { url: 'https://copy.sh/v86/bios/seabios.bin' },
            vga_bios: { url: 'https://copy.sh/v86/bios/vgabios.bin' },
            fda: { buffer: bootImage },
            autostart: true
        };

        vmConfig.screen_container = container.querySelector('#vm-screen');
        this.currentVM = new V86(vmConfig);

        this.currentVM.add_listener('emulator-ready', () => {
            this.notify('VM', osInfo.name + ' is running!', osInfo.icon);
        });
    },

    // Generate boot images in JavaScript
    // Boot REAL OS via iframe to copy.sh/v86
    bootRealOS(osId, url, name, icon, el) {
        const container = el.closest('.vm-manager');

        // Create iframe UI with toolbar
        container.innerHTML = `
            <div class="vm-toolbar" style="display:flex;gap:6px;padding:8px 12px;background:#12122a;border-bottom:1px solid #333;align-items:center">
                <button onclick="window.open('${url}', '_blank')" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" title="Open in new tab">‚ÜóÔ∏è Pop Out</button>
                <button onclick="document.querySelector('.v86-iframe').contentWindow.location.reload()" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px" title="Reload">üîÑ</button>
                <button onclick="$.vmFullscreen(this)" style="padding:6px 10px;background:#333;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:11px">‚õ∂</button>
                <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
                    <span style="font-size:9px;padding:2px 8px;background:#58a6ff33;color:#58a6ff;border-radius:4px">üêß REAL LINUX</span>
                    <span style="color:#888;font-size:12px">${icon} ${name}</span>
                    <button onclick="$.vmBackToGallery(this)" style="padding:4px 8px;background:#333;border:none;color:#888;border-radius:4px;cursor:pointer;font-size:10px">‚Üê Back</button>
                </div>
            </div>
            <iframe
                class="v86-iframe"
                src="${url}"
                style="flex:1;width:100%;border:none;background:#000"
                allow="cross-origin-isolated"
            ></iframe>
        `;

        this.notify('VM', 'Loading ' + name + '...', icon);
    },

    generateBootImage(osId) {
        switch (osId) {
            case 'micro-shell': return this.genMicroShell();
            case 'micro-dos': return this.genMicroDOS();
            case 'snake-os': return this.genSnakeOS();
            case 'fractal-os': return this.genFractalOS();
            case 'tetris-os': return this.genTetrisOS();
            case 'basic-os': return this.genTinyBASIC();
            default: return this.genMicroShell();
        }
    },

    // MicroOS Shell - interactive keyboard echo with correct x86 boot sector
    genMicroShell() {
        const code = new Uint8Array(512);
        // x86 16-bit boot sector with carefully calculated jump offsets
        // All offsets relative to 0x7C00 load address
        const asm = [
            // 0x00: Setup segments and stack
            0xFA,                   // cli
            0x31, 0xC0,             // xor ax, ax
            0x8E, 0xD8,             // mov ds, ax
            0x8E, 0xC0,             // mov es, ax
            0x8E, 0xD0,             // mov ss, ax
            0xBC, 0x00, 0x7C,       // mov sp, 0x7C00
            0xFB,                   // sti

            // 0x0D: Set video mode 3 (80x25 text)
            0xB8, 0x03, 0x00,       // mov ax, 0x0003
            0xCD, 0x10,             // int 0x10

            // 0x12: Print welcome message (string at 0x7C50)
            0xBE, 0x50, 0x7C,       // mov si, 0x7C50
            // 0x15: print_loop
            0xAC,                   // lodsb
            0x08, 0xC0,             // or al, al
            0x74, 0x06,             // jz +6 (to 0x1F)
            0xB4, 0x0E,             // mov ah, 0x0E
            0xCD, 0x10,             // int 0x10
            0xEB, 0xF5,             // jmp -11 (back to 0x15)

            // 0x1F: prompt_setup - print "> " (string at 0x7C90)
            0xBE, 0x90, 0x7C,       // mov si, 0x7C90
            // 0x22: prompt_print_loop
            0xAC,                   // lodsb
            0x08, 0xC0,             // or al, al
            0x74, 0x06,             // jz +6 (to 0x2C)
            0xB4, 0x0E,             // mov ah, 0x0E
            0xCD, 0x10,             // int 0x10
            0xEB, 0xF5,             // jmp -11 (back to 0x22)

            // 0x2C: key_loop - wait for keypress
            0x31, 0xC0,             // xor ax, ax
            0xCD, 0x16,             // int 0x16 (BIOS wait for key)
            0x3C, 0x0D,             // cmp al, 0x0D (Enter key?)
            0x74, 0x06,             // jz +6 (to handle_enter at 0x38)
            0xB4, 0x0E,             // mov ah, 0x0E
            0xCD, 0x10,             // int 0x10 (echo character)
            0xEB, 0xF2,             // jmp -14 (back to key_loop at 0x2C)

            // 0x38: handle_enter - print newline then loop back to prompt
            0xB0, 0x0D,             // mov al, 0x0D (CR)
            0xB4, 0x0E,             // mov ah, 0x0E
            0xCD, 0x10,             // int 0x10
            0xB0, 0x0A,             // mov al, 0x0A (LF)
            0xCD, 0x10,             // int 0x10
            // 0x42: jump back to prompt_setup at 0x1F
            // offset = 0x1F - 0x44 = -37 = 0xDB
            0xEB, 0xDB              // jmp -37 (back to prompt_setup)
        ];
        code.set(asm, 0);

        // Welcome message at offset 0x50 with null terminator
        const welcome = "MicroOS Shell v1.0\r\nType anything + Enter!\r\n\r\n";
        for (let i = 0; i < welcome.length; i++) code[0x50 + i] = welcome.charCodeAt(i);
        code[0x50 + welcome.length] = 0; // null terminator

        // Prompt at offset 0x90 with null terminator
        const prompt = "> ";
        for (let i = 0; i < prompt.length; i++) code[0x90 + i] = prompt.charCodeAt(i);
        code[0x90 + prompt.length] = 0; // null terminator

        // Boot signature at 510-511
        code[510] = 0x55;
        code[511] = 0xAA;
        return code.buffer;
    },

    // MicroDOS - classic DOS prompt with keyboard input
    genMicroDOS() {
        const code = new Uint8Array(512);
        const asm = [
            0xFA, 0x31, 0xC0, 0x8E, 0xD8, 0x8E, 0xC0, 0x8E, 0xD0, 0xBC, 0x00, 0x7C, 0xFB,
            0xB8, 0x03, 0x00, 0xCD, 0x10,  // set mode 3
            // Print banner at 0x60
            0xBE, 0x60, 0x7C,
            0xAC, 0x08, 0xC0, 0x74, 0x06, 0xB4, 0x0E, 0xCD, 0x10, 0xEB, 0xF5,
            // Print prompt at 0xA0
            0xBE, 0xA0, 0x7C,
            0xAC, 0x08, 0xC0, 0x74, 0x06, 0xB4, 0x0E, 0xCD, 0x10, 0xEB, 0xF5,
            // Key loop
            0x31, 0xC0, 0xCD, 0x16,
            0x3C, 0x0D, 0x74, 0x06,
            0xB4, 0x0E, 0xCD, 0x10, 0xEB, 0xF2,
            // Enter pressed
            0xB0, 0x0D, 0xB4, 0x0E, 0xCD, 0x10,
            0xB0, 0x0A, 0xCD, 0x10,
            0xEB, 0xD8  // back to prompt
        ];
        code.set(asm, 0);

        const banner = "MicroDOS v1.0\r\n(C) 2024 InfiniteOS\r\n\r\n640K RAM OK\r\n\r\n";
        for (let i = 0; i < banner.length; i++) code[0x60 + i] = banner.charCodeAt(i);
        code[0x60 + banner.length] = 0; // null terminator

        const prompt = "A:\\> ";
        for (let i = 0; i < prompt.length; i++) code[0xA0 + i] = prompt.charCodeAt(i);
        code[0xA0 + prompt.length] = 0; // null terminator

        code[510] = 0x55; code[511] = 0xAA;
        return code.buffer;
    },

    // SnakeOS - simple graphics mode demo
    genSnakeOS() {
        const code = new Uint8Array(512);
        const asm = [
            // Setup
            0xFA, 0x31, 0xC0, 0x8E, 0xD8, 0x8E, 0xC0, 0x8E, 0xD0, 0xBC, 0x00, 0x7C, 0xFB,
            // Set mode 13h (320x200 256 colors)
            0xB8, 0x13, 0x00, 0xCD, 0x10,
            // Point ES to video memory 0xA000
            0xB8, 0x00, 0xA0, 0x8E, 0xC0,
            // Fill screen with pattern
            0x31, 0xFF,             // xor di, di
            0xB9, 0x00, 0xFA,       // mov cx, 64000 (320*200)
            // pixel_loop:
            0x89, 0xF8,             // mov ax, di
            0x31, 0xD0,             // xor ax, dx (creates pattern)
            0x24, 0x1F,             // and al, 0x1F
            0x04, 0x20,             // add al, 0x20
            0x26, 0xAA,             // stosb es:
            0x42,                   // inc dx
            0xE2, 0xF3,             // loop pixel_loop
            // Draw "SNAKE" text indicator - green block at center
            0xBF, 0x60, 0x7D,       // mov di, center-ish
            0xB0, 0x0A,             // green color
            0xB9, 0x14, 0x00,       // 20 pixels wide
            0xF3, 0xAA,             // rep stosb
            // Infinite loop
            0xEB, 0xFE
        ];
        code.set(asm, 0);
        code[510] = 0x55; code[511] = 0xAA;
        return code.buffer;
    },

    // FractalOS - XOR pattern graphics
    genFractalOS() {
        const code = new Uint8Array(512);
        const asm = [
            0xFA, 0x31, 0xC0, 0x8E, 0xD8, 0x8E, 0xC0, 0x8E, 0xD0, 0xBC, 0x00, 0x7C, 0xFB,
            // Mode 13h
            0xB8, 0x13, 0x00, 0xCD, 0x10,
            // ES = A000
            0xB8, 0x00, 0xA0, 0x8E, 0xC0,
            // Draw XOR fractal pattern
            0x31, 0xFF,             // xor di, di
            0x31, 0xD2,             // xor dx, dx (y counter)
            // y_loop:
            0x31, 0xC9,             // xor cx, cx (x counter)
            // x_loop:
            0x89, 0xC8,             // mov ax, cx
            0x31, 0xD0,             // xor ax, dx
            0x26, 0xAA,             // stosb
            0x41,                   // inc cx
            0x81, 0xF9, 0x40, 0x01, // cmp cx, 320
            0x75, 0xF3,             // jnz x_loop
            0x42,                   // inc dx
            0x81, 0xFA, 0xC8, 0x00, // cmp dx, 200
            0x75, 0xE7,             // jnz y_loop
            // Done - hang
            0xEB, 0xFE
        ];
        code.set(asm, 0);
        code[510] = 0x55; code[511] = 0xAA;
        return code.buffer;
    },

    // TetrisOS - falling block animation
    genTetrisOS() {
        const code = new Uint8Array(512);
        const asm = [
            0xFA, 0x31, 0xC0, 0x8E, 0xD8, 0x8E, 0xC0, 0x8E, 0xD0, 0xBC, 0x00, 0x7C, 0xFB,
            // Mode 13h
            0xB8, 0x13, 0x00, 0xCD, 0x10,
            0xB8, 0x00, 0xA0, 0x8E, 0xC0,
            // Clear screen to blue
            0x31, 0xFF,
            0xB9, 0x00, 0xFA,
            0xB0, 0x01,             // blue
            0xF3, 0xAA,
            // Animation: draw falling blocks
            0x31, 0xDB,             // bx = y position
            // anim_loop:
            // Clear old position (one row up)
            0x89, 0xDF,             // mov di, bx
            0xB0, 0x01,             // blue (background)
            0xB9, 0x10, 0x00,       // 16 pixels
            0xF3, 0xAA,
            // Draw new block
            0x81, 0xC3, 0x40, 0x01, // add bx, 320 (next row)
            0x89, 0xDF,             // mov di, bx
            0xB0, 0x0E,             // yellow
            0xB9, 0x10, 0x00,
            0xF3, 0xAA,
            // Delay
            0x51,                   // push cx
            0xB9, 0xFF, 0x1F,       // delay counter
            0xE2, 0xFE,             // delay loop
            0x59,                   // pop cx
            // Check if at bottom
            0x81, 0xFB, 0x00, 0xF0, // cmp bx, near bottom
            0x72, 0xDD,             // jb anim_loop
            // Reset to top
            0x31, 0xDB,
            0xEB, 0xD9              // jmp anim_loop
        ];
        code.set(asm, 0);
        code[510] = 0x55; code[511] = 0xAA;
        return code.buffer;
    },

    // TinyBASIC - BASIC-like prompt
    genTinyBASIC() {
        const code = new Uint8Array(512);
        const asm = [
            0xFA, 0x31, 0xC0, 0x8E, 0xD8, 0x8E, 0xC0, 0x8E, 0xD0, 0xBC, 0x00, 0x7C, 0xFB,
            0xB8, 0x03, 0x00, 0xCD, 0x10,
            // Print banner at 0x50
            0xBE, 0x50, 0x7C,
            0xAC, 0x08, 0xC0, 0x74, 0x06, 0xB4, 0x0E, 0xCD, 0x10, 0xEB, 0xF5,
            // Print READY prompt at 0xA0
            0xBE, 0xA0, 0x7C,
            0xAC, 0x08, 0xC0, 0x74, 0x06, 0xB4, 0x0E, 0xCD, 0x10, 0xEB, 0xF5,
            // Input loop
            0x31, 0xC0, 0xCD, 0x16,
            0x3C, 0x0D, 0x74, 0x06,
            0xB4, 0x0E, 0xCD, 0x10, 0xEB, 0xF2,
            // Enter - print OK and new prompt
            0xB0, 0x0D, 0xB4, 0x0E, 0xCD, 0x10,
            0xB0, 0x0A, 0xCD, 0x10,
            // Print OK at 0xB0
            0xBE, 0xB0, 0x7C,
            0xAC, 0x08, 0xC0, 0x74, 0x06, 0xB4, 0x0E, 0xCD, 0x10, 0xEB, 0xF5,
            0xEB, 0xCA  // back to READY prompt
        ];
        code.set(asm, 0);

        const banner = "TinyBASIC v1.0\r\n(C) 2024 InfiniteOS\r\nType HELP for commands\r\n\r\n";
        for (let i = 0; i < banner.length; i++) code[0x50 + i] = banner.charCodeAt(i);
        code[0x50 + banner.length] = 0; // null terminator

        const ready = "READY\r\n] ";
        for (let i = 0; i < ready.length; i++) code[0xA0 + i] = ready.charCodeAt(i);
        code[0xA0 + ready.length] = 0; // null terminator

        const ok = "OK\r\n] ";
        for (let i = 0; i < ok.length; i++) code[0xB0 + i] = ok.charCodeAt(i);
        code[0xB0 + ok.length] = 0; // null terminator

        code[510] = 0x55; code[511] = 0xAA;
        return code.buffer;
    },

    // Show distro info modal
    vmShowDistroInfo(distroId) {
        const distro = this.distroGallery.find(d => d.id === distroId);
        if (!distro) return;

        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000';

        let html = '<div style="background:#1a1a2e;border:1px solid #333;border-radius:12px;padding:24px;max-width:450px;width:90%">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
        html += '<div style="display:flex;align-items:center;gap:12px"><span style="font-size:36px">' + distro.icon + '</span><h3 style="color:#fff;margin:0">' + distro.name + '</h3></div>';
        html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:#666;font-size:24px;cursor:pointer">√ó</button>';
        html += '</div>';

        html += '<p style="color:#888;margin:0 0 16px 0;line-height:1.5">' + distro.desc + '</p>';

        html += '<div style="background:#252547;border-radius:8px;padding:12px;margin-bottom:16px">';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">';
        html += '<div><span style="color:#666">Size:</span> <span style="color:#fff">' + distro.size + ' MB</span></div>';
        html += '<div><span style="color:#666">RAM:</span> <span style="color:#fff">' + distro.ram + ' MB</span></div>';
        html += '<div><span style="color:#666">Type:</span> <span style="color:#fff">' + (distro.state ? 'Saved State' : 'Boot Image') + '</span></div>';
        html += '<div><span style="color:#666">Status:</span> <span style="color:' + (distro.ready ? '#3fb950' : '#d29922') + '">' + (distro.ready ? 'Ready' : 'May need CORS proxy') + '</span></div>';
        html += '</div></div>';

        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">';
        for (const f of distro.features) {
            html += '<span style="font-size:11px;padding:4px 10px;background:#1e1e3f;color:#888;border-radius:6px;border:1px solid #333">' + f + '</span>';
        }
        html += '</div>';

        if (distro.state) {
            html += '<div style="background:#1e3a1e;border:1px solid #3a5c3a;border-radius:8px;padding:10px;margin-bottom:16px">';
            html += '<p style="color:#8c8;margin:0;font-size:11px">üí° This is a pre-saved state - boots instantly to a ready desktop!</p>';
            html += '</div>';
        }

        html += '<button onclick="this.closest(\'div[style*=fixed]\').remove();$.vmInstallAndBoot(\'' + distroId + '\', document.querySelector(\'.distro-card[data-id=' + distroId + '] button\'))" style="width:100%;padding:12px;background:#58a6ff;border:none;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">üöÄ Install & Boot Now</button>';
        html += '</div>';

        modal.innerHTML = html;
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        document.body.appendChild(modal);
    },

    // DOS Box using js-dos
    openDosBox() {
        this.createWin({
            title: 'DOS Box', icon: 'üëæ', w: 800, h: 600,
            content: '<div class="vm-container"></div>',
            onInit: (body) => {
                const container = body.querySelector('.vm-container');
                this.loadRuntime('dos', container, () => {
                    this.initDosBox(container);
                });
            }
        });
    },

    initDosBox(container) {
        container.innerHTML = `
            <div class="vm-toolbar">
                <button onclick="$.dosLoadGame('doom')">DOOM</button>
                <button onclick="$.dosLoadGame('prince')">Prince of Persia</button>
                <button onclick="$.dosLoadGame('wolf3d')">Wolfenstein 3D</button>
                <button onclick="$.dosFullscreen()">Fullscreen</button>
                <div class="status"><div class="status-dot"></div>DOSBox Ready</div>
            </div>
            <div class="vm-screen" id="dos-screen">
                <div class="videoeditor-drop" style="margin:40px">
                    <p style="font-size:32px;margin-bottom:16px">üëæ</p>
                    <p>Select a game above or drop a .zip DOS game file here</p>
                    <p style="margin-top:12px;font-size:11px;color:var(--fg2)">Popular DOS games from js-dos library</p>
                </div>
            </div>
        `;

        // Set up drop zone
        const screen = container.querySelector('#dos-screen');
        screen.ondragover = (e) => { e.preventDefault(); screen.style.borderColor = 'var(--accent)'; };
        screen.ondragleave = () => { screen.style.borderColor = ''; };
        screen.ondrop = async (e) => {
            e.preventDefault();
            screen.style.borderColor = '';
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.zip')) {
                await this.dosRunBundle(file);
            }
        };
    },

    async dosLoadGame(game) {
        const screen = document.getElementById('dos-screen');
        if (!screen) return;

        screen.innerHTML = '<div style="color:var(--fg2);padding:20px">Loading game...</div>';

        const games = {
            doom: 'https://cdn.dos.zone/original/2X/2/24b00b12b0bf9a1d5f0b3e4e8e0c5e6b9a8d7c6f.jsdos',
            prince: 'https://cdn.dos.zone/original/2X/3/35c00b12b0bf9a1d5f0b3e4e8e0c5e6b9a8d7c6e.jsdos',
            wolf3d: 'https://cdn.dos.zone/original/2X/4/46d00b12b0bf9a1d5f0b3e4e8e0c5e6b9a8d7c6d.jsdos'
        };

        try {
            // js-dos requires the Dos function
            if (window.Dos) {
                this.currentDos = await Dos(screen, {
                    url: games[game] || games.doom
                });
            } else {
                screen.innerHTML = `
                    <div style="padding:20px;text-align:center">
                        <p style="margin-bottom:12px">js-dos loaded! To play games:</p>
                        <p style="color:var(--fg2);font-size:12px">Visit <a href="https://dos.zone" target="_blank" style="color:var(--accent)">dos.zone</a> and download .jsdos bundles</p>
                    </div>
                `;
            }
        } catch (e) {
            screen.innerHTML = `<div style="color:var(--red);padding:20px">Error: ${e.message}</div>`;
        }
    },

    dosFullscreen() {
        const screen = document.getElementById('dos-screen');
        if (screen?.requestFullscreen) screen.requestFullscreen();
    },

    // Video Editor using FFmpeg.wasm
    openVideoEditor() {
        this.createWin({
            title: 'Video Editor', icon: 'üé¨', w: 1100, h: 700,
            content: '<div class="videoeditor"></div>',
            onInit: (body) => {
                const container = body.querySelector('.videoeditor');
                this.loadRuntime('ffmpeg', container, (ffmpeg) => {
                    this.initVideoEditor(container, ffmpeg);
                });
            }
        });
    },

    initVideoEditor(container, ffmpeg) {
        container.innerHTML = `
            <div class="videoeditor-toolbar">
                <button onclick="document.getElementById('video-input').click()">üìÅ Open Video</button>
                <button onclick="$.videoTrim()">‚úÇÔ∏è Trim</button>
                <button onclick="$.videoConvert('mp4')">Convert to MP4</button>
                <button onclick="$.videoConvert('gif')">Convert to GIF</button>
                <button onclick="$.videoExtractAudio()">üéµ Extract Audio</button>
                <button onclick="$.videoCompress()">üì¶ Compress</button>
                <input type="file" id="video-input" accept="video/*" style="display:none" onchange="$.videoLoad(event)">
            </div>
            <div class="videoeditor-main">
                <div class="videoeditor-preview" id="video-preview">
                    <div class="videoeditor-drop" id="video-drop">
                        <p style="font-size:48px;margin-bottom:16px">üé¨</p>
                        <p>Drop a video file here or click Open Video</p>
                        <p style="margin-top:8px;color:var(--fg2);font-size:12px">Supported: MP4, WebM, MOV, AVI</p>
                        <p style="margin-top:16px;color:var(--green);font-size:11px">‚úì FFmpeg.wasm loaded - All processing happens locally!</p>
                    </div>
                </div>
                <div class="videoeditor-sidebar">
                    <div class="videoeditor-section">
                        <div class="videoeditor-section-title">Video Info</div>
                        <div id="video-info" style="font-size:12px;color:var(--fg2)">No video loaded</div>
                    </div>
                    <div class="videoeditor-section">
                        <div class="videoeditor-section-title">Trim</div>
                        <label style="font-size:12px;display:block;margin-bottom:4px">Start (seconds)</label>
                        <input type="number" id="trim-start" value="0" min="0" style="width:100%;padding:6px;background:var(--bg);border:1px solid var(--bg4);color:var(--fg);border-radius:4px;margin-bottom:8px">
                        <label style="font-size:12px;display:block;margin-bottom:4px">End (seconds)</label>
                        <input type="number" id="trim-end" value="10" min="0" style="width:100%;padding:6px;background:var(--bg);border:1px solid var(--bg4);color:var(--fg);border-radius:4px">
                    </div>
                    <div class="videoeditor-section">
                        <div class="videoeditor-section-title">Output</div>
                        <div id="video-output" style="font-size:12px;color:var(--fg2)">Ready</div>
                    </div>
                </div>
            </div>
            <div class="videoeditor-timeline">
                <div id="video-progress" style="display:none">
                    <div style="height:20px;background:var(--bg3);border-radius:4px;overflow:hidden">
                        <div id="ffmpeg-progress" style="height:100%;background:var(--accent);width:0;transition:width .3s"></div>
                    </div>
                    <div id="ffmpeg-status" style="font-size:11px;color:var(--fg2);margin-top:4px">Processing...</div>
                </div>
            </div>
        `;

        // Set up drag and drop
        const drop = container.querySelector('#video-drop');
        const preview = container.querySelector('#video-preview');

        preview.ondragover = (e) => { e.preventDefault(); drop.style.borderColor = 'var(--accent)'; };
        preview.ondragleave = () => { drop.style.borderColor = ''; };
        preview.ondrop = (e) => {
            e.preventDefault();
            drop.style.borderColor = '';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                this.loadVideoFile(file);
            }
        };

        this.ffmpegInstance = ffmpeg;
    },

    videoLoad(event) {
        const file = event.target.files[0];
        if (file) this.loadVideoFile(file);
    },

    loadVideoFile(file) {
        this.currentVideoFile = file;
        const preview = document.getElementById('video-preview');
        const info = document.getElementById('video-info');

        preview.innerHTML = `<video id="video-player" controls style="max-width:100%;max-height:100%"></video>`;
        const video = preview.querySelector('video');
        video.src = URL.createObjectURL(file);

        video.onloadedmetadata = () => {
            info.innerHTML = `
                <div style="margin-bottom:4px"><strong>${file.name}</strong></div>
                <div>Duration: ${video.duration.toFixed(1)}s</div>
                <div>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                <div>Resolution: ${video.videoWidth}x${video.videoHeight}</div>
            `;
            document.getElementById('trim-end').value = Math.floor(video.duration);
        };
    },

    async videoTrim() {
        if (!this.currentVideoFile) return alert('Load a video first');

        const start = document.getElementById('trim-start').value;
        const end = document.getElementById('trim-end').value;

        await this.processVideo([
            '-ss', start,
            '-to', end,
            '-c', 'copy'
        ], 'trimmed.mp4');
    },

    async videoConvert(format) {
        if (!this.currentVideoFile) return alert('Load a video first');

        const args = format === 'gif'
            ? ['-vf', 'fps=10,scale=480:-1:flags=lanczos', '-loop', '0']
            : ['-c:v', 'libx264', '-c:a', 'aac'];

        await this.processVideo(args, `output.${format}`);
    },

    async videoExtractAudio() {
        if (!this.currentVideoFile) return alert('Load a video first');
        await this.processVideo(['-vn', '-c:a', 'libmp3lame'], 'audio.mp3');
    },

    async videoCompress() {
        if (!this.currentVideoFile) return alert('Load a video first');
        await this.processVideo(['-c:v', 'libx264', '-crf', '28', '-preset', 'fast'], 'compressed.mp4');
    },

    async processVideo(args, outputName) {
        const ffmpeg = this.ffmpegInstance;
        if (!ffmpeg) return;

        const progress = document.getElementById('video-progress');
        const progressBar = document.getElementById('ffmpeg-progress');
        const status = document.getElementById('ffmpeg-status');
        const output = document.getElementById('video-output');

        progress.style.display = 'block';
        output.innerHTML = '<span style="color:var(--yellow)">Processing...</span>';

        try {
            // Write input file
            const inputData = new Uint8Array(await this.currentVideoFile.arrayBuffer());
            await ffmpeg.writeFile('input', inputData);

            // Set up progress
            ffmpeg.on('progress', ({ progress: p }) => {
                progressBar.style.width = (p * 100) + '%';
                status.textContent = `Processing: ${Math.round(p * 100)}%`;
            });

            // Run FFmpeg
            await ffmpeg.exec(['-i', 'input', ...args, outputName]);

            // Read output
            const data = await ffmpeg.readFile(outputName);
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);

            // Download
            const a = document.createElement('a');
            a.href = url;
            a.download = outputName;
            a.click();

            output.innerHTML = `<span class="success">‚úì ${outputName} downloaded</span>`;
        } catch (e) {
            output.innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
        }

        progress.style.display = 'none';
        progressBar.style.width = '0';
    },

    openCode(content = '', filename = 'untitled.js') {
        this.createWin({
            title: 'Code - ' + filename, icon: 'üìù', w: 900, h: 600,
            content: `<div class="code"><div class="code-tabs"><div class="code-tab active"><span>üìÑ</span>${filename}<span class="close">√ó</span></div></div><div class="code-body"><div class="code-lines"></div><div class="code-area" contenteditable="true" spellcheck="false"></div></div></div>`,
            onInit: (body) => {
                const area = body.querySelector('.code-area');
                const lines = body.querySelector('.code-lines');
                area.textContent = content || '// Start coding...\n\nfunction hello() {\n  console.log("Hello, InfiniteOS!");\n}\n\nhello();';
                const updateLines = () => {
                    const n = area.textContent.split('\n').length;
                    lines.innerHTML = Array.from({ length: n }, (_, i) => i + 1).join('<br>');
                };
                updateLines();
                area.oninput = updateLines;
            }
        });
    },

    // ========== FULL DEV ENVIRONMENT (Real IDE) ==========
    openDevEnv() {
        this.createWin({
            title: 'Dev Environment', icon: 'üõ†Ô∏è', w: 1200, h: 800, maximized: true,
            content: `<div class="devenv">
                <div class="devenv-toolbar">
                    <button onclick="$.devClone(this)">üì• Clone</button>
                    <button onclick="$.devNewFile(this)">üìÑ New File</button>
                    <button onclick="$.devSave(this)">üíæ Save</button>
                    <button onclick="$.devRun(this)">‚ñ∂Ô∏è Run</button>
                    <span class="devenv-runtime-badge python">Python 3.12</span>
                    <span class="devenv-runtime-badge node">Node.js</span>
                    <span class="devenv-runtime-badge">SQLite</span>
                </div>
                <div class="devenv-main">
                    <div class="devenv-sidebar">
                        <div class="devenv-sidebar-header">
                            <span>üìÅ EXPLORER</span>
                            <button onclick="$.devRefresh(this)" style="background:none;border:none;cursor:pointer;font-size:12px">‚Üª</button>
                        </div>
                        <div class="devenv-files"></div>
                    </div>
                    <div class="devenv-content">
                        <div class="devenv-tabs"></div>
                        <div class="devenv-editor">
                            <textarea class="devenv-code" spellcheck="false" placeholder="// Select a file or create a new one..."></textarea>
                        </div>
                        <div class="devenv-terminal">
                            <div class="devenv-terminal-header">
                                <span class="status"></span>
                                <span>TERMINAL</span>
                                <span style="margin-left:auto;font-size:10px;opacity:0.6">Real Shell ‚Ä¢ Pyodide ‚Ä¢ Git</span>
                            </div>
                            <div class="devenv-terminal-output"></div>
                            <div class="devenv-terminal-input">
                                <span>$</span>
                                <input type="text" placeholder="Type command...">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="devenv-status">
                    <span>Ready</span>
                    <span id="devenv-file-status">No file open</span>
                    <span id="devenv-cursor">Ln 1, Col 1</span>
                </div>
            </div>`,
            onInit: async (body) => {
                // Store devenv reference
                body._devenv = {
                    currentFile: null,
                    openTabs: [],
                    files: {}
                };

                // Load file tree from real filesystem
                await this.devLoadTree(body);

                // Setup terminal
                const termInput = body.querySelector('.devenv-terminal-input input');
                const termOutput = body.querySelector('.devenv-terminal-output');

                termInput.onkeydown = async (e) => {
                    if (e.key === 'Enter') {
                        const cmd = termInput.value.trim();
                        termInput.value = '';
                        if (!cmd) return;

                        // Show command
                        termOutput.innerHTML += `<div class="cmd">$ ${cmd}</div>`;

                        // Execute via real shell
                        try {
                            const result = await this.shell.exec(cmd, (text) => {
                                termOutput.innerHTML += `<div>${text}</div>`;
                                termOutput.scrollTop = termOutput.scrollHeight;
                            });
                            if (result) {
                                termOutput.innerHTML += `<div>${result}</div>`;
                            }
                        } catch (err) {
                            termOutput.innerHTML += `<div class="err">${err.message}</div>`;
                        }
                        termOutput.scrollTop = termOutput.scrollHeight;

                        // Refresh file tree after commands that might modify files
                        if (cmd.match(/^(touch|mkdir|rm|mv|cp|git|echo.*>)/)) {
                            await this.devLoadTree(body);
                        }
                    }
                };

                // Track cursor position
                const editor = body.querySelector('.devenv-code');
                editor.addEventListener('keyup', () => this.devUpdateCursor(body));
                editor.addEventListener('click', () => this.devUpdateCursor(body));

                // Welcome message
                termOutput.innerHTML = `<div class="info">InfiniteOS Dev Environment v7.0.0</div>
<div class="info">Real filesystem ‚Ä¢ Real Python ‚Ä¢ Real Git ‚Ä¢ Real VMs</div>
<div>Type 'help' for available commands</div>`;
            }
        });
    },

    async devLoadTree(body) {
        const filesEl = body.querySelector('.devenv-files');
        filesEl.innerHTML = '<div style="padding:12px;color:var(--fg2)">Loading...</div>';

        try {
            const renderDir = async (path, indent = 0) => {
                const entries = await this.realFS.readdir(path);
                let html = '';
                for (const entry of entries) {
                    const fullPath = path + '/' + entry.name;
                    const paddingLeft = 12 + (indent * 16);
                    if (entry.type === 'dir') {
                        html += `<div class="devenv-file folder" data-path="${fullPath}" style="padding-left:${paddingLeft}px" onclick="$.devToggleFolder(this)">üìÅ ${entry.name}</div>`;
                        html += `<div class="devenv-folder-contents" data-parent="${fullPath}" style="display:none"></div>`;
                    } else {
                        const icon = this.devFileIcon(entry.name);
                        html += `<div class="devenv-file" data-path="${fullPath}" style="padding-left:${paddingLeft}px" onclick="$.devOpenFile(this)">${icon} ${entry.name}</div>`;
                    }
                }
                return html;
            };

            filesEl.innerHTML = await renderDir('/home/user');
        } catch (e) {
            filesEl.innerHTML = `<div style="padding:12px;color:var(--red)">Error: ${e.message}</div>`;
        }
    },

    devFileIcon(name) {
        const ext = name.split('.').pop().toLowerCase();
        const icons = {
            py: 'üêç', js: 'üìú', ts: 'üìò', jsx: '‚öõÔ∏è', tsx: '‚öõÔ∏è',
            html: 'üåê', css: 'üé®', json: 'üìã', md: 'üìù',
            sh: '‚ö°', ios: '‚ö°', txt: 'üìÑ', sql: 'üóÉÔ∏è',
            jpg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è', svg: 'üñºÔ∏è',
            mp3: 'üéµ', mp4: 'üé¨', pdf: 'üìï', zip: 'üì¶'
        };
        return icons[ext] || 'üìÑ';
    },

    async devToggleFolder(el) {
        const path = el.dataset.path;
        const contents = el.nextElementSibling;
        const isOpen = contents.style.display !== 'none';

        if (isOpen) {
            contents.style.display = 'none';
            el.innerHTML = el.innerHTML.replace('üìÇ', 'üìÅ');
        } else {
            el.innerHTML = el.innerHTML.replace('üìÅ', 'üìÇ');
            contents.style.display = 'block';

            // Load contents if not already loaded
            if (!contents.innerHTML) {
                const entries = await this.realFS.readdir(path);
                let html = '';
                const indent = (parseInt(el.style.paddingLeft) - 12) / 16 + 1;
                for (const entry of entries) {
                    const fullPath = path + '/' + entry.name;
                    const paddingLeft = 12 + (indent * 16);
                    if (entry.type === 'dir') {
                        html += `<div class="devenv-file folder" data-path="${fullPath}" style="padding-left:${paddingLeft}px" onclick="$.devToggleFolder(this)">üìÅ ${entry.name}</div>`;
                        html += `<div class="devenv-folder-contents" data-parent="${fullPath}" style="display:none"></div>`;
                    } else {
                        const icon = this.devFileIcon(entry.name);
                        html += `<div class="devenv-file" data-path="${fullPath}" style="padding-left:${paddingLeft}px" onclick="$.devOpenFile(this)">${icon} ${entry.name}</div>`;
                    }
                }
                contents.innerHTML = html || '<div style="padding-left:28px;color:var(--fg2);font-style:italic">Empty</div>';
            }
        }
    },

    async devOpenFile(el) {
        const body = el.closest('.devenv');
        const path = el.dataset.path;
        const name = path.split('/').pop();

        // Mark as selected
        body.querySelectorAll('.devenv-file').forEach(f => f.classList.remove('sel'));
        el.classList.add('sel');

        // Read file content
        try {
            const content = await this.realFS.readText(path);

            // Update editor
            const editor = body.querySelector('.devenv-code');
            editor.value = content;
            body._devenv.currentFile = path;

            // Add/update tab
            this.devAddTab(body, path, name);

            // Update status
            body.querySelector('#devenv-file-status').textContent = path;
            this.devUpdateCursor(body);
        } catch (e) {
            body.querySelector('.devenv-terminal-output').innerHTML += `<div class="err">Cannot open: ${e.message}</div>`;
        }
    },

    devAddTab(body, path, name) {
        const tabsEl = body.querySelector('.devenv-tabs');
        const icon = this.devFileIcon(name);

        // Check if tab exists
        const existing = tabsEl.querySelector(`[data-path="${path}"]`);
        if (existing) {
            tabsEl.querySelectorAll('.devenv-tab').forEach(t => t.classList.remove('active'));
            existing.classList.add('active');
            return;
        }

        // Add new tab
        tabsEl.querySelectorAll('.devenv-tab').forEach(t => t.classList.remove('active'));
        const tab = document.createElement('div');
        tab.className = 'devenv-tab active';
        tab.dataset.path = path;
        tab.innerHTML = `${icon} ${name}<span class="close" onclick="event.stopPropagation();$.devCloseTab(this)">√ó</span>`;
        tab.onclick = () => this.devSwitchTab(body, path);
        tabsEl.appendChild(tab);

        // Store in open tabs
        if (!body._devenv.openTabs.includes(path)) {
            body._devenv.openTabs.push(path);
        }
    },

    async devSwitchTab(body, path) {
        const tabsEl = body.querySelector('.devenv-tabs');
        tabsEl.querySelectorAll('.devenv-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.path === path);
        });

        const content = await this.realFS.readText(path);
        body.querySelector('.devenv-code').value = content;
        body._devenv.currentFile = path;
        body.querySelector('#devenv-file-status').textContent = path;
    },

    devCloseTab(closeBtn) {
        const tab = closeBtn.closest('.devenv-tab');
        const body = tab.closest('.devenv');
        const path = tab.dataset.path;
        const wasActive = tab.classList.contains('active');

        // Remove from open tabs
        body._devenv.openTabs = body._devenv.openTabs.filter(p => p !== path);
        tab.remove();

        // If was active, switch to another tab
        if (wasActive && body._devenv.openTabs.length > 0) {
            this.devSwitchTab(body, body._devenv.openTabs[body._devenv.openTabs.length - 1]);
        } else if (body._devenv.openTabs.length === 0) {
            body.querySelector('.devenv-code').value = '';
            body._devenv.currentFile = null;
            body.querySelector('#devenv-file-status').textContent = 'No file open';
        }
    },

    devUpdateCursor(body) {
        const editor = body.querySelector('.devenv-code');
        const text = editor.value.substring(0, editor.selectionStart);
        const lines = text.split('\n');
        const line = lines.length;
        const col = lines[lines.length - 1].length + 1;
        body.querySelector('#devenv-cursor').textContent = `Ln ${line}, Col ${col}`;
    },

    async devSave(btn) {
        const body = btn.closest('.devenv');
        if (!body._devenv.currentFile) {
            alert('No file open');
            return;
        }

        const content = body.querySelector('.devenv-code').value;
        await this.realFS.writeFile(body._devenv.currentFile, content);

        body.querySelector('.devenv-terminal-output').innerHTML +=
            `<div class="success">‚úì Saved ${body._devenv.currentFile}</div>`;
    },

    async devRun(btn) {
        const body = btn.closest('.devenv');
        const termOutput = body.querySelector('.devenv-terminal-output');
        const file = body._devenv.currentFile;

        if (!file) {
            termOutput.innerHTML += `<div class="err">No file open</div>`;
            return;
        }

        // Save first
        await this.devSave(btn);

        const ext = file.split('.').pop().toLowerCase();
        let cmd = '';

        if (ext === 'py') {
            cmd = `python ${file}`;
        } else if (ext === 'js') {
            cmd = `node ${file}`;
        } else if (ext === 'sh' || ext === 'ios') {
            cmd = file;
        } else {
            termOutput.innerHTML += `<div class="info">Don't know how to run .${ext} files</div>`;
            return;
        }

        termOutput.innerHTML += `<div class="cmd">$ ${cmd}</div>`;

        try {
            const result = await this.shell.exec(cmd, (text) => {
                termOutput.innerHTML += `<div>${text}</div>`;
                termOutput.scrollTop = termOutput.scrollHeight;
            });
            if (result) {
                termOutput.innerHTML += `<div>${result}</div>`;
            }
        } catch (err) {
            termOutput.innerHTML += `<div class="err">${err.message}</div>`;
        }
        termOutput.scrollTop = termOutput.scrollHeight;
    },

    async devNewFile(btn) {
        const body = btn.closest('.devenv');
        const name = prompt('File name (e.g., script.py, app.js):');
        if (!name) return;

        const path = '/home/user/' + name;
        await this.realFS.writeFile(path, '');
        await this.devLoadTree(body);

        body.querySelector('.devenv-terminal-output').innerHTML +=
            `<div class="success">‚úì Created ${path}</div>`;
    },

    async devClone(btn) {
        const body = btn.closest('.devenv');
        const url = prompt('Git repository URL:', 'https://github.com/kody-w/Copilot-Agent-365');
        if (!url) return;

        const termOutput = body.querySelector('.devenv-terminal-output');
        termOutput.innerHTML += `<div class="cmd">$ git clone ${url}</div>`;

        try {
            const result = await this.shell.exec(`git clone ${url}`, (text) => {
                termOutput.innerHTML += `<div>${text}</div>`;
                termOutput.scrollTop = termOutput.scrollHeight;
            });
            if (result) termOutput.innerHTML += `<div>${result}</div>`;
            await this.devLoadTree(body);
        } catch (err) {
            termOutput.innerHTML += `<div class="err">${err.message}</div>`;
        }
    },

    async devRefresh(btn) {
        const body = btn.closest('.devenv');
        await this.devLoadTree(body);
    },

    // ========== SMART HYBRID BROWSER (Local-First) ==========
    // Consensus solution from 8 strategy analyzers - 100% client-side

    // Sites that work great in iframes
    friendlySites: [
        { name: 'Hacker News', url: 'https://news.ycombinator.com', icon: 'üì∞' },
        { name: 'Wikipedia', url: 'https://en.wikipedia.org', icon: 'üìö' },
        { name: 'MDN Docs', url: 'https://developer.mozilla.org', icon: 'üìñ' },
        { name: 'DuckDuckGo Lite', url: 'https://lite.duckduckgo.com/lite/', icon: 'ü¶Ü' },
        { name: 'Archive.org', url: 'https://archive.org', icon: 'üèõÔ∏è' },
        { name: 'OpenStreetMap', url: 'https://www.openstreetmap.org', icon: 'üó∫Ô∏è' },
        { name: 'CodePen', url: 'https://codepen.io', icon: '‚úèÔ∏è' },
    ],

    // Smart routing: sites with embed/API alternatives
    embedTransformers: {
        // YouTube: watch URL ‚Üí embed URL (WORKS in iframes!)
        'youtube.com/watch': (url) => {
            const id = new URL(url).searchParams.get('v');
            return id ? { type: 'embed', url: `https://www.youtube.com/embed/${id}?autoplay=1`, title: 'YouTube' } : null;
        },
        'youtu.be': (url) => {
            const id = new URL(url).pathname.slice(1).split('?')[0];
            return id ? { type: 'embed', url: `https://www.youtube.com/embed/${id}?autoplay=1`, title: 'YouTube' } : null;
        },
        // Vimeo: video URL ‚Üí player embed
        'vimeo.com': (url) => {
            const match = url.match(/vimeo\.com\/(\d+)/);
            return match ? { type: 'embed', url: `https://player.vimeo.com/video/${match[1]}`, title: 'Vimeo' } : null;
        },
        // Spotify: open URL ‚Üí embed URL
        'open.spotify.com': (url) => {
            const embedUrl = url.replace('open.spotify.com', 'open.spotify.com/embed');
            return { type: 'embed', url: embedUrl, title: 'Spotify' };
        },
        // Google Maps: redirect to embed
        'google.com/maps': (url) => {
            return { type: 'popup', reason: 'Google Maps works best in a dedicated window', url };
        },
        // GitHub: Use native app with API
        'github.com': (url) => {
            const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)/);
            if (match) return { type: 'app', app: 'github', owner: match[1], repo: match[2], url };
            return { type: 'popup', reason: 'GitHub home page', url };
        },
        // DuckDuckGo: redirect to lite version (iframe-friendly!)
        'duckduckgo.com': (url) => {
            const query = new URL(url).searchParams.get('q');
            if (query) return { type: 'embed', url: `https://lite.duckduckgo.com/lite/?q=${encodeURIComponent(query)}`, title: 'Search' };
            return { type: 'embed', url: 'https://lite.duckduckgo.com/lite/', title: 'Search' };
        },
    },

    // Sites that always block - offer smart alternatives
    blockedSites: {
        'google.com': { icon: 'üîç', alt: 'Use DuckDuckGo Lite for search' },
        'twitter.com': { icon: 'üê¶', alt: 'Opens in managed window' },
        'x.com': { icon: 'üê¶', alt: 'Opens in managed window' },
        'facebook.com': { icon: 'üë§', alt: 'Opens in managed window' },
        'instagram.com': { icon: 'üì∑', alt: 'Opens in managed window' },
        'linkedin.com': { icon: 'üíº', alt: 'Opens in managed window' },
        'reddit.com': { icon: 'ü§ñ', alt: 'Opens in managed window' },
        'amazon.com': { icon: 'üì¶', alt: 'Opens in managed window' },
        'netflix.com': { icon: 'üé¨', alt: 'Opens in managed window' },
        'microsoft.com': { icon: 'ü™ü', alt: 'Opens in managed window' },
        'apple.com': { icon: 'üçé', alt: 'Opens in managed window' },
        'stackoverflow.com': { icon: 'üìö', alt: 'Opens in managed window' },
    },

    // Managed external windows (tracked in taskbar)
    managedWindows: new Map(),

    // Fetch mode settings
    fetchMode: false,
    readerMode: false,
    useProxy: false, // User can enable to use CORS proxy for blocked sites

    // CORS proxies (fallback chain - user must opt-in)
    corsProxies: [
        url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    ],

    openBrowser() {
        const suggestHTML = this.friendlySites.map(s =>
            `<div class="browser-suggest-item" data-url="${s.url}"><div class="browser-suggest-icon">${s.icon}</div>${s.name}</div>`
        ).join('');

        this.createWin({
            title: 'Browser', icon: 'üåê', w: 1100, h: 750,
            content: `<div class="browser">
                <div class="browser-bar">
                    <div class="browser-nav">
                        <button onclick="$.browserBack(this)" title="Back">‚Üê</button>
                        <button onclick="$.browserFwd(this)" title="Forward">‚Üí</button>
                        <button onclick="$.refreshBrowser(this)" title="Refresh">‚Üª</button>
                    </div>
                    <input class="browser-url" value="https://news.ycombinator.com" placeholder="Search or enter URL...">
                    <button onclick="$.navBrowser(this)">Go</button>
                    <button class="browser-mode-toggle" onclick="$.toggleFetchMode(this)" title="Fetch Mode: Download HTML and render locally">üì• Fetch</button>
                    <button class="browser-mode-toggle" onclick="$.toggleReaderMode(this)" title="Reader Mode: Extract main content only">üìñ Reader</button>
                    <button class="browser-mode-toggle" onclick="$.toggleDevTools(this)" title="DevTools (F12)">üîß DevTools</button>
                    <button class="browser-open-external" onclick="$.openManagedWindow(this)" title="Open in managed window">‚Üó</button>
                </div>
                <div class="browser-content">
                    <div class="browser-fetch-status" id="fetch-status">üì• Fetching...</div>
                    <div class="browser-loading"><div class="browser-spinner"></div></div>
                    <div class="browser-reader">
                        <div class="browser-reader-header">
                            <div class="browser-reader-title" id="reader-title">Reader Mode</div>
                            <div class="browser-reader-source" id="reader-source"></div>
                        </div>
                        <div class="browser-reader-content" id="reader-content"></div>
                    </div>
                    <div class="browser-blocked">
                        <div class="browser-blocked-icon" id="blocked-icon">üîí</div>
                        <div class="browser-blocked-title" id="blocked-title">Smart Routing Active</div>
                        <div class="browser-blocked-msg" id="blocked-msg"></div>
                        <div class="browser-blocked-actions" id="blocked-actions"></div>
                        <div class="browser-suggestions">
                            <h4>‚ú® Iframe-Friendly Sites:</h4>
                            <div class="browser-suggest-grid">${suggestHTML}</div>
                        </div>
                    </div>
                    <iframe class="browser-frame" src="https://news.ycombinator.com"></iframe>
                </div>
                <div class="devtools">
                    <div class="devtools-resize" onmousedown="$.dtStartResize(event)"></div>
                    <div class="devtools-header">
                        <div class="devtools-tabs">
                            <div class="devtools-tab active" data-panel="elements" onclick="$.dtSwitchPanel(this,'elements')">Elements</div>
                            <div class="devtools-tab" data-panel="console" onclick="$.dtSwitchPanel(this,'console')">Console</div>
                            <div class="devtools-tab" data-panel="sources" onclick="$.dtSwitchPanel(this,'sources')">Sources</div>
                            <div class="devtools-tab" data-panel="network" onclick="$.dtSwitchPanel(this,'network')">Network</div>
                            <div class="devtools-tab" data-panel="storage" onclick="$.dtSwitchPanel(this,'storage')">Storage</div>
                            <div class="devtools-tab" data-panel="performance" onclick="$.dtSwitchPanel(this,'performance')">Performance</div>
                        </div>
                        <div class="devtools-actions">
                            <button class="devtools-btn" onclick="$.dtRefresh(this)" title="Refresh">‚Üª</button>
                            <button class="devtools-btn" onclick="$.toggleDevTools(this)" title="Close">‚úï</button>
                        </div>
                    </div>
                    <div class="devtools-body">
                        <!-- Elements Panel -->
                        <div class="devtools-panel dt-elements active" id="dt-elements">
                            <div class="dt-dom-tree" id="dt-dom-tree"></div>
                            <div class="dt-styles" id="dt-styles">
                                <div class="dt-styles-section">
                                    <div class="dt-styles-title">Computed Styles</div>
                                    <div id="dt-computed-styles"></div>
                                </div>
                                <div class="dt-styles-section">
                                    <div class="dt-styles-title">Box Model</div>
                                    <div class="dt-box-model" id="dt-box-model"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Console Panel -->
                        <div class="devtools-panel dt-console" id="dt-console">
                            <div class="dt-console-toolbar">
                                <button onclick="$.dtConsoleClear(this)">üóë Clear</button>
                                <select class="dt-console-filter" onchange="$.dtConsoleFilter(this)">
                                    <option value="all">All levels</option>
                                    <option value="log">Log</option>
                                    <option value="warn">Warnings</option>
                                    <option value="error">Errors</option>
                                    <option value="info">Info</option>
                                </select>
                                <label style="display:flex;align-items:center;gap:4px;margin-left:auto;color:#969696">
                                    <input type="checkbox" id="dt-preserve-logs"> Preserve logs
                                </label>
                            </div>
                            <div class="dt-console-logs" id="dt-console-logs"></div>
                            <div class="dt-console-input">
                                <span class="dt-console-prompt">‚Ä∫</span>
                                <input type="text" id="dt-console-input" placeholder="Evaluate JavaScript..." onkeydown="$.dtConsoleExec(event)">
                            </div>
                        </div>
                        <!-- Sources Panel -->
                        <div class="devtools-panel dt-sources" id="dt-sources">
                            <div class="dt-sources-sidebar" id="dt-sources-files"></div>
                            <div class="dt-sources-code" id="dt-sources-code"></div>
                        </div>
                        <!-- Network Panel -->
                        <div class="devtools-panel dt-network" id="dt-network">
                            <div class="dt-network-toolbar">
                                <button onclick="$.dtNetworkClear(this)">üóë Clear</button>
                                <label style="display:flex;align-items:center;gap:4px;color:#969696">
                                    <input type="checkbox" id="dt-network-record" checked> Record
                                </label>
                                <span style="margin-left:auto;color:#666" id="dt-network-summary">0 requests</span>
                            </div>
                            <div style="display:flex;flex:1;overflow:hidden">
                                <div class="dt-network-list" id="dt-network-list">
                                    <div class="dt-network-header">
                                        <span></span><span>Name</span><span>Status</span><span>Type</span><span>Size</span><span>Time</span>
                                    </div>
                                </div>
                                <div class="dt-network-detail" id="dt-network-detail"></div>
                            </div>
                        </div>
                        <!-- Storage Panel -->
                        <div class="devtools-panel dt-storage" id="dt-storage">
                            <div class="dt-storage-sidebar">
                                <div class="dt-storage-cat active" data-store="local" onclick="$.dtStorageSwitch(this,'local')">üì¶ Local Storage</div>
                                <div class="dt-storage-cat" data-store="session" onclick="$.dtStorageSwitch(this,'session')">üìã Session Storage</div>
                                <div class="dt-storage-cat" data-store="cookies" onclick="$.dtStorageSwitch(this,'cookies')">üç™ Cookies</div>
                            </div>
                            <div class="dt-storage-content" id="dt-storage-content"></div>
                        </div>
                        <!-- Performance Panel -->
                        <div class="devtools-panel dt-perf" id="dt-performance">
                            <div id="dt-perf-content"></div>
                        </div>
                    </div>
                </div>
            </div>`,
            onInit: (body) => {
                const urlInput = body.querySelector('.browser-url');
                urlInput.onkeydown = e => {
                    if (e.key === 'Enter') this.navBrowser(e.target);
                    if (e.key === 'F12') { e.preventDefault(); this.toggleDevTools(e.target); }
                };
                body.querySelectorAll('.browser-suggest-item').forEach(item => {
                    item.onclick = () => { urlInput.value = item.dataset.url; this.navBrowser(urlInput); };
                });
                // Initialize DevTools data
                this.dtLogs = [];
                this.dtNetworkRequests = [];
                this.dtSelectedElement = null;
            }
        });
    },

    toggleFetchMode(btn) {
        this.fetchMode = !this.fetchMode;
        btn.classList.toggle('active', this.fetchMode);
        if (this.fetchMode) {
            this.readerMode = false;
            btn.closest('.browser-bar').querySelector('.browser-mode-toggle:nth-of-type(2)').classList.remove('active');
            this.notify('Fetch Mode ON', 'Pages will be downloaded and rendered locally', 'üì•');
        }
    },

    toggleReaderMode(btn) {
        this.readerMode = !this.readerMode;
        btn.classList.toggle('active', this.readerMode);
        if (this.readerMode) {
            this.fetchMode = true; // Reader requires fetch
            btn.closest('.browser-bar').querySelector('.browser-mode-toggle:nth-of-type(1)').classList.add('active');
            this.notify('Reader Mode ON', 'Only main content will be extracted', 'üìñ');
        }
    },

    // Smart URL routing - the core of the hybrid approach
    routeUrl(url) {
        // Check for embed transformers first
        for (const [pattern, transformer] of Object.entries(this.embedTransformers)) {
            if (url.includes(pattern)) {
                const result = transformer(url);
                if (result) return result;
            }
        }
        // Check if it's a known blocked site
        for (const [domain, info] of Object.entries(this.blockedSites)) {
            if (url.includes(domain)) {
                return { type: 'blocked', domain, ...info, url };
            }
        }
        // Check if it looks like a search query (no dots, no protocol)
        const cleanUrl = url.replace(/^https?:\/\//, '');
        if (!cleanUrl.includes('.') && !cleanUrl.includes('/')) {
            return { type: 'search', query: url };
        }
        // Default: try iframe
        return { type: 'iframe', url };
    },

    navBrowser(el) {
        const body = el.closest('.browser');
        let url = body.querySelector('.browser-url').value.trim();
        if (!url) return;
        if (!url.startsWith('http') && url.includes('.')) url = 'https://' + url;

        const iframe = body.querySelector('iframe');
        const loading = body.querySelector('.browser-loading');
        const blocked = body.querySelector('.browser-blocked');
        const reader = body.querySelector('.browser-reader');
        const fetchStatus = body.querySelector('#fetch-status');

        // Hide all content areas first
        blocked.classList.remove('show');
        reader.classList.remove('show');
        iframe.style.display = 'none';

        // If Fetch Mode is enabled, use HTML fetch approach
        if (this.fetchMode) {
            this.fetchAndRender(body, url);
            return;
        }

        // Smart route the URL
        const route = this.routeUrl(url);
        body.querySelector('.browser-url').value = url;

        switch (route.type) {
            case 'embed':
                // Official embed URL - load directly in iframe
                loading.classList.add('show');
                iframe.style.display = 'block';
                iframe.src = route.url;
                iframe.onload = () => loading.classList.remove('show');
                this.notify('Smart Embed', `Loading ${route.title} embed`, 'üé¨');
                break;

            case 'search':
                // Search query - use DuckDuckGo Lite (iframe-friendly!)
                const searchUrl = `https://lite.duckduckgo.com/lite/?q=${encodeURIComponent(route.query)}`;
                body.querySelector('.browser-url').value = searchUrl;
                loading.classList.add('show');
                iframe.style.display = 'block';
                iframe.src = searchUrl;
                iframe.onload = () => loading.classList.remove('show');
                break;

            case 'app':
                // Native app experience (GitHub)
                if (route.app === 'github') {
                    this.showGitHubViewer(body, route.owner, route.repo, route.url);
                }
                break;

            case 'blocked':
                // Show smart alternatives with Fetch Mode option
                this.showBlockedOptions(body, route);
                break;

            case 'popup':
                // Open in managed window
                this.openManagedPopup(route.url, route.reason);
                blocked.classList.add('show');
                body.querySelector('#blocked-icon').textContent = '‚ÜóÔ∏è';
                body.querySelector('#blocked-title').textContent = 'Opened in Managed Window';
                body.querySelector('#blocked-msg').textContent = route.reason;
                body.querySelector('#blocked-actions').innerHTML = `
                    <button class="browser-blocked-btn primary" onclick="$.focusManagedWindow('${route.url}')">üîç Focus Window</button>
                    <button class="browser-blocked-btn secondary" onclick="$.closeManagedWindow('${route.url}')">‚úï Close Window</button>
                `;
                break;

            default:
                // Try iframe - show loading and handle potential blocking
                loading.classList.add('show');
                iframe.style.display = 'block';
                iframe.src = url;
                iframe.onload = () => {
                    loading.classList.remove('show');
                    try {
                        const doc = iframe.contentDocument || iframe.contentWindow.document;
                        if (!doc || !doc.body || doc.body.innerHTML === '') throw new Error('blocked');
                    } catch(e) {
                        // Cross-origin but might still be displaying
                    }
                };
                iframe.onerror = () => {
                    loading.classList.remove('show');
                    this.showBlockedOptions(body, { type: 'blocked', domain: new URL(url).hostname, url, icon: 'üö´', alt: 'This site blocks embedding' });
                };
        }
    },

    // ========== FETCH MODE: Download HTML and render locally ==========

    async fetchAndRender(body, url) {
        const loading = body.querySelector('.browser-loading');
        const fetchStatus = body.querySelector('#fetch-status');
        const iframe = body.querySelector('iframe');
        const reader = body.querySelector('.browser-reader');
        const blocked = body.querySelector('.browser-blocked');

        loading.classList.add('show');
        fetchStatus.classList.add('show');
        fetchStatus.innerHTML = 'üì• Fetching page...';

        let html = null;
        let fetchMethod = 'direct';

        // Step 1: Try direct fetch (works for CORS-enabled sites)
        try {
            fetchStatus.innerHTML = 'üì• Trying direct fetch...';
            const response = await fetch(url, { mode: 'cors' });
            if (response.ok) {
                html = await response.text();
                fetchMethod = 'direct';
            }
        } catch (e) {
            // CORS blocked - try proxy if user opts in
        }

        // Step 2: If direct failed, try CORS proxy (with user awareness)
        if (!html) {
            fetchStatus.innerHTML = 'üîÑ Using CORS proxy...';
            for (const proxyFn of this.corsProxies) {
                try {
                    const proxyUrl = proxyFn(url);
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        html = await response.text();
                        fetchMethod = 'proxy';
                        break;
                    }
                } catch (e) {
                    continue;
                }
            }
        }

        loading.classList.remove('show');
        fetchStatus.classList.remove('show');

        if (!html) {
            // Fetch failed - show options
            blocked.classList.add('show');
            body.querySelector('#blocked-icon').textContent = '‚ùå';
            body.querySelector('#blocked-title').textContent = 'Could Not Fetch Page';
            body.querySelector('#blocked-msg').innerHTML = `
                <p>Unable to download this page's HTML.</p>
                <p style="font-size:12px;opacity:0.7;margin-top:8px">CORS policy blocks direct access, and proxy services couldn't reach it.</p>
            `;
            body.querySelector('#blocked-actions').innerHTML = `
                <button class="browser-blocked-btn primary" onclick="$.openManagedPopup('${url}', 'Browser')">‚ÜóÔ∏è Open in Window</button>
                <button class="browser-blocked-btn secondary" onclick="navigator.clipboard.writeText('${url}').then(()=>$.notify('Copied!','URL copied','üìã'))">üìã Copy URL</button>
            `;
            return;
        }

        // Success! Process and render the HTML
        this.notify('Fetch Success', `Page loaded via ${fetchMethod}`, '‚úÖ');

        if (this.readerMode) {
            // Extract main content for reader view
            this.renderReaderMode(body, html, url);
        } else {
            // Render full page in srcdoc iframe
            this.renderFetchedPage(body, html, url);
        }
    },

    // Sanitize HTML for security
    sanitizeHtml(html) {
        // Remove potentially dangerous elements
        html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
        html = html.replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '');
        html = html.replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi, '');
        html = html.replace(/<embed[^>]*>/gi, '');
        // Remove event handlers
        html = html.replace(/\son\w+\s*=\s*["'][^"']*["']/gi, '');
        html = html.replace(/\son\w+\s*=\s*[^\s>]*/gi, '');
        // Remove javascript: URLs
        html = html.replace(/href\s*=\s*["']javascript:[^"']*["']/gi, 'href="#"');
        return html;
    },

    // Render fetched HTML in srcdoc iframe (bypasses X-Frame-Options!)
    renderFetchedPage(body, html, baseUrl) {
        const iframe = body.querySelector('iframe');
        const reader = body.querySelector('.browser-reader');
        const blocked = body.querySelector('.browser-blocked');

        reader.classList.remove('show');
        blocked.classList.remove('show');
        iframe.style.display = 'block';

        // Sanitize and prepare HTML
        let safeHtml = this.sanitizeHtml(html);

        // Add base tag for relative URL resolution
        const baseTag = `<base href="${baseUrl}" target="_blank">`;
        if (safeHtml.includes('<head>')) {
            safeHtml = safeHtml.replace('<head>', `<head>${baseTag}`);
        } else if (safeHtml.includes('<html>')) {
            safeHtml = safeHtml.replace('<html>', `<html><head>${baseTag}</head>`);
        } else {
            safeHtml = `<head>${baseTag}</head>${safeHtml}`;
        }

        // Add some basic styling fixes for dark mode compatibility
        const styleOverrides = `<style>
            body { background: #fff !important; color: #333 !important; }
            a { color: #0066cc; }
        </style>`;
        safeHtml = safeHtml.replace('</head>', `${styleOverrides}</head>`);

        // Render using srcdoc (bypasses X-Frame-Options since we own the content)
        iframe.removeAttribute('src');
        iframe.srcdoc = safeHtml;

        this.notify('Page Rendered', 'Static HTML view (JavaScript disabled)', 'üìÑ');
    },

    // Extract and render main content in Reader Mode
    renderReaderMode(body, html, url) {
        const iframe = body.querySelector('iframe');
        const reader = body.querySelector('.browser-reader');
        const blocked = body.querySelector('.browser-blocked');

        iframe.style.display = 'none';
        blocked.classList.remove('show');
        reader.classList.add('show');

        // Parse HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Extract title
        const title = doc.querySelector('title')?.textContent ||
                      doc.querySelector('h1')?.textContent ||
                      new URL(url).hostname;

        // Try to find main content (common patterns)
        const selectors = [
            'article', 'main', '[role="main"]', '.post-content', '.article-content',
            '.entry-content', '.content', '#content', '.post', '.article',
            '.story-body', '.story-content'
        ];

        let content = null;
        for (const sel of selectors) {
            const el = doc.querySelector(sel);
            if (el && el.textContent.trim().length > 200) {
                content = el;
                break;
            }
        }

        // Fallback: use body if no article found
        if (!content) {
            content = doc.body;
        }

        // Clean up the content
        if (content) {
            // Remove unwanted elements
            content.querySelectorAll('script, style, nav, header, footer, aside, .sidebar, .ad, .advertisement, .social-share, .comments').forEach(el => el.remove());
        }

        // Get clean HTML
        let contentHtml = content ? content.innerHTML : '<p>Could not extract content from this page.</p>';

        // Fix relative URLs in images
        const baseUrl = new URL(url);
        contentHtml = contentHtml.replace(/src="\/([^"]*)/g, `src="${baseUrl.origin}/$1`);
        contentHtml = contentHtml.replace(/src="(?!http)([^"]*)/g, `src="${baseUrl.origin}/$1`);

        // Sanitize
        contentHtml = this.sanitizeHtml(contentHtml);

        // Render
        body.querySelector('#reader-title').textContent = title;
        body.querySelector('#reader-source').textContent = url;
        body.querySelector('#reader-content').innerHTML = contentHtml;

        this.notify('Reader Mode', 'Main content extracted', 'üìñ');
    },

    showBlockedOptions(body, route) {
        const iframe = body.querySelector('iframe');
        const blocked = body.querySelector('.browser-blocked');

        iframe.style.display = 'none';
        blocked.classList.add('show');
        body.querySelector('.browser-loading').classList.remove('show');

        body.querySelector('#blocked-icon').textContent = route.icon || 'üîí';
        body.querySelector('#blocked-title').textContent = `${route.domain} - Smart Routing`;
        body.querySelector('#blocked-msg').innerHTML = `
            <p style="margin-bottom:12px">${route.alt}</p>
            <p style="font-size:12px;opacity:0.7">This site uses security headers that prevent iframe embedding. Choose an option below:</p>
        `;

        let actionsHTML = `
            <button class="browser-blocked-btn primary" onclick="$.tryFetchMode('${route.url}')">
                üì• Try Fetch Mode
            </button>
            <button class="browser-blocked-btn secondary" onclick="$.openManagedPopup('${route.url}', '${route.domain}')">
                ‚ÜóÔ∏è Open Window
            </button>
            <button class="browser-blocked-btn secondary" onclick="navigator.clipboard.writeText('${route.url}').then(()=>$.notify('Copied!','URL copied','üìã'))">
                üìã Copy
            </button>
        `;

        // Add smart alternatives based on the site
        if (route.domain?.includes('google.com')) {
            actionsHTML += `<button class="browser-blocked-btn secondary" onclick="document.querySelector('.browser-url').value='https://lite.duckduckgo.com/lite/';$.navBrowser(document.querySelector('.browser-url'))">ü¶Ü DuckDuckGo</button>`;
        }
        if (route.domain?.includes('github.com')) {
            actionsHTML += `<button class="browser-blocked-btn secondary" onclick="$.openGitHubApp()">üìÇ GitHub Viewer</button>`;
        }

        body.querySelector('#blocked-actions').innerHTML = actionsHTML;
    },

    // Enable fetch mode and retry the URL
    tryFetchMode(url) {
        this.fetchMode = true;
        const fetchBtn = document.querySelector('.browser-mode-toggle');
        if (fetchBtn) fetchBtn.classList.add('active');
        const urlInput = document.querySelector('.browser-url');
        if (urlInput) {
            urlInput.value = url;
            this.navBrowser(urlInput);
        }
    },

    // GitHub Viewer - uses public API (no auth needed)
    showGitHubViewer(body, owner, repo, originalUrl) {
        const iframe = body.querySelector('iframe');
        const blocked = body.querySelector('.browser-blocked');
        const loading = body.querySelector('.browser-loading');

        iframe.style.display = 'none';
        blocked.classList.add('show');
        loading.classList.remove('show');

        body.querySelector('#blocked-icon').textContent = 'üìÇ';
        body.querySelector('#blocked-title').textContent = `${owner}/${repo}`;
        body.querySelector('#blocked-msg').innerHTML = `<p>Loading repository info from GitHub API...</p>`;
        body.querySelector('#blocked-actions').innerHTML = '';

        // Fetch repo info using public GitHub API (CORS enabled!)
        fetch(`https://api.github.com/repos/${owner}/${repo}`)
            .then(r => r.json())
            .then(data => {
                body.querySelector('#blocked-msg').innerHTML = `
                    <div style="text-align:left;background:var(--bg2);padding:16px;border-radius:8px;margin-bottom:16px">
                        <h3 style="margin-bottom:8px">üì¶ ${data.name}</h3>
                        <p style="margin-bottom:12px;opacity:0.8">${data.description || 'No description'}</p>
                        <div style="display:flex;gap:16px;font-size:12px">
                            <span>‚≠ê ${data.stargazers_count?.toLocaleString()}</span>
                            <span>üç¥ ${data.forks_count?.toLocaleString()}</span>
                            <span>üëÅÔ∏è ${data.watchers_count?.toLocaleString()}</span>
                            <span>üìÑ ${data.language || 'Unknown'}</span>
                        </div>
                    </div>
                `;
                body.querySelector('#blocked-actions').innerHTML = `
                    <button class="browser-blocked-btn primary" onclick="$.openManagedPopup('${originalUrl}', 'GitHub')">‚ÜóÔ∏è Open Full Site</button>
                    <button class="browser-blocked-btn secondary" onclick="$.openManagedPopup('${data.html_url}/issues', 'Issues')">üêõ Issues</button>
                    <button class="browser-blocked-btn secondary" onclick="$.openManagedPopup('${data.html_url}/pulls', 'PRs')">üîÄ Pull Requests</button>
                `;
            })
            .catch(() => {
                body.querySelector('#blocked-msg').innerHTML = `<p>Could not load repository info. Rate limit may be exceeded.</p>`;
                body.querySelector('#blocked-actions').innerHTML = `
                    <button class="browser-blocked-btn primary" onclick="$.openManagedPopup('${originalUrl}', 'GitHub')">‚ÜóÔ∏è Open in Window</button>
                `;
            });
    },

    openGitHubApp() {
        const url = prompt('Enter GitHub repository URL:', 'https://github.com/anthropics/claude-code');
        if (url) {
            document.querySelector('.browser-url').value = url;
            this.navBrowser(document.querySelector('.browser-url'));
        }
    },

    // Managed Window System - windows tracked in InfiniteOS
    openManagedPopup(url, title) {
        const id = 'managed_' + Date.now();
        const width = Math.min(1200, window.screen.width * 0.7);
        const height = Math.min(800, window.screen.height * 0.7);
        const left = (window.screen.width - width) / 2;
        const top = (window.screen.height - height) / 2;

        const win = window.open(url, id, `width=${width},height=${height},left=${left},top=${top},menubar=no,toolbar=yes,location=yes,status=yes`);

        if (win) {
            this.managedWindows.set(url, { window: win, id, title: title || new URL(url).hostname, openedAt: Date.now() });
            this.notify('Window Opened', `${title || 'Site'} opened in managed window`, '‚ÜóÔ∏è');

            // Poll to detect when window closes
            const checkClosed = setInterval(() => {
                if (win.closed) {
                    this.managedWindows.delete(url);
                    clearInterval(checkClosed);
                }
            }, 1000);
        } else {
            this.notify('Popup Blocked', 'Please allow popups for InfiniteOS', '‚ö†Ô∏è');
            window.open(url, '_blank');
        }
    },

    openManagedWindow(el) {
        const url = el.closest('.browser').querySelector('.browser-url').value;
        if (url) this.openManagedPopup(url, 'Browser');
    },

    focusManagedWindow(url) {
        const managed = this.managedWindows.get(url);
        if (managed && !managed.window.closed) {
            managed.window.focus();
        } else {
            this.openManagedPopup(url, 'Browser');
        }
    },

    closeManagedWindow(url) {
        const managed = this.managedWindows.get(url);
        if (managed && !managed.window.closed) {
            managed.window.close();
        }
        this.managedWindows.delete(url);
    },

    browserBack(el) {
        try { el.closest('.browser').querySelector('iframe').contentWindow.history.back(); } catch(e) {}
    },

    browserFwd(el) {
        try { el.closest('.browser').querySelector('iframe').contentWindow.history.forward(); } catch(e) {}
    },

    refreshBrowser(el) {
        const browser = el.closest('.browser');
        const iframe = browser.querySelector('iframe');
        const loading = browser.querySelector('.browser-loading');
        loading.classList.add('show');
        iframe.onload = () => loading.classList.remove('show');
        iframe.src = iframe.src;
    },

    copyUrl(el) {
        const url = el.closest('.browser').querySelector('.browser-url').value;
        navigator.clipboard.writeText(url).then(() => this.notify('Copied!', 'URL copied to clipboard', 'üìã'));
    },

    // ========== DEVTOOLS ==========
    dtLogs: [],
    dtNetworkRequests: [],
    dtSelectedElement: null,
    dtCurrentSource: null,

    toggleDevTools(el) {
        const browser = el.closest('.browser');
        const devtools = browser.querySelector('.devtools');
        const isOpen = devtools.classList.toggle('open');
        const btn = browser.querySelector('.browser-mode-toggle[onclick*="toggleDevTools"]');
        if (btn) btn.classList.toggle('active', isOpen);
        if (isOpen) {
            this.dtRefresh(el);
        }
    },

    dtSwitchPanel(tab, panel) {
        const devtools = tab.closest('.devtools');
        devtools.querySelectorAll('.devtools-tab').forEach(t => t.classList.remove('active'));
        devtools.querySelectorAll('.devtools-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        devtools.querySelector(`#dt-${panel}`).classList.add('active');

        // Refresh panel content
        const browser = devtools.closest('.browser');
        if (panel === 'elements') this.dtRefreshElements(browser);
        if (panel === 'console') this.dtRefreshConsole(browser);
        if (panel === 'sources') this.dtRefreshSources(browser);
        if (panel === 'network') this.dtRefreshNetwork(browser);
        if (panel === 'storage') this.dtRefreshStorage(browser, 'local');
        if (panel === 'performance') this.dtRefreshPerformance(browser);
    },

    dtRefresh(el) {
        const browser = el.closest('.browser');
        const activeTab = browser.querySelector('.devtools-tab.active');
        if (activeTab) {
            this.dtSwitchPanel(activeTab, activeTab.dataset.panel);
        }
    },

    dtStartResize(e) {
        const devtools = e.target.closest('.devtools');
        const startY = e.clientY;
        const startHeight = devtools.offsetHeight;

        const onMove = (e) => {
            const diff = startY - e.clientY;
            devtools.style.height = Math.max(150, Math.min(startHeight + diff, window.innerHeight * 0.6)) + 'px';
        };
        const onUp = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    },

    // ===== ELEMENTS PANEL =====
    dtRefreshElements(browser) {
        const iframe = browser.querySelector('iframe');
        const treeEl = browser.querySelector('#dt-dom-tree');

        try {
            let doc;
            if (iframe.srcdoc) {
                const parser = new DOMParser();
                doc = parser.parseFromString(iframe.srcdoc, 'text/html');
            } else {
                doc = iframe.contentDocument;
            }

            if (doc && doc.documentElement) {
                treeEl.innerHTML = this.dtBuildDomTree(doc.documentElement, 0);
            } else {
                treeEl.innerHTML = '<div style="color:#969696;padding:8px">Cross-origin iframe - cannot inspect DOM</div>';
            }
        } catch (e) {
            treeEl.innerHTML = '<div style="color:#969696;padding:8px">Cross-origin iframe - cannot inspect DOM<br><br>Tip: Use Fetch Mode to enable DOM inspection!</div>';
        }
    },

    dtBuildDomTree(node, depth) {
        if (!node) return '';
        let html = '';

        if (node.nodeType === 1) { // Element
            const tag = node.tagName.toLowerCase();
            const attrs = Array.from(node.attributes || []).slice(0, 3).map(a =>
                `<span class="dt-dom-attr">${a.name}</span>=<span class="dt-dom-attr-val">"${this.dtEscape(a.value.substring(0, 30))}${a.value.length > 30 ? '...' : ''}"</span>`
            ).join(' ');

            const hasChildren = node.children.length > 0;
            const expand = hasChildren ? '<span class="dt-dom-expand">‚ñ∂</span>' : '<span class="dt-dom-expand"></span>';

            html += `<div class="dt-dom-node" data-depth="${depth}" onclick="$.dtSelectElement(this, event)">`;
            html += `${expand}<span class="dt-dom-tag">&lt;${tag}</span>${attrs ? ' ' + attrs : ''}<span class="dt-dom-tag">&gt;</span>`;

            if (!hasChildren && node.textContent.trim()) {
                const text = node.textContent.trim().substring(0, 50);
                html += `<span class="dt-dom-text">${this.dtEscape(text)}${node.textContent.length > 50 ? '...' : ''}</span>`;
                html += `<span class="dt-dom-tag">&lt;/${tag}&gt;</span>`;
            }
            html += '</div>';

            if (hasChildren) {
                html += `<div class="dt-dom-children" style="display:none">`;
                for (const child of node.childNodes) {
                    if (child.nodeType === 1) {
                        html += this.dtBuildDomTree(child, depth + 1);
                    } else if (child.nodeType === 3 && child.textContent.trim()) {
                        html += `<div class="dt-dom-node"><span class="dt-dom-expand"></span><span class="dt-dom-text">"${this.dtEscape(child.textContent.trim().substring(0, 50))}"</span></div>`;
                    }
                }
                html += `<div class="dt-dom-node"><span class="dt-dom-expand"></span><span class="dt-dom-tag">&lt;/${tag}&gt;</span></div>`;
                html += '</div>';
            }
        }
        return html;
    },

    dtSelectElement(el, e) {
        e.stopPropagation();
        const browser = el.closest('.browser');

        // Toggle expand/collapse
        const children = el.nextElementSibling;
        if (children && children.classList.contains('dt-dom-children')) {
            const expand = el.querySelector('.dt-dom-expand');
            if (children.style.display === 'none') {
                children.style.display = 'block';
                expand.textContent = '‚ñº';
            } else {
                children.style.display = 'none';
                expand.textContent = '‚ñ∂';
            }
        }

        // Select element
        browser.querySelectorAll('.dt-dom-node').forEach(n => n.classList.remove('selected'));
        el.classList.add('selected');

        // Show computed styles (mock data for demo)
        this.dtShowStyles(browser, el);
    },

    dtShowStyles(browser, el) {
        const stylesEl = browser.querySelector('#dt-computed-styles');
        const boxEl = browser.querySelector('#dt-box-model');
        const iframe = browser.querySelector('iframe');

        // Extract element info from the DOM node display
        const tagMatch = el.innerHTML.match(/&lt;(\w+)/);
        const tag = tagMatch ? tagMatch[1] : 'div';

        // Try to get actual computed styles
        let computedStyles = {};
        let boxModel = { margin: '0', border: '0', padding: '0', width: 'auto', height: 'auto' };

        try {
            // For srcdoc iframes, we can access the real element
            if (iframe.srcdoc) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(iframe.srcdoc, 'text/html');

                // Extract all styles from the document
                const allStyles = this.dtExtractPageStyles(doc);

                // Find the element path from our selection
                const depth = parseInt(el.dataset.depth || 0);
                const attrMatch = el.innerHTML.match(/class="([^"]*)"/);
                const classNames = attrMatch ? attrMatch[1].split(' ') : [];
                const idMatch = el.innerHTML.match(/id="([^"]*)"/);
                const id = idMatch ? idMatch[1] : null;

                // Build selector and find matching styles
                let selector = tag;
                if (id) selector = `#${id}`;
                else if (classNames.length) selector = `.${classNames[0]}`;

                computedStyles = this.dtMatchStyles(allStyles, tag, id, classNames);

                // Try to get actual element dimensions
                const actualEl = id ? doc.getElementById(id) :
                                 classNames.length ? doc.querySelector(`.${classNames[0]}`) :
                                 doc.querySelector(tag);

                if (actualEl) {
                    const inlineStyle = actualEl.getAttribute('style');
                    if (inlineStyle) {
                        inlineStyle.split(';').forEach(rule => {
                            const [prop, val] = rule.split(':').map(s => s?.trim());
                            if (prop && val) computedStyles[prop] = val;
                        });
                    }
                }
            }
        } catch (e) {
            // Fallback to defaults
        }

        // Merge with smart defaults based on tag
        const tagDefaults = {
            'html': { display: 'block' },
            'body': { display: 'block', margin: '8px' },
            'div': { display: 'block' },
            'span': { display: 'inline' },
            'p': { display: 'block', margin: '1em 0' },
            'h1': { display: 'block', 'font-size': '2em', 'font-weight': 'bold', margin: '.67em 0' },
            'h2': { display: 'block', 'font-size': '1.5em', 'font-weight': 'bold', margin: '.83em 0' },
            'h3': { display: 'block', 'font-size': '1.17em', 'font-weight': 'bold', margin: '1em 0' },
            'a': { display: 'inline', color: '#0000EE', 'text-decoration': 'underline', cursor: 'pointer' },
            'img': { display: 'inline-block' },
            'ul': { display: 'block', 'list-style-type': 'disc', margin: '1em 0', 'padding-left': '40px' },
            'ol': { display: 'block', 'list-style-type': 'decimal', margin: '1em 0', 'padding-left': '40px' },
            'li': { display: 'list-item' },
            'table': { display: 'table', 'border-collapse': 'separate' },
            'tr': { display: 'table-row' },
            'td': { display: 'table-cell', padding: '1px' },
            'th': { display: 'table-cell', 'font-weight': 'bold', 'text-align': 'center' },
            'input': { display: 'inline-block' },
            'button': { display: 'inline-block', cursor: 'pointer' },
            'form': { display: 'block' },
            'header': { display: 'block' },
            'footer': { display: 'block' },
            'nav': { display: 'block' },
            'main': { display: 'block' },
            'article': { display: 'block' },
            'section': { display: 'block' },
            'aside': { display: 'block' },
        };

        const baseDefaults = {
            'position': 'static',
            'color': 'rgb(0, 0, 0)',
            'background-color': 'transparent',
            'font-family': 'system-ui, sans-serif'
        };

        const finalStyles = { ...baseDefaults, ...(tagDefaults[tag] || { display: 'block' }), ...computedStyles };

        // Render styles with syntax highlighting
        stylesEl.innerHTML = Object.entries(finalStyles).map(([name, val]) =>
            `<div class="dt-style-prop"><span class="dt-style-name">${name}:</span><span class="dt-style-val">${val}</span></div>`
        ).join('');

        // Extract box model values
        const m = finalStyles['margin'] || '0';
        const b = finalStyles['border-width'] || '0';
        const p = finalStyles['padding'] || '0';
        const w = finalStyles['width'] || 'auto';
        const h = finalStyles['height'] || 'auto';

        boxEl.innerHTML = `
            <div class="dt-box">
                <div class="dt-box-margin">
                    <span class="dt-box-label" style="top:-10px;left:50%;transform:translateX(-50%)">margin</span>
                    <span class="dt-box-val" style="position:absolute;top:2px;left:50%;transform:translateX(-50%)">${m}</span>
                    <div class="dt-box-border">
                        <span class="dt-box-label" style="top:-8px;left:2px">border</span>
                        <span class="dt-box-val" style="position:absolute;top:2px;right:4px">${b}</span>
                        <div class="dt-box-padding">
                            <span class="dt-box-label" style="top:-8px;left:2px">padding</span>
                            <span class="dt-box-val" style="position:absolute;top:2px;right:4px">${p}</span>
                            <div class="dt-box-content">
                                <span class="dt-box-val">${w} √ó ${h}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    // Extract all CSS rules from a document
    dtExtractPageStyles(doc) {
        const styles = {};

        // Extract from <style> tags
        doc.querySelectorAll('style').forEach(styleEl => {
            const cssText = styleEl.textContent;
            this.dtParseCssRules(cssText, styles);
        });

        // Extract from inline styles on elements
        doc.querySelectorAll('[style]').forEach(el => {
            const tag = el.tagName.toLowerCase();
            if (!styles[tag]) styles[tag] = {};
            el.getAttribute('style').split(';').forEach(rule => {
                const [prop, val] = rule.split(':').map(s => s?.trim());
                if (prop && val) styles[tag][prop] = val;
            });
        });

        return styles;
    },

    // Parse CSS text into structured rules
    dtParseCssRules(cssText, styles) {
        // Simple CSS parser - handles basic selectors
        const ruleRegex = /([^{]+)\{([^}]+)\}/g;
        let match;

        while ((match = ruleRegex.exec(cssText)) !== null) {
            const selectors = match[1].trim().split(',').map(s => s.trim());
            const declarations = match[2].trim();

            selectors.forEach(selector => {
                if (!styles[selector]) styles[selector] = {};

                declarations.split(';').forEach(decl => {
                    const [prop, val] = decl.split(':').map(s => s?.trim());
                    if (prop && val) {
                        styles[selector][prop] = val;
                    }
                });
            });
        }
    },

    // Match styles to an element
    dtMatchStyles(allStyles, tag, id, classNames) {
        const matched = {};

        // Check tag selector
        if (allStyles[tag]) Object.assign(matched, allStyles[tag]);

        // Check class selectors
        classNames.forEach(cls => {
            if (allStyles[`.${cls}`]) Object.assign(matched, allStyles[`.${cls}`]);
            if (allStyles[`${tag}.${cls}`]) Object.assign(matched, allStyles[`${tag}.${cls}`]);
        });

        // Check ID selector (highest specificity)
        if (id && allStyles[`#${id}`]) Object.assign(matched, allStyles[`#${id}`]);

        // Check common patterns
        ['*', 'body *', `${tag}`, ...classNames.map(c => `.${c}`)].forEach(sel => {
            if (allStyles[sel]) Object.assign(matched, allStyles[sel]);
        });

        return matched;
    },

    dtEscape(str) {
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    },

    // ===== CONSOLE PANEL =====
    dtRefreshConsole(browser) {
        const logsEl = browser.querySelector('#dt-console-logs');
        logsEl.innerHTML = this.dtLogs.map(log => `
            <div class="dt-log ${log.type}">
                <span class="dt-log-icon">${log.type === 'error' ? '‚úï' : log.type === 'warn' ? '‚ö†' : log.type === 'info' ? '‚Ñπ' : '‚óè'}</span>
                <span class="dt-log-content">${this.dtFormatValue(log.message)}</span>
                <span class="dt-log-time">${log.time}</span>
            </div>
        `).join('');
        logsEl.scrollTop = logsEl.scrollHeight;
    },

    dtConsoleLog(type, ...args) {
        const time = new Date().toLocaleTimeString();
        this.dtLogs.push({ type, message: args, time });
        const browser = document.querySelector('.browser .devtools.open');
        if (browser) this.dtRefreshConsole(browser.closest('.browser'));
    },

    dtConsoleClear(el) {
        if (!el.closest('.browser').querySelector('#dt-preserve-logs')?.checked) {
            this.dtLogs = [];
        }
        this.dtRefreshConsole(el.closest('.browser'));
    },

    dtConsoleFilter(select) {
        const filter = select.value;
        const logsEl = select.closest('.devtools').querySelector('#dt-console-logs');
        logsEl.querySelectorAll('.dt-log').forEach(log => {
            if (filter === 'all' || log.classList.contains(filter)) {
                log.style.display = 'flex';
            } else {
                log.style.display = 'none';
            }
        });
    },

    dtConsoleExec(e) {
        if (e.key !== 'Enter') return;
        const input = e.target;
        const code = input.value.trim();
        if (!code) return;

        this.dtConsoleLog('log', `> ${code}`);

        try {
            const browser = input.closest('.browser');
            const iframe = browser.querySelector('iframe');
            let result;

            try {
                // Try to eval in iframe context
                result = iframe.contentWindow.eval(code);
            } catch (e) {
                // Fallback to main context
                result = eval(code);
            }

            this.dtConsoleLog('log', result);
        } catch (err) {
            this.dtConsoleLog('error', err.message);
        }

        input.value = '';
    },

    dtFormatValue(val) {
        if (val === null) return '<span class="dt-null">null</span>';
        if (val === undefined) return '<span class="dt-undefined">undefined</span>';
        if (typeof val === 'string') return `<span class="dt-string">"${this.dtEscape(val)}"</span>`;
        if (typeof val === 'number') return `<span class="dt-number">${val}</span>`;
        if (typeof val === 'boolean') return `<span class="dt-boolean">${val}</span>`;
        if (typeof val === 'function') return `<span class="dt-function">∆í ${val.name || 'anonymous'}()</span>`;
        if (Array.isArray(val)) return `<span class="dt-object">[${val.map(v => this.dtFormatValue(v)).join(', ')}]</span>`;
        if (typeof val === 'object') {
            try {
                const preview = JSON.stringify(val).substring(0, 100);
                return `<span class="dt-object">${this.dtEscape(preview)}${preview.length >= 100 ? '...' : ''}</span>`;
            } catch {
                return `<span class="dt-object">[Object]</span>`;
            }
        }
        return String(val);
    },

    // ===== SOURCES PANEL =====
    dtRefreshSources(browser) {
        const filesEl = browser.querySelector('#dt-sources-files');
        const iframe = browser.querySelector('iframe');

        const files = [
            { name: 'document', icon: 'üìÑ', type: 'html' },
            { name: 'styles', icon: 'üé®', type: 'css' },
        ];

        filesEl.innerHTML = files.map((f, i) => `
            <div class="dt-sources-file ${i === 0 ? 'active' : ''}" onclick="$.dtShowSource(this, '${f.type}')">
                <span class="dt-sources-file-icon">${f.icon}</span>
                ${f.name}
            </div>
        `).join('');

        this.dtShowSource(filesEl.querySelector('.dt-sources-file'), 'html');
    },

    dtShowSource(el, type) {
        const browser = el.closest('.browser');
        const codeEl = browser.querySelector('#dt-sources-code');
        const iframe = browser.querySelector('iframe');

        browser.querySelectorAll('.dt-sources-file').forEach(f => f.classList.remove('active'));
        el.classList.add('active');

        let source = '';
        try {
            if (iframe.srcdoc) {
                source = iframe.srcdoc;
            } else if (iframe.contentDocument) {
                source = iframe.contentDocument.documentElement.outerHTML;
            }
        } catch (e) {
            source = '// Cross-origin - cannot view source\n// Use Fetch Mode to enable source viewing';
        }

        if (type === 'css') {
            // Extract CSS
            const cssMatch = source.match(/<style[^>]*>([\s\S]*?)<\/style>/gi);
            source = cssMatch ? cssMatch.map(s => s.replace(/<\/?style[^>]*>/gi, '')).join('\n\n') : '/* No inline styles found */';
        }

        const lines = source.split('\n');
        codeEl.innerHTML = lines.map((line, i) => `
            <div class="dt-code-line">
                <span class="dt-code-num">${i + 1}</span>
                <span class="dt-code-content">${this.dtSyntaxHighlight(line, type)}</span>
            </div>
        `).join('');
    },

    dtSyntaxHighlight(code, type) {
        let html = this.dtEscape(code);
        if (type === 'html') {
            html = html.replace(/(&lt;\/?)([\w-]+)/g, '$1<span class="dt-syntax-tag">$2</span>');
            html = html.replace(/([\w-]+)=(&quot;[^&]*&quot;)/g, '<span class="dt-syntax-attr">$1</span>=<span class="dt-syntax-string">$2</span>');
            html = html.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="dt-syntax-comment">$1</span>');
        } else if (type === 'css') {
            html = html.replace(/([\w-]+)\s*:/g, '<span class="dt-syntax-attr">$1</span>:');
            html = html.replace(/:\s*([^;]+);/g, ': <span class="dt-syntax-string">$1</span>;');
            html = html.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="dt-syntax-comment">$1</span>');
        }
        return html;
    },

    // ===== NETWORK PANEL =====
    dtRefreshNetwork(browser) {
        const listEl = browser.querySelector('#dt-network-list');
        const summaryEl = browser.querySelector('#dt-network-summary');

        const header = '<div class="dt-network-header"><span></span><span>Name</span><span>Status</span><span>Type</span><span>Size</span><span>Time</span></div>';

        const rows = this.dtNetworkRequests.map((req, i) => `
            <div class="dt-network-row" onclick="$.dtShowNetworkDetail(this, ${i})">
                <span class="dt-network-status s${String(req.status)[0]}">${req.status}</span>
                <span class="dt-network-name" title="${req.url}">${req.name}</span>
                <span>${req.status}</span>
                <span>${req.type}</span>
                <span>${req.size}</span>
                <span>${req.time}</span>
            </div>
        `).join('');

        listEl.innerHTML = header + rows;
        summaryEl.textContent = `${this.dtNetworkRequests.length} requests`;
    },

    dtNetworkClear(el) {
        this.dtNetworkRequests = [];
        this.dtRefreshNetwork(el.closest('.browser'));
    },

    dtLogNetworkRequest(url, status, type, size, time) {
        const name = url.split('/').pop() || url;
        this.dtNetworkRequests.push({ url, name, status, type, size, time });
        const browser = document.querySelector('.browser .devtools.open');
        if (browser) this.dtRefreshNetwork(browser.closest('.browser'));
    },

    dtShowNetworkDetail(el, index) {
        const browser = el.closest('.browser');
        const detailEl = browser.querySelector('#dt-network-detail');
        const req = this.dtNetworkRequests[index];

        browser.querySelectorAll('.dt-network-row').forEach(r => r.classList.remove('selected'));
        el.classList.add('selected');

        detailEl.classList.add('show');
        detailEl.innerHTML = `
            <div class="dt-network-detail-section">
                <h4>General</h4>
                <div class="dt-style-prop"><span class="dt-style-name">URL:</span><span class="dt-style-val">${req.url}</span></div>
                <div class="dt-style-prop"><span class="dt-style-name">Status:</span><span class="dt-style-val">${req.status}</span></div>
                <div class="dt-style-prop"><span class="dt-style-name">Type:</span><span class="dt-style-val">${req.type}</span></div>
            </div>
            <div class="dt-network-detail-section">
                <h4>Timing</h4>
                <div class="dt-network-timing"><div class="dt-network-timing-bar" style="width:${Math.min(100, parseInt(req.time) / 10)}%"></div></div>
                <div class="dt-style-prop"><span class="dt-style-name">Duration:</span><span class="dt-style-val">${req.time}</span></div>
            </div>
        `;
    },

    // ===== STORAGE PANEL =====
    dtRefreshStorage(browser, type) {
        const contentEl = browser.querySelector('#dt-storage-content');
        let data = {};

        if (type === 'local') {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                data[key] = localStorage.getItem(key);
            }
        } else if (type === 'session') {
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                data[key] = sessionStorage.getItem(key);
            }
        } else if (type === 'cookies') {
            document.cookie.split(';').forEach(c => {
                const [key, val] = c.trim().split('=');
                if (key) data[key] = val || '';
            });
        }

        const storage = type === 'local' ? 'localStorage' : type === 'session' ? 'sessionStorage' : 'cookies';

        contentEl.innerHTML = `
            <div class="dt-storage-actions">
                <button onclick="$.dtStorageAdd('${type}')">+ Add</button>
                <button class="danger" onclick="$.dtStorageClear('${type}')">Clear All</button>
            </div>
            <table class="dt-storage-table">
                <thead><tr><th>Key</th><th>Value</th><th></th></tr></thead>
                <tbody>
                    ${Object.entries(data).map(([key, val]) => `
                        <tr>
                            <td class="dt-storage-key" title="${this.dtEscape(key)}">${this.dtEscape(key)}</td>
                            <td class="dt-storage-val" title="${this.dtEscape(val)}">${this.dtEscape(String(val).substring(0, 100))}</td>
                            <td><button class="devtools-btn" onclick="$.dtStorageDelete('${type}','${this.dtEscape(key)}')">‚úï</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    dtStorageSwitch(el, type) {
        const browser = el.closest('.browser');
        browser.querySelectorAll('.dt-storage-cat').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        this.dtRefreshStorage(browser, type);
    },

    dtStorageAdd(type) {
        const key = prompt('Enter key:');
        if (!key) return;
        const val = prompt('Enter value:');
        if (val === null) return;

        if (type === 'local') localStorage.setItem(key, val);
        else if (type === 'session') sessionStorage.setItem(key, val);
        else if (type === 'cookies') document.cookie = `${key}=${val}`;

        const browser = document.querySelector('.browser .devtools.open');
        if (browser) this.dtRefreshStorage(browser.closest('.browser'), type);
    },

    dtStorageDelete(type, key) {
        if (type === 'local') localStorage.removeItem(key);
        else if (type === 'session') sessionStorage.removeItem(key);
        else if (type === 'cookies') document.cookie = `${key}=;expires=Thu, 01 Jan 1970 00:00:00 GMT`;

        const browser = document.querySelector('.browser .devtools.open');
        if (browser) this.dtRefreshStorage(browser.closest('.browser'), type);
    },

    dtStorageClear(type) {
        if (!confirm(`Clear all ${type} storage?`)) return;
        if (type === 'local') localStorage.clear();
        else if (type === 'session') sessionStorage.clear();

        const browser = document.querySelector('.browser .devtools.open');
        if (browser) this.dtRefreshStorage(browser.closest('.browser'), type);
    },

    // ===== PERFORMANCE PANEL =====
    dtRefreshPerformance(browser) {
        const contentEl = browser.querySelector('#dt-perf-content');
        const perf = performance;
        const timing = perf.timing || {};
        const memory = perf.memory || {};

        const navStart = timing.navigationStart || 0;
        const domReady = timing.domContentLoadedEventEnd ? timing.domContentLoadedEventEnd - navStart : 0;
        const loadTime = timing.loadEventEnd ? timing.loadEventEnd - navStart : 0;
        const dnsTime = timing.domainLookupEnd ? timing.domainLookupEnd - timing.domainLookupStart : 0;
        const connectTime = timing.connectEnd ? timing.connectEnd - timing.connectStart : 0;

        const memUsed = memory.usedJSHeapSize ? (memory.usedJSHeapSize / 1048576).toFixed(1) : 'N/A';
        const memTotal = memory.totalJSHeapSize ? (memory.totalJSHeapSize / 1048576).toFixed(1) : 'N/A';
        const memLimit = memory.jsHeapSizeLimit ? (memory.jsHeapSizeLimit / 1048576).toFixed(1) : 'N/A';

        // DOM stats
        const domNodes = document.getElementsByTagName('*').length;

        contentEl.innerHTML = `
            <div class="dt-perf-section">
                <div class="dt-perf-title">‚è± Page Load Timing</div>
                <div class="dt-perf-grid">
                    <div class="dt-perf-card">
                        <div class="dt-perf-value">${loadTime || '‚Äî'}</div>
                        <div class="dt-perf-label">Page Load (ms)</div>
                    </div>
                    <div class="dt-perf-card">
                        <div class="dt-perf-value">${domReady || '‚Äî'}</div>
                        <div class="dt-perf-label">DOM Ready (ms)</div>
                    </div>
                    <div class="dt-perf-card">
                        <div class="dt-perf-value">${dnsTime || '‚Äî'}</div>
                        <div class="dt-perf-label">DNS Lookup (ms)</div>
                    </div>
                    <div class="dt-perf-card">
                        <div class="dt-perf-value">${connectTime || '‚Äî'}</div>
                        <div class="dt-perf-label">Connect (ms)</div>
                    </div>
                </div>
            </div>
            <div class="dt-perf-section">
                <div class="dt-perf-title">üíæ Memory Usage</div>
                <div class="dt-perf-bar">
                    <div class="dt-perf-bar-fill ${memory.usedJSHeapSize ? (memory.usedJSHeapSize / memory.jsHeapSizeLimit > 0.8 ? 'bad' : memory.usedJSHeapSize / memory.jsHeapSizeLimit > 0.5 ? 'warn' : 'good') : 'good'}"
                         style="width:${memory.usedJSHeapSize ? (memory.usedJSHeapSize / memory.jsHeapSizeLimit * 100) : 30}%"></div>
                </div>
                <div class="dt-perf-grid">
                    <div class="dt-perf-card">
                        <div class="dt-perf-value">${memUsed}</div>
                        <div class="dt-perf-label">Used Heap (MB)</div>
                    </div>
                    <div class="dt-perf-card">
                        <div class="dt-perf-value">${memTotal}</div>
                        <div class="dt-perf-label">Total Heap (MB)</div>
                    </div>
                    <div class="dt-perf-card">
                        <div class="dt-perf-value">${memLimit}</div>
                        <div class="dt-perf-label">Heap Limit (MB)</div>
                    </div>
                </div>
            </div>
            <div class="dt-perf-section">
                <div class="dt-perf-title">üìä DOM Statistics</div>
                <div class="dt-perf-list">
                    <div class="dt-perf-item"><span>Total DOM Nodes</span><span>${domNodes}</span></div>
                    <div class="dt-perf-item"><span>Scripts</span><span>${document.scripts.length}</span></div>
                    <div class="dt-perf-item"><span>Stylesheets</span><span>${document.styleSheets.length}</span></div>
                    <div class="dt-perf-item"><span>Images</span><span>${document.images.length}</span></div>
                    <div class="dt-perf-item"><span>Iframes</span><span>${document.querySelectorAll('iframe').length}</span></div>
                    <div class="dt-perf-item"><span>Event Listeners</span><span>~${domNodes * 2}</span></div>
                </div>
            </div>
            <div class="dt-perf-section">
                <div class="dt-perf-title">üåê Connection Info</div>
                <div class="dt-perf-list">
                    <div class="dt-perf-item"><span>Effective Type</span><span>${navigator.connection?.effectiveType || 'N/A'}</span></div>
                    <div class="dt-perf-item"><span>Downlink</span><span>${navigator.connection?.downlink ? navigator.connection.downlink + ' Mbps' : 'N/A'}</span></div>
                    <div class="dt-perf-item"><span>RTT</span><span>${navigator.connection?.rtt ? navigator.connection.rtt + ' ms' : 'N/A'}</span></div>
                    <div class="dt-perf-item"><span>Save Data</span><span>${navigator.connection?.saveData ? 'Yes' : 'No'}</span></div>
                </div>
            </div>
        `;
    },

    openCalc() {
        this.createWin({
            title: 'Calculator', icon: 'üî¢', w: 320, h: 440,
            content: `<div class="calc"><div class="calc-display" id="calc-disp">0</div><div class="calc-btns"><button class="calc-btn" onclick="$.cc()">C</button><button class="calc-btn" onclick="$.cb()">‚å´</button><button class="calc-btn" onclick="$.cp()">%</button><button class="calc-btn op" onclick="$.co('/')">√∑</button><button class="calc-btn" onclick="$.cn('7')">7</button><button class="calc-btn" onclick="$.cn('8')">8</button><button class="calc-btn" onclick="$.cn('9')">9</button><button class="calc-btn op" onclick="$.co('*')">√ó</button><button class="calc-btn" onclick="$.cn('4')">4</button><button class="calc-btn" onclick="$.cn('5')">5</button><button class="calc-btn" onclick="$.cn('6')">6</button><button class="calc-btn op" onclick="$.co('-')">‚àí</button><button class="calc-btn" onclick="$.cn('1')">1</button><button class="calc-btn" onclick="$.cn('2')">2</button><button class="calc-btn" onclick="$.cn('3')">3</button><button class="calc-btn op" onclick="$.co('+')">+</button><button class="calc-btn" onclick="$.cn('0')">0</button><button class="calc-btn" onclick="$.cd()">.</button><button class="calc-btn eq" onclick="$.ce()">=</button></div></div>`
        });
        this.calcD = '0'; this.calcO = null; this.calcP = null; this.calcR = false;
    },

    cn(n) { const d = document.getElementById('calc-disp'); if (this.calcR || this.calcD === '0') { this.calcD = n; this.calcR = false; } else this.calcD += n; d.textContent = this.calcD; },
    co(o) { this.calcP = parseFloat(this.calcD); this.calcO = o; this.calcR = true; },
    ce() { if (!this.calcO || this.calcP === null) return; const c = parseFloat(this.calcD); let r; switch(this.calcO) { case '+': r = this.calcP + c; break; case '-': r = this.calcP - c; break; case '*': r = this.calcP * c; break; case '/': r = this.calcP / c; break; } this.calcD = String(r); document.getElementById('calc-disp').textContent = this.calcD; this.calcO = null; this.calcP = null; this.calcR = true; },
    cc() { this.calcD = '0'; this.calcO = null; this.calcP = null; document.getElementById('calc-disp').textContent = '0'; },
    cb() { this.calcD = this.calcD.slice(0, -1) || '0'; document.getElementById('calc-disp').textContent = this.calcD; },
    cd() { if (!this.calcD.includes('.')) { this.calcD += '.'; document.getElementById('calc-disp').textContent = this.calcD; } },
    cp() { this.calcD = String(parseFloat(this.calcD) / 100); document.getElementById('calc-disp').textContent = this.calcD; },

    openNotes() {
        const notes = JSON.parse(localStorage.getItem('infOS_notes') || '[]');
        if (!notes.length) notes.push({ id: 1, title: 'Welcome', content: 'Welcome to Notes!\n\nCreate and organize your thoughts.', date: new Date().toLocaleDateString() });
        this.createWin({
            title: 'Notes', icon: 'üìí', w: 750, h: 500,
            content: `<div class="notes"><div class="notes-list"><div class="notes-list-head"><span>Notes</span><button onclick="$.addNote(this)">+</button></div><div class="notes-list-body"></div></div><div class="notes-editor"><div class="notes-editor-title"><input type="text" placeholder="Title..."></div><div class="notes-editor-body"><textarea placeholder="Start typing..."></textarea></div></div></div>`,
            onInit: (body) => {
                this.notesData = notes;
                this.renderNotes(body);
                if (notes.length) this.selectNote(body, 0);
            }
        });
    },

    renderNotes(body) {
        const list = body.querySelector('.notes-list-body');
        list.innerHTML = '';
        this.notesData.forEach((n, i) => {
            const d = document.createElement('div');
            d.className = 'note-item' + (i === 0 ? ' active' : '');
            d.innerHTML = `<div class="note-item-title">${n.title}</div><div class="note-item-preview">${n.content.slice(0, 50)}</div><div class="note-item-date">${n.date}</div>`;
            d.onclick = () => { list.querySelectorAll('.note-item').forEach(x => x.classList.remove('active')); d.classList.add('active'); this.selectNote(body, i); };
            list.appendChild(d);
        });
    },

    selectNote(body, i) {
        this.currentNoteIdx = i;
        const n = this.notesData[i];
        body.querySelector('.notes-editor-title input').value = n.title;
        body.querySelector('.notes-editor-body textarea').value = n.content;
        body.querySelector('.notes-editor-title input').oninput = e => { n.title = e.target.value; this.saveNotes(); this.renderNotes(body); };
        body.querySelector('.notes-editor-body textarea').oninput = e => { n.content = e.target.value; this.saveNotes(); };
    },

    addNote(btn) {
        const body = btn.closest('.notes');
        this.notesData.unshift({ id: Date.now(), title: 'New Note', content: '', date: new Date().toLocaleDateString() });
        this.saveNotes();
        this.renderNotes(body);
        this.selectNote(body, 0);
    },

    saveNotes() { localStorage.setItem('infOS_notes', JSON.stringify(this.notesData)); },

    openTasks() {
        const tasks = JSON.parse(localStorage.getItem('infOS_tasks') || '[]');
        this.createWin({
            title: 'Tasks', icon: '‚úÖ', w: 550, h: 450,
            content: `<div class="tasks"><div class="tasks-header"><h2>My Tasks</h2><span id="tasks-count">0 tasks</span></div><div class="tasks-add"><input type="text" placeholder="Add a new task..." id="task-input"><button onclick="$.addTask()">Add</button></div><div id="tasks-list"></div></div>`,
            onInit: (body) => {
                this.tasksData = tasks;
                this.renderTasks(body);
                body.querySelector('#task-input').onkeydown = e => { if (e.key === 'Enter') this.addTask(); };
            }
        });
    },

    renderTasks(body) {
        const list = body.querySelector('#tasks-list');
        list.innerHTML = '';
        this.tasksData.forEach((t, i) => {
            const d = document.createElement('div');
            d.className = 'task' + (t.done ? ' done' : '');
            d.innerHTML = `<div class="task-check ${t.done ? 'done' : ''}" onclick="$.toggleTask(${i})">‚úì</div><div class="task-text">${t.text}</div><div class="task-del" onclick="$.delTask(${i})">üóëÔ∏è</div>`;
            list.appendChild(d);
        });
        body.querySelector('#tasks-count').textContent = this.tasksData.length + ' tasks';
    },

    addTask() {
        const inp = document.querySelector('#task-input');
        if (!inp.value.trim()) return;
        this.tasksData.unshift({ text: inp.value, done: false });
        inp.value = '';
        this.saveTasks();
        this.renderTasks(document.querySelector('.tasks'));
    },

    toggleTask(i) { this.tasksData[i].done = !this.tasksData[i].done; this.saveTasks(); this.renderTasks(document.querySelector('.tasks')); },
    delTask(i) { this.tasksData.splice(i, 1); this.saveTasks(); this.renderTasks(document.querySelector('.tasks')); },
    saveTasks() { localStorage.setItem('infOS_tasks', JSON.stringify(this.tasksData)); },

    openCalendar() {
        const now = new Date();
        let month = now.getMonth(), year = now.getFullYear();
        this.createWin({
            title: 'Calendar', icon: 'üìÖ', w: 380, h: 400,
            content: `<div class="calendar" id="cal-wrap"></div>`,
            onInit: (body) => {
                const render = () => {
                    const first = new Date(year, month, 1).getDay();
                    const days = new Date(year, month + 1, 0).getDate();
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    let html = `<div class="cal-header"><h2 class="cal-title">${months[month]} ${year}</h2><div class="cal-nav"><button id="cal-prev">‚Üê</button><button id="cal-next">‚Üí</button></div></div><div class="cal-grid"><div class="cal-day-head">Su</div><div class="cal-day-head">Mo</div><div class="cal-day-head">Tu</div><div class="cal-day-head">We</div><div class="cal-day-head">Th</div><div class="cal-day-head">Fr</div><div class="cal-day-head">Sa</div>`;
                    for (let i = 0; i < first; i++) html += '<div class="cal-day other"></div>';
                    for (let d = 1; d <= days; d++) {
                        const isToday = d === now.getDate() && month === now.getMonth() && year === now.getFullYear();
                        html += `<div class="cal-day ${isToday ? 'today' : ''}">${d}</div>`;
                    }
                    html += '</div>';
                    body.querySelector('#cal-wrap').innerHTML = html;
                    body.querySelector('#cal-prev').onclick = () => { month--; if (month < 0) { month = 11; year--; } render(); };
                    body.querySelector('#cal-next').onclick = () => { month++; if (month > 11) { month = 0; year++; } render(); };
                };
                render();
            }
        });
    },

    openMusic() {
        this.createWin({
            title: 'Music', icon: 'üéµ', w: 380, h: 480,
            content: `<div class="music"><div class="music-cover">üéµ</div><div class="music-title">Lo-Fi Beats</div><div class="music-artist">Chill Station</div><div class="music-progress"><div class="music-progress-bar"></div></div><div class="music-times"><span>1:23</span><span>3:45</span></div><div class="music-controls"><button class="music-btn">‚èÆ</button><button class="music-btn play" onclick="this.textContent = this.textContent === '‚ñ∂' ? '‚è∏' : '‚ñ∂'">‚ñ∂</button><button class="music-btn">‚è≠</button></div></div>`
        });
    },

    openWeather() {
        this.createWin({
            title: 'Weather', icon: 'üå§Ô∏è', w: 380, h: 320,
            content: `<div class="weather"><div class="weather-icon">‚òÄÔ∏è</div><div class="weather-temp">72¬∞F</div><div class="weather-desc">Sunny</div><div class="weather-details"><div class="weather-detail"><div class="weather-detail-val">65%</div><div class="weather-detail-lbl">Humidity</div></div><div class="weather-detail"><div class="weather-detail-val">12 mph</div><div class="weather-detail-lbl">Wind</div></div><div class="weather-detail"><div class="weather-detail-val">UV 6</div><div class="weather-detail-lbl">UV Index</div></div></div></div>`
        });
    },

    openPhotos() {
        this.createWin({
            title: 'Photos', icon: 'üñºÔ∏è', w: 700, h: 500,
            content: `<div class="photo"><div class="photo-bar"><button onclick="document.getElementById('photo-upload').click()">üìÅ Open</button><input type="file" id="photo-upload" accept="image/*" style="display:none"><button onclick="$.photoSave()">üíæ Save</button><div class="photo-filters"><button class="photo-filter active" data-filter="none">None</button><button class="photo-filter" data-filter="grayscale(100%)">B&W</button><button class="photo-filter" data-filter="sepia(100%)">Sepia</button><button class="photo-filter" data-filter="contrast(150%)">Contrast</button><button class="photo-filter" data-filter="brightness(120%)">Bright</button></div></div><div class="photo-canvas-wrap"><canvas class="photo-canvas" id="photo-canvas"></canvas></div></div>`,
            onInit: (body) => {
                const canvas = body.querySelector('#photo-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 600; canvas.height = 400;
                ctx.fillStyle = '#333'; ctx.fillRect(0, 0, 600, 400);
                ctx.fillStyle = '#666'; ctx.font = '18px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText('Open an image to edit', 300, 200);
                this.photoCanvas = canvas;
                this.photoCtx = ctx;

                body.querySelector('#photo-upload').onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const img = new Image();
                    img.onload = () => {
                        canvas.width = img.width; canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        this.photoImg = img;
                    };
                    img.src = URL.createObjectURL(file);
                };

                body.querySelectorAll('.photo-filter').forEach(btn => {
                    btn.onclick = () => {
                        body.querySelectorAll('.photo-filter').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        canvas.style.filter = btn.dataset.filter;
                    };
                });
            }
        });
    },

    photoSave() {
        if (this.photoCanvas) {
            const link = document.createElement('a');
            link.download = 'photo.png';
            link.href = this.photoCanvas.toDataURL();
            link.click();
        }
    },

    openMarkdown(content = '', filename = 'untitled.md') {
        this.createWin({
            title: 'Markdown - ' + filename, icon: 'üìÑ', w: 900, h: 550,
            content: `<div class="md"><div class="md-edit"><textarea placeholder="# Write Markdown here...">${content || '# Welcome to Markdown Editor\n\nWrite **bold**, *italic*, and more!\n\n## Features\n- Live preview\n- Simple syntax\n- Export ready\n\n```js\nconsole.log("Hello!");\n```'}</textarea></div><div class="md-preview"></div></div>`,
            onInit: (body) => {
                const ta = body.querySelector('.md-edit textarea');
                const preview = body.querySelector('.md-preview');
                const render = () => { preview.innerHTML = this.parseMd(ta.value); };
                render();
                ta.oninput = render;
            }
        });
    },

    parseMd(md) {
        return md
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/^- (.*$)/gm, '<li>$1</li>')
            .replace(/\n/g, '<br>');
    },

    openClock() {
        this.createWin({
            title: 'Clock', icon: 'üïê', w: 350, h: 280,
            content: `<div class="clock-widget"><div class="clock-time" id="cw-time">00:00:00</div><div class="clock-date" id="cw-date"></div><div class="clock-seconds" id="cw-secs"></div></div>`,
            onInit: (body) => {
                const update = () => {
                    const now = new Date();
                    body.querySelector('#cw-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                    body.querySelector('#cw-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                };
                update();
                setInterval(update, 1000);
            }
        });
    },

    openSettings() {
        this.createWin({
            title: 'Settings', icon: '‚öôÔ∏è', w: 800, h: 550,
            content: `<div class="settings"><div class="settings-nav"><div class="settings-nav-item active">üé® Appearance</div><div class="settings-nav-item">üîä Sound</div><div class="settings-nav-item">üîí Privacy</div><div class="settings-nav-item">üë§ Account</div><div class="settings-nav-item">‚ÑπÔ∏è About</div></div><div class="settings-body"><h2 class="settings-title">Appearance</h2><div class="settings-section"><div class="settings-row"><div><h4>Dark Mode</h4><p>Use dark colors for the interface</p></div><div class="toggle on"></div></div><div class="settings-row"><div><h4>Animations</h4><p>Enable smooth transitions</p></div><div class="toggle on"></div></div><div class="settings-row"><div><h4>Transparency</h4><p>Use transparent window effects</p></div><div class="toggle on"></div></div></div><div class="settings-section"><h3>Account</h3><div class="settings-row"><div><h4>Username</h4><p>${this.user.name}</p></div><button onclick="$.changeUser()">Change</button></div></div></div></div>`,
            onInit: (body) => {
                body.querySelectorAll('.toggle').forEach(t => t.onclick = () => t.classList.toggle('on'));
            }
        });
    },

    changeUser() {
        const name = prompt('Enter new username:', this.user.name);
        if (name) {
            this.user.name = name;
            this.save();
            document.getElementById('lock-user').textContent = name;
            document.getElementById('start-name').textContent = name;
            this.notify('Settings', 'Username changed', '‚öôÔ∏è');
        }
    },

    openTaskMgr() {
        this.createWin({
            title: 'Task Manager', icon: 'üìä', w: 650, h: 450,
            content: `<div class="taskmgr"><table><thead><tr><th>Name</th><th>Status</th><th>CPU</th><th>Memory</th></tr></thead><tbody id="tm-list"></tbody></table></div>`,
            onInit: (body) => {
                const list = body.querySelector('#tm-list');
                this.wins.forEach(w => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${w.icon} ${w.title}</td><td>Running</td><td>${Math.floor(Math.random() * 8)}%</td><td>${Math.floor(Math.random() * 80 + 20)} MB</td>`;
                    list.appendChild(tr);
                });
            }
        });
    },

    openAbout() {
        this.createWin({
            title: 'About', icon: '‚ÑπÔ∏è', w: 450, h: 420,
            content: `<div class="about"><div class="about-logo">‚ôæÔ∏è</div><h1 class="about-title">InfiniteOS</h1><p class="about-ver">Version ${this.v}</p><div class="about-info"><div class="about-row"><span>Platform</span><span>Browser</span></div><div class="about-row"><span>Engine</span><span>JavaScript</span></div><div class="about-row"><span>Storage</span><span>localStorage</span></div><div class="about-row"><span>Windows</span><span>${this.wins.length}</span></div><div class="about-row"><span>Recursion</span><span>‚àû</span></div></div></div>`
        });
    },

    openInfinite() {
        this.createWin({
            title: 'InfiniteOS ‚àû', icon: '‚ôæÔ∏è', w: 900, h: 600,
            content: `<iframe class="recursive-frame" src="${location.href}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>`
        });
        this.notify('Inception', 'Entering recursive mode...', '‚ôæÔ∏è');
    },

    // Utils
    notify(title, msg, icon = 'üîî') {
        const c = document.getElementById('notifs');
        const n = document.createElement('div');
        n.className = 'notif';
        n.innerHTML = `<div class="notif-head"><span>${icon}</span><span>${title}</span></div><div class="notif-body">${msg}</div>`;
        c.appendChild(n);
        setTimeout(() => { n.style.opacity = '0'; setTimeout(() => n.remove(), 200); }, 3500);
    },

    restart() { location.reload(); },
    shutdown() { document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;background:#000;font-size:20px">Goodbye</div>'; },
    delay(ms) { return new Promise(r => setTimeout(r, ms)); }
};

// Events
document.getElementById('start-btn').onclick = () => $.toggleStart();
document.getElementById('lock-pass').onkeydown = e => { if (e.key === 'Enter') $.unlock(); };

document.addEventListener('click', e => {
    if ($.startOpen && !e.target.closest('#start') && !e.target.closest('#start-btn')) $.closeStart();
    if ($.qpanelOpen && !e.target.closest('#qpanel') && !e.target.closest('#clock') && !e.target.closest('.tray-btn')) { $.qpanelOpen = false; document.getElementById('qpanel').style.display = 'none'; }
    if (!e.target.closest('#ctx')) document.getElementById('ctx').style.display = 'none';
    if ($.spotOpen && !e.target.closest('#spotlight')) $.toggleSpot();
});

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        $.closeStart();
        if ($.spotOpen) $.toggleSpot();
        document.getElementById('ctx').style.display = 'none';
        document.getElementById('qpanel').style.display = 'none';
    }
    if ((e.metaKey || e.ctrlKey) && e.code === 'Space') { e.preventDefault(); $.toggleSpot(); }
});

document.getElementById('spot-input').oninput = e => $.updateSpotlight(e.target.value);
document.getElementById('spot-input').onkeydown = e => {
    if (e.key === 'Enter') {
        const sel = document.querySelector('.spot-item.sel');
        if (sel) sel.click();
    }
};

document.getElementById('search-input').oninput = e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('.sapp').forEach(app => {
        app.style.display = app.querySelector('.sapp-name').textContent.toLowerCase().includes(q) ? '' : 'none';
    });
};

document.getElementById('desktop').oncontextmenu = e => {
    e.preventDefault();
    const ctx = document.getElementById('ctx');
    ctx.innerHTML = `<div class="ctx-item" onclick="$.openFiles()">üìÅ Open Files</div><div class="ctx-item" onclick="$.openTerminal()">üíª Open Terminal</div><div class="ctx-sep"></div><div class="ctx-item" onclick="$.newFolder()">üìÅ New Folder</div><div class="ctx-item" onclick="$.openSettings()">‚öôÔ∏è Settings</div><div class="ctx-sep"></div><div class="ctx-item" onclick="$.openInfinite()">‚ôæÔ∏è Open InfiniteOS</div>`;
    ctx.style.left = e.clientX + 'px';
    ctx.style.top = e.clientY + 'px';
    ctx.style.display = 'block';
};

// Boot
$.boot();
</script>
</body>
</html>
