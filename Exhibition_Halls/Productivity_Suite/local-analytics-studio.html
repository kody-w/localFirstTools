<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Analytics Studio - Privacy-First Analytics Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .privacy-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        canvas {
            max-width: 100%;
            height: 300px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        input, select, textarea, button {
            font-family: inherit;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="datetime-local"],
        select,
        textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .event-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .event-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .event-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .event-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .event-time {
            color: #6c757d;
            font-size: 0.9em;
        }

        .event-properties {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
            color: #495057;
        }

        .metric-builder {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .funnel-step {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .funnel-step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .funnel-visualization {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .funnel-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }

        .funnel-bar:hover {
            transform: scaleX(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .widget {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .widget-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .cohort-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .cohort-table th,
        .cohort-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .cohort-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .cohort-table td {
            background: white;
        }

        .retention-cell {
            position: relative;
            overflow: hidden;
        }

        .retention-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(102, 126, 234, 0.3);
            z-index: 0;
        }

        .retention-value {
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        .json-display {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Local Analytics Studio</h1>
            <p>Privacy-First Analytics Platform - All Data Stays on Your Device</p>
            <div class="privacy-badge">üîí 100% Local ‚Ä¢ Zero Tracking ‚Ä¢ Your Data, Your Control</div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="events">Track Events</button>
            <button class="nav-tab" data-tab="analytics">Analytics</button>
            <button class="nav-tab" data-tab="funnel">Funnel Analysis</button>
            <button class="nav-tab" data-tab="cohorts">Cohort Analysis</button>
            <button class="nav-tab" data-tab="export">Import/Export</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Events</div>
                    <div class="stat-value" id="totalEvents">0</div>
                    <div class="stat-change" id="eventsChange">+0% from last period</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unique Users</div>
                    <div class="stat-value" id="uniqueUsers">0</div>
                    <div class="stat-change" id="usersChange">+0% from last period</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Events Today</div>
                    <div class="stat-value" id="eventsToday">0</div>
                    <div class="stat-change" id="todayChange">Last 24 hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Events/User</div>
                    <div class="stat-value" id="avgEvents">0</div>
                    <div class="stat-change" id="avgChange">Per user</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Events Over Time</div>
                <canvas id="timelineChart"></canvas>
            </div>

            <div class="dashboard-grid">
                <div class="widget">
                    <div class="widget-header">
                        <div class="widget-title">Top Events</div>
                    </div>
                    <canvas id="topEventsChart"></canvas>
                </div>
                <div class="widget">
                    <div class="widget-header">
                        <div class="widget-title">User Activity</div>
                    </div>
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Track Events Tab -->
        <div class="tab-content" id="events">
            <div class="alert alert-info">
                üí° Track custom events with properties. Perfect for analyzing user behavior, conversions, and engagement.
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Event Name</label>
                    <input type="text" id="eventName" placeholder="e.g., button_click, page_view">
                </div>
                <div class="control-group">
                    <label>User ID (optional)</label>
                    <input type="text" id="userId" placeholder="User identifier">
                </div>
            </div>

            <div class="metric-builder">
                <h3 style="margin-bottom: 15px;">Event Properties (JSON)</h3>
                <textarea id="eventProperties" rows="6" placeholder='{"page": "home", "button": "signup", "campaign": "summer2024"}'></textarea>
                <button class="btn btn-primary" onclick="Analytics.trackEvent()" style="margin-top: 15px;">
                    üìä Track Event
                </button>
            </div>

            <h3 style="margin: 30px 0 15px 0;">Recent Events</h3>
            <div class="event-list" id="eventsList"></div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics">
            <div class="controls">
                <div class="control-group">
                    <label>Date Range</label>
                    <select id="dateRange" onchange="Analytics.updateAnalytics()">
                        <option value="today">Today</option>
                        <option value="week" selected>Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="all">All Time</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="control-group" id="customDateRange" style="display: none;">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="control-group" id="customDateRangeEnd" style="display: none;">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="control-group">
                    <label>Group By</label>
                    <select id="groupBy" onchange="Analytics.updateAnalytics()">
                        <option value="hour">Hour</option>
                        <option value="day" selected>Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Event Trends</div>
                <canvas id="trendsChart"></canvas>
            </div>

            <div class="dashboard-grid">
                <div class="widget">
                    <div class="widget-header">
                        <div class="widget-title">Events by Type</div>
                    </div>
                    <canvas id="eventTypeChart"></canvas>
                </div>
                <div class="widget">
                    <div class="widget-header">
                        <div class="widget-title">User Engagement</div>
                    </div>
                    <canvas id="engagementChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Funnel Analysis Tab -->
        <div class="tab-content" id="funnel">
            <div class="alert alert-info">
                üéØ Track conversion funnels to understand where users drop off in multi-step processes.
            </div>

            <div class="metric-builder">
                <h3 style="margin-bottom: 15px;">Define Funnel Steps</h3>
                <div id="funnelSteps">
                    <div class="funnel-step">
                        <div class="funnel-step-number">1</div>
                        <input type="text" placeholder="Event name for step 1" class="funnel-step-input" value="page_view">
                    </div>
                    <div class="funnel-step">
                        <div class="funnel-step-number">2</div>
                        <input type="text" placeholder="Event name for step 2" class="funnel-step-input" value="add_to_cart">
                    </div>
                    <div class="funnel-step">
                        <div class="funnel-step-number">3</div>
                        <input type="text" placeholder="Event name for step 3" class="funnel-step-input" value="checkout">
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="Analytics.addFunnelStep()" style="margin-top: 15px;">
                    + Add Step
                </button>
                <button class="btn btn-primary" onclick="Analytics.analyzeFunnel()" style="margin-top: 15px;">
                    üìä Analyze Funnel
                </button>
            </div>

            <div id="funnelResults"></div>
        </div>

        <!-- Cohort Analysis Tab -->
        <div class="tab-content" id="cohorts">
            <div class="alert alert-info">
                üë• Analyze user retention over time by grouping users based on when they first performed an event.
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Cohort Event</label>
                    <input type="text" id="cohortEvent" placeholder="Event that defines cohort (e.g., signup)" value="signup">
                </div>
                <div class="control-group">
                    <label>Return Event</label>
                    <input type="text" id="returnEvent" placeholder="Event that indicates return (e.g., login)" value="login">
                </div>
                <div class="control-group">
                    <label>Cohort Size</label>
                    <select id="cohortSize">
                        <option value="day">Daily</option>
                        <option value="week" selected>Weekly</option>
                        <option value="month">Monthly</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="Analytics.analyzeCohorts()">
                üìä Generate Cohort Analysis
            </button>

            <div id="cohortResults"></div>
        </div>

        <!-- Import/Export Tab -->
        <div class="tab-content" id="export">
            <div class="alert alert-success">
                üíæ Export your analytics data for backup or import data from other sources. All data stays on your device.
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="Analytics.exportData()">
                    üì• Export All Data (JSON)
                </button>
                <button class="btn btn-secondary" onclick="Analytics.exportCSV()">
                    üìä Export as CSV
                </button>
                <button class="btn btn-danger" onclick="Analytics.clearData()">
                    üóëÔ∏è Clear All Data
                </button>
            </div>

            <div class="metric-builder">
                <h3 style="margin-bottom: 15px;">Import Data</h3>
                <input type="file" id="importFile" accept=".json" style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="Analytics.importData()">
                    üì§ Import JSON Data
                </button>
            </div>

            <div class="metric-builder">
                <h3 style="margin-bottom: 15px;">Generate Sample Data</h3>
                <p style="margin-bottom: 15px; color: #6c757d;">Quickly populate with sample events for testing</p>
                <div class="controls">
                    <div class="control-group">
                        <label>Number of Events</label>
                        <input type="number" id="sampleCount" value="100" min="10" max="1000">
                    </div>
                    <div class="control-group">
                        <label>Number of Users</label>
                        <input type="number" id="sampleUsers" value="20" min="1" max="100">
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="Analytics.generateSampleData()">
                    üé≤ Generate Sample Data
                </button>
            </div>

            <h3 style="margin: 30px 0 15px 0;">Current Data Summary</h3>
            <div class="json-display" id="dataSummary"></div>
        </div>
    </div>

    <script>
        const Analytics = {
            events: [],
            charts: {},

            init() {
                this.loadData();
                this.setupEventListeners();
                this.updateDashboard();
                this.updateEventsList();
                this.updateDataSummary();

                // Set default date range
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                document.getElementById('startDate').valueAsDate = weekAgo;
                document.getElementById('endDate').valueAsDate = today;
            },

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.add('active');

                        // Update charts when switching tabs
                        if (e.target.dataset.tab === 'analytics') {
                            this.updateAnalytics();
                        }
                    });
                });

                // Date range selector
                document.getElementById('dateRange').addEventListener('change', (e) => {
                    const custom = document.getElementById('customDateRange');
                    const customEnd = document.getElementById('customDateRangeEnd');
                    if (e.target.value === 'custom') {
                        custom.style.display = 'block';
                        customEnd.style.display = 'block';
                    } else {
                        custom.style.display = 'none';
                        customEnd.style.display = 'none';
                    }
                });
            },

            loadData() {
                const saved = localStorage.getItem('analyticsEvents');
                if (saved) {
                    this.events = JSON.parse(saved);
                }
            },

            saveData() {
                localStorage.setItem('analyticsEvents', JSON.stringify(this.events));
            },

            trackEvent() {
                const name = document.getElementById('eventName').value.trim();
                const userId = document.getElementById('userId').value.trim() || `user_${Math.random().toString(36).substr(2, 9)}`;
                const propertiesText = document.getElementById('eventProperties').value.trim();

                if (!name) {
                    alert('Please enter an event name');
                    return;
                }

                let properties = {};
                if (propertiesText) {
                    try {
                        properties = JSON.parse(propertiesText);
                    } catch (e) {
                        alert('Invalid JSON in properties. Using empty properties.');
                    }
                }

                const event = {
                    id: Date.now() + Math.random(),
                    name,
                    userId,
                    properties,
                    timestamp: new Date().toISOString()
                };

                this.events.push(event);
                this.saveData();
                this.updateDashboard();
                this.updateEventsList();
                this.updateDataSummary();

                // Clear form
                document.getElementById('eventName').value = '';
                document.getElementById('eventProperties').value = '';

                alert('‚úÖ Event tracked successfully!');
            },

            updateDashboard() {
                const stats = this.calculateStats();

                document.getElementById('totalEvents').textContent = stats.totalEvents.toLocaleString();
                document.getElementById('uniqueUsers').textContent = stats.uniqueUsers.toLocaleString();
                document.getElementById('eventsToday').textContent = stats.eventsToday.toLocaleString();
                document.getElementById('avgEvents').textContent = stats.avgEventsPerUser.toFixed(1);

                this.renderTimelineChart();
                this.renderTopEventsChart();
                this.renderUserActivityChart();
            },

            calculateStats() {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                const eventsToday = this.events.filter(e => new Date(e.timestamp) >= today).length;
                const uniqueUsers = new Set(this.events.map(e => e.userId)).size;
                const avgEventsPerUser = uniqueUsers > 0 ? this.events.length / uniqueUsers : 0;

                return {
                    totalEvents: this.events.length,
                    uniqueUsers,
                    eventsToday,
                    avgEventsPerUser
                };
            },

            renderTimelineChart() {
                const canvas = document.getElementById('timelineChart');
                const ctx = canvas.getContext('2d');

                // Group events by day
                const eventsByDay = {};
                this.events.forEach(event => {
                    const date = new Date(event.timestamp).toLocaleDateString();
                    eventsByDay[date] = (eventsByDay[date] || 0) + 1;
                });

                const dates = Object.keys(eventsByDay).sort();
                const counts = dates.map(date => eventsByDay[date]);

                this.drawLineChart(ctx, canvas, dates, counts, '#667eea');
            },

            renderTopEventsChart() {
                const canvas = document.getElementById('topEventsChart');
                const ctx = canvas.getContext('2d');

                const eventCounts = {};
                this.events.forEach(event => {
                    eventCounts[event.name] = (eventCounts[event.name] || 0) + 1;
                });

                const sorted = Object.entries(eventCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const labels = sorted.map(([name]) => name);
                const values = sorted.map(([, count]) => count);

                this.drawBarChart(ctx, canvas, labels, values, '#764ba2');
            },

            renderUserActivityChart() {
                const canvas = document.getElementById('userActivityChart');
                const ctx = canvas.getContext('2d');

                const userActivity = {};
                this.events.forEach(event => {
                    userActivity[event.userId] = (userActivity[event.userId] || 0) + 1;
                });

                // Group users by activity level
                const levels = {
                    '1-5 events': 0,
                    '6-10 events': 0,
                    '11-20 events': 0,
                    '21-50 events': 0,
                    '50+ events': 0
                };

                Object.values(userActivity).forEach(count => {
                    if (count <= 5) levels['1-5 events']++;
                    else if (count <= 10) levels['6-10 events']++;
                    else if (count <= 20) levels['11-20 events']++;
                    else if (count <= 50) levels['21-50 events']++;
                    else levels['50+ events']++;
                });

                const labels = Object.keys(levels);
                const values = Object.values(levels);

                this.drawBarChart(ctx, canvas, labels, values, '#667eea');
            },

            drawLineChart(ctx, canvas, labels, data, color) {
                const width = canvas.width = canvas.offsetWidth * 2;
                const height = canvas.height = 600;
                ctx.clearRect(0, 0, width, height);

                if (data.length === 0) {
                    ctx.fillStyle = '#999';
                    ctx.font = '24px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data yet', width / 2, height / 2);
                    return;
                }

                const padding = 60;
                const chartWidth = width - padding * 2;
                const chartHeight = height - padding * 2;

                const max = Math.max(...data, 1);
                const step = chartWidth / (data.length - 1 || 1);

                // Draw grid
                ctx.strokeStyle = '#e9ecef';
                ctx.lineWidth = 2;
                for (let i = 0; i <= 5; i++) {
                    const y = padding + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();

                    // Y-axis labels
                    ctx.fillStyle = '#6c757d';
                    ctx.font = '20px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(Math.round(max * (1 - i / 5)), padding - 10, y + 7);
                }

                // Draw line
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.beginPath();
                data.forEach((value, i) => {
                    const x = padding + step * i;
                    const y = padding + chartHeight - (value / max) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Draw points
                ctx.fillStyle = color;
                data.forEach((value, i) => {
                    const x = padding + step * i;
                    const y = padding + chartHeight - (value / max) * chartHeight;
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, Math.PI * 2);
                    ctx.fill();
                });

                // X-axis labels
                ctx.fillStyle = '#6c757d';
                ctx.font = '18px sans-serif';
                ctx.textAlign = 'center';
                labels.forEach((label, i) => {
                    if (i % Math.ceil(labels.length / 7) === 0) {
                        const x = padding + step * i;
                        ctx.fillText(label, x, height - padding + 30);
                    }
                });
            },

            drawBarChart(ctx, canvas, labels, data, color) {
                const width = canvas.width = canvas.offsetWidth * 2;
                const height = canvas.height = 600;
                ctx.clearRect(0, 0, width, height);

                if (data.length === 0) {
                    ctx.fillStyle = '#999';
                    ctx.font = '24px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data yet', width / 2, height / 2);
                    return;
                }

                const padding = 60;
                const chartWidth = width - padding * 2;
                const chartHeight = height - padding * 2;

                const max = Math.max(...data, 1);
                const barWidth = chartWidth / data.length * 0.8;
                const gap = chartWidth / data.length * 0.2;

                // Draw bars
                data.forEach((value, i) => {
                    const barHeight = (value / max) * chartHeight;
                    const x = padding + (barWidth + gap) * i;
                    const y = padding + chartHeight - barHeight;

                    // Gradient fill
                    const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                    gradient.addColorStop(0, color);
                    gradient.addColorStop(1, color + '80');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, y, barWidth, barHeight);

                    // Value label
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 20px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(value, x + barWidth / 2, y - 10);

                    // X-axis label
                    ctx.fillStyle = '#6c757d';
                    ctx.font = '18px sans-serif';
                    ctx.save();
                    ctx.translate(x + barWidth / 2, height - padding + 20);
                    ctx.rotate(-Math.PI / 6);
                    ctx.fillText(labels[i], 0, 0);
                    ctx.restore();
                });
            },

            updateEventsList() {
                const container = document.getElementById('eventsList');
                const recent = [...this.events].reverse().slice(0, 50);

                if (recent.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No events tracked yet. Start tracking events to see them here.</p>';
                    return;
                }

                container.innerHTML = recent.map(event => `
                    <div class="event-item">
                        <div class="event-header">
                            <div class="event-name">${this.escapeHtml(event.name)}</div>
                            <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
                        </div>
                        <div style="color: #6c757d; margin-bottom: 8px;">User: ${this.escapeHtml(event.userId)}</div>
                        ${Object.keys(event.properties).length > 0 ? `
                            <div class="event-properties">${this.escapeHtml(JSON.stringify(event.properties, null, 2))}</div>
                        ` : ''}
                    </div>
                `).join('');
            },

            updateAnalytics() {
                const range = this.getDateRange();
                const filtered = this.events.filter(e => {
                    const date = new Date(e.timestamp);
                    return date >= range.start && date <= range.end;
                });

                this.renderTrendsChart(filtered);
                this.renderEventTypeChart(filtered);
                this.renderEngagementChart(filtered);
            },

            getDateRange() {
                const rangeType = document.getElementById('dateRange').value;
                const end = new Date();
                let start = new Date();

                switch (rangeType) {
                    case 'today':
                        start.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        start.setDate(start.getDate() - 7);
                        break;
                    case 'month':
                        start.setDate(start.getDate() - 30);
                        break;
                    case 'custom':
                        start = new Date(document.getElementById('startDate').value);
                        end.setTime(new Date(document.getElementById('endDate').value).getTime());
                        break;
                    case 'all':
                        start = new Date(0);
                        break;
                }

                return { start, end };
            },

            renderTrendsChart(events) {
                const canvas = document.getElementById('trendsChart');
                const ctx = canvas.getContext('2d');
                const groupBy = document.getElementById('groupBy').value;

                const grouped = {};
                events.forEach(event => {
                    const date = new Date(event.timestamp);
                    let key;
                    switch (groupBy) {
                        case 'hour':
                            key = date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric' });
                            break;
                        case 'day':
                            key = date.toLocaleDateString();
                            break;
                        case 'week':
                            const week = Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000));
                            key = `Week ${week}`;
                            break;
                        case 'month':
                            key = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                            break;
                    }
                    grouped[key] = (grouped[key] || 0) + 1;
                });

                const labels = Object.keys(grouped).sort();
                const data = labels.map(label => grouped[label]);

                this.drawLineChart(ctx, canvas, labels, data, '#667eea');
            },

            renderEventTypeChart(events) {
                const canvas = document.getElementById('eventTypeChart');
                const ctx = canvas.getContext('2d');

                const types = {};
                events.forEach(event => {
                    types[event.name] = (types[event.name] || 0) + 1;
                });

                const sorted = Object.entries(types).sort((a, b) => b[1] - a[1]).slice(0, 10);
                const labels = sorted.map(([name]) => name);
                const data = sorted.map(([, count]) => count);

                this.drawBarChart(ctx, canvas, labels, data, '#764ba2');
            },

            renderEngagementChart(events) {
                const canvas = document.getElementById('engagementChart');
                const ctx = canvas.getContext('2d');

                const userEvents = {};
                events.forEach(event => {
                    userEvents[event.userId] = (userEvents[event.userId] || 0) + 1;
                });

                const engagement = {
                    'Very Low (1)': 0,
                    'Low (2-5)': 0,
                    'Medium (6-10)': 0,
                    'High (11-20)': 0,
                    'Very High (20+)': 0
                };

                Object.values(userEvents).forEach(count => {
                    if (count === 1) engagement['Very Low (1)']++;
                    else if (count <= 5) engagement['Low (2-5)']++;
                    else if (count <= 10) engagement['Medium (6-10)']++;
                    else if (count <= 20) engagement['High (11-20)']++;
                    else engagement['Very High (20+)']++;
                });

                const labels = Object.keys(engagement);
                const data = Object.values(engagement);

                this.drawBarChart(ctx, canvas, labels, data, '#667eea');
            },

            addFunnelStep() {
                const container = document.getElementById('funnelSteps');
                const stepNum = container.children.length + 1;
                const div = document.createElement('div');
                div.className = 'funnel-step';
                div.innerHTML = `
                    <div class="funnel-step-number">${stepNum}</div>
                    <input type="text" placeholder="Event name for step ${stepNum}" class="funnel-step-input">
                `;
                container.appendChild(div);
            },

            analyzeFunnel() {
                const steps = Array.from(document.querySelectorAll('.funnel-step-input'))
                    .map(input => input.value.trim())
                    .filter(v => v);

                if (steps.length < 2) {
                    alert('Please define at least 2 funnel steps');
                    return;
                }

                // Group events by user
                const userJourneys = {};
                this.events.forEach(event => {
                    if (!userJourneys[event.userId]) {
                        userJourneys[event.userId] = [];
                    }
                    userJourneys[event.userId].push({
                        name: event.name,
                        timestamp: new Date(event.timestamp)
                    });
                });

                // Calculate funnel metrics
                const funnelData = steps.map((step, index) => {
                    let count = 0;
                    Object.values(userJourneys).forEach(journey => {
                        // Check if user completed all steps up to this point in order
                        let stepIndex = 0;
                        for (let event of journey.sort((a, b) => a.timestamp - b.timestamp)) {
                            if (event.name === steps[stepIndex]) {
                                stepIndex++;
                                if (stepIndex > index) {
                                    count++;
                                    break;
                                }
                            }
                        }
                    });
                    return { step, count };
                });

                const total = funnelData[0].count || 1;
                const resultsHtml = `
                    <div class="chart-container">
                        <div class="chart-title">Funnel Visualization</div>
                        <div class="funnel-visualization">
                            ${funnelData.map((data, i) => {
                                const percentage = (data.count / total * 100).toFixed(1);
                                const width = percentage;
                                const dropoff = i > 0 ? ((funnelData[i-1].count - data.count) / funnelData[i-1].count * 100).toFixed(1) : 0;
                                return `
                                    <div class="funnel-bar" style="width: ${width}%">
                                        <span>${data.step}</span>
                                        <span>${data.count} users (${percentage}%) ${i > 0 ? `[-${dropoff}%]` : ''}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                document.getElementById('funnelResults').innerHTML = resultsHtml;
            },

            analyzeCohorts() {
                const cohortEvent = document.getElementById('cohortEvent').value.trim();
                const returnEvent = document.getElementById('returnEvent').value.trim();
                const cohortSize = document.getElementById('cohortSize').value;

                if (!cohortEvent || !returnEvent) {
                    alert('Please specify both cohort and return events');
                    return;
                }

                // Build cohorts
                const cohorts = {};
                this.events.forEach(event => {
                    if (event.name === cohortEvent) {
                        const date = new Date(event.timestamp);
                        let cohortKey;
                        if (cohortSize === 'day') {
                            cohortKey = date.toLocaleDateString();
                        } else if (cohortSize === 'week') {
                            const week = Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000));
                            cohortKey = `Week ${week}`;
                        } else {
                            cohortKey = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                        }

                        if (!cohorts[cohortKey]) {
                            cohorts[cohortKey] = {
                                users: new Set(),
                                firstDate: date,
                                retention: {}
                            };
                        }
                        cohorts[cohortKey].users.add(event.userId);
                    }
                });

                // Calculate retention
                this.events.forEach(event => {
                    if (event.name === returnEvent) {
                        const eventDate = new Date(event.timestamp);
                        for (const [cohortKey, cohort] of Object.entries(cohorts)) {
                            if (cohort.users.has(event.userId)) {
                                const daysDiff = Math.floor((eventDate - cohort.firstDate) / (24 * 60 * 60 * 1000));
                                const period = Math.floor(daysDiff / (cohortSize === 'day' ? 1 : cohortSize === 'week' ? 7 : 30));
                                if (period >= 0) {
                                    if (!cohort.retention[period]) {
                                        cohort.retention[period] = new Set();
                                    }
                                    cohort.retention[period].add(event.userId);
                                }
                            }
                        }
                    }
                });

                // Generate table
                const cohortKeys = Object.keys(cohorts).sort();
                const maxPeriod = Math.max(...Object.values(cohorts).flatMap(c => Object.keys(c.retention).map(Number)));

                let tableHtml = `
                    <table class="cohort-table">
                        <thead>
                            <tr>
                                <th>Cohort</th>
                                <th>Size</th>
                                ${Array.from({ length: maxPeriod + 1 }, (_, i) => `<th>Period ${i}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                cohortKeys.forEach(key => {
                    const cohort = cohorts[key];
                    const size = cohort.users.size;
                    tableHtml += `<tr><td><strong>${key}</strong></td><td>${size}</td>`;
                    for (let i = 0; i <= maxPeriod; i++) {
                        const retained = cohort.retention[i] ? cohort.retention[i].size : 0;
                        const percentage = (retained / size * 100).toFixed(0);
                        tableHtml += `
                            <td class="retention-cell">
                                <div class="retention-bar" style="width: ${percentage}%"></div>
                                <span class="retention-value">${percentage}%</span>
                            </td>
                        `;
                    }
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';

                document.getElementById('cohortResults').innerHTML = `
                    <div class="chart-container" style="margin-top: 30px;">
                        <div class="chart-title">Cohort Retention Analysis</div>
                        ${tableHtml}
                    </div>
                `;
            },

            generateSampleData() {
                const count = parseInt(document.getElementById('sampleCount').value);
                const users = parseInt(document.getElementById('sampleUsers').value);

                const eventTypes = ['page_view', 'button_click', 'signup', 'login', 'purchase', 'add_to_cart', 'checkout', 'share', 'comment', 'like'];
                const pages = ['home', 'product', 'cart', 'checkout', 'profile', 'settings'];

                const userIds = Array.from({ length: users }, (_, i) => `user_${i + 1}`);

                for (let i = 0; i < count; i++) {
                    const userId = userIds[Math.floor(Math.random() * userIds.length)];
                    const eventName = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                    const timestamp = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString();

                    const properties = {
                        page: pages[Math.floor(Math.random() * pages.length)],
                        value: Math.floor(Math.random() * 100)
                    };

                    this.events.push({
                        id: Date.now() + Math.random(),
                        name: eventName,
                        userId,
                        properties,
                        timestamp
                    });
                }

                this.saveData();
                this.updateDashboard();
                this.updateEventsList();
                this.updateDataSummary();

                alert(`‚úÖ Generated ${count} sample events for ${users} users!`);
            },

            exportData() {
                const data = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    events: this.events
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics-export-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            exportCSV() {
                if (this.events.length === 0) {
                    alert('No events to export');
                    return;
                }

                let csv = 'Event Name,User ID,Timestamp,Properties\n';
                this.events.forEach(event => {
                    csv += `"${event.name}","${event.userId}","${event.timestamp}","${JSON.stringify(event.properties).replace(/"/g, '""')}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics-export-${Date.now()}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            importData() {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];

                if (!file) {
                    alert('Please select a file');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.events && Array.isArray(data.events)) {
                            this.events = data.events;
                            this.saveData();
                            this.updateDashboard();
                            this.updateEventsList();
                            this.updateDataSummary();
                            alert(`‚úÖ Imported ${data.events.length} events successfully!`);
                        } else {
                            alert('Invalid data format');
                        }
                    } catch (err) {
                        alert('Error parsing JSON: ' + err.message);
                    }
                };
                reader.readAsText(file);
            },

            clearData() {
                if (confirm('Are you sure you want to delete all analytics data? This cannot be undone.')) {
                    this.events = [];
                    this.saveData();
                    this.updateDashboard();
                    this.updateEventsList();
                    this.updateDataSummary();
                    alert('‚úÖ All data cleared');
                }
            },

            updateDataSummary() {
                const summary = {
                    totalEvents: this.events.length,
                    uniqueUsers: new Set(this.events.map(e => e.userId)).size,
                    eventTypes: [...new Set(this.events.map(e => e.name))],
                    dateRange: this.events.length > 0 ? {
                        earliest: new Date(Math.min(...this.events.map(e => new Date(e.timestamp)))).toISOString(),
                        latest: new Date(Math.max(...this.events.map(e => new Date(e.timestamp)))).toISOString()
                    } : null
                };

                document.getElementById('dataSummary').textContent = JSON.stringify(summary, null, 2);
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Initialize on load
        window.addEventListener('load', () => Analytics.init());
    </script>
</body>
</html>