<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Memory Vault - AI-Powered Second Brain</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-surface: #1a1a2e;
            --bg-hover: #252540;
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #06b6d4;
            --accent: #f472b6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2a2a4a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .logo {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .logo-text span {
            color: var(--primary);
        }

        .nav-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .nav-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .nav-btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        .nav-btn .icon {
            font-size: 1.2rem;
        }

        .nav-btn .badge {
            margin-left: auto;
            background: var(--bg-surface);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .nav-btn.active .badge {
            background: rgba(255,255,255,0.2);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 16px;
        }

        .stat-card {
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .search-box {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Panels */
        .panel {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .panel.active {
            display: flex;
            flex-direction: column;
        }

        /* AI Chat Panel */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            padding: 24px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .message.user .message-avatar {
            background: var(--secondary);
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--accent));
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .message-content {
            padding-left: 44px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .message.ai .message-content {
            background: var(--bg-surface);
            border-radius: 12px;
            padding: 16px;
            margin-left: 44px;
        }

        .sources {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .sources-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .source-chip {
            display: inline-block;
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 6px;
            font-size: 0.75rem;
            margin-right: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-chip:hover {
            background: var(--primary);
            color: white;
        }

        .chat-input-container {
            padding: 20px 0;
            border-top: 1px solid var(--border);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-send-btn {
            padding: 12px 20px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .suggested-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .suggested-query {
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggested-query:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Memories Panel */
        .memories-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .memories-list {
            width: 350px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 16px;
        }

        .memory-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .memory-card:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .memory-card.selected {
            border-color: var(--primary);
            background: var(--bg-hover);
        }

        .memory-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .memory-type.note { background: rgba(139, 92, 246, 0.2); color: var(--primary); }
        .memory-type.email { background: rgba(6, 182, 212, 0.2); color: var(--secondary); }
        .memory-type.event { background: rgba(244, 114, 182, 0.2); color: var(--accent); }
        .memory-type.person { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .memory-type.document { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        .memory-title {
            font-weight: 600;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memory-preview {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .memory-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .memory-detail {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .memory-detail-header {
            margin-bottom: 24px;
        }

        .memory-detail-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .memory-detail-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .memory-detail-content {
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .entities-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .entities-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .entity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .entity-tag {
            padding: 6px 12px;
            background: var(--bg-surface);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .entity-tag:hover {
            background: var(--primary);
            color: white;
        }

        .entity-tag.person { border-left: 3px solid var(--success); }
        .entity-tag.place { border-left: 3px solid var(--secondary); }
        .entity-tag.date { border-left: 3px solid var(--warning); }
        .entity-tag.topic { border-left: 3px solid var(--primary); }

        /* Knowledge Graph Panel */
        .graph-container {
            flex: 1;
            position: relative;
        }

        #graphCanvas {
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
        }

        .graph-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .graph-control-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .graph-control-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .graph-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .legend-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.person { background: var(--success); }
        .legend-dot.place { background: var(--secondary); }
        .legend-dot.event { background: var(--accent); }
        .legend-dot.topic { background: var(--primary); }
        .legend-dot.document { background: var(--warning); }

        /* Timeline Panel */
        .timeline-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .timeline-filters {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 14px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-group {
            margin-bottom: 32px;
        }

        .timeline-date {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            position: relative;
        }

        .timeline-date::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
        }

        .timeline-item {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            margin-left: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 20px;
            width: 8px;
            height: 8px;
            background: var(--bg-surface);
            border: 2px solid var(--border);
            border-radius: 50%;
        }

        .timeline-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        /* Add Memory Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--bg-surface);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea.input-field {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.6;
        }

        .type-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .type-option {
            padding: 10px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .type-option:hover {
            border-color: var(--primary);
        }

        .type-option.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Insights Panel */
        .insights-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .insight-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .insight-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 16px;
        }

        .insight-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .insight-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .insight-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .on-this-day {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(244, 114, 182, 0.1));
            border: 1px solid var(--primary);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.info { border-left: 4px solid var(--primary); }

        /* Responsive */
        @media (max-width: 1024px) {
            .memories-list {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .memories-container {
                flex-direction: column;
            }

            .memories-list {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 40vh;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-description {
            color: var(--text-muted);
            margin-bottom: 24px;
            max-width: 400px;
        }

        /* Data Controls */
        .data-controls {
            padding: 16px;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        .data-btn {
            width: 100%;
            padding: 10px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .data-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">üß†</div>
                <div class="logo-text">Memory<span>Vault</span></div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Navigate</div>
                <button class="nav-btn active" data-panel="chat" onclick="showPanel('chat')">
                    <span class="icon">üí¨</span>
                    Ask Your Memory
                </button>
                <button class="nav-btn" data-panel="memories" onclick="showPanel('memories')">
                    <span class="icon">üìù</span>
                    All Memories
                    <span class="badge" id="memoryCount">0</span>
                </button>
                <button class="nav-btn" data-panel="graph" onclick="showPanel('graph')">
                    <span class="icon">üï∏Ô∏è</span>
                    Knowledge Graph
                </button>
                <button class="nav-btn" data-panel="timeline" onclick="showPanel('timeline')">
                    <span class="icon">üìÖ</span>
                    Timeline
                </button>
                <button class="nav-btn" data-panel="insights" onclick="showPanel('insights')">
                    <span class="icon">‚ú®</span>
                    Insights
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statMemories">0</div>
                    <div class="stat-label">Memories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPeople">0</div>
                    <div class="stat-label">People</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTopics">0</div>
                    <div class="stat-label">Topics</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statDays">0</div>
                    <div class="stat-label">Days Tracked</div>
                </div>
            </div>

            <div class="data-controls">
                <button class="data-btn" onclick="exportData()">üì§ Export Data</button>
                <button class="data-btn" onclick="document.getElementById('importFile').click()">üì• Import Data</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <button class="btn btn-secondary" onclick="toggleSidebar()" style="display:none" id="menuBtn">‚ò∞</button>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="globalSearch" placeholder="Search your memories..." onkeyup="handleGlobalSearch(event)">
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <span>‚ûï</span> Add Memory
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- AI Chat Panel -->
                <div class="panel active" id="panel-chat">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message ai">
                                <div class="message-header">
                                    <div class="message-avatar">üß†</div>
                                    <span class="message-sender">Memory Vault AI</span>
                                    <span class="message-time">Now</span>
                                </div>
                                <div class="message-content">
                                    Hello! I'm your personal memory assistant. I can help you recall information from your memories, find connections between people and events, and surface insights from your life.
                                    <br><br>
                                    Try asking me things like:
                                    <ul style="margin-top: 8px; padding-left: 20px;">
                                        <li>When did I last talk to [person]?</li>
                                        <li>What were my goals last month?</li>
                                        <li>Summarize everything about [topic]</li>
                                        <li>What promises have I made?</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <div class="chat-input-wrapper">
                                <textarea class="chat-input" id="chatInput" placeholder="Ask about your memories..." rows="1" onkeydown="handleChatKey(event)"></textarea>
                                <button class="chat-send-btn" onclick="sendChat()">‚Üí</button>
                            </div>
                            <div class="suggested-queries">
                                <span class="suggested-query" onclick="askQuery(this)">What did I do last week?</span>
                                <span class="suggested-query" onclick="askQuery(this)">Who have I mentioned most?</span>
                                <span class="suggested-query" onclick="askQuery(this)">Show my recent promises</span>
                                <span class="suggested-query" onclick="askQuery(this)">What topics interest me?</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memories Panel -->
                <div class="panel" id="panel-memories">
                    <div class="memories-container">
                        <div class="memories-list" id="memoriesList"></div>
                        <div class="memory-detail" id="memoryDetail">
                            <div class="empty-state">
                                <div class="empty-icon">üìù</div>
                                <div class="empty-title">Select a Memory</div>
                                <div class="empty-description">Click on a memory from the list to view its details and extracted entities.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Graph Panel -->
                <div class="panel" id="panel-graph">
                    <div class="graph-container">
                        <canvas id="graphCanvas"></canvas>
                        <div class="graph-controls">
                            <button class="graph-control-btn" onclick="zoomGraph(1.2)" title="Zoom In">+</button>
                            <button class="graph-control-btn" onclick="zoomGraph(0.8)" title="Zoom Out">‚àí</button>
                            <button class="graph-control-btn" onclick="resetGraph()" title="Reset">‚ü≤</button>
                        </div>
                        <div class="graph-legend">
                            <div class="legend-title">Node Types</div>
                            <div class="legend-item"><div class="legend-dot person"></div> People</div>
                            <div class="legend-item"><div class="legend-dot place"></div> Places</div>
                            <div class="legend-item"><div class="legend-dot event"></div> Events</div>
                            <div class="legend-item"><div class="legend-dot topic"></div> Topics</div>
                            <div class="legend-item"><div class="legend-dot document"></div> Documents</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Panel -->
                <div class="panel" id="panel-timeline">
                    <div class="timeline-container">
                        <div class="timeline-header">
                            <h2>Memory Timeline</h2>
                            <div class="timeline-filters">
                                <button class="filter-btn active" data-filter="all">All</button>
                                <button class="filter-btn" data-filter="note">Notes</button>
                                <button class="filter-btn" data-filter="event">Events</button>
                                <button class="filter-btn" data-filter="person">People</button>
                            </div>
                        </div>
                        <div class="timeline" id="timelineContent"></div>
                    </div>
                </div>

                <!-- Insights Panel -->
                <div class="panel" id="panel-insights">
                    <div class="insights-container">
                        <div class="insights-grid" id="insightsGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Memory Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Memory</h3>
                <button class="modal-close" onclick="closeAddModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Memory Type</label>
                    <div class="type-selector">
                        <div class="type-option selected" data-type="note" onclick="selectType(this)">üìù Note</div>
                        <div class="type-option" data-type="email" onclick="selectType(this)">‚úâÔ∏è Email</div>
                        <div class="type-option" data-type="event" onclick="selectType(this)">üìÖ Event</div>
                        <div class="type-option" data-type="person" onclick="selectType(this)">üë§ Person</div>
                        <div class="type-option" data-type="document" onclick="selectType(this)">üìÑ Document</div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">Title</label>
                    <input type="text" class="input-field" id="memoryTitle" placeholder="Give this memory a title...">
                </div>
                <div class="input-group">
                    <label class="input-label">Content</label>
                    <textarea class="input-field" id="memoryContent" placeholder="Write or paste your content here... Include names, dates, places, and topics for automatic extraction."></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">Date (optional)</label>
                    <input type="date" class="input-field" id="memoryDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveMemory()">Save Memory</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastIcon">‚úì</span>
        <span id="toastText">Success</span>
    </div>

    <script>
        // ============================================
        // PERSONAL MEMORY VAULT - Core Engine
        // ============================================

        const APP_NAME = 'personal-memory-vault';

        // App State
        let appData = {
            memories: [],
            entities: {
                people: [],
                places: [],
                topics: [],
                events: []
            },
            relationships: [],
            settings: {}
        };

        let selectedMemoryId = null;
        let currentPanel = 'chat';
        let graphNodes = [];
        let graphEdges = [];
        let graphZoom = 1;
        let graphOffset = { x: 0, y: 0 };

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            loadData();
            updateStats();
            renderMemoriesList();
            renderTimeline();
            renderInsights();
            initGraph();

            // Auto-resize chat input
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });

            // Check for mobile
            if (window.innerWidth <= 768) {
                document.getElementById('menuBtn').style.display = 'block';
            }

            window.addEventListener('resize', () => {
                document.getElementById('menuBtn').style.display = window.innerWidth <= 768 ? 'block' : 'none';
                initGraph();
            });
        }

        // ============================================
        // DATA MANAGEMENT
        // ============================================

        function loadData() {
            const saved = localStorage.getItem(APP_NAME);
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load data');
                }
            }
        }

        function saveData() {
            localStorage.setItem(APP_NAME, JSON.stringify(appData));
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `memory-vault-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('Data exported successfully', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    appData = JSON.parse(e.target.result);
                    saveData();
                    updateStats();
                    renderMemoriesList();
                    renderTimeline();
                    renderInsights();
                    initGraph();
                    showToast('Data imported successfully', 'success');
                } catch (error) {
                    showToast('Invalid JSON file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ============================================
        // ENTITY EXTRACTION ENGINE
        // ============================================

        function extractEntities(text) {
            const entities = {
                people: [],
                places: [],
                dates: [],
                topics: [],
                promises: [],
                actions: []
            };

            // Extract potential names (capitalized words)
            const namePattern = /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/g;
            const commonWords = new Set(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday',
                'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December',
                'The', 'This', 'That', 'What', 'When', 'Where', 'Why', 'How', 'Today', 'Tomorrow', 'Yesterday']);

            let match;
            while ((match = namePattern.exec(text)) !== null) {
                const name = match[1];
                if (!commonWords.has(name) && name.length > 2) {
                    entities.people.push(name);
                }
            }

            // Extract dates
            const datePatterns = [
                /\b(\d{1,2}\/\d{1,2}\/\d{2,4})\b/g,
                /\b(\d{4}-\d{2}-\d{2})\b/g,
                /\b((?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2}(?:st|nd|rd|th)?(?:,?\s*\d{4})?)\b/gi,
                /\b(today|tomorrow|yesterday|last week|next week|last month|next month)\b/gi
            ];

            datePatterns.forEach(pattern => {
                while ((match = pattern.exec(text)) !== null) {
                    entities.dates.push(match[1]);
                }
            });

            // Extract places (basic heuristics)
            const placeIndicators = /(?:in|at|to|from|near|visiting|went to|arrived at|left)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/g;
            while ((match = placeIndicators.exec(text)) !== null) {
                entities.places.push(match[1]);
            }

            // Extract topics/themes using keyword extraction
            const words = text.toLowerCase().split(/\W+/);
            const wordFreq = {};
            const stopWords = new Set(['the', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'shall', 'can', 'need', 'dare', 'ought', 'used', 'to', 'of', 'in', 'for', 'on', 'with', 'at', 'by', 'from', 'as', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'between', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 'just', 'and', 'but', 'if', 'or', 'because', 'until', 'while', 'this', 'that', 'these', 'those', 'what', 'which', 'who', 'whom', 'i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', 'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves']);

            words.forEach(word => {
                if (word.length > 4 && !stopWords.has(word)) {
                    wordFreq[word] = (wordFreq[word] || 0) + 1;
                }
            });

            entities.topics = Object.entries(wordFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([word]) => word);

            // Extract promises/commitments
            const promisePatterns = [
                /I (?:will|'ll|promise to|need to|have to|should|must)\s+([^.!?]+)/gi,
                /(?:going to|gonna)\s+([^.!?]+)/gi,
                /remind me to\s+([^.!?]+)/gi
            ];

            promisePatterns.forEach(pattern => {
                while ((match = pattern.exec(text)) !== null) {
                    entities.promises.push(match[1].trim());
                }
            });

            // Deduplicate
            Object.keys(entities).forEach(key => {
                entities[key] = [...new Set(entities[key])];
            });

            return entities;
        }

        // ============================================
        // MEMORY MANAGEMENT
        // ============================================

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.getElementById('memoryDate').value = new Date().toISOString().split('T')[0];
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('memoryTitle').value = '';
            document.getElementById('memoryContent').value = '';
        }

        function selectType(element) {
            document.querySelectorAll('.type-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function saveMemory() {
            const title = document.getElementById('memoryTitle').value.trim();
            const content = document.getElementById('memoryContent').value.trim();
            const date = document.getElementById('memoryDate').value;
            const type = document.querySelector('.type-option.selected')?.dataset.type || 'note';

            if (!content) {
                showToast('Please enter some content', 'error');
                return;
            }

            const entities = extractEntities(content);

            const memory = {
                id: Date.now().toString(),
                title: title || content.substring(0, 50) + '...',
                content,
                type,
                date: date || new Date().toISOString().split('T')[0],
                created: new Date().toISOString(),
                entities
            };

            appData.memories.unshift(memory);

            // Update global entities
            entities.people.forEach(p => {
                if (!appData.entities.people.includes(p)) {
                    appData.entities.people.push(p);
                }
            });
            entities.places.forEach(p => {
                if (!appData.entities.places.includes(p)) {
                    appData.entities.places.push(p);
                }
            });
            entities.topics.forEach(t => {
                if (!appData.entities.topics.includes(t)) {
                    appData.entities.topics.push(t);
                }
            });

            saveData();
            updateStats();
            renderMemoriesList();
            renderTimeline();
            renderInsights();
            initGraph();
            closeAddModal();
            showToast('Memory saved!', 'success');
        }

        function renderMemoriesList(filter = '') {
            const container = document.getElementById('memoriesList');
            let memories = appData.memories;

            if (filter) {
                const lowerFilter = filter.toLowerCase();
                memories = memories.filter(m =>
                    m.title.toLowerCase().includes(lowerFilter) ||
                    m.content.toLowerCase().includes(lowerFilter) ||
                    m.entities.people.some(p => p.toLowerCase().includes(lowerFilter)) ||
                    m.entities.topics.some(t => t.toLowerCase().includes(lowerFilter))
                );
            }

            if (memories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-title">No Memories Yet</div>
                        <div class="empty-description">Start adding memories to build your personal knowledge base.</div>
                        <button class="btn btn-primary" onclick="openAddModal()">Add First Memory</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = memories.map(m => `
                <div class="memory-card ${m.id === selectedMemoryId ? 'selected' : ''}" onclick="viewMemory('${m.id}')">
                    <span class="memory-type ${m.type}">${m.type}</span>
                    <div class="memory-title">${escapeHtml(m.title)}</div>
                    <div class="memory-preview">${escapeHtml(m.content.substring(0, 100))}</div>
                    <div class="memory-meta">
                        <span>üìÖ ${formatDate(m.date)}</span>
                        <span>üè∑Ô∏è ${m.entities.people.length + m.entities.topics.length} entities</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('memoryCount').textContent = appData.memories.length;
        }

        function viewMemory(id) {
            selectedMemoryId = id;
            const memory = appData.memories.find(m => m.id === id);
            if (!memory) return;

            renderMemoriesList();

            const detail = document.getElementById('memoryDetail');
            detail.innerHTML = `
                <div class="memory-detail-header">
                    <span class="memory-type ${memory.type}">${memory.type}</span>
                    <h2 class="memory-detail-title">${escapeHtml(memory.title)}</h2>
                    <div class="memory-detail-meta">
                        <span class="meta-item">üìÖ ${formatDate(memory.date)}</span>
                        <span class="meta-item">üïê Created ${formatDate(memory.created)}</span>
                    </div>
                </div>
                <div class="memory-detail-content">${escapeHtml(memory.content).replace(/\n/g, '<br>')}</div>

                ${memory.entities.people.length > 0 ? `
                    <div class="entities-section">
                        <div class="entities-title">üë§ People Mentioned</div>
                        <div class="entity-tags">
                            ${memory.entities.people.map(p => `<span class="entity-tag person" onclick="searchEntity('${p}')">${p}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}

                ${memory.entities.places.length > 0 ? `
                    <div class="entities-section">
                        <div class="entities-title">üìç Places</div>
                        <div class="entity-tags">
                            ${memory.entities.places.map(p => `<span class="entity-tag place" onclick="searchEntity('${p}')">${p}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}

                ${memory.entities.topics.length > 0 ? `
                    <div class="entities-section">
                        <div class="entities-title">üè∑Ô∏è Topics</div>
                        <div class="entity-tags">
                            ${memory.entities.topics.map(t => `<span class="entity-tag topic" onclick="searchEntity('${t}')">${t}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}

                ${memory.entities.promises && memory.entities.promises.length > 0 ? `
                    <div class="entities-section">
                        <div class="entities-title">‚úÖ Commitments/Promises</div>
                        <div class="entity-tags">
                            ${memory.entities.promises.map(p => `<span class="entity-tag" style="border-left: 3px solid var(--warning);">${p}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}

                <div class="entities-section">
                    <button class="btn btn-secondary" onclick="deleteMemory('${memory.id}')" style="background: var(--error);">üóëÔ∏è Delete Memory</button>
                </div>
            `;
        }

        function deleteMemory(id) {
            if (!confirm('Are you sure you want to delete this memory?')) return;

            appData.memories = appData.memories.filter(m => m.id !== id);
            selectedMemoryId = null;
            saveData();
            updateStats();
            renderMemoriesList();
            renderTimeline();
            initGraph();

            document.getElementById('memoryDetail').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-title">Select a Memory</div>
                    <div class="empty-description">Click on a memory from the list to view its details.</div>
                </div>
            `;

            showToast('Memory deleted', 'info');
        }

        function searchEntity(entity) {
            document.getElementById('globalSearch').value = entity;
            renderMemoriesList(entity);
            showPanel('memories');
        }

        // ============================================
        // AI CHAT ENGINE
        // ============================================

        function handleChatKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChat();
            }
        }

        function askQuery(element) {
            document.getElementById('chatInput').value = element.textContent;
            sendChat();
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            const query = input.value.trim();
            if (!query) return;

            // Add user message
            addChatMessage(query, 'user');
            input.value = '';
            input.style.height = 'auto';

            // Process query
            setTimeout(() => {
                const response = processQuery(query);
                addChatMessage(response.text, 'ai', response.sources);
            }, 500);
        }

        function addChatMessage(text, type, sources = []) {
            const container = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let sourcesHtml = '';
            if (sources.length > 0) {
                sourcesHtml = `
                    <div class="sources">
                        <div class="sources-title">üìé Sources (${sources.length})</div>
                        ${sources.map(s => `<span class="source-chip" onclick="viewMemory('${s.id}')">${escapeHtml(s.title.substring(0, 30))}</span>`).join('')}
                    </div>
                `;
            }

            container.innerHTML += `
                <div class="message ${type}">
                    <div class="message-header">
                        <div class="message-avatar">${type === 'user' ? 'üë§' : 'üß†'}</div>
                        <span class="message-sender">${type === 'user' ? 'You' : 'Memory Vault AI'}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">
                        ${text.replace(/\n/g, '<br>')}
                        ${sourcesHtml}
                    </div>
                </div>
            `;

            container.scrollTop = container.scrollHeight;
        }

        function processQuery(query) {
            const lowerQuery = query.toLowerCase();
            let relevantMemories = [];
            let responseText = '';

            // Find relevant memories using semantic matching
            relevantMemories = appData.memories.filter(m => {
                const content = (m.title + ' ' + m.content).toLowerCase();
                const queryWords = lowerQuery.split(/\s+/).filter(w => w.length > 2);
                return queryWords.some(word => content.includes(word)) ||
                       m.entities.people.some(p => lowerQuery.includes(p.toLowerCase())) ||
                       m.entities.topics.some(t => lowerQuery.includes(t));
            }).slice(0, 10);

            // Query type detection and response generation
            if (lowerQuery.includes('who') || lowerQuery.includes('people') || lowerQuery.includes('person')) {
                const people = [...new Set(appData.memories.flatMap(m => m.entities.people))];
                if (people.length > 0) {
                    const peopleCounts = {};
                    appData.memories.forEach(m => {
                        m.entities.people.forEach(p => {
                            peopleCounts[p] = (peopleCounts[p] || 0) + 1;
                        });
                    });
                    const sorted = Object.entries(peopleCounts).sort((a, b) => b[1] - a[1]);
                    responseText = `Based on your memories, you've mentioned these people most often:\n\n`;
                    sorted.slice(0, 10).forEach(([name, count], i) => {
                        responseText += `${i + 1}. **${name}** - mentioned ${count} time(s)\n`;
                    });
                } else {
                    responseText = "I don't see any people mentioned in your memories yet. Try adding some notes about conversations or interactions!";
                }
            }
            else if (lowerQuery.includes('promise') || lowerQuery.includes('commitment') || lowerQuery.includes('todo') || lowerQuery.includes('to do')) {
                const allPromises = appData.memories.flatMap(m =>
                    (m.entities.promises || []).map(p => ({ promise: p, date: m.date, memoryId: m.id }))
                );
                if (allPromises.length > 0) {
                    responseText = `I found ${allPromises.length} commitment(s)/promise(s) in your memories:\n\n`;
                    allPromises.slice(0, 10).forEach((p, i) => {
                        responseText += `${i + 1}. "${p.promise}" (from ${formatDate(p.date)})\n`;
                    });
                    relevantMemories = appData.memories.filter(m =>
                        allPromises.some(p => p.memoryId === m.id)
                    );
                } else {
                    responseText = "I haven't found any explicit promises or commitments in your memories. When you add notes, try including phrases like 'I will...' or 'I need to...'";
                }
            }
            else if (lowerQuery.includes('last week') || lowerQuery.includes('recent')) {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const recentMemories = appData.memories.filter(m => new Date(m.date) >= weekAgo);

                if (recentMemories.length > 0) {
                    responseText = `Here's a summary of your last week (${recentMemories.length} memories):\n\n`;
                    const topics = [...new Set(recentMemories.flatMap(m => m.entities.topics))].slice(0, 5);
                    const people = [...new Set(recentMemories.flatMap(m => m.entities.people))].slice(0, 5);

                    if (topics.length > 0) responseText += `**Topics:** ${topics.join(', ')}\n`;
                    if (people.length > 0) responseText += `**People involved:** ${people.join(', ')}\n\n`;

                    recentMemories.slice(0, 5).forEach(m => {
                        responseText += `‚Ä¢ ${m.title} (${formatDate(m.date)})\n`;
                    });
                    relevantMemories = recentMemories;
                } else {
                    responseText = "I don't have any memories from the last week. Add some notes about what you've been up to!";
                }
            }
            else if (lowerQuery.includes('topic') || lowerQuery.includes('interest') || lowerQuery.includes('about')) {
                const topicCounts = {};
                appData.memories.forEach(m => {
                    m.entities.topics.forEach(t => {
                        topicCounts[t] = (topicCounts[t] || 0) + 1;
                    });
                });
                const sorted = Object.entries(topicCounts).sort((a, b) => b[1] - a[1]);

                if (sorted.length > 0) {
                    responseText = `Based on your memories, your main interests/topics are:\n\n`;
                    sorted.slice(0, 10).forEach(([topic, count], i) => {
                        responseText += `${i + 1}. **${topic}** - appears ${count} time(s)\n`;
                    });
                } else {
                    responseText = "I haven't extracted any topics yet. Add more detailed memories for better topic detection!";
                }
            }
            else if (lowerQuery.includes('when did i') || lowerQuery.includes('last time')) {
                // Search for specific event/action
                if (relevantMemories.length > 0) {
                    const sorted = relevantMemories.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const most = sorted[0];
                    responseText = `The most recent relevant memory I found is from **${formatDate(most.date)}**:\n\n"${most.content.substring(0, 200)}${most.content.length > 200 ? '...' : ''}"`;
                } else {
                    responseText = "I couldn't find any memories matching that query. Try being more specific or check if you've added relevant notes.";
                }
            }
            else if (lowerQuery.includes('summarize') || lowerQuery.includes('summary')) {
                if (relevantMemories.length > 0) {
                    const allContent = relevantMemories.map(m => m.content).join(' ');
                    const allTopics = [...new Set(relevantMemories.flatMap(m => m.entities.topics))];
                    const allPeople = [...new Set(relevantMemories.flatMap(m => m.entities.people))];

                    responseText = `**Summary of ${relevantMemories.length} relevant memories:**\n\n`;
                    if (allTopics.length > 0) responseText += `**Key themes:** ${allTopics.slice(0, 5).join(', ')}\n`;
                    if (allPeople.length > 0) responseText += `**People involved:** ${allPeople.slice(0, 5).join(', ')}\n\n`;
                    responseText += `**Key points:**\n`;
                    relevantMemories.slice(0, 5).forEach(m => {
                        responseText += `‚Ä¢ ${m.title}\n`;
                    });
                } else {
                    responseText = "I need more context to summarize. What topic or time period would you like me to summarize?";
                }
            }
            else {
                // Default: semantic search
                if (relevantMemories.length > 0) {
                    responseText = `I found ${relevantMemories.length} memories related to your query:\n\n`;
                    relevantMemories.slice(0, 5).forEach((m, i) => {
                        responseText += `**${i + 1}. ${m.title}** (${formatDate(m.date)})\n`;
                        responseText += `${m.content.substring(0, 150)}${m.content.length > 150 ? '...' : ''}\n\n`;
                    });
                } else {
                    responseText = "I couldn't find any memories matching your query. Try different keywords or add more memories about this topic!";
                }
            }

            return {
                text: responseText,
                sources: relevantMemories.slice(0, 5)
            };
        }

        // ============================================
        // KNOWLEDGE GRAPH
        // ============================================

        function initGraph() {
            const canvas = document.getElementById('graphCanvas');
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            buildGraphData();
            renderGraph();
        }

        function buildGraphData() {
            graphNodes = [];
            graphEdges = [];

            const nodeMap = new Map();

            // Add document nodes
            appData.memories.forEach(m => {
                const id = `doc_${m.id}`;
                nodeMap.set(id, {
                    id,
                    label: m.title.substring(0, 20),
                    type: 'document',
                    x: Math.random() * 600 + 100,
                    y: Math.random() * 400 + 100,
                    vx: 0,
                    vy: 0
                });

                // Add entity nodes and edges
                m.entities.people.forEach(p => {
                    const personId = `person_${p}`;
                    if (!nodeMap.has(personId)) {
                        nodeMap.set(personId, {
                            id: personId,
                            label: p,
                            type: 'person',
                            x: Math.random() * 600 + 100,
                            y: Math.random() * 400 + 100,
                            vx: 0,
                            vy: 0
                        });
                    }
                    graphEdges.push({ source: id, target: personId });
                });

                m.entities.topics.forEach(t => {
                    const topicId = `topic_${t}`;
                    if (!nodeMap.has(topicId)) {
                        nodeMap.set(topicId, {
                            id: topicId,
                            label: t,
                            type: 'topic',
                            x: Math.random() * 600 + 100,
                            y: Math.random() * 400 + 100,
                            vx: 0,
                            vy: 0
                        });
                    }
                    graphEdges.push({ source: id, target: topicId });
                });
            });

            graphNodes = Array.from(nodeMap.values());
        }

        function renderGraph() {
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Simple force simulation
            for (let i = 0; i < 50; i++) {
                simulateForces();
            }

            ctx.clearRect(0, 0, width, height);

            ctx.save();
            ctx.translate(width / 2 + graphOffset.x, height / 2 + graphOffset.y);
            ctx.scale(graphZoom, graphZoom);
            ctx.translate(-width / 2, -height / 2);

            // Draw edges
            ctx.strokeStyle = 'rgba(139, 92, 246, 0.3)';
            ctx.lineWidth = 1;
            graphEdges.forEach(edge => {
                const source = graphNodes.find(n => n.id === edge.source);
                const target = graphNodes.find(n => n.id === edge.target);
                if (source && target) {
                    ctx.beginPath();
                    ctx.moveTo(source.x, source.y);
                    ctx.lineTo(target.x, target.y);
                    ctx.stroke();
                }
            });

            // Draw nodes
            const colors = {
                person: '#10b981',
                place: '#06b6d4',
                event: '#f472b6',
                topic: '#8b5cf6',
                document: '#f59e0b'
            };

            graphNodes.forEach(node => {
                const radius = node.type === 'document' ? 8 : 12;

                ctx.beginPath();
                ctx.arc(node.x, node.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = colors[node.type] || '#8b5cf6';
                ctx.fill();

                ctx.fillStyle = '#f1f5f9';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(node.label, node.x, node.y + radius + 12);
            });

            ctx.restore();
        }

        function simulateForces() {
            const k = 0.01; // Spring constant
            const repulsion = 5000;

            // Repulsion between all nodes
            graphNodes.forEach((node1, i) => {
                graphNodes.forEach((node2, j) => {
                    if (i >= j) return;
                    const dx = node2.x - node1.x;
                    const dy = node2.y - node1.y;
                    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                    const force = repulsion / (dist * dist);
                    const fx = (dx / dist) * force;
                    const fy = (dy / dist) * force;
                    node1.vx -= fx;
                    node1.vy -= fy;
                    node2.vx += fx;
                    node2.vy += fy;
                });
            });

            // Attraction along edges
            graphEdges.forEach(edge => {
                const source = graphNodes.find(n => n.id === edge.source);
                const target = graphNodes.find(n => n.id === edge.target);
                if (source && target) {
                    const dx = target.x - source.x;
                    const dy = target.y - source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                    const force = dist * k;
                    const fx = (dx / dist) * force;
                    const fy = (dy / dist) * force;
                    source.vx += fx;
                    source.vy += fy;
                    target.vx -= fx;
                    target.vy -= fy;
                }
            });

            // Apply velocities and damping
            const canvas = document.getElementById('graphCanvas');
            graphNodes.forEach(node => {
                node.vx *= 0.9;
                node.vy *= 0.9;
                node.x += node.vx;
                node.y += node.vy;

                // Keep in bounds
                node.x = Math.max(50, Math.min(canvas.width - 50, node.x));
                node.y = Math.max(50, Math.min(canvas.height - 50, node.y));
            });
        }

        function zoomGraph(factor) {
            graphZoom *= factor;
            graphZoom = Math.max(0.3, Math.min(3, graphZoom));
            renderGraph();
        }

        function resetGraph() {
            graphZoom = 1;
            graphOffset = { x: 0, y: 0 };
            initGraph();
        }

        // ============================================
        // TIMELINE
        // ============================================

        function renderTimeline(filter = 'all') {
            const container = document.getElementById('timelineContent');

            let memories = [...appData.memories];
            if (filter !== 'all') {
                memories = memories.filter(m => m.type === filter);
            }

            // Group by date
            const grouped = {};
            memories.forEach(m => {
                const date = m.date;
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(m);
            });

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            if (sortedDates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <div class="empty-title">No Timeline Events</div>
                        <div class="empty-description">Add memories with dates to see your timeline.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = sortedDates.map(date => `
                <div class="timeline-group">
                    <div class="timeline-date">${formatDate(date)}</div>
                    ${grouped[date].map(m => `
                        <div class="timeline-item" onclick="viewMemory('${m.id}'); showPanel('memories');">
                            <span class="memory-type ${m.type}">${m.type}</span>
                            <div class="memory-title">${escapeHtml(m.title)}</div>
                            <div class="memory-preview">${escapeHtml(m.content.substring(0, 80))}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            // Setup filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
                btn.onclick = () => renderTimeline(btn.dataset.filter);
            });
        }

        // ============================================
        // INSIGHTS
        // ============================================

        function renderInsights() {
            const container = document.getElementById('insightsGrid');

            // Calculate insights
            const totalMemories = appData.memories.length;
            const uniquePeople = new Set(appData.memories.flatMap(m => m.entities.people)).size;
            const uniqueTopics = new Set(appData.memories.flatMap(m => m.entities.topics)).size;

            const dates = appData.memories.map(m => m.date).filter(d => d);
            const uniqueDays = new Set(dates).size;

            // On this day
            const today = new Date();
            const todayStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const onThisDay = appData.memories.filter(m => {
                if (!m.date) return false;
                const mDate = m.date.substring(5);
                return mDate === todayStr;
            });

            // Most mentioned person
            const personCounts = {};
            appData.memories.forEach(m => {
                m.entities.people.forEach(p => {
                    personCounts[p] = (personCounts[p] || 0) + 1;
                });
            });
            const topPerson = Object.entries(personCounts).sort((a, b) => b[1] - a[1])[0];

            // Recent activity
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentCount = appData.memories.filter(m => new Date(m.created) >= weekAgo).length;

            // Promises
            const openPromises = appData.memories.flatMap(m => m.entities.promises || []).length;

            container.innerHTML = `
                <div class="insight-card">
                    <div class="insight-icon">üìä</div>
                    <div class="insight-title">Total Memories</div>
                    <div class="insight-value">${totalMemories}</div>
                    <div class="insight-description">Your complete knowledge base</div>
                </div>

                <div class="insight-card">
                    <div class="insight-icon">üë•</div>
                    <div class="insight-title">People Network</div>
                    <div class="insight-value">${uniquePeople}</div>
                    <div class="insight-description">Unique people in your memories${topPerson ? `. Most mentioned: ${topPerson[0]}` : ''}</div>
                </div>

                <div class="insight-card">
                    <div class="insight-icon">üè∑Ô∏è</div>
                    <div class="insight-title">Topics Tracked</div>
                    <div class="insight-value">${uniqueTopics}</div>
                    <div class="insight-description">Different subjects you've written about</div>
                </div>

                <div class="insight-card">
                    <div class="insight-icon">üìÖ</div>
                    <div class="insight-title">Days Documented</div>
                    <div class="insight-value">${uniqueDays}</div>
                    <div class="insight-description">Days with at least one memory</div>
                </div>

                <div class="insight-card">
                    <div class="insight-icon">‚ö°</div>
                    <div class="insight-title">This Week</div>
                    <div class="insight-value">${recentCount}</div>
                    <div class="insight-description">Memories added in the last 7 days</div>
                </div>

                <div class="insight-card">
                    <div class="insight-icon">‚úÖ</div>
                    <div class="insight-title">Open Commitments</div>
                    <div class="insight-value">${openPromises}</div>
                    <div class="insight-description">Promises and to-dos detected in your notes</div>
                </div>

                ${onThisDay.length > 0 ? `
                    <div class="insight-card on-this-day" style="grid-column: span 2;">
                        <div class="insight-icon">üéâ</div>
                        <div class="insight-title">On This Day</div>
                        <div class="insight-value">${onThisDay.length} memor${onThisDay.length === 1 ? 'y' : 'ies'}</div>
                        <div class="insight-description">
                            ${onThisDay.map(m => `‚Ä¢ ${m.title} (${m.date.substring(0, 4)})`).join('<br>')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // ============================================
        // UI HELPERS
        // ============================================

        function showPanel(panelId) {
            currentPanel = panelId;
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(`panel-${panelId}`).classList.add('active');
            document.querySelector(`[data-panel="${panelId}"]`).classList.add('active');

            if (panelId === 'graph') {
                setTimeout(initGraph, 100);
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function handleGlobalSearch(event) {
            if (event.key === 'Enter') {
                const query = event.target.value;
                renderMemoriesList(query);
                showPanel('memories');
            }
        }

        function updateStats() {
            document.getElementById('statMemories').textContent = appData.memories.length;
            document.getElementById('statPeople').textContent = new Set(appData.memories.flatMap(m => m.entities.people)).size;
            document.getElementById('statTopics').textContent = new Set(appData.memories.flatMap(m => m.entities.topics)).size;
            document.getElementById('statDays').textContent = new Set(appData.memories.map(m => m.date).filter(d => d)).size;
            document.getElementById('memoryCount').textContent = appData.memories.length;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const text = document.getElementById('toastText');

            toast.className = `toast ${type}`;
            icon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
            text.textContent = message;

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        init();
    </script>
</body>
</html>
