<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Local First Tools Gallery - Intelligent Discovery Edition</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="theme-color" content="#1a1a2e" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- Apple Web App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LocalFirst">

    <!-- Standard favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- Description -->
    <meta name="description" content="Privacy-first, offline-capable tools that work entirely in your browser. No servers, no tracking.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #06ffa5;
            --accent-secondary: #ff006e;
            --accent-tertiary: #8338ec;
            --border: rgba(255, 255, 255, 0.1);

            /* Category colors */
            --cat-visual-art: #ff6b9d;
            --cat-3d: #4ecdc4;
            --cat-audio: #f7b731;
            --cat-games: #5f27cd;
            --cat-ai: #00d2d3;
            --cat-creative: #ff9ff3;
            --cat-generative: #54a0ff;
            --cat-physics: #48dbfb;
            --cat-educational: #feca57;
        }

        /* Light theme */
        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #000000;
            --text-secondary: #606060;
            --accent: #00a870;
            --accent-secondary: #e6005c;
            --accent-tertiary: #6b2dc7;
            --border: rgba(0, 0, 0, 0.1);
        }

        /* High contrast theme */
        body.high-contrast {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --accent: #00ff00;
            --accent-secondary: #ff0080;
            --accent-tertiary: #ffff00;
            --border: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 30, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 30, 120, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 10%, rgba(30, 255, 120, 0.3) 0%, transparent 50%);
            animation: drift 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes drift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            33% { transform: scale(1.1) rotate(120deg); }
            66% { transform: scale(0.95) rotate(240deg); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 80px 20px 60px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 50px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.3) 100%);
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .header {
                padding: 40px 20px 30px;
            }
        }

        h1 {
            font-size: 4.5em;
            font-weight: 200;
            letter-spacing: 0.15em;
            margin-bottom: 25px;
            text-transform: uppercase;
            position: relative;
            display: inline-block;
            line-height: 1.2;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 3em;
                letter-spacing: 0.1em;
            }
        }

        h1::before {
            content: 'LOCAL FIRST TOOLS';
            position: absolute;
            left: 0;
            top: 0;
            background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff, #06ffa5);
            background-size: 400% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 8s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.3em;
            font-weight: 300;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            margin-bottom: 25px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .subtitle {
                font-size: 1.2em;
                letter-spacing: 0.3em;
            }
        }

        .description {
            max-width: 700px;
            margin: 25px auto;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.8;
            font-weight: 300;
            font-size: 1.05em;
        }

        /* Stats display */
        .stats {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8338ec, #06ffa5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .stat-item:hover::before {
            opacity: 1;
        }

        .stat-value {
            display: block;
            font-size: 2.5em;
            font-weight: 600;
            background: linear-gradient(135deg, #8338ec, #06ffa5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 300;
        }

        /* Advanced search */
        .search-container {
            margin-bottom: 40px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .search-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 20px 60px 20px 25px;
            font-size: 1.15em;
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            color: var(--text-primary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(131, 56, 236, 0.6);
            box-shadow: 0 0 0 4px rgba(131, 56, 236, 0.1), 0 8px 30px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .search-icon {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
            font-size: 1.3em;
        }

        /* Category Navigation */
        .category-nav {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .category-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: capitalize;
        }

        .category-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .category-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .category-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .category-btn.active .category-count {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 25px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 35px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.04);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .filter-group:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
        }

        .filter-select {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            font-weight: 400;
        }

        .filter-select:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(131, 56, 236, 0.4);
        }

        .filter-select:focus {
            outline: none;
            border-color: rgba(131, 56, 236, 0.6);
            box-shadow: 0 0 0 3px rgba(131, 56, 236, 0.1);
        }

        /* Active Filters Display */
        .active-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            min-height: 35px;
            align-items: center;
            justify-content: center;
        }

        .filter-chip {
            background: rgba(138, 43, 226, 0.2);
            border: 1px solid var(--accent-tertiary);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .filter-chip .remove {
            cursor: pointer;
            color: var(--accent-secondary);
            font-weight: bold;
        }

        .filter-chip .remove:hover {
            transform: scale(1.2);
        }

        /* Tag Cloud */
        .tag-cloud {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
        }

        .tag-cloud-title {
            color: var(--text-secondary);
            font-size: 1em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .tag-cloud-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .tag-item {
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
        }

        .tag-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .tag-item.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .tag-size-1 { font-size: 0.8em; opacity: 0.6; }
        .tag-size-2 { font-size: 0.9em; opacity: 0.7; }
        .tag-size-3 { font-size: 1em; opacity: 0.8; }
        .tag-size-4 { font-size: 1.1em; opacity: 0.9; }
        .tag-size-5 { font-size: 1.2em; opacity: 1; font-weight: 500; }

        /* Recommendations Section */
        .recommendations {
            margin-bottom: 40px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(6, 255, 165, 0.1));
            border-radius: 15px;
        }

        .recommendations-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-primary);
            letter-spacing: 0.05em;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Gallery modes */
        .gallery-modes {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .gallery-modes {
                gap: 15px;
            }
        }

        .mode-button {
            padding: 16px 32px;
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 1em;
            letter-spacing: 0.08em;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            font-weight: 600;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .mode-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(131, 56, 236, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .mode-button:hover::before {
            width: 300px;
            height: 300px;
        }

        @media (max-width: 768px) {
            .mode-button {
                padding: 14px 24px;
                font-size: 0.95em;
            }
        }

        .mode-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(131, 56, 236, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(131, 56, 236, 0.2);
        }

        .mode-button:active {
            transform: translateY(-1px) scale(0.98);
        }

        .mode-button.active {
            background: linear-gradient(135deg, rgba(131, 56, 236, 0.4), rgba(255, 0, 110, 0.3));
            border-color: rgba(131, 56, 236, 0.7);
            box-shadow: 0 8px 30px rgba(131, 56, 236, 0.4);
            color: #ffffff;
        }

        .mode-button.vr-mode {
            background: linear-gradient(135deg, rgba(131, 56, 236, 0.5), rgba(255, 0, 110, 0.4));
            border-color: rgba(131, 56, 236, 0.8);
        }

        .mode-button.vr-mode:hover {
            box-shadow: 0 12px 35px rgba(131, 56, 236, 0.5);
        }

        /* Sort controls */
        .sort-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.04);
            border: 1.5px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .sort-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(131, 56, 236, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .sort-btn:hover::before {
            left: 100%;
        }

        .sort-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(131, 56, 236, 0.4);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .sort-btn.active {
            background: linear-gradient(135deg, rgba(131, 56, 236, 0.3), rgba(131, 56, 236, 0.2));
            color: #ffffff;
            border-color: rgba(131, 56, 236, 0.6);
            box-shadow: 0 4px 15px rgba(131, 56, 236, 0.3);
        }

        /* Tools grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .tool-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-height: 320px;
        }

        .tool-card.pinned {
            border-color: var(--accent-secondary);
            background: rgba(255, 0, 110, 0.05);
        }

        .tool-card.featured {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(6, 255, 165, 0.05));
            border-color: var(--accent-tertiary);
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--accent-tertiary));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        @media (hover: hover) {
            .tool-card:hover {
                transform: translateY(-2px);
                border-color: var(--accent);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5),
                           0 0 60px rgba(138, 43, 226, 0.2);
                background: rgba(255, 255, 255, 0.05);
            }

            .tool-card:hover::before {
                transform: translateX(0);
            }
        }

        @media (hover: none) {
            .tool-card:active {
                transform: scale(0.98);
                background: rgba(255, 255, 255, 0.05);
            }
        }

        .pin-button {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .pin-button:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: scale(1.1);
        }

        .pin-button.pinned {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }

        /* Featured badge */
        .featured-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, var(--accent), var(--accent-tertiary));
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            color: white;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* Category badge */
        .category-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
        }

        .category-badge.visual_art { background: var(--cat-visual-art); color: white; }
        .category-badge.cat-3d_immersive { background: var(--cat-3d); color: white; }
        .category-badge.audio_music { background: var(--cat-audio); color: black; }
        .category-badge.games_puzzles { background: var(--cat-games); color: white; }
        .category-badge.experimental_ai { background: var(--cat-ai); color: black; }
        .category-badge.creative_tools { background: var(--cat-creative); color: black; }
        .category-badge.generative_art { background: var(--cat-generative); color: white; }
        .category-badge.particle_physics { background: var(--cat-physics); color: black; }
        .category-badge.educational_tools { background: var(--cat-educational); color: black; }

        .tool-preview {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(0, 255, 255, 0.1));
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            position: relative;
            overflow: hidden;
        }

        .tool-title {
            font-size: 1.3em;
            font-weight: 400;
            margin-bottom: 8px;
            letter-spacing: 0.02em;
            line-height: 1.3;
        }

        .tool-filename {
            color: var(--text-secondary);
            font-size: 0.85em;
            font-family: 'Monaco', 'Menlo', monospace;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        .tool-description {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            margin-bottom: 15px;
            flex-grow: 1;
            font-weight: 300;
            font-size: 0.95em;
        }

        .tool-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .tool-tag {
            padding: 3px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
        }

        .complexity-indicator {
            display: flex;
            gap: 3px;
            margin-bottom: 10px;
        }

        .complexity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .complexity-dot.filled {
            background: var(--accent);
        }

        .tool-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.5);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .vote-count {
            color: var(--accent);
        }

        .tool-actions {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }

        .view-button, .vote-button, .download-button, .preview-button {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 400;
            letter-spacing: 0.03em;
            transition: all 0.3s ease;
            text-transform: uppercase;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }

        .view-button {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));
            color: white;
        }

        .view-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.5);
        }

        .preview-button {
            background: transparent;
            color: var(--accent-tertiary);
            border: 1px solid var(--accent-tertiary);
        }

        .preview-button:hover {
            background: rgba(138, 43, 226, 0.1);
        }

        .vote-button {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .vote-button:hover {
            background: rgba(6, 255, 165, 0.1);
        }

        .vote-button.voted {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .download-button {
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .download-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Recent & Popular sections */
        .quick-access {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .quick-access {
                grid-template-columns: 1fr;
            }
        }

        .quick-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
        }

        .quick-section-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quick-item {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-decoration: none;
            color: inherit;
        }

        .quick-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .quick-item-title {
            font-size: 0.95em;
        }

        .quick-item-meta {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        /* Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 20px;
        }

        .preview-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .preview-title {
            font-size: 1.2em;
            color: var(--text-primary);
        }

        .preview-actions {
            display: flex;
            gap: 15px;
        }

        .preview-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .preview-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .preview-iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        }

        /* Tour overlay */
        .tour-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
        }

        .tour-overlay.active {
            display: block;
        }

        .tour-tooltip {
            position: absolute;
            background: var(--accent-tertiary);
            color: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(138, 43, 226, 0.5);
        }

        .tour-tooltip::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .tour-tooltip.bottom::after {
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent var(--accent-tertiary) transparent;
        }

        .tour-title {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .tour-text {
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .tour-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .tour-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .tour-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tour-btn.primary {
            background: white;
            color: var(--accent-tertiary);
        }

        .tour-progress {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
        }

        .tour-dot.active {
            background: white;
        }

        /* No results message */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 1.2em;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 1.2em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Sections */
        .exhibition-section {
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: var(--text-primary);
            font-weight: 300;
            letter-spacing: 0.05em;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        /* Three.js container */
        #three-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        #three-container.active {
            display: block;
        }

        /* Xbox controller indicator */
        #controller-indicator {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--accent);
            border-radius: 25px;
            color: var(--accent);
            font-size: 14px;
            z-index: 1002;
            animation: pulse 2s ease-in-out infinite;
        }

        #controller-indicator.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* Mobile touch controls */
        @media (max-width: 768px) {
            .mobile-controls {
                display: block;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .shortcuts-modal.active {
            display: block;
        }

        .shortcuts-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--accent);
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 15px 30px;
        }

        .shortcut-key {
            background: var(--bg-primary);
            padding: 5px 10px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            color: var(--accent);
            border: 1px solid var(--border);
            white-space: nowrap;
        }

        .shortcut-description {
            color: var(--text-primary);
        }

        /* Data Export/Import Section */
        .data-management {
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .data-management-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .data-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .data-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .data-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        /* Collections Sidebar */
        .collections-sidebar {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background: var(--bg-secondary);
            border-left: 2px solid var(--border);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .collections-sidebar.active {
            right: 0;
        }

        .collections-toggle {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 120px;
            background: var(--accent-tertiary);
            border-radius: 20px 0 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            writing-mode: vertical-rl;
            color: white;
            font-size: 0.9em;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
        }

        .collections-toggle:hover {
            width: 50px;
            background: var(--accent);
        }

        .collection-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .collection-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-5px);
        }

        .collection-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .collection-count {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 900px;
            height: 80vh;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            overflow-y: auto;
            z-index: 10001;
        }

        .analytics-dashboard.active {
            display: block;
        }

        .analytics-title {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: var(--accent);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: var(--bg-primary);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .analytics-value {
            font-size: 2.5em;
            color: var(--accent);
            font-weight: 300;
        }

        .analytics-label {
            color: var(--text-secondary);
            margin-top: 10px;
        }

        /* Simple Bar Chart */
        .chart-container {
            background: var(--bg-primary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 10px;
            padding: 10px 0;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--accent), var(--accent-tertiary));
            border-radius: 5px 5px 0 0;
            position: relative;
            min-height: 5px;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
            color: var(--accent);
        }

        /* Theme Selector */
        .theme-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 998;
        }

        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s ease;
        }

        .theme-btn:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }

        .theme-menu {
            position: absolute;
            bottom: 60px;
            right: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 10px;
            display: none;
        }

        .theme-menu.active {
            display: block;
        }

        .theme-option {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .theme-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-option.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        /* Comparison Mode */
        .comparison-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-tertiary);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            z-index: 1000;
        }

        .comparison-mode-indicator.active {
            display: block;
        }

        .comparison-table {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1000px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            z-index: 10001;
            max-height: 80vh;
            overflow-y: auto;
        }

        .comparison-table.active {
            display: block;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: auto repeat(var(--comparison-count, 2), 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .comparison-cell {
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .comparison-header {
            font-weight: 600;
            color: var(--accent);
        }

        .comparison-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .suggestion-type {
            font-size: 0.8em;
            color: var(--accent);
            margin-right: 10px;
        }

        /* Keyboard shortcut indicators */
        .kbd-indicator {
            display: inline-block;
            padding: 2px 6px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8em;
            font-family: monospace;
            margin-left: 10px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>LOCAL FIRST TOOLS</h1>
            <div class="subtitle">Gallery Collection</div>
            <div class="description">
                Privacy-first, offline-capable tools that work entirely in your browser.
                No servers, no tracking, just powerful applications you fully control.
            </div>
        </header>

        <div class="stats" id="stats">
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="total-tools">0</span>
                    <span>Total Tools</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="featured-count">0</span>
                    <span>Featured</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="categories-count">0</span>
                    <span>Categories</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="last-updated">--</span>
                    <span>Last Updated</span>
                </div>
            </div>
        </div>

        <div class="search-container">
            <div class="search-wrapper">
                <input type="text" class="search-input" id="searchInput"
                       placeholder="Search by title, description, tags, category, or filename... (Press /)">
                <span class="search-icon">üîç</span>
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
        </div>

        <!-- Category Navigation -->
        <div class="category-nav" id="categoryNav">
            <!-- Categories will be dynamically added here -->
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-group">
                <span class="filter-label">Complexity:</span>
                <select class="filter-select" id="complexityFilter">
                    <option value="">All</option>
                    <option value="simple">Simple</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Type:</span>
                <select class="filter-select" id="typeFilter">
                    <option value="">All</option>
                    <option value="game">Games</option>
                    <option value="drawing">Drawing</option>
                    <option value="visual">Visual</option>
                    <option value="interactive">Interactive</option>
                    <option value="audio">Audio</option>
                    <option value="interface">Interface</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Featured:</span>
                <select class="filter-select" id="featuredFilter">
                    <option value="">All</option>
                    <option value="featured">Featured Only</option>
                    <option value="regular">Regular Only</option>
                </select>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div class="active-filters" id="activeFilters"></div>

        <!-- Sort Controls -->
        <div class="sort-controls">
            <button class="sort-btn active" data-sort="name">Name</button>
            <button class="sort-btn" data-sort="popular">Most Popular</button>
            <button class="sort-btn" data-sort="recent">Recently Used</button>
            <button class="sort-btn" data-sort="complexity">Complexity</button>
            <button class="sort-btn" data-sort="random">Random</button>
        </div>

        <!-- Gallery Modes -->
        <div class="gallery-modes">
            <button class="mode-button active" id="main-gallery">Main Gallery</button>
            <button class="mode-button" id="archive-mode">Archive</button>
            <button class="mode-button" id="magazine-mode">Magazine</button>
            <button class="mode-button vr-mode" id="3d-mode">3D Experience</button>
            <button class="mode-button" id="tour-btn">Guided Tour</button>
            <button class="mode-button" id="analytics-btn">Analytics <span class="kbd-indicator">A</span></button>
            <button class="mode-button" id="compare-btn">Compare <span class="kbd-indicator">C</span></button>
        </div>

        <!-- Data Management Section -->
        <div class="data-management">
            <div class="data-management-title">üîê Data Management</div>
            <div class="data-actions">
                <button class="data-btn" id="exportDataBtn">Export All Data</button>
                <button class="data-btn" id="importDataBtn">Import Data</button>
                <button class="data-btn" id="clearDataBtn">Clear All Data</button>
                <button class="data-btn" id="backupBtn">Create Backup</button>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>
        </div>

        <!-- Tag Cloud -->
        <div class="tag-cloud" id="tagCloud">
            <div class="tag-cloud-title">Popular Tags</div>
            <div class="tag-cloud-items" id="tagCloudItems"></div>
        </div>

        <!-- Quick Access Sections -->
        <div class="quick-access">
            <div class="quick-section">
                <div class="quick-section-title">
                    üïê Recently Opened
                </div>
                <div class="quick-list" id="recentlyOpened"></div>
            </div>
            <div class="quick-section">
                <div class="quick-section-title">
                    üî• Popular This Week
                </div>
                <div class="quick-list" id="popularTools"></div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="recommendations" id="recommendations" style="display: none;">
            <div class="recommendations-title">‚ú® Recommended For You</div>
            <div class="recommendations-grid" id="recommendationsGrid"></div>
        </div>

        <!-- Main Content -->
        <div class="content" id="toolsContainer">
            <div class="loading">Loading tools...</div>
        </div>
    </div>

    <!-- 3D Gallery Container -->
    <div id="three-container"></div>

    <!-- Xbox Controller Indicator -->
    <div id="controller-indicator">üéÆ Xbox Controller Connected</div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <div class="preview-title" id="previewTitle">Tool Preview</div>
                <div class="preview-actions">
                    <button class="preview-btn" id="openFullBtn">Open Full</button>
                    <button class="preview-btn" id="closePreviewBtn">Close (ESC)</button>
                </div>
            </div>
            <iframe class="preview-iframe" id="previewIframe"></iframe>
        </div>
    </div>

    <!-- Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-tooltip" id="tourTooltip">
            <div class="tour-progress" id="tourProgress"></div>
            <div class="tour-title" id="tourTitle">Welcome to Local First Tools!</div>
            <div class="tour-text" id="tourText">
                This gallery contains 200+ privacy-first tools that work entirely offline.
            </div>
            <div class="tour-actions">
                <button class="tour-btn" id="tourSkip">Skip</button>
                <button class="tour-btn primary" id="tourNext">Next</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal">
        <h2 class="shortcuts-title">‚å®Ô∏è Keyboard Shortcuts</h2>
        <div class="shortcuts-grid">
            <div class="shortcut-key">/</div>
            <div class="shortcut-description">Focus search box</div>

            <div class="shortcut-key">Esc</div>
            <div class="shortcut-description">Clear search / Close modals</div>

            <div class="shortcut-key">?</div>
            <div class="shortcut-description">Show this help</div>

            <div class="shortcut-key">1-9</div>
            <div class="shortcut-description">Jump to category</div>

            <div class="shortcut-key">0</div>
            <div class="shortcut-description">Show all categories</div>

            <div class="shortcut-key">f</div>
            <div class="shortcut-description">Toggle featured filter</div>

            <div class="shortcut-key">p</div>
            <div class="shortcut-description">Toggle pin on focused tool</div>

            <div class="shortcut-key">a</div>
            <div class="shortcut-description">Open analytics dashboard</div>

            <div class="shortcut-key">c</div>
            <div class="shortcut-description">Toggle comparison mode</div>

            <div class="shortcut-key">t</div>
            <div class="shortcut-description">Toggle theme</div>

            <div class="shortcut-key">h</div>
            <div class="shortcut-description">Go to home/reset view</div>

            <div class="shortcut-key">r</div>
            <div class="shortcut-description">Refresh tools</div>

            <div class="shortcut-key">Tab</div>
            <div class="shortcut-description">Navigate through tools</div>

            <div class="shortcut-key">Enter</div>
            <div class="shortcut-description">Open focused tool</div>

            <div class="shortcut-key">Shift+Enter</div>
            <div class="shortcut-description">Preview focused tool</div>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="analytics-dashboard" id="analyticsDashboard">
        <h2 class="analytics-title">üìä Analytics Dashboard</h2>

        <div class="analytics-grid">
            <div class="analytics-card">
                <div class="analytics-value" id="totalOpens">0</div>
                <div class="analytics-label">Total Opens</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-value" id="uniqueTools">0</div>
                <div class="analytics-label">Unique Tools Used</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-value" id="avgUsage">0</div>
                <div class="analytics-label">Avg. Uses/Tool</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-value" id="streak">0</div>
                <div class="analytics-label">Day Streak</div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Top 10 Most Used Tools</h3>
            <div class="chart-bars" id="topToolsChart"></div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Category Usage Breakdown</h3>
            <div class="chart-bars" id="categoryChart"></div>
        </div>

        <div class="data-actions" style="margin-top: 20px;">
            <button class="data-btn" onclick="closeAnalytics()">Close</button>
            <button class="data-btn" onclick="exportAnalytics()">Export Report</button>
            <button class="data-btn" onclick="clearAnalytics()">Clear Analytics</button>
        </div>
    </div>

    <!-- Comparison Table -->
    <div class="comparison-table" id="comparisonTable">
        <h2 style="color: var(--accent); margin-bottom: 20px;">üîç Tool Comparison</h2>
        <div class="comparison-grid" id="comparisonGrid">
            <!-- Comparison content will be generated dynamically -->
        </div>
        <div class="data-actions" style="margin-top: 20px;">
            <button class="data-btn" onclick="closeComparison()">Close</button>
            <button class="data-btn" onclick="clearComparison()">Clear Selection</button>
        </div>
    </div>

    <!-- Comparison Mode Indicator -->
    <div class="comparison-mode-indicator" id="comparisonIndicator">
        Select tools to compare (0/4 selected)
    </div>

    <!-- Collections Sidebar -->
    <div class="collections-toggle" id="collectionsToggle">COLLECTIONS</div>
    <div class="collections-sidebar" id="collectionsSidebar">
        <h3 style="color: var(--accent); margin-bottom: 20px;">üìÅ Collections</h3>

        <div class="data-actions" style="margin-bottom: 20px;">
            <button class="data-btn" onclick="createCollection()">+ New Collection</button>
        </div>

        <div id="collectionsList">
            <!-- Collections will be generated dynamically -->
        </div>
    </div>

    <!-- Theme Selector -->
    <div class="theme-selector">
        <button class="theme-btn" id="themeToggle">üé®</button>
        <div class="theme-menu" id="themeMenu">
            <div class="theme-option active" data-theme="dark">üåô Dark</div>
            <div class="theme-option" data-theme="light">‚òÄÔ∏è Light</div>
            <div class="theme-option" data-theme="high-contrast">‚ö° High Contrast</div>
            <div class="theme-option" data-theme="auto">üîÑ Auto</div>
        </div>
    </div>

    <script>
        // State management
        let allTools = [];
        let filteredTools = [];
        let galleryConfig = null;
        let currentCategory = 'all';
        let currentComplexity = '';
        let currentType = '';
        let currentFeatured = '';
        let currentTags = new Set();
        let currentSort = 'name';
        let currentView = 'main';
        let searchTerm = '';

        // Usage tracking (localStorage only)
        let usageData = JSON.parse(localStorage.getItem('toolUsage') || '{}');
        let recentlyOpened = JSON.parse(localStorage.getItem('recentlyOpened') || '[]');
        let pinnedTools = JSON.parse(localStorage.getItem('pinnedTools') || '[]');
        let votes = JSON.parse(localStorage.getItem('votes') || '{}');
        let userVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
        let tourCompleted = localStorage.getItem('tourCompleted') === 'true';

        // Advanced features state
        let collections = JSON.parse(localStorage.getItem('collections') || '{}');
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let shortcuts = JSON.parse(localStorage.getItem('shortcuts') || '{"enabled": true}');
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let comparisonMode = false;
        let comparisonTools = [];
        let focusedToolIndex = -1;
        let analyticsEnabled = localStorage.getItem('analyticsEnabled') !== 'false';

        // Load vibe_gallery_config.json
        async function loadGalleryConfig() {
            try {
                const response = await fetch('./data/config/utility_apps_config.json');
                if (response.ok) {
                    const config = await response.json();
                    processUtilityAppsConfig(config);
                    return true;
                }
            } catch (error) {
                console.error('Failed to load gallery config:', error);
            }

            // Fallback to tools-manifest if config fails
            return loadFallbackManifest();
        }

        // Fallback to tools-manifest.json
        async function loadFallbackManifest() {
            try {
                const response = await fetch('./tools-manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    processFallbackData(manifest);
                    return true;
                }
            } catch (error) {
                console.error('Failed to load tools manifest:', error);
            }
            return false;
        }

        // Process utility_apps_config.json data
        function processUtilityAppsConfig(config) {
            if (!config || !config.apps) return;

            allTools = config.apps.map(app => {
                // Extract category from path (e.g., ./apps/games/snake.html -> games)
                const pathParts = app.path.split('/');
                const categoryKey = pathParts.length > 2 ? pathParts[2] : 'utilities';

                return {
                    id: app.id,
                    filename: app.path.split('/').pop(),
                    title: app.title,
                    path: app.path,
                    description: app.description,
                    tags: app.tags || [],
                    icon: app.icon || 'üîß',
                    categoryKey: categoryKey,
                    categoryTitle: formatCategoryTitle(categoryKey),
                    featured: app.tags?.includes('featured') || false,
                    complexity: app.complexity || 'intermediate',
                    interactionType: app.tags?.[0] || 'interactive'
                };
            });

            // Update stats
            updateStats();

            // Build category navigation
            buildCategoryNav();

            // Build tag cloud
            buildTagCloud();

            // Display tools
            filterAndDisplayTools();

            // Load recent and popular
            updateQuickAccess();

            // Show tour if first visit
            if (!tourCompleted) {
                setTimeout(() => startTour(), 1000);
            }
        }

        // Format category title
        function formatCategoryTitle(categoryKey) {
            return categoryKey
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Process vibe_gallery_config data
        function processGalleryData() {
            if (!galleryConfig || !galleryConfig.vibeGallery) return;

            const gallery = galleryConfig.vibeGallery;
            allTools = [];

            // Extract all tools from categories
            Object.entries(gallery.categories).forEach(([categoryKey, category]) => {
                if (category.apps && Array.isArray(category.apps)) {
                    category.apps.forEach(app => {
                        allTools.push({
                            ...app,
                            categoryKey: categoryKey,
                            categoryTitle: category.title,
                            categoryColor: category.color
                        });
                    });
                }
            });

            // Update stats
            updateStats();

            // Build category navigation
            buildCategoryNav();

            // Build tag cloud
            buildTagCloud();

            // Display tools
            filterAndDisplayTools();

            // Load recent and popular
            updateQuickAccess();

            // Show tour if first visit
            if (!tourCompleted) {
                setTimeout(() => startTour(), 1000);
            }
        }

        // Process fallback manifest data
        function processFallbackData(manifest) {
            if (!manifest || !manifest.tools) return;

            allTools = manifest.tools.map(file => ({
                filename: file.name,
                title: formatTitle(file.name),
                path: file.name,
                description: `Interactive ${formatTitle(file.name)} application`,
                tags: extractTagsFromFilename(file.name),
                category: 'creative_tools',
                categoryKey: 'creative_tools',
                categoryTitle: 'Creative Tools',
                featured: false,
                complexity: 'intermediate',
                interactionType: 'interface'
            }));

            updateStats();
            filterAndDisplayTools();
        }

        // Extract tags from filename
        function extractTagsFromFilename(filename) {
            const name = filename.replace('.html', '').replace(/-/g, ' ');
            const words = name.split(' ');
            return words.filter(w => w.length > 3);
        }

        // Format title from filename
        function formatTitle(filename) {
            return filename
                .replace('.html', '')
                .replace(/-/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Update statistics
        function updateStats() {
            document.getElementById('total-tools').textContent = allTools.length;
            document.getElementById('featured-count').textContent = allTools.filter(t => t.featured).length;

            const categories = new Set(allTools.map(t => t.categoryKey));
            document.getElementById('categories-count').textContent = categories.size;

            const lastUpdated = galleryConfig?.vibeGallery?.lastUpdated || 'Today';
            document.getElementById('last-updated').textContent = lastUpdated;
        }

        // Build category navigation
        function buildCategoryNav() {
            const nav = document.getElementById('categoryNav');
            nav.innerHTML = '';

            // Count tools per category
            const categoryCounts = {};
            allTools.forEach(tool => {
                categoryCounts[tool.categoryKey] = (categoryCounts[tool.categoryKey] || 0) + 1;
            });

            // Add "All" button
            const allBtn = document.createElement('button');
            allBtn.className = 'category-btn active';
            allBtn.innerHTML = `
                <span>All</span>
                <span class="category-count">${allTools.length}</span>
            `;
            allBtn.onclick = () => selectCategory('all');
            nav.appendChild(allBtn);

            // Add category buttons
            if (galleryConfig?.vibeGallery?.categories) {
                Object.entries(galleryConfig.vibeGallery.categories).forEach(([key, category]) => {
                    const count = categoryCounts[key] || 0;
                    if (count > 0) {
                        const btn = document.createElement('button');
                        btn.className = 'category-btn';
                        btn.innerHTML = `
                            <span>${category.title}</span>
                            <span class="category-count">${count}</span>
                        `;
                        btn.onclick = () => selectCategory(key);
                        nav.appendChild(btn);
                    }
                });
            }
        }

        // Build tag cloud
        function buildTagCloud() {
            const tagCounts = {};
            allTools.forEach(tool => {
                if (tool.tags) {
                    tool.tags.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });

            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20); // Top 20 tags

            const maxCount = Math.max(...sortedTags.map(t => t[1]));
            const minCount = Math.min(...sortedTags.map(t => t[1]));
            const range = maxCount - minCount || 1;

            const container = document.getElementById('tagCloudItems');
            container.innerHTML = '';

            sortedTags.forEach(([tag, count]) => {
                const size = Math.ceil(((count - minCount) / range) * 4) + 1;
                const span = document.createElement('span');
                span.className = `tag-item tag-size-${size}`;
                span.textContent = tag;
                span.onclick = () => toggleTag(tag);
                container.appendChild(span);
            });
        }

        // Select category
        function selectCategory(category) {
            currentCategory = category;

            // Update UI
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.category-btn').classList.add('active');

            // Filter and display
            filterAndDisplayTools();
            updateActiveFilters();
        }

        // Toggle tag filter
        function toggleTag(tag) {
            if (currentTags.has(tag)) {
                currentTags.delete(tag);
            } else {
                currentTags.add(tag);
            }

            // Update UI
            document.querySelectorAll('.tag-item').forEach(item => {
                if (item.textContent === tag) {
                    item.classList.toggle('active');
                }
            });

            filterAndDisplayTools();
            updateActiveFilters();
        }

        // Update active filters display
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';

            const filters = [];

            if (currentCategory !== 'all') {
                const categoryTitle = galleryConfig?.vibeGallery?.categories[currentCategory]?.title || currentCategory;
                filters.push({
                    type: 'Category',
                    value: categoryTitle,
                    remove: () => {
                        currentCategory = 'all';
                        document.querySelector('.category-btn').click();
                    }
                });
            }

            if (currentComplexity) {
                filters.push({
                    type: 'Complexity',
                    value: currentComplexity,
                    remove: () => {
                        currentComplexity = '';
                        document.getElementById('complexityFilter').value = '';
                        filterAndDisplayTools();
                    }
                });
            }

            if (currentType) {
                filters.push({
                    type: 'Type',
                    value: currentType,
                    remove: () => {
                        currentType = '';
                        document.getElementById('typeFilter').value = '';
                        filterAndDisplayTools();
                    }
                });
            }

            if (currentFeatured) {
                filters.push({
                    type: 'Featured',
                    value: currentFeatured === 'featured' ? 'Featured Only' : 'Regular Only',
                    remove: () => {
                        currentFeatured = '';
                        document.getElementById('featuredFilter').value = '';
                        filterAndDisplayTools();
                    }
                });
            }

            currentTags.forEach(tag => {
                filters.push({
                    type: 'Tag',
                    value: tag,
                    remove: () => toggleTag(tag)
                });
            });

            if (searchTerm) {
                filters.push({
                    type: 'Search',
                    value: searchTerm,
                    remove: () => {
                        searchTerm = '';
                        document.getElementById('searchInput').value = '';
                        filterAndDisplayTools();
                    }
                });
            }

            filters.forEach(filter => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                chip.innerHTML = `
                    <span>${filter.type}: ${filter.value}</span>
                    <span class="remove" onclick="removeFilter('${filter.type}', '${filter.value}')">‚úï</span>
                `;
                chip.querySelector('.remove').onclick = filter.remove;
                container.appendChild(chip);
            });
        }

        // Filter and display tools
        function filterAndDisplayTools() {
            filteredTools = [...allTools];

            // Category filter
            if (currentCategory !== 'all') {
                filteredTools = filteredTools.filter(t => t.categoryKey === currentCategory);
            }

            // Complexity filter
            if (currentComplexity) {
                filteredTools = filteredTools.filter(t => t.complexity === currentComplexity);
            }

            // Type filter
            if (currentType) {
                filteredTools = filteredTools.filter(t => t.interactionType === currentType);
            }

            // Featured filter
            if (currentFeatured === 'featured') {
                filteredTools = filteredTools.filter(t => t.featured);
            } else if (currentFeatured === 'regular') {
                filteredTools = filteredTools.filter(t => !t.featured);
            }

            // Tag filters
            if (currentTags.size > 0) {
                filteredTools = filteredTools.filter(t => {
                    if (!t.tags) return false;
                    return Array.from(currentTags).every(tag => t.tags.includes(tag));
                });
            }

            // Search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredTools = filteredTools.filter(t => {
                    return t.title?.toLowerCase().includes(term) ||
                           t.description?.toLowerCase().includes(term) ||
                           t.filename?.toLowerCase().includes(term) ||
                           t.category?.toLowerCase().includes(term) ||
                           t.tags?.some(tag => tag.toLowerCase().includes(term));
                });
            }

            // Sort tools
            sortTools();

            // Display
            displayTools();

            // Update recommendations
            updateRecommendations();
        }

        // Sort tools
        function sortTools() {
            switch (currentSort) {
                case 'name':
                    filteredTools.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'popular':
                    filteredTools.sort((a, b) => {
                        const aUsage = usageData[a.filename]?.count || 0;
                        const bUsage = usageData[b.filename]?.count || 0;
                        return bUsage - aUsage;
                    });
                    break;
                case 'recent':
                    filteredTools.sort((a, b) => {
                        const aTime = usageData[a.filename]?.lastUsed || 0;
                        const bTime = usageData[b.filename]?.lastUsed || 0;
                        return bTime - aTime;
                    });
                    break;
                case 'complexity':
                    const complexityOrder = { simple: 1, intermediate: 2, advanced: 3 };
                    filteredTools.sort((a, b) => {
                        const aOrder = complexityOrder[a.complexity] || 2;
                        const bOrder = complexityOrder[b.complexity] || 2;
                        return aOrder - bOrder;
                    });
                    break;
                case 'random':
                    filteredTools = filteredTools.sort(() => Math.random() - 0.5);
                    break;
            }

            // Always put pinned items first
            const pinned = filteredTools.filter(t => pinnedTools.includes(t.filename));
            const unpinned = filteredTools.filter(t => !pinnedTools.includes(t.filename));
            filteredTools = [...pinned, ...unpinned];
        }

        // Display tools
        function displayTools() {
            const container = document.getElementById('toolsContainer');
            container.innerHTML = '';

            if (filteredTools.length === 0) {
                container.innerHTML = '<div class="no-results">No tools found matching your criteria</div>';
                return;
            }

            // Create sections
            const pinnedItems = filteredTools.filter(t => pinnedTools.includes(t.filename));
            const featuredItems = filteredTools.filter(t => t.featured && !pinnedTools.includes(t.filename));
            const regularItems = filteredTools.filter(t => !t.featured && !pinnedTools.includes(t.filename));

            if (pinnedItems.length > 0) {
                createSection('üìå Pinned Tools', pinnedItems);
            }

            if (featuredItems.length > 0) {
                createSection('‚≠ê Featured Tools', featuredItems);
            }

            if (regularItems.length > 0) {
                createSection('üöÄ All Tools', regularItems);
            }
        }

        function displayMagazineView() {
            const container = document.getElementById('toolsContainer');
            container.innerHTML = '';

            if (filteredTools.length === 0) {
                container.innerHTML = '<div class="no-results">No tools found</div>';
                return;
            }

            // Create magazine-style article
            const article = document.createElement('div');
            article.style.cssText = `
                max-width: 800px;
                margin: 0 auto;
                background: rgba(255,255,255,0.05);
                border-radius: 20px;
                padding: 60px;
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;

            // Magazine header
            const header = `
                <div style="text-align: center; margin-bottom: 60px; padding-bottom: 40px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 14px; letter-spacing: 4px; color: rgba(255,255,255,0.6); margin-bottom: 20px;">ISSUE ${new Date().getMonth() + 1}.${new Date().getFullYear()}</div>
                    <h1 style="font-size: 4em; font-weight: 100; letter-spacing: 0.05em; margin-bottom: 20px; background: linear-gradient(135deg, #00d4ff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">LOCAL FIRST TOOLS</h1>
                    <div style="font-size: 1.2em; color: rgba(255,255,255,0.7); font-style: italic;">A Curated Collection of ${allTools.length} Privacy-First Applications</div>
                </div>
            `;

            article.innerHTML = header;

            // Group by category
            const categories = {};
            filteredTools.forEach(tool => {
                const catKey = tool.categoryKey || 'utilities';
                if (!categories[catKey]) categories[catKey] = [];
                categories[catKey].push(tool);
            });

            // Create feature article for each category
            Object.entries(categories).forEach(([category, tools], index) => {
                const categoryData = galleryConfig?.vibeGallery?.categories[category] || {};
                const catTitle = categoryData.title || category;
                const catEmoji = categoryData.emoji || 'üîß';

                const section = document.createElement('div');
                section.style.cssText = `
                    margin: 80px 0;
                    page-break-inside: avoid;
                `;

                const featureTool = tools[0];
                const regularTools = tools.slice(1, 6);

                section.innerHTML = `
                    <div style="margin-bottom: 40px;">
                        <div style="display: inline-block; padding: 8px 20px; background: ${categoryData.color || 'var(--accent)'}; color: #000; border-radius: 20px; font-size: 12px; letter-spacing: 2px; font-weight: 600; margin-bottom: 20px;">${catEmoji} ${catTitle.toUpperCase()}</div>
                        <h2 style="font-size: 3em; font-weight: 300; margin-bottom: 30px; line-height: 1.2;">${featureTool.title}</h2>
                        <div style="font-size: 1.3em; line-height: 1.8; color: rgba(255,255,255,0.8); margin-bottom: 30px; text-indent: 2em;">
                            ${featureTool.description || 'Explore this innovative tool designed for privacy-first computing. Built with care, tested with passion, and ready to transform your workflow.'}
                        </div>
                        <div style="display: flex; gap: 20px; margin: 30px 0; flex-wrap: wrap;">
                            ${featureTool.tags ? featureTool.tags.map(tag =>
                                `<span style="padding: 6px 16px; background: rgba(255,255,255,0.1); border-radius: 15px; font-size: 0.9em;">#${tag}</span>`
                            ).join('') : ''}
                        </div>
                        <a href="${featureTool.path}" target="_blank" style="display: inline-block; padding: 15px 40px; background: linear-gradient(135deg, ${categoryData.color || '#00d4ff'}, ${categoryData.color || '#0099ff'}); color: #000; text-decoration: none; border-radius: 25px; font-weight: 600; letter-spacing: 1px; transition: all 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                            EXPLORE ${featureTool.title.toUpperCase()}
                        </a>
                    </div>

                    ${regularTools.length > 0 ? `
                        <div style="margin-top: 50px; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <h3 style="font-size: 1.5em; font-weight: 400; margin-bottom: 30px; color: rgba(255,255,255,0.9);">More in ${catTitle}</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                                ${regularTools.map(tool => `
                                    <a href="${tool.path}" target="_blank" style="
                                        padding: 20px;
                                        background: rgba(255,255,255,0.05);
                                        border: 1px solid rgba(255,255,255,0.1);
                                        border-radius: 15px;
                                        text-decoration: none;
                                        color: inherit;
                                        transition: all 0.3s;
                                        display: block;
                                    " onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(-5px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='translateY(0)'">
                                        <div style="font-size: 1.2em; font-weight: 500; margin-bottom: 10px;">${tool.title}</div>
                                        <div style="font-size: 0.9em; color: rgba(255,255,255,0.6); line-height: 1.6;">${(tool.description || '').substring(0, 100)}${tool.description && tool.description.length > 100 ? '...' : ''}</div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                article.appendChild(section);
            });

            // Magazine footer
            const footer = document.createElement('div');
            footer.style.cssText = `
                margin-top: 80px;
                padding-top: 40px;
                border-top: 2px solid rgba(255,255,255,0.1);
                text-align: center;
                color: rgba(255,255,255,0.5);
            `;
            footer.innerHTML = `
                <div style="font-size: 0.9em; letter-spacing: 2px; margin-bottom: 20px;">LOCAL FIRST TOOLS</div>
                <div style="font-size: 0.8em;">Privacy-first. Offline-ready. Forever yours.</div>
                <div style="font-size: 0.8em; margin-top: 10px;">${allTools.length} applications ‚Ä¢ ${Object.keys(categories).length} categories ‚Ä¢ 100% local</div>
            `;

            article.appendChild(footer);
            container.appendChild(article);

            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Create a section
        function createSection(title, tools) {
            const container = document.getElementById('toolsContainer');

            const section = document.createElement('div');
            section.className = 'exhibition-section';

            const sectionTitle = document.createElement('h2');
            sectionTitle.className = 'section-title';
            sectionTitle.textContent = title;
            section.appendChild(sectionTitle);

            const grid = document.createElement('div');
            grid.className = 'tools-grid';

            tools.forEach(tool => {
                const card = createToolCard(tool);
                grid.appendChild(card);
            });

            section.appendChild(grid);
            container.appendChild(section);
        }

        // Create tool card
        function createToolCard(tool) {
            const isPinned = pinnedTools.includes(tool.filename);
            const hasVoted = userVotes[tool.filename] || false;
            const voteCount = votes[tool.filename]?.count || 0;

            const card = document.createElement('div');
            card.className = 'tool-card';
            if (isPinned) card.classList.add('pinned');
            if (tool.featured) card.classList.add('featured');

            // Generate emoji based on category or title
            const emoji = getToolEmoji(tool);

            // Complexity dots
            const complexityLevel = tool.complexity === 'simple' ? 1 :
                                   tool.complexity === 'intermediate' ? 2 : 3;

            card.innerHTML = `
                ${tool.featured ? '<div class="featured-badge">Featured</div>' : ''}
                <button class="pin-button ${isPinned ? 'pinned' : ''}"
                        data-file="${tool.filename}"
                        title="${isPinned ? 'Unpin' : 'Pin to top'}">
                    üìå
                </button>

                <div class="tool-preview">${emoji}</div>

                <div class="category-badge ${tool.categoryKey}">
                    ${tool.categoryTitle || tool.category}
                </div>

                <div class="tool-title">${tool.title}</div>
                <div class="tool-filename">${tool.filename}</div>

                <div class="complexity-indicator">
                    ${[1,2,3].map(i => `
                        <div class="complexity-dot ${i <= complexityLevel ? 'filled' : ''}"></div>
                    `).join('')}
                </div>

                <div class="tool-description">${tool.description}</div>

                <div class="tool-meta">
                    ${tool.tags ? tool.tags.slice(0, 3).map(tag => `
                        <span class="tool-tag">#${tag}</span>
                    `).join('') : ''}
                </div>

                <div class="tool-stats">
                    <span class="stat-item">
                        <span class="vote-count">${voteCount}</span> votes
                    </span>
                    ${usageData[tool.filename] ? `
                        <span class="stat-item">
                            ${usageData[tool.filename].count} opens
                        </span>
                    ` : ''}
                </div>

                <div class="tool-actions">
                    <button class="view-button" onclick="openTool('${tool.filename}')">OPEN</button>
                    <button class="preview-button" onclick="previewTool('${tool.filename}', '${tool.title}')">PREVIEW</button>
                    <button class="vote-button ${hasVoted ? 'voted' : ''}"
                            onclick="voteTool('${tool.filename}', event)">
                        ${hasVoted ? 'VOTED' : 'VOTE'}
                    </button>
                    <button class="download-button" onclick="downloadTool('${tool.filename}')">‚Üì</button>
                </div>
            `;

            // Add pin button listener
            const pinBtn = card.querySelector('.pin-button');
            pinBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePin(tool.filename);
            });

            return card;
        }

        // Get tool emoji based on category or content
        function getToolEmoji(tool) {
            const emojiMap = {
                games_puzzles: 'üéÆ',
                '3d_immersive': 'üé®',
                audio_music: 'üéµ',
                experimental_ai: 'ü§ñ',
                creative_tools: 'üõ†Ô∏è',
                generative_art: '‚ú®',
                particle_physics: '‚öõÔ∏è',
                educational_tools: 'üìö',
                visual_art: 'üé®'
            };

            return emojiMap[tool.categoryKey] || 'üì±';
        }

        // Open tool
        function openTool(filename) {
            // Find the tool to get its full path
            const tool = allTools.find(t => t.filename === filename);
            const fullPath = tool ? tool.path : filename;

            // Track usage
            if (!usageData[filename]) {
                usageData[filename] = { count: 0, lastUsed: 0 };
            }
            usageData[filename].count++;
            usageData[filename].lastUsed = Date.now();
            localStorage.setItem('toolUsage', JSON.stringify(usageData));

            // Add to recently opened
            recentlyOpened = recentlyOpened.filter(f => f !== filename);
            recentlyOpened.unshift(filename);
            recentlyOpened = recentlyOpened.slice(0, 10);
            localStorage.setItem('recentlyOpened', JSON.stringify(recentlyOpened));

            // Update quick access
            updateQuickAccess();

            // Open tool with full path
            window.open(fullPath, '_blank');
        }

        // Preview tool
        function previewTool(filename, title) {
            // Find the tool to get its full path
            const tool = allTools.find(t => t.filename === filename);
            const fullPath = tool ? tool.path : filename;

            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');
            const titleEl = document.getElementById('previewTitle');

            titleEl.textContent = title;
            iframe.src = fullPath;
            modal.classList.add('active');

            // Track preview
            if (!usageData[filename]) {
                usageData[filename] = { count: 0, lastUsed: 0 };
            }
            usageData[filename].previews = (usageData[filename].previews || 0) + 1;
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
        }

        // Close preview
        function closePreview() {
            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');

            modal.classList.remove('active');
            iframe.src = '';
        }

        // Vote for tool
        function voteTool(filename, event) {
            event.stopPropagation();

            if (userVotes[filename]) {
                // Remove vote
                userVotes[filename] = false;
                if (votes[filename]) {
                    votes[filename].count--;
                }
            } else {
                // Add vote
                userVotes[filename] = true;
                if (!votes[filename]) {
                    votes[filename] = { count: 0 };
                }
                votes[filename].count++;
            }

            localStorage.setItem('userVotes', JSON.stringify(userVotes));
            localStorage.setItem('votes', JSON.stringify(votes));

            // Refresh display
            filterAndDisplayTools();
        }

        // Download tool
        function downloadTool(filename) {
            // Find the tool to get its full path
            const tool = allTools.find(t => t.filename === filename);
            const fullPath = tool ? tool.path : filename;

            const link = document.createElement('a');
            link.href = fullPath;
            link.download = filename;
            link.click();
        }

        // Toggle pin
        function togglePin(filename) {
            if (pinnedTools.includes(filename)) {
                pinnedTools = pinnedTools.filter(f => f !== filename);
            } else {
                pinnedTools.push(filename);
            }

            localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools));
            filterAndDisplayTools();
        }

        // Update quick access sections
        function updateQuickAccess() {
            // Recently opened
            const recentContainer = document.getElementById('recentlyOpened');
            recentContainer.innerHTML = '';

            recentlyOpened.slice(0, 5).forEach(filename => {
                const tool = allTools.find(t => t.filename === filename);
                if (tool) {
                    const item = document.createElement('a');
                    item.className = 'quick-item';
                    item.href = '#';
                    item.onclick = (e) => {
                        e.preventDefault();
                        openTool(filename);
                    };
                    item.innerHTML = `
                        <span class="quick-item-title">${tool.title}</span>
                        <span class="quick-item-meta">Just now</span>
                    `;
                    recentContainer.appendChild(item);
                }
            });

            if (recentContainer.children.length === 0) {
                recentContainer.innerHTML = '<div style="color: var(--text-secondary); padding: 10px;">No recent tools</div>';
            }

            // Popular tools
            const popularContainer = document.getElementById('popularTools');
            popularContainer.innerHTML = '';

            const popular = Object.entries(usageData)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);

            popular.forEach(([filename, data]) => {
                const tool = allTools.find(t => t.filename === filename);
                if (tool) {
                    const item = document.createElement('a');
                    item.className = 'quick-item';
                    item.href = '#';
                    item.onclick = (e) => {
                        e.preventDefault();
                        openTool(filename);
                    };
                    item.innerHTML = `
                        <span class="quick-item-title">${tool.title}</span>
                        <span class="quick-item-meta">${data.count} opens</span>
                    `;
                    popularContainer.appendChild(item);
                }
            });

            if (popularContainer.children.length === 0) {
                popularContainer.innerHTML = '<div style="color: var(--text-secondary); padding: 10px;">No data yet</div>';
            }
        }

        // Update recommendations
        function updateRecommendations() {
            if (recentlyOpened.length === 0) return;

            const recentTool = allTools.find(t => t.filename === recentlyOpened[0]);
            if (!recentTool) return;

            // Find similar tools
            const similar = allTools.filter(t => {
                if (t.filename === recentTool.filename) return false;

                // Same category
                if (t.categoryKey === recentTool.categoryKey) return true;

                // Shared tags
                if (t.tags && recentTool.tags) {
                    const sharedTags = t.tags.filter(tag => recentTool.tags.includes(tag));
                    if (sharedTags.length >= 2) return true;
                }

                // Same complexity
                if (t.complexity === recentTool.complexity) return true;

                return false;
            }).slice(0, 4);

            if (similar.length > 0) {
                const container = document.getElementById('recommendations');
                const grid = document.getElementById('recommendationsGrid');

                container.style.display = 'block';
                grid.innerHTML = '';

                similar.forEach(tool => {
                    const card = createToolCard(tool);
                    grid.appendChild(card);
                });
            }
        }

        // Start guided tour
        function startTour() {
            const overlay = document.getElementById('tourOverlay');
            const tooltip = document.getElementById('tourTooltip');

            const steps = [
                {
                    title: 'Welcome to Local First Tools!',
                    text: 'This gallery contains 200+ privacy-first tools that work entirely offline in your browser.',
                    element: null
                },
                {
                    title: 'Smart Search',
                    text: 'Search across titles, descriptions, tags, and categories to find exactly what you need.',
                    element: document.getElementById('searchInput')
                },
                {
                    title: 'Category Navigation',
                    text: 'Browse tools by category - from games and AI experiments to creative tools and visualizations.',
                    element: document.getElementById('categoryNav')
                },
                {
                    title: 'Advanced Filters',
                    text: 'Filter by complexity level, interaction type, or featured status to narrow your search.',
                    element: document.querySelector('.filter-controls')
                },
                {
                    title: 'Tag Cloud',
                    text: 'Click on popular tags to discover related tools quickly.',
                    element: document.getElementById('tagCloud')
                },
                {
                    title: '3D Gallery Mode',
                    text: 'Experience an immersive 3D gallery with Xbox controller support!',
                    element: document.getElementById('3d-mode')
                },
                {
                    title: 'Get Started!',
                    text: 'Pin your favorite tools, track usage, and enjoy complete privacy - everything stays in your browser.',
                    element: null
                }
            ];

            let currentStep = 0;

            function showStep(index) {
                const step = steps[index];
                const progress = document.getElementById('tourProgress');

                // Update progress dots
                progress.innerHTML = steps.map((_, i) =>
                    `<div class="tour-dot ${i === index ? 'active' : ''}"></div>`
                ).join('');

                // Update content
                document.getElementById('tourTitle').textContent = step.title;
                document.getElementById('tourText').textContent = step.text;

                // Position tooltip
                if (step.element) {
                    const rect = step.element.getBoundingClientRect();
                    tooltip.style.top = (rect.bottom + 20) + 'px';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translateX(-50%)';
                } else {
                    tooltip.style.top = '50%';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translate(-50%, -50%)';
                }

                // Update button
                const nextBtn = document.getElementById('tourNext');
                if (index === steps.length - 1) {
                    nextBtn.textContent = 'Finish';
                } else {
                    nextBtn.textContent = 'Next';
                }
            }

            overlay.classList.add('active');
            showStep(0);

            document.getElementById('tourNext').onclick = () => {
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    showStep(currentStep);
                } else {
                    endTour();
                }
            };

            document.getElementById('tourSkip').onclick = endTour;

            function endTour() {
                overlay.classList.remove('active');
                localStorage.setItem('tourCompleted', 'true');
                tourCompleted = true;
            }
        }

        // Initialize event listeners
        function initEventListeners() {
            // Search input with advanced features
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const value = e.target.value;
                    searchTerm = value.toLowerCase();

                    // Update search history
                    if (value && !searchHistory.includes(value)) {
                        searchHistory.unshift(value);
                        searchHistory = searchHistory.slice(0, 10);
                        localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                    }

                    // Parse advanced search operators
                    if (value.includes(':')) {
                        parseAdvancedSearch(value);
                    } else {
                        filterAndDisplayTools();
                    }

                    updateActiveFilters();
                    updateSearchSuggestions(value);
                }, 300);
            });

            // Search suggestions
            searchInput.addEventListener('focus', () => {
                showSearchSuggestions();
            });

            searchInput.addEventListener('blur', () => {
                setTimeout(() => hideSearchSuggestions(), 200);
            });

            // Complexity filter
            document.getElementById('complexityFilter').addEventListener('change', (e) => {
                currentComplexity = e.target.value;
                filterAndDisplayTools();
                updateActiveFilters();
            });

            // Type filter
            document.getElementById('typeFilter').addEventListener('change', (e) => {
                currentType = e.target.value;
                filterAndDisplayTools();
                updateActiveFilters();
            });

            // Featured filter
            document.getElementById('featuredFilter').addEventListener('change', (e) => {
                currentFeatured = e.target.value;
                filterAndDisplayTools();
                updateActiveFilters();
            });

            // Sort buttons
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSort = btn.dataset.sort;
                    filterAndDisplayTools();
                });
            });

            // Gallery modes
            document.getElementById('main-gallery').addEventListener('click', () => {
                currentView = 'main';
                document.querySelectorAll('.mode-button').forEach(b => b.classList.remove('active'));
                document.getElementById('main-gallery').classList.add('active');
                filterAndDisplayTools();
            });

            document.getElementById('archive-mode').addEventListener('click', () => {
                currentView = 'archive';
                document.querySelectorAll('.mode-button').forEach(b => b.classList.remove('active'));
                document.getElementById('archive-mode').classList.add('active');
                // In enhanced version, we'd filter archive tools
                filterAndDisplayTools();
            });

            document.getElementById('magazine-mode').addEventListener('click', () => {
                currentView = 'magazine';
                document.querySelectorAll('.mode-button').forEach(b => b.classList.remove('active'));
                document.getElementById('magazine-mode').classList.add('active');
                displayMagazineView();
            });

            document.getElementById('tour-btn').addEventListener('click', startTour);

            // Preview modal
            document.getElementById('closePreviewBtn').addEventListener('click', closePreview);
            document.getElementById('openFullBtn').addEventListener('click', () => {
                const iframe = document.getElementById('previewIframe');
                window.open(iframe.src, '_blank');
                closePreview();
            });

            // ESC key to close preview
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closePreview();
                }
            });

            // Analytics button
            document.getElementById('analytics-btn').addEventListener('click', openAnalytics);

            // Compare button
            document.getElementById('compare-btn').addEventListener('click', toggleComparisonMode);

            // Data management buttons
            document.getElementById('exportDataBtn').addEventListener('click', exportAllData);
            document.getElementById('importDataBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            document.getElementById('importFile').addEventListener('change', importData);
            document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
            document.getElementById('backupBtn').addEventListener('click', createBackup);

            // Collections toggle
            document.getElementById('collectionsToggle').addEventListener('click', toggleCollectionsSidebar);

            // Theme selector
            document.getElementById('themeToggle').addEventListener('click', toggleThemeMenu);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    setTheme(e.target.dataset.theme);
                });
            });

            // Initialize keyboard shortcuts
            initKeyboardShortcuts();
        }

        // Advanced Search Parsing
        function parseAdvancedSearch(query) {
            const operators = {
                'tag:': (value) => {
                    currentTags.clear();
                    currentTags.add(value);
                },
                'cat:': (value) => {
                    currentCategory = value;
                },
                'level:': (value) => {
                    currentComplexity = value;
                },
                'type:': (value) => {
                    currentType = value;
                },
                'is:': (value) => {
                    if (value === 'featured') currentFeatured = 'featured';
                    if (value === 'pinned') {
                        filteredTools = allTools.filter(t => pinnedTools.includes(t.filename));
                        displayTools();
                        return true;
                    }
                }
            };

            for (const [operator, handler] of Object.entries(operators)) {
                if (query.includes(operator)) {
                    const value = query.split(operator)[1].split(' ')[0];
                    if (handler(value) !== true) {
                        filterAndDisplayTools();
                    }
                    return;
                }
            }

            filterAndDisplayTools();
        }

        // Search Suggestions
        function updateSearchSuggestions(query) {
            const suggestions = document.getElementById('searchSuggestions');
            if (!query) {
                suggestions.classList.remove('active');
                return;
            }

            const suggestionItems = [];

            // Recent searches
            searchHistory.filter(s => s.toLowerCase().includes(query.toLowerCase())).forEach(search => {
                suggestionItems.push({ type: 'Recent', value: search });
            });

            // Tool suggestions
            allTools.filter(t => t.title.toLowerCase().includes(query.toLowerCase())).slice(0, 5).forEach(tool => {
                suggestionItems.push({ type: 'Tool', value: tool.title });
            });

            // Tag suggestions
            const allTags = new Set();
            allTools.forEach(t => t.tags?.forEach(tag => allTags.add(tag)));
            Array.from(allTags).filter(tag => tag.toLowerCase().includes(query.toLowerCase())).slice(0, 3).forEach(tag => {
                suggestionItems.push({ type: 'Tag', value: `tag:${tag}` });
            });

            if (suggestionItems.length > 0) {
                suggestions.innerHTML = suggestionItems.map(item => `
                    <div class="suggestion-item" onclick="applySuggestion('${item.value}')">
                        <span class="suggestion-type">${item.type}</span>
                        <span>${item.value}</span>
                    </div>
                `).join('');
                suggestions.classList.add('active');
            } else {
                suggestions.classList.remove('active');
            }
        }

        function showSearchSuggestions() {
            const suggestions = document.getElementById('searchSuggestions');
            if (searchHistory.length > 0 || searchTerm) {
                updateSearchSuggestions(searchTerm || '');
            }
        }

        function hideSearchSuggestions() {
            document.getElementById('searchSuggestions').classList.remove('active');
        }

        function applySuggestion(value) {
            document.getElementById('searchInput').value = value;
            searchTerm = value.toLowerCase();
            filterAndDisplayTools();
            hideSearchSuggestions();
        }

        // Keyboard Shortcuts Implementation
        function initKeyboardShortcuts() {
            if (!shortcuts.enabled) return;

            document.addEventListener('keydown', (e) => {
                // Don't trigger shortcuts in input fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                // Don't trigger shortcuts when in 3D mode
                const threeContainer = document.getElementById('three-container');
                if (threeContainer && threeContainer.classList.contains('active')) {
                    return;
                }

                // Shortcuts
                switch(e.key) {
                    case '/':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;

                    case 'Escape':
                        clearSearch();
                        closeAllModals();
                        break;

                    case '?':
                        if (e.shiftKey) {
                            toggleShortcutsHelp();
                        }
                        break;

                    case 'h':
                        resetView();
                        break;

                    case 'r':
                        location.reload();
                        break;

                    case 'f':
                        toggleFeaturedFilter();
                        break;

                    case 'p':
                        if (focusedToolIndex >= 0) {
                            const tool = filteredTools[focusedToolIndex];
                            togglePin(tool.filename);
                        }
                        break;

                    case 'a':
                        openAnalytics();
                        break;

                    case 'c':
                        toggleComparisonMode();
                        break;

                    case 't':
                        cycleTheme();
                        break;

                    case 'Tab':
                        e.preventDefault();
                        navigateTools(e.shiftKey ? -1 : 1);
                        break;

                    case 'Enter':
                        if (focusedToolIndex >= 0) {
                            const tool = filteredTools[focusedToolIndex];
                            if (e.shiftKey) {
                                previewTool(tool.filename, tool.title);
                            } else {
                                openTool(tool.filename);
                            }
                        }
                        break;

                    default:
                        // Number keys for categories
                        if (e.key >= '0' && e.key <= '9') {
                            jumpToCategory(parseInt(e.key));
                        }
                        break;
                }
            });
        }

        function toggleShortcutsHelp() {
            const modal = document.getElementById('shortcutsModal');
            modal.classList.toggle('active');
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            filterAndDisplayTools();
        }

        function closeAllModals() {
            document.querySelectorAll('.shortcuts-modal, .analytics-dashboard, .comparison-table, .preview-modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function resetView() {
            currentCategory = 'all';
            currentComplexity = '';
            currentType = '';
            currentFeatured = '';
            currentTags.clear();
            searchTerm = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('complexityFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('featuredFilter').value = '';
            filterAndDisplayTools();
        }

        function toggleFeaturedFilter() {
            const filter = document.getElementById('featuredFilter');
            filter.value = filter.value === 'featured' ? '' : 'featured';
            currentFeatured = filter.value;
            filterAndDisplayTools();
        }

        function navigateTools(direction) {
            const cards = document.querySelectorAll('.tool-card');
            if (cards.length === 0) return;

            focusedToolIndex = Math.max(0, Math.min(cards.length - 1, focusedToolIndex + direction));

            cards.forEach(c => c.style.outline = '');
            cards[focusedToolIndex].style.outline = '2px solid var(--accent)';
            cards[focusedToolIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function jumpToCategory(num) {
            const btns = document.querySelectorAll('.category-btn');
            if (num === 0) {
                btns[0]?.click(); // All categories
            } else if (num <= btns.length - 1) {
                btns[num]?.click();
            }
        }

        // Data Export/Import Functions
        function exportAllData() {
            const exportData = {
                version: '1.0.0',
                timestamp: new Date().toISOString(),
                data: {
                    usageData,
                    recentlyOpened,
                    pinnedTools,
                    votes,
                    userVotes,
                    collections,
                    searchHistory,
                    shortcuts,
                    theme: currentTheme,
                    tourCompleted,
                    analyticsEnabled
                }
            };

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `localfirst-gallery-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('Data exported successfully!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importData = JSON.parse(e.target.result);

                    if (!importData.version || !importData.data) {
                        throw new Error('Invalid data format');
                    }

                    // Ask user for import strategy
                    if (confirm('Replace existing data? (Cancel to merge)')) {
                        // Replace
                        usageData = importData.data.usageData || {};
                        recentlyOpened = importData.data.recentlyOpened || [];
                        pinnedTools = importData.data.pinnedTools || [];
                        votes = importData.data.votes || {};
                        userVotes = importData.data.userVotes || {};
                        collections = importData.data.collections || {};
                        searchHistory = importData.data.searchHistory || [];
                        shortcuts = importData.data.shortcuts || { enabled: true };
                        currentTheme = importData.data.theme || 'dark';
                        tourCompleted = importData.data.tourCompleted || false;
                        analyticsEnabled = importData.data.analyticsEnabled !== false;
                    } else {
                        // Merge
                        usageData = { ...usageData, ...importData.data.usageData };
                        recentlyOpened = [...new Set([...recentlyOpened, ...importData.data.recentlyOpened])].slice(0, 20);
                        pinnedTools = [...new Set([...pinnedTools, ...importData.data.pinnedTools])];
                        votes = { ...votes, ...importData.data.votes };
                        userVotes = { ...userVotes, ...importData.data.userVotes };
                        collections = { ...collections, ...importData.data.collections };
                        searchHistory = [...new Set([...searchHistory, ...importData.data.searchHistory])].slice(0, 20);
                    }

                    // Save to localStorage
                    saveAllData();
                    location.reload();

                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('Are you sure you want to clear all data? This cannot be undone.')) return;

            // Clear all localStorage data
            localStorage.clear();

            // Reset all state
            usageData = {};
            recentlyOpened = [];
            pinnedTools = [];
            votes = {};
            userVotes = {};
            collections = {};
            searchHistory = [];
            shortcuts = { enabled: true };
            currentTheme = 'dark';
            tourCompleted = false;
            analyticsEnabled = true;

            location.reload();
        }

        function createBackup() {
            const backupData = {
                usageData,
                recentlyOpened,
                pinnedTools,
                votes,
                userVotes,
                collections,
                searchHistory,
                shortcuts,
                theme: currentTheme,
                tourCompleted,
                analyticsEnabled,
                timestamp: Date.now()
            };

            localStorage.setItem('galleryBackup', JSON.stringify(backupData));
            localStorage.setItem('galleryBackupDate', new Date().toISOString());

            showNotification('Backup created successfully!', 'success');
        }

        function saveAllData() {
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
            localStorage.setItem('recentlyOpened', JSON.stringify(recentlyOpened));
            localStorage.setItem('pinnedTools', JSON.stringify(pinnedTools));
            localStorage.setItem('votes', JSON.stringify(votes));
            localStorage.setItem('userVotes', JSON.stringify(userVotes));
            localStorage.setItem('collections', JSON.stringify(collections));
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            localStorage.setItem('shortcuts', JSON.stringify(shortcuts));
            localStorage.setItem('theme', currentTheme);
            localStorage.setItem('tourCompleted', tourCompleted.toString());
            localStorage.setItem('analyticsEnabled', analyticsEnabled.toString());
        }

        // Collections Functions
        function toggleCollectionsSidebar() {
            const sidebar = document.getElementById('collectionsSidebar');
            sidebar.classList.toggle('active');
            if (sidebar.classList.contains('active')) {
                renderCollections();
            }
        }

        function renderCollections() {
            const container = document.getElementById('collectionsList');

            // Default collections
            const defaultCollections = [
                { id: 'favorites', name: 'Favorites', tools: pinnedTools },
                { id: 'recent', name: 'Recently Used', tools: recentlyOpened.slice(0, 10) }
            ];

            let html = '';

            // Render default collections
            defaultCollections.forEach(col => {
                html += `
                    <div class="collection-item" onclick="loadCollection('${col.id}')">
                        <div class="collection-name">${col.name}</div>
                        <div class="collection-count">${col.tools.length} tools</div>
                    </div>
                `;
            });

            // Render custom collections
            Object.entries(collections).forEach(([id, col]) => {
                html += `
                    <div class="collection-item" onclick="loadCollection('${id}')">
                        <div class="collection-name">${col.name}</div>
                        <div class="collection-count">${col.tools?.length || 0} tools</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function createCollection() {
            const name = prompt('Enter collection name:');
            if (!name) return;

            const id = 'col_' + Date.now();
            collections[id] = {
                name,
                tools: [],
                created: Date.now()
            };

            localStorage.setItem('collections', JSON.stringify(collections));
            renderCollections();
        }

        function loadCollection(id) {
            if (id === 'favorites') {
                filteredTools = allTools.filter(t => pinnedTools.includes(t.filename));
            } else if (id === 'recent') {
                filteredTools = allTools.filter(t => recentlyOpened.includes(t.filename));
            } else if (collections[id]) {
                filteredTools = allTools.filter(t => collections[id].tools.includes(t.filename));
            }

            displayTools();
            document.getElementById('collectionsSidebar').classList.remove('active');
        }

        // Analytics Functions
        function openAnalytics() {
            if (!analyticsEnabled) {
                if (!confirm('Analytics are disabled. Enable analytics?')) return;
                analyticsEnabled = true;
                localStorage.setItem('analyticsEnabled', 'true');
            }

            const dashboard = document.getElementById('analyticsDashboard');
            dashboard.classList.add('active');

            // Calculate stats
            const totalOpens = Object.values(usageData).reduce((sum, data) => sum + data.count, 0);
            const uniqueTools = Object.keys(usageData).length;
            const avgUsage = uniqueTools > 0 ? Math.round(totalOpens / uniqueTools) : 0;

            // Calculate streak
            const today = new Date().toDateString();
            const streak = localStorage.getItem('lastVisit') === today ?
                          parseInt(localStorage.getItem('visitStreak') || 0) : 0;

            // Update stats display
            document.getElementById('totalOpens').textContent = totalOpens;
            document.getElementById('uniqueTools').textContent = uniqueTools;
            document.getElementById('avgUsage').textContent = avgUsage;
            document.getElementById('streak').textContent = streak;

            // Create top tools chart
            createTopToolsChart();

            // Create category breakdown chart
            createCategoryChart();
        }

        function closeAnalytics() {
            document.getElementById('analyticsDashboard').classList.remove('active');
        }

        function createTopToolsChart() {
            const container = document.getElementById('topToolsChart');
            const topTools = Object.entries(usageData)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            if (topTools.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">No data yet</div>';
                return;
            }

            const maxCount = Math.max(...topTools.map(t => t[1].count));

            container.innerHTML = topTools.map(([filename, data]) => {
                const tool = allTools.find(t => t.filename === filename);
                const height = (data.count / maxCount) * 100;
                return `
                    <div class="chart-bar" style="height: ${height}%;">
                        <div class="chart-bar-value">${data.count}</div>
                        <div class="chart-bar-label">${tool?.title?.substring(0, 10) || filename.substring(0, 10)}...</div>
                    </div>
                `;
            }).join('');
        }

        function createCategoryChart() {
            const container = document.getElementById('categoryChart');
            const categoryUsage = {};

            Object.entries(usageData).forEach(([filename, data]) => {
                const tool = allTools.find(t => t.filename === filename);
                if (tool) {
                    categoryUsage[tool.categoryKey] = (categoryUsage[tool.categoryKey] || 0) + data.count;
                }
            });

            const categories = Object.entries(categoryUsage).sort((a, b) => b[1] - a[1]);

            if (categories.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">No data yet</div>';
                return;
            }

            const maxCount = Math.max(...categories.map(c => c[1]));

            container.innerHTML = categories.map(([category, count]) => {
                const height = (count / maxCount) * 100;
                const categoryData = galleryConfig?.vibeGallery?.categories[category];
                return `
                    <div class="chart-bar" style="height: ${height}%; background: ${categoryData?.color || 'var(--accent)'};">
                        <div class="chart-bar-value">${count}</div>
                        <div class="chart-bar-label">${categoryData?.title || category}</div>
                    </div>
                `;
            }).join('');
        }

        function exportAnalytics() {
            const report = {
                generated: new Date().toISOString(),
                totalOpens: Object.values(usageData).reduce((sum, data) => sum + data.count, 0),
                uniqueTools: Object.keys(usageData).length,
                topTools: Object.entries(usageData)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 20)
                    .map(([filename, data]) => ({
                        filename,
                        title: allTools.find(t => t.filename === filename)?.title,
                        count: data.count,
                        lastUsed: new Date(data.lastUsed).toISOString()
                    })),
                categoryBreakdown: {}
            };

            // Add category breakdown
            Object.entries(usageData).forEach(([filename, data]) => {
                const tool = allTools.find(t => t.filename === filename);
                if (tool) {
                    report.categoryBreakdown[tool.categoryKey] =
                        (report.categoryBreakdown[tool.categoryKey] || 0) + data.count;
                }
            });

            const csv = 'Tool,Count,Last Used\n' +
                       report.topTools.map(t => `"${t.title || t.filename}",${t.count},"${t.lastUsed}"`).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAnalytics() {
            if (!confirm('Clear all analytics data?')) return;
            usageData = {};
            localStorage.setItem('toolUsage', JSON.stringify(usageData));
            closeAnalytics();
            openAnalytics();
        }

        // Comparison Functions
        function toggleComparisonMode() {
            comparisonMode = !comparisonMode;
            const indicator = document.getElementById('comparisonIndicator');

            if (comparisonMode) {
                indicator.classList.add('active');
                comparisonTools = [];
                updateComparisonIndicator();

                // Add click handlers to tool cards
                document.querySelectorAll('.tool-card').forEach(card => {
                    card.style.cursor = 'crosshair';
                    card.onclick = (e) => {
                        if (!comparisonMode) return;
                        e.preventDefault();
                        const filename = card.querySelector('.tool-filename').textContent;
                        toggleComparisonTool(filename);
                    };
                });
            } else {
                indicator.classList.remove('active');
                document.querySelectorAll('.tool-card').forEach(card => {
                    card.style.cursor = 'pointer';
                    card.onclick = null;
                });
            }
        }

        function toggleComparisonTool(filename) {
            if (comparisonTools.includes(filename)) {
                comparisonTools = comparisonTools.filter(f => f !== filename);
            } else if (comparisonTools.length < 4) {
                comparisonTools.push(filename);
            } else {
                alert('Maximum 4 tools can be compared');
                return;
            }

            updateComparisonIndicator();

            if (comparisonTools.length >= 2) {
                showComparison();
            }
        }

        function updateComparisonIndicator() {
            const indicator = document.getElementById('comparisonIndicator');
            indicator.textContent = `Select tools to compare (${comparisonTools.length}/4 selected)`;
        }

        function showComparison() {
            const table = document.getElementById('comparisonTable');
            const grid = document.getElementById('comparisonGrid');

            const tools = comparisonTools.map(filename =>
                allTools.find(t => t.filename === filename)
            ).filter(Boolean);

            if (tools.length < 2) return;

            // Set CSS variable for grid columns
            grid.style.setProperty('--comparison-count', tools.length);

            // Build comparison table
            const rows = [
                ['Tool', ...tools.map(t => t.title)],
                ['Category', ...tools.map(t => t.categoryTitle || t.category)],
                ['Complexity', ...tools.map(t => t.complexity || 'Unknown')],
                ['Tags', ...tools.map(t => (t.tags || []).slice(0, 3).join(', '))],
                ['Usage', ...tools.map(t => usageData[t.filename]?.count || 0)],
                ['Votes', ...tools.map(t => votes[t.filename]?.count || 0)],
                ['Pinned', ...tools.map(t => pinnedTools.includes(t.filename) ? 'Yes' : 'No')]
            ];

            grid.innerHTML = rows.map((row, i) =>
                row.map((cell, j) => `
                    <div class="comparison-cell ${i === 0 ? 'comparison-header' : ''} ${j === 0 ? 'comparison-label' : ''}">
                        ${cell}
                    </div>
                `).join('')
            ).join('');

            table.classList.add('active');
        }

        function closeComparison() {
            document.getElementById('comparisonTable').classList.remove('active');
            toggleComparisonMode();
        }

        function clearComparison() {
            comparisonTools = [];
            updateComparisonIndicator();
            document.getElementById('comparisonGrid').innerHTML = '';
        }

        // Theme Functions
        function toggleThemeMenu() {
            document.getElementById('themeMenu').classList.toggle('active');
        }

        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);

            // Remove all theme classes
            document.body.classList.remove('light-theme', 'high-contrast');

            // Apply theme
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else if (theme === 'high-contrast') {
                document.body.classList.add('high-contrast');
            } else if (theme === 'auto') {
                if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                    document.body.classList.add('light-theme');
                }
            }

            // Update active state
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === theme);
            });

            document.getElementById('themeMenu').classList.remove('active');
        }

        function cycleTheme() {
            const themes = ['dark', 'light', 'high-contrast', 'auto'];
            const currentIndex = themes.indexOf(currentTheme);
            const nextTheme = themes[(currentIndex + 1) % themes.length];
            setTheme(nextTheme);
        }

        // Notification helper
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--accent)' : 'var(--accent-secondary)'};
                color: ${type === 'success' ? 'var(--bg-primary)' : 'white'};
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize theme on load
        function initTheme() {
            setTheme(currentTheme);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            await loadGalleryConfig();
            initEventListeners();

            // Update visit streak
            const today = new Date().toDateString();
            const lastVisit = localStorage.getItem('lastVisit');
            if (lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (lastVisit === yesterday.toDateString()) {
                    const streak = parseInt(localStorage.getItem('visitStreak') || 0) + 1;
                    localStorage.setItem('visitStreak', streak.toString());
                } else {
                    localStorage.setItem('visitStreak', '1');
                }
                localStorage.setItem('lastVisit', today);
            }
        });
    </script>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- 3D Gallery Script -->
    <script>
        // 3D Gallery functionality
        let threeScene = null;

        // Add 3D mode event listener
        const threeDButton = document.getElementById('3d-mode');
        if (threeDButton) {
            threeDButton.addEventListener('click', () => {
                const toolsContainer = document.getElementById('toolsContainer');
                const threeContainer = document.getElementById('three-container');

                // Hide main content
                if (toolsContainer) toolsContainer.style.display = 'none';

                // Show 3D container
                threeContainer.classList.add('active');

                // Update mode buttons
                document.querySelectorAll('.mode-button').forEach(b => b.classList.remove('active'));
                threeDButton.classList.add('active');

                // Initialize 3D gallery
                if (!threeScene && typeof THREE !== 'undefined') {
                    init3DGallery();
                }
            });
        }

        // Initialize 3D Gallery
        function init3DGallery() {
            if (threeScene) {
                threeScene.cleanup();
            }

            // Get current filtered tools
            const files = filteredTools.slice(0, 20).map(tool => ({
                path: tool.filename,
                pages_url: tool.filename,
                title: tool.title,
                description: tool.description,
                icon: tool.icon || getToolEmoji(tool)
            }));

            threeScene = new MinecraftGallery(files);
            threeScene.init();
        }

        // Minecraft-style 3D Gallery Class
        class MinecraftGallery {
            constructor(files) {
                this.files = files;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.artworks = [];
                this.raycaster = new THREE.Raycaster();
                this.moveSpeed = 0.2;
                this.lookSpeed = 0.002;

                // Movement state
                this.keys = { w: false, a: false, s: false, d: false };

                // Camera rotation
                this.rotation = { x: 0, y: 0 };

                this.isPointerLocked = false;
                this.createBackButton();
            }

            createBackButton() {
                const threeContainer = document.getElementById('three-container');
                if (!threeContainer.querySelector('.three-ui')) {
                    const ui = document.createElement('div');
                    ui.className = 'three-ui';
                    ui.style.cssText = 'position: absolute; top: 20px; left: 20px; z-index: 1001;';
                    ui.innerHTML = '<button class="mode-button" id="back-to-gallery" style="padding: 12px 30px;">‚Üê Back to Gallery</button>';
                    threeContainer.appendChild(ui);

                    const hint = document.createElement('div');
                    hint.style.cssText = 'position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.7); padding: 15px 30px; border-radius: 25px; font-size: 0.9em; color: rgba(255, 255, 255, 0.8); z-index: 1001; text-align: center;';
                    hint.textContent = 'Use WASD to move, Mouse to look around, Click on artworks to view';
                    threeContainer.appendChild(hint);

                    document.getElementById('back-to-gallery').addEventListener('click', () => {
                        document.getElementById('main-gallery').click();
                    });
                }
            }

            init() {
                const threeContainer = document.getElementById('three-container');

                // Scene
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.Fog(0x000000, 10, 100);

                // Camera
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 2, 10);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                threeContainer.appendChild(this.renderer.domElement);

                this.setupLighting();
                this.createGallery();
                this.setupEventListeners();
                this.animate();
            }

            setupLighting() {
                this.scene.add(new THREE.AmbientLight(0x404040, 0.5));

                const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
                dirLight.position.set(10, 20, 10);
                dirLight.castShadow = true;
                this.scene.add(dirLight);

                [0xff00ff, 0x00ffff, 0xffff00].forEach((color, i) => {
                    const light = new THREE.PointLight(color, 0.5, 10);
                    light.position.set(i * 10 - 10, 3, 0);
                    this.scene.add(light);
                });
            }

            createGallery() {
                // Floor
                const floor = new THREE.Mesh(
                    new THREE.BoxGeometry(100, 1, 100),
                    new THREE.MeshLambertMaterial({ color: 0x333333, emissive: 0x111111 })
                );
                floor.position.y = -0.5;
                floor.receiveShadow = true;
                this.scene.add(floor);

                this.createWalls();
                this.createArtworks();
                this.addDecorations();
            }

            createWalls() {
                const wallMat = new THREE.MeshLambertMaterial({ color: 0x666666, emissive: 0x222222 });

                [[100, 20, 1, 0, 10, -50], [1, 20, 100, -50, 10, 0], [1, 20, 100, 50, 10, 0]].forEach(w => {
                    const wall = new THREE.Mesh(new THREE.BoxGeometry(w[0], w[1], w[2]), wallMat);
                    wall.position.set(w[3], w[4], w[5]);
                    wall.castShadow = wall.receiveShadow = true;
                    this.scene.add(wall);
                });
            }

            createTextSprite(text, fontSize = 0.5) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.height = 256;

                ctx.fillStyle = 'rgba(0, 0, 0, 0)';
                ctx.fillRect(0, 0, 256, 256);
                ctx.font = `${256 * fontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'white';
                ctx.fillText(text, 128, 128);

                const texture = new THREE.CanvasTexture(canvas);
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
                sprite.scale.set(2, 2, 1);
                return sprite;
            }

            createArtworks() {
                const numArtworks = Math.min(this.files.length, 20);

                for (let i = 0; i < numArtworks; i++) {
                    const file = this.files[i];
                    const artworkGroup = new THREE.Group();

                    // Frame
                    const frame = new THREE.Mesh(
                        new THREE.BoxGeometry(4, 3, 0.2),
                        new THREE.MeshLambertMaterial({ color: 0x888888, emissive: 0x444444 })
                    );

                    // Canvas
                    const hue = Math.random();
                    const canvas = new THREE.Mesh(
                        new THREE.BoxGeometry(3.6, 2.6, 0.1),
                        new THREE.MeshLambertMaterial({
                            color: new THREE.Color().setHSL(hue, 0.7, 0.5),
                            emissive: new THREE.Color().setHSL(hue, 0.7, 0.3),
                            emissiveIntensity: 0.5
                        })
                    );
                    canvas.position.z = 0.1;
                    frame.add(canvas);

                    // Icon
                    const icon = this.createTextSprite(file.icon || 'üé®', 0.4);
                    icon.position.z = 0.2;
                    canvas.add(icon);

                    // Title
                    const title = file.title || 'Untitled';
                    const titleSprite = this.createTextSprite(
                        title.substring(0, 15) + (title.length > 15 ? '...' : ''),
                        0.15
                    );
                    titleSprite.position.y = -2;
                    titleSprite.position.z = 0.5;
                    frame.add(titleSprite);

                    artworkGroup.add(frame);

                    // Position in circle
                    const angle = (i / numArtworks) * Math.PI * 2;
                    const radius = 20;
                    artworkGroup.position.x = Math.cos(angle) * radius;
                    artworkGroup.position.z = Math.sin(angle) * radius;
                    artworkGroup.position.y = 3;
                    artworkGroup.rotation.y = -angle + Math.PI;

                    frame.castShadow = frame.receiveShadow = true;
                    frame.userData = {
                        url: file.pages_url || file.path,
                        title: file.title,
                        description: file.description,
                        icon: file.icon
                    };

                    this.artworks.push(frame);
                    this.scene.add(artworkGroup);
                }
            }

            addDecorations() {
                const decorMat = new THREE.MeshLambertMaterial({ color: 0x444444, emissive: 0x222222 });

                // Pillars
                for (let i = 0; i < 8; i++) {
                    const pillar = new THREE.Mesh(new THREE.BoxGeometry(2, 10, 2), decorMat);
                    const angle = (i / 8) * Math.PI * 2;
                    pillar.position.set(Math.cos(angle) * 30, 5, Math.sin(angle) * 30);
                    pillar.castShadow = pillar.receiveShadow = true;
                    this.scene.add(pillar);
                }

                // Floating cubes
                for (let i = 0; i < 20; i++) {
                    const size = Math.random() * 0.5 + 0.5;
                    const cube = new THREE.Mesh(
                        new THREE.BoxGeometry(size, size, size),
                        new THREE.MeshLambertMaterial({
                            color: new THREE.Color().setHSL(Math.random(), 0.7, 0.5),
                            emissive: new THREE.Color().setHSL(Math.random(), 0.7, 0.3),
                            emissiveIntensity: 0.3
                        })
                    );

                    cube.position.x = (Math.random() - 0.5) * 40;
                    cube.position.y = Math.random() * 10 + 10;
                    cube.position.z = (Math.random() - 0.5) * 40;
                    cube.rotation.x = Math.random() * Math.PI * 2;
                    cube.rotation.y = Math.random() * Math.PI * 2;
                    cube.userData.floatSpeed = Math.random() * 0.02 + 0.01;
                    cube.userData.rotateSpeed = Math.random() * 0.02 + 0.01;
                    cube.castShadow = true;
                    this.scene.add(cube);
                }
            }

            setupEventListeners() {
                window.addEventListener('keydown', (e) => {
                    if (e.key.toLowerCase() in this.keys) this.keys[e.key.toLowerCase()] = true;
                });

                window.addEventListener('keyup', (e) => {
                    if (e.key.toLowerCase() in this.keys) this.keys[e.key.toLowerCase()] = false;
                });

                this.renderer.domElement.addEventListener('click', () => {
                    if (!this.isPointerLocked) {
                        this.renderer.domElement.requestPointerLock();
                    } else {
                        // Check for artwork click
                        this.raycaster.setFromCamera(new THREE.Vector2(0, 0), this.camera);
                        const intersects = this.raycaster.intersectObjects(this.artworks, true);

                        if (intersects.length > 0) {
                            const artwork = intersects[0].object.parent || intersects[0].object;
                            if (artwork.userData?.url) {
                                window.open(artwork.userData.url, '_blank');
                            }
                        }
                    }
                });

                document.addEventListener('pointerlockchange', () => {
                    this.isPointerLocked = document.pointerLockElement === this.renderer.domElement;
                });

                document.addEventListener('mousemove', (e) => {
                    if (this.isPointerLocked) {
                        this.rotation.y -= e.movementX * this.lookSpeed;
                        this.rotation.x -= e.movementY * this.lookSpeed;
                        this.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, this.rotation.x));
                    }
                });

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            updateMovement() {
                const forward = new THREE.Vector3();
                const right = new THREE.Vector3();

                this.camera.getWorldDirection(forward);
                forward.y = 0;
                forward.normalize();
                right.crossVectors(forward, new THREE.Vector3(0, 1, 0));

                if (this.keys.w) this.camera.position.add(forward.multiplyScalar(this.moveSpeed));
                if (this.keys.s) this.camera.position.add(forward.multiplyScalar(-this.moveSpeed));
                if (this.keys.a) this.camera.position.add(right.multiplyScalar(-this.moveSpeed));
                if (this.keys.d) this.camera.position.add(right.multiplyScalar(this.moveSpeed));

                this.camera.rotation.order = 'YXZ';
                this.camera.rotation.y = this.rotation.y;
                this.camera.rotation.x = this.rotation.x;
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                this.updateMovement();

                // Animate floating cubes
                this.scene.children.forEach(child => {
                    if (child.userData.floatSpeed) {
                        child.position.y += Math.sin(Date.now() * child.userData.floatSpeed) * 0.01;
                        child.rotation.x += child.userData.rotateSpeed;
                        child.rotation.y += child.userData.rotateSpeed * 0.7;
                    }
                });

                this.renderer.render(this.scene, this.camera);
            }

            cleanup() {
                const threeContainer = document.getElementById('three-container');
                if (this.renderer?.domElement) {
                    threeContainer.removeChild(this.renderer.domElement);
                    this.renderer.dispose();
                }
                if (document.pointerLockElement) {
                    document.exitPointerLock();
                }
            }
        }

        // Update main gallery button to cleanup 3D scene
        const mainGalleryBtn = document.getElementById('main-gallery');
        if (mainGalleryBtn) {
            const originalClick = mainGalleryBtn.onclick;
            mainGalleryBtn.addEventListener('click', () => {
                const threeContainer = document.getElementById('three-container');
                const toolsContainer = document.getElementById('toolsContainer');

                threeContainer.classList.remove('active');
                if (toolsContainer) toolsContainer.style.display = 'block';

                if (threeScene) {
                    threeScene.cleanup();
                    threeScene = null;
                }
            });
        }
    </script>
</body>
</html>