<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Game Service - Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #808080;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .test-suite {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4ec9b0;
        }

        .test-suite h2 {
            color: #4ec9b0;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .test-case {
            background: #1e1e1e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 3px solid #3e3e3e;
        }

        .test-case.pass {
            border-left-color: #4ec9b0;
        }

        .test-case.fail {
            border-left-color: #f48771;
        }

        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #dcdcaa;
        }

        .test-result {
            font-size: 14px;
            margin-top: 5px;
        }

        .test-result.pass {
            color: #4ec9b0;
        }

        .test-result.fail {
            color: #f48771;
        }

        .test-output {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #808080;
            margin-top: 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .summary {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-value.pass {
            color: #4ec9b0;
        }

        .stat-value.fail {
            color: #f48771;
        }

        .stat-value.total {
            color: #569cd6;
        }

        .stat-label {
            font-size: 12px;
            color: #808080;
            text-transform: uppercase;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #1177bb;
        }

        .timestamp {
            color: #808080;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª GitHub Game Service - Test Suite</h1>
        <p class="subtitle">Automated tests for the GitHub game integration service</p>

        <button onclick="runAllTests()">â–¶ Run All Tests</button>

        <div id="testResults"></div>

        <div class="summary" id="summary">
            <div class="stat">
                <div class="stat-value total" id="totalTests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat">
                <div class="stat-value pass" id="passedTests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat">
                <div class="stat-value fail" id="failedTests">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script src="github-game-service.js"></script>
    <script>
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
            }

            describe(suiteName, fn) {
                const suite = {
                    name: suiteName,
                    tests: []
                };
                this.currentSuite = suite;
                this.tests.push(suite);
                fn();
            }

            it(testName, fn) {
                this.currentSuite.tests.push({
                    name: testName,
                    fn: fn
                });
            }

            async run() {
                this.results = [];
                const startTime = Date.now();

                for (const suite of this.tests) {
                    const suiteResults = {
                        name: suite.name,
                        tests: []
                    };

                    for (const test of suite.tests) {
                        const result = {
                            name: test.name,
                            pass: false,
                            error: null,
                            output: null
                        };

                        try {
                            const output = await test.fn();
                            result.pass = true;
                            result.output = output;
                        } catch (error) {
                            result.pass = false;
                            result.error = error.message;
                        }

                        suiteResults.tests.push(result);
                    }

                    this.results.push(suiteResults);
                }

                const endTime = Date.now();
                this.renderResults(endTime - startTime);
            }

            renderResults(duration) {
                const container = document.getElementById('testResults');
                container.innerHTML = '';

                let totalTests = 0;
                let passedTests = 0;
                let failedTests = 0;

                this.results.forEach(suite => {
                    const suiteDiv = document.createElement('div');
                    suiteDiv.className = 'test-suite';

                    const suiteTitle = document.createElement('h2');
                    suiteTitle.textContent = suite.name;
                    suiteDiv.appendChild(suiteTitle);

                    suite.tests.forEach(test => {
                        totalTests++;
                        if (test.pass) passedTests++;
                        else failedTests++;

                        const testDiv = document.createElement('div');
                        testDiv.className = `test-case ${test.pass ? 'pass' : 'fail'}`;

                        const testName = document.createElement('div');
                        testName.className = 'test-name';
                        testName.textContent = `${test.pass ? 'âœ“' : 'âœ—'} ${test.name}`;

                        const testResult = document.createElement('div');
                        testResult.className = `test-result ${test.pass ? 'pass' : 'fail'}`;
                        testResult.textContent = test.pass ? 'PASS' : `FAIL: ${test.error}`;

                        testDiv.appendChild(testName);
                        testDiv.appendChild(testResult);

                        if (test.output) {
                            const output = document.createElement('div');
                            output.className = 'test-output';
                            output.textContent = typeof test.output === 'object'
                                ? JSON.stringify(test.output, null, 2)
                                : test.output;
                            testDiv.appendChild(output);
                        }

                        suiteDiv.appendChild(testDiv);
                    });

                    container.appendChild(suiteDiv);
                });

                // Update summary
                document.getElementById('totalTests').textContent = totalTests;
                document.getElementById('passedTests').textContent = passedTests;
                document.getElementById('failedTests').textContent = failedTests;

                // Update timestamp
                document.getElementById('timestamp').textContent =
                    `Tests completed in ${duration}ms at ${new Date().toLocaleTimeString()}`;
            }
        }

        const runner = new TestRunner();

        // Test Suite: Game Class
        runner.describe('Game Class', () => {
            runner.it('should create a game with basic properties', () => {
                const game = new Game({
                    id: 'test-game',
                    name: 'Test Game',
                    description: 'A test game',
                    icon: 'ðŸŽ®',
                    category: 'arcade'
                });

                if (game.id !== 'test-game') throw new Error('ID mismatch');
                if (game.name !== 'Test Game') throw new Error('Name mismatch');
                if (game.icon !== 'ðŸŽ®') throw new Error('Icon mismatch');
                if (game.category !== 'arcade') throw new Error('Category mismatch');

                return `Game created: ${game.name}`;
            });

            runner.it('should use default values for missing properties', () => {
                const game = new Game({});

                if (game.name !== 'Unknown Game') throw new Error('Default name not applied');
                if (game.icon !== 'ðŸŽ®') throw new Error('Default icon not applied');
                if (game.author !== 'Unknown') throw new Error('Default author not applied');

                return `Defaults applied correctly`;
            });

            runner.it('should export to JSON correctly', () => {
                const game = new Game({
                    id: 'test',
                    name: 'Test',
                    code: '<html></html>'
                });

                const json = game.toJSON();

                if (!json.isLocal) throw new Error('isLocal not set in JSON');
                if (json.name !== 'Test') throw new Error('Name not in JSON');
                if (json.code !== '<html></html>') throw new Error('Code not in JSON');

                return `JSON export successful`;
            });
        });

        // Test Suite: GitHubService
        runner.describe('GitHubService', () => {
            runner.it('should format names correctly', () => {
                const tests = [
                    { input: 'snake-game', expected: 'Snake Game' },
                    { input: 'space_invaders', expected: 'Space Invaders' },
                    { input: 'tetris', expected: 'Tetris' }
                ];

                for (const test of tests) {
                    const result = GitHubService.formatName(test.input);
                    if (result !== test.expected) {
                        throw new Error(`Expected "${test.expected}", got "${result}"`);
                    }
                }

                return `All ${tests.length} name formatting tests passed`;
            });

            runner.it('should format file sizes correctly', () => {
                const tests = [
                    { input: 500, expected: '500 B' },
                    { input: 1024, expected: '1 KB' },
                    { input: 1536, expected: '2 KB' },
                    { input: 1048576, expected: '1 MB' }
                ];

                for (const test of tests) {
                    const result = GitHubService.formatFileSize(test.input);
                    if (result !== test.expected) {
                        throw new Error(`Expected "${test.expected}", got "${result}"`);
                    }
                }

                return `All ${tests.length} file size formatting tests passed`;
            });

            runner.it('should retrieve game info for known games', () => {
                const games = ['snake', 'tetris', 'pong', 'pacman'];
                const results = [];

                for (const game of games) {
                    const info = GitHubService.getGameInfo(game);
                    if (!info.icon) throw new Error(`No icon for ${game}`);
                    if (!info.description) throw new Error(`No description for ${game}`);
                    if (!info.name) throw new Error(`No name for ${game}`);
                    results.push(`${info.icon} ${info.name}`);
                }

                return `Retrieved info for: ${results.join(', ')}`;
            });

            runner.it('should return default info for unknown games', () => {
                const info = GitHubService.getGameInfo('unknown-game-xyz');

                if (info.icon !== 'ðŸŽ®') throw new Error('Default icon not returned');
                if (info.category !== 'arcade') throw new Error('Default category not returned');
                if (info.name !== null) throw new Error('Default name should be null');

                return `Default info returned correctly`;
            });

            runner.it('should fetch games from GitHub (async)', async () => {
                const games = await GitHubService.fetchGames();

                // This test will pass even if no games are returned (API error)
                // as the service is designed to return empty array on failure
                return `Fetched ${games.length} games from GitHub`;
            });
        });

        // Test Suite: LocalGameService
        runner.describe('LocalGameService', () => {
            runner.it('should get built-in Tetris game', () => {
                const tetris = LocalGameService.getBuiltInTetris();

                if (!tetris) throw new Error('Tetris not returned');
                if (tetris.id !== 'built-in-tetris') throw new Error('Wrong Tetris ID');
                if (!tetris.code) throw new Error('Tetris has no code');
                if (tetris.code.length < 1000) throw new Error('Tetris code seems incomplete');
                if (!tetris.code.includes('<!DOCTYPE html>')) throw new Error('Tetris code invalid');

                return `Tetris game loaded (${tetris.code.length} chars)`;
            });

            runner.it('should create game from JSON object', () => {
                const jsonData = {
                    name: 'Test Game',
                    code: '<html><body>Test</body></html>',
                    description: 'Test description',
                    icon: 'ðŸŽ®',
                    category: 'arcade'
                };

                const game = LocalGameService.createGameFromJSON(jsonData);

                if (!game.id) throw new Error('No ID generated');
                if (game.name !== 'Test Game') throw new Error('Name not preserved');
                if (!game.isLocal) throw new Error('isLocal not set');

                return `Game created from JSON with ID: ${game.id}`;
            });

            runner.it('should create game from JSON string', () => {
                const jsonString = JSON.stringify({
                    name: 'String Test',
                    code: '<html></html>'
                });

                const game = LocalGameService.createGameFromJSON(jsonString);

                if (game.name !== 'String Test') throw new Error('Name not parsed');

                return `Game created from JSON string`;
            });

            runner.it('should throw error for invalid JSON', () => {
                let errorThrown = false;

                try {
                    LocalGameService.createGameFromJSON({ name: 'No Code' });
                } catch (error) {
                    errorThrown = true;
                }

                if (!errorThrown) throw new Error('Should have thrown error for missing code');

                return `Correctly rejected invalid JSON`;
            });

            runner.it('should import games from multi-game JSON', () => {
                const exportData = {
                    version: '1.0',
                    games: [
                        { name: 'Game 1', code: '<html>1</html>' },
                        { name: 'Game 2', code: '<html>2</html>' }
                    ]
                };

                const games = LocalGameService.importGamesFromJSON(exportData);

                if (games.length !== 2) throw new Error(`Expected 2 games, got ${games.length}`);
                if (games[0].name !== 'Game 1') throw new Error('First game name wrong');
                if (games[1].name !== 'Game 2') throw new Error('Second game name wrong');

                return `Imported ${games.length} games successfully`;
            });

            runner.it('should import single game JSON', () => {
                const singleGame = {
                    name: 'Single Game',
                    code: '<html>single</html>'
                };

                const games = LocalGameService.importGamesFromJSON(singleGame);

                if (games.length !== 1) throw new Error(`Expected 1 game, got ${games.length}`);
                if (games[0].name !== 'Single Game') throw new Error('Game name wrong');

                return `Imported single game successfully`;
            });
        });

        // Test Suite: Integration Tests
        runner.describe('Integration Tests', () => {
            runner.it('should create, export, and import a game', () => {
                // Create a game
                const originalGame = new Game({
                    id: 'test-integration',
                    name: 'Integration Test Game',
                    code: '<html><body>Integration Test</body></html>',
                    description: 'Testing the full cycle',
                    icon: 'ðŸ§ª',
                    category: 'puzzle'
                });

                // Export to JSON
                const exported = originalGame.toJSON();

                // Import from JSON
                const imported = LocalGameService.createGameFromJSON(exported);

                // Verify
                if (imported.name !== originalGame.name) throw new Error('Name not preserved');
                if (imported.code !== originalGame.code) throw new Error('Code not preserved');
                if (imported.description !== originalGame.description) throw new Error('Description not preserved');
                if (imported.icon !== originalGame.icon) throw new Error('Icon not preserved');

                return `Full export/import cycle successful`;
            });

            runner.it('should handle multiple game round-trip', () => {
                const games = [
                    new Game({ name: 'Game A', code: '<html>A</html>' }),
                    new Game({ name: 'Game B', code: '<html>B</html>' }),
                    new Game({ name: 'Game C', code: '<html>C</html>' })
                ];

                // Create export format
                const exportData = {
                    version: '1.0',
                    games: games.map(g => g.toJSON())
                };

                // Import back
                const imported = LocalGameService.importGamesFromJSON(exportData);

                if (imported.length !== games.length) {
                    throw new Error(`Expected ${games.length} games, got ${imported.length}`);
                }

                return `${imported.length} games survived round-trip`;
            });
        });

        function runAllTests() {
            runner.run();
        }

        // Auto-run tests on page load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 100);
        });
    </script>
</body>
</html>
