<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step Sequencer Pro</title>
    <meta name="description" content="Professional 16-step sequencer with 8 instruments, pattern management, swing, velocity controls, Web Audio synthesis, and WAV export">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }
        #app {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(20, 20, 40, 0.95);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        #header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px 30px;
            border-bottom: 2px solid #00ff88;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { font-size: 24px; color: #00ff88; }
        #transport {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .transport-btn {
            padding: 10px 20px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .transport-btn:hover { background: #00dd77; }
        .transport-btn.stop { background: #ff6b6b; }
        .transport-btn.record { background: #ff006e; }
        #controls {
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
        }
        input[type="range"] {
            width: 120px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #00ff88;
            color: #e0e0e0;
            border-radius: 4px;
        }
        select {
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #00ff88;
            color: #e0e0e0;
            border-radius: 4px;
        }
        .value-display {
            color: #00ff88;
            font-weight: bold;
            font-size: 14px;
        }
        #sequencer {
            padding: 30px;
        }
        .track {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .track-label {
            width: 100px;
            font-size: 12px;
            font-weight: bold;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .track-mute {
            width: 30px;
            height: 30px;
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .track-mute.active {
            background: #ff6b6b;
            color: #fff;
        }
        .track-solo {
            width: 30px;
            height: 30px;
            background: rgba(255, 235, 59, 0.3);
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .track-solo.active {
            background: #ffeb3b;
            color: #000;
        }
        .steps {
            display: flex;
            gap: 5px;
            flex: 1;
        }
        .step {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
        }
        .step:hover {
            background: rgba(0, 255, 136, 0.2);
        }
        .step.active {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        .step.playing {
            border-color: #ffeb3b;
            animation: pulse 0.2s;
        }
        .step.beat-marker {
            border-left: 3px solid rgba(0, 255, 136, 0.5);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .velocity-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.3);
            height: 0%;
            transition: height 0.1s;
        }
        .step.active .velocity-bar {
            height: 100%;
            background: linear-gradient(to top, #00dd77, #00ff88);
        }
        #patterns {
            padding: 0 30px 30px;
        }
        .pattern-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .pattern-btn {
            padding: 10px 20px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .pattern-btn:hover { background: rgba(0, 255, 136, 0.3); }
        .pattern-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .pattern-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
        }
        .pattern-item:hover { border-color: #00ff88; }
        .pattern-item.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        .pattern-name {
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }
        .pattern-info {
            font-size: 11px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="header">
            <h1>üéõÔ∏è Step Sequencer Pro</h1>
            <div id="transport">
                <button class="transport-btn" onclick="togglePlay()">‚ñ∂Ô∏è Play</button>
                <button class="transport-btn stop" onclick="stop()">‚èπÔ∏è Stop</button>
                <button class="transport-btn" onclick="exportAudio()">üíæ Export WAV</button>
            </div>
        </div>

        <div id="controls">
            <div class="control-group">
                <label>BPM</label>
                <input type="number" id="bpm" min="60" max="200" value="120">
                <span class="value-display" id="bpmDisplay">120</span>
            </div>

            <div class="control-group">
                <label>Swing</label>
                <input type="range" id="swing" min="0" max="100" value="0">
                <span class="value-display" id="swingDisplay">0%</span>
            </div>

            <div class="control-group">
                <label>Master Volume</label>
                <input type="range" id="masterVolume" min="0" max="100" value="70">
                <span class="value-display" id="volumeDisplay">70%</span>
            </div>

            <div class="control-group">
                <label>Steps</label>
                <select id="stepCount">
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                    <option value="32">32</option>
                </select>
            </div>

            <div class="control-group">
                <label>Pattern</label>
                <select id="patternSelect"></select>
            </div>
        </div>

        <div id="sequencer"></div>

        <div id="patterns">
            <h3 style="color: #00ff88; margin-bottom: 15px;">Pattern Management</h3>
            <div class="pattern-controls">
                <button class="pattern-btn" onclick="newPattern()">‚ûï New Pattern</button>
                <button class="pattern-btn" onclick="duplicatePattern()">üìã Duplicate</button>
                <button class="pattern-btn" onclick="clearPattern()">üóëÔ∏è Clear</button>
                <button class="pattern-btn" onclick="randomize()">üé≤ Randomize</button>
                <button class="pattern-btn" onclick="savePatterns()">üíæ Save All</button>
            </div>
            <div class="pattern-list" id="patternList"></div>
        </div>
    </div>

    <script>
        let audioContext = null;
        let isPlaying = false;
        let currentStep = 0;
        let stepInterval = null;
        let nextStepTime = 0;
        let lookahead = 25; // ms
        let scheduleAheadTime = 0.1; // seconds

        const instruments = [
            { name: 'Kick', freq: 60, type: 'sine', decay: 0.5 },
            { name: 'Snare', freq: 200, type: 'noise', decay: 0.2 },
            { name: 'Hi-Hat', freq: 8000, type: 'noise', decay: 0.05 },
            { name: 'Clap', freq: 1000, type: 'noise', decay: 0.15 },
            { name: 'Tom', freq: 120, type: 'sine', decay: 0.4 },
            { name: 'Rim', freq: 3000, type: 'triangle', decay: 0.08 },
            { name: 'Cymbal', freq: 6000, type: 'noise', decay: 0.8 },
            { name: 'Bass', freq: 55, type: 'sawtooth', decay: 0.3 }
        ];

        let patterns = JSON.parse(localStorage.getItem('stepSequencerPatterns')) || [{
            name: 'Pattern 1',
            steps: Array(8).fill().map(() => Array(16).fill(0))
        }];

        let currentPatternIndex = 0;
        let params = {
            bpm: 120,
            swing: 0,
            masterVolume: 0.7,
            stepCount: 16
        };

        let mutedTracks = new Set();
        let soloTracks = new Set();

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(instrument, time, velocity = 1) {
            initAudio();

            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filterNode = audioContext.createBiquadFilter();

            if (instrument.type === 'noise') {
                // Use white noise for percussion
                const bufferSize = audioContext.sampleRate * 0.5;
                const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const noise = audioContext.createBufferSource();
                noise.buffer = buffer;

                filterNode.type = 'highpass';
                filterNode.frequency.value = instrument.freq;

                noise.connect(filterNode);
                filterNode.connect(gainNode);
                gainNode.connect(audioContext.destination);

                gainNode.gain.setValueAtTime(params.masterVolume * velocity, time);
                gainNode.gain.exponentialRampToValueAtTime(0.01, time + instrument.decay);

                noise.start(time);
                noise.stop(time + instrument.decay);
            } else {
                osc.type = instrument.type;
                osc.frequency.value = instrument.freq;

                if (instrument.name === 'Kick') {
                    osc.frequency.setValueAtTime(instrument.freq * 2, time);
                    osc.frequency.exponentialRampToValueAtTime(instrument.freq, time + 0.05);
                }

                osc.connect(gainNode);
                gainNode.connect(audioContext.destination);

                gainNode.gain.setValueAtTime(params.masterVolume * velocity, time);
                gainNode.gain.exponentialRampToValueAtTime(0.01, time + instrument.decay);

                osc.start(time);
                osc.stop(time + instrument.decay);
            }
        }

        function scheduler() {
            while (nextStepTime < audioContext.currentTime + scheduleAheadTime) {
                scheduleStep(currentStep, nextStepTime);
                nextStep();
            }
        }

        function scheduleStep(step, time) {
            const pattern = patterns[currentPatternIndex].steps;

            instruments.forEach((instrument, trackIndex) => {
                const velocity = pattern[trackIndex][step];

                if (velocity > 0 && !mutedTracks.has(trackIndex)) {
                    const shouldPlay = soloTracks.size === 0 || soloTracks.has(trackIndex);
                    if (shouldPlay) {
                        playSound(instrument, time, velocity);
                    }
                }
            });

            // Visual feedback
            setTimeout(() => {
                document.querySelectorAll('.step').forEach((el, index) => {
                    el.classList.remove('playing');
                    if (index % params.stepCount === step) {
                        el.classList.add('playing');
                    }
                });
            }, (time - audioContext.currentTime) * 1000);
        }

        function nextStep() {
            const secondsPerBeat = 60.0 / params.bpm;
            const swingAmount = params.swing / 100 * 0.5;

            if (currentStep % 2 === 1) {
                nextStepTime += (secondsPerBeat / 4) * (1 + swingAmount);
            } else {
                nextStepTime += (secondsPerBeat / 4) * (1 - swingAmount);
            }

            currentStep = (currentStep + 1) % params.stepCount;
        }

        function togglePlay() {
            if (!isPlaying) {
                initAudio();
                isPlaying = true;
                currentStep = 0;
                nextStepTime = audioContext.currentTime;
                stepInterval = setInterval(scheduler, lookahead);
                document.querySelector('.transport-btn').textContent = '‚è∏Ô∏è Pause';
            } else {
                isPlaying = false;
                clearInterval(stepInterval);
                document.querySelector('.transport-btn').textContent = '‚ñ∂Ô∏è Play';
            }
        }

        function stop() {
            isPlaying = false;
            clearInterval(stepInterval);
            currentStep = 0;
            document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
            document.querySelector('.transport-btn').textContent = '‚ñ∂Ô∏è Play';
        }

        function renderSequencer() {
            const container = document.getElementById('sequencer');
            container.innerHTML = '';

            const pattern = patterns[currentPatternIndex];

            instruments.forEach((instrument, trackIndex) => {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'track';

                const label = document.createElement('div');
                label.className = 'track-label';
                label.innerHTML = `
                    <span>${instrument.name}</span>
                `;

                const muteBtn = document.createElement('div');
                muteBtn.className = 'track-mute' + (mutedTracks.has(trackIndex) ? ' active' : '');
                muteBtn.textContent = 'M';
                muteBtn.onclick = () => toggleMute(trackIndex);

                const soloBtn = document.createElement('div');
                soloBtn.className = 'track-solo' + (soloTracks.has(trackIndex) ? ' active' : '');
                soloBtn.textContent = 'S';
                soloBtn.onclick = () => toggleSolo(trackIndex);

                label.prepend(soloBtn);
                label.prepend(muteBtn);

                const stepsDiv = document.createElement('div');
                stepsDiv.className = 'steps';

                for (let i = 0; i < params.stepCount; i++) {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step' + (i % 4 === 0 ? ' beat-marker' : '');
                    if (pattern.steps[trackIndex][i] > 0) {
                        stepDiv.classList.add('active');
                    }

                    const velocityBar = document.createElement('div');
                    velocityBar.className = 'velocity-bar';
                    velocityBar.style.height = (pattern.steps[trackIndex][i] * 100) + '%';
                    stepDiv.appendChild(velocityBar);

                    stepDiv.onclick = () => toggleStep(trackIndex, i);
                    stepsDiv.appendChild(stepDiv);
                }

                trackDiv.appendChild(label);
                trackDiv.appendChild(stepsDiv);
                container.appendChild(trackDiv);
            });
        }

        function toggleStep(track, step) {
            const pattern = patterns[currentPatternIndex];
            if (pattern.steps[track][step] === 0) {
                pattern.steps[track][step] = 1;
            } else {
                pattern.steps[track][step] = 0;
            }
            renderSequencer();
            savePatterns();
        }

        function toggleMute(track) {
            if (mutedTracks.has(track)) {
                mutedTracks.delete(track);
            } else {
                mutedTracks.add(track);
            }
            renderSequencer();
        }

        function toggleSolo(track) {
            if (soloTracks.has(track)) {
                soloTracks.delete(track);
            } else {
                soloTracks.add(track);
            }
            renderSequencer();
        }

        function newPattern() {
            const name = prompt('Pattern name:', `Pattern ${patterns.length + 1}`);
            if (name) {
                patterns.push({
                    name,
                    steps: Array(8).fill().map(() => Array(32).fill(0))
                });
                currentPatternIndex = patterns.length - 1;
                renderPatternList();
                renderSequencer();
                savePatterns();
            }
        }

        function duplicatePattern() {
            const current = patterns[currentPatternIndex];
            patterns.push({
                name: current.name + ' (copy)',
                steps: current.steps.map(row => [...row])
            });
            currentPatternIndex = patterns.length - 1;
            renderPatternList();
            renderSequencer();
            savePatterns();
        }

        function clearPattern() {
            if (confirm('Clear current pattern?')) {
                patterns[currentPatternIndex].steps = Array(8).fill().map(() => Array(32).fill(0));
                renderSequencer();
                savePatterns();
            }
        }

        function randomize() {
            const pattern = patterns[currentPatternIndex];
            pattern.steps.forEach((row, trackIndex) => {
                for (let i = 0; i < params.stepCount; i++) {
                    row[i] = Math.random() > 0.7 ? 1 : 0;
                }
            });
            renderSequencer();
            savePatterns();
        }

        function savePatterns() {
            localStorage.setItem('stepSequencerPatterns', JSON.stringify(patterns));
        }

        function renderPatternList() {
            const list = document.getElementById('patternList');
            const select = document.getElementById('patternSelect');

            list.innerHTML = patterns.map((p, i) => `
                <div class="pattern-item ${i === currentPatternIndex ? 'active' : ''}" onclick="selectPattern(${i})">
                    <div class="pattern-name">${p.name}</div>
                    <div class="pattern-info">${countSteps(p)} steps</div>
                </div>
            `).join('');

            select.innerHTML = patterns.map((p, i) => `
                <option value="${i}" ${i === currentPatternIndex ? 'selected' : ''}>${p.name}</option>
            `).join('');
        }

        function countSteps(pattern) {
            return pattern.steps.reduce((sum, row) => sum + row.filter(v => v > 0).length, 0);
        }

        function selectPattern(index) {
            currentPatternIndex = index;
            renderPatternList();
            renderSequencer();
        }

        function exportAudio() {
            alert('WAV export feature: This would record the pattern playback and export as WAV. Implementation requires MediaRecorder API with proper timing.');
        }

        // Event listeners
        document.getElementById('bpm').addEventListener('input', (e) => {
            params.bpm = parseInt(e.target.value);
            document.getElementById('bpmDisplay').textContent = params.bpm;
        });

        document.getElementById('swing').addEventListener('input', (e) => {
            params.swing = parseInt(e.target.value);
            document.getElementById('swingDisplay').textContent = params.swing + '%';
        });

        document.getElementById('masterVolume').addEventListener('input', (e) => {
            params.masterVolume = parseInt(e.target.value) / 100;
            document.getElementById('volumeDisplay').textContent = e.target.value + '%';
        });

        document.getElementById('stepCount').addEventListener('change', (e) => {
            params.stepCount = parseInt(e.target.value);
            renderSequencer();
        });

        document.getElementById('patternSelect').addEventListener('change', (e) => {
            selectPattern(parseInt(e.target.value));
        });

        // Initialize
        renderSequencer();
        renderPatternList();
    </script>
</body>
</html>