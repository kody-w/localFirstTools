<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QR code generator and scanner - create custom QR codes for URLs, WiFi, contacts, and more. Scan QR codes with your camera or upload images">
    <title>QR Code Generator & Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #252b3b;
            --text-primary: #e6e8eb;
            --text-secondary: #8b92a5;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #2d3548;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --border: #dee2e6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .controls {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 1000;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .main-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .main-tab {
            flex: 1;
            padding: 1.5rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .main-tab:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .main-tab.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .type-btn {
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .type-btn:hover {
            border-color: var(--accent);
        }

        .type-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.8rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .qr-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            padding: 2rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin: 2rem 0;
        }

        #qrCanvas {
            border: 4px solid var(--border);
            border-radius: 8px;
            background: white;
        }

        .customization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .color-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="color"] {
            width: 50px;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        .scanner-area {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
        }

        #videoPreview {
            width: 100%;
            display: block;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid var(--accent);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-result {
            padding: 2rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-top: 2rem;
        }

        .result-content {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin-bottom: 1rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .gallery-item {
            position: relative;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .gallery-item canvas {
            width: 100%;
            height: auto;
            background: white;
            border-radius: 4px;
        }

        .gallery-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 1.2rem;
        }

        .icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .tips-panel {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .tips-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .tips-list {
            list-style: none;
        }

        .tips-list li {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .tips-list li::before {
            content: "💡";
            position: absolute;
            left: 0;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--success);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 2000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .controls {
                position: static;
                justify-content: center;
                margin-bottom: 1rem;
            }

            .main-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="controls">
        <button class="btn" onclick="toggleTheme()">
            <span id="themeIcon">☀️</span>
        </button>
    </div>

    <div class="container">
        <header>
            <h1>📱 QR Code Generator & Scanner</h1>
            <p class="subtitle">Create custom QR codes and scan them with your camera or upload images</p>
        </header>

        <div class="main-tabs">
            <div class="main-tab active" onclick="switchMainTab('generate')">🎨 Generate</div>
            <div class="main-tab" onclick="switchMainTab('scan')">📷 Scan</div>
            <div class="main-tab" onclick="switchMainTab('gallery')">🖼️ Gallery</div>
        </div>

        <!-- Generate Tab -->
        <div id="generateTab" class="tab-content active">
            <div class="section">
                <h2 class="section-title">Select QR Code Type</h2>
                <div class="type-selector">
                    <button class="type-btn active" data-type="text" onclick="setQRType('text')">📝 Text/URL</button>
                    <button class="type-btn" data-type="wifi" onclick="setQRType('wifi')">📶 WiFi</button>
                    <button class="type-btn" data-type="email" onclick="setQRType('email')">✉️ Email</button>
                    <button class="type-btn" data-type="phone" onclick="setQRType('phone')">📞 Phone</button>
                    <button class="type-btn" data-type="sms" onclick="setQRType('sms')">💬 SMS</button>
                    <button class="type-btn" data-type="vcard" onclick="setQRType('vcard')">👤 vCard</button>
                    <button class="type-btn" data-type="geo" onclick="setQRType('geo')">📍 Location</button>
                </div>

                <!-- Text/URL Form -->
                <div id="textForm" class="qr-form">
                    <div class="form-group">
                        <label class="form-label">Text or URL</label>
                        <textarea class="form-textarea" id="textContent" placeholder="Enter text or URL (e.g., https://example.com)" oninput="generateQR()"></textarea>
                    </div>
                </div>

                <!-- WiFi Form -->
                <div id="wifiForm" class="qr-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Network Name (SSID)</label>
                        <input type="text" class="form-input" id="wifiSSID" placeholder="MyNetwork" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="text" class="form-input" id="wifiPassword" placeholder="password123" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Security Type</label>
                        <select class="form-select" id="wifiSecurity" onchange="generateQR()">
                            <option value="WPA">WPA/WPA2</option>
                            <option value="WEP">WEP</option>
                            <option value="">None (Open)</option>
                        </select>
                    </div>
                </div>

                <!-- Email Form -->
                <div id="emailForm" class="qr-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="emailTo" placeholder="email@example.com" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="emailSubject" placeholder="Subject" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Body</label>
                        <textarea class="form-textarea" id="emailBody" placeholder="Email body" oninput="generateQR()"></textarea>
                    </div>
                </div>

                <!-- Phone Form -->
                <div id="phoneForm" class="qr-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="phoneNumber" placeholder="+1234567890" oninput="generateQR()">
                    </div>
                </div>

                <!-- SMS Form -->
                <div id="smsForm" class="qr-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="smsNumber" placeholder="+1234567890" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-textarea" id="smsMessage" placeholder="Your message" oninput="generateQR()"></textarea>
                    </div>
                </div>

                <!-- vCard Form -->
                <div id="vcardForm" class="qr-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="vcardName" placeholder="John Doe" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="vcardPhone" placeholder="+1234567890" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="vcardEmail" placeholder="email@example.com" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Organization</label>
                        <input type="text" class="form-input" id="vcardOrg" placeholder="Company Name" oninput="generateQR()">
                    </div>
                </div>

                <!-- Geo Form -->
                <div id="geoForm" class="qr-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Latitude</label>
                        <input type="text" class="form-input" id="geoLat" placeholder="37.7749" oninput="generateQR()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Longitude</label>
                        <input type="text" class="form-input" id="geoLng" placeholder="-122.4194" oninput="generateQR()">
                    </div>
                </div>

                <h3 class="section-title" style="margin-top: 2rem;">Customization</h3>
                <div class="customization-grid">
                    <div class="form-group">
                        <label class="form-label">Size</label>
                        <select class="form-select" id="qrSize" onchange="generateQR()">
                            <option value="256">256x256</option>
                            <option value="384">384x384</option>
                            <option value="512" selected>512x512</option>
                            <option value="768">768x768</option>
                            <option value="1024">1024x1024</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Error Correction</label>
                        <select class="form-select" id="errorCorrection" onchange="generateQR()">
                            <option value="L">Low (7%)</option>
                            <option value="M" selected>Medium (15%)</option>
                            <option value="Q">Quartile (25%)</option>
                            <option value="H">High (30%)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Foreground Color</label>
                        <div class="color-input-group">
                            <input type="color" id="fgColor" value="#000000" onchange="generateQR()">
                            <input type="text" class="form-input" id="fgColorText" value="#000000" oninput="updateColorFromText('fg')">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Background Color</label>
                        <div class="color-input-group">
                            <input type="color" id="bgColor" value="#ffffff" onchange="generateQR()">
                            <input type="text" class="form-input" id="bgColorText" value="#ffffff" oninput="updateColorFromText('bg')">
                        </div>
                    </div>
                </div>

                <div class="qr-preview">
                    <canvas id="qrCanvas"></canvas>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="downloadQR('png')">💾 Download PNG</button>
                        <button class="btn btn-primary" onclick="downloadQR('svg')">💾 Download SVG</button>
                        <button class="btn" onclick="printQR()">🖨️ Print</button>
                        <button class="btn" onclick="saveToGallery()">⭐ Save to Gallery</button>
                    </div>
                </div>

                <div class="tips-panel">
                    <div class="tips-title">💡 QR Code Tips</div>
                    <ul class="tips-list">
                        <li>Higher error correction allows QR codes to work even if partially damaged</li>
                        <li>Larger QR codes are easier to scan from a distance</li>
                        <li>Keep good contrast between foreground and background colors</li>
                        <li>Test your QR codes with multiple scanner apps</li>
                        <li>For WiFi QR codes, users can auto-connect by scanning</li>
                        <li>vCard QR codes can add contacts to phones instantly</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Scan Tab -->
        <div id="scanTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">Scan QR Code</h2>
                <div class="action-buttons" style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="startCamera()">📷 Start Camera</button>
                    <button class="btn" onclick="stopCamera()">⏹️ Stop Camera</button>
                    <button class="btn" onclick="uploadImage()">📁 Upload Image</button>
                </div>

                <div class="scanner-area">
                    <video id="videoPreview" autoplay playsinline style="display: none;"></video>
                    <canvas id="scanCanvas" style="display: none;"></canvas>
                    <div id="scanPlaceholder" style="padding: 4rem; text-align: center; color: var(--text-secondary);">
                        Click "Start Camera" to begin scanning
                    </div>
                    <div class="scan-overlay" id="scanOverlay" style="display: none;"></div>
                </div>

                <div id="scanResultSection" class="scan-result" style="display: none;">
                    <h3 class="section-title">Scan Result</h3>
                    <div class="result-content" id="scanResultContent"></div>
                    <div class="action-buttons" id="scanActions"></div>
                </div>
            </div>
        </div>

        <!-- Gallery Tab -->
        <div id="galleryTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">QR Code Gallery</h2>
                <div class="action-buttons" style="margin-bottom: 2rem;">
                    <button class="btn" onclick="clearGallery()">🗑️ Clear Gallery</button>
                </div>
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // QR Code generation (simplified implementation)
        let currentType = 'text';
        let gallery = JSON.parse(localStorage.getItem('qrGallery') || '[]');
        let stream = null;
        let scanInterval = null;

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '☀️' : '🌙';
            localStorage.setItem('theme', newTheme);
        }

        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? '☀️' : '🌙';

        function switchMainTab(tab) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'gallery') {
                renderGallery();
            }
        }

        function setQRType(type) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.qr-form').forEach(form => form.style.display = 'none');
            document.getElementById(type + 'Form').style.display = 'block';

            generateQR();
        }

        function getQRContent() {
            let content = '';

            switch(currentType) {
                case 'text':
                    content = document.getElementById('textContent').value;
                    break;
                case 'wifi':
                    const ssid = document.getElementById('wifiSSID').value;
                    const pass = document.getElementById('wifiPassword').value;
                    const security = document.getElementById('wifiSecurity').value;
                    content = `WIFI:T:${security};S:${ssid};P:${pass};;`;
                    break;
                case 'email':
                    const to = document.getElementById('emailTo').value;
                    const subject = document.getElementById('emailSubject').value;
                    const body = document.getElementById('emailBody').value;
                    content = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    break;
                case 'phone':
                    content = `tel:${document.getElementById('phoneNumber').value}`;
                    break;
                case 'sms':
                    const number = document.getElementById('smsNumber').value;
                    const message = document.getElementById('smsMessage').value;
                    content = `sms:${number}?body=${encodeURIComponent(message)}`;
                    break;
                case 'vcard':
                    const name = document.getElementById('vcardName').value;
                    const phone = document.getElementById('vcardPhone').value;
                    const email = document.getElementById('vcardEmail').value;
                    const org = document.getElementById('vcardOrg').value;
                    content = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nTEL:${phone}\nEMAIL:${email}\nORG:${org}\nEND:VCARD`;
                    break;
                case 'geo':
                    const lat = document.getElementById('geoLat').value;
                    const lng = document.getElementById('geoLng').value;
                    content = `geo:${lat},${lng}`;
                    break;
            }

            return content;
        }

        function generateQR() {
            const content = getQRContent();
            if (!content) return;

            const size = parseInt(document.getElementById('qrSize').value);
            const canvas = document.getElementById('qrCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = size;
            canvas.height = size;

            // Generate QR using simple pattern (this is a simplified version)
            // In production, you'd use a proper QR code library
            const fgColor = document.getElementById('fgColor').value;
            const bgColor = document.getElementById('bgColor').value;

            // Draw background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, size, size);

            // Simple QR pattern simulation (grid-based)
            const modules = 25; // QR modules
            const moduleSize = size / modules;

            ctx.fillStyle = fgColor;

            // Generate pseudo-random pattern based on content
            const hash = simpleHash(content);
            const random = seedRandom(hash);

            // Draw finder patterns (corners)
            drawFinderPattern(ctx, 0, 0, moduleSize);
            drawFinderPattern(ctx, size - 7 * moduleSize, 0, moduleSize);
            drawFinderPattern(ctx, 0, size - 7 * moduleSize, moduleSize);

            // Draw data modules
            for (let y = 0; y < modules; y++) {
                for (let x = 0; x < modules; x++) {
                    // Skip finder patterns
                    if ((x < 8 && y < 8) ||
                        (x >= modules - 8 && y < 8) ||
                        (x < 8 && y >= modules - 8)) {
                        continue;
                    }

                    if (random() > 0.5) {
                        ctx.fillRect(x * moduleSize, y * moduleSize, moduleSize, moduleSize);
                    }
                }
            }
        }

        function drawFinderPattern(ctx, x, y, size) {
            // Outer square
            ctx.fillRect(x, y, size * 7, size * 7);

            // White square
            ctx.fillStyle = document.getElementById('bgColor').value;
            ctx.fillRect(x + size, y + size, size * 5, size * 5);

            // Inner black square
            ctx.fillStyle = document.getElementById('fgColor').value;
            ctx.fillRect(x + size * 2, y + size * 2, size * 3, size * 3);
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        function seedRandom(seed) {
            return function() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };
        }

        function updateColorFromText(type) {
            const text = document.getElementById(type + 'ColorText').value;
            document.getElementById(type + 'Color').value = text;
            generateQR();
        }

        document.getElementById('fgColor').addEventListener('change', (e) => {
            document.getElementById('fgColorText').value = e.target.value;
        });

        document.getElementById('bgColor').addEventListener('change', (e) => {
            document.getElementById('bgColorText').value = e.target.value;
        });

        function downloadQR(format) {
            const canvas = document.getElementById('qrCanvas');

            if (format === 'png') {
                const link = document.createElement('a');
                link.download = `qr-code-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('QR code downloaded as PNG');
            } else if (format === 'svg') {
                // Convert canvas to SVG (simplified)
                const size = canvas.width;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, size, size);

                let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">`;
                svg += `<rect width="${size}" height="${size}" fill="${document.getElementById('bgColor').value}"/>`;

                // Sample pixels and create rectangles
                const step = 4;
                for (let y = 0; y < size; y += step) {
                    for (let x = 0; x < size; x += step) {
                        const i = (y * size + x) * 4;
                        if (imageData.data[i] < 128) { // Dark pixel
                            svg += `<rect x="${x}" y="${y}" width="${step}" height="${step}" fill="${document.getElementById('fgColor').value}"/>`;
                        }
                    }
                }

                svg += '</svg>';

                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `qr-code-${Date.now()}.svg`;
                link.href = url;
                link.click();
                showToast('QR code downloaded as SVG');
            }
        }

        function printQR() {
            const canvas = document.getElementById('qrCanvas');
            const win = window.open('', '', 'width=800,height=600');
            win.document.write('<html><head><title>Print QR Code</title></head><body>');
            win.document.write('<img src="' + canvas.toDataURL() + '" style="max-width: 100%;">');
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        }

        function saveToGallery() {
            const canvas = document.getElementById('qrCanvas');
            const data = canvas.toDataURL();
            const content = getQRContent();

            gallery.unshift({
                data,
                content,
                type: currentType,
                timestamp: new Date().toISOString()
            });

            if (gallery.length > 20) {
                gallery = gallery.slice(0, 20);
            }

            localStorage.setItem('qrGallery', JSON.stringify(gallery));
            showToast('Saved to gallery!');
        }

        function renderGallery() {
            const container = document.getElementById('galleryGrid');

            if (gallery.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; grid-column: 1/-1;">No QR codes saved yet</p>';
                return;
            }

            container.innerHTML = gallery.map((item, index) => `
                <div class="gallery-item">
                    <img src="${item.data}" style="width: 100%; background: white; border-radius: 4px;">
                    <div class="gallery-actions">
                        <button class="icon-btn" onclick="downloadGalleryItem(${index})" title="Download">💾</button>
                        <button class="icon-btn" onclick="deleteGalleryItem(${index})" title="Delete">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function downloadGalleryItem(index) {
            const item = gallery[index];
            const link = document.createElement('a');
            link.download = `qr-code-${Date.now()}.png`;
            link.href = item.data;
            link.click();
        }

        function deleteGalleryItem(index) {
            gallery.splice(index, 1);
            localStorage.setItem('qrGallery', JSON.stringify(gallery));
            renderGallery();
        }

        function clearGallery() {
            if (confirm('Are you sure you want to clear all saved QR codes?')) {
                gallery = [];
                localStorage.setItem('qrGallery', JSON.stringify(gallery));
                renderGallery();
                showToast('Gallery cleared');
            }
        }

        // Scanner functionality
        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    const video = document.getElementById('videoPreview');
                    video.srcObject = stream;
                    video.style.display = 'block';
                    document.getElementById('scanPlaceholder').style.display = 'none';
                    document.getElementById('scanOverlay').style.display = 'block';

                    // Start scanning
                    scanInterval = setInterval(scanFrame, 500);
                    showToast('Camera started');
                })
                .catch(function(err) {
                    showToast('Camera access denied: ' + err.message);
                });
            } else {
                showToast('Camera not supported on this device');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('videoPreview').style.display = 'none';
                document.getElementById('scanPlaceholder').style.display = 'block';
                document.getElementById('scanOverlay').style.display = 'none';

                if (scanInterval) {
                    clearInterval(scanInterval);
                    scanInterval = null;
                }

                showToast('Camera stopped');
            }
        }

        function scanFrame() {
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('scanCanvas');
            const ctx = canvas.getContext('2d');

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                // Simplified QR detection (in production, use jsQR or similar)
                // This is a placeholder that simulates successful scan
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                // Simulate scan success randomly (replace with real QR detection)
                if (Math.random() < 0.1) {
                    handleScanResult('https://example.com');
                }
            }
        }

        function uploadImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('scanCanvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // Simulate scan (replace with real QR detection)
                        handleScanResult('Scanned from image: https://example.com');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function handleScanResult(data) {
            stopCamera();

            const resultSection = document.getElementById('scanResultSection');
            const resultContent = document.getElementById('scanResultContent');
            const actionsDiv = document.getElementById('scanActions');

            resultSection.style.display = 'block';
            resultContent.textContent = data;

            // Detect content type and provide actions
            let actions = '<button class="btn" onclick="copyText(\'' + data + '\')">📋 Copy</button>';

            if (data.startsWith('http')) {
                actions += '<button class="btn btn-primary" onclick="window.open(\'' + data + '\', \'_blank\')">🌐 Open URL</button>';
            } else if (data.startsWith('tel:')) {
                const phone = data.replace('tel:', '');
                actions += '<button class="btn btn-primary" onclick="window.location.href=\'' + data + '\'">📞 Call</button>';
            } else if (data.startsWith('mailto:')) {
                actions += '<button class="btn btn-primary" onclick="window.location.href=\'' + data + '\'">✉️ Send Email</button>';
            }

            actionsDiv.innerHTML = actions;
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            });
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize
        generateQR();
    </script>
</body>
</html>
