<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroOS Arcade - Browser-Based Operating Systems</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #6366f1, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: #a0a0a0;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            color: #fff;
            background: rgba(99, 102, 241, 0.2);
        }

        /* Main Content */
        .main-content {
            display: flex;
            height: calc(100vh - 73px);
        }

        /* Sidebar - OS Selection */
        .sidebar {
            width: 360px;
            background: rgba(20, 20, 30, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            overflow-y: auto;
            padding: 1rem;
            transition: transform 0.3s;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
            position: absolute;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
        }

        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-pill {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-pill:hover, .filter-pill.active {
            background: rgba(99, 102, 241, 0.3);
            border-color: #6366f1;
            color: #fff;
        }

        /* OS Cards */
        .os-card {
            background: linear-gradient(135deg, rgba(30, 30, 45, 0.9) 0%, rgba(25, 25, 35, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .os-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .os-card:hover {
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
        }

        .os-card:hover::before {
            opacity: 1;
        }

        .os-card.selected {
            border-color: #6366f1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(30, 30, 45, 0.9) 100%);
        }

        .os-card.selected::before {
            opacity: 1;
        }

        .os-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .os-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .os-icon.linux { background: linear-gradient(135deg, #f9a825, #ff8f00); }
        .os-icon.bsd { background: linear-gradient(135deg, #e53935, #c62828); }
        .os-icon.dos { background: linear-gradient(135deg, #1565c0, #0d47a1); }
        .os-icon.windows { background: linear-gradient(135deg, #00a8e8, #0077b6); }
        .os-icon.other { background: linear-gradient(135deg, #7cb342, #558b2f); }
        .os-icon.games { background: linear-gradient(135deg, #9c27b0, #6a1b9a); }

        .os-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #fff;
        }

        .os-meta {
            display: flex;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: #666;
        }

        .os-tag {
            padding: 0.15rem 0.4rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .os-description {
            font-size: 0.8rem;
            color: #888;
            line-height: 1.4;
        }

        /* Emulator View */
        .emulator-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }

        /* Control Bar */
        .control-bar {
            background: linear-gradient(180deg, rgba(30, 30, 40, 0.95) 0%, rgba(20, 20, 30, 0.95) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .control-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: #6366f1;
            color: #fff;
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-color: transparent;
            color: #fff;
        }

        .control-btn.primary:hover {
            background: linear-gradient(135deg, #7c7ff2, #9d7df7);
        }

        .control-btn.danger {
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }

        .control-btn.danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .scale-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scale-control label {
            font-size: 0.8rem;
            color: #888;
        }

        .scale-slider {
            width: 100px;
            accent-color: #6366f1;
        }

        .scale-value {
            font-size: 0.8rem;
            color: #6366f1;
            min-width: 35px;
        }

        /* Screen Container */
        .screen-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, #111 0%, #000 100%);
            overflow: hidden;
            position: relative;
        }

        #screen_container {
            position: relative;
            background: #000;
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        #screen_container canvas {
            display: block;
        }

        /* Welcome Screen */
        .welcome-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
            text-align: center;
            padding: 2rem;
        }

        .welcome-screen.hidden {
            display: none;
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #fff;
        }

        .welcome-subtitle {
            color: #666;
            font-size: 0.95rem;
            max-width: 400px;
        }

        /* Stats Panel */
        .stats-panel {
            background: rgba(15, 15, 25, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .stats-group {
            display: flex;
            gap: 1.5rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            color: #6366f1;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-weight: 500;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.running {
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            animation: pulse 2s infinite;
        }

        .status-dot.paused {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #888;
            font-size: 0.9rem;
        }

        .loading-progress {
            margin-top: 1rem;
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            width: 0%;
            transition: width 0.3s;
        }

        /* Fullscreen */
        .emulator-container:fullscreen {
            background: #000;
        }

        .emulator-container:fullscreen .control-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .emulator-container:fullscreen .control-bar:hover {
            opacity: 1;
        }

        .emulator-container:fullscreen .stats-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .emulator-container:fullscreen .stats-panel:hover {
            opacity: 1;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                position: absolute;
                z-index: 50;
                height: calc(100vh - 73px);
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .control-bar {
                padding: 0.5rem;
            }

            .control-btn span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">&#x1F4BB;</div>
            <span class="logo-text">RetroOS Arcade</span>
        </div>
        <nav class="nav-links">
            <a href="#" class="nav-link active" id="toggleSidebar">OS Library</a>
            <a href="index.html" class="nav-link">Classic View</a>
        </nav>
    </header>

    <main class="main-content">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Select Operating System</span>
            </div>

            <div class="filter-pills">
                <button class="filter-pill active" data-filter="all">All</button>
                <button class="filter-pill" data-filter="linux">Linux</button>
                <button class="filter-pill" data-filter="bsd">BSD/Unix</button>
                <button class="filter-pill" data-filter="dos">DOS</button>
                <button class="filter-pill" data-filter="windows">Windows</button>
                <button class="filter-pill" data-filter="other">Hobby OS</button>
                <button class="filter-pill" data-filter="games">Games/Demos</button>
            </div>

            <div class="os-list" id="osList">
                <!-- OS cards will be populated by JavaScript -->
            </div>
        </aside>

        <section class="emulator-container" id="emulatorContainer">
            <div class="control-bar">
                <div class="control-group">
                    <button class="control-btn primary" id="btnStart" disabled>
                        <span>&#9654;</span> <span>Start</span>
                    </button>
                    <button class="control-btn" id="btnPause" disabled>
                        <span>&#10074;&#10074;</span> <span>Pause</span>
                    </button>
                    <button class="control-btn danger" id="btnReset" disabled>
                        <span>&#8635;</span> <span>Reset</span>
                    </button>
                </div>

                <div class="control-group">
                    <button class="control-btn" id="btnCtrlAltDel" disabled>Ctrl+Alt+Del</button>
                    <button class="control-btn" id="btnFullscreen">
                        <span>&#x26F6;</span> <span>Fullscreen</span>
                    </button>
                    <button class="control-btn" id="btnScreenshot" disabled>
                        <span>&#128247;</span> <span>Screenshot</span>
                    </button>
                </div>

                <div class="scale-control">
                    <label>Scale:</label>
                    <input type="range" class="scale-slider" id="scaleSlider" min="0.5" max="2" step="0.1" value="1">
                    <span class="scale-value" id="scaleValue">1.0x</span>
                </div>
            </div>

            <div class="screen-wrapper">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">&#128421;</div>
                    <h2 class="welcome-title">Select an Operating System</h2>
                    <p class="welcome-subtitle">Choose from the sidebar to boot a classic operating system directly in your browser</p>
                </div>

                <div class="loading-overlay hidden" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text" id="loadingText">Initializing...</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar" id="loadingProgress"></div>
                    </div>
                </div>

                <div id="screen_container">
                    <div id="screen"></div>
                    <canvas id="vga"></canvas>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stats-group">
                    <div class="stat-item">
                        <span class="stat-label">Runtime:</span>
                        <span class="stat-value" id="statRuntime">0:00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Speed:</span>
                        <span class="stat-value" id="statSpeed">0 MIPS</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg:</span>
                        <span class="stat-value" id="statAvgSpeed">0 MIPS</span>
                    </div>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span class="stat-label" id="statusText">Ready</span>
                </div>
            </div>
        </section>
    </main>

    <script src="build/libv86.js"></script>
    <script>
        // Operating System Database
        // CDN for images we don't have locally
        const CDN = 'https://i.copy.sh/';
        const LOCAL = 'images/';

        const OS_DATABASE = [
            // ═══════════════════════════════════════════════════════════
            // LINUX DISTRIBUTIONS
            // ═══════════════════════════════════════════════════════════
            {
                id: 'dsl',
                name: 'Damn Small Linux',
                description: 'A 50MB live CD Linux distro with JWM desktop - great for old hardware',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['GUI', 'CD', '50MB'],
                config: {
                    cdrom: { url: LOCAL + 'dsl-4.11.rc2.iso' },
                    memory_size: 256 * 1024 * 1024,
                    vga_memory_size: 8 * 1024 * 1024
                }
            },
            {
                id: 'archlinux',
                name: 'Arch Linux',
                description: 'A lightweight and flexible Linux distribution (with saved state)',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['GUI', '512MB', 'Modern'],
                config: {
                    memory_size: 512 * 1024 * 1024,
                    vga_memory_size: 8 * 1024 * 1024,
                    state: { url: CDN + 'arch_state-v3.bin.zst' },
                    filesystem: { baseurl: CDN + 'arch/' }
                }
            },
            {
                id: 'buildroot',
                name: 'Buildroot Linux',
                description: 'Minimal Linux system built with Buildroot - fast boot',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', '5MB', 'Fast'],
                config: {
                    bzimage: { url: LOCAL + 'buildroot-bzimage.bin' },
                    memory_size: 64 * 1024 * 1024,
                    cmdline: 'tsc=reliable mitigations=off random.trust_cpu=on'
                }
            },
            {
                id: 'buildroot6',
                name: 'Buildroot Linux 6.8',
                description: 'Latest Buildroot with modern Linux kernel 6.8',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', '10MB', 'Modern'],
                config: {
                    bzimage: { url: LOCAL + 'buildroot-bzimage68.bin' },
                    memory_size: 128 * 1024 * 1024,
                    cmdline: 'tsc=reliable mitigations=off random.trust_cpu=on'
                }
            },
            {
                id: 'linux26',
                name: 'Linux 2.6',
                description: 'Classic Linux 2.6 kernel live CD',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', 'CD', '6MB'],
                config: {
                    cdrom: { url: LOCAL + 'linux.iso' },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'linux3',
                name: 'Linux 3.x',
                description: 'Linux 3.x kernel live CD',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', 'CD', '8MB'],
                config: {
                    cdrom: { url: LOCAL + 'linux3.iso' },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'linux4',
                name: 'Linux 4.x',
                description: 'Linux 4.x kernel live CD with filesystem support',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', 'CD', '8MB'],
                config: {
                    cdrom: { url: LOCAL + 'linux4.iso' },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'basiclinux',
                name: 'BasicLinux',
                description: 'A minimalist Linux distribution that fits on a floppy',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', 'HD', '100MB'],
                config: {
                    hda: { url: LOCAL + 'bl3-5.img', size: 104857600 },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'xpud',
                name: 'xPUD',
                description: 'Lightweight Linux with quick boot and Firefox',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['GUI', 'CD', '64MB'],
                config: {
                    cdrom: { url: LOCAL + 'xpud-0.9.2.iso', size: 67108864 },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'elks',
                name: 'ELKS',
                description: 'Embeddable Linux Kernel Subset - runs on 8086 PCs',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', 'HD', '16-bit'],
                config: {
                    hda: { url: LOCAL + 'elks-hd32-fat.img', size: 32514048 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'nodeos',
                name: 'NodeOS',
                description: 'A Linux distribution built entirely in Node.js',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', '14MB', 'Node.js'],
                config: {
                    bzimage: { url: LOCAL + 'nodeos-kernel.bin', size: 14452000 },
                    memory_size: 128 * 1024 * 1024,
                    cmdline: 'tsc=reliable mitigations=off random.trust_cpu=on'
                }
            },
            {
                id: 'xwoaf',
                name: 'xwoaf',
                description: 'X Windows On A Floppy - minimal X11 environment',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['GUI', 'CD', '2MB'],
                config: {
                    cdrom: { url: LOCAL + 'xwoaf_rebuild4.iso', size: 2205696 },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'openwrt',
                name: 'OpenWrt',
                description: 'Linux distribution for embedded network devices',
                category: 'linux',
                icon: '&#x1F427;',
                tags: ['CLI', 'HD', '19MB'],
                config: {
                    hda: { url: LOCAL + 'openwrt-18.06.1-x86-legacy-combined-squashfs.img', size: 19846474 },
                    memory_size: 128 * 1024 * 1024
                }
            },

            // ═══════════════════════════════════════════════════════════
            // BSD & UNIX
            // ═══════════════════════════════════════════════════════════
            {
                id: 'freebsd',
                name: 'FreeBSD',
                description: 'Advanced open source Unix-like operating system (with state)',
                category: 'bsd',
                icon: '&#x1F608;',
                tags: ['CLI', 'HD', '2GB'],
                config: {
                    hda: { url: CDN + 'freebsd/.img', size: 2147483648, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    state: { url: CDN + 'freebsd_state-v2.bin.zst' },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'openbsd',
                name: 'OpenBSD',
                description: 'Security-focused Unix-like operating system (with state)',
                category: 'bsd',
                icon: '&#x1F421;',
                tags: ['CLI', 'HD', '1GB'],
                config: {
                    hda: { url: CDN + 'openbsd/.img', size: 1073741824, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    state: { url: CDN + 'openbsd_state-v2.bin.zst' },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'netbsd',
                name: 'NetBSD',
                description: 'Portable Unix-like operating system',
                category: 'bsd',
                icon: '&#x1F3C1;',
                tags: ['CLI', 'HD', '500MB'],
                config: {
                    hda: { url: CDN + 'netbsd/.img', size: 511000064, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'minix',
                name: 'Minix 3',
                description: 'Microkernel-based Unix-like OS, inspired Linux',
                category: 'bsd',
                icon: '&#x1F9EC;',
                tags: ['CLI', 'CD', '577MB'],
                config: {
                    cdrom: { url: CDN + 'minix-3.3.0/.iso', size: 605581312, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'unix-v7',
                name: 'Unix V7',
                description: 'Historic Unix Version 7 from Bell Labs (1979)',
                category: 'bsd',
                icon: '&#x1F4DC;',
                tags: ['CLI', 'HD', 'Historic'],
                config: {
                    hda: { url: CDN + 'unix-v7x86-0.8a/.img', size: 152764416, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 64 * 1024 * 1024
                }
            },

            // ═══════════════════════════════════════════════════════════
            // DOS & COMMAND LINE
            // ═══════════════════════════════════════════════════════════
            {
                id: 'freedos',
                name: 'FreeDOS',
                description: 'Open source DOS-compatible operating system',
                category: 'dos',
                icon: '&#x1F4BE;',
                tags: ['CLI', 'Floppy', '<1MB'],
                config: {
                    fda: { url: LOCAL + 'freedos722.img' },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'msdos',
                name: 'MS-DOS 6.22',
                description: 'The last standalone version of Microsoft DOS',
                category: 'dos',
                icon: '&#x1F4BE;',
                tags: ['CLI', 'HD', '64MB'],
                config: {
                    hda: { url: CDN + 'msdos622/.img', size: 64 * 1024 * 1024, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'msdos4',
                name: 'MS-DOS 4',
                description: 'Early version of Microsoft DOS from 1988',
                category: 'dos',
                icon: '&#x1F4BE;',
                tags: ['CLI', 'Floppy', 'Historic'],
                config: {
                    fda: { url: LOCAL + 'msdos4.img', size: 1474560 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: '86dos',
                name: '86-DOS',
                description: 'The precursor to MS-DOS, originally called QDOS',
                category: 'dos',
                icon: '&#x1F4BE;',
                tags: ['CLI', 'Floppy', 'Historic'],
                config: {
                    fda: { url: LOCAL + 'pc86dos.img', size: 163840 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'freegem',
                name: 'FreeDOS + FreeGEM',
                description: 'FreeDOS with FreeGEM graphical environment',
                category: 'dos',
                icon: '&#x1F4BE;',
                tags: ['GUI', 'HD', '200MB'],
                config: {
                    hda: { url: CDN + 'freegem/.bin', size: 209715200, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'psychdos',
                name: 'PsychDOS',
                description: 'FreeDOS with games, demos, and multimedia',
                category: 'dos',
                icon: '&#x1F3AE;',
                tags: ['GUI', 'HD', '524MB'],
                config: {
                    hda: { url: CDN + 'psychdos/.img', size: 549453824, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 64 * 1024 * 1024
                }
            },

            // ═══════════════════════════════════════════════════════════
            // WINDOWS
            // ═══════════════════════════════════════════════════════════
            {
                id: 'windows1',
                name: 'Windows 1.01',
                description: 'The original Windows from 1985',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'Floppy', 'Historic'],
                config: {
                    fda: { url: LOCAL + 'windows101.img' },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'windows2',
                name: 'Windows 2.03',
                description: 'Second major Windows release from 1987',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '4MB'],
                config: {
                    hda: { url: LOCAL + 'windows2.img', size: 4177920 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'windows30',
                name: 'Windows 3.0',
                description: 'First commercially successful Windows version',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'CD', '8MB'],
                config: {
                    cdrom: { url: LOCAL + 'Win30.iso', size: 7774208 },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'windows31',
                name: 'Windows 3.1',
                description: 'Popular 16-bit Windows with improved UI',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '34MB'],
                config: {
                    hda: { url: LOCAL + 'win31.img', size: 34463744 },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'windowsnt3',
                name: 'Windows NT 3.1',
                description: 'First 32-bit Windows for workstations',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '87MB'],
                config: {
                    hda: { url: CDN + 'winnt31/.img', size: 87 * 1024 * 1024, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'windowsnt35',
                name: 'Windows NT 3.51',
                description: 'Windows NT with improved shell',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '156MB'],
                config: {
                    hda: { url: CDN + 'windowsnt351/.img', size: 163577856, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'windowsnt4',
                name: 'Windows NT 4.0',
                description: 'NT kernel with Windows 95 interface',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '500MB'],
                config: {
                    hda: { url: CDN + 'winnt4_noacpi/.img', size: 523837440, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 512 * 1024 * 1024
                }
            },
            {
                id: 'windows95',
                name: 'Windows 95',
                description: 'Revolutionary 32-bit consumer Windows',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '450MB'],
                config: {
                    hda: { url: CDN + 'windows95-v2/.img', size: 471859200, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'windows98',
                name: 'Windows 98',
                description: 'Popular Windows with IE integration (with state)',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '300MB'],
                config: {
                    hda: { url: CDN + 'windows98/.img', size: 300 * 1024 * 1024, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    state: { url: CDN + 'windows98_state-v2.bin.zst' },
                    memory_size: 128 * 1024 * 1024
                }
            },
            {
                id: 'windows-me',
                name: 'Windows ME',
                description: 'Last DOS-based Windows (with state)',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '796MB'],
                config: {
                    hda: { url: CDN + 'windowsme-v2/.img', size: 834666496, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    state: { url: CDN + 'windows-me_state-v2.bin.zst' },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'windows2000',
                name: 'Windows 2000',
                description: 'Professional Windows NT 5.0 (with state)',
                category: 'windows',
                icon: '&#x1F5BC;',
                tags: ['GUI', 'HD', '2GB'],
                config: {
                    hda: { url: CDN + 'windows2k-v2/.img', size: 2 * 1024 * 1024 * 1024, async: true, fixed_chunk_size: 256 * 1024, use_parts: true },
                    state: { url: CDN + 'windows2k_state-v4.bin.zst' },
                    memory_size: 512 * 1024 * 1024
                }
            },

            // ═══════════════════════════════════════════════════════════
            // HOBBY & ALTERNATIVE OS
            // ═══════════════════════════════════════════════════════════
            {
                id: 'kolibri',
                name: 'KolibriOS',
                description: 'Tiny but powerful GUI OS written entirely in assembly',
                category: 'other',
                icon: '&#x1F426;',
                tags: ['GUI', 'Floppy', '1.4MB'],
                config: {
                    fda: { url: LOCAL + 'kolibri.img' },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'serenity',
                name: 'SerenityOS',
                description: 'Retro-style Unix-like OS with GUI (with state)',
                category: 'other',
                icon: '&#x1F308;',
                tags: ['GUI', 'HD', '700MB'],
                config: {
                    hda: { url: CDN + 'serenity-v3/.img.zst', size: 734003200, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    state: { url: CDN + 'serenity_state-v4.bin.zst' },
                    memory_size: 512 * 1024 * 1024
                }
            },
            {
                id: 'redox',
                name: 'Redox OS',
                description: 'Unix-like OS written in Rust (with state)',
                category: 'other',
                icon: '&#x1F980;',
                tags: ['GUI', 'HD', '640MB'],
                config: {
                    hda: { url: CDN + 'redox_demo_i686_2024-09-07_1225_harddrive/.img', size: 671088640, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    state: { url: CDN + 'redox_state-v2.bin.zst' },
                    memory_size: 1024 * 1024 * 1024,
                    acpi: true
                }
            },
            {
                id: 'haiku',
                name: 'Haiku',
                description: 'Open source BeOS successor (with state)',
                category: 'other',
                icon: '&#x1F343;',
                tags: ['GUI', 'HD', '1.3GB'],
                config: {
                    hda: { url: CDN + 'haiku-v5/.img', size: 1342177280, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    state: { url: CDN + 'haiku_state-v5.bin.zst' },
                    memory_size: 512 * 1024 * 1024,
                    acpi: true
                }
            },
            {
                id: 'helenos',
                name: 'HelenOS',
                description: 'Microkernel-based portable OS',
                category: 'other',
                icon: '&#x1F3DB;',
                tags: ['GUI', 'CD', '25MB'],
                config: {
                    cdrom: { url: LOCAL + 'HelenOS-0.14.1-ia32.iso', size: 25792512 },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'reactos',
                name: 'ReactOS',
                description: 'Open source Windows-compatible OS (with state)',
                category: 'other',
                icon: '&#x2699;',
                tags: ['GUI', 'HD', '700MB'],
                config: {
                    hda: { url: CDN + 'reactos-v3/.img', size: 734003200, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    state: { url: CDN + 'reactos_state-v3.bin.zst' },
                    memory_size: 512 * 1024 * 1024,
                    acpi: true
                }
            },
            {
                id: 'fiwix',
                name: 'FiwixOS',
                description: 'Unix-like kernel written from scratch',
                category: 'other',
                icon: '&#x1F9E9;',
                tags: ['CLI', 'HD', '1GB'],
                config: {
                    hda: { url: CDN + 'FiwixOS-3.4-i386/.img', size: 1024 * 1024 * 1024, async: true, fixed_chunk_size: 1024 * 1024, use_parts: true },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'sortix',
                name: 'Sortix',
                description: 'Small hobby OS with Unix-like features',
                category: 'other',
                icon: '&#x1F50D;',
                tags: ['CLI', 'CD', '68MB'],
                config: {
                    cdrom: { url: LOCAL + 'sortix-1.0-i686.iso', size: 71075840 },
                    memory_size: 512 * 1024 * 1024
                }
            },
            {
                id: 'skift',
                name: 'Skift OS',
                description: 'Modern hobby OS with compositor',
                category: 'other',
                icon: '&#x1F3A8;',
                tags: ['GUI', 'CD', '61MB'],
                config: {
                    cdrom: { url: LOCAL + 'skift-20200910.iso', size: 64452608 },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'oberon',
                name: 'Oberon',
                description: 'OS developed at ETH Zurich by Niklaus Wirth',
                category: 'other',
                icon: '&#x1F393;',
                tags: ['GUI', 'HD', '24MB'],
                config: {
                    hda: { url: LOCAL + 'oberon.img', size: 24 * 1024 * 1024 },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'tilck',
                name: 'Tilck',
                description: 'Tiny Linux-Compatible Kernel',
                category: 'other',
                icon: '&#x1F9F1;',
                tags: ['CLI', 'HD', '36MB'],
                config: {
                    hda: { url: LOCAL + 'tilck.img', size: 37748736 },
                    memory_size: 128 * 1024 * 1024
                }
            },
            {
                id: 'mu',
                name: 'Mu',
                description: 'Minimalist computing stack',
                category: 'other',
                icon: '&#x03BC;',
                tags: ['CLI', 'HD', '10MB'],
                config: {
                    hda: { url: LOCAL + 'mu-shell.img', size: 10321920 },
                    memory_size: 256 * 1024 * 1024
                }
            },
            {
                id: 'duskos',
                name: 'Dusk OS',
                description: 'Forth-based collapse-tolerant OS',
                category: 'other',
                icon: '&#x1F305;',
                tags: ['CLI', 'HD', '8MB'],
                config: {
                    hda: { url: LOCAL + 'duskos.img', size: 8388608 },
                    memory_size: 64 * 1024 * 1024
                }
            },
            {
                id: 'solos',
                name: 'Sol OS',
                description: 'Simple hobby operating system',
                category: 'other',
                icon: '&#x2600;',
                tags: ['CLI', 'Floppy'],
                config: {
                    fda: { url: LOCAL + 'os8.img', size: 1474560 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'snowdrop',
                name: 'Snowdrop',
                description: 'Minimalist 16-bit real mode OS',
                category: 'other',
                icon: '&#x2744;',
                tags: ['CLI', 'Floppy'],
                config: {
                    fda: { url: LOCAL + 'snowdrop.img', size: 1440 * 1024 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'sanos',
                name: 'Sanos',
                description: 'Minimalist 32-bit x86 OS kernel',
                category: 'other',
                icon: '&#x1F528;',
                tags: ['CLI', 'Floppy'],
                config: {
                    hda: { url: LOCAL + 'sanos-flp.img', size: 1474560 },
                    memory_size: 128 * 1024 * 1024
                }
            },

            // ═══════════════════════════════════════════════════════════
            // BOOTSECTOR GAMES & DEMOS (512 bytes!)
            // ═══════════════════════════════════════════════════════════
            {
                id: 'tetros',
                name: 'TetrOS',
                description: 'Tetris clone that fits in 512 bytes!',
                category: 'games',
                icon: '&#x1F3AE;',
                tags: ['Game', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'tetros.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'bootchess',
                name: 'BootChess',
                description: 'Chess game in 487 bytes - Guinness record!',
                category: 'games',
                icon: '&#x265E;',
                tags: ['Game', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'bootchess.img', size: 1474560 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'floppybird',
                name: 'Floppy Bird',
                description: 'Flappy Bird clone that boots from floppy',
                category: 'games',
                icon: '&#x1F426;',
                tags: ['Game', 'Floppy', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'floppybird.img', size: 1474560 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'invaders',
                name: 'Invaders',
                description: 'Space Invaders in 512 bytes',
                category: 'games',
                icon: '&#x1F47E;',
                tags: ['Game', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'invaders.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'pillman',
                name: 'Pillman',
                description: 'Pac-Man clone in 512 bytes',
                category: 'games',
                icon: '&#x1F7E1;',
                tags: ['Game', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'pillman.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'bootrogue',
                name: 'bootRogue',
                description: 'Roguelike game in 512 bytes',
                category: 'games',
                icon: '&#x1F5E1;',
                tags: ['Game', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'bootrogue.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'dino',
                name: 'Boot Dino',
                description: 'Chrome dinosaur game in a boot sector',
                category: 'games',
                icon: '&#x1F996;',
                tags: ['Game', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'bootdino.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },

            // ═══════════════════════════════════════════════════════════
            // PROGRAMMING ENVIRONMENTS (Bootsector)
            // ═══════════════════════════════════════════════════════════
            {
                id: 'bootbasic',
                name: 'bootBASIC',
                description: 'BASIC interpreter in 512 bytes',
                category: 'games',
                icon: '&#x1F4BB;',
                tags: ['BASIC', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'bootbasic.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'sectorlisp',
                name: 'SectorLISP',
                description: 'LISP interpreter in 512 bytes',
                category: 'games',
                icon: '&#x1F4DD;',
                tags: ['LISP', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'sectorlisp-friendly.bin', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'sectorforth',
                name: 'sectorforth',
                description: 'Forth interpreter in 512 bytes',
                category: 'games',
                icon: '&#x1F4C3;',
                tags: ['Forth', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'sectorforth.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'bootlogo',
                name: 'bootLogo',
                description: 'Logo turtle graphics in 512 bytes',
                category: 'games',
                icon: '&#x1F422;',
                tags: ['Logo', '512B', 'Bootable'],
                config: {
                    fda: { url: LOCAL + 'bootlogo.img', size: 512 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'stillalive',
                name: 'Still Alive',
                description: 'Portal "Still Alive" song player OS',
                category: 'games',
                icon: '&#x1F3B5;',
                tags: ['Music', 'Floppy', 'Demo'],
                config: {
                    fda: { url: LOCAL + 'stillalive-os.img', size: 368640 },
                    memory_size: 32 * 1024 * 1024
                }
            },
            {
                id: 'xcom',
                name: 'FreeDOS + Xcom',
                description: 'FreeDOS with Xcom file manager',
                category: 'dos',
                icon: '&#x1F4C1;',
                tags: ['CLI', 'Floppy'],
                config: {
                    fda: { url: LOCAL + 'xcom144.img', size: 1440 * 1024 },
                    memory_size: 32 * 1024 * 1024
                }
            }
        ];

        // Global state
        let emulator = null;
        let selectedOS = null;
        let isPaused = false;
        let startTime = null;
        let statsInterval = null;

        // DOM Elements
        const elements = {
            osList: document.getElementById('osList'),
            sidebar: document.getElementById('sidebar'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            loadingProgress: document.getElementById('loadingProgress'),
            screenContainer: document.getElementById('screen_container'),
            emulatorContainer: document.getElementById('emulatorContainer'),
            btnStart: document.getElementById('btnStart'),
            btnPause: document.getElementById('btnPause'),
            btnReset: document.getElementById('btnReset'),
            btnCtrlAltDel: document.getElementById('btnCtrlAltDel'),
            btnFullscreen: document.getElementById('btnFullscreen'),
            btnScreenshot: document.getElementById('btnScreenshot'),
            scaleSlider: document.getElementById('scaleSlider'),
            scaleValue: document.getElementById('scaleValue'),
            statRuntime: document.getElementById('statRuntime'),
            statSpeed: document.getElementById('statSpeed'),
            statAvgSpeed: document.getElementById('statAvgSpeed'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            toggleSidebar: document.getElementById('toggleSidebar')
        };

        // Initialize OS List
        function initOSList() {
            elements.osList.innerHTML = OS_DATABASE.map(os => `
                <div class="os-card" data-id="${os.id}" data-category="${os.category}">
                    <div class="os-card-header">
                        <div class="os-icon ${os.category}">${os.icon}</div>
                        <div>
                            <div class="os-name">${os.name}</div>
                            <div class="os-meta">
                                ${os.tags.map(t => `<span class="os-tag">${t}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="os-description">${os.description}</div>
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.os-card').forEach(card => {
                card.addEventListener('click', () => selectOS(card.dataset.id));
            });
        }

        // Filter OS List
        function initFilters() {
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');

                    const filter = pill.dataset.filter;
                    document.querySelectorAll('.os-card').forEach(card => {
                        if (filter === 'all' || card.dataset.category === filter) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });
        }

        // Select OS
        function selectOS(id) {
            selectedOS = OS_DATABASE.find(os => os.id === id);
            if (!selectedOS) return;

            // Update UI
            document.querySelectorAll('.os-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === id);
            });

            elements.btnStart.disabled = false;
            elements.welcomeScreen.querySelector('.welcome-title').textContent = selectedOS.name;
            elements.welcomeScreen.querySelector('.welcome-subtitle').textContent =
                `Click Start to boot ${selectedOS.name}`;
        }

        // Start Emulator
        async function startEmulator() {
            if (!selectedOS) return;

            // Stop existing emulator
            if (emulator) {
                emulator.stop();
                emulator.destroy();
            }

            // Show loading
            elements.welcomeScreen.classList.add('hidden');
            elements.loadingOverlay.classList.remove('hidden');
            elements.loadingText.textContent = `Loading ${selectedOS.name}...`;
            elements.loadingProgress.style.width = '0%';

            // Build config
            const config = {
                wasm_path: 'build/v86.wasm',
                memory_size: selectedOS.config.memory_size || 64 * 1024 * 1024,
                vga_memory_size: selectedOS.config.vga_memory_size || 8 * 1024 * 1024,
                screen_container: elements.screenContainer,
                bios: { url: 'bios/seabios.bin' },
                vga_bios: { url: 'bios/vgabios.bin' },
                autostart: true
            };

            // Add boot media
            if (selectedOS.config.fda) config.fda = selectedOS.config.fda;
            if (selectedOS.config.cdrom) config.cdrom = selectedOS.config.cdrom;
            if (selectedOS.config.hda) config.hda = selectedOS.config.hda;
            if (selectedOS.config.bzimage) config.bzimage = selectedOS.config.bzimage;
            if (selectedOS.config.cmdline) config.cmdline = selectedOS.config.cmdline;

            try {
                emulator = new V86(config);

                emulator.add_listener('download-progress', (e) => {
                    const percent = e.loaded / e.total * 100;
                    elements.loadingProgress.style.width = `${percent}%`;
                    elements.loadingText.textContent = `Loading ${selectedOS.name}... ${Math.round(percent)}%`;
                });

                emulator.add_listener('emulator-ready', () => {
                    elements.loadingOverlay.classList.add('hidden');
                    updateControls(true);
                    startStats();
                });

            } catch (err) {
                console.error('Emulator error:', err);
                elements.loadingText.textContent = `Error: ${err.message}`;
            }
        }

        // Update Controls
        function updateControls(running) {
            elements.btnStart.disabled = running;
            elements.btnPause.disabled = !running;
            elements.btnReset.disabled = !running;
            elements.btnCtrlAltDel.disabled = !running;
            elements.btnScreenshot.disabled = !running;

            elements.statusDot.className = 'status-dot' + (running ? ' running' : '');
            elements.statusText.textContent = running ? 'Running' : 'Stopped';
        }

        // Stats
        function startStats() {
            startTime = Date.now();
            statsInterval = setInterval(updateStats, 500);
        }

        function updateStats() {
            if (!emulator) return;

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            elements.statRuntime.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

            const ips = emulator.get_instruction_counter();
            if (ips) {
                const mips = (ips / 1000000).toFixed(1);
                elements.statSpeed.textContent = `${mips} MIPS`;

                const avgMips = (ips / elapsed / 1000000).toFixed(1);
                elements.statAvgSpeed.textContent = `${avgMips} MIPS`;
            }
        }

        // Event Handlers
        elements.btnStart.addEventListener('click', startEmulator);

        elements.btnPause.addEventListener('click', () => {
            if (!emulator) return;
            if (isPaused) {
                emulator.run();
                elements.btnPause.innerHTML = '<span>&#10074;&#10074;</span> <span>Pause</span>';
                elements.statusDot.className = 'status-dot running';
                elements.statusText.textContent = 'Running';
            } else {
                emulator.stop();
                elements.btnPause.innerHTML = '<span>&#9654;</span> <span>Resume</span>';
                elements.statusDot.className = 'status-dot paused';
                elements.statusText.textContent = 'Paused';
            }
            isPaused = !isPaused;
        });

        elements.btnReset.addEventListener('click', () => {
            if (emulator) emulator.restart();
        });

        elements.btnCtrlAltDel.addEventListener('click', () => {
            if (emulator) {
                emulator.keyboard_send_scancodes([0x1D, 0x38, 0x53, 0x53 | 0x80, 0x38 | 0x80, 0x1D | 0x80]);
            }
        });

        elements.btnFullscreen.addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                elements.emulatorContainer.requestFullscreen();
            }
        });

        elements.btnScreenshot.addEventListener('click', () => {
            if (!emulator) return;
            const canvas = elements.screenContainer.querySelector('canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `${selectedOS?.name || 'screenshot'}-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        });

        elements.scaleSlider.addEventListener('input', (e) => {
            const scale = parseFloat(e.target.value);
            elements.scaleValue.textContent = `${scale.toFixed(1)}x`;
            elements.screenContainer.style.transform = `scale(${scale})`;
        });

        elements.toggleSidebar.addEventListener('click', (e) => {
            e.preventDefault();
            elements.sidebar.classList.toggle('open');
        });

        // Initialize
        initOSList();
        initFilters();
    </script>
</body>
</html>
