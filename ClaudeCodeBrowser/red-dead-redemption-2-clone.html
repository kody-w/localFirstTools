<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Dead Redemption 2 - Wild West Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: #000;
            color: #f5deb3;
            overflow: hidden;
            cursor: crosshair;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        /* Title Screen */
        .title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
                        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23654321" width="100" height="100"/><circle fill="%23886633" cx="50" cy="50" r="30"/></svg>');
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 2s ease-in;
        }

        .title-screen.hidden {
            display: none;
        }

        .game-title {
            font-size: 5rem;
            font-weight: bold;
            color: #d4af37;
            text-shadow: 4px 4px 12px rgba(0,0,0,0.9);
            margin-bottom: 1rem;
            letter-spacing: 0.3rem;
            font-family: 'Georgia', serif;
            text-align: center;
        }

        .game-subtitle {
            font-size: 2rem;
            color: #cd853f;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
            margin-bottom: 3rem;
            font-style: italic;
        }

        .start-btn {
            padding: 1.5rem 4rem;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            color: #f5deb3;
            border: 3px solid #d4af37;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }

        .start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
            background: linear-gradient(135deg, #654321 0%, #8b4513 100%);
        }

        /* HUD */
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .hud > * {
            pointer-events: auto;
        }

        .top-left-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            min-width: 250px;
        }

        .player-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-label {
            width: 80px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .bar-container {
            flex: 1;
            height: 20px;
            background: #333;
            border: 1px solid #666;
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .health-bar { background: linear-gradient(90deg, #ff0000, #cc0000); }
        .stamina-bar { background: linear-gradient(90deg, #ffd700, #ffaa00); }
        .dead-eye-bar { background: linear-gradient(90deg, #ff6347, #cc4433); }

        .top-right-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            text-align: right;
        }

        .time-weather {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .location {
            font-size: 0.9rem;
            color: #cd853f;
            margin-top: 5px;
        }

        .bottom-left-hud {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border: 2px solid #d4af37;
            border-radius: 5px;
        }

        .weapon-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .weapon-icon {
            font-size: 2rem;
        }

        .ammo-count {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .bottom-right-hud {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border: 2px solid #d4af37;
            border-radius: 5px;
        }

        .honor-meter {
            text-align: center;
            margin-bottom: 10px;
        }

        .honor-bar-container {
            width: 200px;
            height: 25px;
            background: linear-gradient(90deg, #8b0000 0%, #666 50%, #4169e1 100%);
            border: 2px solid #d4af37;
            border-radius: 5px;
            position: relative;
        }

        .honor-indicator {
            position: absolute;
            width: 4px;
            height: 100%;
            background: #fff;
            box-shadow: 0 0 10px #fff;
            transition: left 0.3s ease;
        }

        .money-display {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
            margin-top: 10px;
        }

        /* Minimap */
        .minimap {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #d4af37;
            border-radius: 50%;
            overflow: hidden;
        }

        .minimap-canvas {
            width: 100%;
            height: 100%;
        }

        /* Controls Help */
        .controls-help {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            font-size: 0.9rem;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .key {
            background: #333;
            color: #ffd700;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            border: 1px solid #666;
        }

        /* Mission Panel */
        .mission-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border: 3px solid #d4af37;
            border-radius: 10px;
            min-width: 600px;
            max-width: 800px;
            z-index: 200;
            display: none;
        }

        .mission-panel.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .mission-title {
            font-size: 2rem;
            color: #d4af37;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 10px;
        }

        .mission-description {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .mission-objectives {
            background: rgba(139, 69, 19, 0.3);
            padding: 15px;
            border-left: 4px solid #d4af37;
            margin-bottom: 20px;
        }

        .objective-item {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .objective-item.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .mission-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .mission-btn {
            padding: 12px 30px;
            font-size: 1rem;
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            color: #f5deb3;
            border: 2px solid #d4af37;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .mission-btn:hover {
            background: linear-gradient(135deg, #654321 0%, #8b4513 100%);
            transform: scale(1.05);
        }

        /* Inventory */
        .inventory-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border: 3px solid #d4af37;
            border-radius: 10px;
            width: 80vw;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }

        .inventory-panel.active {
            display: block;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .inventory-item {
            background: rgba(139, 69, 19, 0.3);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .inventory-item:hover {
            border-color: #d4af37;
            transform: scale(1.05);
        }

        .item-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-count {
            color: #ffd700;
            font-size: 1.2rem;
        }

        /* Notification */
        .notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 40px;
            border: 3px solid #d4af37;
            border-radius: 10px;
            font-size: 1.5rem;
            z-index: 300;
            display: none;
            animation: fadeInOut 3s ease;
        }

        .notification.active {
            display: block;
        }

        /* Crosshair */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            pointer-events: none;
            z-index: 150;
        }

        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }

        .crosshair::before {
            width: 2px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .crosshair::after {
            height: 2px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Save/Load */
        .save-load-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 150;
        }

        .save-btn, .load-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            color: #f5deb3;
            border: 2px solid #d4af37;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .save-btn:hover, .load-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .dead-eye-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,0,0,0.1) 0%, rgba(100,0,0,0.3) 100%);
            pointer-events: none;
            z-index: 90;
            display: none;
            animation: pulse 2s infinite;
        }

        .dead-eye-overlay.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Title Screen -->
        <div class="title-screen" id="titleScreen">
            <div class="game-title">RED DEAD<br>REDEMPTION 2</div>
            <div class="game-subtitle">The Wild West Awaits</div>
            <button class="start-btn" onclick="startGame()">RIDE INTO THE SUNSET</button>
        </div>

        <!-- 3D Canvas -->
        <div id="canvas-container"></div>

        <!-- HUD -->
        <div class="hud" id="hud" style="display: none;">
            <!-- Top Left - Player Stats -->
            <div class="top-left-hud">
                <div class="player-stats">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #d4af37;">ARTHUR MORGAN</div>
                    <div class="stat-bar">
                        <span class="stat-label">Health</span>
                        <div class="bar-container">
                            <div class="bar-fill health-bar" id="healthBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <span class="stat-label">Stamina</span>
                        <div class="bar-container">
                            <div class="bar-fill stamina-bar" id="staminaBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <span class="stat-label">Dead Eye</span>
                        <div class="bar-container">
                            <div class="bar-fill dead-eye-bar" id="deadEyeBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Right - Time & Weather -->
            <div class="top-right-hud">
                <div class="time-weather">
                    <div id="timeDisplay">12:00 PM</div>
                    <div id="weatherDisplay" style="color: #87ceeb;">Sunny</div>
                </div>
                <div class="location" id="locationDisplay">New Hanover</div>
            </div>

            <!-- Bottom Left - Weapon -->
            <div class="bottom-left-hud">
                <div class="weapon-display">
                    <div class="weapon-icon" id="weaponIcon">üî´</div>
                    <div>
                        <div id="weaponName" style="font-weight: bold;">Cattleman Revolver</div>
                        <div class="ammo-count" id="ammoCount">6 / 60</div>
                    </div>
                </div>
            </div>

            <!-- Bottom Right - Honor & Money -->
            <div class="bottom-right-hud">
                <div class="honor-meter">
                    <div style="margin-bottom: 5px; font-weight: bold;">HONOR</div>
                    <div class="honor-bar-container">
                        <div class="honor-indicator" id="honorIndicator" style="left: 50%"></div>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.8rem;" id="honorText">Neutral</div>
                </div>
                <div class="money-display" id="moneyDisplay">$1,250.00</div>
            </div>

            <!-- Minimap -->
            <div class="minimap">
                <canvas class="minimap-canvas" id="minimapCanvas" width="200" height="200"></canvas>
            </div>

            <!-- Controls Help -->
            <div class="controls-help">
                <div class="control-item"><span class="key">WASD</span> Move</div>
                <div class="control-item"><span class="key">SHIFT</span> Run</div>
                <div class="control-item"><span class="key">SPACE</span> Jump</div>
                <div class="control-item"><span class="key">H</span> Horse</div>
                <div class="control-item"><span class="key">CLICK</span> Shoot</div>
                <div class="control-item"><span class="key">Q</span> Dead Eye</div>
                <div class="control-item"><span class="key">E</span> Interact</div>
                <div class="control-item"><span class="key">I</span> Inventory</div>
                <div class="control-item"><span class="key">M</span> Missions</div>
                <div class="control-item"><span class="key">1-5</span> Weapons</div>
            </div>

            <!-- Crosshair -->
            <div class="crosshair"></div>

            <!-- Dead Eye Overlay -->
            <div class="dead-eye-overlay" id="deadEyeOverlay"></div>
        </div>

        <!-- Mission Panel -->
        <div class="mission-panel" id="missionPanel">
            <div class="mission-title" id="missionTitle">Available Missions</div>
            <div id="missionContent">
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">Main Story</h3>
                    <div class="mission-item" onclick="startMission('bank')">
                        <strong>The Bank Robbery</strong> - Help Dutch rob the Valentine bank
                    </div>
                    <div class="mission-item" onclick="startMission('train')">
                        <strong>Train Heist</strong> - Stop and rob a moving train
                    </div>
                    <div class="mission-item" onclick="startMission('bounty')">
                        <strong>Bounty Hunter</strong> - Capture a dangerous outlaw
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">Side Missions</h3>
                    <div class="mission-item" onclick="startMission('hunt')">
                        <strong>The Legendary Bear</strong> - Hunt a legendary grizzly bear
                    </div>
                    <div class="mission-item" onclick="startMission('rescue')">
                        <strong>Rescue Mission</strong> - Save a kidnapped homesteader
                    </div>
                    <div class="mission-item" onclick="startMission('poker')">
                        <strong>High Stakes Poker</strong> - Win a poker game in Saint Denis
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="mission-btn" onclick="closeMissionPanel()">Close</button>
            </div>
        </div>

        <!-- Inventory Panel -->
        <div class="inventory-panel" id="inventoryPanel">
            <div class="mission-title">Inventory & Satchel</div>
            <div class="inventory-grid" id="inventoryGrid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="mission-btn" onclick="closeInventory()">Close</button>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification"></div>

        <!-- Save/Load -->
        <div class="save-load-panel" id="saveLoadPanel" style="display: none;">
            <button class="save-btn" onclick="saveGame()">SAVE GAME</button>
            <button class="load-btn" onclick="loadGame()">LOAD GAME</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ==================== GAME STATE ====================

        const gameState = {
            player: {
                name: 'Arthur Morgan',
                health: 100,
                maxHealth: 100,
                stamina: 100,
                maxStamina: 100,
                deadEye: 100,
                maxDeadEye: 100,
                money: 1250.00,
                honor: 0, // -100 to 100
                position: { x: 0, y: 0, z: 0 },
                onHorse: false,
                inDeadEye: false
            },
            world: {
                time: 12, // 0-24 hours
                weather: 'Sunny',
                location: 'New Hanover'
            },
            weapons: [
                { name: 'Cattleman Revolver', icon: 'üî´', ammo: 6, maxAmmo: 60, damage: 35, selected: true },
                { name: 'Repeater Carbine', icon: 'üî´', ammo: 14, maxAmmo: 140, damage: 30, selected: false },
                { name: 'Pump Shotgun', icon: 'üî´', ammo: 5, maxAmmo: 50, damage: 80, selected: false },
                { name: 'Bolt-Action Rifle', icon: 'üî´', ammo: 5, maxAmmo: 50, damage: 60, selected: false },
                { name: 'Bow', icon: 'üèπ', ammo: 20, maxAmmo: 100, damage: 50, selected: false }
            ],
            inventory: {
                'Cooked Meat': { icon: 'ü•©', count: 5, type: 'consumable' },
                'Health Tonic': { icon: 'üß™', count: 3, type: 'consumable' },
                'Stamina Tonic': { icon: 'üß™', count: 3, type: 'consumable' },
                'Perfect Deer Pelt': { icon: 'ü¶å', count: 2, type: 'crafting' },
                'Gold Nugget': { icon: 'üí∞', count: 8, type: 'valuable' },
                'Cigarettes': { icon: 'üö¨', count: 10, type: 'consumable' },
                'Coffee': { icon: '‚òï', count: 7, type: 'consumable' },
                'Herbs': { icon: 'üåø', count: 15, type: 'crafting' },
                'Animal Fat': { icon: 'üßà', count: 4, type: 'crafting' },
                'Whiskey': { icon: 'ü•É', count: 2, type: 'consumable' }
            },
            missions: {
                active: null,
                completed: []
            },
            wanted: 0 // 0-5 stars
        };

        // ==================== THREE.JS SETUP ====================

        let scene, camera, renderer, player, horse, controls = {};
        let terrain, npcs = [], animals = [], buildings = [];
        let clock = new THREE.Clock();

        function startGame() {
            document.getElementById('titleScreen').classList.add('hidden');
            document.getElementById('hud').style.display = 'block';
            document.getElementById('saveLoadPanel').style.display = 'flex';
            init3D();
            setupControls();
            updateHUD();
            startGameLoop();
            showNotification('Welcome to the Wild West, Arthur!');
        }

        function init3D() {
            const container = document.getElementById('canvas-container');

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Sky blue
            scene.fog = new THREE.Fog(0x87ceeb, 100, 500);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffd700, 0.8);
            sunLight.position.set(100, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            scene.add(sunLight);

            // Create world
            createTerrain();
            createPlayer();
            createHorse();
            createTown();
            createNPCs();
            createAnimals();
            createVegetation();
            createCamp();

            // Window resize
            window.addEventListener('resize', onWindowResize, false);
        }

        function createTerrain() {
            // Large terrain plane
            const terrainSize = 500;
            const terrainGeometry = new THREE.PlaneGeometry(terrainSize, terrainSize, 50, 50);

            // Add some height variation
            const vertices = terrainGeometry.attributes.position.array;
            for (let i = 0; i < vertices.length; i += 3) {
                vertices[i + 2] = Math.sin(vertices[i] * 0.1) * Math.cos(vertices[i + 1] * 0.1) * 3;
            }
            terrainGeometry.computeVertexNormals();

            const terrainMaterial = new THREE.MeshStandardMaterial({
                color: 0x5d8a3a,
                roughness: 0.9,
                flatShading: false
            });

            terrain = new THREE.Mesh(terrainGeometry, terrainMaterial);
            terrain.rotation.x = -Math.PI / 2;
            terrain.receiveShadow = true;
            scene.add(terrain);

            // Add dirt paths
            for (let i = 0; i < 5; i++) {
                const pathGeometry = new THREE.PlaneGeometry(200, 4);
                const pathMaterial = new THREE.MeshStandardMaterial({ color: 0x8b7355 });
                const path = new THREE.Mesh(pathGeometry, pathMaterial);
                path.rotation.x = -Math.PI / 2;
                path.position.y = 0.05;
                path.position.x = (i - 2) * 50;
                path.receiveShadow = true;
                scene.add(path);
            }
        }

        function createPlayer() {
            const playerGroup = new THREE.Group();

            // Body
            const bodyGeometry = new THREE.BoxGeometry(1, 2, 0.5);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1;
            body.castShadow = true;
            playerGroup.add(body);

            // Head
            const headGeometry = new THREE.SphereGeometry(0.4, 16, 16);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 2.5;
            head.castShadow = true;
            playerGroup.add(head);

            // Hat
            const hatBottomGeometry = new THREE.CylinderGeometry(0.6, 0.6, 0.2, 16);
            const hatMaterial = new THREE.MeshStandardMaterial({ color: 0x654321 });
            const hatBottom = new THREE.Mesh(hatBottomGeometry, hatMaterial);
            hatBottom.position.y = 3;
            hatBottom.castShadow = true;
            playerGroup.add(hatBottom);

            const hatTopGeometry = new THREE.ConeGeometry(0.5, 0.6, 16);
            const hatTop = new THREE.Mesh(hatTopGeometry, hatMaterial);
            hatTop.position.y = 3.5;
            hatTop.castShadow = true;
            playerGroup.add(hatTop);

            // Gun holster indicator
            const holsterGeometry = new THREE.BoxGeometry(0.2, 0.4, 0.2);
            const holsterMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
            const holster = new THREE.Mesh(holsterGeometry, holsterMaterial);
            holster.position.set(0.6, 0.5, 0);
            playerGroup.add(holster);

            player = playerGroup;
            player.position.set(0, 0, 0);
            scene.add(player);
        }

        function createHorse() {
            const horseGroup = new THREE.Group();

            // Body
            const bodyGeometry = new THREE.BoxGeometry(1.5, 1.2, 3);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1.5;
            body.castShadow = true;
            horseGroup.add(body);

            // Head
            const headGeometry = new THREE.BoxGeometry(0.8, 0.8, 1.2);
            const head = new THREE.Mesh(headGeometry, bodyMaterial);
            head.position.set(0, 1.8, 2);
            head.castShadow = true;
            horseGroup.add(head);

            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.15, 0.15, 1.5);
            const legPositions = [
                [-0.5, 0.75, 1],
                [0.5, 0.75, 1],
                [-0.5, 0.75, -1],
                [0.5, 0.75, -1]
            ];

            legPositions.forEach(pos => {
                const leg = new THREE.Mesh(legGeometry, bodyMaterial);
                leg.position.set(...pos);
                leg.castShadow = true;
                horseGroup.add(leg);
            });

            // Tail
            const tailGeometry = new THREE.ConeGeometry(0.2, 1, 8);
            const tail = new THREE.Mesh(tailGeometry, new THREE.MeshStandardMaterial({ color: 0x654321 }));
            tail.position.set(0, 1.5, -1.8);
            tail.rotation.x = Math.PI / 4;
            horseGroup.add(tail);

            horse = horseGroup;
            horse.position.set(5, 0, 5);
            horse.visible = true;
            scene.add(horse);
        }

        function createTown() {
            // Create a small western town
            const townPositions = [
                { x: -40, z: -40, type: 'saloon' },
                { x: -40, z: -20, type: 'general' },
                { x: -40, z: 0, type: 'bank' },
                { x: -60, z: -40, type: 'hotel' },
                { x: -60, z: -20, type: 'sheriff' },
                { x: -20, z: -40, type: 'gunsmith' }
            ];

            townPositions.forEach(pos => {
                createBuilding(pos.x, pos.z, pos.type);
            });
        }

        function createBuilding(x, z, type) {
            const buildingGroup = new THREE.Group();

            // Main structure
            const width = 8 + Math.random() * 4;
            const height = 6 + Math.random() * 3;
            const depth = 6 + Math.random() * 2;

            const buildingGeometry = new THREE.BoxGeometry(width, height, depth);
            const buildingMaterial = new THREE.MeshStandardMaterial({
                color: type === 'saloon' ? 0xd2691e : 0xdaa520
            });
            const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
            building.position.y = height / 2;
            building.castShadow = true;
            building.receiveShadow = true;
            buildingGroup.add(building);

            // Roof
            const roofGeometry = new THREE.ConeGeometry(width * 0.7, 2, 4);
            const roofMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
            const roof = new THREE.Mesh(roofGeometry, roofMaterial);
            roof.position.y = height + 1;
            roof.rotation.y = Math.PI / 4;
            roof.castShadow = true;
            buildingGroup.add(roof);

            // Sign
            const signGeometry = new THREE.PlaneGeometry(width * 0.8, 1);
            const signMaterial = new THREE.MeshStandardMaterial({ color: 0x654321 });
            const sign = new THREE.Mesh(signGeometry, signMaterial);
            sign.position.set(0, height + 0.5, depth / 2 + 0.01);
            buildingGroup.add(sign);

            // Porch
            const porchGeometry = new THREE.BoxGeometry(width, 0.3, 2);
            const porchMaterial = new THREE.MeshStandardMaterial({ color: 0x8b7355 });
            const porch = new THREE.Mesh(porchGeometry, porchMaterial);
            porch.position.set(0, 0.15, depth / 2 + 1);
            porch.receiveShadow = true;
            buildingGroup.add(porch);

            buildingGroup.position.set(x, 0, z);
            buildingGroup.userData = { type: type };
            buildings.push(buildingGroup);
            scene.add(buildingGroup);
        }

        function createNPCs() {
            const npcPositions = [
                { x: -35, z: -35, type: 'townfolk' },
                { x: -45, z: -25, type: 'shopkeeper' },
                { x: -38, z: -18, type: 'sheriff' },
                { x: -42, z: -38, type: 'drunk' },
                { x: -50, z: -30, type: 'stranger' }
            ];

            npcPositions.forEach(pos => {
                const npc = createNPC(pos.type);
                npc.position.set(pos.x, 0, pos.z);
                npcs.push(npc);
                scene.add(npc);
            });
        }

        function createNPC(type) {
            const npcGroup = new THREE.Group();

            // Body
            const bodyGeometry = new THREE.BoxGeometry(0.8, 1.6, 0.4);
            const bodyColor = type === 'sheriff' ? 0x000080 : type === 'drunk' ? 0x654321 : 0x8b4513;
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: bodyColor });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.8;
            body.castShadow = true;
            npcGroup.add(body);

            // Head
            const headGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 2;
            head.castShadow = true;
            npcGroup.add(head);

            npcGroup.userData = { type: type, dialogueIndex: 0 };
            return npcGroup;
        }

        function createAnimals() {
            const animalTypes = ['deer', 'rabbit', 'bird', 'bear'];

            for (let i = 0; i < 15; i++) {
                const type = animalTypes[Math.floor(Math.random() * animalTypes.length)];
                const animal = createAnimal(type);

                const angle = Math.random() * Math.PI * 2;
                const distance = 30 + Math.random() * 100;
                animal.position.set(
                    Math.cos(angle) * distance,
                    0,
                    Math.sin(angle) * distance
                );

                animals.push(animal);
                scene.add(animal);
            }
        }

        function createAnimal(type) {
            const animalGroup = new THREE.Group();

            let color, size;
            switch(type) {
                case 'deer':
                    color = 0x8b4513;
                    size = 1.5;
                    break;
                case 'rabbit':
                    color = 0xd2691e;
                    size = 0.5;
                    break;
                case 'bird':
                    color = 0x000000;
                    size = 0.3;
                    break;
                case 'bear':
                    color = 0x654321;
                    size = 2.5;
                    break;
            }

            const bodyGeometry = new THREE.BoxGeometry(size, size * 0.6, size * 1.2);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: color });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = size * 0.4;
            body.castShadow = true;
            animalGroup.add(body);

            animalGroup.userData = {
                type: type,
                velocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 0.02,
                    0,
                    (Math.random() - 0.5) * 0.02
                )
            };

            return animalGroup;
        }

        function createVegetation() {
            // Trees
            for (let i = 0; i < 100; i++) {
                const tree = createTree();
                const angle = Math.random() * Math.PI * 2;
                const distance = 20 + Math.random() * 200;
                tree.position.set(
                    Math.cos(angle) * distance,
                    0,
                    Math.sin(angle) * distance
                );
                scene.add(tree);
            }

            // Rocks
            for (let i = 0; i < 50; i++) {
                const rock = createRock();
                const angle = Math.random() * Math.PI * 2;
                const distance = 10 + Math.random() * 200;
                rock.position.set(
                    Math.cos(angle) * distance,
                    0,
                    Math.sin(angle) * distance
                );
                scene.add(rock);
            }
        }

        function createTree() {
            const treeGroup = new THREE.Group();

            // Trunk
            const trunkGeometry = new THREE.CylinderGeometry(0.5, 0.6, 6, 8);
            const trunkMaterial = new THREE.MeshStandardMaterial({ color: 0x654321 });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.y = 3;
            trunk.castShadow = true;
            treeGroup.add(trunk);

            // Foliage
            const foliageGeometry = new THREE.ConeGeometry(3, 6, 8);
            const foliageMaterial = new THREE.MeshStandardMaterial({ color: 0x228b22 });
            const foliage = new THREE.Mesh(foliageGeometry, foliageMaterial);
            foliage.position.y = 8;
            foliage.castShadow = true;
            treeGroup.add(foliage);

            return treeGroup;
        }

        function createRock() {
            const size = 0.5 + Math.random() * 1.5;
            const rockGeometry = new THREE.DodecahedronGeometry(size, 0);
            const rockMaterial = new THREE.MeshStandardMaterial({ color: 0x808080 });
            const rock = new THREE.Mesh(rockGeometry, rockMaterial);
            rock.position.y = size * 0.5;
            rock.castShadow = true;
            rock.receiveShadow = true;
            return rock;
        }

        function createCamp() {
            const campX = 20;
            const campZ = 20;

            // Campfire
            const fireGroup = new THREE.Group();

            // Logs around fire
            for (let i = 0; i < 6; i++) {
                const logGeometry = new THREE.CylinderGeometry(0.2, 0.2, 2);
                const logMaterial = new THREE.MeshStandardMaterial({ color: 0x654321 });
                const log = new THREE.Mesh(logGeometry, logMaterial);
                const angle = (i / 6) * Math.PI * 2;
                log.position.set(Math.cos(angle) * 1.5, 0.1, Math.sin(angle) * 1.5);
                log.rotation.z = Math.PI / 2;
                log.rotation.y = angle;
                fireGroup.add(log);
            }

            // Fire (glowing sphere)
            const fireGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const fireMaterial = new THREE.MeshBasicMaterial({ color: 0xff6600 });
            const fire = new THREE.Mesh(fireGeometry, fireMaterial);
            fire.position.y = 0.5;
            fireGroup.add(fire);

            // Fire light
            const fireLight = new THREE.PointLight(0xff6600, 2, 20);
            fireLight.position.set(0, 0.5, 0);
            fireGroup.add(fireLight);

            fireGroup.position.set(campX, 0, campZ);
            scene.add(fireGroup);

            // Tents
            for (let i = 0; i < 3; i++) {
                const tentGroup = new THREE.Group();

                const tentGeometry = new THREE.ConeGeometry(2, 3, 4);
                const tentMaterial = new THREE.MeshStandardMaterial({ color: 0xf5deb3 });
                const tent = new THREE.Mesh(tentGeometry, tentMaterial);
                tent.position.y = 1.5;
                tent.rotation.y = Math.PI / 4;
                tent.castShadow = true;
                tentGroup.add(tent);

                const angle = (i / 3) * Math.PI * 2;
                tentGroup.position.set(
                    campX + Math.cos(angle) * 8,
                    0,
                    campZ + Math.sin(angle) * 8
                );
                scene.add(tentGroup);
            }
        }

        // ==================== CONTROLS ====================

        function setupControls() {
            window.addEventListener('keydown', (e) => {
                controls[e.key.toLowerCase()] = true;

                // Weapon switching
                if (e.key >= '1' && e.key <= '5') {
                    switchWeapon(parseInt(e.key) - 1);
                }

                // Dead Eye
                if (e.key.toLowerCase() === 'q') {
                    toggleDeadEye();
                }

                // Inventory
                if (e.key.toLowerCase() === 'i') {
                    toggleInventory();
                }

                // Missions
                if (e.key.toLowerCase() === 'm') {
                    toggleMissions();
                }

                // Horse
                if (e.key.toLowerCase() === 'h') {
                    toggleHorse();
                }

                // Interact
                if (e.key.toLowerCase() === 'e') {
                    interact();
                }
            });

            window.addEventListener('keyup', (e) => {
                controls[e.key.toLowerCase()] = false;
            });

            // Shooting
            window.addEventListener('click', (e) => {
                if (!document.getElementById('missionPanel').classList.contains('active') &&
                    !document.getElementById('inventoryPanel').classList.contains('active')) {
                    shoot();
                }
            });
        }

        function updateControls() {
            const moveSpeed = controls['shift'] ? 0.3 : 0.15;
            const runMultiplier = controls['shift'] ? 2 : 1;

            let moved = false;
            const direction = new THREE.Vector3();

            if (controls['w']) {
                direction.z -= 1;
                moved = true;
            }
            if (controls['s']) {
                direction.z += 1;
                moved = true;
            }
            if (controls['a']) {
                direction.x -= 1;
                moved = true;
            }
            if (controls['d']) {
                direction.x += 1;
                moved = true;
            }

            if (moved) {
                direction.normalize();

                if (gameState.player.onHorse) {
                    horse.position.x += direction.x * moveSpeed * 2;
                    horse.position.z += direction.z * moveSpeed * 2;
                    player.position.copy(horse.position);
                    player.position.y = 2;

                    if (direction.length() > 0) {
                        horse.rotation.y = Math.atan2(direction.x, direction.z);
                        player.rotation.y = horse.rotation.y;
                    }
                } else {
                    player.position.x += direction.x * moveSpeed;
                    player.position.z += direction.z * moveSpeed;

                    if (direction.length() > 0) {
                        player.rotation.y = Math.atan2(direction.x, direction.z);
                    }
                }

                // Deplete stamina when running
                if (controls['shift']) {
                    gameState.player.stamina = Math.max(0, gameState.player.stamina - 0.1);
                }
            } else {
                // Regenerate stamina
                gameState.player.stamina = Math.min(gameState.player.maxStamina, gameState.player.stamina + 0.05);
            }

            // Jump
            if (controls[' '] && player.position.y <= 0.1) {
                player.userData.velocity = 0.3;
            }

            // Apply gravity
            if (!player.userData.velocity) player.userData.velocity = 0;
            player.userData.velocity -= 0.02;
            player.position.y += player.userData.velocity;

            if (player.position.y <= 0) {
                player.position.y = 0;
                player.userData.velocity = 0;
            }

            // Camera follow
            const cameraOffset = new THREE.Vector3(0, 5, 10);
            const cameraRotation = new THREE.Euler(0, player.rotation.y, 0);
            cameraOffset.applyEuler(cameraRotation);

            camera.position.x = player.position.x + cameraOffset.x;
            camera.position.y = player.position.y + cameraOffset.y;
            camera.position.z = player.position.z + cameraOffset.z;

            camera.lookAt(player.position);

            // Update location based on position
            updateLocation();
        }

        function toggleHorse() {
            if (gameState.player.onHorse) {
                // Dismount
                gameState.player.onHorse = false;
                player.position.y = 0;
                horse.visible = true;
                horse.position.set(
                    player.position.x + 2,
                    0,
                    player.position.z
                );
                showNotification('Dismounted');
            } else {
                // Check if near horse
                const distance = player.position.distanceTo(horse.position);
                if (distance < 5) {
                    gameState.player.onHorse = true;
                    player.position.y = 2;
                    horse.visible = true;
                    showNotification('Mounted horse');
                } else {
                    showNotification('Horse is too far away');
                }
            }
        }

        function switchWeapon(index) {
            if (index < gameState.weapons.length) {
                gameState.weapons.forEach((w, i) => w.selected = i === index);
                updateHUD();
                showNotification(`Equipped: ${gameState.weapons[index].name}`);
            }
        }

        function toggleDeadEye() {
            if (gameState.player.deadEye > 0) {
                gameState.player.inDeadEye = !gameState.player.inDeadEye;
                document.getElementById('deadEyeOverlay').classList.toggle('active');

                if (gameState.player.inDeadEye) {
                    showNotification('Dead Eye Activated');
                }
            }
        }

        function shoot() {
            const weapon = gameState.weapons.find(w => w.selected);

            if (weapon.ammo > 0) {
                weapon.ammo--;

                // Check if hit animal or NPC
                const playerDir = new THREE.Vector3(
                    Math.sin(player.rotation.y),
                    0,
                    Math.cos(player.rotation.y)
                );

                let hit = false;

                // Check animals
                animals.forEach((animal, index) => {
                    const toAnimal = new THREE.Vector3()
                        .subVectors(animal.position, player.position)
                        .normalize();

                    const dot = playerDir.dot(toAnimal);
                    const distance = player.position.distanceTo(animal.position);

                    if (dot > 0.95 && distance < 50) {
                        // Hit!
                        const animalType = animal.userData.type;
                        scene.remove(animal);
                        animals.splice(index, 1);

                        // Add to inventory
                        const lootItem = `Perfect ${animalType.charAt(0).toUpperCase() + animalType.slice(1)} Pelt`;
                        if (!gameState.inventory[lootItem]) {
                            gameState.inventory[lootItem] = { icon: 'ü¶å', count: 0, type: 'crafting' };
                        }
                        gameState.inventory[lootItem].count++;

                        gameState.player.honor += 2;
                        gameState.player.money += 5 + Math.random() * 10;

                        showNotification(`Killed ${animalType}! +$${Math.floor(5 + Math.random() * 10)}`);
                        hit = true;
                    }
                });

                if (gameState.player.inDeadEye) {
                    gameState.player.deadEye = Math.max(0, gameState.player.deadEye - 5);
                }

                updateHUD();
            } else {
                showNotification('Out of ammo! Reload needed');
            }
        }

        function interact() {
            // Check for nearby NPCs
            npcs.forEach(npc => {
                const distance = player.position.distanceTo(npc.position);
                if (distance < 5) {
                    const dialogues = {
                        'townfolk': ['Howdy, partner!', 'Nice weather we\'re having', 'Watch out for bandits'],
                        'shopkeeper': ['Welcome to my store!', 'Got some fine goods here', 'Take a look around'],
                        'sheriff': ['Keep the peace, stranger', 'No trouble in my town', 'Move along'],
                        'drunk': ['*hic* Buy me a drink?', 'I seen things...', '*stumbles*'],
                        'stranger': ['...', 'You looking for work?', 'I might have a job for you']
                    };

                    const npcDialogues = dialogues[npc.userData.type] || ['Hello'];
                    const dialogue = npcDialogues[npc.userData.dialogueIndex % npcDialogues.length];
                    npc.userData.dialogueIndex++;

                    showNotification(dialogue);

                    // Chance to get mission
                    if (Math.random() > 0.8) {
                        gameState.player.honor += 1;
                    }
                }
            });

            // Check for buildings
            buildings.forEach(building => {
                const distance = player.position.distanceTo(building.position);
                if (distance < 10) {
                    const buildingType = building.userData.type;
                    showNotification(`Entering ${buildingType}...`);

                    if (buildingType === 'general') {
                        gameState.player.health = gameState.player.maxHealth;
                        showNotification('Purchased health items');
                    }
                }
            });
        }

        function updateLocation() {
            const x = player.position.x;
            const z = player.position.z;

            if (x < -30 && z < -20) {
                gameState.world.location = 'Valentine (Town)';
            } else if (x > 10 && z > 10) {
                gameState.world.location = 'Camp Shady Belle';
            } else if (Math.abs(x) < 20 && Math.abs(z) < 20) {
                gameState.world.location = 'The Heartlands';
            } else {
                gameState.world.location = 'New Hanover';
            }
        }

        // ==================== GAME LOOP ====================

        function startGameLoop() {
            function animate() {
                requestAnimationFrame(animate);

                updateControls();
                updateAnimals();
                updateTime();
                updateHUD();
                updateMinimap();

                renderer.render(scene, camera);
            }
            animate();
        }

        function updateAnimals() {
            animals.forEach(animal => {
                // Simple AI: wander around
                animal.position.add(animal.userData.velocity);

                // Random direction changes
                if (Math.random() > 0.98) {
                    animal.userData.velocity.set(
                        (Math.random() - 0.5) * 0.05,
                        0,
                        (Math.random() - 0.5) * 0.05
                    );
                }

                // Keep animals in bounds
                const maxDistance = 200;
                if (Math.abs(animal.position.x) > maxDistance || Math.abs(animal.position.z) > maxDistance) {
                    animal.userData.velocity.multiplyScalar(-1);
                }

                // Rotate to face movement direction
                if (animal.userData.velocity.length() > 0) {
                    animal.rotation.y = Math.atan2(animal.userData.velocity.x, animal.userData.velocity.z);
                }
            });
        }

        function updateTime() {
            // Advance time slowly
            gameState.world.time += 0.001;
            if (gameState.world.time >= 24) {
                gameState.world.time = 0;
            }

            // Update sky color based on time
            const time = gameState.world.time;
            let skyColor;

            if (time >= 6 && time < 12) {
                skyColor = new THREE.Color(0x87ceeb); // Day
            } else if (time >= 12 && time < 18) {
                skyColor = new THREE.Color(0x87ceeb); // Afternoon
            } else if (time >= 18 && time < 20) {
                skyColor = new THREE.Color(0xff6347); // Sunset
            } else {
                skyColor = new THREE.Color(0x191970); // Night
            }

            scene.background = skyColor;
            scene.fog.color = skyColor;

            // Regenerate dead eye slowly
            gameState.player.deadEye = Math.min(gameState.player.maxDeadEye, gameState.player.deadEye + 0.01);
        }

        function updateHUD() {
            // Health
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            document.getElementById('healthBar').style.width = healthPercent + '%';

            // Stamina
            const staminaPercent = (gameState.player.stamina / gameState.player.maxStamina) * 100;
            document.getElementById('staminaBar').style.width = staminaPercent + '%';

            // Dead Eye
            const deadEyePercent = (gameState.player.deadEye / gameState.player.maxDeadEye) * 100;
            document.getElementById('deadEyeBar').style.width = deadEyePercent + '%';

            // Time
            const hours = Math.floor(gameState.world.time);
            const minutes = Math.floor((gameState.world.time % 1) * 60);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            document.getElementById('timeDisplay').textContent =
                `${displayHours}:${String(minutes).padStart(2, '0')} ${ampm}`;

            // Weather
            document.getElementById('weatherDisplay').textContent = gameState.world.weather;

            // Location
            document.getElementById('locationDisplay').textContent = gameState.world.location;

            // Weapon
            const weapon = gameState.weapons.find(w => w.selected);
            document.getElementById('weaponIcon').textContent = weapon.icon;
            document.getElementById('weaponName').textContent = weapon.name;
            document.getElementById('ammoCount').textContent = `${weapon.ammo} / ${weapon.maxAmmo}`;

            // Honor
            const honorPercent = ((gameState.player.honor + 100) / 200) * 100;
            document.getElementById('honorIndicator').style.left = honorPercent + '%';

            let honorText = 'Neutral';
            if (gameState.player.honor > 50) honorText = 'Honorable';
            else if (gameState.player.honor > 20) honorText = 'Good';
            else if (gameState.player.honor < -50) honorText = 'Villain';
            else if (gameState.player.honor < -20) honorText = 'Bad';
            document.getElementById('honorText').textContent = honorText;

            // Money
            document.getElementById('moneyDisplay').textContent = '$' + gameState.player.money.toFixed(2);
        }

        function updateMinimap() {
            const canvas = document.getElementById('minimapCanvas');
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#2a5018';
            ctx.fillRect(0, 0, 200, 200);

            // Draw player
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(100, 100, 5, 0, Math.PI * 2);
            ctx.fill();

            // Draw horse if not mounted
            if (!gameState.player.onHorse) {
                const horseX = 100 + (horse.position.x - player.position.x) * 2;
                const horseZ = 100 + (horse.position.z - player.position.z) * 2;
                ctx.fillStyle = '#8b4513';
                ctx.beginPath();
                ctx.arc(horseX, horseZ, 3, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw NPCs
            npcs.forEach(npc => {
                const npcX = 100 + (npc.position.x - player.position.x) * 2;
                const npcZ = 100 + (npc.position.z - player.position.z) * 2;

                if (Math.abs(npcX - 100) < 100 && Math.abs(npcZ - 100) < 100) {
                    ctx.fillStyle = '#ffff00';
                    ctx.fillRect(npcX - 2, npcZ - 2, 4, 4);
                }
            });

            // Draw buildings
            buildings.forEach(building => {
                const buildingX = 100 + (building.position.x - player.position.x) * 2;
                const buildingZ = 100 + (building.position.z - player.position.z) * 2;

                if (Math.abs(buildingX - 100) < 100 && Math.abs(buildingZ - 100) < 100) {
                    ctx.fillStyle = '#666666';
                    ctx.fillRect(buildingX - 3, buildingZ - 3, 6, 6);
                }
            });
        }

        // ==================== UI FUNCTIONS ====================

        function toggleInventory() {
            const panel = document.getElementById('inventoryPanel');
            panel.classList.toggle('active');

            if (panel.classList.contains('active')) {
                updateInventoryDisplay();
            }
        }

        function updateInventoryDisplay() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';

            for (const [itemName, itemData] of Object.entries(gameState.inventory)) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.innerHTML = `
                    <div class="item-icon">${itemData.icon}</div>
                    <div class="item-name">${itemName}</div>
                    <div class="item-count">x${itemData.count}</div>
                `;
                itemDiv.onclick = () => useItem(itemName);
                grid.appendChild(itemDiv);
            }
        }

        function useItem(itemName) {
            const item = gameState.inventory[itemName];

            if (item.count > 0) {
                if (item.type === 'consumable') {
                    item.count--;

                    if (itemName.includes('Health')) {
                        gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + 30);
                        showNotification('Health restored!');
                    } else if (itemName.includes('Stamina')) {
                        gameState.player.stamina = gameState.player.maxStamina;
                        showNotification('Stamina restored!');
                    } else {
                        showNotification(`Used ${itemName}`);
                    }

                    updateInventoryDisplay();
                } else {
                    showNotification(`${itemName} cannot be used directly`);
                }
            }
        }

        function closeInventory() {
            document.getElementById('inventoryPanel').classList.remove('active');
        }

        function toggleMissions() {
            document.getElementById('missionPanel').classList.toggle('active');
        }

        function closeMissionPanel() {
            document.getElementById('missionPanel').classList.remove('active');
        }

        function startMission(missionType) {
            const missions = {
                'bank': {
                    title: 'The Bank Robbery',
                    description: 'Dutch has a plan to rob the Valentine bank. Meet the gang outside town.',
                    reward: 500
                },
                'train': {
                    title: 'Train Heist',
                    description: 'Stop and rob a supply train heading through the valley.',
                    reward: 750
                },
                'bounty': {
                    title: 'Bounty Hunter',
                    description: 'Capture "Black Jack" Morrison, wanted dead or alive.',
                    reward: 300
                },
                'hunt': {
                    title: 'The Legendary Bear',
                    description: 'Track and hunt the legendary grizzly bear terrorizing the region.',
                    reward: 200
                },
                'rescue': {
                    title: 'Rescue Mission',
                    description: 'Save a kidnapped homesteader from a gang of outlaws.',
                    reward: 400
                },
                'poker': {
                    title: 'High Stakes Poker',
                    description: 'Win big in a high-stakes poker game in Saint Denis.',
                    reward: 1000
                }
            };

            const mission = missions[missionType];
            gameState.missions.active = missionType;

            showNotification(`Mission Started: ${mission.title}`);
            closeMissionPanel();

            // Auto-complete after some time for demo
            setTimeout(() => {
                completeMission(missionType);
            }, 10000);
        }

        function completeMission(missionType) {
            const missions = {
                'bank': { title: 'The Bank Robbery', reward: 500 },
                'train': { title: 'Train Heist', reward: 750 },
                'bounty': { title: 'Bounty Hunter', reward: 300 },
                'hunt': { title: 'The Legendary Bear', reward: 200 },
                'rescue': { title: 'Rescue Mission', reward: 400 },
                'poker': { title: 'High Stakes Poker', reward: 1000 }
            };

            const mission = missions[missionType];

            if (gameState.missions.active === missionType) {
                gameState.missions.completed.push(missionType);
                gameState.missions.active = null;
                gameState.player.money += mission.reward;
                gameState.player.honor += 10;

                showNotification(`Mission Complete: ${mission.title}! +$${mission.reward}`);
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('active');

            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }

        // ==================== SAVE/LOAD ====================

        function saveGame() {
            const saveData = {
                gameState: gameState,
                playerPosition: {
                    x: player.position.x,
                    y: player.position.y,
                    z: player.position.z
                },
                horsePosition: {
                    x: horse.position.x,
                    y: horse.position.y,
                    z: horse.position.z
                },
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(saveData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `rdr2-save-${Date.now()}.json`;
            link.click();

            URL.revokeObjectURL(url);
            showNotification('Game saved successfully!');
        }

        function loadGame() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        const saveData = JSON.parse(event.target.result);

                        // Restore game state
                        Object.assign(gameState, saveData.gameState);

                        // Restore positions
                        player.position.set(
                            saveData.playerPosition.x,
                            saveData.playerPosition.y,
                            saveData.playerPosition.z
                        );

                        horse.position.set(
                            saveData.horsePosition.x,
                            saveData.horsePosition.y,
                            saveData.horsePosition.z
                        );

                        updateHUD();
                        showNotification(`Game loaded from ${new Date(saveData.timestamp).toLocaleString()}`);
                    } catch (error) {
                        showNotification('Error loading save file!');
                        console.error(error);
                    }
                };

                reader.readAsText(file);
            };

            input.click();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==================== START ====================

        console.log('%cü§† RED DEAD REDEMPTION 2 - Wild West Edition ü§†', 'font-size: 20px; color: #d4af37; font-weight: bold;');
        console.log('%cFull open world with exploration', 'color: #00ff00;');
        console.log('%cHorse riding, hunting, shooting', 'color: #00ff00;');
        console.log('%cMissions, NPCs, and dynamic world', 'color: #00ff00;');
        console.log('%cFull save/load system active', 'color: #00ff00;');
        console.log('%cRide into the sunset, partner!', 'color: #d4af37; font-size: 16px;');
    </script>
</body>
</html>
