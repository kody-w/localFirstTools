<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Browser - Web Interface</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .status-bar {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            background: rgba(255,255,255,0.2);
        }

        .status-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-indicator.connected .dot {
            background: var(--success);
        }

        .status-indicator.disconnected .dot {
            background: var(--danger);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .sidebar h3 {
            margin-bottom: 1rem;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 0.5rem;
        }

        .nav-menu button {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            background: var(--gray-50);
            color: var(--gray-700);
            text-align: left;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-menu button:hover {
            background: var(--gray-100);
        }

        .nav-menu button.active {
            background: var(--primary);
            color: white;
        }

        .content-area {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h3 {
            color: var(--gray-800);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .url-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .url-bar input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 6px;
            font-size: 1rem;
        }

        .url-bar input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .output-box {
            background: var(--gray-900);
            color: #00ff00;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-box:empty::before {
            content: 'Output will appear here...';
            opacity: 0.5;
        }

        .history-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: var(--gray-50);
        }

        .history-item .url {
            color: var(--primary);
            font-weight: 500;
        }

        .history-item .time {
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        .session-card {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .session-card h4 {
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .session-card .meta {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #eff6ff;
            border-left: 4px solid var(--primary);
            color: var(--primary-dark);
        }

        .alert-success {
            background: #ecfdf5;
            border-left: 4px solid var(--success);
            color: #065f46;
        }

        .alert-warning {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            color: #92400e;
        }

        .alert-danger {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .code-block {
            background: var(--gray-900);
            color: #f0f0f0;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 1rem 0;
        }

        .tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .tag-success { background: #ecfdf5; color: var(--success); }
        .tag-warning { background: #fffbeb; color: var(--warning); }
        .tag-danger { background: #fef2f2; color: var(--danger); }
        .tag-info { background: #eff6ff; color: var(--primary); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card .label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .tab-list {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: var(--primary);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Agent Browser - Web Interface</h1>
            <p>Browser automation designed for AI agents - all running locally in your browser</p>
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">
                    <span class="dot"></span>
                    <span id="statusText">Ready</span>
                </div>
                <div class="status-indicator">
                    <span>Current URL:</span>
                    <strong id="currentUrl">None</strong>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Sidebar Navigation -->
            <aside class="sidebar">
                <h3>Navigation</h3>
                <ul class="nav-menu">
                    <li><button class="active" onclick="showSection('browser')">üåê Browser</button></li>
                    <li><button onclick="showSection('extract')">üìä Extract Content</button></li>
                    <li><button onclick="showSection('interact')">üéØ Interact</button></li>
                    <li><button onclick="showSection('history')">üìú History</button></li>
                    <li><button onclick="showSection('sessions')">üíæ Sessions</button></li>
                    <li><button onclick="showSection('settings')">‚öôÔ∏è Settings</button></li>
                </ul>

                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Quick Actions</h3>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" onclick="exportData()">üì• Export Data</button>
                    <button class="btn btn-outline" style="width: 100%; margin-bottom: 0.5rem;" onclick="importData()">üì§ Import Data</button>
                    <button class="btn btn-danger" style="width: 100%;" onclick="clearAllData()">üóëÔ∏è Clear All</button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="content-area">
                <!-- Browser Section -->
                <section id="browser" class="section active">
                    <h2>üåê Browser Control</h2>

                    <div class="card">
                        <h3>Navigation</h3>
                        <div class="url-bar">
                            <input type="text" id="urlInput" placeholder="Enter URL (e.g., https://example.com)" value="https://example.com">
                            <button class="btn btn-primary" onclick="navigateToUrl()">Go</button>
                            <button class="btn btn-outline" onclick="goBack()">‚Üê</button>
                            <button class="btn btn-outline" onclick="goForward()">‚Üí</button>
                            <button class="btn btn-outline" onclick="reload()">‚Üª</button>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-outline" onclick="takeScreenshot()">üì∏ Screenshot</button>
                            <button class="btn btn-outline" onclick="getPageTitle()">üìë Get Title</button>
                            <button class="btn btn-outline" onclick="getPageContent()">üìÑ Get Content</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Browser Frame (Simulated)</h3>
                        <div class="alert alert-info">
                            ‚ÑπÔ∏è Note: This is a simulated browser interface. In a real implementation, you would use iframe or WebView2 for actual browser rendering. For security reasons, modern browsers restrict cross-origin iframe loading.
                        </div>
                        <iframe id="browserFrame" style="width: 100%; height: 500px; border: 2px solid var(--gray-300); border-radius: 8px; background: white;"></iframe>
                    </div>

                    <div class="card">
                        <h3>Output Console</h3>
                        <div class="output-box" id="outputConsole"></div>
                        <button class="btn btn-outline" style="margin-top: 0.5rem;" onclick="clearConsole()">Clear Console</button>
                    </div>
                </section>

                <!-- Extract Content Section -->
                <section id="extract" class="section">
                    <h2>üìä Extract Content</h2>

                    <div class="card">
                        <h3>Extract Structured Data</h3>
                        <div class="input-group">
                            <label>Extraction Type</label>
                            <select id="extractType">
                                <option value="text">Plain Text</option>
                                <option value="markdown">Markdown</option>
                                <option value="json">Structured JSON</option>
                                <option value="links">All Links</option>
                                <option value="images">All Images</option>
                                <option value="headings">All Headings</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="extractContent()">Extract</button>
                    </div>

                    <div class="card">
                        <h3>Custom Selector Extract</h3>
                        <div class="input-group">
                            <label>CSS Selector</label>
                            <input type="text" id="customSelector" placeholder="e.g., .article, #content, h1">
                        </div>
                        <button class="btn btn-primary" onclick="extractBySelector()">Extract by Selector</button>
                    </div>

                    <div class="card">
                        <h3>Extracted Content</h3>
                        <div class="tab-list">
                            <button class="tab-button active" onclick="showTab('preview')">Preview</button>
                            <button class="tab-button" onclick="showTab('raw')">Raw Data</button>
                            <button class="tab-button" onclick="showTab('json')">JSON</button>
                        </div>
                        <div id="preview" class="tab-content active">
                            <div id="extractPreview" class="output-box"></div>
                        </div>
                        <div id="raw" class="tab-content">
                            <div id="extractRaw" class="output-box"></div>
                        </div>
                        <div id="json" class="tab-content">
                            <div id="extractJson" class="output-box"></div>
                        </div>
                        <button class="btn btn-outline" style="margin-top: 0.5rem;" onclick="copyExtractedData()">üìã Copy to Clipboard</button>
                        <button class="btn btn-outline" style="margin-top: 0.5rem;" onclick="downloadExtractedData()">üíæ Download</button>
                    </div>
                </section>

                <!-- Interact Section -->
                <section id="interact" class="section">
                    <h2>üéØ Interact with Page</h2>

                    <div class="card">
                        <h3>Click Element</h3>
                        <div class="input-group">
                            <label>Selector</label>
                            <input type="text" id="clickSelector" placeholder="e.g., button, .submit, #login">
                        </div>
                        <button class="btn btn-primary" onclick="clickElement()">Click</button>
                    </div>

                    <div class="card">
                        <h3>Type Text</h3>
                        <div class="input-group">
                            <label>Selector</label>
                            <input type="text" id="typeSelector" placeholder="e.g., input[name='email']">
                        </div>
                        <div class="input-group">
                            <label>Text to Type</label>
                            <input type="text" id="typeText" placeholder="Enter text to type">
                        </div>
                        <button class="btn btn-primary" onclick="typeInElement()">Type</button>
                    </div>

                    <div class="card">
                        <h3>Fill Form</h3>
                        <div id="formFields">
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Selector</label>
                                    <input type="text" class="form-selector" placeholder="CSS selector">
                                </div>
                                <div class="input-group">
                                    <label>Value</label>
                                    <input type="text" class="form-value" placeholder="Value to fill">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="addFormField()">+ Add Field</button>
                        <button class="btn btn-primary" onclick="fillForm()">Fill Form</button>
                    </div>

                    <div class="card">
                        <h3>Scroll Page</h3>
                        <div class="button-group">
                            <button class="btn btn-outline" onclick="scrollPage('top')">‚¨ÜÔ∏è Top</button>
                            <button class="btn btn-outline" onclick="scrollPage('down')">‚¨áÔ∏è Down</button>
                            <button class="btn btn-outline" onclick="scrollPage('bottom')">‚¨áÔ∏è Bottom</button>
                        </div>
                    </div>
                </section>

                <!-- History Section -->
                <section id="history" class="section">
                    <h2>üìú Navigation History</h2>

                    <div class="card">
                        <h3>History</h3>
                        <ul class="history-list" id="historyList">
                            <li style="text-align: center; padding: 2rem; color: var(--gray-600);">No history yet</li>
                        </ul>
                        <button class="btn btn-danger" style="margin-top: 1rem;" onclick="clearHistory()">Clear History</button>
                    </div>

                    <div class="card">
                        <h3>Statistics</h3>
                        <div class="stats-grid" id="statsGrid">
                            <div class="stat-card">
                                <div class="value" id="statPages">0</div>
                                <div class="label">Pages Visited</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%);">
                                <div class="value" id="statExtractions">0</div>
                                <div class="label">Extractions</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);">
                                <div class="value" id="statInteractions">0</div>
                                <div class="label">Interactions</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);">
                                <div class="value" id="statSessions">0</div>
                                <div class="label">Sessions Saved</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sessions Section -->
                <section id="sessions" class="section">
                    <h2>üíæ Session Management</h2>

                    <div class="card">
                        <h3>Save Current Session</h3>
                        <div class="input-group">
                            <label>Session Name</label>
                            <input type="text" id="sessionName" placeholder="Enter session name">
                        </div>
                        <button class="btn btn-success" onclick="saveSession()">üíæ Save Session</button>
                    </div>

                    <div class="card">
                        <h3>Saved Sessions</h3>
                        <div id="sessionsList">
                            <p style="text-align: center; padding: 2rem; color: var(--gray-600);">No saved sessions</p>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings" class="section">
                    <h2>‚öôÔ∏è Settings</h2>

                    <div class="card">
                        <h3>Browser Settings</h3>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="autoSave" checked>
                                Auto-save sessions
                            </label>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="recordHistory" checked>
                                Record navigation history
                            </label>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="verboseLogging">
                                Verbose console logging
                            </label>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Data Management</h3>
                        <div class="alert alert-info">
                            ‚ÑπÔ∏è All data is stored locally in your browser's localStorage. No data is sent to any server.
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="exportData()">üì• Export All Data (JSON)</button>
                            <button class="btn btn-outline" onclick="importData()">üì§ Import Data (JSON)</button>
                            <button class="btn btn-outline" onclick="downloadStateSnapshot()">üì∏ Download Snapshot</button>
                            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>About</h3>
                        <p style="margin-bottom: 1rem;"><strong>Agent Browser v1.0.0</strong></p>
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            A browser interface designed for AI agents and automation. All functionality runs locally in your browser with full import/export capabilities.
                        </p>
                        <p style="color: var(--gray-600);">
                            Created with ‚ù§Ô∏è for the AI community
                        </p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal Title</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">Modal content</div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================

        const appState = {
            currentUrl: null,
            currentPageData: null,
            history: [],
            sessions: [],
            extractedData: null,
            statistics: {
                pagesVisited: 0,
                extractions: 0,
                interactions: 0,
                sessionsSaved: 0
            },
            settings: {
                autoSave: true,
                recordHistory: true,
                verboseLogging: false
            }
        };

        // ============================================
        // PROXY SERVER INTEGRATION
        // ============================================

        const PROXY_CONFIG = {
            enabled: true,
            serverUrl: 'http://localhost:3000',
            useCache: true
        };

        let currentPageData = null;

        // Check if proxy server is available
        async function checkProxyServer() {
            if (!PROXY_CONFIG.enabled) return false;

            try {
                const response = await fetch(`${PROXY_CONFIG.serverUrl}/api/health`, {
                    method: 'GET'
                });
                const data = await response.json();
                return data.status === 'ok';
            } catch (e) {
                return false;
            }
        }

        // Fetch page through proxy (bypasses CORS!)
        async function fetchThroughProxy(url) {
            log(`Fetching through proxy: ${url}`, 'info');

            try {
                const response = await fetch(
                    `${PROXY_CONFIG.serverUrl}/api/fetch?url=${encodeURIComponent(url)}`
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const pageData = await response.json();
                return pageData;

            } catch (error) {
                throw new Error(`Proxy fetch failed: ${error.message}`);
            }
        }

        // Load page data (from proxy or fallback to iframe)
        async function loadPageData(url) {
            try {
                if (PROXY_CONFIG.enabled) {
                    const isAvailable = await checkProxyServer();

                    if (isAvailable) {
                        const pageData = await fetchThroughProxy(url);
                        return pageData;
                    } else {
                        log('Proxy server not available, using fallback mode', 'warning');
                    }
                }

                return null;

            } catch (error) {
                log(`Error loading page: ${error.message}`, 'error');
                throw error;
            }
        }

        // Render virtual page from JSON data
        function renderVirtualPage(pageData) {
            currentPageData = pageData;
            const content = pageData.content;

            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${content.title}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 { color: #333; }
        a { color: #2563eb; }
        img { max-width: 100%; height: auto; }
        .meta { background: #f0f0f0; padding: 10px; margin-bottom: 20px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="meta">
        <strong>Loaded from JSON:</strong> ${pageData.url}<br>
        <strong>Fetched:</strong> ${new Date(pageData.fetchedAt).toLocaleString()}<br>
        <strong>Title:</strong> ${content.title}
    </div>

    <h1>${content.title}</h1>
`;

            // Add paragraphs
            if (content.paragraphs && content.paragraphs.length > 0) {
                content.paragraphs.forEach(p => {
                    html += `<p>${p}</p>\n`;
                });
            }

            // Add links section
            if (content.links && content.links.length > 0) {
                html += `<h2>Links (${content.links.length})</h2><ul>`;
                content.links.slice(0, 20).forEach(link => {
                    html += `<li><a href="${link.href}">${link.text || link.href}</a></li>`;
                });
                if (content.links.length > 20) {
                    html += `<li><em>... and ${content.links.length - 20} more links</em></li>`;
                }
                html += `</ul>`;
            }

            // Add images section
            if (content.images && content.images.length > 0) {
                html += `<h2>Images (${content.images.length})</h2>`;
                content.images.slice(0, 5).forEach(img => {
                    html += `<img src="${img.src}" alt="${img.alt || ''}" style="max-width: 200px; margin: 10px;"><br>`;
                });
                if (content.images.length > 5) {
                    html += `<p><em>... and ${content.images.length - 5} more images</em></p>`;
                }
            }

            html += `</body></html>`;

            const iframe = document.getElementById('browserFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();

            log('Virtual page rendered from JSON data', 'success');
        }

        // Convert page data to markdown
        function convertPageDataToMarkdown(content) {
            let md = `# ${content.title}\n\n`;

            if (content.meta && content.meta.description) {
                md += `> ${content.meta.description}\n\n`;
            }

            if (content.headings && content.headings.length > 0) {
                md += `## Headings\n\n`;
                content.headings.forEach(h => {
                    md += `${'#'.repeat(h.level)} ${h.text}\n`;
                });
                md += '\n';
            }

            if (content.paragraphs && content.paragraphs.length > 0) {
                md += `## Content\n\n`;
                content.paragraphs.forEach(p => {
                    md += `${p}\n\n`;
                });
            }

            if (content.links && content.links.length > 0) {
                md += `## Links\n\n`;
                content.links.slice(0, 50).forEach(link => {
                    md += `- [${link.text || 'Link'}](${link.href})\n`;
                });
            }

            return md;
        }

        // Load saved page files from server
        async function loadSavedFiles() {
            try {
                const response = await fetch(`${PROXY_CONFIG.serverUrl}/api/files`);
                const data = await response.json();

                if (data.files && data.files.length > 0) {
                    const modalBody = document.getElementById('modalBody');
                    const modalTitle = document.getElementById('modalTitle');

                    modalTitle.textContent = 'Saved Page Files';

                    let html = `<p>Found ${data.files.length} saved pages:</p><ul style="list-style: none; padding: 0;">`;

                    data.files.forEach(file => {
                        html += `
                            <li style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                                <strong>${file.url}</strong><br>
                                <small>Fetched: ${new Date(file.fetchedAt).toLocaleString()}</small><br>
                                <small>Size: ${(file.size / 1024).toFixed(1)} KB</small><br>
                                <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="loadFileFromServer('${file.path}')">Load</button>
                            </li>
                        `;
                    });

                    html += `</ul>`;
                    modalBody.innerHTML = html;
                    document.getElementById('modal').classList.add('active');
                } else {
                    showAlert('No saved files found. Fetch some pages first!', 'info');
                }

            } catch (error) {
                showAlert('Could not connect to proxy server', 'warning');
                log('Proxy server not available', 'error');
            }
        }

        // Load specific file from server
        async function loadFileFromServer(filePath) {
            try {
                const response = await fetch(
                    `${PROXY_CONFIG.serverUrl}/api/load-file?path=${encodeURIComponent(filePath)}`
                );
                const pageData = await response.json();

                renderVirtualPage(pageData);
                currentPageData = pageData;
                appState.currentUrl = pageData.url;
                appState.currentPageData = pageData;
                document.getElementById('currentUrl').textContent = pageData.url;
                document.getElementById('urlInput').value = pageData.url;

                closeModal();
                log(`Loaded file: ${filePath}`, 'success');

            } catch (error) {
                showAlert('Error loading file: ' + error.message, 'danger');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async function() {
            loadStateFromLocalStorage();
            updateUI();
            log('Agent Browser initialized', 'success');

            // Check proxy server
            const available = await checkProxyServer();

            if (available) {
                log('‚úÖ Proxy server connected - CORS bypass enabled!', 'success');
                document.getElementById('statusIndicator').classList.add('connected');
                document.getElementById('statusText').textContent = 'Proxy Connected';

                // Add "Load Files" button to sidebar
                const sidebar = document.querySelector('.sidebar');
                const divider = document.createElement('div');
                divider.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--gray-200);';
                divider.innerHTML = `
                    <button class="btn btn-success" style="width: 100%; margin-bottom: 0.5rem;" onclick="loadSavedFiles()">üìÇ Load Saved Pages</button>
                `;
                sidebar.appendChild(divider);

            } else {
                log('‚ö†Ô∏è Proxy server not available - Limited to same-origin pages', 'warning');
                log('üí° Start proxy: node proxy-server.js', 'info');
                document.getElementById('statusIndicator').classList.add('disconnected');
                document.getElementById('statusText').textContent = 'Proxy Disconnected';
            }
        });

        // ============================================
        // NAVIGATION
        // ============================================

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-menu button').forEach(b => b.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        function showTab(tabId) {
            event.target.parentElement.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            event.target.closest('.card').querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        // ============================================
        // BROWSER FUNCTIONS
        // ============================================

        async function navigateToUrl() {
            const url = document.getElementById('urlInput').value.trim();

            if (!url) {
                showAlert('Please enter a URL', 'warning');
                return;
            }

            // Validate URL
            let finalUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                finalUrl = 'https://' + url;
            }

            try {
                new URL(finalUrl); // Validate

                appState.currentUrl = finalUrl;
                document.getElementById('currentUrl').textContent = finalUrl;

                // Show loading
                log(`Loading: ${finalUrl}`, 'info');
                const iframe = document.getElementById('browserFrame');
                iframe.srcdoc = '<div style="padding: 20px; text-align: center;">Loading...</div>';

                // Try to load through proxy
                const pageData = await loadPageData(finalUrl);

                if (pageData) {
                    // Success! Render virtual page
                    renderVirtualPage(pageData);

                    // Add to history
                    if (appState.settings.recordHistory) {
                        appState.history.unshift({
                            url: finalUrl,
                            timestamp: new Date().toISOString(),
                            title: pageData.content.title
                        });
                        appState.statistics.pagesVisited++;
                    }

                    // Store page data for extraction
                    appState.currentPageData = pageData;

                    updateUI();
                    saveStateToLocalStorage();

                } else {
                    // Fallback to iframe
                    log('Falling back to iframe mode', 'warning');
                    iframe.src = finalUrl;

                    if (appState.settings.recordHistory) {
                        appState.history.unshift({
                            url: finalUrl,
                            timestamp: new Date().toISOString(),
                            title: 'Loading...'
                        });
                        appState.statistics.pagesVisited++;
                    }

                    iframe.onload = function() {
                        try {
                            const title = iframe.contentDocument.title || finalUrl;
                            if (appState.history[0]) {
                                appState.history[0].title = title;
                            }
                            log(`Loaded via iframe: ${finalUrl}`, 'success');
                        } catch (e) {
                            log(`Loaded: ${finalUrl} (cross-origin, limited access)`, 'warning');
                        }
                        updateUI();
                        saveStateToLocalStorage();
                    };
                }

            } catch (e) {
                showAlert('Invalid URL format', 'danger');
                log(`Invalid URL: ${url}`, 'error');
            }
        }

        function goBack() {
            if (appState.history.length > 1) {
                // Simple back simulation
                const previousUrl = appState.history[1].url;
                document.getElementById('urlInput').value = previousUrl;
                navigateToUrl();
                log('Navigated back', 'info');
            } else {
                showAlert('No previous page in history', 'warning');
            }
        }

        function goForward() {
            showAlert('Forward navigation not implemented in this demo', 'info');
        }

        function reload() {
            if (appState.currentUrl) {
                const iframe = document.getElementById('browserFrame');
                iframe.src = iframe.src;
                log('Page reloaded', 'info');
            } else {
                showAlert('No page loaded', 'warning');
            }
        }

        function takeScreenshot() {
            showAlert('Screenshot functionality requires server-side implementation', 'info');
            log('Screenshot requested (not implemented in browser-only version)', 'warning');
        }

        function getPageTitle() {
            const iframe = document.getElementById('browserFrame');
            try {
                const title = iframe.contentDocument.title;
                log(`Page Title: ${title}`, 'success');
                showAlert(`Title: ${title}`, 'success');
            } catch (e) {
                showAlert('Cannot access page title (cross-origin restriction)', 'warning');
                log('Cannot access page (cross-origin)', 'error');
            }
        }

        function getPageContent() {
            const iframe = document.getElementById('browserFrame');
            try {
                const content = iframe.contentDocument.body.innerText;
                const preview = content.substring(0, 500);
                log(`Page Content (${content.length} chars):\n${preview}...`, 'success');
                showAlert(`Content extracted (${content.length} characters)`, 'success');

                appState.extractedData = {
                    type: 'text',
                    content: content,
                    url: appState.currentUrl,
                    timestamp: new Date().toISOString()
                };
                appState.statistics.extractions++;
                saveStateToLocalStorage();
            } catch (e) {
                showAlert('Cannot access page content (cross-origin restriction)', 'warning');
                log('Cannot access page content (cross-origin)', 'error');
            }
        }

        // ============================================
        // EXTRACTION FUNCTIONS
        // ============================================

        function extractContent() {
            const type = document.getElementById('extractType').value;

            // If we have JSON page data, extract from that
            if (currentPageData && currentPageData.content) {
                const content = currentPageData.content;
                let extracted = null;

                switch(type) {
                    case 'text':
                        extracted = content.bodyText;
                        break;

                    case 'markdown':
                        extracted = convertPageDataToMarkdown(content);
                        break;

                    case 'json':
                        extracted = content;
                        break;

                    case 'links':
                        extracted = content.links;
                        break;

                    case 'images':
                        extracted = content.images;
                        break;

                    case 'headings':
                        extracted = content.headings;
                        break;
                }

                appState.extractedData = {
                    type: type,
                    content: extracted,
                    url: currentPageData.url,
                    timestamp: new Date().toISOString()
                };

                displayExtractedContent(extracted, type);
                appState.statistics.extractions++;
                saveStateToLocalStorage();
                log(`Extracted ${type} from JSON data`, 'success');

                return;
            }

            // Fallback to original iframe extraction
            const iframe = document.getElementById('browserFrame');

            try {
                const doc = iframe.contentDocument;
                let extracted = null;

                switch(type) {
                    case 'text':
                        extracted = doc.body.innerText;
                        break;

                    case 'markdown':
                        extracted = convertToMarkdown(doc.body.innerHTML);
                        break;

                    case 'json':
                        extracted = extractStructuredData(doc);
                        break;

                    case 'links':
                        const links = Array.from(doc.querySelectorAll('a[href]')).map(a => ({
                            text: a.innerText.trim(),
                            href: a.href,
                            title: a.title || null
                        }));
                        extracted = links;
                        break;

                    case 'images':
                        const images = Array.from(doc.querySelectorAll('img[src]')).map(img => ({
                            src: img.src,
                            alt: img.alt || null,
                            title: img.title || null
                        }));
                        extracted = images;
                        break;

                    case 'headings':
                        const headings = Array.from(doc.querySelectorAll('h1, h2, h3, h4, h5, h6')).map(h => ({
                            level: parseInt(h.tagName[1]),
                            text: h.innerText.trim(),
                            id: h.id || null
                        }));
                        extracted = headings;
                        break;
                }

                appState.extractedData = {
                    type: type,
                    content: extracted,
                    url: appState.currentUrl,
                    timestamp: new Date().toISOString()
                };

                displayExtractedContent(extracted, type);
                appState.statistics.extractions++;
                saveStateToLocalStorage();
                log(`Extracted ${type} content successfully`, 'success');

            } catch (e) {
                showAlert('Cannot extract content (cross-origin restriction)', 'warning');
                log(`Extraction failed: ${e.message}`, 'error');
            }
        }

        function extractBySelector() {
            const selector = document.getElementById('customSelector').value.trim();
            if (!selector) {
                showAlert('Please enter a CSS selector', 'warning');
                return;
            }

            const iframe = document.getElementById('browserFrame');
            try {
                const doc = iframe.contentDocument;
                const elements = Array.from(doc.querySelectorAll(selector));

                const extracted = elements.map(el => ({
                    tagName: el.tagName.toLowerCase(),
                    text: el.innerText ? el.innerText.trim() : null,
                    html: el.innerHTML,
                    attributes: Array.from(el.attributes).reduce((acc, attr) => {
                        acc[attr.name] = attr.value;
                        return acc;
                    }, {})
                }));

                appState.extractedData = {
                    type: 'selector',
                    selector: selector,
                    content: extracted,
                    url: appState.currentUrl,
                    timestamp: new Date().toISOString()
                };

                displayExtractedContent(extracted, 'json');
                appState.statistics.extractions++;
                saveStateToLocalStorage();
                log(`Extracted ${extracted.length} elements matching "${selector}"`, 'success');

            } catch (e) {
                showAlert('Extraction failed: ' + e.message, 'danger');
                log(`Extraction error: ${e.message}`, 'error');
            }
        }

        function displayExtractedContent(content, type) {
            const preview = document.getElementById('extractPreview');
            const raw = document.getElementById('extractRaw');
            const json = document.getElementById('extractJson');

            if (typeof content === 'string') {
                preview.textContent = content.substring(0, 2000) + (content.length > 2000 ? '...' : '');
                raw.textContent = content;
                json.textContent = JSON.stringify({ content }, null, 2);
            } else {
                preview.textContent = JSON.stringify(content, null, 2).substring(0, 2000);
                raw.textContent = JSON.stringify(content);
                json.textContent = JSON.stringify(content, null, 2);
            }
        }

        function extractStructuredData(doc) {
            return {
                title: doc.title,
                url: doc.location.href,
                meta: {
                    description: doc.querySelector('meta[name="description"]')?.content || null,
                    keywords: doc.querySelector('meta[name="keywords"]')?.content || null
                },
                headings: Array.from(doc.querySelectorAll('h1, h2, h3')).map(h => ({
                    level: parseInt(h.tagName[1]),
                    text: h.innerText.trim()
                })),
                links: Array.from(doc.querySelectorAll('a[href]')).slice(0, 50).map(a => ({
                    text: a.innerText.trim(),
                    href: a.href
                })),
                paragraphs: Array.from(doc.querySelectorAll('p')).slice(0, 10).map(p => p.innerText.trim())
            };
        }

        function convertToMarkdown(html) {
            // Simple HTML to Markdown conversion
            let md = html;
            md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
            md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
            md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
            md = md.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
            md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
            md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
            md = md.replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
            md = md.replace(/<br\s*\/?>/gi, '\n');
            md = md.replace(/<[^>]+>/g, '');
            md = md.replace(/\n{3,}/g, '\n\n');
            return md.trim();
        }

        // ============================================
        // INTERACTION FUNCTIONS
        // ============================================

        function clickElement() {
            const selector = document.getElementById('clickSelector').value.trim();
            if (!selector) {
                showAlert('Please enter a selector', 'warning');
                return;
            }

            const iframe = document.getElementById('browserFrame');
            try {
                const element = iframe.contentDocument.querySelector(selector);
                if (element) {
                    element.click();
                    log(`Clicked element: ${selector}`, 'success');
                    appState.statistics.interactions++;
                    saveStateToLocalStorage();
                } else {
                    showAlert('Element not found', 'warning');
                }
            } catch (e) {
                showAlert('Cannot interact with page (cross-origin restriction)', 'warning');
                log(`Interaction failed: ${e.message}`, 'error');
            }
        }

        function typeInElement() {
            const selector = document.getElementById('typeSelector').value.trim();
            const text = document.getElementById('typeText').value;

            if (!selector || !text) {
                showAlert('Please enter selector and text', 'warning');
                return;
            }

            const iframe = document.getElementById('browserFrame');
            try {
                const element = iframe.contentDocument.querySelector(selector);
                if (element) {
                    element.value = text;
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                    log(`Typed "${text}" into ${selector}`, 'success');
                    appState.statistics.interactions++;
                    saveStateToLocalStorage();
                } else {
                    showAlert('Element not found', 'warning');
                }
            } catch (e) {
                showAlert('Cannot interact with page (cross-origin restriction)', 'warning');
                log(`Interaction failed: ${e.message}`, 'error');
            }
        }

        function addFormField() {
            const container = document.getElementById('formFields');
            const fieldHtml = `
                <div class="input-row">
                    <div class="input-group">
                        <label>Selector</label>
                        <input type="text" class="form-selector" placeholder="CSS selector">
                    </div>
                    <div class="input-group">
                        <label>Value</label>
                        <input type="text" class="form-value" placeholder="Value to fill">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', fieldHtml);
        }

        function fillForm() {
            const selectors = Array.from(document.querySelectorAll('.form-selector'));
            const values = Array.from(document.querySelectorAll('.form-value'));

            if (selectors.length === 0) {
                showAlert('Please add form fields', 'warning');
                return;
            }

            const iframe = document.getElementById('browserFrame');
            let successCount = 0;

            try {
                selectors.forEach((selectorInput, i) => {
                    const selector = selectorInput.value.trim();
                    const value = values[i].value;

                    if (selector && value) {
                        const element = iframe.contentDocument.querySelector(selector);
                        if (element) {
                            element.value = value;
                            element.dispatchEvent(new Event('input', { bubbles: true }));
                            successCount++;
                        }
                    }
                });

                log(`Filled ${successCount} form fields`, 'success');
                appState.statistics.interactions++;
                saveStateToLocalStorage();
                showAlert(`Filled ${successCount} fields successfully`, 'success');

            } catch (e) {
                showAlert('Cannot interact with page (cross-origin restriction)', 'warning');
                log(`Form fill failed: ${e.message}`, 'error');
            }
        }

        function scrollPage(direction) {
            const iframe = document.getElementById('browserFrame');
            try {
                const win = iframe.contentWindow;
                switch(direction) {
                    case 'top':
                        win.scrollTo(0, 0);
                        break;
                    case 'down':
                        win.scrollBy(0, win.innerHeight * 0.8);
                        break;
                    case 'bottom':
                        win.scrollTo(0, win.document.body.scrollHeight);
                        break;
                }
                log(`Scrolled ${direction}`, 'success');
            } catch (e) {
                showAlert('Cannot scroll page (cross-origin restriction)', 'warning');
            }
        }

        // ============================================
        // SESSION MANAGEMENT
        // ============================================

        function saveSession() {
            const name = document.getElementById('sessionName').value.trim();
            if (!name) {
                showAlert('Please enter a session name', 'warning');
                return;
            }

            const session = {
                name: name,
                url: appState.currentUrl,
                history: [...appState.history],
                extractedData: appState.extractedData,
                timestamp: new Date().toISOString()
            };

            appState.sessions.push(session);
            appState.statistics.sessionsSaved++;
            saveStateToLocalStorage();
            updateUI();

            document.getElementById('sessionName').value = '';
            log(`Session "${name}" saved`, 'success');
            showAlert(`Session "${name}" saved successfully`, 'success');
        }

        function loadSession(session) {
            appState.currentUrl = session.url;
            appState.history = [...session.history];
            appState.extractedData = session.extractedData;

            if (session.url) {
                document.getElementById('urlInput').value = session.url;
                navigateToUrl();
            }

            updateUI();
            log(`Session "${session.name}" loaded`, 'success');
            showAlert(`Session "${session.name}" loaded`, 'success');
        }

        function deleteSession(index) {
            if (confirm('Delete this session?')) {
                const session = appState.sessions[index];
                appState.sessions.splice(index, 1);
                saveStateToLocalStorage();
                updateUI();
                log(`Session "${session.name}" deleted`, 'info');
            }
        }

        // ============================================
        // DATA MANAGEMENT
        // ============================================

        function exportData() {
            const exportData = {
                version: '1.0.0',
                exportDate: new Date().toISOString(),
                state: appState
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agent-browser-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('Data exported successfully', 'success');
            showAlert('Data exported successfully', 'success');
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);

                    if (imported.state) {
                        // Merge or replace state
                        if (confirm('Replace current data with imported data?')) {
                            Object.assign(appState, imported.state);
                            saveStateToLocalStorage();
                            updateUI();
                            log('Data imported successfully', 'success');
                            showAlert('Data imported successfully', 'success');
                        }
                    } else {
                        showAlert('Invalid import file format', 'danger');
                    }
                } catch (err) {
                    showAlert('Error importing data: ' + err.message, 'danger');
                    log('Import error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        function downloadStateSnapshot() {
            const snapshot = {
                timestamp: new Date().toISOString(),
                currentUrl: appState.currentUrl,
                history: appState.history,
                statistics: appState.statistics
            };

            const dataStr = JSON.stringify(snapshot, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `snapshot-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('Snapshot downloaded', 'success');
        }

        function clearAllData() {
            if (confirm('Clear all data? This cannot be undone.')) {
                localStorage.removeItem('agentBrowserState');
                location.reload();
            }
        }

        function clearHistory() {
            if (confirm('Clear navigation history?')) {
                appState.history = [];
                appState.statistics.pagesVisited = 0;
                saveStateToLocalStorage();
                updateUI();
                log('History cleared', 'info');
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function copyExtractedData() {
            if (!appState.extractedData) {
                showAlert('No data to copy', 'warning');
                return;
            }

            const text = typeof appState.extractedData.content === 'string'
                ? appState.extractedData.content
                : JSON.stringify(appState.extractedData.content, null, 2);

            navigator.clipboard.writeText(text).then(() => {
                showAlert('Copied to clipboard', 'success');
                log('Data copied to clipboard', 'success');
            }).catch(err => {
                showAlert('Failed to copy', 'danger');
            });
        }

        function downloadExtractedData() {
            if (!appState.extractedData) {
                showAlert('No data to download', 'warning');
                return;
            }

            const content = typeof appState.extractedData.content === 'string'
                ? appState.extractedData.content
                : JSON.stringify(appState.extractedData.content, null, 2);

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `extracted-${Date.now()}.${appState.extractedData.type === 'json' ? 'json' : 'txt'}`;
            a.click();
            URL.revokeObjectURL(url);

            log('Data downloaded', 'success');
        }

        function clearConsole() {
            document.getElementById('outputConsole').textContent = '';
        }

        function log(message, type = 'info') {
            const console = document.getElementById('outputConsole');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                info: '[INFO]',
                success: '[SUCCESS]',
                warning: '[WARNING]',
                error: '[ERROR]'
            }[type] || '[LOG]';

            const line = `${timestamp} ${prefix} ${message}\n`;
            console.textContent += line;
            console.scrollTop = console.scrollHeight;

            if (appState.settings.verboseLogging) {
                console.log(`[AgentBrowser] ${message}`);
            }
        }

        function showAlert(message, type = 'info') {
            // Simple alert for now, could be enhanced with toast notifications
            const alertClass = `alert-${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // ============================================
        // STATE PERSISTENCE
        // ============================================

        function saveStateToLocalStorage() {
            try {
                localStorage.setItem('agentBrowserState', JSON.stringify(appState));
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        function loadStateFromLocalStorage() {
            try {
                const saved = localStorage.getItem('agentBrowserState');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    Object.assign(appState, loaded);
                }
            } catch (e) {
                console.error('Failed to load state:', e);
            }
        }

        // ============================================
        // UI UPDATE
        // ============================================

        function updateUI() {
            // Update history list
            const historyList = document.getElementById('historyList');
            if (appState.history.length === 0) {
                historyList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--gray-600);">No history yet</li>';
            } else {
                historyList.innerHTML = appState.history.map((item, index) => `
                    <li class="history-item" onclick="navigateToHistoryItem(${index})">
                        <div class="url">${item.title || item.url}</div>
                        <div class="time">${new Date(item.timestamp).toLocaleString()}</div>
                    </li>
                `).join('');
            }

            // Update sessions list
            const sessionsList = document.getElementById('sessionsList');
            if (appState.sessions.length === 0) {
                sessionsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray-600);">No saved sessions</p>';
            } else {
                sessionsList.innerHTML = appState.sessions.map((session, index) => `
                    <div class="session-card">
                        <h4>${session.name}</h4>
                        <div class="meta">
                            <div>URL: ${session.url || 'None'}</div>
                            <div>Saved: ${new Date(session.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="button-group" style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="loadSession(appState.sessions[${index}])">Load</button>
                            <button class="btn btn-danger" onclick="deleteSession(${index})">Delete</button>
                        </div>
                    </div>
                `).join('');
            }

            // Update statistics
            document.getElementById('statPages').textContent = appState.statistics.pagesVisited;
            document.getElementById('statExtractions').textContent = appState.statistics.extractions;
            document.getElementById('statInteractions').textContent = appState.statistics.interactions;
            document.getElementById('statSessions').textContent = appState.statistics.sessionsSaved;

            // Update current URL display
            document.getElementById('currentUrl').textContent = appState.currentUrl || 'None';
        }

        function navigateToHistoryItem(index) {
            const item = appState.history[index];
            document.getElementById('urlInput').value = item.url;
            navigateToUrl();
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================

        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to navigate
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                if (document.activeElement.id === 'urlInput') {
                    navigateToUrl();
                }
            }

            // Ctrl/Cmd + S to save session
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                showSection('sessions');
                document.getElementById('sessionName').focus();
            }

            // Ctrl/Cmd + E to export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }
        });

        // ============================================
        // AUTO-SAVE
        // ============================================

        setInterval(function() {
            if (appState.settings.autoSave) {
                saveStateToLocalStorage();
            }
        }, 30000); // Auto-save every 30 seconds

        // Log integration status
        console.log('ü§ñ Agent Browser - Proxy Integration Active');
        console.log('üì° Proxy Server:', PROXY_CONFIG.enabled ? PROXY_CONFIG.serverUrl : 'Disabled');
    </script>
</body>
</html>
