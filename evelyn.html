<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LEVIATHAN">
    <title>LEVIATHAN: OMNIVERSE</title>
    <style>
        /* System fonts - local-first compliant */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

        :root {
            --app-height: 100vh;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            
            /* Colors & Tokens */
            --color-bg-dark: rgba(10, 15, 20, 0.95);
            --color-border-default: #445;
            --color-text-accent: #fb0;
            --touch-min: 44px;
        }

        body {
            margin: 0; overflow: hidden;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: #000; color: #fff;
            touch-action: none;
        }

        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* UI Layer */
        .ui-layer {
            position: fixed; pointer-events: none; width: 100%; height: 100%; z-index: 200;
        }

        /* Top HUD */
        .hud-top {
            position: absolute; top: 0; left: 0; right: 0;
            background: linear-gradient(to bottom, rgba(0,10,20,0.95), transparent);
            padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            pointer-events: auto; z-index: 250;
        }

        .game-title {
            font-family: Georgia, serif; font-size: 24px; color: #00ffff;
            text-shadow: 0 0 10px rgba(0,255,255,0.5); letter-spacing: 4px; font-weight: bold;
        }
        .subtitle { color: #666; font-size: 12px; margin-top: 4px; }

        .stats-box { display: flex; gap: 15px; text-align: right; }
        .stat-entry { display: flex; flex-direction: column; }
        .stat-val { font-size: 20px; color: #00ff00; font-weight: bold; }
        .stat-lbl { font-size: 10px; color: #666; text-transform: uppercase; }

        /* Controls Bar */
        .data-controls {
            position: fixed; top: 8px; left: 220px; right: 180px; z-index: 1000;
            display: flex; flex-wrap: wrap; gap: 4px; pointer-events: auto;
            justify-content: center; align-items: flex-start;
        }
        .data-controls button {
            background: rgba(0, 255, 255, 0.15); border: 1px solid #0ff; color: #0ff;
            padding: 5px 10px; font-size: 11px; cursor: pointer; border-radius: 4px;
            transition: all 0.2s; white-space: nowrap;
        }
        .data-controls button:hover {
            background: rgba(0, 255, 255, 0.3); transform: translateY(-1px);
        }

        /* --- CHARACTER LAB STYLES (v8.5) --- */
        .char-lab-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 20000;
            justify-content: center; align-items: center; backdrop-filter: blur(10px);
            pointer-events: auto;
        }
        .char-lab-content {
            display: flex; width: 90%; max-width: 1000px; height: 80vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #0d0d1a 100%);
            border: 2px solid #00ffff; border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
        }
        .char-lab-preview {
            flex: 2; background: radial-gradient(circle at center, #2a2a3a 0%, #000000 100%);
            position: relative; border-right: 1px solid rgba(0, 255, 255, 0.3);
        }
        .char-lab-controls {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column;
            gap: 15px; background: rgba(0, 0, 0, 0.5);
        }
        .lab-section-title {
            color: #00ffff; font-size: 14px; font-weight: bold; text-transform: uppercase;
            border-bottom: 1px solid #00aaaa; padding-bottom: 5px; margin-bottom: 10px;
        }
        .lab-btn-row { display: flex; gap: 10px; }
        .lab-btn {
            flex: 1; padding: 10px; background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.5); color: #fff; cursor: pointer;
            transition: all 0.2s; border-radius: 5px; font-weight: bold; font-size: 12px;
        }
        .lab-btn:hover { background: rgba(0, 255, 255, 0.3); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }
        .lab-btn.primary { background: linear-gradient(135deg, #00ffff, #0088ff); color: #000; border: none; }
        .lab-btn.success { background: linear-gradient(135deg, #00ff88, #008844); color: #000; border: none; }
        .lab-input { width: 100%; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff; border-radius: 4px; }

        /* RTS Panels */
        .rts-panel-toggles {
            position: fixed; bottom: 12px; left: 12px; display: flex; gap: 4px;
            z-index: 1003; pointer-events: auto;
        }
        .rts-toggle-btn {
            width: 44px; height: 44px; background: #0a0f14; border: 2px solid #445;
            border-radius: 6px; color: #fb0; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* Loading Screen */
        .loading {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: #000; color: #0f0; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 999;
        }

        /* Generic Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: none; justify-content: center;
            align-items: center; z-index: 2000; pointer-events: auto;
        }
        .modal-content {
            background: #1a1a2e; border: 2px solid #0ff; border-radius: 12px;
            padding: 25px; max-width: 400px; width: 90%; max-height: 90vh; overflow-y: auto;
        }
        .modal-close { float: right; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }

        /* Mobile */
        @media (max-width: 768px) {
            .char-lab-content { flex-direction: column; width: 95%; height: 95%; }
            .data-controls { position: fixed; bottom: 70px; left: 10px; right: 10px; top: auto; justify-content: flex-start; overflow-x: auto; }
        }
        
        /* Notifications */
        .notification {
            position: fixed; top: 180px; left: 50%; transform: translateX(-50%);
            background: rgba(0,100,0,0.9); border: 1px solid #0f0; padding: 10px 20px;
            border-radius: 4px; color: #0f0; z-index: 500; animation: fadeOut 3s forwards; pointer-events: none;
        }
        @keyframes fadeOut { 0% { opacity: 0; transform: translate(-50%, 20px); } 10% { opacity: 1; transform: translate(-50%, 0); } 80% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>INITIALIZING OMNIVERSE...</div>
    </div>

    <div id="container"></div>

    <div class="ui-layer">
        <div class="data-controls">
            <button onclick="showStatsPanel()">Stats</button>
            <button onclick="openCodexModal()" style="background: linear-gradient(135deg, #ffd700, #ff8c00);">Codex</button>
            <button onclick="openQuestModal()" style="background: linear-gradient(135deg, #ff8c00, #ff4400);">Quests</button>
            <button onclick="openMasteryModal()" style="background: linear-gradient(135deg, #ff44ff, #8844ff);">Mastery</button>
            <button onclick="openPortalModal()" style="background: linear-gradient(135deg, #8844ff, #4488ff);">Portals</button>
            <button onclick="openEvolutionModal()" style="background: linear-gradient(135deg, #aa44ff, #ff44aa);">Evolve</button>
            <button onclick="showSettingsModal()">Settings</button>
            <!-- v8.5: Character Lab Button -->
            <button onclick="CharacterLab.open()" style="background: linear-gradient(135deg, #00d2ff, #3a7bd5); border-color: #00d2ff; color: #fff;">üß¨ Char Lab</button>
            <button onclick="openRappidModal()" style="background: linear-gradient(135deg, #7b2cbf, #3a0ca3); border-color: #7b2cbf; color: #fff;">RAPPID</button>
            <button onclick="quickSave()">Save</button>
            <button onclick="exportData()">Export</button>
            <button onclick="document.getElementById('importFile').click()">Import</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        </div>

        <div class="hud-top">
            <div>
                <div class="game-title">LEVIATHAN</div>
                <div class="subtitle">GALAXY SIMULATION v7.22</div>
            </div>
            <div class="stats-box">
                <div class="stat-entry">
                    <span class="stat-val" id="civ-count">0</span>
                    <span class="stat-lbl">Civilizations</span>
                </div>
                <div class="stat-entry">
                    <span class="stat-val" id="total-playtime">0:00</span>
                    <span class="stat-lbl">Playtime</span>
                </div>
            </div>
        </div>

        <div class="rts-panel-toggles">
            <div class="rts-toggle-btn" onclick="toggleRTSPanel('skills')">üìä</div>
            <div class="rts-toggle-btn" onclick="toggleRTSPanel('crafting')">üî®</div>
            <div class="rts-toggle-btn" onclick="toggleRTSPanel('inventory')">üéí</div>
            <div class="rts-toggle-btn" onclick="toggleRTSPanel('equipment')">‚öîÔ∏è</div>
        </div>
    </div>

    <!-- v8.5: Character Lab Modal -->
    <div id="char-lab-modal" class="char-lab-modal">
        <div class="char-lab-content">
            <div class="char-lab-preview" id="char-lab-canvas-container">
                <div style="position: absolute; top: 15px; left: 15px; color: #00ffff; font-size: 12px; font-family: monospace; text-shadow: 0 0 5px #00ffff;">
                    // LIVE PREVIEW <br> // DRAG TO ROTATE
                </div>
            </div>
            <div class="char-lab-controls">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #fff;">MODEL LAB</h2>
                    <button onclick="CharacterLab.close()" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
                </div>

                <div class="lab-section-title">Generation</div>
                <div class="lab-btn-row">
                    <button class="lab-btn primary" onclick="CharacterLab.generateRandom()">üé≤ Randomize</button>
                </div>
                <div style="margin-top: 10px;">
                    <select id="char-archetype" class="lab-input" onchange="CharacterLab.generateRandom()">
                        <option value="explorer">Archetype: Explorer (Orange)</option>
                        <option value="warrior">Archetype: Warrior (Red)</option>
                        <option value="miner">Archetype: Industrial (Grey)</option>
                        <option value="void">Archetype: Void Walker (Purple)</option>
                    </select>
                </div>

                <div class="lab-section-title" style="margin-top: 20px;">Data IO</div>
                <div class="lab-btn-row">
                    <button class="lab-btn" onclick="CharacterLab.exportToJson()">üíæ Export</button>
                    <button class="lab-btn" onclick="document.getElementById('model-upload').click()">üìÇ Import</button>
                    <input type="file" id="model-upload" style="display:none" accept=".json" onchange="CharacterLab.importFromJson(this)">
                </div>

                <div class="lab-section-title" style="margin-top: 20px;">Deploy</div>
                <button class="lab-btn success" style="padding: 15px;" onclick="CharacterLab.applyToPlayer()">
                    ‚úì APPLY TO PLAYER
                </button>
            </div>
        </div>
    </div>

    <!-- Placeholders for other modals to prevent errors -->
    <div id="stats-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').style.display='none'">√ó</button><h2>Stats</h2><div id="stats-content"></div></div></div>
    <div id="codex-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').style.display='none'">√ó</button><h2>Codex</h2></div></div>
    <div id="quest-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').style.display='none'">√ó</button><h2>Quests</h2></div></div>
    <div id="mastery-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').style.display='none'">√ó</button><h2>Mastery</h2></div></div>
    <div id="portal-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').style.display='none'">√ó</button><h2>Portals</h2></div></div>
    <div id="evolution-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').style.display='none'">√ó</button><h2>Evolution</h2></div></div>
    <div id="settings-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').style.display='none'">√ó</button><h2>Settings</h2></div></div>
    <div id="ai-settings-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close" onclick="this.closest('.modal-overlay').classList.remove('active')">√ó</button><h2>RAPPID</h2></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // --- GAME CORE & STATE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        
        // Game State
        let worldState = { player: null, interactables: [], mobs: [] };
        let gameData = { inventory: [], skills: {}, player: { hp: 100, maxHp: 100 } };
        let mode = 'galaxy'; // galaxy, world
        
        // Setup
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);
        camera.position.z = 10;

        // --- MODEL LOADER SYSTEM ---
        const ModelLoader = {
            buildMesh(modelData) {
                if (!modelData || !modelData.parts) {
                    console.warn('[ModelLoader] Invalid data');
                    return null;
                }
                const group = new THREE.Group();
                
                modelData.parts.forEach(part => {
                    let geo;
                    if(part.geometry.type === 'box') geo = new THREE.BoxGeometry(part.geometry.width, part.geometry.height, part.geometry.depth);
                    else geo = new THREE.BoxGeometry(1,1,1);
                    
                    const mat = new THREE.MeshStandardMaterial({
                        color: new THREE.Color(part.material.color),
                        emissive: part.material.emissive ? new THREE.Color(part.material.emissive) : 0x000000,
                        emissiveIntensity: part.material.emissiveIntensity || 0,
                        roughness: 0.5, metalness: 0.5
                    });
                    
                    const mesh = new THREE.Mesh(geo, mat);
                    if(part.position) mesh.position.set(part.position.x, part.position.y, part.position.z);
                    group.add(mesh);
                    
                    if(part.children) {
                        part.children.forEach(child => {
                            // Recursion simplified for this demo block
                            const cGeo = new THREE.BoxGeometry(child.geometry.width, child.geometry.height, child.geometry.depth);
                            const cMat = new THREE.MeshStandardMaterial({ color: child.material.color, emissive: child.material.emissive || 0x000000 });
                            const cMesh = new THREE.Mesh(cGeo, cMat);
                            if(child.position) cMesh.position.set(child.position.x, child.position.y, child.position.z);
                            mesh.add(cMesh);
                        });
                    }
                });
                return group;
            }
        };

        // --- CHARACTER LAB SYSTEM (v8.5) ---
        const CharacterLab = {
            active: false,
            previewScene: null,
            previewCamera: null,
            previewRenderer: null,
            previewMesh: null,
            currentModelData: null,
            
            init() {
                if(this.previewRenderer) return;
                const container = document.getElementById('char-lab-canvas-container');
                this.previewScene = new THREE.Scene();
                this.previewScene.background = new THREE.Color(0x1a1a2e);
                
                const grid = new THREE.GridHelper(10, 10, 0x00ffff, 0x222222);
                grid.position.y = -2;
                this.previewScene.add(grid);
                
                const ambient = new THREE.AmbientLight(0xffffff, 0.6);
                this.previewScene.add(ambient);
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 10, 7);
                this.previewScene.add(dirLight);

                this.previewCamera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 100);
                this.previewCamera.position.set(0, 0, 8);
                
                this.previewRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.previewRenderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(this.previewRenderer.domElement);
                
                this.animate();
            },
            
            animate() {
                if(!this.active) return;
                requestAnimationFrame(() => this.animate());
                if(this.previewMesh) this.previewMesh.rotation.y += 0.005;
                this.previewRenderer.render(this.previewScene, this.previewCamera);
            },
            
            open() {
                this.init();
                document.getElementById('char-lab-modal').style.display = 'flex';
                this.active = true;
                if(!this.currentModelData) this.generateRandom();
                this.animate();
            },
            
            close() {
                document.getElementById('char-lab-modal').style.display = 'none';
                this.active = false;
            },
            
            generateRandom() {
                const type = document.getElementById('char-archetype').value;
                let colors = { pri: 0x888888, sec: 0x444444, emi: 0x00ffff };
                
                if(type === 'explorer') colors = { pri: 0xffaa00, sec: 0x333333, emi: 0x00ffff };
                if(type === 'warrior') colors = { pri: 0xaa0000, sec: 0x111111, emi: 0xff4400 };
                
                // Construct procedural model JSON
                const model = {
                    name: `Custom ${type}`,
                    parts: [
                        { // Torso
                            geometry: { type: 'box', width: 0.6, height: 0.8, depth: 0.4 },
                            material: { color: colors.pri },
                            position: { x: 0, y: 0, z: 0 }
                        },
                        { // Head
                            geometry: { type: 'box', width: 0.4, height: 0.4, depth: 0.4 },
                            material: { color: colors.sec },
                            position: { x: 0, y: 0.7, z: 0 },
                            children: [{
                                geometry: { type: 'box', width: 0.35, height: 0.1, depth: 0.1 },
                                material: { color: colors.emi, emissive: colors.emi },
                                position: { x: 0, y: 0, z: 0.2 }
                            }]
                        },
                        { // Arms
                            geometry: { type: 'box', width: 0.2, height: 0.7, depth: 0.2 },
                            material: { color: colors.sec },
                            position: { x: -0.5, y: 0, z: 0 }
                        },
                        {
                            geometry: { type: 'box', width: 0.2, height: 0.7, depth: 0.2 },
                            material: { color: colors.sec },
                            position: { x: 0.5, y: 0, z: 0 }
                        }
                    ]
                };
                
                this.currentModelData = model;
                this.renderPreview(model);
            },
            
            renderPreview(data) {
                if(this.previewMesh) this.previewScene.remove(this.previewMesh);
                this.previewMesh = ModelLoader.buildMesh(data);
                if(this.previewMesh) this.previewScene.add(this.previewMesh);
            },
            
            exportToJson() {
                const str = JSON.stringify(this.currentModelData, null, 2);
                const blob = new Blob([str], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'character.json';
                a.click();
            },
            
            importFromJson(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.currentModelData = JSON.parse(e.target.result);
                        this.renderPreview(this.currentModelData);
                    } catch(err) { console.error(err); }
                };
                reader.readAsText(file);
                input.value = '';
            },
            
            applyToPlayer() {
                if(!this.currentModelData) return;
                
                // Initialize player if needed (Mock for this single file context)
                if(!worldState.player) {
                    worldState.player = new THREE.Group();
                    scene.add(worldState.player);
                    mode = 'world'; // Switch mode to see player
                    // Move camera to see player
                    camera.position.set(0, 5, 10);
                    camera.lookAt(0,0,0);
                }
                
                // Remove old mesh children
                while(worldState.player.children.length > 0) {
                    worldState.player.remove(worldState.player.children[0]);
                }
                
                // Build and add new mesh
                const newMesh = ModelLoader.buildMesh(this.currentModelData);
                worldState.player.add(newMesh);
                
                // Important: Tag as custom to prevent animation system overrides if merging with full engine
                worldState.player.userData.isCustomCharacter = true;
                
                this.close();
                showNotification('Character Applied!', 'success');
            }
        };

        // --- GLOBAL FUNCTIONS & EVENT HANDLERS ---
        function showNotification(msg, type) {
            const div = document.createElement('div');
            div.className = 'notification';
            div.textContent = msg;
            if(type === 'success') div.style.borderColor = '#00ff88';
            if(type === 'error') div.style.borderColor = '#ff4444';
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Mock Functions for Buttons
        function showStatsPanel() { document.getElementById('stats-modal').style.display = 'flex'; }
        function openCodexModal() { document.getElementById('codex-modal').style.display = 'flex'; }
        function openQuestModal() { document.getElementById('quest-modal').style.display = 'flex'; }
        function openMasteryModal() { document.getElementById('mastery-modal').style.display = 'flex'; }
        function openPortalModal() { document.getElementById('portal-modal').style.display = 'flex'; }
        function openEvolutionModal() { document.getElementById('evolution-modal').style.display = 'flex'; }
        function showSettingsModal() { document.getElementById('settings-modal').style.display = 'flex'; }
        function openRappidModal() { document.getElementById('ai-settings-modal').classList.add('active'); }
        function quickSave() { showNotification('Game Saved!', 'success'); }
        function exportData() { showNotification('Game Exported to JSON', 'success'); }
        
        // Initial Load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                
                // Create a basic galaxy representation
                const geometry = new THREE.BufferGeometry();
                const vertices = [];
                for ( let i = 0; i < 2000; i ++ ) {
                    vertices.push( THREE.MathUtils.randFloatSpread( 200 ) ); // x
                    vertices.push( THREE.MathUtils.randFloatSpread( 200 ) ); // y
                    vertices.push( THREE.MathUtils.randFloatSpread( 200 ) ); // z
                }
                geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( vertices, 3 ) );
                const particles = new THREE.Points( geometry, new THREE.PointsMaterial( { color: 0x888888 } ) );
                scene.add( particles );
                
                loop();
            }, 1000);
        });

        // Main Loop
        function loop() {
            requestAnimationFrame(loop);
            
            if(mode === 'galaxy') {
                scene.rotation.y += 0.001;
            } else if(mode === 'world' && worldState.player) {
                // Simple player rotation in world mode
                worldState.player.rotation.y += 0.01;
            }
            
            renderer.render(scene, camera);
        }

        // Handle Window Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>