<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMDR Therapy Session</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            overscroll-behavior: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .ball {
            height: 32px;
            width: 32px;
            background: #3B82F6;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px 2px rgba(59, 130, 246, 0.5),
                        0 0 20px 4px rgba(59, 130, 246, 0.3);
            transition: box-shadow 0.3s ease;
            will-change: transform;
        }

        .ball.active {
            box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.6),
                        0 0 30px 8px rgba(59, 130, 246, 0.4);
        }

        .track {
            position: relative;
            height: 80px;
            background: linear-gradient(to right, rgba(219, 234, 254, 0.3), rgba(219, 234, 254, 0.1));
            border-radius: 8px;
            overflow: hidden;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .ball {
                height: 24px;
                width: 24px;
            }

            .track {
                height: 60px;
            }

            .left-panel {
                display: none;
            }

            .right-panel {
                width: 100%;
            }

            .mobile-stack {
                flex-direction: column;
            }
        }

        /* Desktop-specific styles */
        @media (min-width: 769px) {
            .mobile-only {
                display: none;
            }
        }

        /* UI Elements */
        .info-tooltip {
            visibility: hidden;
            position: absolute;
            background-color: #1F2937;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            max-width: 300px;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .info-icon:hover + .info-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Custom scrollbar */
        #historyContent::-webkit-scrollbar {
            width: 6px;
        }

        #historyContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #historyContent::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #historyContent::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Range input styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #e2e8f0;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            transition: background .15s ease-in-out;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border: 0;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            transition: background .15s ease-in-out;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Focus styles for accessibility */
        :focus-visible {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }

        /* Prevent text selection during ball tracking */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Container -->
    <div class="h-screen flex flex-col">
        <!-- Top Bar -->
        <div class="bg-white border-b px-4 py-2 flex justify-between items-center flex-shrink-0">
            <div class="text-sm text-gray-600" id="sessionInfo"></div>
            <div class="flex gap-2">
                <input type="file" id="sessionUpload" accept=".json" class="hidden">
                <label for="sessionUpload" class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm hover:bg-blue-100 cursor-pointer">
                    Import
                </label>
                <button onclick="exportSession()" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600">
                    Save
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex min-h-0">
            <!-- Left Panel -->
            <div class="w-96 border-r bg-gray-50 flex flex-col overflow-hidden left-panel">
                <!-- Progress Steps -->
                <div class="p-3 border-b bg-white flex-shrink-0">
                    <div class="flex justify-between">
                        <div id="step1" class="text-center flex-1">
                            <div class="w-6 h-6 rounded-full bg-blue-500 text-white text-sm flex items-center justify-center mx-auto mb-1">1</div>
                            <div class="text-xs">Memory</div>
                        </div>
                        <div class="flex-1 border-t-2 border-gray-200 relative top-3"></div>
                        <div id="step2" class="text-center flex-1">
                            <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-sm flex items-center justify-center mx-auto mb-1">2</div>
                            <div class="text-xs">Rating</div>
                        </div>
                        <div class="flex-1 border-t-2 border-gray-200 relative top-3"></div>
                        <div id="step3" class="text-center flex-1">
                            <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-sm flex items-center justify-center mx-auto mb-1">3</div>
                            <div class="text-xs">Process</div>
                        </div>
                        <div class="flex-1 border-t-2 border-gray-200 relative top-3"></div>
                        <div id="step4" class="text-center flex-1">
                            <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-sm flex items-center justify-center mx-auto mb-1">4</div>
                            <div class="text-xs">Complete</div>
                        </div>
                    </div>
                </div>

                <!-- Current Focus -->
                <div class="p-3 border-b flex-shrink-0">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-sm font-medium">Current Focus</h3>
                        <span id="currentPhase" class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Memory Selection</span>
                    </div>
                    <div id="focusContent" class="text-sm text-gray-600"></div>
                </div>

                <!-- SUDS Progress -->
                <div class="p-3 border-b flex-shrink-0">
                    <div class="flex justify-between text-sm mb-2">
                        <span>Initial SUDS: <span id="initialSudsDisplay" class="font-mono">-</span></span>
                        <span>Current: <span id="currentSudsDisplay" class="font-mono">-</span></span>
                    </div>
                    <div id="chartContainer" class="hidden h-32">
                        <canvas id="sudsChart"></canvas>
                    </div>
                </div>

                <!-- History -->
                <div class="flex-1 overflow-y-auto">
                    <div id="processHistory" class="hidden p-3">
                        <h3 class="text-sm font-medium mb-2">Process History</h3>
                        <div class="space-y-3" id="historyContent"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="flex-1 flex flex-col p-4 overflow-y-auto right-panel">
                <!-- Memory Input -->
                <div id="memoryInput" class="space-y-3">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-lg font-semibold">Target Memory</h2>
                            <p class="text-sm text-gray-600">Choose a specific memory to process</p>
                        </div>
                        <button class="text-blue-600 hover:text-blue-700 text-sm" onclick="showHelp('memory')">
                            Need help?
                        </button>
                    </div>
                    
                    <textarea 
                        id="memoryText" 
                        placeholder="Describe a specific memory that still bothers you..."
                        class="w-full p-2 border rounded-lg h-24 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    ></textarea>
                    
                    <button onclick="submitMemory()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600">
                        Continue
                    </button>
                </div>

                <!-- Rating Input -->
                <div id="ratingInput" class="hidden space-y-3">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-lg font-semibold">Rate Your Discomfort</h2>
                            <p class="text-sm text-gray-600">How disturbing does this memory feel?</p>
                        </div>
                        <div class="relative">
                            <span class="info-icon cursor-help text-sm">❔</span>
                            <div class="info-tooltip -right-2">
                                0 = No disturbance<br>
                                5 = Moderate disturbance<br>
                                10 = Highest disturbance
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 items-center">
                        <input 
                            type="range" 
                            id="sudsSlider" 
                            min="0" 
                            max="10" 
                            step="1"
                            class="w-full"
                            oninput="updateSudsValue(this.value)"
                        >
                        <input 
                            type="number" 
                            id="sudsRating" 
                            min="0" 
                            max="10" 
                            class="w-16 p-1 border rounded text-sm"
                            oninput="updateSudsSlider(this.value)"
                        >
                    </div>
                    
                    <button onclick="submitRating()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600">
                        Start Processing
                    </button>
                </div>

                <!-- Processing Area -->
                <div id="processing" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-lg font-semibold">Set <span id="currentSet">1</span>/<span id="totalSets">10</span></h2>
                            <p class="text-sm text-gray-600">Follow the ball with your eyes</p>
                        </div>
                        <div id="timer" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded"></div>
                    </div>
                    
                    <div class="track">
                        <div id="ball" class="ball"></div>
                    </div>

                    <div class="flex justify-between items-center">
                        <button id="toggleButton" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600">
                            Start Set
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-600">Slower</span>
                            <input type="range" id="speedControl" min="1" max="4" step="0.5" value="2" class="w-24">
                            <span class="text-xs text-gray-600">Faster</span>
                        </div>
                    </div>

                    <!-- Set Completion Form -->
                    <div id="setComplete" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-medium">Check In</h3>
                        <p class="text-xs text-gray-600">Take a moment to notice what you're experiencing</p>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm mb-1">Current disturbance level (0-10):</label>
                                <div class="flex gap-4 items-center">
                                    <input 
                                        type="range" 
                                        id="currentSudsSlider" 
                                        min="0" 
                                        max="10" 
                                        class="w-full"
                                        oninput="updateCurrentSudsValue(this.value)"
                                    >
                                    <input 
                                        type="number" 
                                        id="currentSuds" 
                                        min="0" 
                                        max="10" 
                                        class="w-16 p-1 border rounded text-sm"
                                        oninput="updateCurrentSudsSlider(this.value)"
                                    >
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm mb-1">What are you noticing? (Optional)</label>
                                <textarea 
                                    id="observations" 
                                    placeholder="Any changes in thoughts, feelings, sensations..."
                                    class="w-full p-2 border rounded-lg h-20 text-sm"
                                ></textarea>
                            </div>
                            
                            <button onclick="completeSet()" class="w-full bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600">
                                Continue to Next Set
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg w-[32rem] mx-4 p-4 space-y-3">
            <h3 class="text-lg font-bold" id="helpTitle"></h3>
            <div id="helpContent" class="text-gray-600 max-h-[60vh] overflow-y-auto"></div>
            <button onclick="closeHelp()" class="w-full bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600">
                Got it
            </button>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-[40rem] mx-4 p-4 space-y-3 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800">Welcome to EMDR Therapy Assistant</h2>
            
            <div class="space-y-3 text-gray-600">
                <div>
                    <p class="font-medium text-gray-700">What is EMDR?</p>
                    <p class="text-sm">EMDR (Eye Movement Desensitization and Reprocessing) is a proven therapy technique that helps process difficult memories and reduce their emotional impact. It works by combining memory recall with bilateral stimulation (in this case, following a moving ball with your eyes).</p>
                </div>
                
                <div>
                    <p class="font-medium text-gray-700">How does this tool work?</p>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>You'll identify a specific memory you want to work on</li>
                        <li>Rate how disturbing it feels (0-10)</li>
                        <li>Follow the ball with your eyes while holding the memory in mind</li>
                        <li>After each set, you'll note any changes in how you feel</li>
                    </ol>
                </div>

                <div class="bg-blue-50 p-3 rounded-lg">
                    <label class="block font-medium text-gray-700 mb-1 text-sm">How much time do you have for this session?</label>
                    <select id="sessionDuration" class="w-full p-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="15">15 minutes (5 sets)</option>
                        <option value="30" selected>30 minutes (10 sets)</option>
                        <option value="45">45 minutes (15 sets)</option>
                        <option value="60">60 minutes (20 sets)</option>
                    </select>
                    <p class="text-xs text-gray-600 mt-1">Each set takes about 2-3 minutes including check-ins</p>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                    <p class="font-medium text-sm">Important Note:</p>
                    <p class="text-sm">While this tool can be helpful, it's recommended to use it alongside professional therapy. If you're dealing with severe trauma, please consult a mental health professional.</p>
                </div>
            </div>

            <button onclick="startSession()" class="w-full bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                Begin Session
            </button>
        </div>
    </div>

    <script>
        // Session state management
        let sessionState = {
            id: 'session_' + Date.now(),
            startTime: new Date().toISOString(),
            memory: '',
            initialSuds: null,
            currentSet: 0,
            sets: [],
            status: 'active',
            totalSets: 10,
            duration: 30
        };

        // UI state
        let isRunning = false;
        let position = 0;
        let direction = 1;
        let speed = 2;
        let animationFrame;
        let lastTime = 0;
        let setTimer;
        let remainingTime = 30;
        let sudsChart = null;

        // Initialize
        updateSessionInfo();

        function startSession() {
            const durationSelect = document.getElementById('sessionDuration');
            const duration = parseInt(durationSelect.value);
            sessionState.duration = duration;
            sessionState.totalSets = Math.floor(duration / 3); // Approximately 3 minutes per set
            document.getElementById('welcomeModal').style.display = 'none';
            document.getElementById('totalSets').textContent = sessionState.totalSets;
            updateSessionInfo();
            
            // Initialize focus content
            updateFocusPanel('Memory Selection', `
                <p>Please describe a specific memory you'd like to work on.</p>
                <p class="text-sm text-gray-500 mt-2">Choose something that:</p>
                <ul class="list-disc list-inside text-sm text-gray-500 mt-1">
                    <li>Is a single, specific event</li>
                    <li>Still causes some emotional discomfort</li>
                    <li>You feel ready to work with</li>
                </ul>
            `);
        }

        function updateProgress(step) {
            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.querySelector('div').classList.remove('bg-blue-500', 'bg-green-500');
                stepEl.querySelector('div').classList.add('bg-gray-200');
                stepEl.querySelector('div').classList.remove('text-white');
                stepEl.querySelector('div').classList.add('text-gray-600');
            }
            
            // Update completed steps
            for (let i = 1; i <= step; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.querySelector('div').classList.remove('bg-gray-200');
                stepEl.querySelector('div').classList.add(i === step ? 'bg-blue-500' : 'bg-green-500');
                stepEl.querySelector('div').classList.remove('text-gray-600');
                stepEl.querySelector('div').classList.add('text-white');
            }
        }

        function updateFocusPanel(phase, content) {
            document.getElementById('currentPhase').textContent = phase;
            document.getElementById('focusContent').innerHTML = content;
        }

        function addToHistory(type, content) {
            const historyDiv = document.getElementById('processHistory');
            const historyContent = document.getElementById('historyContent');
            
            historyDiv.classList.remove('hidden');
            
            const timestamp = new Date().toLocaleTimeString();
            const entryDiv = document.createElement('div');
            entryDiv.className = 'border-l-2 border-blue-200 pl-4 fade-in';
            entryDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="text-sm font-medium">${type}</span>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <div class="text-gray-600 mt-1">${content}</div>
            `;
            
            historyContent.insertBefore(entryDiv, historyContent.firstChild);
        }

        function initSudsChart() {
            const ctx = document.getElementById('sudsChart').getContext('2d');
            document.getElementById('chartContainer').classList.remove('hidden');
            
            sudsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Initial'],
                    datasets: [{
                        label: 'Distress Level (SUDS)',
                        data: [sessionState.initialSuds],
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'SUDS Rating'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateSudsChart(suds) {
            if (sudsChart) {
                sudsChart.data.labels.push(`Set ${sessionState.sets.length}`);
                sudsChart.data.datasets[0].data.push(suds);
                sudsChart.update();
            }
        }

        function updateSudsValue(value) {
            document.getElementById('sudsRating').value = value;
        }

        function updateSudsSlider(value) {
            document.getElementById('sudsSlider').value = value;
        }

        function updateCurrentSudsValue(value) {
            document.getElementById('currentSuds').value = value;
        }

        function updateCurrentSudsSlider(value) {
            document.getElementById('currentSudsSlider').value = value;
        }

        // File handlers
        document.getElementById('sessionUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        sessionState = importedState;
                        restoreSession();
                        updateSessionInfo();
                    } catch (error) {
                        alert('Error importing session: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        function exportSession() {
            const dataStr = JSON.stringify(sessionState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `emdr_session_${sessionState.id}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function submitMemory() {
            const memoryText = document.getElementById('memoryText').value.trim();
            if (memoryText) {
                sessionState.memory = memoryText;
                document.getElementById('memoryInput').classList.add('hidden');
                document.getElementById('ratingInput').classList.remove('hidden');
                updateSessionInfo();
                
                // Update progress tracking
                updateProgress(2);
                updateFocusPanel('Initial Rating', `
                    <p class="mb-2"><strong>Target Memory:</strong> "${memoryText}"</p>
                    <p>Please rate how disturbing this memory feels right now.</p>
                `);
                addToHistory('Memory Selected', memoryText);
            } else {
                alert('Please describe the memory you want to work on.');
            }
        }

        function submitRating() {
            const rating = parseInt(document.getElementById('sudsRating').value);
            if (rating >= 0 && rating <= 10) {
                sessionState.initialSuds = rating;
                document.getElementById('initialSudsDisplay').textContent = rating;
                document.getElementById('currentSudsDisplay').textContent = rating;
                document.getElementById('ratingInput').classList.add('hidden');
                document.getElementById('processing').classList.remove('hidden');
                updateSessionInfo();
                
                // Initialize SUDS chart
                initSudsChart();
                
                // Update progress tracking
                updateProgress(3);
                updateFocusPanel('Processing', `
                    <div class="space-y-2">
                        <p><strong>Target Memory:</strong> "${sessionState.memory}"</p>
                        <p><strong>Initial Disturbance:</strong> ${rating}/10</p>
                        <p>Follow the ball with your eyes while holding this memory in mind.</p>
                    </div>
                `);
                addToHistory('Initial Rating', `Starting SUDS: ${rating}/10`);
                
                // Show initial guidance
                showProcessingGuidance();
            } else {
                alert('Please enter a rating between 0 and 10.');
            }
        }

        function showProcessingGuidance() {
            const modal = document.getElementById('helpModal');
            const title = document.getElementById('helpTitle');
            const content = document.getElementById('helpContent');
            
            title.textContent = 'Ready to Begin Processing';
            content.innerHTML = `
                <p class="mb-4">During each processing set:</p>
                <ul class="list-disc list-inside space-y-2 mb-4">
                    <li>Follow the blue ball with your eyes</li>
                    <li>Allow your mind to go wherever it needs to</li>
                    <li>Notice any changes in thoughts, feelings, or body sensations</li>
                    <li>There's no "right" or "wrong" way to experience this</li>
                </ul>
                <div class="bg-blue-50 p-4 rounded">
                    <p class="font-medium">Tips:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li>Adjust the speed to what feels comfortable</li>
                        <li>You can pause anytime if needed</li>
                        <li>Take breaks between sets if you need to</li>
                    </ul>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function startSet() {
            isRunning = true;
            lastTime = 0;
            remainingTime = 30;
            document.getElementById('toggleButton').textContent = 'Pause';
            document.getElementById('toggleButton').classList.remove('bg-blue-500', 'hover:bg-blue-600');
            document.getElementById('toggleButton').classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            document.getElementById('timer').textContent = `${remainingTime}s`;
            document.getElementById('ball').classList.add('active');
            
            setTimer = setInterval(() => {
                remainingTime--;
                document.getElementById('timer').textContent = `${remainingTime}s`;
                if (remainingTime <= 0) {
                    stopSet();
                    showSetCompletion();
                }
            }, 1000);
            
            animationFrame = requestAnimationFrame(animate);
        }

        function stopSet() {
            isRunning = false;
            document.getElementById('toggleButton').textContent = 'Start Set';
            document.getElementById('toggleButton').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            document.getElementById('toggleButton').classList.add('bg-blue-500', 'hover:bg-blue-600');
            document.getElementById('ball').classList.remove('active');
            clearInterval(setTimer);
            cancelAnimationFrame(animationFrame);
        }

        function animate(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            position += direction * speed * (deltaTime / 16);
            
            if (position >= 100) {
                direction = -1;
                position = 100;
            } else if (position <= 0) {
                direction = 1;
                position = 0;
            }
            
            document.getElementById('ball').style.left = `${position}%`;
            
            if (isRunning) {
                animationFrame = requestAnimationFrame(animate);
            }
        }

        function showSetCompletion() {
            document.getElementById('setComplete').classList.remove('hidden');
            // Initialize the current SUDS slider with the last SUDS value
            const lastSuds = sessionState.sets.length > 0 
                ? sessionState.sets[sessionState.sets.length - 1].suds 
                : sessionState.initialSuds;
            document.getElementById('currentSudsSlider').value = lastSuds;
            document.getElementById('currentSuds').value = lastSuds;
        }

        function completeSet() {
            const suds = parseInt(document.getElementById('currentSuds').value);
            const observations = document.getElementById('observations').value.trim();
            
            if (suds >= 0 && suds <= 10) {
                sessionState.sets.push({
                    setNumber: sessionState.currentSet + 1,
                    suds: suds,
                    observations: observations,
                    timestamp: new Date().toISOString()
                });
                
                // Update SUDS chart
                updateSudsChart(suds);
                
                document.getElementById('currentSudsDisplay').textContent = suds;
                sessionState.currentSet++;
                document.getElementById('currentSet').textContent = sessionState.currentSet + 1;
                document.getElementById('setComplete').classList.add('hidden');
                document.getElementById('currentSuds').value = '';
                document.getElementById('observations').value = '';
                
                // Add to history
                addToHistory('Set Complete', `
                    <div class="space-y-1">
                        <div>SUDS: ${suds}/10</div>
                        ${observations ? `<div>Observations: ${observations}</div>` : ''}
                    </div>
                `);
                
                // Update focus panel
                updateFocusPanel('Processing', `
                    <div class="space-y-2">
                        <p><strong>Target Memory:</strong> "${sessionState.memory}"</p>
                        <p><strong>Progress:</strong> ${sessionState.currentSet}/${sessionState.totalSets} sets completed</p>
                        <p><strong>Current Disturbance:</strong> ${suds}/10 (started at ${sessionState.initialSuds}/10)</p>
                        ${observations ? `<p><strong>Latest Observations:</strong> ${observations}</p>` : ''}
                    </div>
                `);
                
                updateSessionInfo();

                if (sessionState.currentSet >= sessionState.totalSets || suds <= 1) {
                    endSession();
                } else if (suds <= 3 && sessionState.currentSet >= Math.floor(sessionState.totalSets / 2)) {
                    suggestEndingSession(suds);
                }
            }
        }

        function suggestEndingSession(suds) {
            const modal = document.getElementById('helpModal');
            const title = document.getElementById('helpTitle');
            const content = document.getElementById('helpContent');
            
            title.textContent = 'Progress Check';
            content.innerHTML = `
                <p class="mb-4">Your distress level is now quite low (${suds}/10), and you've completed more than half the sets. Would you like to:</p>
                <div class="space-y-2">
                    <button onclick="endSession()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        End Session & Save Progress
                    </button>
                    <button onclick="closeHelp()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Continue Processing
                    </button>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function endSession() {
            sessionState.status = 'completed';
            sessionState.endTime = new Date().toISOString();
            updateProgress(4);
            updateSessionInfo();
            
            const finalSuds = sessionState.sets[sessionState.sets.length-1].suds;
            const sudsDifference = sessionState.initialSuds - finalSuds;
            const percentImprovement = ((sudsDifference) / sessionState.initialSuds * 100).toFixed(1);
            
            const modal = document.getElementById('helpModal');
            const title = document.getElementById('helpTitle');
            const content = document.getElementById('helpContent');
            
            title.textContent = 'Session Complete';
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded">
                        <h4 class="font-medium mb-2">Session Summary:</h4>
                        <ul class="list-none space-y-2">
                            <li><strong>Starting distress level:</strong> ${sessionState.initialSuds}/10</li>
                            <li><strong>Final distress level:</strong> ${finalSuds}/10</li>
                            <li><strong>Improvement:</strong> ${percentImprovement}%</li>
                            <li><strong>Sets completed:</strong> ${sessionState.sets.length}</li>
                            <li><strong>Duration:</strong> ${sessionState.duration} minutes</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded">
                        <h4 class="font-medium mb-2">Next Steps:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li>Take time to rest and process</li>
                            <li>Be gentle with yourself</li>
                            <li>Notice any changes over the next few days</li>
                            <li>Consider scheduling a follow-up session if needed</li>
                        </ul>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="exportSession()" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Save Session Data
                        </button>
                        <button onclick="closeHelp(); resetSession();" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Start New Session
                        </button>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function resetSession() {
            sessionState = {
                id: 'session_' + Date.now(),
                startTime: new Date().toISOString(),
                memory: '',
                initialSuds: null,
                currentSet: 0,
                sets: [],
                status: 'active',
                totalSets: sessionState.totalSets,
                duration: sessionState.duration
            };
            
            // Reset UI
            document.getElementById('memoryText').value = '';
            document.getElementById('sudsRating').value = '';
            document.getElementById('sudsSlider').value = 5;
            document.getElementById('initialSudsDisplay').textContent = '-';
            document.getElementById('currentSudsDisplay').textContent = '-';
            document.getElementById('processHistory').classList.add('hidden');
            document.getElementById('historyContent').innerHTML = '';
            document.getElementById('chartContainer').classList.add('hidden');
            
            // Show memory input
            document.getElementById('memoryInput').classList.remove('hidden');
            document.getElementById('ratingInput').classList.add('hidden');
            document.getElementById('processing').classList.add('hidden');
            
            // Reset progress
            updateProgress(1);
            updateFocusPanel('Memory Selection', `
                <p>Please describe a specific memory you'd like to work on.</p>
                <p class="text-sm text-gray-500 mt-2">Choose something that:</p>
                <ul class="list-disc list-inside text-sm text-gray-500 mt-1">
                    <li>Is a single, specific event</li>
                    <li>Still causes some emotional discomfort</li>
                    <li>You feel ready to work with</li>
                </ul>
            `);
            
            updateSessionInfo();
        }

        function updateSessionInfo() {
            const info = document.getElementById('sessionInfo');
            const sets = sessionState.sets.length;
            const initialSuds = sessionState.initialSuds;
            const currentSuds = sets > 0 ? sessionState.sets[sets-1].suds : null;
            
            let infoText = `Session ${sessionState.id.split('_')[1]} | `;
            infoText += `Sets: ${sets}/${sessionState.totalSets} | `;
            if (initialSuds !== null) {
                infoText += `Initial SUDS: ${initialSuds}`;
                if (currentSuds !== null) {
                    infoText += ` → Current: ${currentSuds}`;
                }
            }
            infoText += ` | Status: ${sessionState.status}`;
            info.textContent = infoText;
        }

        function showHelp(topic) {
            const modal = document.getElementById('helpModal');
            const title = document.getElementById('helpTitle');
            const content = document.getElementById('helpContent');

            if (topic === 'memory') {
                title.textContent = 'Choosing a Memory to Process';
                content.innerHTML = `
                    <div class="space-y-4">
                        <p>Choose a specific memory that:</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Still causes you some distress when you think about it</li>
                            <li>Happened at a specific time (not an ongoing situation)</li>
                            <li>You feel ready to work on</li>
                        </ul>
                        
                        <div class="bg-gray-50 p-4 rounded">
                            <p class="font-medium mb-2">Good examples:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-600">
                                <li>"That time I failed my driving test"</li>
                                <li>"When I gave my first presentation at work"</li>
                                <li>"The argument with my friend last summer"</li>
                            </ul>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded">
                            <p class="font-medium">Start Small:</p>
                            <p>If you're new to EMDR, start with a mildly disturbing memory (rated 3-5 out of 10) rather than your most difficult memories.</p>
                        </div>
                    </div>
                `;
            }

            modal.style.display = 'flex';
        }

        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        function restoreSession() {
            // Restore memory
            if (sessionState.memory) {
                document.getElementById('memoryText').value = sessionState.memory;
            }
            
            // Restore rating
            if (sessionState.initialSuds !== null) {
                document.getElementById('sudsRating').value = sessionState.initialSuds;
                document.getElementById('sudsSlider').value = sessionState.initialSuds;
                document.getElementById('initialSudsDisplay').textContent = sessionState.initialSuds;
                
                if (sessionState.sets.length > 0) {
                    const currentSuds = sessionState.sets[sessionState.sets.length - 1].suds;
                    document.getElementById('currentSudsDisplay').textContent = currentSuds;
                }
            }
            
            // Restore SUDS chart
            if (sessionState.initialSuds !== null) {
                initSudsChart();
                sessionState.sets.forEach(set => {
                    updateSudsChart(set.suds);
                });
            }
            
            // Show appropriate stage
            if (!sessionState.memory) {
                document.getElementById('memoryInput').classList.remove('hidden');
                document.getElementById('ratingInput').classList.add('hidden');
                document.getElementById('processing').classList.add('hidden');
            } else if (sessionState.initialSuds === null) {
                document.getElementById('memoryInput').classList.add('hidden');
                document.getElementById('ratingInput').classList.remove('hidden');
                document.getElementById('processing').classList.add('hidden');
            } else {
                document.getElementById('memoryInput').classList.add('hidden');
                document.getElementById('ratingInput').classList.add('hidden');
                document.getElementById('processing').classList.remove('hidden');
                document.getElementById('currentSet').textContent = sessionState.currentSet + 1;
                document.getElementById('totalSets').textContent = sessionState.totalSets;
            }
            
            // Update progress tracking
            if (sessionState.status === 'completed') {
                updateProgress(4);
            } else if (sessionState.sets.length > 0) {
                updateProgress(3);
            } else if (sessionState.initialSuds !== null) {
                updateProgress(2);
            } else if (sessionState.memory) {
                updateProgress(1);
            }
            
            // Restore process history
            if (sessionState.sets.length > 0) {
                document.getElementById('processHistory').classList.remove('hidden');
                sessionState.sets.forEach(set => {
                    addToHistory('Set Complete', `
                        <div class="space-y-1">
                            <div>SUDS: ${set.suds}/10</div>
                            ${set.observations ? `<div>Observations: ${set.observations}</div>` : ''}
                        </div>
                    `);
                });
            }
        }

        // Event Listeners
        document.getElementById('toggleButton').addEventListener('click', () => {
            if (isRunning) {
                stopSet();
            } else {
                startSet();
            }
        });

        document.getElementById('speedControl').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
        });
    </script>
</body>
</html>