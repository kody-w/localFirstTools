<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Distributed OS - Collective Computing Network</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 24px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .peer-count {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Grid */
        .main-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            overflow: hidden;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .card-content {
            flex: 1;
            overflow-y: auto;
        }

        /* Network Visualization */
        .network-canvas {
            width: 100%;
            height: 100%;
            background: #1f2937;
            border-radius: 8px;
        }

        /* Peer List */
        .peer-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .peer-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }

        .peer-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .peer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .peer-details {
            font-size: 13px;
        }

        .peer-name {
            font-weight: 600;
            color: #1f2937;
        }

        .peer-stats {
            color: #6b7280;
            font-size: 11px;
        }

        .peer-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-leader {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        /* File System */
        .file-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        .file-icon {
            font-size: 18px;
            margin-right: 8px;
        }

        .file-chunks {
            font-size: 11px;
            color: #6b7280;
        }

        /* Processes */
        .process-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .process-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .process-name {
            font-weight: 600;
            color: #1f2937;
        }

        .process-location {
            font-size: 11px;
            color: #6b7280;
        }

        .process-progress {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .process-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s;
        }

        /* Chat */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            max-width: 80%;
            font-size: 13px;
        }

        .message-local {
            background: #dbeafe;
            margin-left: auto;
            text-align: right;
        }

        .message-remote {
            background: #f3f4f6;
        }

        .message-sender {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .chat-input {
            display: flex;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .chat-input button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-input button:hover {
            transform: scale(1.05);
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #1f2937;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        /* Stats */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Logs */
        .log-container {
            background: #1f2937;
            color: #d1d5db;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 200px;
        }

        .log-entry {
            margin-bottom: 4px;
        }

        .log-timestamp {
            color: #9ca3af;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-success {
            color: #34d399;
        }

        .log-error {
            color: #f87171;
        }

        /* Connection Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .modal-subtitle {
            color: #6b7280;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .input-group input:focus {
            border-color: #667eea;
        }

        .peer-id-display {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            text-align: center;
            margin-bottom: 16px;
            border: 2px dashed #d1d5db;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        /* Shared Desktop */
        .shared-desktop {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .desktop-canvas {
            width: 100%;
            height: 100%;
        }

        .desktop-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            transition: all 0.1s;
        }

        /* Full width cards */
        .card-full {
            grid-column: 1 / -1;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>üåê</span>
                <span>P2P Distributed OS</span>
            </h1>
            <div style="display: flex; gap: 16px; align-items: center;">
                <div class="peer-count">
                    <span class="pulse-dot"></span>
                    <span id="peer-count">0 Peers Connected</span>
                </div>
                <button class="btn btn-primary" onclick="P2POS.showConnectionModal()">
                    ‚ûï Connect to Network
                </button>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Network Visualization -->
            <div class="card">
                <div class="card-header">üï∏Ô∏è Network Mesh</div>
                <div class="card-content">
                    <canvas class="network-canvas" id="network-canvas"></canvas>
                </div>
            </div>

            <!-- Connected Peers -->
            <div class="card">
                <div class="card-header">üë• Connected Peers</div>
                <div class="card-content" id="peer-list">
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîå</div>
                        <p>No peers connected yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Click "Connect to Network" to join</p>
                    </div>
                </div>
            </div>

            <!-- System Stats -->
            <div class="card">
                <div class="card-header">üìä Collective Resources</div>
                <div class="card-content">
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-cpu">0</div>
                            <div class="stat-label">Total CPUs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-memory">0 GB</div>
                            <div class="stat-label">Total Memory</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-storage">0 GB</div>
                            <div class="stat-label">Total Storage</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="network-speed">0 Mbps</div>
                            <div class="stat-label">Network Speed</div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="P2POS.uploadFile()">üì§ Upload File</button>
                        <button class="btn btn-secondary" onclick="P2POS.createProcess()">‚öôÔ∏è New Process</button>
                        <button class="btn btn-secondary" onclick="P2POS.shareScreen()">üñ•Ô∏è Share Screen</button>
                    </div>
                </div>
            </div>

            <!-- Distributed File System -->
            <div class="card">
                <div class="card-header">üíæ Distributed Files</div>
                <div class="card-content" id="file-list">
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">
                        <p>No files in distributed storage</p>
                    </div>
                </div>
            </div>

            <!-- Running Processes -->
            <div class="card">
                <div class="card-header">‚öôÔ∏è Distributed Processes</div>
                <div class="card-content" id="process-list">
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">
                        <p>No processes running</p>
                    </div>
                </div>
            </div>

            <!-- Chat & Communication -->
            <div class="card">
                <div class="card-header">üí¨ Network Chat</div>
                <div class="card-content" style="display: flex; flex-direction: column;">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="chat-input" placeholder="Message the network..." onkeypress="if(event.key==='Enter') P2POS.sendMessage()">
                        <button onclick="P2POS.sendMessage()">Send</button>
                    </div>
                </div>
            </div>

            <!-- System Logs -->
            <div class="card card-full">
                <div class="card-header">üìú System Logs</div>
                <div class="card-content">
                    <div class="log-container" id="system-logs"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div class="modal" id="connection-modal">
        <div class="modal-content">
            <div class="modal-title">Connect to P2P Network</div>
            <div class="modal-subtitle">Join the distributed operating system by connecting to peers</div>

            <div class="input-group">
                <label>Your Peer ID</label>
                <div class="peer-id-display" id="my-peer-id">Generating...</div>
            </div>

            <div class="input-group">
                <label>Connect to Peer (enter their ID)</label>
                <input type="text" id="remote-peer-id" placeholder="Enter peer ID to connect...">
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="P2POS.closeConnectionModal()" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="P2POS.connectToPeer()" style="flex: 1;">Connect</button>
            </div>

            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                <p style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">Or share your ID for others to connect:</p>
                <button class="btn btn-secondary" onclick="P2POS.copyPeerID()" style="width: 100%;">üìã Copy My Peer ID</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        const P2POS = {
            peer: null,
            myPeerID: null,
            connections: new Map(),
            peers: new Map(),
            files: new Map(),
            processes: new Map(),
            isLeader: false,
            networkCanvas: null,
            networkCtx: null,

            // Initialize the P2P OS
            init() {
                this.setupPeer();
                this.setupCanvas();
                this.startNetworkVisualization();
                this.log('System initialized', 'success');
            },

            // Setup PeerJS connection
            setupPeer() {
                // Generate random peer ID
                const id = 'p2pos-' + Math.random().toString(36).substring(2, 10);

                // Initialize PeerJS
                this.peer = new Peer(id, {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                });

                this.peer.on('open', (id) => {
                    this.myPeerID = id;
                    this.log(`Peer ID generated: ${id}`, 'info');

                    // Add self to peers list
                    this.peers.set(id, {
                        id,
                        name: 'You (Local)',
                        cpu: navigator.hardwareConcurrency || 4,
                        memory: (navigator.deviceMemory || 4) * 1024, // MB
                        isLocal: true,
                        isLeader: false
                    });

                    this.updatePeerList();
                    this.updateStats();
                });

                this.peer.on('connection', (conn) => {
                    this.log(`Incoming connection from ${conn.peer}`, 'info');
                    this.handleConnection(conn);
                });

                this.peer.on('error', (err) => {
                    this.log(`Peer error: ${err.message}`, 'error');
                });
            },

            // Handle new peer connection
            handleConnection(conn) {
                conn.on('open', () => {
                    this.connections.set(conn.peer, conn);
                    this.log(`Connected to ${conn.peer}`, 'success');

                    // Exchange peer info
                    conn.send({
                        type: 'peer-info',
                        data: {
                            id: this.myPeerID,
                            name: 'Peer-' + this.myPeerID.substring(6, 10),
                            cpu: navigator.hardwareConcurrency || 4,
                            memory: (navigator.deviceMemory || 4) * 1024
                        }
                    });

                    // Request network topology
                    conn.send({
                        type: 'request-topology'
                    });

                    this.updatePeerCount();
                });

                conn.on('data', (data) => {
                    this.handleMessage(data, conn);
                });

                conn.on('close', () => {
                    this.connections.delete(conn.peer);
                    this.peers.delete(conn.peer);
                    this.log(`Disconnected from ${conn.peer}`, 'info');
                    this.updatePeerList();
                    this.updatePeerCount();
                });

                conn.on('error', (err) => {
                    this.log(`Connection error: ${err.message}`, 'error');
                });
            },

            // Handle incoming messages
            handleMessage(data, conn) {
                switch (data.type) {
                    case 'peer-info':
                        this.peers.set(data.data.id, {
                            ...data.data,
                            isLocal: false
                        });
                        this.updatePeerList();
                        this.updateStats();
                        break;

                    case 'chat':
                        this.displayChatMessage(data.sender, data.message, false);
                        break;

                    case 'file-chunk':
                        this.handleFileChunk(data.fileId, data.chunkIndex, data.chunk);
                        break;

                    case 'process-migrate':
                        this.receiveProcess(data.process);
                        break;

                    case 'request-topology':
                        // Send all known peers
                        conn.send({
                            type: 'topology',
                            peers: Array.from(this.peers.values())
                        });
                        break;

                    case 'topology':
                        // Merge received peer list
                        data.peers.forEach(peer => {
                            if (!this.peers.has(peer.id) && peer.id !== this.myPeerID) {
                                this.peers.set(peer.id, peer);
                            }
                        });
                        this.updatePeerList();
                        break;

                    case 'screen-share':
                        this.displaySharedScreen(data.imageData);
                        break;

                    case 'consensus-vote':
                        this.handleConsensusVote(data);
                        break;
                }
            },

            // Connect to a peer
            connectToPeer() {
                const remotePeerID = document.getElementById('remote-peer-id').value.trim();

                if (!remotePeerID) {
                    alert('Please enter a peer ID');
                    return;
                }

                if (this.connections.has(remotePeerID)) {
                    alert('Already connected to this peer');
                    return;
                }

                this.log(`Connecting to ${remotePeerID}...`, 'info');

                const conn = this.peer.connect(remotePeerID, {
                    reliable: true
                });

                this.handleConnection(conn);
                this.closeConnectionModal();
            },

            // Broadcast message to all peers
            broadcast(data) {
                this.connections.forEach((conn) => {
                    conn.send(data);
                });
            },

            // Send chat message
            sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message) return;

                this.displayChatMessage('You', message, true);

                this.broadcast({
                    type: 'chat',
                    sender: 'Peer-' + this.myPeerID.substring(6, 10),
                    message: message
                });

                input.value = '';
            },

            // Display chat message
            displayChatMessage(sender, message, isLocal) {
                const messagesEl = document.getElementById('chat-messages');

                const msgEl = document.createElement('div');
                msgEl.className = 'chat-message ' + (isLocal ? 'message-local' : 'message-remote');

                msgEl.innerHTML = `
                    <div class="message-sender">${sender}</div>
                    <div>${message}</div>
                `;

                messagesEl.appendChild(msgEl);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            },

            // Upload file to distributed file system
            uploadFile() {
                const input = document.createElement('input');
                input.type = 'file';

                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    this.log(`Uploading ${file.name} to distributed file system...`, 'info');

                    // Read file
                    const arrayBuffer = await file.arrayBuffer();
                    const fileId = 'file-' + Date.now();

                    // Split into chunks
                    const chunkSize = 64 * 1024; // 64KB chunks
                    const chunks = [];

                    for (let i = 0; i < arrayBuffer.byteLength; i += chunkSize) {
                        chunks.push(arrayBuffer.slice(i, i + chunkSize));
                    }

                    // Store file metadata
                    this.files.set(fileId, {
                        id: fileId,
                        name: file.name,
                        size: file.size,
                        chunks: chunks.length,
                        uploadedBy: this.myPeerID,
                        timestamp: new Date()
                    });

                    // Distribute chunks to peers
                    const peerArray = Array.from(this.connections.keys());
                    chunks.forEach((chunk, index) => {
                        const targetPeer = peerArray[index % peerArray.length];
                        if (targetPeer) {
                            this.connections.get(targetPeer).send({
                                type: 'file-chunk',
                                fileId,
                                chunkIndex: index,
                                chunk: Array.from(new Uint8Array(chunk))
                            });
                        }
                    });

                    this.updateFileList();
                    this.log(`File ${file.name} uploaded and distributed`, 'success');
                };

                input.click();
            },

            // Create distributed process
            createProcess() {
                const processId = 'proc-' + Date.now();

                this.processes.set(processId, {
                    id: processId,
                    name: 'Task-' + Math.random().toString(36).substring(2, 6),
                    location: this.myPeerID,
                    progress: 0,
                    status: 'running'
                });

                this.updateProcessList();
                this.log(`Process ${processId} created`, 'success');

                // Simulate process execution
                const interval = setInterval(() => {
                    const process = this.processes.get(processId);
                    if (!process) {
                        clearInterval(interval);
                        return;
                    }

                    process.progress += Math.random() * 10;

                    if (process.progress >= 100) {
                        process.progress = 100;
                        process.status = 'completed';
                        clearInterval(interval);
                    }

                    // Random process migration
                    if (Math.random() < 0.2 && this.connections.size > 0) {
                        const peers = Array.from(this.connections.keys());
                        const targetPeer = peers[Math.floor(Math.random() * peers.length)];

                        this.migrateProcess(processId, targetPeer);
                    }

                    this.updateProcessList();
                }, 1000);
            },

            // Migrate process to another peer
            migrateProcess(processId, targetPeerId) {
                const process = this.processes.get(processId);
                if (!process) return;

                this.log(`Migrating ${process.name} to ${targetPeerId.substring(0, 10)}...`, 'info');

                const conn = this.connections.get(targetPeerId);
                if (conn) {
                    conn.send({
                        type: 'process-migrate',
                        process: {
                            ...process,
                            location: targetPeerId
                        }
                    });

                    process.location = targetPeerId;
                    this.updateProcessList();
                }
            },

            // Receive migrated process
            receiveProcess(process) {
                this.processes.set(process.id, process);
                this.updateProcessList();
                this.log(`Received process ${process.name}`, 'success');
            },

            // Share screen
            async shareScreen() {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: true
                    });

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const sendFrame = () => {
                        if (stream.active) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            ctx.drawImage(video, 0, 0);

                            const imageData = canvas.toDataURL('image/jpeg', 0.5);

                            this.broadcast({
                                type: 'screen-share',
                                imageData
                            });

                            setTimeout(sendFrame, 1000 / 5); // 5 FPS
                        }
                    };

                    video.onloadeddata = () => sendFrame();

                    this.log('Screen sharing started', 'success');
                } catch (error) {
                    this.log('Screen share denied', 'error');
                }
            },

            // Setup network visualization canvas
            setupCanvas() {
                this.networkCanvas = document.getElementById('network-canvas');
                this.networkCtx = this.networkCanvas.getContext('2d');

                this.networkCanvas.width = this.networkCanvas.offsetWidth;
                this.networkCanvas.height = this.networkCanvas.offsetHeight;
            },

            // Animate network visualization
            startNetworkVisualization() {
                const animate = () => {
                    this.drawNetwork();
                    requestAnimationFrame(animate);
                };
                animate();
            },

            // Draw network mesh
            drawNetwork() {
                const ctx = this.networkCtx;
                const canvas = this.networkCanvas;

                ctx.fillStyle = '#1f2937';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const peers = Array.from(this.peers.values());
                if (peers.length === 0) return;

                // Position peers in a circle
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(canvas.width, canvas.height) * 0.35;

                peers.forEach((peer, index) => {
                    const angle = (index / peers.length) * Math.PI * 2 - Math.PI / 2;
                    peer.x = centerX + Math.cos(angle) * radius;
                    peer.y = centerY + Math.sin(angle) * radius;
                });

                // Draw connections
                ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)';
                ctx.lineWidth = 2;

                peers.forEach((peer1, i) => {
                    peers.forEach((peer2, j) => {
                        if (i < j) {
                            ctx.beginPath();
                            ctx.moveTo(peer1.x, peer1.y);
                            ctx.lineTo(peer2.x, peer2.y);
                            ctx.stroke();
                        }
                    });
                });

                // Draw peers
                peers.forEach((peer) => {
                    // Outer glow
                    const gradient = ctx.createRadialGradient(peer.x, peer.y, 0, peer.x, peer.y, 30);
                    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
                    gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(peer.x, peer.y, 30, 0, Math.PI * 2);
                    ctx.fill();

                    // Peer node
                    ctx.fillStyle = peer.isLocal ? '#fbbf24' : '#10b981';
                    ctx.beginPath();
                    ctx.arc(peer.x, peer.y, 15, 0, Math.PI * 2);
                    ctx.fill();

                    // Label
                    ctx.fillStyle = 'white';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(peer.name.substring(0, 8), peer.x, peer.y + 35);
                });
            },

            // Update peer list UI
            updatePeerList() {
                const listEl = document.getElementById('peer-list');
                const peers = Array.from(this.peers.values());

                if (peers.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No peers connected</div>';
                    return;
                }

                listEl.innerHTML = peers.map(peer => `
                    <div class="peer-item">
                        <div class="peer-info">
                            <div class="peer-avatar">${peer.name.substring(0, 2).toUpperCase()}</div>
                            <div class="peer-details">
                                <div class="peer-name">${peer.name}</div>
                                <div class="peer-stats">${peer.cpu} CPUs ‚Ä¢ ${(peer.memory / 1024).toFixed(1)} GB RAM</div>
                            </div>
                        </div>
                        ${peer.isLocal ? '<span class="peer-badge badge-active">You</span>' :
                          peer.isLeader ? '<span class="peer-badge badge-leader">Leader</span>' :
                          '<span class="peer-badge badge-active">Active</span>'}
                    </div>
                `).join('');
            },

            // Update file list UI
            updateFileList() {
                const listEl = document.getElementById('file-list');
                const files = Array.from(this.files.values());

                if (files.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">No files</div>';
                    return;
                }

                listEl.innerHTML = files.map(file => `
                    <div class="file-item">
                        <div>
                            <span class="file-icon">üìÑ</span>
                            ${file.name}
                        </div>
                        <div class="file-chunks">${file.chunks} chunks</div>
                    </div>
                `).join('');
            },

            // Update process list UI
            updateProcessList() {
                const listEl = document.getElementById('process-list');
                const processes = Array.from(this.processes.values());

                if (processes.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">No processes</div>';
                    return;
                }

                listEl.innerHTML = processes.map(proc => `
                    <div class="process-item">
                        <div class="process-header">
                            <div class="process-name">${proc.name}</div>
                            <div class="process-location">@ ${proc.location.substring(0, 10)}...</div>
                        </div>
                        <div class="process-progress">
                            <div class="process-progress-bar" style="width: ${proc.progress}%"></div>
                        </div>
                    </div>
                `).join('');
            },

            // Update peer count
            updatePeerCount() {
                const count = this.connections.size;
                document.getElementById('peer-count').textContent =
                    count === 0 ? 'No Peers Connected' :
                    count === 1 ? '1 Peer Connected' :
                    `${count} Peers Connected`;
            },

            // Update collective stats
            updateStats() {
                const peers = Array.from(this.peers.values());

                const totalCPU = peers.reduce((sum, peer) => sum + peer.cpu, 0);
                const totalMemory = peers.reduce((sum, peer) => sum + peer.memory, 0) / 1024; // GB
                const totalStorage = peers.length * 10; // Mock: 10GB per peer
                const networkSpeed = Math.min(peers.length * 100, 1000); // Mock

                document.getElementById('total-cpu').textContent = totalCPU;
                document.getElementById('total-memory').textContent = totalMemory.toFixed(1) + ' GB';
                document.getElementById('total-storage').textContent = totalStorage + ' GB';
                document.getElementById('network-speed').textContent = networkSpeed + ' Mbps';
            },

            // System logging
            log(message, type = 'info') {
                const logsEl = document.getElementById('system-logs');
                const timestamp = new Date().toLocaleTimeString();

                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;

                logsEl.appendChild(logEntry);
                logsEl.scrollTop = logsEl.scrollHeight;

                // Keep only last 100 logs
                while (logsEl.children.length > 100) {
                    logsEl.removeChild(logsEl.firstChild);
                }
            },

            // Modal controls
            showConnectionModal() {
                document.getElementById('connection-modal').classList.add('active');
                document.getElementById('my-peer-id').textContent = this.myPeerID || 'Generating...';
            },

            closeConnectionModal() {
                document.getElementById('connection-modal').classList.remove('active');
            },

            copyPeerID() {
                navigator.clipboard.writeText(this.myPeerID);
                alert('Peer ID copied to clipboard!');
            }
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            P2POS.init();
        });
    </script>
</body>
</html>
