<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Dead Poker - Blackwater Saloon</title>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Almendra:wght@400;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --felt-green: #1a4d2e;
            --felt-dark: #0d2818;
            --wood-dark: #2c1810;
            --wood-medium: #4a2c1a;
            --wood-light: #6b3d22;
            --gold: #d4a954;
            --gold-dark: #8b6914;
            --cream: #f5e6c8;
            --aged-paper: #e8dcc4;
            --blood-red: #8b0000;
            --lamp-glow: rgba(255, 180, 80, 0.15);
        }

        /* Location Themes */
        .theme-blackwater {
            --felt-green: #1a4d2e;
            --felt-dark: #0d2818;
            --wood-dark: #2c1810;
            --wood-medium: #4a2c1a;
            --wood-light: #6b3d22;
            --lamp-glow: rgba(255, 180, 80, 0.15);
        }

        .theme-valentine {
            --felt-green: #2d4a1a;
            --felt-dark: #1a2d0d;
            --wood-dark: #3d2817;
            --wood-medium: #5a3d22;
            --wood-light: #7a5233;
            --lamp-glow: rgba(255, 200, 100, 0.18);
        }

        .theme-rhodes {
            --felt-green: #4d3a1a;
            --felt-dark: #2d2210;
            --wood-dark: #1a1008;
            --wood-medium: #3a2515;
            --wood-light: #5a3a22;
            --lamp-glow: rgba(255, 160, 60, 0.2);
        }

        .theme-saintdenis {
            --felt-green: #1a3d4d;
            --felt-dark: #0d2833;
            --wood-dark: #1a1a2c;
            --wood-medium: #2a2a4a;
            --wood-light: #3a3a5a;
            --lamp-glow: rgba(200, 180, 255, 0.12);
        }

        .theme-tumbleweed {
            --felt-green: #4d4a3a;
            --felt-dark: #33312a;
            --wood-dark: #2c2218;
            --wood-medium: #4a3828;
            --wood-light: #6b5038;
            --lamp-glow: rgba(255, 220, 150, 0.15);
        }

        .theme-vanhorn {
            --felt-green: #2a3d2a;
            --felt-dark: #1a281a;
            --wood-dark: #1c1c1c;
            --wood-medium: #333333;
            --wood-light: #4a4a4a;
            --lamp-glow: rgba(200, 200, 200, 0.1);
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.95; }
            75% { opacity: 0.98; }
        }

        @keyframes cardDeal {
            from {
                transform: translateY(-100px) rotateY(180deg) scale(0.5);
                opacity: 0;
            }
            to {
                transform: translateY(0) rotateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes chipStack {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulseGold {
            0%, 100% { box-shadow: 0 0 10px rgba(212, 169, 84, 0.3); }
            50% { box-shadow: 0 0 20px rgba(212, 169, 84, 0.6); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes chipMove {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) translateY(-10px); }
            100% { transform: scale(1) translateY(0); }
        }

        @keyframes potGrow {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes winnerGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(212, 169, 84, 0.5),
                            0 0 40px rgba(212, 169, 84, 0.3),
                            0 0 60px rgba(212, 169, 84, 0.1);
            }
            50% {
                box-shadow: 0 0 30px rgba(212, 169, 84, 0.8),
                            0 0 60px rgba(212, 169, 84, 0.5),
                            0 0 90px rgba(212, 169, 84, 0.3);
            }
        }

        @keyframes strengthPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        body {
            font-family: 'IM Fell English', serif;
            background: var(--wood-dark);
            color: var(--cream);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Wood grain texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.03) 2px,
                    rgba(0,0,0,0.03) 4px
                ),
                linear-gradient(180deg,
                    var(--wood-dark) 0%,
                    var(--wood-medium) 50%,
                    var(--wood-dark) 100%
                );
            pointer-events: none;
            z-index: -1;
        }

        /* Lamp glow effect */
        .lamp-glow {
            position: fixed;
            top: -50%;
            left: 50%;
            transform: translateX(-50%);
            width: 150%;
            height: 100%;
            background: radial-gradient(ellipse at center top, var(--lamp-glow) 0%, transparent 60%);
            pointer-events: none;
            z-index: 1000;
            animation: flicker 4s ease-in-out infinite;
        }

        /* Header */
        .game-header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            position: relative;
        }

        .game-title {
            font-family: 'Rye', cursive;
            font-size: 2.5em;
            color: var(--gold);
            text-shadow:
                2px 2px 0 var(--wood-dark),
                4px 4px 8px rgba(0,0,0,0.8),
                0 0 30px rgba(212, 169, 84, 0.3);
            letter-spacing: 4px;
        }

        .game-subtitle {
            font-family: 'Almendra', serif;
            color: var(--aged-paper);
            font-size: 1.1em;
            opacity: 0.8;
            margin-top: 5px;
            font-style: italic;
        }

        /* Main game container */
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* Poker table */
        .poker-table {
            background:
                radial-gradient(ellipse at center, var(--felt-green) 0%, var(--felt-dark) 100%);
            border-radius: 200px;
            padding: 30px;
            position: relative;
            box-shadow:
                inset 0 0 100px rgba(0,0,0,0.5),
                0 10px 40px rgba(0,0,0,0.8),
                0 0 0 15px var(--wood-light),
                0 0 0 20px var(--wood-medium),
                0 0 0 30px var(--wood-dark);
            min-height: 600px;
            margin: 20px 0;
        }

        /* Felt texture */
        .poker-table::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 200px;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.05;
            pointer-events: none;
        }

        /* Player positions */
        .players-container {
            position: relative;
            height: 550px;
        }

        .player-seat {
            position: absolute;
            width: 180px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .player-seat.active {
            transform: scale(1.05);
        }

        .player-seat.folded {
            opacity: 0.4;
        }

        .player-seat.winner {
            animation: winnerGlow 1s ease-in-out infinite;
        }

        /* Player positions around oval table */
        .player-seat.position-0 { bottom: -20px; left: 50%; transform: translateX(-50%); }
        .player-seat.position-1 { bottom: 80px; left: 5%; }
        .player-seat.position-2 { top: 50%; left: 0; transform: translateY(-50%); }
        .player-seat.position-3 { top: 80px; left: 5%; }
        .player-seat.position-4 { top: -20px; left: 50%; transform: translateX(-50%); }
        .player-seat.position-5 { top: 80px; right: 5%; }
        .player-seat.position-6 { top: 50%; right: 0; transform: translateY(-50%); }
        .player-seat.position-7 { bottom: 80px; right: 5%; }

        .player-seat.position-0.active { transform: translateX(-50%) scale(1.05); }
        .player-seat.position-2.active { transform: translateY(-50%) scale(1.05); }
        .player-seat.position-4.active { transform: translateX(-50%) scale(1.05); }
        .player-seat.position-6.active { transform: translateY(-50%) scale(1.05); }

        /* Player avatar */
        .player-avatar {
            width: 70px;
            height: 70px;
            margin: 0 auto 8px;
            background: var(--wood-medium);
            border-radius: 50%;
            border: 3px solid var(--gold-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            box-shadow:
                0 4px 15px rgba(0,0,0,0.5),
                inset 0 -3px 10px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .player-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            border-radius: 50%;
        }

        .player-seat.active .player-avatar {
            border-color: var(--gold);
            box-shadow:
                0 4px 15px rgba(0,0,0,0.5),
                0 0 20px rgba(212, 169, 84, 0.5);
        }

        .dealer-chip {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #fff 0%, #ccc 100%);
            border-radius: 50%;
            font-size: 0.5em;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--gold);
            font-family: 'Rye', cursive;
        }

        .player-name {
            font-family: 'Almendra', serif;
            font-size: 0.95em;
            color: var(--cream);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            margin-bottom: 5px;
            font-weight: bold;
        }

        .player-chips {
            font-size: 0.85em;
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .chip-icon {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border-radius: 50%;
            border: 2px solid var(--cream);
        }

        .player-bet {
            position: absolute;
            background: rgba(0,0,0,0.7);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            color: var(--gold);
            border: 1px solid var(--gold-dark);
            white-space: nowrap;
            animation: chipMove 0.3s ease-out;
        }

        .player-seat.position-0 .player-bet { top: -30px; left: 50%; transform: translateX(-50%); }
        .player-seat.position-1 .player-bet { top: 20px; right: -40px; }
        .player-seat.position-2 .player-bet { top: 50%; right: -50px; transform: translateY(-50%); }
        .player-seat.position-3 .player-bet { bottom: 20px; right: -40px; }
        .player-seat.position-4 .player-bet { bottom: -30px; left: 50%; transform: translateX(-50%); }
        .player-seat.position-5 .player-bet { bottom: 20px; left: -40px; }
        .player-seat.position-6 .player-bet { top: 50%; left: -50px; transform: translateY(-50%); }
        .player-seat.position-7 .player-bet { top: 20px; left: -40px; }

        .player-action {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.75em;
            color: var(--cream);
            border: 1px solid var(--gold-dark);
            white-space: nowrap;
            animation: slideIn 0.3s ease-out;
        }

        .player-action.fold { border-color: #666; color: #999; }
        .player-action.check { border-color: #4a9; color: #6cb; }
        .player-action.call { border-color: var(--gold); }
        .player-action.raise { border-color: #d44; color: #f66; }
        .player-action.all-in { border-color: #f00; color: #f44; background: rgba(139,0,0,0.8); }

        /* Player cards */
        .player-cards {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 8px;
        }

        .card {
            width: 45px;
            height: 65px;
            background: linear-gradient(135deg, #fff 0%, #e8e8e8 100%);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow:
                2px 2px 8px rgba(0,0,0,0.4),
                inset 0 0 20px rgba(255,255,255,0.5);
            position: relative;
            animation: cardDeal 0.5s ease-out;
            border: 1px solid #ccc;
        }

        .card.face-down {
            background:
                repeating-linear-gradient(
                    45deg,
                    var(--blood-red),
                    var(--blood-red) 5px,
                    #6b0000 5px,
                    #6b0000 10px
                );
            border: 3px solid var(--gold-dark);
        }

        .card.face-down::after {
            content: '\1F0A0';
            font-size: 1.5em;
            filter: brightness(0.8);
        }

        .card-rank {
            font-size: 1.1em;
            line-height: 1;
        }

        .card-suit {
            font-size: 1.3em;
            line-height: 1;
        }

        .card.red { color: var(--blood-red); }
        .card.black { color: #1a1a1a; }

        .card.highlight {
            box-shadow:
                0 0 15px rgba(212, 169, 84, 0.8),
                2px 2px 8px rgba(0,0,0,0.4);
            border-color: var(--gold);
        }

        /* Community cards */
        .community-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .pot-display {
            background: rgba(0,0,0,0.7);
            padding: 8px 25px;
            border-radius: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--gold-dark);
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .pot-display.growing {
            animation: potGrow 0.3s ease;
        }

        .pot-label {
            font-size: 0.8em;
            color: var(--aged-paper);
            opacity: 0.8;
        }

        .pot-amount {
            font-family: 'Rye', cursive;
            font-size: 1.4em;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212, 169, 84, 0.5);
        }

        .community-cards {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .community-cards .card {
            width: 60px;
            height: 85px;
        }

        .community-cards .card-rank {
            font-size: 1.4em;
        }

        .community-cards .card-suit {
            font-size: 1.6em;
        }

        .game-phase {
            font-family: 'Almendra', serif;
            font-size: 0.9em;
            color: var(--aged-paper);
            opacity: 0.7;
            font-style: italic;
        }

        /* Controls panel */
        .controls-panel {
            background: linear-gradient(180deg, var(--wood-medium) 0%, var(--wood-dark) 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow:
                0 5px 20px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
            border: 2px solid var(--wood-light);
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .your-hand-info {
            text-align: left;
        }

        .your-hand-label {
            font-size: 0.85em;
            color: var(--aged-paper);
            opacity: 0.7;
        }

        .your-hand-value {
            font-family: 'Almendra', serif;
            font-size: 1.3em;
            color: var(--gold);
            font-weight: bold;
        }

        /* Hand Strength Meter */
        .hand-strength-container {
            margin-top: 8px;
        }

        .hand-strength-label {
            font-size: 0.75em;
            color: var(--aged-paper);
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .hand-strength-bar {
            width: 150px;
            height: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--gold-dark);
        }

        .hand-strength-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.5s ease;
        }

        .hand-strength-fill.weak {
            background: linear-gradient(90deg, #c44 0%, #922 100%);
        }

        .hand-strength-fill.medium {
            background: linear-gradient(90deg, #ca4 0%, #a82 100%);
        }

        .hand-strength-fill.strong {
            background: linear-gradient(90deg, #4a4 0%, #282 100%);
        }

        .hand-strength-fill.monster {
            background: linear-gradient(90deg, var(--gold) 0%, var(--gold-dark) 100%);
            animation: strengthPulse 1s ease-in-out infinite;
        }

        .blinds-info {
            text-align: right;
            font-size: 0.85em;
            color: var(--aged-paper);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            font-family: 'Rye', cursive;
            font-size: 1em;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            pointer-events: none;
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-btn:not(:disabled):hover {
            transform: translateY(-2px);
        }

        .action-btn:not(:disabled):active {
            transform: translateY(0);
        }

        .btn-fold {
            background: linear-gradient(180deg, #666 0%, #444 100%);
            color: #ccc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .btn-check {
            background: linear-gradient(180deg, #4a9979 0%, #2d6b5a 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(45, 107, 90, 0.4);
        }

        .btn-call {
            background: linear-gradient(180deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--wood-dark);
            box-shadow: 0 4px 15px rgba(212, 169, 84, 0.4);
        }

        .btn-raise {
            background: linear-gradient(180deg, #c44 0%, #922 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(153, 34, 34, 0.4);
        }

        .btn-allin {
            background: linear-gradient(180deg, var(--blood-red) 0%, #500 100%);
            color: var(--gold);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.6);
            animation: pulseGold 2s ease-in-out infinite;
        }

        /* Raise slider */
        .raise-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .raise-slider-container {
            flex: 1;
            position: relative;
        }

        .raise-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, var(--felt-dark) 0%, var(--gold-dark) 100%);
            border-radius: 4px;
            outline: none;
        }

        .raise-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--cream);
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }

        .raise-amount {
            font-family: 'Rye', cursive;
            font-size: 1.2em;
            color: var(--gold);
            min-width: 80px;
            text-align: right;
        }

        .preset-bets {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .preset-btn {
            font-family: 'Almendra', serif;
            font-size: 0.85em;
            padding: 6px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--gold-dark);
            color: var(--cream);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            background: rgba(212, 169, 84, 0.2);
            border-color: var(--gold);
        }

        /* Game info sidebar */
        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-panel {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .info-panel h3 {
            font-family: 'Rye', cursive;
            font-size: 1em;
            color: var(--gold);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .hand-rankings {
            font-size: 0.85em;
            line-height: 1.8;
        }

        .hand-rankings li {
            list-style: none;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .hand-rankings li:last-child {
            border-bottom: none;
        }

        .hand-rankings span {
            color: var(--gold);
            font-weight: bold;
        }

        /* Game log */
        .game-log {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.85em;
        }

        .game-log::-webkit-scrollbar {
            width: 6px;
        }

        .game-log::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .game-log::-webkit-scrollbar-thumb {
            background: var(--gold-dark);
            border-radius: 3px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: slideIn 0.3s ease-out;
        }

        .log-entry.action { color: var(--cream); }
        .log-entry.win { color: var(--gold); font-weight: bold; }
        .log-entry.fold { color: #888; }
        .log-entry.system { color: #6cb; font-style: italic; }

        /* Menu and Settings */
        .menu-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .menu-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .menu-btn {
            font-family: 'Almendra', serif;
            font-size: 0.9em;
            padding: 8px 20px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold-dark);
            color: var(--cream);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .menu-btn:hover {
            background: rgba(212, 169, 84, 0.2);
            border-color: var(--gold);
        }

        .menu-btn.active {
            background: rgba(212, 169, 84, 0.3);
            border-color: var(--gold);
        }

        .player-stats {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--gold-dark);
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--aged-paper);
            opacity: 0.7;
        }

        .stat-value {
            font-family: 'Rye', cursive;
            color: var(--gold);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: linear-gradient(180deg, var(--wood-medium) 0%, var(--wood-dark) 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 3px solid var(--gold-dark);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal h2 {
            font-family: 'Rye', cursive;
            color: var(--gold);
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-content {
            margin-bottom: 25px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: var(--cream);
        }

        select, input[type="checkbox"] {
            font-family: 'Almendra', serif;
            padding: 8px 15px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold-dark);
            color: var(--cream);
            border-radius: 5px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            transition: 0.4s;
            border-radius: 26px;
            border: 1px solid var(--gold-dark);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 3px;
            background-color: var(--cream);
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--gold-dark);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .poker-table {
                border-radius: 150px;
            }
        }

        @media (max-width: 900px) {
            .poker-table {
                border-radius: 100px;
                padding: 20px;
            }

            .players-container {
                height: 450px;
            }

            .player-seat {
                width: 140px;
            }

            .player-avatar {
                width: 55px;
                height: 55px;
                font-size: 1.5em;
            }

            .card {
                width: 35px;
                height: 50px;
            }

            .community-cards .card {
                width: 50px;
                height: 70px;
            }
        }

        @media (max-width: 600px) {
            .game-title {
                font-size: 1.8em;
            }

            .poker-table {
                border-radius: 80px;
                min-height: 400px;
            }

            .players-container {
                height: 350px;
            }

            .action-btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }

            .menu-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .player-stats {
                justify-content: center;
            }
        }

        /* Winner announcement */
        .winner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .winner-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .winner-announcement {
            text-align: center;
            animation: slideIn 0.5s ease-out;
        }

        .winner-announcement h2 {
            font-family: 'Rye', cursive;
            font-size: 3em;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(212, 169, 84, 0.8);
            margin-bottom: 20px;
        }

        .winner-hand {
            font-family: 'Almendra', serif;
            font-size: 1.5em;
            color: var(--cream);
            margin-bottom: 30px;
        }

        .winner-pot {
            font-family: 'Rye', cursive;
            font-size: 2em;
            color: var(--gold);
        }

        .winner-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .winner-cards .card {
            width: 60px;
            height: 85px;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: var(--cream);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Statistics Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stats-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .stats-item-label {
            font-size: 0.75em;
            color: var(--aged-paper);
            opacity: 0.7;
        }

        .stats-item-value {
            font-family: 'Rye', cursive;
            font-size: 1.1em;
            color: var(--gold);
        }
    </style>
</head>
<body class="theme-blackwater">
    <div class="lamp-glow"></div>

    <div class="game-header">
        <h1 class="game-title">RED DEAD POKER</h1>
        <p class="game-subtitle" id="locationSubtitle">Blackwater Saloon ‚Äî Texas Hold'em</p>
    </div>

    <div class="game-container">
        <div class="menu-bar">
            <div class="menu-buttons">
                <button class="menu-btn" onclick="showSettings()">Settings</button>
                <button class="menu-btn" onclick="startNewGame()">New Game</button>
                <button class="menu-btn" onclick="showStats()">Statistics</button>
                <button class="menu-btn" id="soundToggle" onclick="toggleSound()">Sound: ON</button>
            </div>
            <div class="player-stats">
                <div class="stat-item">
                    <div class="stat-label">Your Stack</div>
                    <div class="stat-value" id="playerStack">$1,000</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Hands Won</div>
                    <div class="stat-value" id="handsWon">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Session</div>
                    <div class="stat-value" id="sessionProfit">$0</div>
                </div>
            </div>
        </div>

        <div class="poker-table">
            <div class="players-container" id="playersContainer">
                <!-- Players will be rendered here -->
            </div>

            <div class="community-area">
                <div class="pot-display" id="potDisplay">
                    <div class="pot-label">POT</div>
                    <div class="pot-amount" id="potAmount">$0</div>
                </div>
                <div class="community-cards" id="communityCards">
                    <!-- Community cards rendered here -->
                </div>
                <div class="game-phase" id="gamePhase">Waiting to start...</div>
            </div>
        </div>

        <div class="controls-panel" id="controlsPanel">
            <div class="controls-header">
                <div class="your-hand-info">
                    <div class="your-hand-label">Your Hand</div>
                    <div class="your-hand-value" id="yourHandValue">‚Äî</div>
                    <div class="hand-strength-container" id="handStrengthContainer" style="display: none;">
                        <div class="hand-strength-label">Hand Strength</div>
                        <div class="hand-strength-bar">
                            <div class="hand-strength-fill" id="handStrengthFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="blinds-info">
                    <div>Blinds: <span id="blindsDisplay">$5 / $10</span></div>
                    <div>To Call: <span id="toCallAmount">$0</span></div>
                </div>
            </div>

            <div class="action-buttons" id="actionButtons">
                <button class="action-btn btn-fold" onclick="playerAction('fold')" id="btnFold" disabled>Fold</button>
                <button class="action-btn btn-check" onclick="playerAction('check')" id="btnCheck" disabled>Check</button>
                <button class="action-btn btn-call" onclick="playerAction('call')" id="btnCall" disabled>Call <span id="callAmount"></span></button>
                <button class="action-btn btn-raise" onclick="playerAction('raise')" id="btnRaise" disabled>Raise</button>
                <button class="action-btn btn-allin" onclick="playerAction('allin')" id="btnAllIn" disabled>All In</button>
            </div>

            <div class="raise-controls" id="raiseControls" style="display: none;">
                <span style="color: var(--cream);">Raise to:</span>
                <div class="raise-slider-container">
                    <input type="range" class="raise-slider" id="raiseSlider" min="0" max="1000" value="20">
                </div>
                <div class="raise-amount" id="raiseAmountDisplay">$20</div>
            </div>

            <div class="preset-bets" id="presetBets" style="display: none;">
                <button class="preset-btn" onclick="setRaisePreset(0.5)">1/2 Pot</button>
                <button class="preset-btn" onclick="setRaisePreset(0.75)">3/4 Pot</button>
                <button class="preset-btn" onclick="setRaisePreset(1)">Pot</button>
                <button class="preset-btn" onclick="setRaisePreset(2)">2x Pot</button>
            </div>
        </div>

        <div class="game-info">
            <div class="info-panel">
                <h3>Game Log</h3>
                <div class="game-log" id="gameLog">
                    <div class="log-entry system">Welcome to Red Dead Poker. Click "New Game" to begin.</div>
                </div>
            </div>

            <div class="info-panel">
                <h3>Quick Reference</h3>
                <ul class="hand-rankings">
                    <li><span>Royal Flush</span> ‚Äî A, K, Q, J, 10 same suit</li>
                    <li><span>Straight Flush</span> ‚Äî Five sequential, same suit</li>
                    <li><span>Four of a Kind</span> ‚Äî Four cards same rank</li>
                    <li><span>Full House</span> ‚Äî Three of a kind + pair</li>
                    <li><span>Flush</span> ‚Äî Five cards same suit</li>
                    <li><span>Straight</span> ‚Äî Five sequential cards</li>
                    <li><span>Three of a Kind</span> ‚Äî Three same rank</li>
                    <li><span>Two Pair</span> ‚Äî Two different pairs</li>
                    <li><span>One Pair</span> ‚Äî Two same rank</li>
                    <li><span>High Card</span> ‚Äî Highest card wins</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h2>Game Settings</h2>
            <div class="modal-content">
                <div class="setting-row">
                    <span class="setting-label">Number of Opponents</span>
                    <select id="numOpponents">
                        <option value="2">2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4" selected>4 Players</option>
                        <option value="5">5 Players</option>
                        <option value="6">6 Players</option>
                        <option value="7">7 Players</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Starting Stack</span>
                    <select id="startingStack">
                        <option value="500">$500</option>
                        <option value="1000" selected>$1,000</option>
                        <option value="2500">$2,500</option>
                        <option value="5000">$5,000</option>
                        <option value="10000">$10,000</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Blinds</span>
                    <select id="blindsSelect">
                        <option value="1-2">$1 / $2</option>
                        <option value="5-10" selected>$5 / $10</option>
                        <option value="10-20">$10 / $20</option>
                        <option value="25-50">$25 / $50</option>
                        <option value="50-100">$50 / $100</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Game Speed</span>
                    <select id="gameSpeed">
                        <option value="slow">Slow</option>
                        <option value="normal" selected>Normal</option>
                        <option value="fast">Fast</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Location</span>
                    <select id="locationSelect">
                        <option value="blackwater" selected>Blackwater Saloon</option>
                        <option value="valentine">Valentine Saloon</option>
                        <option value="rhodes">Rhodes Parlor House</option>
                        <option value="saintdenis">Saint Denis Hotel</option>
                        <option value="tumbleweed">Tumbleweed Saloon</option>
                        <option value="vanhorn">Van Horn Trading Post</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Show Hand Strength</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showHandStrength" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Auto-Save Progress</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSave" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="menu-btn" onclick="closeSettings()">Cancel</button>
                <button class="action-btn btn-call" onclick="applySettings()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal">
            <h2>Statistics</h2>
            <div class="modal-content">
                <div class="stats-grid">
                    <div class="stats-item">
                        <div class="stats-item-label">Hands Played</div>
                        <div class="stats-item-value" id="statsHandsPlayed">0</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-label">Hands Won</div>
                        <div class="stats-item-value" id="statsHandsWon">0</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-label">Win Rate</div>
                        <div class="stats-item-value" id="statsWinRate">0%</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-label">Biggest Pot Won</div>
                        <div class="stats-item-value" id="statsBiggestPot">$0</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-label">Total Earnings</div>
                        <div class="stats-item-value" id="statsTotalEarnings">$0</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-label">Best Hand</div>
                        <div class="stats-item-value" id="statsBestHand">‚Äî</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-label">Bluffs Won</div>
                        <div class="stats-item-value" id="statsBluffsWon">0</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-label">All-Ins Won</div>
                        <div class="stats-item-value" id="statsAllInsWon">0</div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="menu-btn" onclick="resetStats()">Reset Stats</button>
                <button class="action-btn btn-call" onclick="closeStats()">Close</button>
            </div>
        </div>
    </div>

    <!-- Winner Modal -->
    <div class="winner-overlay" id="winnerOverlay">
        <div class="winner-announcement">
            <h2 id="winnerName">Winner!</h2>
            <div class="winner-cards" id="winnerCards"></div>
            <div class="winner-hand" id="winnerHand">Royal Flush</div>
            <div class="winner-pot" id="winnerPot">Wins $500</div>
            <br><br>
            <button class="action-btn btn-call" onclick="closeWinnerOverlay()">Continue</button>
        </div>
    </div>

    <script>
        // ==================== GAME CONSTANTS ====================
        const SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const RANK_VALUES = { '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14 };

        const HAND_RANKINGS = {
            'Royal Flush': 10,
            'Straight Flush': 9,
            'Four of a Kind': 8,
            'Full House': 7,
            'Flush': 6,
            'Straight': 5,
            'Three of a Kind': 4,
            'Two Pair': 3,
            'One Pair': 2,
            'High Card': 1
        };

        const LOCATIONS = {
            blackwater: { name: 'Blackwater Saloon', theme: 'theme-blackwater' },
            valentine: { name: 'Valentine Saloon', theme: 'theme-valentine' },
            rhodes: { name: 'Rhodes Parlor House', theme: 'theme-rhodes' },
            saintdenis: { name: 'Saint Denis Hotel', theme: 'theme-saintdenis' },
            tumbleweed: { name: 'Tumbleweed Saloon', theme: 'theme-tumbleweed' },
            vanhorn: { name: 'Van Horn Trading Post', theme: 'theme-vanhorn' }
        };

        // RDR Character data with enhanced AI profiles
        const RDR_CHARACTERS = [
            { name: 'Arthur Morgan', avatar: 'ü§†', style: 'balanced', aggression: 0.5, bluffFreq: 0.3, tiltFactor: 0.2 },
            { name: 'Dutch van der Linde', avatar: 'üé©', style: 'aggressive', aggression: 0.7, bluffFreq: 0.5, tiltFactor: 0.4 },
            { name: 'John Marston', avatar: 'üê∫', style: 'tight', aggression: 0.4, bluffFreq: 0.2, tiltFactor: 0.3 },
            { name: 'Hosea Matthews', avatar: 'üë¥', style: 'tricky', aggression: 0.5, bluffFreq: 0.6, tiltFactor: 0.1 },
            { name: 'Micah Bell', avatar: 'üêç', style: 'maniac', aggression: 0.8, bluffFreq: 0.7, tiltFactor: 0.6 },
            { name: 'Sadie Adler', avatar: 'üí™', style: 'aggressive', aggression: 0.65, bluffFreq: 0.35, tiltFactor: 0.35 },
            { name: 'Charles Smith', avatar: 'ü¶Ö', style: 'tight', aggression: 0.35, bluffFreq: 0.15, tiltFactor: 0.1 },
            { name: 'Lenny Summers', avatar: 'üìö', style: 'balanced', aggression: 0.45, bluffFreq: 0.25, tiltFactor: 0.2 },
            { name: 'Bill Williamson', avatar: 'üêó', style: 'loose', aggression: 0.6, bluffFreq: 0.4, tiltFactor: 0.5 },
            { name: 'Javier Escuella', avatar: 'üé∏', style: 'balanced', aggression: 0.5, bluffFreq: 0.35, tiltFactor: 0.25 },
            { name: 'Uncle', avatar: 'üç∫', style: 'loose', aggression: 0.3, bluffFreq: 0.5, tiltFactor: 0.7 },
            { name: 'Trelawny', avatar: 'üé≠', style: 'tricky', aggression: 0.55, bluffFreq: 0.65, tiltFactor: 0.15 },
            { name: 'Sean MacGuire', avatar: '‚òòÔ∏è', style: 'maniac', aggression: 0.7, bluffFreq: 0.55, tiltFactor: 0.55 },
            { name: 'Kieran Duffy', avatar: 'üê¥', style: 'tight', aggression: 0.25, bluffFreq: 0.1, tiltFactor: 0.4 },
            { name: 'Leopold Strauss', avatar: 'üí∞', style: 'tight', aggression: 0.3, bluffFreq: 0.2, tiltFactor: 0.2 }
        ];

        // ==================== SOUND SYSTEM ====================
        const SoundManager = {
            enabled: true,
            audioContext: null,

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Web Audio API not supported');
                }
            },

            play(type) {
                if (!this.enabled || !this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                switch(type) {
                    case 'card':
                        oscillator.frequency.value = 800;
                        gainNode.gain.value = 0.1;
                        oscillator.type = 'sine';
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.05);
                        break;
                    case 'chip':
                        oscillator.frequency.value = 1200;
                        gainNode.gain.value = 0.08;
                        oscillator.type = 'sine';
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.03);
                        break;
                    case 'win':
                        this.playWinSound();
                        break;
                    case 'fold':
                        oscillator.frequency.value = 300;
                        gainNode.gain.value = 0.1;
                        oscillator.type = 'sine';
                        oscillator.start();
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                        oscillator.stop(this.audioContext.currentTime + 0.2);
                        break;
                    case 'check':
                        oscillator.frequency.value = 600;
                        gainNode.gain.value = 0.08;
                        oscillator.type = 'triangle';
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.08);
                        break;
                    case 'raise':
                        oscillator.frequency.value = 500;
                        gainNode.gain.value = 0.1;
                        oscillator.type = 'sawtooth';
                        oscillator.start();
                        oscillator.frequency.exponentialRampToValueAtTime(800, this.audioContext.currentTime + 0.1);
                        oscillator.stop(this.audioContext.currentTime + 0.15);
                        break;
                    case 'allin':
                        this.playAllInSound();
                        break;
                }
            },

            playWinSound() {
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        const osc = this.audioContext.createOscillator();
                        const gain = this.audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(this.audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.value = 0.15;
                        osc.type = 'sine';
                        osc.start();
                        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                        osc.stop(this.audioContext.currentTime + 0.3);
                    }, i * 100);
                });
            },

            playAllInSound() {
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                osc.connect(gain);
                gain.connect(this.audioContext.destination);
                osc.frequency.value = 150;
                gain.gain.value = 0.2;
                osc.type = 'sawtooth';
                osc.start();
                osc.frequency.exponentialRampToValueAtTime(600, this.audioContext.currentTime + 0.3);
                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);
                osc.stop(this.audioContext.currentTime + 0.4);
            },

            toggle() {
                this.enabled = !this.enabled;
                document.getElementById('soundToggle').textContent = `Sound: ${this.enabled ? 'ON' : 'OFF'}`;
                if (this.enabled && !this.audioContext) {
                    this.init();
                }
            }
        };

        // ==================== PERSISTENCE ====================
        const Storage = {
            save(key, data) {
                try {
                    localStorage.setItem(`rdrpoker_${key}`, JSON.stringify(data));
                } catch (e) {
                    console.log('LocalStorage not available');
                }
            },

            load(key, defaultValue = null) {
                try {
                    const data = localStorage.getItem(`rdrpoker_${key}`);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            },

            clear(key) {
                try {
                    localStorage.removeItem(`rdrpoker_${key}`);
                } catch (e) {}
            }
        };

        // ==================== GAME STATE ====================
        let gameState = {
            deck: [],
            players: [],
            communityCards: [],
            pot: 0,
            currentBet: 0,
            minRaise: 0,
            dealerIndex: 0,
            currentPlayerIndex: 0,
            phase: 'waiting',
            smallBlind: 5,
            bigBlind: 10,
            gameSpeed: 1000,
            handsPlayed: 0,
            playerWins: 0,
            startingStack: 1000,
            sidePots: [],
            location: 'blackwater',
            showHandStrength: true,
            autoSave: true
        };

        // Player statistics
        let playerStats = {
            handsPlayed: 0,
            handsWon: 0,
            biggestPot: 0,
            totalEarnings: 0,
            bestHand: { name: '‚Äî', rank: 0 },
            bluffsWon: 0,
            allInsWon: 0
        };

        // ==================== UTILITY FUNCTIONS ====================
        function createDeck() {
            const deck = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    deck.push({ rank, suit });
                }
            }
            return shuffleDeck(deck);
        }

        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getCardColor(suit) {
            return (suit === '‚ô•' || suit === '‚ô¶') ? 'red' : 'black';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms * (2 - gameState.gameSpeed / 1000)));
        }

        function formatMoney(amount) {
            return '$' + amount.toLocaleString();
        }

        function addLog(message, type = 'action') {
            const log = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            log.insertBefore(entry, log.firstChild);

            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        // ==================== HAND EVALUATION ====================
        function evaluateHand(cards) {
            if (cards.length < 5) return { rank: 0, name: 'Incomplete', value: [] };

            const allCombinations = getCombinations(cards, 5);
            let bestHand = { rank: 0, name: 'High Card', value: [] };

            for (const combo of allCombinations) {
                const hand = evaluateFiveCardHand(combo);
                if (hand.rank > bestHand.rank ||
                    (hand.rank === bestHand.rank && compareValues(hand.value, bestHand.value) > 0)) {
                    bestHand = hand;
                }
            }

            return bestHand;
        }

        function getCombinations(arr, k) {
            const result = [];

            function combine(start, combo) {
                if (combo.length === k) {
                    result.push([...combo]);
                    return;
                }
                for (let i = start; i < arr.length; i++) {
                    combo.push(arr[i]);
                    combine(i + 1, combo);
                    combo.pop();
                }
            }

            combine(0, []);
            return result;
        }

        function evaluateFiveCardHand(cards) {
            const ranks = cards.map(c => RANK_VALUES[c.rank]).sort((a, b) => b - a);
            const suits = cards.map(c => c.suit);

            const isFlush = suits.every(s => s === suits[0]);
            const uniqueRanks = [...new Set(ranks)];

            let isStraight = false;
            let straightHigh = 0;

            if (uniqueRanks.length === 5) {
                if (ranks[0] - ranks[4] === 4) {
                    isStraight = true;
                    straightHigh = ranks[0];
                }
                if (ranks[0] === 14 && ranks[1] === 5 && ranks[2] === 4 && ranks[3] === 3 && ranks[4] === 2) {
                    isStraight = true;
                    straightHigh = 5;
                }
            }

            const rankCounts = {};
            for (const r of ranks) {
                rankCounts[r] = (rankCounts[r] || 0) + 1;
            }
            const counts = Object.values(rankCounts).sort((a, b) => b - a);
            const countRanks = Object.entries(rankCounts)
                .sort((a, b) => b[1] - a[1] || b[0] - a[0])
                .map(e => parseInt(e[0]));

            if (isFlush && isStraight && straightHigh === 14) {
                return { rank: 10, name: 'Royal Flush', value: [14] };
            }
            if (isFlush && isStraight) {
                return { rank: 9, name: 'Straight Flush', value: [straightHigh] };
            }
            if (counts[0] === 4) {
                return { rank: 8, name: 'Four of a Kind', value: countRanks };
            }
            if (counts[0] === 3 && counts[1] === 2) {
                return { rank: 7, name: 'Full House', value: countRanks };
            }
            if (isFlush) {
                return { rank: 6, name: 'Flush', value: ranks };
            }
            if (isStraight) {
                return { rank: 5, name: 'Straight', value: [straightHigh] };
            }
            if (counts[0] === 3) {
                return { rank: 4, name: 'Three of a Kind', value: countRanks };
            }
            if (counts[0] === 2 && counts[1] === 2) {
                return { rank: 3, name: 'Two Pair', value: countRanks };
            }
            if (counts[0] === 2) {
                return { rank: 2, name: 'One Pair', value: countRanks };
            }
            return { rank: 1, name: 'High Card', value: ranks };
        }

        function compareValues(a, b) {
            for (let i = 0; i < Math.max(a.length, b.length); i++) {
                if ((a[i] || 0) > (b[i] || 0)) return 1;
                if ((a[i] || 0) < (b[i] || 0)) return -1;
            }
            return 0;
        }

        function getHandStrength(cards) {
            if (cards.length < 2) return 0;

            const hand = evaluateHand(cards);
            let strength = hand.rank / 10;

            if (hand.value.length > 0) {
                strength += hand.value[0] / 140;
            }

            return strength;
        }

        function calculateHandStrengthPercentage(player) {
            const allCards = [...player.cards, ...gameState.communityCards];

            if (allCards.length < 2) return 0;

            // Pre-flop hand strength
            if (gameState.communityCards.length === 0) {
                const card1 = RANK_VALUES[player.cards[0].rank];
                const card2 = RANK_VALUES[player.cards[1].rank];
                const isPair = card1 === card2;
                const isSuited = player.cards[0].suit === player.cards[1].suit;
                const highCard = Math.max(card1, card2);
                const lowCard = Math.min(card1, card2);
                const gap = highCard - lowCard;

                let strength = 0;

                // Pairs
                if (isPair) {
                    strength = 50 + (card1 / 14) * 45;
                } else {
                    // High cards
                    strength = (highCard / 14) * 30 + (lowCard / 14) * 15;
                    if (isSuited) strength += 8;
                    if (gap <= 2) strength += 5;
                    if (gap === 1) strength += 3;

                    // Premium connectors
                    if (highCard >= 10 && lowCard >= 10) strength += 10;
                    if (highCard === 14) strength += 8;
                }

                return Math.min(100, strength);
            }

            // Post-flop: use actual hand evaluation
            const hand = evaluateHand(allCards);
            let baseStrength = (hand.rank / 10) * 80;

            // Add kicker strength
            if (hand.value.length > 0) {
                baseStrength += (hand.value[0] / 14) * 20;
            }

            return Math.min(100, baseStrength);
        }

        // ==================== AI LOGIC ====================
        function getAIDecision(player, toCall) {
            const { aggression, bluffFreq, style, tiltFactor } = player.character;
            const allCards = [...player.cards, ...gameState.communityCards];
            const handStrength = getHandStrength(allCards);
            const potOdds = toCall > 0 ? toCall / (gameState.pot + toCall) : 0;
            const stackRatio = player.chips / gameState.bigBlind;

            // Position awareness (later position = more aggressive)
            const positionBonus = getPositionBonus(player);

            // Tilt factor - after losing a big pot, may play looser
            const tiltAdjustment = player.justLostBigPot ? tiltFactor * 0.2 : 0;

            const randomFactor = Math.random();

            let effectiveStrength = handStrength + positionBonus + tiltAdjustment;

            // Pre-flop adjustments
            if (gameState.phase === 'preflop') {
                const card1 = RANK_VALUES[player.cards[0].rank];
                const card2 = RANK_VALUES[player.cards[1].rank];
                const isPair = card1 === card2;
                const isSuited = player.cards[0].suit === player.cards[1].suit;
                const highCard = Math.max(card1, card2);
                const gap = Math.abs(card1 - card2);

                effectiveStrength = 0.2;

                if (isPair) {
                    effectiveStrength = 0.4 + (card1 / 14) * 0.5;
                } else {
                    effectiveStrength = (highCard / 14) * 0.3;
                    if (isSuited) effectiveStrength += 0.1;
                    if (gap <= 2) effectiveStrength += 0.05;
                    if (gap === 0) effectiveStrength += 0.1;
                }

                if (isPair && card1 >= 10) effectiveStrength = 0.85;
                if (highCard === 14 && Math.min(card1, card2) >= 10) effectiveStrength = 0.75;

                effectiveStrength += positionBonus;
            }

            // Style modifiers
            switch (style) {
                case 'tight':
                    effectiveStrength *= 0.85;
                    break;
                case 'loose':
                    effectiveStrength *= 1.15;
                    break;
                case 'aggressive':
                    effectiveStrength *= 1.1;
                    break;
                case 'maniac':
                    effectiveStrength *= 1.25;
                    break;
                case 'tricky':
                    if (randomFactor < 0.3) {
                        effectiveStrength = 1 - effectiveStrength;
                    }
                    break;
            }

            // Bluffing logic
            const isBluffing = randomFactor < bluffFreq && effectiveStrength < 0.4;
            if (isBluffing) {
                effectiveStrength += 0.4;
                player.isBluffing = true;
            } else {
                player.isBluffing = false;
            }

            // Stack size considerations
            if (stackRatio < 10) {
                // Short stack - more likely to go all-in with decent hands
                if (effectiveStrength > 0.5 && randomFactor < 0.3) {
                    return { action: 'allin' };
                }
            }

            // Decision making
            if (toCall === 0) {
                if (effectiveStrength > 0.6 && randomFactor < aggression) {
                    const raiseAmount = calculateRaiseAmount(player, effectiveStrength);
                    return { action: 'raise', amount: raiseAmount };
                }
                return { action: 'check' };
            }

            const callThreshold = 0.25 + (potOdds * 0.5);

            if (effectiveStrength < callThreshold - 0.1) {
                if (randomFactor < 0.1) {
                    return { action: 'call' };
                }
                return { action: 'fold' };
            }

            if (effectiveStrength < callThreshold + 0.1) {
                if (randomFactor < 0.2) {
                    return { action: 'fold' };
                }
                return { action: 'call' };
            }

            if (effectiveStrength > 0.7 && randomFactor < aggression) {
                const raiseAmount = calculateRaiseAmount(player, effectiveStrength);
                if (raiseAmount > toCall) {
                    return { action: 'raise', amount: raiseAmount };
                }
            }

            return { action: 'call' };
        }

        function getPositionBonus(player) {
            const totalPlayers = gameState.players.filter(p => !p.folded).length;
            const dealerDistance = (player.id - gameState.dealerIndex + gameState.players.length) % gameState.players.length;
            // Later position gets bonus (closer to dealer button)
            return (dealerDistance / totalPlayers) * 0.1;
        }

        function calculateRaiseAmount(player, strength) {
            const minRaise = Math.max(gameState.currentBet + gameState.minRaise, gameState.bigBlind * 2);
            const maxRaise = player.chips + player.currentBet;

            let multiplier = 0.5 + (strength * 1.5);
            multiplier *= (0.8 + Math.random() * 0.4);

            let raiseAmount = Math.floor(gameState.pot * multiplier);
            raiseAmount = Math.max(raiseAmount, minRaise);
            raiseAmount = Math.min(raiseAmount, maxRaise);

            if (raiseAmount > 100) {
                raiseAmount = Math.round(raiseAmount / 25) * 25;
            } else if (raiseAmount > 20) {
                raiseAmount = Math.round(raiseAmount / 5) * 5;
            }

            return raiseAmount;
        }

        // ==================== GAME FLOW ====================
        async function startNewGame() {
            const numOpponents = parseInt(document.getElementById('numOpponents').value);
            const startingStack = parseInt(document.getElementById('startingStack').value);
            const blinds = document.getElementById('blindsSelect').value.split('-');
            const speed = document.getElementById('gameSpeed').value;
            const location = document.getElementById('locationSelect').value;

            gameState.smallBlind = parseInt(blinds[0]);
            gameState.bigBlind = parseInt(blinds[1]);
            gameState.startingStack = startingStack;
            gameState.gameSpeed = speed === 'slow' ? 1500 : speed === 'fast' ? 500 : 1000;
            gameState.location = location;
            gameState.showHandStrength = document.getElementById('showHandStrength').checked;
            gameState.autoSave = document.getElementById('autoSave').checked;

            // Apply theme
            applyTheme(location);

            const shuffledCharacters = [...RDR_CHARACTERS].sort(() => Math.random() - 0.5);

            gameState.players = [{
                id: 0,
                name: 'You',
                avatar: 'ü§†',
                chips: startingStack,
                cards: [],
                folded: false,
                allIn: false,
                currentBet: 0,
                isHuman: true,
                character: { aggression: 0, bluffFreq: 0, style: 'human', tiltFactor: 0 }
            }];

            for (let i = 0; i < numOpponents; i++) {
                const char = shuffledCharacters[i];
                gameState.players.push({
                    id: i + 1,
                    name: char.name,
                    avatar: char.avatar,
                    chips: startingStack,
                    cards: [],
                    folded: false,
                    allIn: false,
                    currentBet: 0,
                    isHuman: false,
                    character: char,
                    justLostBigPot: false,
                    isBluffing: false
                });
            }

            gameState.dealerIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.handsPlayed = 0;
            gameState.playerWins = 0;

            document.getElementById('gameLog').innerHTML = '';
            addLog(`Welcome to ${LOCATIONS[location].name}. Good luck, partner!`, 'system');

            updateStats();
            await startNewHand();
        }

        function applyTheme(location) {
            document.body.className = LOCATIONS[location].theme;
            document.getElementById('locationSubtitle').textContent = `${LOCATIONS[location].name} ‚Äî Texas Hold'em`;
        }

        async function startNewHand() {
            gameState.deck = createDeck();
            gameState.communityCards = [];
            gameState.pot = 0;
            gameState.currentBet = 0;
            gameState.minRaise = gameState.bigBlind;
            gameState.sidePots = [];
            gameState.phase = 'preflop';

            for (const player of gameState.players) {
                player.cards = [];
                player.folded = false;
                player.allIn = false;
                player.currentBet = 0;
                player.lastAction = null;
            }

            gameState.players = gameState.players.filter(p => p.chips > 0 || p.isHuman);

            if (gameState.players.filter(p => p.chips > 0).length <= 1) {
                if (gameState.players[0].chips > 0) {
                    addLog('YOU WIN THE TOURNAMENT!', 'win');
                    SoundManager.play('win');
                } else {
                    addLog('You\'ve been eliminated...', 'fold');
                }
                return;
            }

            gameState.dealerIndex = (gameState.dealerIndex + 1) % gameState.players.length;
            gameState.handsPlayed++;
            playerStats.handsPlayed++;

            addLog(`--- Hand #${gameState.handsPlayed} ---`, 'system');

            renderPlayers();
            renderCommunityCards();
            updatePotDisplay();
            updateHandStrengthMeter();

            await delay(500);
            await postBlinds();
            await dealHoleCards();
            await startBettingRound();
        }

        async function postBlinds() {
            const sbIndex = (gameState.dealerIndex + 1) % gameState.players.length;
            const bbIndex = (gameState.dealerIndex + 2) % gameState.players.length;

            const sbPlayer = gameState.players[sbIndex];
            const bbPlayer = gameState.players[bbIndex];

            const sbAmount = Math.min(gameState.smallBlind, sbPlayer.chips);
            sbPlayer.chips -= sbAmount;
            sbPlayer.currentBet = sbAmount;
            gameState.pot += sbAmount;

            SoundManager.play('chip');
            addLog(`${sbPlayer.name} posts small blind ${formatMoney(sbAmount)}`);

            const bbAmount = Math.min(gameState.bigBlind, bbPlayer.chips);
            bbPlayer.chips -= bbAmount;
            bbPlayer.currentBet = bbAmount;
            gameState.pot += bbAmount;
            gameState.currentBet = bbAmount;

            SoundManager.play('chip');
            addLog(`${bbPlayer.name} posts big blind ${formatMoney(bbAmount)}`);

            renderPlayers();
            updatePotDisplay();

            await delay(300);
        }

        async function dealHoleCards() {
            for (const player of gameState.players) {
                player.cards = [gameState.deck.pop(), gameState.deck.pop()];
                SoundManager.play('card');
                renderPlayers();
                await delay(200);
            }

            updateYourHand();
            updateHandStrengthMeter();
        }

        async function startBettingRound() {
            let startIndex;
            if (gameState.phase === 'preflop') {
                startIndex = (gameState.dealerIndex + 3) % gameState.players.length;
            } else {
                startIndex = (gameState.dealerIndex + 1) % gameState.players.length;
            }

            gameState.currentPlayerIndex = startIndex;

            if (gameState.phase !== 'preflop') {
                gameState.currentBet = 0;
                gameState.minRaise = gameState.bigBlind;
                for (const player of gameState.players) {
                    player.currentBet = 0;
                }
            }

            await processBettingRound();
        }

        async function processBettingRound() {
            let actionCount = 0;
            let lastRaiser = -1;
            const maxActions = gameState.players.length * 4;

            while (actionCount < maxActions) {
                const activePlayers = gameState.players.filter(p => !p.folded && !p.allIn);

                if (activePlayers.length <= 1) {
                    break;
                }

                const currentPlayer = gameState.players[gameState.currentPlayerIndex];

                if (currentPlayer.folded || currentPlayer.allIn) {
                    gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                    continue;
                }

                const allBetsEqual = activePlayers.every(p => p.currentBet === gameState.currentBet);
                if (allBetsEqual && actionCount > 0 && gameState.currentPlayerIndex === lastRaiser) {
                    break;
                }

                if (allBetsEqual && actionCount >= activePlayers.length && lastRaiser === -1) {
                    break;
                }

                renderPlayers();

                if (currentPlayer.isHuman) {
                    enableActionButtons(currentPlayer);
                    return;
                } else {
                    await delay(gameState.gameSpeed);
                    const toCall = gameState.currentBet - currentPlayer.currentBet;
                    const decision = getAIDecision(currentPlayer, toCall);

                    if (decision.action === 'raise') {
                        lastRaiser = gameState.currentPlayerIndex;
                    }

                    await executeAction(currentPlayer, decision.action, decision.amount);
                }

                actionCount++;
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            }

            await advancePhase();
        }

        async function executeAction(player, action, amount = 0) {
            const toCall = gameState.currentBet - player.currentBet;

            switch (action) {
                case 'fold':
                    player.folded = true;
                    player.lastAction = 'fold';
                    SoundManager.play('fold');
                    addLog(`${player.name} folds`, 'fold');
                    break;

                case 'check':
                    player.lastAction = 'check';
                    SoundManager.play('check');
                    addLog(`${player.name} checks`);
                    break;

                case 'call':
                    const callAmount = Math.min(toCall, player.chips);
                    player.chips -= callAmount;
                    player.currentBet += callAmount;
                    gameState.pot += callAmount;

                    SoundManager.play('chip');

                    if (player.chips === 0) {
                        player.allIn = true;
                        player.lastAction = 'all-in';
                        addLog(`${player.name} calls ${formatMoney(callAmount)} (ALL IN!)`);
                    } else {
                        player.lastAction = 'call';
                        addLog(`${player.name} calls ${formatMoney(callAmount)}`);
                    }
                    break;

                case 'raise':
                    const raiseTotal = Math.min(amount, player.chips + player.currentBet);
                    const raiseAmount = raiseTotal - player.currentBet;

                    player.chips -= raiseAmount;
                    gameState.pot += raiseAmount;
                    gameState.minRaise = raiseTotal - gameState.currentBet;
                    gameState.currentBet = raiseTotal;
                    player.currentBet = raiseTotal;

                    SoundManager.play('raise');

                    if (player.chips === 0) {
                        player.allIn = true;
                        player.lastAction = 'all-in';
                        addLog(`${player.name} raises to ${formatMoney(raiseTotal)} (ALL IN!)`);
                    } else {
                        player.lastAction = 'raise';
                        addLog(`${player.name} raises to ${formatMoney(raiseTotal)}`);
                    }
                    break;

                case 'allin':
                    const allInAmount = player.chips;
                    const totalBet = player.currentBet + allInAmount;

                    player.chips = 0;
                    gameState.pot += allInAmount;
                    player.currentBet = totalBet;
                    player.allIn = true;
                    player.lastAction = 'all-in';

                    SoundManager.play('allin');

                    if (totalBet > gameState.currentBet) {
                        gameState.minRaise = totalBet - gameState.currentBet;
                        gameState.currentBet = totalBet;
                    }

                    addLog(`${player.name} goes ALL IN for ${formatMoney(allInAmount)}!`);
                    break;
            }

            renderPlayers();
            updatePotDisplay(true);
            updateStats();
            saveGame();
        }

        async function advancePhase() {
            const activePlayers = gameState.players.filter(p => !p.folded);

            if (activePlayers.length === 1) {
                await awardPot([activePlayers[0]]);
                return;
            }

            const canAct = activePlayers.filter(p => !p.allIn);
            if (canAct.length <= 1) {
                await dealRemainingCards();
                await determineWinner();
                return;
            }

            switch (gameState.phase) {
                case 'preflop':
                    gameState.phase = 'flop';
                    document.getElementById('gamePhase').textContent = 'The Flop';
                    addLog('--- The Flop ---', 'system');
                    await dealFlop();
                    break;

                case 'flop':
                    gameState.phase = 'turn';
                    document.getElementById('gamePhase').textContent = 'The Turn';
                    addLog('--- The Turn ---', 'system');
                    await dealTurn();
                    break;

                case 'turn':
                    gameState.phase = 'river';
                    document.getElementById('gamePhase').textContent = 'The River';
                    addLog('--- The River ---', 'system');
                    await dealRiver();
                    break;

                case 'river':
                    await determineWinner();
                    return;
            }

            updateYourHand();
            updateHandStrengthMeter();
            await startBettingRound();
        }

        async function dealRemainingCards() {
            while (gameState.communityCards.length < 5) {
                gameState.deck.pop();
                gameState.communityCards.push(gameState.deck.pop());
                SoundManager.play('card');
                renderCommunityCards();
                await delay(500);
            }
        }

        async function dealFlop() {
            gameState.deck.pop();
            for (let i = 0; i < 3; i++) {
                gameState.communityCards.push(gameState.deck.pop());
                SoundManager.play('card');
                renderCommunityCards();
                await delay(300);
            }
        }

        async function dealTurn() {
            gameState.deck.pop();
            gameState.communityCards.push(gameState.deck.pop());
            SoundManager.play('card');
            renderCommunityCards();
            await delay(300);
        }

        async function dealRiver() {
            gameState.deck.pop();
            gameState.communityCards.push(gameState.deck.pop());
            SoundManager.play('card');
            renderCommunityCards();
            await delay(300);
        }

        async function determineWinner() {
            gameState.phase = 'showdown';
            document.getElementById('gamePhase').textContent = 'Showdown';
            addLog('--- Showdown ---', 'system');

            const activePlayers = gameState.players.filter(p => !p.folded);

            const hands = activePlayers.map(player => {
                const allCards = [...player.cards, ...gameState.communityCards];
                const evaluation = evaluateHand(allCards);
                return { player, evaluation };
            });

            hands.sort((a, b) => {
                if (a.evaluation.rank !== b.evaluation.rank) {
                    return b.evaluation.rank - a.evaluation.rank;
                }
                return compareValues(b.evaluation.value, a.evaluation.value);
            });

            const winners = [hands[0]];
            for (let i = 1; i < hands.length; i++) {
                if (hands[i].evaluation.rank === hands[0].evaluation.rank &&
                    compareValues(hands[i].evaluation.value, hands[0].evaluation.value) === 0) {
                    winners.push(hands[i]);
                } else {
                    break;
                }
            }

            renderPlayers(true);
            await delay(1500);

            for (const hand of hands) {
                addLog(`${hand.player.name}: ${hand.evaluation.name}`);
            }

            // Mark losers as having lost a big pot (for tilt)
            const losers = hands.filter(h => !winners.includes(h));
            for (const loser of losers) {
                if (gameState.pot > gameState.bigBlind * 20) {
                    loser.player.justLostBigPot = true;
                }
            }

            await awardPot(winners.map(w => w.player), winners[0].evaluation.name, winners.map(w => w.player.cards));
        }

        async function awardPot(winners, handName = '', winnerCards = []) {
            const potShare = Math.floor(gameState.pot / winners.length);

            for (const winner of winners) {
                winner.chips += potShare;
                winner.justLostBigPot = false;

                if (winner.isHuman) {
                    gameState.playerWins++;
                    playerStats.handsWon++;
                    playerStats.totalEarnings += potShare - winner.currentBet;

                    if (potShare > playerStats.biggestPot) {
                        playerStats.biggestPot = potShare;
                    }

                    if (handName && HAND_RANKINGS[handName] > playerStats.bestHand.rank) {
                        playerStats.bestHand = { name: handName, rank: HAND_RANKINGS[handName] };
                    }

                    // Check if won with a bluff (everyone else folded)
                    if (!handName || handName === '') {
                        playerStats.bluffsWon++;
                    }

                    // Check if won all-in
                    if (winner.allIn) {
                        playerStats.allInsWon++;
                    }
                }
            }

            SoundManager.play('win');

            // Show winner overlay with cards
            const winnerNames = winners.map(w => w.name).join(' & ');
            document.getElementById('winnerName').textContent = winners.length > 1 ? 'Split Pot!' : `${winnerNames} Wins!`;
            document.getElementById('winnerHand').textContent = handName || 'Everyone else folded';
            document.getElementById('winnerPot').textContent = `Wins ${formatMoney(gameState.pot)}`;

            // Show winning cards
            const cardsContainer = document.getElementById('winnerCards');
            cardsContainer.innerHTML = '';
            if (winnerCards.length > 0 && winnerCards[0]) {
                for (const card of winnerCards[0]) {
                    const cardEl = document.createElement('div');
                    cardEl.className = `card ${getCardColor(card.suit)}`;
                    cardEl.innerHTML = `<div class="card-rank">${card.rank}</div><div class="card-suit">${card.suit}</div>`;
                    cardsContainer.appendChild(cardEl);
                }
            }

            document.getElementById('winnerOverlay').classList.add('active');

            if (winners.length === 1) {
                addLog(`${winners[0].name} wins ${formatMoney(gameState.pot)} with ${handName || 'the only remaining hand'}!`, 'win');
            } else {
                addLog(`Split pot! ${winnerNames} each win ${formatMoney(potShare)}`, 'win');
            }

            updateStats();
            saveGame();
            saveStats();
        }

        function closeWinnerOverlay() {
            document.getElementById('winnerOverlay').classList.remove('active');
            setTimeout(() => startNewHand(), 500);
        }

        // ==================== PLAYER ACTIONS ====================
        function playerAction(action) {
            const player = gameState.players[gameState.currentPlayerIndex];
            if (!player.isHuman) return;

            disableActionButtons();

            let amount = 0;
            if (action === 'raise') {
                amount = parseInt(document.getElementById('raiseSlider').value);
            } else if (action === 'call') {
                amount = gameState.currentBet - player.currentBet;
            }

            executeAction(player, action, amount).then(() => {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                processBettingRound();
            });
        }

        function enableActionButtons(player) {
            const toCall = gameState.currentBet - player.currentBet;
            const canRaise = player.chips > toCall;

            document.getElementById('btnFold').disabled = false;
            document.getElementById('btnCheck').disabled = toCall > 0;
            document.getElementById('btnCall').disabled = toCall <= 0;
            document.getElementById('btnRaise').disabled = !canRaise;
            document.getElementById('btnAllIn').disabled = player.chips <= 0;

            document.getElementById('callAmount').textContent = toCall > 0 ? formatMoney(toCall) : '';
            document.getElementById('toCallAmount').textContent = formatMoney(toCall);

            if (canRaise) {
                const minRaise = Math.max(gameState.currentBet + gameState.minRaise, gameState.bigBlind * 2);
                const maxRaise = player.chips + player.currentBet;

                const slider = document.getElementById('raiseSlider');
                slider.min = minRaise;
                slider.max = maxRaise;
                slider.value = Math.min(minRaise * 2, maxRaise);

                updateRaiseDisplay();

                document.getElementById('raiseControls').style.display = 'flex';
                document.getElementById('presetBets').style.display = 'flex';
            } else {
                document.getElementById('raiseControls').style.display = 'none';
                document.getElementById('presetBets').style.display = 'none';
            }
        }

        function disableActionButtons() {
            document.getElementById('btnFold').disabled = true;
            document.getElementById('btnCheck').disabled = true;
            document.getElementById('btnCall').disabled = true;
            document.getElementById('btnRaise').disabled = true;
            document.getElementById('btnAllIn').disabled = true;
            document.getElementById('raiseControls').style.display = 'none';
            document.getElementById('presetBets').style.display = 'none';
        }

        function updateRaiseDisplay() {
            const amount = parseInt(document.getElementById('raiseSlider').value);
            document.getElementById('raiseAmountDisplay').textContent = formatMoney(amount);
        }

        function setRaisePreset(multiplier) {
            const player = gameState.players[0];
            const potBet = Math.floor(gameState.pot * multiplier);
            const minRaise = parseInt(document.getElementById('raiseSlider').min);
            const maxRaise = parseInt(document.getElementById('raiseSlider').max);

            const betAmount = Math.max(minRaise, Math.min(potBet, maxRaise));
            document.getElementById('raiseSlider').value = betAmount;
            updateRaiseDisplay();
        }

        // ==================== RENDERING ====================
        function renderPlayers(showAllCards = false) {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const position = index;
                const isDealer = index === gameState.dealerIndex;
                const isActive = index === gameState.currentPlayerIndex && gameState.phase !== 'waiting' && gameState.phase !== 'showdown';

                const seat = document.createElement('div');
                seat.className = `player-seat position-${position}`;
                if (isActive) seat.classList.add('active');
                if (player.folded) seat.classList.add('folded');

                const avatar = document.createElement('div');
                avatar.className = 'player-avatar';
                avatar.textContent = player.avatar;

                if (isDealer) {
                    const dealerChip = document.createElement('div');
                    dealerChip.className = 'dealer-chip';
                    dealerChip.textContent = 'D';
                    avatar.appendChild(dealerChip);
                }

                seat.appendChild(avatar);

                const name = document.createElement('div');
                name.className = 'player-name';
                name.textContent = player.name;
                seat.appendChild(name);

                const chips = document.createElement('div');
                chips.className = 'player-chips';
                chips.innerHTML = `<div class="chip-icon"></div> ${formatMoney(player.chips)}`;
                seat.appendChild(chips);

                const cardsDiv = document.createElement('div');
                cardsDiv.className = 'player-cards';

                if (player.cards.length > 0) {
                    const showCards = player.isHuman || showAllCards || (gameState.phase === 'showdown' && !player.folded);

                    player.cards.forEach(card => {
                        const cardEl = document.createElement('div');
                        if (showCards) {
                            cardEl.className = `card ${getCardColor(card.suit)}`;
                            cardEl.innerHTML = `<div class="card-rank">${card.rank}</div><div class="card-suit">${card.suit}</div>`;
                        } else {
                            cardEl.className = 'card face-down';
                        }
                        cardsDiv.appendChild(cardEl);
                    });
                }

                seat.appendChild(cardsDiv);

                if (player.currentBet > 0) {
                    const bet = document.createElement('div');
                    bet.className = 'player-bet';
                    bet.textContent = formatMoney(player.currentBet);
                    seat.appendChild(bet);
                }

                if (player.lastAction && !player.folded) {
                    const action = document.createElement('div');
                    action.className = `player-action ${player.lastAction}`;
                    action.textContent = player.lastAction.toUpperCase();
                    seat.appendChild(action);
                }

                container.appendChild(seat);
            });
        }

        function renderCommunityCards() {
            const container = document.getElementById('communityCards');
            container.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                if (i < gameState.communityCards.length) {
                    const card = gameState.communityCards[i];
                    const cardEl = document.createElement('div');
                    cardEl.className = `card ${getCardColor(card.suit)}`;
                    cardEl.innerHTML = `<div class="card-rank">${card.rank}</div><div class="card-suit">${card.suit}</div>`;
                    container.appendChild(cardEl);
                }
            }
        }

        function updatePotDisplay(animate = false) {
            const potDisplay = document.getElementById('potDisplay');
            document.getElementById('potAmount').textContent = formatMoney(gameState.pot);

            if (animate) {
                potDisplay.classList.add('growing');
                setTimeout(() => potDisplay.classList.remove('growing'), 300);
            }
        }

        function updateYourHand() {
            const player = gameState.players[0];
            if (!player || player.cards.length === 0) {
                document.getElementById('yourHandValue').textContent = '‚Äî';
                return;
            }

            const allCards = [...player.cards, ...gameState.communityCards];
            if (allCards.length >= 5) {
                const hand = evaluateHand(allCards);
                document.getElementById('yourHandValue').textContent = hand.name;
            } else if (allCards.length >= 2) {
                const card1 = player.cards[0];
                const card2 = player.cards[1];
                const isPair = card1.rank === card2.rank;
                const isSuited = card1.suit === card2.suit;

                let description = `${card1.rank}${card2.rank}`;
                if (isSuited) description += ' suited';
                if (isPair) description = `Pair of ${card1.rank}s`;

                document.getElementById('yourHandValue').textContent = description;
            }
        }

        function updateHandStrengthMeter() {
            const container = document.getElementById('handStrengthContainer');
            const fill = document.getElementById('handStrengthFill');

            if (!gameState.showHandStrength || !gameState.players[0] || gameState.players[0].cards.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            const strength = calculateHandStrengthPercentage(gameState.players[0]);

            fill.style.width = `${strength}%`;
            fill.className = 'hand-strength-fill';

            if (strength < 30) {
                fill.classList.add('weak');
            } else if (strength < 55) {
                fill.classList.add('medium');
            } else if (strength < 80) {
                fill.classList.add('strong');
            } else {
                fill.classList.add('monster');
            }
        }

        function updateStats() {
            const player = gameState.players[0];
            if (player) {
                document.getElementById('playerStack').textContent = formatMoney(player.chips);

                const profit = player.chips - gameState.startingStack;
                const profitStr = profit >= 0 ? `+${formatMoney(profit)}` : `-${formatMoney(Math.abs(profit))}`;
                document.getElementById('sessionProfit').textContent = profitStr;
                document.getElementById('sessionProfit').style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
            }

            document.getElementById('handsWon').textContent = gameState.playerWins;
            document.getElementById('blindsDisplay').textContent = `${formatMoney(gameState.smallBlind)} / ${formatMoney(gameState.bigBlind)}`;
        }

        // ==================== PERSISTENCE ====================
        function saveGame() {
            if (!gameState.autoSave) return;

            Storage.save('gameState', {
                players: gameState.players.map(p => ({
                    ...p,
                    cards: [] // Don't save cards
                })),
                dealerIndex: gameState.dealerIndex,
                handsPlayed: gameState.handsPlayed,
                playerWins: gameState.playerWins,
                startingStack: gameState.startingStack,
                location: gameState.location,
                smallBlind: gameState.smallBlind,
                bigBlind: gameState.bigBlind
            });
        }

        function loadGame() {
            const saved = Storage.load('gameState');
            if (saved) {
                // Could implement game resumption here
                console.log('Saved game found');
            }
        }

        function saveStats() {
            Storage.save('playerStats', playerStats);
        }

        function loadStats() {
            const saved = Storage.load('playerStats');
            if (saved) {
                playerStats = { ...playerStats, ...saved };
            }
        }

        // ==================== UI FUNCTIONS ====================
        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function applySettings() {
            closeSettings();
            startNewGame();
        }

        function showStats() {
            document.getElementById('statsHandsPlayed').textContent = playerStats.handsPlayed;
            document.getElementById('statsHandsWon').textContent = playerStats.handsWon;
            document.getElementById('statsWinRate').textContent = playerStats.handsPlayed > 0
                ? Math.round((playerStats.handsWon / playerStats.handsPlayed) * 100) + '%'
                : '0%';
            document.getElementById('statsBiggestPot').textContent = formatMoney(playerStats.biggestPot);
            document.getElementById('statsTotalEarnings').textContent = playerStats.totalEarnings >= 0
                ? formatMoney(playerStats.totalEarnings)
                : '-' + formatMoney(Math.abs(playerStats.totalEarnings));
            document.getElementById('statsBestHand').textContent = playerStats.bestHand.name;
            document.getElementById('statsBluffsWon').textContent = playerStats.bluffsWon;
            document.getElementById('statsAllInsWon').textContent = playerStats.allInsWon;

            document.getElementById('statsModal').classList.add('active');
        }

        function closeStats() {
            document.getElementById('statsModal').classList.remove('active');
        }

        function resetStats() {
            if (confirm('Are you sure you want to reset all statistics?')) {
                playerStats = {
                    handsPlayed: 0,
                    handsWon: 0,
                    biggestPot: 0,
                    totalEarnings: 0,
                    bestHand: { name: '‚Äî', rank: 0 },
                    bluffsWon: 0,
                    allInsWon: 0
                };
                saveStats();
                showStats();
            }
        }

        function toggleSound() {
            SoundManager.toggle();
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('raiseSlider').addEventListener('input', updateRaiseDisplay);

        document.addEventListener('keydown', (e) => {
            if (gameState.phase === 'waiting' || gameState.phase === 'showdown') return;

            const player = gameState.players[gameState.currentPlayerIndex];
            if (!player || !player.isHuman) return;

            switch (e.key.toLowerCase()) {
                case 'f':
                    if (!document.getElementById('btnFold').disabled) playerAction('fold');
                    break;
                case 'c':
                    if (!document.getElementById('btnCheck').disabled) playerAction('check');
                    else if (!document.getElementById('btnCall').disabled) playerAction('call');
                    break;
                case 'r':
                    if (!document.getElementById('btnRaise').disabled) playerAction('raise');
                    break;
                case 'a':
                    if (!document.getElementById('btnAllIn').disabled) playerAction('allin');
                    break;
            }
        });

        // Theme change listener
        document.getElementById('locationSelect').addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            disableActionButtons();
            document.getElementById('gamePhase').textContent = 'Click "New Game" to start';

            SoundManager.init();
            loadStats();
            loadGame();

            renderPlayers();
        });
    </script>
</body>
</html>
